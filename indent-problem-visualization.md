# ç¼©è¿›é—®é¢˜å¯è§†åŒ–å¯¹æ¯”

## ğŸ”´ å½“å‰è¾“å‡ºï¼ˆæœ‰é—®é¢˜ï¼‰

### ç¤ºä¾‹ 1ï¼šOptionalExpression çš„æ··ä¹±ç¼©è¿›

```
â”œâ”€OptionalExpression
â”‚  â””â”€ğŸ”€ OptionalExpression(Or)          â† Or åŒ…è£¹èŠ‚ç‚¹ï¼ˆæ·±åº¦ 2ï¼‰
â”‚  â”‚  â””â”€[Branch #1]                     â† åˆ†æ”¯ 1ï¼ˆæ·±åº¦ 3ï¼‰âœ… æ­£ç¡®
â”‚  â”‚  â”‚  â””â”€MemberExpression             â† åˆ†æ”¯ 1 çš„å†…å®¹ï¼ˆæ·±åº¦ 4ï¼‰
â”‚  â”‚  â””â”€[Branch #2]                     â† åˆ†æ”¯ 2ï¼ˆæ·±åº¦ 3ï¼‰âœ… æ­£ç¡®
â”‚  â”‚  â”‚  â””â”€CallExpression               â† åˆ†æ”¯ 2 çš„å†…å®¹ï¼ˆæ·±åº¦ 4ï¼‰
â”‚  â””â”€[Branch #2]                        â† âŒ åˆä¸€ä¸ªåˆ†æ”¯ 2ï¼Ÿï¼ˆæ·±åº¦ 2ï¼‰
â”‚  â”‚  â””â”€LeftHandSideExpression          â† å†…å®¹ï¼ˆæ·±åº¦ 3ï¼‰
```

**é—®é¢˜ï¼š**
- å‡ºç°äº†ä¸¤ä¸ª `[Branch #2]`
- ç¬¬ä¸€ä¸ªæ·±åº¦æ˜¯ 3ï¼Œç¬¬äºŒä¸ªæ·±åº¦æ˜¯ 2
- ç¬¬äºŒä¸ª `[Branch #2]` çš„ç¼©è¿›å’Œ `OptionalExpression(Or)` ä¸€æ ·ï¼Œçœ‹èµ·æ¥åƒæ˜¯å…„å¼ŸèŠ‚ç‚¹
- **æ— æ³•åˆ¤æ–­ç¬¬äºŒä¸ª `[Branch #2]` å±äºå“ªä¸ª Or**

### ç¤ºä¾‹ 2ï¼šCallExpression çš„æ··ä¹±ç»“æ„

```
â”œâ”€Script > ... > CallExpression
â”‚  â””â”€ğŸ”€ CallExpression(Or)              â† Or åŒ…è£¹èŠ‚ç‚¹ï¼ˆæ·±åº¦ 2ï¼‰
â”‚  â”‚  â””â”€[Branch #1]                     â† åˆ†æ”¯ 1ï¼ˆæ·±åº¦ 3ï¼‰
â”‚  â”‚  â”‚  â””â”€CoverCallExpression...       â† åˆ†æ”¯ 1 çš„å†…å®¹ï¼ˆæ·±åº¦ 4ï¼‰
â”‚  â”‚  â”‚  â”‚  â””â”€MemberExpression          â† æ›´æ·±çš„å†…å®¹ï¼ˆæ·±åº¦ 5ï¼‰
â”‚  â”œâ”€OptionalExpression                 â† âŒ è¿™æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆæ·±åº¦ 2ï¼‰
â”‚  â”‚  â””â”€ğŸ”€ OptionalExpression(Or)       â† å¦ä¸€ä¸ª Orï¼ˆæ·±åº¦ 3ï¼‰
â”‚  â”‚  â”‚  â””â”€[Branch #1]                  â† åˆ†æ”¯ï¼ˆæ·±åº¦ 4ï¼‰
â”‚  â”‚  â”‚  â”‚  â””â”€MemberExpression          â† å†…å®¹ï¼ˆæ·±åº¦ 5ï¼‰
â”‚  â”‚  â”‚  â””â”€[Branch #2]                  â† åˆ†æ”¯ï¼ˆæ·±åº¦ 4ï¼‰
â”‚  â”‚  â”‚  â”‚  â””â”€CallExpression            â† å†…å®¹ï¼ˆæ·±åº¦ 5ï¼‰
â”‚  â””â”€[Branch #2]                        â† âŒ è¿™å±äºè°ï¼Ÿï¼ˆæ·±åº¦ 2ï¼‰
â”‚  â”‚  â””â”€LeftHandSideExpression          â† å†…å®¹ï¼ˆæ·±åº¦ 3ï¼‰
```

**é—®é¢˜ï¼š**
- `CallExpression(Or)` ä¸‹é¢åº”è¯¥æœ‰å¤šä¸ªåˆ†æ”¯
- ä½†ä¸­é—´æ’å…¥äº† `OptionalExpression`ï¼ˆæ·±åº¦ 2ï¼Œå’Œ Or åŒ…è£¹èŠ‚ç‚¹åŒçº§ï¼‰
- æœ€ååˆå‡ºç°äº† `[Branch #2]`ï¼ˆæ·±åº¦ 2ï¼‰
- **å®Œå…¨æ— æ³•ç†è§£è¿™ä¸ªæ ‘å½¢ç»“æ„**

### ç¤ºä¾‹ 3ï¼šå­¤ç«‹çš„ Branch èŠ‚ç‚¹

```
â”‚  â””â”€[Branch #2]                        â† åˆ†æ”¯ 2ï¼ˆæ·±åº¦ 2ï¼‰
â”‚  â”‚  â””â”€LeftHandSideExpression          â† å†…å®¹ï¼ˆæ·±åº¦ 3ï¼‰
â”‚  â””â”€[Branch #5]                        â† âŒ åˆ†æ”¯ 5ï¼Ÿå‰é¢æ²¡æœ‰ Or èŠ‚ç‚¹ï¼ï¼ˆæ·±åº¦ 2ï¼‰
â”‚  â”‚  â””â”€LeftHandSideExpression          â† å†…å®¹ï¼ˆæ·±åº¦ 3ï¼‰
â”‚  â”œâ”€UnaryExpression                    â† âŒ æ™®é€šè§„åˆ™ï¼ˆæ·±åº¦ 2ï¼‰
â”‚  â”‚  â””â”€ğŸ”€ UnaryExpression(Or)          â† Or åŒ…è£¹èŠ‚ç‚¹ï¼ˆæ·±åº¦ 3ï¼‰
â”‚  â”‚  â”‚  â””â”€[Branch #1]                  â† åˆ†æ”¯ 1ï¼ˆæ·±åº¦ 4ï¼‰
â”‚  â”‚  â”‚  â”‚  â””â”€UpdateExpression          â† å†…å®¹ï¼ˆæ·±åº¦ 5ï¼‰
â”‚  â”œâ”€                                   â† âŒ ç©ºè§„åˆ™åï¼ï¼ˆæ·±åº¦ 2ï¼‰
â”‚  â”‚  â””â”€CoalesceExpression              â† å†…å®¹ï¼ˆæ·±åº¦ 3ï¼‰
â”‚  â”‚  â”‚  â””â”€BitwiseORExpression          â† æ›´æ·±çš„å†…å®¹ï¼ˆæ·±åº¦ 4ï¼‰
â”‚  â””â”€[Branch #2]                        â† âŒ åˆä¸€ä¸ªåˆ†æ”¯ 2ï¼ˆæ·±åº¦ 2ï¼‰
â”‚  â”‚  â””â”€ShortCircuitExpression          â† å†…å®¹ï¼ˆæ·±åº¦ 3ï¼‰
```

**é—®é¢˜ï¼š**
- å‡ºç°äº† `[Branch #5]`ï¼Œä½†å‰é¢æ²¡æœ‰å¯¹åº”çš„ Or åŒ…è£¹èŠ‚ç‚¹
- å‡ºç°äº†ç©ºè§„åˆ™å `â”œâ”€`
- å¤šä¸ª `[Branch #2]` æ•£è½åœ¨ä¸åŒä½ç½®
- **å®Œå…¨æ— æ³•ç†è§£è¿™äº›èŠ‚ç‚¹çš„å½’å±å…³ç³»**

---

## âœ… æœŸæœ›çš„è¾“å‡ºï¼ˆæ­£ç¡®ï¼‰

### ç¤ºä¾‹ 1ï¼šOptionalExpression åº”è¯¥æ˜¯è¿™æ ·

```
â”œâ”€OptionalExpression
â”‚  â””â”€ğŸ”€ OptionalExpression(Or)          â† Or åŒ…è£¹èŠ‚ç‚¹ï¼ˆæ·±åº¦ 2ï¼‰
â”‚     â”œâ”€[Branch #1]                     â† åˆ†æ”¯ 1ï¼ˆæ·±åº¦ 3ï¼‰
â”‚     â”‚  â””â”€MemberExpression             â† åˆ†æ”¯ 1 çš„å†…å®¹ï¼ˆæ·±åº¦ 4ï¼‰
â”‚     â””â”€[Branch #2]                     â† åˆ†æ”¯ 2ï¼ˆæ·±åº¦ 3ï¼‰
â”‚        â””â”€CallExpression               â† åˆ†æ”¯ 2 çš„å†…å®¹ï¼ˆæ·±åº¦ 4ï¼‰
```

**æ”¹è¿›ï¼š**
- âœ… Or åŒ…è£¹èŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰åˆ†æ”¯æ·±åº¦ä¸€è‡´ï¼ˆéƒ½æ˜¯ 3ï¼‰
- âœ… ä½¿ç”¨ `â”œâ”€` å’Œ `â””â”€` æ¸…æ™°è¡¨ç¤ºå…„å¼Ÿå…³ç³»
- âœ… ç¼©è¿›æ­£ç¡®ï¼Œå±‚çº§å…³ç³»æ¸…æ™°

### ç¤ºä¾‹ 2ï¼šCallExpression åº”è¯¥æ˜¯è¿™æ ·

```
â”œâ”€Script > ... > CallExpression
â”‚  â””â”€ğŸ”€ CallExpression(Or)              â† Or åŒ…è£¹èŠ‚ç‚¹ï¼ˆæ·±åº¦ 2ï¼‰
â”‚     â”œâ”€[Branch #1]                     â† åˆ†æ”¯ 1ï¼ˆæ·±åº¦ 3ï¼‰
â”‚     â”‚  â””â”€CoverCallExpression...       â† åˆ†æ”¯ 1 çš„å†…å®¹ï¼ˆæ·±åº¦ 4ï¼‰
â”‚     â”‚     â””â”€MemberExpression          â† æ›´æ·±çš„å†…å®¹ï¼ˆæ·±åº¦ 5ï¼‰
â”‚     â”‚        â””â”€OptionalExpression     â† ç»§ç»­æ·±å…¥ï¼ˆæ·±åº¦ 6ï¼‰
â”‚     â”‚           â””â”€ğŸ”€ OptionalExpression(Or)  â† åµŒå¥—çš„ Orï¼ˆæ·±åº¦ 7ï¼‰
â”‚     â”‚              â”œâ”€[Branch #1]      â† åµŒå¥— Or çš„åˆ†æ”¯ 1ï¼ˆæ·±åº¦ 8ï¼‰
â”‚     â”‚              â”‚  â””â”€MemberExpression  â† å†…å®¹ï¼ˆæ·±åº¦ 9ï¼‰
â”‚     â”‚              â””â”€[Branch #2]      â† åµŒå¥— Or çš„åˆ†æ”¯ 2ï¼ˆæ·±åº¦ 8ï¼‰
â”‚     â”‚                 â””â”€CallExpression    â† å†…å®¹ï¼ˆæ·±åº¦ 9ï¼‰
â”‚     â””â”€[Branch #2]                     â† åˆ†æ”¯ 2ï¼ˆæ·±åº¦ 3ï¼‰
â”‚        â””â”€LeftHandSideExpression       â† åˆ†æ”¯ 2 çš„å†…å®¹ï¼ˆæ·±åº¦ 4ï¼‰
```

**æ”¹è¿›ï¼š**
- âœ… `CallExpression(Or)` çš„æ‰€æœ‰åˆ†æ”¯éƒ½æ˜¯æ·±åº¦ 3
- âœ… `OptionalExpression` æ˜¯ `[Branch #1]` çš„å­èŠ‚ç‚¹ï¼Œä¸æ˜¯å…„å¼ŸèŠ‚ç‚¹
- âœ… åµŒå¥—çš„ Or ç»“æ„æ¸…æ™°å¯è§
- âœ… å±‚çº§å…³ç³»ä¸€ç›®äº†ç„¶

---

## ğŸ”§ é—®é¢˜æ ¹æº

### ä»£ç é—®é¢˜ï¼š`printSingleRule` çš„æ·±åº¦è®¡ç®—é”™è¯¯

**å½“å‰å®ç°ï¼ˆé”™è¯¯ï¼‰ï¼š**
```typescript
static printSingleRule(rules: RuleStackItem[], startDepth: number): void {
    rules.forEach((item, index) => {
        const depth = startDepth + index  // âŒ å‡è®¾æ¯ä¸ªè§„åˆ™æ·±åº¦é€’å¢
        // ...
    })
}
```

**é—®é¢˜ï¼š**
- å½“ä¼ å…¥ `[Branch #1]` æ—¶ï¼Œ`index = 0`ï¼Œ`depth = startDepth + 0 = startDepth`
- å½“ä¼ å…¥ `[Branch #2]` æ—¶ï¼ˆå•ç‹¬è°ƒç”¨ï¼‰ï¼Œ`index = 0`ï¼Œ`depth = startDepth + 0 = startDepth`
- ä½†å¦‚æœ `startDepth` ä¸åŒï¼Œä¸¤ä¸ªåˆ†æ”¯çš„æ·±åº¦å°±ä¸ä¸€è‡´äº†

**è°ƒç”¨åœºæ™¯ï¼š**
```typescript
// flushPendingOutputs ä¸­
for (const rule of pending) {
    if (rule.shouldBreakLine) {
        this.printSingleRule([rule], currentDepth)  // â† æ¯æ¬¡åªä¼ å…¥ 1 ä¸ªè§„åˆ™
        currentDepth++  // â† æ·±åº¦é€’å¢
    }
}
```

**ç»“æœï¼š**
- ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼š`printSingleRule([Branch #1], 3)` â†’ æ·±åº¦ 3
- ç¬¬äºŒæ¬¡è°ƒç”¨ï¼š`printSingleRule([Branch #2], 4)` â†’ æ·±åº¦ 4 âŒ
- **åŒä¸€ä¸ª Or çš„ä¸¤ä¸ªåˆ†æ”¯æ·±åº¦ä¸ä¸€è‡´ï¼**

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šä¿®å¤æ·±åº¦è®¡ç®—é€»è¾‘

```typescript
static printSingleRule(rules: RuleStackItem[], startDepth: number): void {
    rules.forEach((item, index) => {
        // âœ… ä¿®å¤ï¼šOr åˆ†æ”¯èŠ‚ç‚¹ä¸é€’å¢æ·±åº¦
        let depth = startDepth
        if (!item.orBranchInfo?.isOrBranch) {
            depth = startDepth + index
        }
        // ...
    })
}
```

### æ–¹æ¡ˆ 2ï¼šåœ¨ flush æ—¶ä¸é€’å¢æ·±åº¦

```typescript
for (const rule of pending) {
    if (rule.shouldBreakLine) {
        this.printSingleRule([rule], currentDepth)
        // âœ… ä¿®å¤ï¼šOr åˆ†æ”¯èŠ‚ç‚¹ä¸é€’å¢æ·±åº¦
        if (!rule.orBranchInfo?.isOrBranch) {
            currentDepth++
        }
    }
}
```

### æ–¹æ¡ˆ 3ï¼šé‡æ–°è®¾è®¡ Or èŠ‚ç‚¹çš„è¾“å‡º

å°† Or åŒ…è£¹èŠ‚ç‚¹å’Œå…¶æ‰€æœ‰åˆ†æ”¯ä½œä¸ºä¸€ä¸ªæ•´ä½“è¾“å‡ºï¼Œè€Œä¸æ˜¯åˆ†æ•£è¾“å‡ºã€‚

