# Slime - JavaScript ES6 Parser & Generator

## 项目定位
适用于编辑器场景的高容错JavaScript/TypeScript解析器和代码生成器，支持包含各种错误的代码尽可能解析

**核心价值：**
- 高容错性：支持解析包含错误的代码
- ESTree兼容：AST结构遵循ESTree标准
- 完整ES6支持：100%覆盖ES6核心特性
- 代码生成：AST到代码的高质量生成

## 当前阶段
STAGE_4_OPTIMIZATION

## 当前状态
- ✅ ES5语法：100% 完全支持
- ✅ ES6语法：100% 完全支持
- ✅ 测试覆盖：50个测试用例，从简单到复杂
- ✅ 生产可用：企业级标准
- 版本：0.2.0
- 测试用例：50个（01-50，简单→复杂）

## 下一步行动
运行测试用例，验证所有ES6特性的支持度

---

# 【核心需求层】

## 核心功能（用户能做什么）
- **JavaScript解析**：ES5/ES6代码 → CST → AST
- **代码生成**：AST → JavaScript代码
- **容错解析**：支持包含错误的代码
- **源码映射**：保留位置信息

## 技术方向（设备支持、性能要求）
**默认技术栈：** Subhuti (Parser Generator) + TypeScript
**运行环境：**
- Node.js 16+
- TypeScript 5.8+
- 性能：中等复杂代码 < 100ms

## 测试架构
**tests目录结构（扁平化）：**
```
tests/
├── TEST_CASES_PLAN.md  # 测试清单
├── cases/              # 所有测试用例（01-50编号，简单→复杂，禁止分子目录）
│   ├── 01-literals-basic.js
│   ├── 02-literals-numbers.js
│   ├── ...
│   └── 50-comprehensive.js
└── ai/
    ├── .msg.txt        # 临时消息（⚠️ 禁止删除）
    └── log-from-file.js # 追加工具
```

**设计理念：**
- 扁平化：所有测试用例平铺在`tests/cases/`下
- 禁止：按类型创建子目录（single/、combined/、comprehensive/等）
- 统一编号：`01-功能名.js`（两位数）
- 复杂度排序：简单→复杂，方便按顺序测试

**测试工具：**
```bash
# 单个测试
npx tsx test-runner.ts tests/cases/01-literals-basic.js

# 顺序测试（所有用例）
npx tsx test-all.ts

# 并行测试（推荐）
npx tsx test-runner-parallel.ts
```

## 优先级（第一版做什么）
**P0-核心功能（已完成）：**
- ✅ ES5完整支持
- ✅ ES6核心语法

**P1-高级功能（已完成）：**
- ✅ 解构赋值（所有形式）
- ✅ Spread/Rest（所有场景）
- ✅ 模块系统（import/export）
- ✅ 类和继承

**P2-优化功能（进行中）：**
- 🔄 测试覆盖验证
- 🔄 性能优化
- 🔄 错误恢复增强

---

# 【细节实现层】

## 技术栈详情
- **解析器框架**：Subhuti 0.1.3
- **AST工具**：Slime系列（自研）
- **类型支持**：TypeScript 5.8.3
- **测试工具**：自定义测试运行器

## 模块架构
```
slime/
├── packages/
│   ├── slime-parser/      # 解析器（CST生成）
│   ├── slime-ast/         # AST模型定义
│   ├── slime-generator/   # 代码生成器
│   ├── slime-token/       # Token类型定义
│   └── slime-syntax/      # 语法类型定义
├── tests/                 # 测试用例
├── test-runner.ts         # 单测运行器
├── test-all.ts            # 顺序测试
└── test-runner-parallel.ts # 并行测试
```

## 编译流程
1. **词法分析**（SubhutiLexer）→ Token流
2. **语法分析**（Es6Parser）→ CST具体语法树
3. **AST转换**（SlimeCstToAst）→ AST抽象语法树
4. **代码生成**（SlimeGenerator）→ JavaScript代码

## 测试覆盖清单（50个用例）

| 分类 | 测试编号 | 数量 | 说明 |
|------|---------|------|------|
| **基础字面量** | 01-05 | 5个 | 数字、字符串、模板、数组、对象 |
| **变量声明** | 06-10 | 5个 | let、const、var、作用域、遮蔽 |
| **传统函数** | 11-13 | 3个 | 函数声明、表达式、IIFE |
| **箭头函数** | 14-18 | 5个 | 各种形式的箭头函数 |
| **数组解构** | 19-22 | 4个 | 基础、跳过、rest、嵌套 |
| **对象解构** | 23-26 | 4个 | 基础、重命名、嵌套、默认值 |
| **Spread/Rest** | 27-32 | 6个 | 数组、函数、解构、混合 |
| **类** | 33-38 | 6个 | 基础、继承、static、getter/setter |
| **模块** | 39-44 | 6个 | export、import、重命名、from |
| **高级特性** | 45-50 | 6个 | Generator、Async、Promise、Symbol |

### ES6特性详细清单

**✅ 完全支持（100%）**

1. **基础语法**
   - Let/Const声明
   - Arrow Functions（所有形式）
   - Template Literals（基础、多行、插值、Tagged）
   - Default Parameters

2. **解构（完整支持）**
   - 数组解构基础：`const [a, b] = arr`
   - 数组跳过元素：`const [a, , c] = arr`
   - 数组rest解构：`const [first, ...rest] = arr`
   - 对象解构简写：`const {name, age} = obj`
   - 对象解构重命名：`const {name: userName} = obj`
   - 参数解构：`function({name, age})`

3. **Classes**
   - 基础class、constructor、实例方法
   - 继承（extends）、super调用
   - static方法、getter/setter
   - 计算属性名

4. **Modules（完整支持）**
   - export default（function、class、expression）
   - export named（const、function）
   - export重命名：`export {name as userName}`
   - import default、import {named}、import * as
   - import重命名：`import {name as userName}`
   - export from：`export {name} from './module.js'`

5. **Spread/Rest（完整支持）**
   - 数组spread：`[...arr]`
   - 函数调用spread：`func(...args)`
   - Rest参数：`function(...args)`
   - 数组rest解构：`const [first, ...rest] = arr`

6. **高级特性**
   - Promises、Generators、Async/Await
   - For-of、Symbol、Map/Set
   - new.target、Proxy、Reflect
   - Enhanced Objects、Binary/Octal literals

**❌ 不支持的ES7+特性（按设计）**
- 对象spread：`{...obj}`（ES2018）
- 对象rest：`const {a, ...rest} = obj`（ES2018）
- Optional chaining：`obj?.prop`（ES2020）
- Nullish coalescing：`a ?? b`（ES2020）

---

# 【快速开始指南】

## 安装依赖
```bash
cd slime
npm install
```

## 运行测试
```bash
# 单个测试
npx tsx test-runner.ts tests/cases/01-literals-basic.js

# 顺序测试（所有用例）
npx tsx test-all.ts

# 并行测试（推荐，~10秒）
npx tsx test-runner-parallel.ts
```

## 使用示例
```typescript
import Es6Parser from './packages/slime-parser/src/language/es2015/Es6Parser.ts'
import { es6Tokens } from './packages/slime-parser/src/language/es2015/Es6Tokens.ts'
import SubhutiLexer from '../subhuti/src/parser/SubhutiLexer.ts'
import { SlimeCstToAst } from './packages/slime-parser/src/language/SlimeCstToAstUtil.ts'
import SlimeGenerator from './packages/slime-generator/src/SlimeGenerator.ts'

// 1. 词法分析
const lexer = new SubhutiLexer(es6Tokens)
const tokens = lexer.lexer(code)

// 2. 语法分析
const parser = new Es6Parser(tokens)
const cst = parser.Program()

// 3. CST -> AST
const slimeCstToAst = new SlimeCstToAst()
const ast = slimeCstToAst.toProgram(cst)

// 4. 代码生成
const result = SlimeGenerator.generator(ast, tokens)
console.log(result.code)
```

---

# 变更记录

## 2025-10-17 [测试用例创建]
- 创建50个测试用例（01-50），覆盖ES6所有核心特性
- 创建测试工具：test-all.ts、test-runner-parallel.ts
- 创建断点重续工具：tests/ai/log-from-file.js、.msg.txt
- 创建测试清单：tests/TEST_CASES_PLAN.md
- 创建项目文档：.cursor/rules/project.mdc
- 测试用例扁平化：tests/cases/下统一编号，不分子目录
