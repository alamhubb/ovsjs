# Subhuti Parser - å›æº¯æœºåˆ¶ä¿®å¤æ–‡æ¡£

> ä¿®å¤æ—¶é—´ï¼š2025-11-02  
> é—®é¢˜çº§åˆ«ï¼šP0ï¼ˆæ ¸å¿ƒæœºåˆ¶ç¼ºé™·ï¼‰  
> ä¿®å¤æ–¹å¼ï¼šå†™æ—¶å¤åˆ¶ï¼ˆCopy-on-Writeï¼‰  

---

## ğŸ“‹ ç›®å½•

1. [é—®é¢˜ç°è±¡](#é—®é¢˜ç°è±¡)
2. [æ ¹æœ¬åŸå› ](#æ ¹æœ¬åŸå› )
3. [ä¿®å¤æ–¹æ¡ˆ](#ä¿®å¤æ–¹æ¡ˆ)
4. [ä¿®å¤æ•ˆæœ](#ä¿®å¤æ•ˆæœ)
5. [æŠ€æœ¯ç»†èŠ‚](#æŠ€æœ¯ç»†èŠ‚)
6. [ç»éªŒæ€»ç»“](#ç»éªŒæ€»ç»“)

---

## é—®é¢˜ç°è±¡

### ç—‡çŠ¶

CSTï¼ˆConcrete Syntax Treeï¼‰ä¸­å‡ºç°å¤§é‡ç©ºèŠ‚ç‚¹ï¼Œå æ¯”é«˜è¾¾ **80%+**

### å¤ç°ä»£ç 

```javascript
Math.max(1, 2) + Math.min(5, 3)
```

### é—®é¢˜è¾“å‡º

```json
{
  "name": "NewExpression",
  "children": []  // âŒ ç©ºèŠ‚ç‚¹
},
{
  "name": "PostfixExpression",
  "children": []  // âŒ ç©ºèŠ‚ç‚¹
},
{
  "name": "UnaryExpression",
  "children": []  // âŒ ç©ºèŠ‚ç‚¹
}
// ... æ•°ç™¾ä¸ªç©ºèŠ‚ç‚¹
```

### å½±å“èŒƒå›´

- âŒ CST ä½“ç§¯è†¨èƒ€ï¼ˆç©ºèŠ‚ç‚¹å  80%+ï¼‰
- âŒ AST è½¬æ¢å›°éš¾ï¼ˆéœ€è¦è¿‡æ»¤å¤§é‡ç©ºèŠ‚ç‚¹ï¼‰
- âŒ ä»£ç ç”Ÿæˆå¤±è´¥ï¼ˆç©ºèŠ‚ç‚¹å¯¼è‡´é€»è¾‘é”™è¯¯ï¼‰
- âŒ å†…å­˜æµªè´¹ï¼ˆå¤§é‡æ— ç”¨èŠ‚ç‚¹ï¼‰

---

## æ ¹æœ¬åŸå› 

### é—®é¢˜ä»£ç 

**ä¿®å¤å‰çš„å›æº¯å®ç°**ï¼š

```typescript
interface BacktrackData {
    tokenIndex: number  // âœ… åªä¿å­˜ token ä½ç½®
    // âŒ æ²¡æœ‰ä¿å­˜ CST çŠ¶æ€
}

private saveState(): BacktrackData {
    return {
        tokenIndex: this.tokenIndex
    }
}

private restoreState(data: BacktrackData) {
    this.tokenIndex = data.tokenIndex
    // âŒ æ²¡æœ‰æ¸…ç†å¤±è´¥åˆ†æ”¯çš„å­èŠ‚ç‚¹
}
```

### é—®é¢˜åˆ†æ

**é”™è¯¯å‡è®¾**ï¼š  
> "CST é‡‡ç”¨'æˆåŠŸæ‰æ·»åŠ 'æ¨¡å¼ï¼Œå¤±è´¥æ—¶ CST ä»æœªè¢«æ·»åŠ ï¼Œæ— éœ€å›é€€"

**å®é™…æƒ…å†µ**ï¼š  
åœ¨ Or è§„åˆ™ä¸­ï¼Œåˆ†æ”¯å¤±è´¥å‰å¯èƒ½å·²ç»ï¼š
1. åˆ›å»ºäº† CST èŠ‚ç‚¹ï¼ˆé€šè¿‡ `new SubhutiCst()`ï¼‰
2. å°†èŠ‚ç‚¹æ·»åŠ åˆ°çˆ¶èŠ‚ç‚¹çš„ children æ•°ç»„
3. ç„¶åæ‰æŠ›å‡ºå¼‚å¸¸å¤±è´¥

**æ‰§è¡Œæµç¨‹ç¤ºä¾‹**ï¼š

```typescript
// Or è§„åˆ™å°è¯•ç¬¬ä¸€ä¸ªåˆ†æ”¯
Or([
  {alt: () => {
    this.NewExpression()       // åˆ›å»ºç©ºèŠ‚ç‚¹
    this.consume('SomeTok')    // âŒ å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸
  }},
  {alt: () => {
    this.CallExpression()      // âœ… æˆåŠŸ
  }}
])

// å›æº¯åï¼š
// - tokenIndex æ¢å¤äº† âœ…
// - NewExpression çš„ç©ºèŠ‚ç‚¹è¿˜åœ¨çˆ¶ CST ä¸­ âŒ
```

---

## ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆé€‰æ‹©

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | ç»“è®º |
|-----|------|------|------|
| æ·±åº¦å¤åˆ¶ CST | ç®€å•ç›´æ¥ | æ€§èƒ½å·®ï¼Œå†…å­˜å ç”¨å¤§ | âŒ ä¸å¯è¡Œ |
| å¼•ç”¨è®¡æ•° | ç²¾ç¡®æ§åˆ¶ | å¤æ‚ï¼Œå®¹æ˜“å‡ºé”™ | âŒ è¿‡åº¦è®¾è®¡ |
| **å†™æ—¶å¤åˆ¶** | **ç®€å•ã€é«˜æ•ˆ** | **éœ€è¦è®°å½•é•¿åº¦** | **âœ… æœ€ä¼˜** |

### å†™æ—¶å¤åˆ¶å®ç°

**æ ¸å¿ƒæ€è·¯**ï¼š
- ä¿å­˜çŠ¶æ€æ—¶ï¼šè®°å½•æ¯å±‚ CST çš„ children æ•°ç»„é•¿åº¦
- å›æº¯æ—¶ï¼šæˆªæ–­ children æ•°ç»„åˆ°ä¿å­˜çš„é•¿åº¦

**ä¿®å¤ä»£ç **ï¼š

```typescript
// 1. æ‰©å±•å›æº¯æ•°æ®ç»“æ„
interface BacktrackData {
    tokenIndex: number
    cstChildrenLengths: number[]  // âœ… æ–°å¢ï¼šè®°å½•æ¯å±‚ CST çš„ children é•¿åº¦
}

// 2. ä¿å­˜çŠ¶æ€ï¼šè®°å½•é•¿åº¦
private saveState(): BacktrackData {
    // ä¿å­˜æ¯å±‚ CST çš„ children é•¿åº¦
    const cstChildrenLengths = this.cstStack.map(cst => 
        cst.children ? cst.children.length : 0
    )
    
    return {
        tokenIndex: this.tokenIndex,
        cstChildrenLengths
    }
}

// 3. æ¢å¤çŠ¶æ€ï¼šæˆªæ–­æ•°ç»„
private restoreState(data: BacktrackData) {
    // æ¢å¤ token ä½ç½®
    this.tokenIndex = data.tokenIndex
    
    // æˆªæ–­æ¯å±‚ CST çš„ children æ•°ç»„ï¼ˆç§»é™¤å¤±è´¥åˆ†æ”¯çš„èŠ‚ç‚¹ï¼‰
    for (let i = 0; i < this.cstStack.length && i < data.cstChildrenLengths.length; i++) {
        const cst = this.cstStack[i]
        const savedLength = data.cstChildrenLengths[i]
        
        if (cst.children && cst.children.length > savedLength) {
            // å…³é”®ï¼šæˆªæ–­æ•°ç»„åˆ°ä¿å­˜çš„é•¿åº¦
            cst.children.length = savedLength
        }
    }
}
```

### ä¸ºä»€ä¹ˆæœ‰æ•ˆï¼Ÿ

JavaScript æ•°ç»„çš„ `length` å±æ€§æ˜¯å¯å†™çš„ï¼š

```javascript
const arr = [1, 2, 3, 4, 5]
arr.length = 2  // æˆªæ–­æ•°ç»„
console.log(arr)  // [1, 2]
```

è®¾ç½®æ›´å°çš„ `length` ä¼šï¼š
- âœ… ç«‹å³åˆ é™¤å¤šä½™çš„å…ƒç´ 
- âœ… æ—¶é—´å¤æ‚åº¦ O(1)
- âœ… å†…å­˜è‡ªåŠ¨å›æ”¶
- âœ… ä¸éœ€è¦æ‰‹åŠ¨éå†åˆ é™¤

---

## ä¿®å¤æ•ˆæœ

### æµ‹è¯• 1ï¼šç®€å•è¡¨è¾¾å¼ `a`

**ä¿®å¤å‰**ï¼š
```
æ€»èŠ‚ç‚¹æ•°: 100+
ç©ºèŠ‚ç‚¹æ•°: 80+ (80%+)
âŒ å¤§é‡ç©ºèŠ‚ç‚¹
```

**ä¿®å¤å**ï¼š
```
æ€»èŠ‚ç‚¹æ•°: 23
ç©ºèŠ‚ç‚¹æ•°: 3 (13.04%)
âœ… æ— é‡å¤ tokenï¼ˆå›æº¯æˆåŠŸï¼‰
âœ… ç©ºèŠ‚ç‚¹æ•°é‡åˆç†
```

### æµ‹è¯• 2ï¼šå¤æ‚è¡¨è¾¾å¼ `Math.max(1, 2) + Math.min(5, 3)`

**ä¿®å¤å‰**ï¼š
```
æ€»èŠ‚ç‚¹æ•°: 500+
ç©ºèŠ‚ç‚¹æ•°: 400+ (80%+)
âŒ CST ä¸¥é‡æ±¡æŸ“
```

**ä¿®å¤å**ï¼š
```
æ€»èŠ‚ç‚¹æ•°: 67
ç©ºèŠ‚ç‚¹æ•°: 9 (13.43%)
âœ… æ— é‡å¤ tokenï¼ˆå›æº¯æˆåŠŸï¼‰
âœ… CST ç»“æ„æ¸…æ™°
```

### å‰©ä½™ç©ºèŠ‚ç‚¹è¯´æ˜

ä¿®å¤åå‰©ä½™çš„ 9 ä¸ªç©ºèŠ‚ç‚¹éƒ½æ˜¯**åˆç†çš„**ï¼š

1. **PostfixExpression** (3ä¸ª)
   - è§„åˆ™ï¼š`Option(() => this.PlusPlusTok() | this.MinusMinusTok())`
   - è¯­ä¹‰ï¼šå¯é€‰çš„åç¼€è¿ç®—ç¬¦ï¼ˆ`i++`, `i--`ï¼‰
   - 0æ¬¡åŒ¹é…ï¼šæ­£å¸¸æƒ…å†µï¼ˆå¦‚ `a` æ²¡æœ‰åç¼€ï¼‰

2. **UnaryExpression** (4ä¸ª)
   - è§„åˆ™ï¼š`Option(() => this.Plus() | this.Minus() | ...)`
   - è¯­ä¹‰ï¼šå¯é€‰çš„ä¸€å…ƒè¿ç®—ç¬¦ï¼ˆ`+1`, `-1`, `!x`ï¼‰
   - 0æ¬¡åŒ¹é…ï¼šæ­£å¸¸æƒ…å†µï¼ˆå¦‚ `a` ä¸æ˜¯ä¸€å…ƒè¡¨è¾¾å¼ï¼‰

3. **EmptySemicolon** (1ä¸ª)
   - è§„åˆ™ï¼šç©ºåˆ†å·è§„åˆ™ï¼ˆASI - Automatic Semicolon Insertionï¼‰
   - è¯­ä¹‰ï¼šè‡ªåŠ¨åˆ†å·æ’å…¥
   - ç©º childrenï¼š**è®¾è®¡å¦‚æ­¤**

4. **LeftHandSideExpression** (1ä¸ª)
   - è§„åˆ™ï¼š`Or([OptionalExpression, CallExpression, NewExpression])`
   - è¯­ä¹‰ï¼šæŸäº›æƒ…å†µä¸‹çš„å›é€€åˆ†æ”¯
   - ç©º childrenï¼šç‰¹æ®Šæƒ…å†µ

---

## æŠ€æœ¯ç»†èŠ‚

### æ€§èƒ½åˆ†æ

| æ“ä½œ | ä¿®å¤å‰ | ä¿®å¤å | å½±å“ |
|-----|--------|--------|------|
| saveState() | O(1) | O(n) | n = cstStack.lengthï¼ˆé€šå¸¸ < 50ï¼‰ |
| restoreState() | O(1) | O(n) | n = cstStack.lengthï¼ˆé€šå¸¸ < 50ï¼‰ |
| æ•°ç»„æˆªæ–­ | - | O(1) | JavaScript å†…ç½®ä¼˜åŒ– |
| å†…å­˜å ç”¨ | å¤§é‡ç©ºèŠ‚ç‚¹ | æ­£å¸¸ | å‡å°‘ 80%+ æ— ç”¨èŠ‚ç‚¹ |

**ç»“è®º**ï¼šæ€§èƒ½å½±å“å¯å¿½ç•¥ï¼Œå†…å­˜ä¼˜åŒ–æ˜¾è‘—

### ç©ºé—´å¤æ‚åº¦

- **saveState()**: O(n)ï¼Œn = cstStack.length
- **BacktrackData**: O(n)ï¼Œåªå­˜å‚¨æ•´æ•°æ•°ç»„
- **æ€»ä½“å½±å“**: æ¯æ¬¡å›æº¯å¢åŠ  ~200 bytesï¼ˆå‡è®¾ 50 å±‚ï¼‰

### æ—¶é—´å¤æ‚åº¦

- **ä¿å­˜é•¿åº¦**: O(n) - éå† cstStack
- **æˆªæ–­æ•°ç»„**: O(1) - JavaScript å†…ç½®
- **æ€»ä½“**: O(n)ï¼Œn é€šå¸¸ < 50

---

## ç»éªŒæ€»ç»“

### è®¾è®¡æ•™è®­

âŒ **é”™è¯¯å‡è®¾**ï¼š
> "æˆåŠŸæ‰æ·»åŠ "ç­–ç•¥åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½æœ‰æ•ˆ

âœ… **æ­£ç¡®ç†è§£**ï¼š
> Or è§„åˆ™çš„åˆ†æ”¯å¤±è´¥å‰ï¼Œå­èŠ‚ç‚¹å¯èƒ½å·²ç»æ·»åŠ åˆ°çˆ¶èŠ‚ç‚¹

âŒ **é”™è¯¯åšæ³•**ï¼š
> åªä¿å­˜ tokenIndexï¼Œè®¤ä¸º CST ä¼šè‡ªåŠ¨å›æ»š

âœ… **æ­£ç¡®åšæ³•**ï¼š
> ä¿å­˜æ‰€æœ‰å¯å˜çŠ¶æ€ï¼ŒåŒ…æ‹¬ CST ç»“æ„

### æœ€ä½³å®è·µ

1. **å›æº¯æ•°æ®è¦å®Œæ•´**
   - åŒ…å«æ‰€æœ‰å¯èƒ½è¢«ä¿®æ”¹çš„çŠ¶æ€
   - ä¸è¦å‡è®¾æŸäº›çŠ¶æ€"ä¸ä¼šè¢«ä¿®æ”¹"

2. **ä½¿ç”¨é«˜æ•ˆçš„æ¢å¤ç­–ç•¥**
   - ä¼˜å…ˆè€ƒè™‘"å†™æ—¶å¤åˆ¶"
   - é¿å…æ·±åº¦å¤åˆ¶ï¼ˆæ€§èƒ½æ€æ‰‹ï¼‰

3. **æµ‹è¯•è¦å…¨é¢**
   - ä¸ä»…æµ‹è¯•"èƒ½å¦è§£ææˆåŠŸ"
   - è¿˜è¦æµ‹è¯•"CST ç»“æ„æ˜¯å¦æ­£ç¡®"
   - æ£€æŸ¥ç©ºèŠ‚ç‚¹ã€é‡å¤èŠ‚ç‚¹

4. **æ–‡æ¡£è¦æ¸…æ™°**
   - æ˜ç¡®è¯´æ˜å‡è®¾å’Œé™åˆ¶
   - è®°å½•å·²çŸ¥é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### ç›¸å…³èµ„æº

- [PEG.js å›æº¯å®ç°](https://pegjs.org/)
- [Chevrotain Parser å›æº¯æœºåˆ¶](https://chevrotain.io/)
- [JavaScript æ•°ç»„æ€§èƒ½ä¼˜åŒ–](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array)

---

## ä¿®æ”¹æ¸…å•

### ä¿®æ”¹æ–‡ä»¶

- **subhuti/src/parser/SubhutiParser.ts**
  - `BacktrackData` æ¥å£ï¼š+1 å­—æ®µï¼ˆcstChildrenLengthsï¼‰
  - `saveState()` æ–¹æ³•ï¼š+3 è¡Œï¼ˆè®°å½•é•¿åº¦ï¼‰
  - `restoreState()` æ–¹æ³•ï¼š+10 è¡Œï¼ˆæˆªæ–­æ•°ç»„ï¼‰

### æµ‹è¯•æ–‡ä»¶

- **slime/tests/ppp/test-backtrack.ts**
  - å›æº¯æœºåˆ¶åŸºç¡€æµ‹è¯•
  - ç©ºèŠ‚ç‚¹ç»Ÿè®¡
  - é‡å¤ token æ£€æµ‹

- **slime/tests/ppp/test-complex.ts**
  - å¤æ‚è¡¨è¾¾å¼æµ‹è¯•
  - CST å®Œæ•´æ€§éªŒè¯

### æ–‡æ¡£æ›´æ–°

- **subhuti/CHANGELOG.md** - å˜æ›´æ—¥å¿—
- **subhuti/REWRITE_PLAN.md** - å®é™…ä¿®å¤è®°å½•
- **subhuti/docs/BACKTRACK_FIX.md** - æœ¬æ–‡æ¡£

---

## é™„å½•

### A. æµ‹è¯•è¾“å‡ºç¤ºä¾‹

```bash
$ npx tsx tests/ppp/test-backtrack.ts

=== Tokens ===
Identifier: "a"

=== CST ç»Ÿè®¡ ===
æ€»èŠ‚ç‚¹æ•°: 23
ç©ºèŠ‚ç‚¹æ•°: 3
ç©ºèŠ‚ç‚¹å æ¯”: 13.04%

=== ç©ºèŠ‚ç‚¹åˆ—è¡¨ ===
  PostfixExpression
  UnaryExpression
  EmptySemicolon

âœ… æ²¡æœ‰é‡å¤çš„ token èŠ‚ç‚¹ï¼ˆå›æº¯æˆåŠŸï¼‰

=== æµ‹è¯•ç»“æœ ===
âœ… æµ‹è¯•é€šè¿‡ï¼šç©ºèŠ‚ç‚¹æ•°é‡åˆç†ï¼Œæ— é‡å¤ token
```

### B. æ ¸å¿ƒä»£ç ç‰‡æ®µ

**å®Œæ•´çš„ restoreState å®ç°**ï¼š

```typescript
private restoreState(data: BacktrackData) {
    // 1. æ¢å¤ token ä½ç½®
    this.tokenIndex = data.tokenIndex
    
    // 2. æˆªæ–­æ¯å±‚ CST çš„ children æ•°ç»„
    // åŸç†ï¼šç§»é™¤å¤±è´¥åˆ†æ”¯æ·»åŠ çš„æ‰€æœ‰å­èŠ‚ç‚¹
    for (let i = 0; i < this.cstStack.length && i < data.cstChildrenLengths.length; i++) {
        const cst = this.cstStack[i]
        const savedLength = data.cstChildrenLengths[i]
        
        // åªåœ¨éœ€è¦æ—¶æˆªæ–­ï¼ˆé¿å…ä¸å¿…è¦çš„æ“ä½œï¼‰
        if (cst.children && cst.children.length > savedLength) {
            // JavaScript æ•°ç»„çš„ length å±æ€§æ˜¯å¯å†™çš„
            // è®¾ç½®æ›´å°çš„å€¼ä¼šè‡ªåŠ¨åˆ é™¤å¤šä½™çš„å…ƒç´ 
            cst.children.length = savedLength
        }
    }
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-11-02  
**ç»´æŠ¤è€…**ï¼šSubhuti Team















