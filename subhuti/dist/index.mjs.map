{"version":3,"file":"index.mjs","names":["result: SubhutiMatchToken[]","suggestions: string[]","lines: string[]","allLines: string[]","groups: RuleStackItem[][]","currentGroup: RuleStackItem[]","result","lines: string[]","values: string[]","missing: string[]","errors: Array<{ path: string, issue: string, node?: any }>","path","node","lines: string[]","error: any","ruleItem: RuleStackItem","location: string | null","orIndex: number | undefined","suggestions: string[]","result: SubhutiMatchToken[]","token: SubhutiMatchToken","errors: ValidationError[]","stats?: ValidationStats","lines: string[]","rootNode: SequenceNode","error: any","altNodes: any[]","tokenNode: ConsumeNode","path","error: any","result: string[][] | undefined","ruleASTs: Map<string, SequenceNode>","tokenCache: Map<string, ConsumeNode>","orConflictErrors: ValidationError[]","allOrs: string[][][]","allBranchAllSeq: string[][]","path","uniqueBehind: string[][]","orPossibility: number","result: number","stats: any","allLevelPaths: string[][]","allErrors: ValidationError[]","inputSize","temp: string[][]","seqKey","combined: string[]","finalArray: string[][]","result: string[][]","allBranches: string[][][]","cachedBranches: string[][] | null","expandedPaths: string[][]","branchResults: Array<{ branchName: string, paths: string[][] }>","branchAllRuleBranchSeqs: string[][][]","result","error: LeftRecursionError","SubhutiGrammarAnalyzer","SubhutiRuleCollector","SubhutiConflictDetector","error: any","path","recordNode: ParseRecordNode","recordNode","cst","recordNode: ParseRecordNode | null","selectedNodes: ParseRecordNode[]","best: ParseRecordNode | null","tokenNode: ParseRecordNode","lines: string[]"],"sources":["../src/SubhutiTokenLookahead.ts","../src/struct/SubhutiCst.ts","../src/SubhutiError.ts","../src/SubhutiDebugRuleTracePrint.ts","../src/SubhutiDebug.ts","../src/SubhutiPackratCache.ts","../src/SubhutiTokenConsumer.ts","../src/SubhutiLexer.ts","../src/validation/SubhutiValidationError.ts","../src/validation/SubhutiRuleCollector.ts","../src/validation/ArrayTria.ts","../src/validation/SubhutiGrammarAnalyzer.ts","../src/validation/SubhutiConflictDetector.ts","../src/validation/SubhutiValidationDebugger.ts","../src/validation/SubhutiValidationLogger.ts","../src/validation/SubhutiGrammarValidator.ts","../src/SubhutiParser.ts","../src/struct/SubhutiMatchToken.ts","../src/struct/SubhutiCreateToken.ts","../src/logutil.ts"],"sourcesContent":["/**\r\n * Subhuti Token Lookahead - Token å‰ç»åŸºç¡€ç±»ï¼ˆæŠ½è±¡ï¼‰\r\n *\r\n * èŒè´£ï¼š\r\n * 1. Token å‰ç»ï¼ˆåªè¯»æŸ¥è¯¢ï¼‰\r\n * 2. è¡Œç»ˆæ­¢ç¬¦æ£€æŸ¥\r\n * 3. å¯¹åº” ECMAScriptÂ® 2025 è§„èŒƒä¸­çš„æ‰€æœ‰ [lookahead ...] çº¦æŸ\r\n *\r\n * è®¾è®¡æ¨¡å¼ï¼š\r\n * - æŠ½è±¡ç±»ï¼Œå®šä¹‰è®¿é—®æ¥å£\r\n * - å­ç±»ï¼ˆSubhutiParserï¼‰å®ç°å…·ä½“è®¿é—®é€»è¾‘\r\n * - å®Œå…¨åŸºäºæŒ‰éœ€è¯æ³•åˆ†æï¼ˆOn-Demand Lexingï¼‰\r\n *\r\n * è§„èŒƒåœ°å€ï¼šhttps://tc39.es/ecma262/2025/#sec-grammar-summary\r\n *\r\n * @version 4.0.0 - ç§»é™¤æ—§æ¨¡å¼ï¼Œåªä¿ç•™æŒ‰éœ€è¯æ³•åˆ†æ\r\n */\r\n\r\nimport type SubhutiMatchToken from \"./struct/SubhutiMatchToken.ts\"\r\n\r\nexport default class SubhutiTokenLookahead {\r\n    // ============================================\r\n    // æ ¸å¿ƒçŠ¶æ€\r\n    // ============================================\r\n\r\n    /**\r\n     * æ ¸å¿ƒçŠ¶æ€ï¼šå½“å‰è§„åˆ™æ˜¯å¦æˆåŠŸ\r\n     * - true: æˆåŠŸï¼Œç»§ç»­æ‰§è¡Œ\r\n     * - false: å¤±è´¥ï¼Œåœæ­¢å¹¶è¿”å› undefined\r\n     */\r\n    protected _parseSuccess = true\r\n\r\n    get parserFail() {\r\n        return !this._parseSuccess\r\n    }\r\n\r\n    /**\r\n     * æ ‡è®°è§£æå¤±è´¥ï¼ˆç”¨äºæ‰‹åŠ¨å¤±è´¥ï¼‰\r\n     *\r\n     * ç”¨äºè‡ªå®šä¹‰éªŒè¯é€»è¾‘ä¸­æ ‡è®°è§£æå¤±è´¥\r\n     *\r\n     * @returns never (å®é™…è¿”å› undefinedï¼Œä½†ç±»å‹å£°æ˜ä¸º never ä»¥ä¾¿é“¾å¼è°ƒç”¨)\r\n     */\r\n    protected setParseFail(): never {\r\n        this._parseSuccess = false\r\n        return undefined as never\r\n    }\r\n\r\n    /**\r\n     * è·å–å½“å‰ tokenï¼ˆç”±å­ç±»å®ç°ï¼‰\r\n     */\r\n    get curToken(): SubhutiMatchToken | undefined {\r\n        // å­ç±» SubhutiParser ä¼šè¦†ç›–æ­¤ getter\r\n        return undefined\r\n    }\r\n\r\n    // ============================================\r\n    // å±‚çº§ 1ï¼šç§æœ‰æŸ¥è¯¢æ–¹æ³•ï¼ˆå†…éƒ¨å®ç°ï¼Œè¿”å› booleanï¼‰\r\n    // ============================================\r\n\r\n    /**\r\n     * å‰ç»ï¼šè·å–æœªæ¥çš„ tokenï¼ˆä¸æ¶ˆè´¹ï¼‰\r\n     * ç”±å­ç±» SubhutiParser è¦†ç›–å®ç°\r\n     *\r\n     * @param offset åç§»é‡ï¼ˆ1 = å½“å‰ tokenï¼Œ2 = ä¸‹ä¸€ä¸ª...ï¼‰\r\n     * @returns token æˆ– undefinedï¼ˆEOFï¼‰\r\n     */\r\n    protected peek(offset: number = 1): SubhutiMatchToken | undefined {\r\n        // å­ç±» SubhutiParser ä¼šè¦†ç›–æ­¤æ–¹æ³•\r\n        return undefined\r\n    }\r\n\r\n    /**\r\n     * LA (LookAhead) - å‰ç»è·å– tokenï¼ˆä¸æ¶ˆè´¹ï¼‰\r\n     *\r\n     * è¿™æ˜¯ parser é¢†åŸŸçš„æ ‡å‡†æœ¯è¯­ï¼š\r\n     * - LA(1) = å½“å‰ token\r\n     * - LA(2) = ä¸‹ä¸€ä¸ª token\r\n     * - LA(n) = ç¬¬ n ä¸ª token\r\n     *\r\n     * @param offset åç§»é‡ï¼ˆ1 = å½“å‰ tokenï¼Œ2 = ä¸‹ä¸€ä¸ª...ï¼‰\r\n     * @returns token æˆ– undefinedï¼ˆEOFï¼‰\r\n     */\r\n    protected LA(offset: number = 1): SubhutiMatchToken | undefined {\r\n        return this.peek(offset)\r\n    }\r\n\r\n    /**\r\n     * å‰ç»ï¼šè·å–è¿ç»­çš„ N ä¸ª token\r\n     *\r\n     * @param count è¦è·å–çš„ token æ•°é‡\r\n     * @returns token æ•°ç»„ï¼ˆé•¿åº¦å¯èƒ½å°äº countï¼Œå¦‚æœé‡åˆ° EOFï¼‰\r\n     */\r\n    private peekSequence(count: number): SubhutiMatchToken[] {\r\n        const result: SubhutiMatchToken[] = []\r\n        for (let i = 1; i <= count; i++) {\r\n            const token = this.peek(i)\r\n            if (!token) break\r\n            result.push(token)\r\n        }\r\n        return result\r\n    }\r\n\r\n    /**\r\n     * [lookahead = token]\r\n     * è§„èŒƒï¼šæ­£å‘å‰ç»ï¼Œæ£€æŸ¥ä¸‹ä¸€ä¸ª token æ˜¯å¦åŒ¹é…\r\n     */\r\n    private lookahead(tokenName: string, offset: number = 1): boolean {\r\n        return this.peek(offset)?.tokenName === tokenName\r\n    }\r\n\r\n    /**\r\n     * [lookahead â‰  token]\r\n     * è§„èŒƒï¼šå¦å®šå‰ç»ï¼Œæ£€æŸ¥ä¸‹ä¸€ä¸ª token æ˜¯å¦ä¸åŒ¹é…\r\n     */\r\n    private lookaheadNot(tokenName: string, offset: number = 1): boolean {\r\n        const token = this.peek(offset)\r\n        // EOF æ—¶è¿”å› trueï¼ˆè®¤ä¸º\"ä¸æ˜¯ä»»ä½•å…·ä½“ token\"ï¼‰\r\n        return token ? token.tokenName !== tokenName : true\r\n    }\r\n\r\n    /**\r\n     * [lookahead âˆˆ {t1, t2, ...}]\r\n     * è§„èŒƒï¼šæ­£å‘é›†åˆå‰ç»ï¼Œæ£€æŸ¥ä¸‹ä¸€ä¸ª token æ˜¯å¦åœ¨é›†åˆä¸­\r\n     */\r\n    private lookaheadIn(tokenNames: string[], offset: number = 1): boolean {\r\n        const token = this.peek(offset)\r\n        return token ? tokenNames.includes(token.tokenName) : false\r\n    }\r\n\r\n    /**\r\n     * [lookahead âˆ‰ {t1, t2, ...}]\r\n     * è§„èŒƒï¼šå¦å®šé›†åˆå‰ç»ï¼Œæ£€æŸ¥ä¸‹ä¸€ä¸ª token æ˜¯å¦ä¸åœ¨é›†åˆä¸­\r\n     */\r\n    private lookaheadNotIn(tokenNames: string[], offset: number = 1): boolean {\r\n        const token = this.peek(offset)\r\n        // EOF æ—¶è¿”å› trueï¼ˆè®¤ä¸º\"ä¸åœ¨ä»»ä½•é›†åˆä¸­\"ï¼‰\r\n        return token ? !tokenNames.includes(token.tokenName) : true\r\n    }\r\n\r\n    /**\r\n     * [lookahead = t1 t2 ...]\r\n     * è§„èŒƒï¼šåºåˆ—å‰ç»ï¼Œæ£€æŸ¥è¿ç»­çš„ token åºåˆ—æ˜¯å¦åŒ¹é…\r\n     */\r\n    private lookaheadSequence(tokenNames: string[]): boolean {\r\n        const peeked = this.peekSequence(tokenNames.length)\r\n        if (peeked.length !== tokenNames.length) {\r\n            return false\r\n        }\r\n        return peeked.every((token, i) => token.tokenName === tokenNames[i])\r\n    }\r\n\r\n    /**\r\n     * [lookahead â‰  t1 t2 ...]\r\n     * è§„èŒƒï¼šå¦å®šåºåˆ—å‰ç»ï¼Œæ£€æŸ¥è¿ç»­çš„ token åºåˆ—æ˜¯å¦ä¸åŒ¹é…\r\n     */\r\n    private lookaheadNotSequence(tokenNames: string[]): boolean {\r\n        return !this.lookaheadSequence(tokenNames)\r\n    }\r\n\r\n\r\n    /**\r\n     * æ£€æŸ¥ï¼štoken åºåˆ—åŒ¹é…ä¸”ä¸­é—´æ— æ¢è¡Œç¬¦\r\n     *\r\n     * @param tokenNames token åç§°åºåˆ—\r\n     * @returns true = åºåˆ—åŒ¹é…ä¸”ä¸­é—´éƒ½åœ¨åŒä¸€è¡Œ\r\n     *\r\n     * @example\r\n     * // async [no LineTerminator here] function\r\n     * if (this.lookaheadSequenceNoLT(['AsyncTok', 'FunctionTok'])) { ... }\r\n     */\r\n    protected lookaheadSequenceNoLT(tokenNames: string[]): boolean {\r\n        const peeked = this.peekSequence(tokenNames.length)\r\n        if (peeked.length !== tokenNames.length) {\r\n            return false\r\n        }\r\n\r\n        // æ£€æŸ¥æ¯ä¸ª token çš„åç§°åŒ¹é…\r\n        for (let i = 0; i < tokenNames.length; i++) {\r\n            if (peeked[i].tokenName !== tokenNames[i]) {\r\n                return false\r\n            }\r\n\r\n            // æ£€æŸ¥ç¬¬äºŒä¸ªåŠä¹‹åçš„ token å‰é¢æ²¡æœ‰æ¢è¡Œç¬¦\r\n            if (i > 0 && peeked[i].hasLineBreakBefore) {\r\n                return false\r\n            }\r\n        }\r\n\r\n        return true\r\n    }\r\n\r\n    /**\r\n     * [no LineTerminator here]\r\n     * æ£€æŸ¥å½“å‰ token å‰æ˜¯å¦æœ‰æ¢è¡Œç¬¦\r\n     */\r\n    private lookaheadHasLineBreak(): boolean {\r\n        return this.curToken?.hasLineBreakBefore ?? false\r\n    }\r\n\r\n    // ============================================\r\n    // å±‚çº§ 2ï¼šå—ä¿æŠ¤çš„æ–­è¨€æ–¹æ³•\r\n    // - è‡ªåŠ¨è®¾ç½® _parseSuccess\r\n    // - è¿”å› booleanï¼Œæ”¯æŒçµæ´»ç»„åˆ\r\n    // ============================================\r\n\r\n    /**\r\n     * æ–­è¨€ï¼šå½“å‰ token å¿…é¡»æ˜¯æŒ‡å®šç±»å‹\r\n     * å¦‚æœä¸æ˜¯ï¼Œåˆ™æ ‡è®°å¤±è´¥\r\n     *\r\n     * @param tokenName - å¿…é¡»çš„ token ç±»å‹\r\n     * @param offset - åç§»é‡ï¼ˆé»˜è®¤ 1ï¼‰\r\n     * @returns æ–­è¨€æ˜¯å¦æˆåŠŸ\r\n     *\r\n     * @example\r\n     * // [lookahead = =]\r\n     * this.assertLookahead('Assign')\r\n     */\r\n    protected assertLookahead(tokenName: string, offset: number = 1): boolean {\r\n        if (!this._parseSuccess) return false\r\n\r\n        const result = this.lookahead(tokenName, offset)\r\n        if (!result) {\r\n            this._parseSuccess = false\r\n        }\r\n        return result\r\n    }\r\n\r\n    /**\r\n     * æ–­è¨€ï¼šå½“å‰ token ä¸èƒ½æ˜¯æŒ‡å®šç±»å‹\r\n     * å¦‚æœæ˜¯ï¼Œåˆ™æ ‡è®°å¤±è´¥\r\n     *\r\n     * @param tokenName - ä¸å…è®¸çš„ token ç±»å‹\r\n     * @param offset - åç§»é‡ï¼ˆé»˜è®¤ 1ï¼‰\r\n     * @returns æ–­è¨€æ˜¯å¦æˆåŠŸ\r\n     *\r\n     * @example\r\n     * // [lookahead â‰  else]\r\n     * this.assertLookaheadNot('ElseTok')\r\n     */\r\n    protected assertLookaheadNot(tokenName: string, offset: number = 1): boolean {\r\n        if (!this._parseSuccess) return false\r\n\r\n        const result = this.lookaheadNot(tokenName, offset)\r\n        if (!result) {\r\n            this._parseSuccess = false\r\n        }\r\n        return result\r\n    }\r\n\r\n    /**\r\n     * æ–­è¨€ï¼šå½“å‰ token å¿…é¡»åœ¨æŒ‡å®šé›†åˆä¸­\r\n     * å¦‚æœä¸åœ¨ï¼Œåˆ™æ ‡è®°å¤±è´¥\r\n     *\r\n     * @param tokenNames - å…è®¸çš„ token ç±»å‹åˆ—è¡¨\r\n     * @param offset - åç§»é‡ï¼ˆé»˜è®¤ 1ï¼‰\r\n     * @returns æ–­è¨€æ˜¯å¦æˆåŠŸ\r\n     *\r\n     * @example\r\n     * // [lookahead âˆˆ {8, 9}]\r\n     * this.assertLookaheadIn(['DecimalDigit8', 'DecimalDigit9'])\r\n     */\r\n    protected assertLookaheadIn(tokenNames: string[], offset: number = 1): boolean {\r\n        if (!this._parseSuccess) return false\r\n\r\n        const result = this.lookaheadIn(tokenNames, offset)\r\n        if (!result) {\r\n            this._parseSuccess = false\r\n        }\r\n        return result\r\n    }\r\n\r\n    /**\r\n     * æ–­è¨€ï¼šå½“å‰ token ä¸èƒ½åœ¨æŒ‡å®šé›†åˆä¸­\r\n     * å¦‚æœåœ¨ï¼Œåˆ™æ ‡è®°å¤±è´¥\r\n     *\r\n     * @param tokenNames - ä¸å…è®¸çš„ token ç±»å‹åˆ—è¡¨\r\n     * @param offset - åç§»é‡ï¼ˆé»˜è®¤ 1ï¼‰\r\n     * @returns æ–­è¨€æ˜¯å¦æˆåŠŸ\r\n     *\r\n     * @example\r\n     * // [lookahead âˆ‰ {{, function, class}]\r\n     * this.assertLookaheadNotIn(['LBrace', 'FunctionTok', 'ClassTok'])\r\n     */\r\n    protected assertLookaheadNotIn(tokenNames: string[], offset: number = 1): boolean {\r\n        if (!this._parseSuccess) return false\r\n\r\n        const result = this.lookaheadNotIn(tokenNames, offset)\r\n        if (!result) {\r\n            this._parseSuccess = false\r\n        }\r\n        return result\r\n    }\r\n\r\n    /**\r\n     * æ–­è¨€ï¼šå¿…é¡»æ˜¯æŒ‡å®šçš„ token åºåˆ—\r\n     * å¦‚æœä¸åŒ¹é…ï¼Œåˆ™æ ‡è®°å¤±è´¥\r\n     *\r\n     * @param tokenNames - token åºåˆ—\r\n     * @returns æ–­è¨€æ˜¯å¦æˆåŠŸ\r\n     *\r\n     * @example\r\n     * // [lookahead = async function]\r\n     * this.assertLookaheadSequence(['AsyncTok', 'FunctionTok'])\r\n     */\r\n    protected assertLookaheadSequence(tokenNames: string[]): boolean {\r\n        if (!this._parseSuccess) return false\r\n\r\n        const result = this.lookaheadSequence(tokenNames)\r\n        if (!result) {\r\n            this._parseSuccess = false\r\n        }\r\n        return result\r\n    }\r\n\r\n    /**\r\n     * æ–­è¨€ï¼šä¸èƒ½æ˜¯æŒ‡å®šçš„ token åºåˆ—\r\n     * å¦‚æœåŒ¹é…ï¼Œåˆ™æ ‡è®°å¤±è´¥\r\n     *\r\n     * @param tokenNames - token åºåˆ—\r\n     * @returns æ–­è¨€æ˜¯å¦æˆåŠŸ\r\n     *\r\n     * @example\r\n     * // [lookahead â‰  let []\r\n     * this.assertLookaheadNotSequence(['LetTok', 'LBracket'])\r\n     */\r\n    protected assertLookaheadNotSequence(tokenNames: string[]): boolean {\r\n        if (!this._parseSuccess) return false\r\n\r\n        const result = this.lookaheadNotSequence(tokenNames)\r\n        if (!result) {\r\n            this._parseSuccess = false\r\n        }\r\n        return result\r\n    }\r\n\r\n    /**\r\n     * æ–­è¨€ï¼šä¸èƒ½æ˜¯æŒ‡å®šçš„ token åºåˆ—ï¼ˆè€ƒè™‘æ¢è¡Œç¬¦çº¦æŸï¼‰\r\n     * å¦‚æœåºåˆ—åŒ¹é…ä¸”ä¸­é—´æ²¡æœ‰æ¢è¡Œç¬¦ï¼Œåˆ™æ ‡è®°å¤±è´¥\r\n     *\r\n     * @param tokenNames - token åºåˆ—\r\n     * @returns æ–­è¨€æ˜¯å¦æˆåŠŸ\r\n     *\r\n     * @example\r\n     * // [lookahead â‰  async [no LineTerminator here] function]\r\n     * this.assertLookaheadNotSequenceNoLT(['AsyncTok', 'FunctionTok'])\r\n     */\r\n    protected assertLookaheadNotSequenceNoLT(tokenNames: string[]): boolean {\r\n        if (!this._parseSuccess) return false\r\n\r\n        const result = !this.lookaheadSequenceNoLT(tokenNames)\r\n        if (!result) {\r\n            this._parseSuccess = false\r\n        }\r\n        return result\r\n    }\r\n\r\n    /**\r\n     * æ–­è¨€ï¼šå½“å‰ token å‰ä¸èƒ½æœ‰æ¢è¡Œç¬¦\r\n     * å¦‚æœæœ‰ï¼Œåˆ™æ ‡è®°å¤±è´¥\r\n     *\r\n     * @returns æ–­è¨€æ˜¯å¦æˆåŠŸ\r\n     *\r\n     * @example\r\n     * // [no LineTerminator here]\r\n     * this.assertNoLineBreak()\r\n     */\r\n    protected assertNoLineBreak(): boolean {\r\n        if (!this._parseSuccess) return false\r\n\r\n        const result = !this.lookaheadHasLineBreak()\r\n        if (!result) {\r\n            this._parseSuccess = false\r\n        }\r\n        return result\r\n    }\r\n\r\n    /**\r\n     * æ–­è¨€ï¼šæ¡ä»¶å¿…é¡»ä¸ºçœŸ\r\n     * å¦‚æœæ¡ä»¶ä¸ºå‡ï¼Œåˆ™æ ‡è®°å¤±è´¥\r\n     *\r\n     * @param condition - è¦æ£€æŸ¥çš„æ¡ä»¶\r\n     * @returns æ–­è¨€æ˜¯å¦æˆåŠŸï¼ˆå³æ¡ä»¶æœ¬èº«ï¼‰\r\n     *\r\n     * @example\r\n     * // æ–­è¨€ï¼šæ ‡è¯†ç¬¦ä¸èƒ½æ˜¯ä¿ç•™å­—\r\n     * const cst = this.tokenConsumer.Identifier()\r\n     * this.assertCondition(!(cst && ReservedWords.has(cst.value!)))\r\n     */\r\n    protected assertCondition(condition: boolean): boolean {\r\n        if (!this._parseSuccess) return false\r\n\r\n        if (!condition) {\r\n            this._parseSuccess = false\r\n        }\r\n        return condition\r\n    }\r\n\r\n\r\n    // ============================================\r\n    // Token åŒ¹é…æ–¹æ³• (Token Matching)\r\n    // ç¬¦åˆ Babel/Acorn çš„ match/isContextual è®¾è®¡æ¨¡å¼\r\n    // ============================================\r\n\r\n    /**\r\n     * æ£€æŸ¥å½“å‰ token æ˜¯å¦åŒ¹é…æŒ‡å®šç±»å‹\r\n     * å¯¹åº” Babel çš„ match æ–¹æ³•\r\n     * @param tokenName token ç±»å‹åç§°\r\n     */\r\n    protected match(tokenName: string): boolean {\r\n        return this.curToken?.tokenName === tokenName\r\n    }\r\n\r\n}\r\n\r\n","import type { SourceLocation, Position } from \"estree\";\r\n\r\nexport interface SubhutiSourceLocation extends SourceLocation {\r\n    // index?: number;\r\n    value?: string;\r\n    newLine?: boolean;\r\n    type?: string;\r\n    start: SubhutiPosition;\r\n    end: SubhutiPosition;\r\n    filename?: string;\r\n    identifierName?: string | undefined | null;\r\n}\r\n\r\nexport interface SubhutiPosition extends Position {\r\n    index: number;\r\n}\r\n\r\nexport default class SubhutiCst {\r\n    // pathName: string;\r\n    name: string;\r\n    children?: SubhutiCst[]\r\n    loc: SubhutiSourceLocation\r\n    value?: string;\r\n\r\n    constructor(cst?: SubhutiCst) {\r\n        if (cst) {\r\n            this.name = cst.name;\r\n            // this.pathName = cst.pathName;\r\n            this.children = cst.children;\r\n            this.value = cst.value;\r\n        }\r\n    }\r\n\r\n    // ========================================\r\n    // è¾…åŠ©æ–¹æ³•ï¼ˆæ–°å¢ - ç®€åŒ– CST è®¿é—®ï¼‰\r\n    // ========================================\r\n\r\n    /**\r\n     * è·å–æŒ‡å®šåç§°çš„ç¬¬ N ä¸ªå­èŠ‚ç‚¹\r\n     *\r\n     * @param name å­èŠ‚ç‚¹åç§°\r\n     * @param index ç´¢å¼•ï¼ˆé»˜è®¤ 0ï¼Œå³ç¬¬ä¸€ä¸ªï¼‰\r\n     * @returns åŒ¹é…çš„å­èŠ‚ç‚¹ï¼Œå¦‚æœä¸å­˜åœ¨è¿”å› undefined\r\n     *\r\n     * ç”¨æ³•ï¼š\r\n     * ```typescript\r\n     * const leftOperand = cst.getChild('Expression', 0)\r\n     * const rightOperand = cst.getChild('Expression', 1)\r\n     * ```\r\n     */\r\n    getChild(name: string, index: number = 0): SubhutiCst | undefined {\r\n        if (!this.children) return undefined\r\n\r\n        const matches = this.children.filter(c => c.name === name)\r\n        return matches[index]\r\n    }\r\n\r\n    /**\r\n     * è·å–æ‰€æœ‰æŒ‡å®šåç§°çš„å­èŠ‚ç‚¹\r\n     *\r\n     * @param name å­èŠ‚ç‚¹åç§°\r\n     * @returns åŒ¹é…çš„å­èŠ‚ç‚¹æ•°ç»„\r\n     *\r\n     * ç”¨æ³•ï¼š\r\n     * ```typescript\r\n     * const allStatements = cst.getChildren('Statement')\r\n     * ```\r\n     */\r\n    getChildren(name: string): SubhutiCst[] {\r\n        if (!this.children) return []\r\n\r\n        return this.children.filter(c => c.name === name)\r\n    }\r\n\r\n    /**\r\n     * è·å–æŒ‡å®šåç§°çš„ token èŠ‚ç‚¹\r\n     *\r\n     * @param tokenName Token åç§°\r\n     * @returns åŒ¹é…çš„ token èŠ‚ç‚¹ï¼Œå¦‚æœä¸å­˜åœ¨è¿”å› undefined\r\n     *\r\n     * ç”¨æ³•ï¼š\r\n     * ```typescript\r\n     * const identifier = cst.getToken('Identifier')\r\n     * console.log(identifier?.value)\r\n     * ```\r\n     */\r\n    getToken(tokenName: string): SubhutiCst | undefined {\r\n        if (!this.children) return undefined\r\n\r\n        return this.children.find(c => c.name === tokenName && c.value !== undefined)\r\n    }\r\n\r\n    /**\r\n     * æ£€æŸ¥æ˜¯å¦æœ‰æŒ‡å®šåç§°çš„å­èŠ‚ç‚¹\r\n     *\r\n     * @param name å­èŠ‚ç‚¹åç§°\r\n     * @returns å¦‚æœå­˜åœ¨è¿”å› trueï¼Œå¦åˆ™è¿”å› false\r\n     *\r\n     * ç”¨æ³•ï¼š\r\n     * ```typescript\r\n     * if (cst.hasChild('ElseClause')) {\r\n     *   // å¤„ç† else åˆ†æ”¯\r\n     * }\r\n     * ```\r\n     */\r\n    hasChild(name: string): boolean {\r\n        if (!this.children) return false\r\n\r\n        return this.children.some(c => c.name === name)\r\n    }\r\n\r\n    /**\r\n     * è·å–å­èŠ‚ç‚¹æ•°é‡\r\n     */\r\n    get childCount(): number {\r\n        return this.children?.length || 0\r\n    }\r\n\r\n    /**\r\n     * æ˜¯å¦ä¸ºå¶å­èŠ‚ç‚¹ï¼ˆtoken èŠ‚ç‚¹ï¼‰\r\n     */\r\n    get isToken(): boolean {\r\n        return this.value !== undefined\r\n    }\r\n\r\n    /**\r\n     * æ˜¯å¦ä¸ºç©ºèŠ‚ç‚¹ï¼ˆæ— å­èŠ‚ç‚¹ï¼‰\r\n     */\r\n    get isEmpty(): boolean {\r\n        return !this.children || this.children.length === 0\r\n    }\r\n}\r\n","/**\r\n * Subhuti Error - ç®€åŒ–é”™è¯¯å¤„ç†ç³»ç»Ÿï¼ˆv3.0ï¼‰\r\n * \r\n * è®¾è®¡ç†å¿µï¼š\r\n * - YAGNIï¼šåªå®ç°å®é™…éœ€è¦çš„åŠŸèƒ½\r\n * - ç®€å•ä¼˜äºå¤æ‚ï¼šä¸€ä¸ªå¥½çš„ API èƒœè¿‡ä¸¤ä¸ªå¹³åº¸çš„ API\r\n * - åŸºäºå®é™…éœ€æ±‚ï¼šåˆ é™¤æœªä½¿ç”¨çš„ ErrorDiagnoser å’Œ ErrorFormatter\r\n * \r\n * @version 3.0.0 - æç®€é‡æ„\r\n * @date 2025-11-04\r\n */\r\n\r\nimport type SubhutiMatchToken from \"./struct/SubhutiMatchToken.ts\";\r\n\r\n// ============================================\r\n// æ ¸å¿ƒé”™è¯¯å¤„ç†\r\n// ============================================\r\n\r\n/**\r\n * é”™è¯¯è¯¦æƒ…ï¼ˆå¹³é“ºç»“æ„ï¼‰\r\n */\r\nexport interface ErrorDetails {\r\n    // é€šç”¨å­—æ®µ\r\n    expected: string\r\n    found?: SubhutiMatchToken\r\n    position: {\r\n        tokenIndex: number      // ç¬¬å‡ ä¸ª tokenï¼ˆç”¨äºæ˜¾ç¤ºï¼Œæ›´ç›´è§‚ï¼‰\r\n        codeIndex: number       // æºç ä½ç½®ç´¢å¼•ï¼ˆç”¨äºç²¾ç¡®å®šä½ï¼‰\r\n        line: number\r\n        column: number\r\n    }\r\n    ruleStack: string[]\r\n    type?: 'parsing' | 'left-recursion' | 'infinite-loop' | 'or-branch-shadowing'  // é»˜è®¤ 'parsing'\r\n\r\n    // Loop é”™è¯¯ä¸“ç”¨å­—æ®µï¼ˆå¹³é“ºï¼‰\r\n    loopRuleName?: string                 // å¾ªç¯çš„è§„åˆ™å\r\n    loopDetectionSet?: string[]           // å¾ªç¯æ£€æµ‹ç‚¹åˆ—è¡¨\r\n    loopCstDepth?: number                 // CST æ ˆæ·±åº¦\r\n    loopCacheStats?: {                    // ç¼“å­˜ç»Ÿè®¡\r\n        hits: number\r\n        misses: number\r\n        hitRate: string\r\n        currentSize: number\r\n    }\r\n    loopTokenContext?: SubhutiMatchToken[] // Token ä¸Šä¸‹æ–‡\r\n\r\n    // æ–°å¢ï¼šç®€çŸ­çš„ä¿®å¤æç¤º\r\n    hint?: string\r\n\r\n    // æ–°å¢ï¼šè§„åˆ™è·¯å¾„ï¼ˆæ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²ï¼‰\r\n    rulePath?: string\r\n\r\n    // æ–°å¢ï¼šè‡ªå®šä¹‰å»ºè®®ï¼ˆå¯é€‰ï¼Œå¦‚æœæä¾›åˆ™ä½¿ç”¨ï¼Œå¦åˆ™è‡ªåŠ¨ç”Ÿæˆï¼‰\r\n    suggestions?: string[]\r\n}\r\n\r\n/**\r\n * è§£æé”™è¯¯ç±»\r\n *\r\n * è®¾è®¡ç†å¿µï¼š\r\n * - æ¸…æ™°çš„è§†è§‰å±‚æ¬¡\r\n * - å…³é”®ä¿¡æ¯çªå‡ºæ˜¾ç¤º\r\n * - æ™ºèƒ½ä¿®å¤å»ºè®®ï¼ˆåªä¿ç•™æœ€å¸¸è§çš„åœºæ™¯ï¼‰\r\n *\r\n * å‚è€ƒï¼šRust compiler error messages\r\n */\r\nexport class ParsingError extends Error {\r\n    readonly expected: string\r\n    readonly found?: SubhutiMatchToken\r\n    readonly position: {\r\n        readonly tokenIndex: number    // ç¬¬å‡ ä¸ª tokenï¼ˆç”¨äºæ˜¾ç¤ºï¼‰\r\n        readonly codeIndex: number     // æºç ä½ç½®ç´¢å¼•ï¼ˆç”¨äºç²¾ç¡®å®šä½ï¼‰\r\n        readonly line: number\r\n        readonly column: number\r\n    }\r\n    readonly ruleStack: readonly string[]\r\n    readonly type: 'parsing' | 'left-recursion' | 'infinite-loop' | 'or-branch-shadowing'\r\n    \r\n    // Loop é”™è¯¯ä¸“ç”¨å­—æ®µï¼ˆå¹³é“ºï¼‰\r\n    readonly loopRuleName?: string\r\n    readonly loopDetectionSet?: readonly string[]\r\n    readonly loopCstDepth?: number\r\n    readonly loopCacheStats?: Readonly<{\r\n        hits: number\r\n        misses: number\r\n        hitRate: string\r\n        currentSize: number\r\n    }>\r\n    readonly loopTokenContext?: readonly SubhutiMatchToken[]\r\n\r\n    // æ–°å¢ï¼šç®€çŸ­çš„ä¿®å¤æç¤º\r\n    readonly hint?: string\r\n\r\n    // æ–°å¢ï¼šè§„åˆ™è·¯å¾„ï¼ˆæ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²ï¼‰\r\n    readonly rulePath?: string\r\n\r\n    /**\r\n     * â­ æ™ºèƒ½ä¿®å¤å»ºè®®ï¼ˆä»… parsing é”™è¯¯ï¼‰\r\n     */\r\n    readonly suggestions: readonly string[]\r\n    \r\n    /**\r\n     * æ˜¯å¦å¯ç”¨è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼ˆä»… parsing é”™è¯¯ä½¿ç”¨ï¼‰\r\n     */\r\n    private readonly useDetailed: boolean\r\n    \r\n    constructor(\r\n        message: string,\r\n        details: ErrorDetails,\r\n        useDetailed: boolean = true\r\n    ) {\r\n        super(message)\r\n        this.name = 'ParsingError'\r\n        this.type = details.type || 'parsing'\r\n        this.expected = details.expected\r\n        this.found = details.found\r\n        this.position = details.position\r\n        this.ruleStack = Object.freeze([...details.ruleStack])\r\n        \r\n        // Loop é”™è¯¯å­—æ®µ\r\n        this.loopRuleName = details.loopRuleName\r\n        this.loopDetectionSet = details.loopDetectionSet ? Object.freeze([...details.loopDetectionSet]) : undefined\r\n        this.loopCstDepth = details.loopCstDepth\r\n        this.loopCacheStats = details.loopCacheStats\r\n        this.loopTokenContext = details.loopTokenContext ? Object.freeze([...details.loopTokenContext]) : undefined\r\n\r\n        // æ–°å¢ï¼šä¿®å¤æç¤º\r\n        this.hint = details.hint\r\n\r\n        // æ–°å¢ï¼šè§„åˆ™è·¯å¾„\r\n        this.rulePath = details.rulePath\r\n        \r\n        this.useDetailed = useDetailed\r\n\r\n        // æ™ºèƒ½å»ºè®®ï¼šä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„ suggestionsï¼Œå¦åˆ™è‡ªåŠ¨ç”Ÿæˆ\r\n        if (details.suggestions && details.suggestions.length > 0) {\r\n            this.suggestions = Object.freeze([...details.suggestions])\r\n        } else if (this.type === 'parsing' && useDetailed) {\r\n            this.suggestions = Object.freeze(this.generateSuggestions())\r\n        } else {\r\n            this.suggestions = Object.freeze([])\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * æ™ºèƒ½ä¿®å¤å»ºè®®ç”Ÿæˆå™¨ï¼ˆç®€åŒ–ç‰ˆï¼‰â­\r\n     * \r\n     * åªä¿ç•™æœ€å¸¸è§çš„ 8 ç§é”™è¯¯åœºæ™¯ï¼š\r\n     * 1. é—­åˆç¬¦å·ç¼ºå¤±ï¼ˆ{} () []ï¼‰\r\n     * 2. åˆ†å·é—®é¢˜\r\n     * 3. å…³é”®å­—æ‹¼å†™é”™è¯¯\r\n     * 4. æ ‡è¯†ç¬¦é”™è¯¯\r\n     * 5. EOF é—®é¢˜\r\n     */\r\n    private generateSuggestions(): string[] {\r\n        const suggestions: string[] = []\r\n        const { expected, found } = this\r\n        \r\n        // 1. é—­åˆç¬¦å·ç¼ºå¤±\r\n        if (expected === 'RBrace') {\r\n            suggestions.push('ğŸ’¡ å¯èƒ½ç¼ºå°‘é—­åˆèŠ±æ‹¬å· }')\r\n        } else if (expected === 'RParen') {\r\n            suggestions.push('ğŸ’¡ å¯èƒ½ç¼ºå°‘é—­åˆæ‹¬å· )')\r\n        } else if (expected === 'RBracket') {\r\n            suggestions.push('ğŸ’¡ å¯èƒ½ç¼ºå°‘é—­åˆæ–¹æ‹¬å· ]')\r\n        }\r\n        \r\n        // 2. åˆ†å·é—®é¢˜\r\n        else if (expected === 'Semicolon') {\r\n            suggestions.push('ğŸ’¡ å¯èƒ½ç¼ºå°‘åˆ†å· ;')\r\n        } else if (found?.tokenName === 'Semicolon' && expected !== 'Semicolon') {\r\n            suggestions.push('ğŸ’¡ æ„å¤–çš„åˆ†å·')\r\n        }\r\n        \r\n        // 3. å…³é”®å­—æ‹¼å†™é”™è¯¯\r\n        else if (expected.endsWith('Tok') && found?.tokenName === 'Identifier') {\r\n            const keyword = expected.replace('Tok', '').toLowerCase()\r\n            suggestions.push(`ğŸ’¡ æœŸæœ›å…³é”®å­— \"${keyword}\"ï¼Œæ£€æŸ¥æ˜¯å¦æ‹¼å†™é”™è¯¯`)\r\n        }\r\n        \r\n        // 4. æ ‡è¯†ç¬¦ç›¸å…³é”™è¯¯\r\n        else if (expected === 'Identifier') {\r\n            if (found?.tokenName === 'Number') {\r\n                suggestions.push('ğŸ’¡ å˜é‡åä¸èƒ½ä»¥æ•°å­—å¼€å¤´')\r\n            } else if (found?.tokenName?.endsWith('Tok')) {\r\n                const keyword = found.tokenName.replace('Tok', '').toLowerCase()\r\n                suggestions.push(`ğŸ’¡ \"${keyword}\" æ˜¯ä¿ç•™å…³é”®å­—ï¼Œä¸èƒ½ç”¨ä½œæ ‡è¯†ç¬¦`)\r\n            }\r\n        }\r\n        \r\n        // 5. EOFï¼ˆæ–‡ä»¶æ„å¤–ç»“æŸï¼‰\r\n        if (!found || found.tokenName === 'EOF') {\r\n            suggestions.push('ğŸ’¡ ä»£ç æ„å¤–ç»“æŸï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æœªé—­åˆçš„æ‹¬å·ã€èŠ±æ‹¬å·æˆ–å¼•å·')\r\n        }\r\n        \r\n        // é™åˆ¶å»ºè®®æ•°é‡ï¼ˆé¿å…ä¿¡æ¯è¿‡è½½ï¼‰\r\n        return suggestions.slice(0, 3)\r\n    }\r\n    \r\n    /**\r\n     * æ ¼å¼åŒ–é”™è¯¯ä¿¡æ¯ï¼ˆæ ¹æ®ç±»å‹å’Œæ¨¡å¼é€‰æ‹©ï¼‰â­\r\n     */\r\n    toString(): string {\r\n        // Or åˆ†æ”¯é®è”½é”™è¯¯ï¼šç‰¹æ®Šæ ¼å¼\r\n        if (this.type === 'or-branch-shadowing') {\r\n            return this.toOrBranchShadowingString()\r\n        }\r\n\r\n        // å¾ªç¯é”™è¯¯ï¼šåªæœ‰ä¸€ç§è¯¦ç»†æ ¼å¼\r\n        if (this.type === 'left-recursion' || this.type === 'infinite-loop') {\r\n            return this.toLoopDetailedString()\r\n        }\r\n        \r\n        // è§£æé”™è¯¯ï¼šæ ¹æ®æ¨¡å¼é€‰æ‹©\r\n        return this.useDetailed ? this.toDetailedString() : this.toSimpleString()\r\n    }\r\n    \r\n    /**\r\n     * è¯¦ç»†æ ¼å¼ï¼ˆRust é£æ ¼ + æ™ºèƒ½å»ºè®®ï¼‰\r\n     */\r\n    private toDetailedString(): string {\r\n        const lines: string[] = []\r\n\r\n        // æ ‡é¢˜\r\n        lines.push('âŒ Parsing Error')\r\n        lines.push('')\r\n\r\n        // ä½ç½®ä¿¡æ¯ - ä½¿ç”¨ç´§å‡‘æ ¼å¼\r\n        lines.push(`Token[${this.position.tokenIndex}]: ${this.found?.tokenName || 'EOF'} @ line ${this.position.line}:${this.position.column} (pos ${this.position.codeIndex})`)\r\n        lines.push('')\r\n\r\n        // æœŸæœ›å’Œå®é™…\r\n        lines.push(`Expected: ${this.expected}`)\r\n        lines.push(`Found:    ${this.found?.tokenName || 'EOF'}`)\r\n\r\n        // è§„åˆ™æ ˆï¼ˆç®€åŒ–æ˜¾ç¤ºï¼Œæœ€å¤š 5 ä¸ªï¼‰\r\n        if (this.ruleStack.length > 0) {\r\n            lines.push('')\r\n            lines.push('Rule stack:')\r\n\r\n            const maxDisplay = 5\r\n            const visible = this.ruleStack.slice(-maxDisplay)\r\n            const hidden = this.ruleStack.length - visible.length\r\n\r\n            if (hidden > 0) {\r\n                lines.push(`  ... (${hidden} more)`)\r\n            }\r\n\r\n            visible.forEach((rule, i) => {\r\n                const isLast = i === visible.length - 1\r\n                const prefix = isLast ? 'â””â”€>' : 'â”œâ”€>'\r\n                lines.push(`  ${prefix} ${rule}`)\r\n            })\r\n        }\r\n\r\n        // æ™ºèƒ½ä¿®å¤å»ºè®®\r\n        if (this.suggestions.length > 0) {\r\n            lines.push('')\r\n            lines.push('Suggestions:')\r\n            this.suggestions.forEach(suggestion => {\r\n                lines.push(`  ${suggestion}`)\r\n            })\r\n        }\r\n\r\n        return lines.join('\\n')\r\n    }\r\n\r\n    /**\r\n     * ç®€å•æ ¼å¼ï¼ˆåŸºæœ¬ä¿¡æ¯ï¼‰\r\n     */\r\n    private toSimpleString(): string {\r\n        return `Parsing Error at token[${this.position.tokenIndex}] line ${this.position.line}:${this.position.column}: Expected ${this.expected}, found ${this.found?.tokenName || 'EOF'}`\r\n    }\r\n    \r\n    /**\r\n     * ç®€æ´æ ¼å¼ï¼ˆç”¨äºæ—¥å¿—ï¼‰\r\n     */\r\n    toShortString(): string {\r\n        return this.toSimpleString()\r\n    }\r\n\r\n    /**\r\n     * æ ¼å¼åŒ–å·¦é€’å½’è·¯å¾„ï¼ˆæ›´æ¸…æ™°çš„æ˜¾ç¤ºï¼‰\r\n     */\r\n    private formatLeftRecursionPath(lines: string[]): void {\r\n        if (!this.loopRuleName || this.ruleStack.length === 0) {\r\n            return\r\n        }\r\n\r\n        // æ‰¾åˆ°ä»»ä½•é‡å¤è§„åˆ™çš„ç¬¬ä¸€æ¬¡å‡ºç°ä½ç½®\r\n        let firstRecursionIndex = -1\r\n        let recursiveRuleName = this.loopRuleName\r\n\r\n        const ruleCounts = new Map<string, number>()\r\n        for (let i = 0; i < this.ruleStack.length; i++) {\r\n            const rule = this.ruleStack[i]\r\n            const count = (ruleCounts.get(rule) || 0) + 1\r\n            ruleCounts.set(rule, count)\r\n\r\n            // æ‰¾åˆ°ç¬¬ä¸€ä¸ªé‡å¤çš„è§„åˆ™\r\n            if (count === 2 && firstRecursionIndex === -1) {\r\n                firstRecursionIndex = this.ruleStack.indexOf(rule)\r\n                recursiveRuleName = rule\r\n            }\r\n        }\r\n\r\n        if (firstRecursionIndex === -1) {\r\n            // é™çº§ï¼šä½¿ç”¨æ™®é€šæ ¼å¼\r\n            lines.push(`  å®Œæ•´è°ƒç”¨æ ˆ:`)\r\n            this.ruleStack.forEach((rule, i) => {\r\n                lines.push(`    ${i + 1}. ${rule}`)\r\n            })\r\n            return\r\n        }\r\n\r\n        // æ˜¾ç¤ºä»ç¬¬ä¸€æ¬¡å‡ºç°åˆ°å½“å‰çš„è·¯å¾„\r\n        const recursionPath = this.ruleStack.slice(firstRecursionIndex)\r\n\r\n        // åˆ¤æ–­æ˜¯ç›´æ¥è¿˜æ˜¯é—´æ¥å·¦é€’å½’\r\n        const isDirect = recursionPath.length === 1\r\n        const pathType = isDirect ? 'ç›´æ¥å·¦é€’å½’' : 'é—´æ¥å·¦é€’å½’'\r\n\r\n        lines.push(`  ç±»å‹: ${pathType}`)\r\n        lines.push(`  å¾ªç¯è§„åˆ™: ${recursiveRuleName}`)\r\n        lines.push(`  è·¯å¾„: ${recursionPath.join(' â†’ ')} â†’ ${recursiveRuleName} âš ï¸`)\r\n        lines.push('')\r\n        lines.push('  è¯¦ç»†è°ƒç”¨æ ˆ:')\r\n\r\n        recursionPath.forEach((rule, i) => {\r\n            const isFirst = i === 0\r\n            const isRecursive = rule === recursiveRuleName\r\n            const marker = isFirst ? ' â† é¦–æ¬¡è°ƒç”¨' : (isRecursive ? ' â† å¾ªç¯' : '')\r\n            lines.push(`    ${i + 1}. ${rule}${marker}`)\r\n        })\r\n\r\n        lines.push(`    ${recursionPath.length + 1}. ${recursiveRuleName} âš ï¸ å¾ªç¯ç‚¹`)\r\n    }\r\n    \r\n    /**\r\n     * å¾ªç¯é”™è¯¯è¯¦ç»†æ ¼å¼â­\r\n     * \r\n     * å±•ç¤ºä¿¡æ¯ï¼š\r\n     * - å¾ªç¯è§„åˆ™åå’Œä½ç½®\r\n     * - å½“å‰ token ä¿¡æ¯\r\n     * - å®Œæ•´è§„åˆ™è°ƒç”¨æ ˆ\r\n     * - å¾ªç¯æ£€æµ‹é›†åˆå†…å®¹\r\n     * - CST æ ˆæ·±åº¦\r\n     * - ç¼“å­˜ç»Ÿè®¡ï¼ˆå¯é€‰ï¼‰\r\n     * - Token ä¸Šä¸‹æ–‡ï¼ˆå¯é€‰ï¼‰\r\n     * - ä¿®å¤å»ºè®®\r\n     */\r\n    private toLoopDetailedString(): string {\r\n        const lines: string[] = []\r\n\r\n        // æ ‡é¢˜\r\n        lines.push(`âŒ æ£€æµ‹åˆ°${this.type === 'left-recursion' ? 'å·¦é€’å½’' : 'æ— é™å¾ªç¯'}`)\r\n        lines.push('')\r\n\r\n        // æ ¸å¿ƒä¿¡æ¯ - ä½¿ç”¨ç´§å‡‘æ ¼å¼\r\n        lines.push(`è§„åˆ™ \"${this.loopRuleName}\" åœ¨ token[${this.position.tokenIndex}] å¤„é‡å¤è°ƒç”¨è‡ªå·±`)\r\n        lines.push(`Token[${this.position.tokenIndex}]: ${this.found?.tokenName || 'EOF'}(\"${this.found?.tokenValue || ''}\") @ line ${this.position.line}:${this.position.column}`)\r\n        lines.push('')\r\n        \r\n        // ğŸ†• è§„åˆ™è·¯å¾„ï¼ˆå¦‚æœæœ‰ï¼‰\r\n        if (this.rulePath) {\r\n            lines.push('è§„åˆ™è·¯å¾„:')\r\n            lines.push(this.rulePath)\r\n            lines.push('')\r\n        } else if (this.ruleStack.length > 0) {\r\n            // æ˜¾ç¤ºå·¦é€’å½’è·¯å¾„\r\n            if (this.type === 'left-recursion') {\r\n                lines.push('å·¦é€’å½’è·¯å¾„:')\r\n                this.formatLeftRecursionPath(lines)\r\n                lines.push('')\r\n            } else {\r\n                // æ™®é€šè§„åˆ™è°ƒç”¨æ ˆ\r\n                lines.push('è§„åˆ™è°ƒç”¨æ ˆ:')\r\n                const maxDisplay = 8\r\n                const visible = this.ruleStack.slice(-maxDisplay)\r\n                const hidden = this.ruleStack.length - visible.length\r\n\r\n                if (hidden > 0) {\r\n                    lines.push(`  ... (éšè— ${hidden} å±‚)`)\r\n                }\r\n\r\n                visible.forEach((rule, i) => {\r\n                    const isLast = i === visible.length - 1\r\n                    const prefix = '  ' + '  '.repeat(i) + (isLast ? 'â””â”€>' : 'â”œâ”€>')\r\n                    lines.push(`${prefix} ${rule}`)\r\n                })\r\n                lines.push(`  ${'  '.repeat(visible.length)}â””â”€> ${this.loopRuleName} âš ï¸ å¾ªç¯ç‚¹`)\r\n                lines.push('')\r\n            }\r\n        }\r\n        \r\n        // è¯Šæ–­ä¿¡æ¯\r\n        lines.push('è¯Šæ–­ä¿¡æ¯:')\r\n        lines.push(`  â€¢ CST æ ˆæ·±åº¦: ${this.loopCstDepth}`)\r\n        \r\n        if (this.loopDetectionSet) {\r\n            lines.push(`  â€¢ å¾ªç¯æ£€æµ‹ç‚¹: ${this.loopDetectionSet.length} ä¸ª`)\r\n            \r\n            if (this.loopDetectionSet.length > 0 && this.loopDetectionSet.length <= 10) {\r\n                lines.push(`    ${this.loopDetectionSet.join(', ')}`)\r\n            } else if (this.loopDetectionSet.length > 10) {\r\n                lines.push(`    ${this.loopDetectionSet.slice(0, 10).join(', ')} ...`)\r\n            }\r\n        }\r\n        \r\n        // ç¼“å­˜ç»Ÿè®¡ï¼ˆå¯é€‰ï¼‰\r\n        if (this.loopCacheStats) {\r\n            lines.push(`  â€¢ ç¼“å­˜å‘½ä¸­ç‡: ${this.loopCacheStats.hitRate} (${this.loopCacheStats.hits} hits / ${this.loopCacheStats.misses} misses)`)\r\n            lines.push(`  â€¢ ç¼“å­˜å¤§å°: ${this.loopCacheStats.currentSize}`)\r\n        }\r\n        \r\n        // Token ä¸Šä¸‹æ–‡ï¼ˆå¯é€‰ï¼‰\r\n        if (this.loopTokenContext && this.loopTokenContext.length > 0) {\r\n            lines.push('')\r\n            lines.push('Token ä¸Šä¸‹æ–‡:')\r\n            this.loopTokenContext.forEach((token) => {\r\n                const isCurrent = token === this.found\r\n                const marker = isCurrent ? ' <-- å½“å‰ä½ç½®' : ''\r\n                lines.push(`  ${token.tokenName}(\"${token.tokenValue}\")${marker}`)\r\n            })\r\n        }\r\n        \r\n        // æ˜¾ç¤º hintï¼ˆå¦‚æœæœ‰ï¼‰\r\n        if (this.hint) {\r\n            lines.push('ğŸ’¡ æç¤º:')\r\n            lines.push(`  ${this.hint}`)\r\n            lines.push('')\r\n        }\r\n        \r\n        lines.push('')\r\n        // ä¿®å¤å»ºè®®\r\n        lines.push('âš ï¸ PEG è§£æå™¨æ— æ³•ç›´æ¥å¤„ç†å·¦é€’å½’ã€‚')\r\n        lines.push('è¯·é‡æ„è¯­æ³•ä»¥æ¶ˆé™¤å·¦é€’å½’ã€‚')\r\n        lines.push('')\r\n        lines.push('ç¤ºä¾‹:')\r\n        lines.push('  âŒ é”™è¯¯:  Expression â†’ Expression \\'+\\' Term | Term')\r\n        lines.push('  âœ… æ­£ç¡®:  Expression â†’ Term (\\'+\\' Term)*')\r\n        lines.push('')\r\n        lines.push('å¸¸è§æ¨¡å¼:')\r\n        lines.push('  â€¢ å·¦é€’å½’:       A â†’ A \\'x\\' | \\'y\\'          â†’  æ”¹ä¸º: A â†’ \\'y\\' (\\'x\\')*')\r\n        lines.push('  â€¢ é—´æ¥å·¦é€’å½’:   A â†’ B, B â†’ C, C â†’ A      â†’  éœ€è¦æ‰‹åŠ¨å±•å¼€æˆ–é‡æ„')\r\n        lines.push('  â€¢ å¾ªç¯ä¾èµ–:     A â†’ B, B â†’ A             â†’  æ£€æŸ¥æ˜¯å¦æœ‰ç©ºåŒ¹é…åˆ†æ”¯')\r\n\r\n        return lines.join('\\n')\r\n    }\r\n\r\n    /**\r\n     * Or åˆ†æ”¯é®è”½é”™è¯¯æ ¼å¼åŒ–ï¼ˆè¯¦ç»†ç‰ˆï¼‰\r\n     */\r\n    private toOrBranchShadowingString(): string {\r\n        const lines: string[] = []\r\n\r\n        lines.push('')\r\n        lines.push('='.repeat(80))\r\n        lines.push('âŒ æ£€æµ‹åˆ° Or åˆ†æ”¯é®è”½é—®é¢˜')\r\n        lines.push('='.repeat(80))\r\n        lines.push(`è§„åˆ™ \"${this.loopRuleName}\" åœ¨ token[${this.position.tokenIndex}] å¤„é‡å¤è°ƒç”¨è‡ªå·±`)\r\n        lines.push(`Token[${this.position.tokenIndex}]: ${this.found?.tokenName}(\"${this.found?.tokenValue}\") @ line ${this.position.line}:${this.position.column}`)\r\n        lines.push('')\r\n\r\n        // è§„åˆ™è°ƒç”¨æ ˆ\r\n        if (this.ruleStack.length > 0) {\r\n            lines.push('è§„åˆ™è°ƒç”¨æ ˆ:')\r\n            this.ruleStack.forEach((rule, index) => {\r\n                const marker = index === this.ruleStack.length - 1 ? ' <-- å½“å‰è§„åˆ™' : ''\r\n                lines.push(`  [${index}] ${rule}${marker}`)\r\n            })\r\n            lines.push('')\r\n        }\r\n\r\n        // Token ä¸Šä¸‹æ–‡\r\n        if (this.loopTokenContext && this.loopTokenContext.length > 0) {\r\n            lines.push('Token ä¸Šä¸‹æ–‡:')\r\n            this.loopTokenContext.forEach(token => {\r\n                const isCurrent = token === this.found\r\n                const marker = isCurrent ? ' <-- å½“å‰ä½ç½®' : ''\r\n                lines.push(`  ${token.tokenName}(\"${token.tokenValue}\")${marker}`)\r\n            })\r\n            lines.push('')\r\n        }\r\n\r\n        // æ˜¾ç¤º hintï¼ˆå¦‚æœæœ‰ï¼‰\r\n        if (this.hint) {\r\n            lines.push('ğŸ’¡ æç¤º:')\r\n            lines.push(`  ${this.hint}`)\r\n            lines.push('')\r\n        }\r\n\r\n        lines.push('')\r\n        // ä¿®å¤å»ºè®®\r\n        lines.push('âš ï¸ è¿™ä¸æ˜¯å·¦é€’å½’é—®é¢˜ï¼Œè€Œæ˜¯ Or åˆ†æ”¯é®è”½é—®é¢˜ï¼')\r\n        lines.push('')\r\n        lines.push('é—®é¢˜åŸå› :')\r\n        lines.push('  åœ¨ PEG ä¸­ï¼ŒOr æ˜¯é¡ºåºé€‰æ‹©ï¼ˆOrdered Choiceï¼‰ï¼š')\r\n        lines.push('  - ç¬¬ä¸€ä¸ªåŒ¹é…çš„åˆ†æ”¯ä¼šç«‹å³è¿”å›')\r\n        lines.push('  - å¦‚æœå‰é¢çš„åˆ†æ”¯\"éƒ¨åˆ†åŒ¹é…\"äº†è¾“å…¥ï¼Œåé¢çš„åˆ†æ”¯æ°¸è¿œæ— æ³•å°è¯•')\r\n        lines.push('  - è¿™å¯¼è‡´æŸäº›è¾“å…¥æ— æ³•æ­£ç¡®è§£æ')\r\n        lines.push('')\r\n        lines.push('ç¤ºä¾‹:')\r\n        lines.push('  âŒ é”™è¯¯é¡ºåº:')\r\n        lines.push('    LeftHandSideExpression â†’ NewExpression | CallExpression')\r\n        lines.push('    // NewExpression åŒ…å« MemberExpression')\r\n        lines.push('    // CallExpression ä¹ŸåŒ…å« MemberExpressionï¼Œä½†è¿˜æœ‰ Arguments')\r\n        lines.push('    // NewExpression ä¼šå…ˆåŒ¹é… \"console.log\"ï¼Œå¯¼è‡´ CallExpression æ— æ³•åŒ¹é… \"console.log(...)\"')\r\n        lines.push('')\r\n        lines.push('  âœ… æ­£ç¡®é¡ºåº:')\r\n        lines.push('    LeftHandSideExpression â†’ CallExpression | NewExpression')\r\n        lines.push('    // å…ˆå°è¯•æ›´é•¿çš„è§„åˆ™ï¼ˆCallExpressionï¼‰')\r\n        lines.push('    // å†å°è¯•æ›´çŸ­çš„è§„åˆ™ï¼ˆNewExpressionï¼‰')\r\n        lines.push('')\r\n        lines.push('ä¿®å¤æ–¹æ³•:')\r\n        lines.push('  1. è°ƒæ•´ Or åˆ†æ”¯é¡ºåºï¼šå°†æ›´å…·ä½“ã€æ›´é•¿çš„è§„åˆ™æ”¾åœ¨å‰é¢')\r\n        lines.push('  2. ç¡®ä¿å‰é¢çš„åˆ†æ”¯ä¸ä¼š\"é®è”½\"åé¢çš„åˆ†æ”¯')\r\n        lines.push('  3. å¦‚æœä¸¤ä¸ªåˆ†æ”¯æœ‰åŒ…å«å…³ç³»ï¼Œå°†\"æ›´å¤§\"çš„åˆ†æ”¯æ”¾åœ¨å‰é¢')\r\n\r\n        return lines.join('\\n')\r\n    }\r\n}\r\n\r\n/**\r\n * Subhuti é”™è¯¯å¤„ç†å™¨\r\n * \r\n * ç®¡ç†é”™è¯¯åˆ›å»ºå’Œæ ¼å¼åŒ–\r\n */\r\nexport class SubhutiErrorHandler {\r\n    private enableDetailedErrors: boolean = true\r\n    \r\n    /**\r\n     * è®¾ç½®æ˜¯å¦å¯ç”¨è¯¦ç»†é”™è¯¯\r\n     * \r\n     * @param enable - true: è¯¦ç»†é”™è¯¯ï¼ˆRusté£æ ¼+å»ºè®®ï¼‰ï¼Œfalse: ç®€å•é”™è¯¯\r\n     */\r\n    setDetailed(enable: boolean): void {\r\n        this.enableDetailedErrors = enable\r\n    }\r\n    \r\n    /**\r\n     * åˆ›å»ºè§£æé”™è¯¯\r\n     * \r\n     * @param details - é”™è¯¯è¯¦æƒ…\r\n     * @returns ParsingError å®ä¾‹\r\n     */\r\n    createError(details: ErrorDetails): ParsingError {\r\n        return new ParsingError(\r\n            `Expected ${details.expected}`,\r\n            details,\r\n            this.enableDetailedErrors\r\n        )\r\n    }\r\n}\r\n","/**\r\n * SubhutiDebugRuleTracePrint - è§„åˆ™è·¯å¾„è¾“å‡ºå·¥å…·ç±»\r\n *\r\n * èŒè´£ï¼š\r\n * - è´Ÿè´£è§„åˆ™æ‰§è¡Œè·¯å¾„çš„æ ¼å¼åŒ–è¾“å‡º\r\n * - å¤„ç†è§„åˆ™é“¾çš„æŠ˜å æ˜¾ç¤º\r\n * - è®¡ç®—ç¼©è¿›å’Œæ˜¾ç¤ºæ·±åº¦\r\n * - ç”Ÿæˆ Or åˆ†æ”¯æ ‡è®°\r\n *\r\n * è®¾è®¡ï¼š\r\n * - çº¯é™æ€æ–¹æ³•ï¼Œæ— å®ä¾‹çŠ¶æ€\r\n * - ç›´æ¥åŸºäº RuleStackItem[] è¿›è¡Œè¾“å‡º\r\n * - å¯ä»¥ä¿®æ”¹ä¼ å…¥çš„çŠ¶æ€å¯¹è±¡ï¼ˆå‰¯ä½œç”¨ï¼‰\r\n * - ç›´æ¥è¾“å‡ºåˆ°æ§åˆ¶å°\r\n *\r\n * é…ç½®ï¼š\r\n * - showRulePath: æ§åˆ¶æ˜¯å¦è¾“å‡ºè§„åˆ™æ‰§è¡Œè·¯å¾„ï¼ˆé»˜è®¤ trueï¼‰\r\n */\r\n\r\n// å…¨å±€é…ç½®ï¼šæ˜¯å¦æ˜¾ç¤ºè§„åˆ™æ‰§è¡Œè·¯å¾„\r\nlet _showRulePath = true\r\n\r\n/**\r\n * è®¾ç½®æ˜¯å¦æ˜¾ç¤ºè§„åˆ™æ‰§è¡Œè·¯å¾„\r\n * @param show - true æ˜¾ç¤ºï¼Œfalse ä¸æ˜¾ç¤º\r\n */\r\nexport function setShowRulePath(show: boolean): void {\r\n    _showRulePath = show\r\n}\r\n\r\n/**\r\n * è·å–å½“å‰æ˜¯å¦æ˜¾ç¤ºè§„åˆ™æ‰§è¡Œè·¯å¾„\r\n */\r\nexport function getShowRulePath(): boolean {\r\n    return _showRulePath\r\n}\r\n\r\n// ============================================\r\n// TreeFormatHelper - æ ‘å½¢è¾“å‡ºæ ¼å¼åŒ–è¾…åŠ©\r\n// ============================================\r\n\r\nimport {LogUtil} from \"./logutil.ts\";\r\n\r\n/**\r\n * æ ‘å½¢è¾“å‡ºæ ¼å¼åŒ–è¾…åŠ©ç±»\r\n *\r\n * æä¾›ç»Ÿä¸€çš„æ ¼å¼åŒ–å·¥å…·æ–¹æ³•ä¾›è°ƒè¯•å·¥å…·ä½¿ç”¨\r\n *\r\n * æ ¸å¿ƒåŠŸèƒ½ï¼š\r\n * 1. formatLine - ç»Ÿä¸€çš„è¡Œè¾“å‡ºæ ¼å¼åŒ–ï¼ˆè‡ªåŠ¨å¤„ç†ç¼©è¿›ã€æ‹¼æ¥ã€è¿‡æ»¤ç©ºå€¼ï¼‰\r\n * 2. formatTokenValue - Token å€¼è½¬ä¹‰å’Œæˆªæ–­\r\n * 3. formatLocation - ä½ç½®ä¿¡æ¯æ ¼å¼åŒ–\r\n * 4. formatRuleChain - è§„åˆ™é“¾æ‹¼æ¥\r\n */\r\nexport class TreeFormatHelper {\r\n    /**\r\n     * æ ¼å¼åŒ–ä¸€è¡Œè¾“å‡º\r\n     *\r\n     * @param parts - å†…å®¹æ•°ç»„ï¼ˆnull/undefined/'' ä¼šè¢«è‡ªåŠ¨è¿‡æ»¤ï¼‰\r\n     * @param options - é…ç½®é€‰é¡¹\r\n     */\r\n    static formatLine(\r\n        content: string,\r\n        options: {\r\n            depth?: number\r\n            prefix?: string\r\n        }\r\n    ): string {\r\n        const indent = options.prefix ?? '  '.repeat(options.depth ?? 0)\r\n        return indent + content\r\n    }\r\n\r\n    static contentJoin(parts: string[]) {\r\n        const content = parts\r\n            .filter(p => p !== null && p !== undefined && p !== '')\r\n        return content\r\n    }\r\n\r\n    /**\r\n     * æ ¼å¼åŒ– Token å€¼ï¼ˆå¤„ç†ç‰¹æ®Šå­—ç¬¦å’Œé•¿åº¦é™åˆ¶ï¼‰\r\n     *\r\n     * @param value - åŸå§‹å€¼\r\n     * @param maxLength - æœ€å¤§é•¿åº¦ï¼ˆè¶…è¿‡åˆ™æˆªæ–­ï¼‰\r\n     */\r\n    static formatTokenValue(value: string, maxLength: number = 40): string {\r\n        // è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦\r\n        let escaped = value\r\n            .replace(/\\\\/g, '\\\\\\\\')\r\n            .replace(/\\n/g, '\\\\n')\r\n            .replace(/\\r/g, '\\\\r')\r\n            .replace(/\\t/g, '\\\\t')\r\n\r\n        // é™åˆ¶é•¿åº¦\r\n        if (escaped.length > maxLength) {\r\n            escaped = escaped.slice(0, maxLength) + '...'\r\n        }\r\n\r\n        return escaped\r\n    }\r\n\r\n    /**\r\n     * æ ¼å¼åŒ–ä½ç½®ä¿¡æ¯\r\n     *\r\n     * @param loc - ä½ç½®å¯¹è±¡ {start: {line, column}, end: {line, column}}\r\n     */\r\n    static formatLocation(loc: any): string {\r\n        if (!loc?.start || !loc?.end) {\r\n            return ''\r\n        }\r\n\r\n        const startLine = loc.start.line\r\n        const startCol = loc.start.column\r\n        const endLine = loc.end.line\r\n        const endCol = loc.end.column\r\n\r\n        if (startLine === endLine) {\r\n            return `[${startLine}:${startCol}-${endCol}]`\r\n        } else {\r\n            return `[${startLine}:${startCol}-${endLine}:${endCol}]`\r\n        }\r\n    }\r\n\r\n    /**\r\n     * æ ¼å¼åŒ–è§„åˆ™é“¾ï¼ˆç”¨äºæŠ˜å æ˜¾ç¤ºï¼‰\r\n     *\r\n     * @param rules - è§„åˆ™åæ•°ç»„\r\n     * @param separator - åˆ†éš”ç¬¦ï¼ˆé»˜è®¤ \" > \"ï¼‰\r\n     */\r\n    static formatRuleChain(rules: string[], separator: string = ' > '): string {\r\n        return rules.join(separator)\r\n    }\r\n}\r\n\r\n// ============================================\r\n// ç±»å‹å®šä¹‰\r\n// ============================================\r\n\r\n/**\r\n * è§„åˆ™æ ˆé¡¹\r\n */\r\nexport interface RuleStackItem {\r\n    ruleName?: string\r\n    tokenValue?: string\r\n    tokenSuccess?: boolean\r\n    tokenExpectName?: string\r\n    tokenName?: string\r\n    startTime: number\r\n    outputted: boolean          // æ˜¯å¦å·²è¾“å‡º\r\n    tokenIndex: number          // è§„åˆ™è¿›å…¥æ—¶çš„ token ç´¢å¼•ï¼ˆç”¨äºç¼“å­˜é”®ï¼‰\r\n\r\n    //ç”¨æ¥åˆ¤æ–­æ˜¯å¦ä¸ºæ¥è‡ªç¼“å­˜çš„æ•°æ®\r\n    isManuallyAdded?: boolean   // æ˜¯å¦åº”è¯¥åœ¨è¿™é‡Œæ¢è¡Œï¼ˆå•ç‹¬ä¸€è¡Œï¼‰\r\n    shouldBreakLine?: boolean   // æ˜¯å¦åº”è¯¥åœ¨è¿™é‡Œæ¢è¡Œï¼ˆå•ç‹¬ä¸€è¡Œï¼‰\r\n    displayDepth?: number       // æ˜¾ç¤ºæ·±åº¦ï¼ˆflush æ—¶è®¡ç®—ï¼‰\r\n    childs?: string[]           // å­èŠ‚ç‚¹çš„ keyï¼ˆå¯ä»¥æ˜¯è§„åˆ™ key æˆ– Token keyï¼‰\r\n\r\n    // ã€é˜²å¾¡æ€§ç¼–ç¨‹ã€‘ä¸¤ç§æ–¹å¼è®¡ç®—çš„ç›¸å¯¹æ·±åº¦ï¼Œç”¨äºäº¤å‰éªŒè¯\r\n    // relativeDepthByStack?: number    // åŸºäºæ ˆè®¡ç®—çš„ç›¸å¯¹æ·±åº¦ï¼ˆéç¼“å­˜æ—¶è®°å½•ï¼‰\r\n    // relativeDepthByChilds?: number   // åŸºäº childs è®¡ç®—çš„ç›¸å¯¹æ·±åº¦ï¼ˆç¼“å­˜æ¢å¤æ—¶è®¡ç®—ï¼‰\r\n\r\n    orBranchInfo?: {\r\n        orIndex?: number           // åŒä¸€è§„åˆ™å†… Or çš„åºå·ï¼ˆ0, 1, 2...ï¼Œç”¨äºåŒºåˆ†å¤šä¸ª Orï¼‰\r\n        branchIndex?: number       // Or åˆ†æ”¯ç´¢å¼•ï¼ˆ1, 2, 3...ï¼‰\r\n        isOrEntry: boolean         // æ˜¯å¦æ˜¯ Or åŒ…è£¹èŠ‚ç‚¹ï¼ˆonOrEnter åˆ›å»ºï¼‰\r\n        isOrBranch: boolean        // æ˜¯å¦æ˜¯ Or åˆ†æ”¯èŠ‚ç‚¹ï¼ˆonOrBranch åˆ›å»ºï¼‰\r\n        totalBranches?: number     // Or åˆ†æ”¯ä¿¡æ¯ï¼ˆå¦‚ \"#1/3\" æˆ– \"3\" è¡¨ç¤ºæ€»åˆ†æ”¯æ•°ï¼‰\r\n    }\r\n}\r\n\r\n/**\r\n * Or åˆ†æ”¯ä¿¡æ¯\r\n */\r\nexport interface OrBranchInfo {\r\n    totalBranches: number\r\n    currentBranch: number\r\n    targetDepth: number\r\n    savedPendingLength: number\r\n    parentRuleName: string  // çˆ¶è§„åˆ™åï¼ˆè°ƒç”¨ Or çš„è§„åˆ™ï¼‰\r\n}\r\n\r\n// ============================================\r\n// SubhutiDebugRuleTracePrint - è§„åˆ™è·¯å¾„è¾“å‡ºå·¥å…·ç±»\r\n// ============================================\r\n\r\nexport class SubhutiDebugRuleTracePrint {\r\n    /**\r\n     * ç»Ÿä¸€çš„ Or æ ‡è®°æ ¼å¼åŒ–æ–¹æ³•\r\n     * æ‰€æœ‰å­—ç¬¦ä¸²æ‹¼æ¥éƒ½åœ¨è¿™é‡Œå¤„ç†\r\n     *\r\n     * @param item - è§„åˆ™æ ˆé¡¹\r\n     * @returns æ˜¾ç¤ºåç¼€ï¼ˆå¦‚ \"\" / \" [Or]\" / \" [Or #1/3]\"ï¼‰\r\n     */\r\n    static formatOrSuffix(item: RuleStackItem): string {\r\n        // ä¼˜å…ˆä½¿ç”¨ orBranchInfo å¯¹è±¡ï¼ˆæ–°è®¾è®¡ï¼‰\r\n        if (item.orBranchInfo) {\r\n            const info = item.orBranchInfo\r\n\r\n            if (info.isOrEntry) {\r\n                // Or åŒ…è£¹èŠ‚ç‚¹ï¼šæ˜¾ç¤º [Or]\r\n                return ' [Or]'\r\n            } else if (info.isOrBranch) {\r\n                return ` [Or #${info.branchIndex + 1}/${info.totalBranches}]`\r\n            } else {\r\n                return `é”™è¯¯`\r\n            }\r\n        }\r\n        // æ™®é€šè§„åˆ™ï¼Œæ— åç¼€\r\n        return ''\r\n    }\r\n\r\n    /**\r\n     * åˆ¤æ–­æ˜¯å¦æ˜¯ Or ç›¸å…³èŠ‚ç‚¹\r\n     */\r\n    static isOrEntry(item: RuleStackItem): boolean {\r\n        // æ–°è®¾è®¡ï¼šæ£€æŸ¥ orBranchInfo å¯¹è±¡\r\n        return item.orBranchInfo?.isOrEntry\r\n    }\r\n\r\n\r\n    public static getPrintToken(tokenItem: RuleStackItem, location?: string): string {\r\n\r\n        // æ ¼å¼åŒ– token å€¼ï¼ˆè½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ã€æˆªæ–­é•¿å­—ç¬¦ä¸²ï¼‰\r\n        const value = TreeFormatHelper.formatTokenValue(tokenItem.tokenValue || '', 20)\r\n\r\n        if (tokenItem.tokenSuccess) {\r\n            return ['âœ…', 'Consume', `token[${tokenItem.tokenIndex}]`, value, '-', `<${tokenItem.tokenName}>`, (location || '[]')].join(' ')\r\n        } else {\r\n            return ['âŒ', `token[${tokenItem.tokenIndex}]`, 'Expect:', tokenItem.tokenExpectName, '-', 'Get:', value, '-', `<${tokenItem.tokenName}>`].join(' ')\r\n        }\r\n\r\n    }\r\n\r\n    /**\r\n     * æ ¼å¼åŒ–ä¸€è¡Œï¼ˆè¿”å›å­—ç¬¦ä¸²ï¼‰\r\n     */\r\n    public static formatLine(str: string, depth: number, symbol: string = 'â””â”€'): string {\r\n        return TreeFormatHelper.formatLine(\r\n            str,\r\n            // å‰ç¼€ï¼šæ ¹æ®æ·±åº¦ç”Ÿæˆç¼©è¿›ï¼Œâ””â”€ è¡¨ç¤ºæ˜¯å¶å­èŠ‚ç‚¹\r\n            {prefix: 'â”‚  '.repeat(depth) + symbol}\r\n        )\r\n    }\r\n\r\n\r\n\r\n    public static consoleLog(...strs) {\r\n        if (!_showRulePath) return  // å¦‚æœå…³é—­äº†è§„åˆ™è·¯å¾„è¾“å‡ºï¼Œç›´æ¥è¿”å›\r\n        console.log(...strs)  // æ¢å¤å®æ—¶è¾“å‡º\r\n        // LogUtil.log(strs[0])  // å¯é€‰ï¼šåŒæ—¶å†™å…¥æ–‡ä»¶\r\n    }\r\n\r\n\r\n    /**\r\n     * éç¼“å­˜åœºæ™¯ï¼šæ ¼å¼åŒ–å¾…å¤„ç†çš„è§„åˆ™æ—¥å¿—ï¼ˆè¿”å›å­—ç¬¦ä¸²æ•°ç»„ï¼‰\r\n     * ç‰¹ç‚¹ï¼šåªæœ‰ä¸€æ¬¡æ–­é“¾ï¼Œåªæœ‰ä¸€ä¸ªæŠ˜å æ®µ\r\n     *\r\n     * ã€è®¾è®¡æ€è·¯ã€‘\r\n     * 1. ä¸éœ€è¦æå‰æ ‡è®° shouldBreakLine\r\n     * 2. éå†æ—¶ç›´æ¥åˆ¤æ–­æ˜¯å¦åˆ°è¾¾æ–­ç‚¹\r\n     * 3. åˆ°è¾¾æ–­ç‚¹å‰ï¼šç§¯ç´¯åˆ°æŠ˜å é“¾\r\n     * 4. åˆ°è¾¾æ–­ç‚¹åï¼šé€ä¸ªè¾“å‡ºå¹¶èµ‹å€¼ shouldBreakLine = true\r\n     */\r\n    public static formatPendingOutputs_NonCache_Impl(ruleStack: RuleStackItem[]): string[] {\r\n        if (!ruleStack.length) {\r\n            throw new Error('ç³»ç»Ÿé”™è¯¯ï¼šruleStack ä¸ºç©º')\r\n        }\r\n\r\n        const allLines: string[] = []\r\n\r\n        let unOutputIndex = ruleStack.findIndex(item => !item.outputted)\r\n\r\n        if (unOutputIndex < 0) {\r\n            //å…è®¸æ²¡æœ‰å¾…è¾“å‡ºçš„ï¼Œè¿ç»­è¾“å‡ºtokençš„æƒ…å†µï¼Œä¸Šä¸€ä¸ªå·²è¾“å‡ºçš„å°±æ˜¯æœ€åä¸€ä¸ª\r\n            unOutputIndex = ruleStack.length\r\n        }\r\n        let pendingRules = ruleStack.slice(unOutputIndex)\r\n\r\n        // æœ€åä¸€ä¸ªå·²è¾“å‡ºçš„è§„åˆ™\r\n        const lastOutputted = ruleStack[unOutputIndex - 1]\r\n\r\n        // è®¡ç®—åŸºå‡†æ·±åº¦\r\n        // å¦‚æœæ²¡æœ‰å·²è¾“å‡ºçš„è§„åˆ™ï¼ˆç¬¬ä¸€æ¬¡è¾“å‡ºï¼‰ï¼ŒbaseDepth = 0\r\n        let baseDepth = 0\r\n        if (lastOutputted) {\r\n            // å¦åˆ™ baseDepth = æœ€åä¸€ä¸ªå·²è¾“å‡ºè§„åˆ™çš„æ·±åº¦ + 1\r\n            baseDepth = lastOutputted.displayDepth\r\n        }\r\n\r\n        //æœ€åä¸€ä¸ªæœªè¾“å‡ºçš„ OrEntryï¼ˆä½¿ç”¨ findLastIndex ç›´æ¥è·å–æ­£å‘ç´¢å¼•ï¼‰\r\n        let lastOrIndex = [...pendingRules].reverse().findIndex(item => !!item.orBranchInfo?.isOrEntry)\r\n\r\n        const minChainRulesLength = 2\r\n\r\n        // è®¡ç®—æ–­é“¾ä½ç½®ï¼šæœ€åä¸€ä¸ª Or çš„ä½ç½® + 1ï¼ˆå¦‚æœæ²¡æœ‰ Orï¼Œåˆ™è‡³å°‘ä¿ç•™ minChainRulesLength ä¸ªè§„åˆ™å•ç‹¬è¾“å‡ºï¼‰\r\n        // lastOrIndex = -1 è¡¨ç¤ºæ²¡æœ‰æ‰¾åˆ° Or èŠ‚ç‚¹\r\n        // æ³¨æ„ï¼šå¦‚æœæ‰¾åˆ°äº† Or èŠ‚ç‚¹ï¼ˆlastOrIndex >= 0ï¼‰ï¼Œåˆ™è‡³å°‘è¦ä¿ç•™ lastOrIndex + 1 ä¸ªè§„åˆ™å•ç‹¬è¾“å‡º\r\n        const breakPoint = Math.max(lastOrIndex + 1, minChainRulesLength)\r\n\r\n        //è·å–æŠ˜å é“¾å’Œå•ç‹¬è¾“å‡ºçš„è§„åˆ™ï¼Œå¦‚æœæŠ˜å é“¾åªæœ‰ä¸€ä¸ªä¸æŠ˜å \r\n        if (breakPoint < pendingRules.length - 1) {\r\n            const singleRules = pendingRules.splice(-breakPoint);\r\n\r\n            const groups: RuleStackItem[][] = []\r\n            let currentGroup: RuleStackItem[] = [pendingRules[0]]\r\n            groups.push(currentGroup)\r\n\r\n            for (let i = 1; i < pendingRules.length; i++) {\r\n                const item = pendingRules[i]\r\n                const prevItem = pendingRules[i - 1]\r\n\r\n                // å¦‚æœå½“å‰è§„åˆ™å’Œå‰ä¸€ä¸ªè§„åˆ™çš„ shouldBreakLine ç›¸åŒ\r\n                if (item.shouldBreakLine === prevItem.shouldBreakLine) {\r\n                    currentGroup.push(item)\r\n                } else {\r\n                    // å¦åˆ™å¼€å§‹æ–°çš„ä¸€ç»„\r\n                    currentGroup = [item]\r\n                    groups.push(currentGroup)\r\n                }\r\n            }\r\n            for (const group of groups) {\r\n                if (group[0].shouldBreakLine) {\r\n                    const result = this.formatMultipleSingleRule(group, baseDepth)\r\n                    allLines.push(...result.lines)\r\n                    baseDepth = result.depth\r\n                } else {\r\n                    baseDepth++\r\n                    const lines = this.formatChainRule(group, baseDepth)\r\n                    allLines.push(...lines)\r\n                }\r\n            }\r\n\r\n            const result = this.formatMultipleSingleRule(singleRules, baseDepth)\r\n            allLines.push(...result.lines)\r\n        } else {\r\n            const result = this.formatMultipleSingleRule(pendingRules, baseDepth)\r\n            allLines.push(...result.lines)\r\n        }\r\n\r\n        return allLines\r\n    }\r\n\r\n    /**\r\n     * éç¼“å­˜åœºæ™¯ï¼šè¾“å‡ºå¾…å¤„ç†çš„è§„åˆ™æ—¥å¿—ï¼ˆç›´æ¥è¾“å‡ºåˆ°æ§åˆ¶å°ï¼‰\r\n     */\r\n    public static flushPendingOutputs_NonCache_Impl(ruleStack: RuleStackItem[]): number {\r\n        const lines = this.formatPendingOutputs_NonCache_Impl(ruleStack)\r\n        lines.forEach(line => this.consoleLog(line))\r\n\r\n        // è¿”å›æœ€åçš„æ·±åº¦ï¼ˆç”¨äºå…¼å®¹ç°æœ‰ä»£ç ï¼‰\r\n        const lastRule = ruleStack[ruleStack.length - 1]\r\n        return lastRule?.displayDepth || 0\r\n    }\r\n\r\n    public static flushPendingOutputs_Cache_Impl(ruleStack: RuleStackItem[]): void {\r\n        let pendingRules = ruleStack.filter(item => !item.outputted)\r\n\r\n        if (pendingRules.length === 0) {\r\n            throw new Error('ä¸è¯¥è§¦å‘æ²¡æœ‰è§„åˆ™åœºæ™¯')\r\n        }\r\n\r\n        // ã€æ–°å¢ã€‘é¢„å¤„ç†ï¼šè°ƒæ•´ shouldBreakLine\r\n        // this.adjustShouldBreakLine(pendingRules)\r\n\r\n        // æŒ‰ç…§ shouldBreakLine åˆ†ç»„\r\n        const groups: RuleStackItem[][] = []\r\n        let currentGroup: RuleStackItem[] = [pendingRules[0]]\r\n        groups.push(currentGroup)\r\n\r\n        for (let i = 1; i < pendingRules.length; i++) {\r\n            const item = pendingRules[i]\r\n            const prevItem = pendingRules[i - 1]\r\n\r\n            // å¦‚æœå½“å‰è§„åˆ™å’Œå‰ä¸€ä¸ªè§„åˆ™çš„ shouldBreakLine ç›¸åŒ\r\n            if (item.shouldBreakLine === prevItem.shouldBreakLine) {\r\n                currentGroup.push(item)\r\n            } else {\r\n                // å¦åˆ™å¼€å§‹æ–°çš„ä¸€ç»„\r\n                currentGroup = [item]\r\n                groups.push(currentGroup)\r\n            }\r\n        }\r\n\r\n        // è¾“å‡ºæ¯ä¸€ç»„\r\n        for (const group of groups) {\r\n            if (group[0].shouldBreakLine) {\r\n                // å•ä¸ªè§„åˆ™ï¼šå•ç‹¬è¾“å‡º\r\n                this.printMultipleSingleRule(group)\r\n            } else {\r\n                // å¤šä¸ªè§„åˆ™ï¼šæŠ˜å è¾“å‡º\r\n                this.printChainRule(group)\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * æ ¼å¼åŒ–æŠ˜å é“¾ï¼ˆè¿”å›å­—ç¬¦ä¸²æ•°ç»„ï¼‰\r\n     * @param rules\r\n     * @param depth å…¼å®¹éç¼“å­˜å’Œç¼“å­˜ï¼Œ\r\n     */\r\n    static formatChainRule(rules: RuleStackItem[], depth: number = rules[0].displayDepth): string[] {\r\n        if (!rules.length) {\r\n            throw new Error(\"ç³»ç»Ÿé”™è¯¯\")\r\n        }\r\n        const names = rules.map(r => SubhutiDebugRuleTracePrint.getRuleItemLogContent(r))\r\n\r\n        const displayNames = names.length > 4\r\n            ? [...names.slice(0, 2), '...', ...names.slice(-2)]\r\n            : names\r\n\r\n        const line = SubhutiDebugRuleTracePrint.formatLine(displayNames.join(' > '), depth, 'â”œâ”€')\r\n\r\n        rules.forEach(r => {\r\n            r.displayDepth = depth\r\n            r.outputted = true\r\n        })\r\n\r\n        return [line]\r\n    }\r\n\r\n    /**\r\n     * æ‰“å°æŠ˜å é“¾ï¼ˆç›´æ¥è¾“å‡ºåˆ°æ§åˆ¶å°ï¼‰\r\n     * @param rules\r\n     * @param depth å…¼å®¹éç¼“å­˜å’Œç¼“å­˜ï¼Œ\r\n     */\r\n    static printChainRule(rules: RuleStackItem[], depth: number = rules[0].displayDepth) {\r\n        const lines = this.formatChainRule(rules, depth)\r\n        lines.forEach(line => this.consoleLog(line))\r\n    }\r\n\r\n    /**\r\n     * æ ¼å¼åŒ–å•ç‹¬è§„åˆ™ï¼ˆè¿”å›å­—ç¬¦ä¸²æ•°ç»„ï¼‰\r\n     * æ³¨æ„ï¼šä¼ å…¥çš„ rules æ•°ç»„é€šå¸¸åªæœ‰ 1 ä¸ªå…ƒç´ ï¼ˆå•ç‹¬æ˜¾ç¤ºçš„è§„åˆ™ï¼‰\r\n     *\r\n     * @param rules\r\n     * @param depth å…¼å®¹éç¼“å­˜å’Œç¼“å­˜ï¼Œ\r\n     */\r\n    static formatMultipleSingleRule(rules: RuleStackItem[], depth: number = rules[0].displayDepth): { lines: string[], depth: number } {\r\n        const lines: string[] = []\r\n\r\n        rules.forEach((item, index) => {\r\n            depth++\r\n\r\n            // åˆ¤æ–­æ˜¯å¦æ˜¯æœ€åä¸€ä¸ª\r\n            const isLast = index === rules.length - 1\r\n\r\n            if (!item.isManuallyAdded) {\r\n                item.displayDepth = depth\r\n            }\r\n\r\n            let branch = isLast ? 'â””â”€' : 'â”œâ”€'\r\n            let printStr = this.getRuleItemLogContent(item)\r\n\r\n            const line = SubhutiDebugRuleTracePrint.formatLine(printStr, item.displayDepth, branch)\r\n            lines.push(line)\r\n\r\n            item.outputted = true\r\n        })\r\n\r\n        return { lines, depth }\r\n    }\r\n\r\n    /**\r\n     * æ‰“å°å•ç‹¬è§„åˆ™ï¼ˆç›´æ¥è¾“å‡ºåˆ°æ§åˆ¶å°ï¼‰\r\n     * æ³¨æ„ï¼šä¼ å…¥çš„ rules æ•°ç»„é€šå¸¸åªæœ‰ 1 ä¸ªå…ƒç´ ï¼ˆå•ç‹¬æ˜¾ç¤ºçš„è§„åˆ™ï¼‰\r\n     *\r\n     * @param rules\r\n     * @param depth å…¼å®¹éç¼“å­˜å’Œç¼“å­˜ï¼Œ\r\n     */\r\n    static printMultipleSingleRule(rules: RuleStackItem[], depth: number = rules[0].displayDepth): number {\r\n        const result = this.formatMultipleSingleRule(rules, depth)\r\n        result.lines.forEach(line => this.consoleLog(line))\r\n        return result.depth\r\n    }\r\n\r\n    private static getRuleItemLogContent(tokenItem: RuleStackItem) {\r\n        let res = 'é”™è¯¯'\r\n        if (tokenItem.orBranchInfo) {\r\n            const branchInfo = tokenItem.orBranchInfo\r\n            if (tokenItem.orBranchInfo.isOrEntry) {\r\n                // branch = 'ğŸ”€ '\r\n                // Or åŒ…è£¹èŠ‚ç‚¹ï¼šæ˜¾ç¤º [Or]\r\n                res = 'ğŸ”€ ' + tokenItem.ruleName + '(Or)'\r\n            } else if (tokenItem.orBranchInfo.isOrBranch) {\r\n                res = `[Branch #${branchInfo.branchIndex + 1}](${tokenItem.ruleName})`\r\n                // ğŸ” è°ƒè¯•ï¼šè®°å½• Or åˆ†æ”¯è¢«æ ‡è®°ä¸º outputted\r\n            }\r\n        } else {\r\n            if (tokenItem.tokenExpectName) {\r\n                res = SubhutiDebugRuleTracePrint.getPrintToken(tokenItem)\r\n            } else {\r\n                res = tokenItem.ruleName\r\n            }\r\n        }\r\n        if (tokenItem.isManuallyAdded) {\r\n            // æ™®é€šè§„åˆ™ï¼šæ·»åŠ ç¼“å­˜æ ‡è®°\r\n            res += ` âš¡[Cached]`\r\n        }\r\n        return res\r\n    }\r\n}\r\n\r\n","/**\r\n * Subhuti Debug - ç»Ÿä¸€è°ƒè¯•å’Œæ€§èƒ½åˆ†æç³»ç»Ÿï¼ˆv4.0ï¼‰\r\n *\r\n * è®¾è®¡ç†å¿µï¼š\r\n * - YAGNIï¼šåªå®ç°å®é™…éœ€è¦çš„åŠŸèƒ½\r\n * - ç®€å•ä¼˜äºå¤æ‚ï¼šç»Ÿä¸€å…¥å£ï¼Œæ¸…æ™°çš„è¾“å‡º\r\n * - èŒè´£åˆ†ç¦»ï¼šè¿½è¸ªå™¨ï¼ˆæœ‰çŠ¶æ€ï¼‰+ å·¥å…·é›†ï¼ˆæ— çŠ¶æ€ï¼‰\r\n *\r\n * æ¶æ„ï¼š\r\n * - SubhutiDebugUtils - æ— çŠ¶æ€å·¥å…·é›†ï¼ˆCSTåˆ†æã€TokenéªŒè¯ã€é«˜çº§è°ƒè¯•ï¼‰\r\n *\r\n * åŠŸèƒ½ï¼š\r\n * - âœ… è§„åˆ™æ‰§è¡Œè¿½è¸ªï¼ˆè¿›å…¥/é€€å‡ºï¼‰\r\n * - âœ… Token æ¶ˆè´¹æ˜¾ç¤ºï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰\r\n * - âœ… ç¼“å­˜å‘½ä¸­æ ‡è¯†ï¼ˆâš¡CACHEDï¼‰\r\n * - âœ… è€—æ—¶ä¿¡æ¯\r\n * - âœ… åµŒå¥—å±‚çº§ï¼ˆç¼©è¿›ï¼‰\r\n * - âœ… Or åˆ†æ”¯é€‰æ‹©\r\n * - âœ… å›æº¯æ ‡è¯†\r\n * - âœ… æ€§èƒ½ç»Ÿè®¡ï¼ˆtotalCalls, avgTime, cacheHitsï¼‰\r\n * - âœ… Top N æ…¢è§„åˆ™ï¼ˆç®€åŒ–è¾“å‡ºï¼‰\r\n * - âœ… äºŒåˆ†å¢é‡è°ƒè¯•ï¼ˆbisectDebugï¼‰\r\n * - âœ… CST ç»“æ„éªŒè¯\r\n * - âœ… Token å®Œæ•´æ€§æ£€æŸ¥\r\n *\r\n * @version 4.0.0 - èŒè´£åˆ†ç¦» + é€šç”¨è°ƒè¯•å·¥å…·\r\n * @date 2025-11-06\r\n */\r\n\r\n// ============================================\r\n// ç±»å‹å®šä¹‰\r\n// ============================================\r\n\r\n/**\r\n * è§„åˆ™æ€§èƒ½ç»Ÿè®¡\r\n */\r\nexport interface RuleStats {\r\n    ruleName: string\r\n    totalCalls: number          // æ€»è°ƒç”¨æ¬¡æ•°ï¼ˆå«ç¼“å­˜å‘½ä¸­ï¼‰\r\n    actualExecutions: number    // å®é™…æ‰§è¡Œæ¬¡æ•°ï¼ˆä¸å«ç¼“å­˜ï¼‰\r\n    cacheHits: number          // ç¼“å­˜å‘½ä¸­æ¬¡æ•°\r\n    totalTime: number          // æ€»è€—æ—¶ï¼ˆå«ç¼“å­˜æŸ¥è¯¢ï¼‰\r\n    executionTime: number      // å®é™…æ‰§è¡Œè€—æ—¶ï¼ˆä¸å«ç¼“å­˜ï¼‰\r\n    avgTime: number            // å¹³å‡è€—æ—¶ï¼ˆä»…å®é™…æ‰§è¡Œï¼‰\r\n}\r\n\r\n// ============================================\r\n// SubhutiTraceDebugger - ç»Ÿä¸€è°ƒè¯•å™¨ï¼ˆv3.0ï¼‰\r\n// ============================================\r\n\r\n/**\r\n * Subhuti è½¨è¿¹è°ƒè¯•å™¨ï¼ˆv4.0 - æç®€ç‰ˆï¼‰\r\n *\r\n * è®¾è®¡åŸåˆ™ï¼š\r\n * - è°ƒç”¨ debug() = è¾“å‡ºæ‰€æœ‰è¯Šæ–­ä¿¡æ¯\r\n * - ä¸è°ƒç”¨ = æ— è¾“å‡º\r\n * - æ— å‚æ•°ï¼Œæ— å¤šä½™æ–¹æ³•\r\n *\r\n * æ•´åˆåŠŸèƒ½ï¼š\r\n * - è¿‡ç¨‹è¿½è¸ªï¼ˆè§„åˆ™è¿›å…¥/é€€å‡ºã€Token æ¶ˆè´¹ã€Or åˆ†æ”¯ã€å›æº¯ï¼‰\r\n * - æ€§èƒ½ç»Ÿè®¡ï¼ˆè°ƒç”¨æ¬¡æ•°ã€è€—æ—¶ã€ç¼“å­˜å‘½ä¸­ç‡ï¼‰\r\n * - CST ç»“æ„éªŒè¯ï¼ˆnull/undefined/children æ£€æµ‹ï¼‰\r\n * - Token å®Œæ•´æ€§æ£€æŸ¥ï¼ˆè¾“å…¥ vs CST å¯¹æ¯”ï¼‰\r\n * - CST ç»Ÿè®¡åˆ†æï¼ˆèŠ‚ç‚¹æ•°ã€æ·±åº¦ã€ç±»å‹åˆ†å¸ƒï¼‰\r\n * - CST å¯è§†åŒ–ï¼ˆæ ‘å½¢ç»“æ„å±•ç¤ºï¼‰\r\n *\r\n * ä½¿ç”¨ç¤ºä¾‹ï¼š\r\n * ```typescript\r\n * const parser = new MyParser(tokens)\r\n * parser.debug()  // å¼€å¯è°ƒè¯•ï¼Œè¾“å‡ºæ‰€æœ‰ä¿¡æ¯\r\n * const cst = parser.Script()\r\n * ```\r\n *\r\n * ============================================================\r\n * âš ï¸ å·²çŸ¥é™åˆ¶ - Or åˆ†æ”¯çš„ Token æ¶ˆè´¹è¾“å‡º\r\n * ============================================================\r\n *\r\n * å½“å‰å®ç°ä¼šè¾“å‡º Or åˆ†æ”¯ä¸­æ‰€æœ‰æˆåŠŸçš„ Token æ¶ˆè´¹ï¼ŒåŒ…æ‹¬å¤±è´¥åˆ†æ”¯çš„å±€éƒ¨æˆåŠŸæ¶ˆè´¹ã€‚\r\n * è¿™å¯èƒ½å¯¼è‡´åŒä¸€ä¸ª Token è¢«æ˜¾ç¤ºå¤šæ¬¡æ¶ˆè´¹ã€‚\r\n *\r\n * ã€ç¤ºä¾‹ã€‘ä»£ç ï¼š`const obj = { sum: 5 + 6 }`\r\n *\r\n * ObjectLiteral æœ‰3ä¸ªåˆ†æ”¯ï¼š\r\n *   - åˆ†æ”¯0: { }                      â†’ å¤±è´¥ï¼ˆç¼ºå°‘ }ï¼‰\r\n *   - åˆ†æ”¯1: { PropertyDefinitionList , } â†’ å¤±è´¥ï¼ˆç¼ºå°‘å°¾éƒ¨é€—å·ï¼‰\r\n *   - åˆ†æ”¯2: { PropertyDefinitionList }   â†’ æˆåŠŸ âœ…\r\n *\r\n * è¾“å‡ºä¼šæ˜¾ç¤ºï¼š\r\n *   ObjectLiteral\r\n *     ğŸ”¹ Consume token[3] - { - <LBrace> [1:13-13] âœ…  â† åˆ†æ”¯0çš„æ¶ˆè´¹\r\n *     ğŸ”¹ Consume token[3] - { - <LBrace> [1:13-13] âœ…  â† åˆ†æ”¯1çš„æ¶ˆè´¹\r\n *     ğŸ”¹ Consume token[3] - { - <LBrace> [1:13-13] âœ…  â† åˆ†æ”¯2çš„æ¶ˆè´¹ï¼ˆæˆåŠŸï¼‰\r\n *     PropertyDefinitionList > ...\r\n *\r\n * ã€åŸå› ã€‘\r\n * - Token æ¶ˆè´¹æ˜¯ç«‹å³è¾“å‡ºçš„ï¼ˆå®æ—¶è¿½è¸ªï¼‰\r\n * - å½“ Or åˆ†æ”¯å¤±è´¥æ—¶ï¼Œå·²è¾“å‡ºçš„å†…å®¹æ— æ³•æ’¤é”€\r\n * - å›æº¯æœºåˆ¶åªæ¢å¤ tokenIndexï¼Œä¸ä¼šæ’¤é”€è¾“å‡º\r\n *\r\n * ã€ä»·å€¼ã€‘\r\n * - âœ… å¯ä»¥çœ‹åˆ° Or åˆ†æ”¯çš„æ‰€æœ‰å°è¯•è¿‡ç¨‹ï¼ˆè°ƒè¯•ä»·å€¼ï¼‰\r\n * - âœ… å¸®åŠ©å‘ç° Or åˆ†æ”¯é¡ºåºé—®é¢˜ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰\r\n * - âœ… å±•ç¤ºè§£æå™¨çš„åŠ¨æ€è¡Œä¸ºï¼ˆæ•™å­¦ä»·å€¼ï¼‰\r\n *\r\n * ã€ä¸ CST çš„åŒºåˆ«ã€‘\r\n * - è§„åˆ™è·¯å¾„ï¼šè®°å½•åŠ¨æ€è¿‡ç¨‹ï¼ˆåŒ…æ‹¬å¤±è´¥çš„å°è¯•ï¼‰\r\n * - CST ç»“æ„ï¼šåªæ˜¾ç¤ºæœ€ç»ˆæˆåŠŸè·¯å¾„ï¼ˆé™æ€ç»“æœï¼‰\r\n *\r\n * ã€æœªæ¥æ”¹è¿›ã€‘\r\n * - éœ€è¦å®ç° Or åˆ†æ”¯è¾“å‡ºç¼“å†²æœºåˆ¶\r\n * - åœ¨ Or åˆ†æ”¯æˆåŠŸåæ‰è¾“å‡ºç¼“å†²å†…å®¹\r\n * - éœ€è¦ä¿®æ”¹ SubhutiParser æ·»åŠ  onOrSuccess å›è°ƒ\r\n *\r\n * ============================================================\r\n * ç¼©è¿›è§„åˆ™ï¼ˆv3.0 - æ™ºèƒ½ç¼©è¿›ï¼‰\r\n * ============================================================\r\n *\r\n * âœ… å–æ¶ˆé»˜è®¤å±‚çº§ç¼©è¿›\r\n *    - ä¸å†æ ¹æ®è§„åˆ™åµŒå¥—æ·±åº¦è‡ªåŠ¨ç¼©è¿›\r\n *\r\n * âœ… åŒçº§å‚ç›´å¯¹é½\r\n *    - åŒä¸€çˆ¶èŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹å¿…é¡»å‚ç›´å¯¹é½\r\n *    - æ‰€æœ‰æ¨æ ¼è§„åˆ™åªå½±å“å­çº§ï¼ŒåŒçº§å§‹ç»ˆå¯¹é½\r\n *\r\n * âœ… Or/Many/AtLeastOneï¼šç¬¬ä¸€æ¡è§„åˆ™çš„å­çº§æ¨1æ ¼\r\n *    - ç¬¬ä¸€æ¡è§„åˆ™æœ¬èº«ä¸æ¨ï¼Œå…¶å­çº§æ¨1æ ¼ï¼ˆ2ä¸ªç©ºæ ¼ï¼‰\r\n *\r\n * âœ… Consumeï¼šè‡ªå·±æ¨1æ ¼\r\n *    - Consume è¯­å¥æœ¬èº«æ¨1æ ¼ï¼ˆ2ä¸ªç©ºæ ¼ï¼‰\r\n *    - ä¸å½±å“ Consume çš„åŒçº§è§„åˆ™\r\n *\r\n * âœ… æ¶ˆè´¹Tokenåï¼šå½“å‰è§„åˆ™çš„åç»­å­è§„åˆ™æ¨1æ ¼ï¼ˆä¸å½±å“å…„å¼Ÿï¼‰\r\n *    - è§„åˆ™å†…éƒ¨æ¶ˆè´¹ token åï¼Œè¯¥è§„åˆ™çš„å­çº§æ¨1æ ¼ï¼ˆ2ä¸ªç©ºæ ¼ï¼‰\r\n *    - ä¸å½±å“è¯¥è§„åˆ™çš„åŒçº§è§„åˆ™\r\n *\r\n * âœ… Optionï¼šåŒ…è£¹å†…å®¹çš„å­çº§æ¨1æ ¼\r\n *    - Option åŒ…è£¹å†…å®¹çš„å­çº§æ¨1æ ¼ï¼ˆ2ä¸ªç©ºæ ¼ï¼‰\r\n *    - ä¸å½±å“åŒçº§è§„åˆ™\r\n *\r\n * ğŸ”„ ç´¯ç§¯æ•ˆæœï¼š\r\n *    - å¤šä¸ªæ¨æ ¼è§„åˆ™å¯ä»¥ç´¯ç§¯ï¼ˆä¾‹å¦‚ï¼šOr +2ç©ºæ ¼ + æ¶ˆè´¹Token +2ç©ºæ ¼ = +4ç©ºæ ¼ï¼‰\r\n *    - ç´¯ç§¯åªä½œç”¨äºå­çº§ï¼ŒåŒçº§å§‹ç»ˆä¿æŒå¯¹é½\r\n *\r\n * ============================================================\r\n * è¾“å‡ºæ ¼å¼ç¤ºä¾‹ï¼ˆä»£ç ï¼šlet count = 1ï¼‰\r\n * ============================================================\r\n *\r\n * ã€è§£æè¿‡ç¨‹ - å®æ—¶è¾“å‡ºã€‘\r\n * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n * â¡ï¸  Script\r\n * â¡ï¸  StatementList\r\n * ğŸ”€ Or â†’ trying Statement (#0/2)\r\n * â¡ï¸  Statement\r\n *   â¡ï¸  VariableStatement\r\n *   â¡ï¸  VariableDeclaration\r\n *   â¡ï¸  LetDeclaration\r\n *     ğŸ”¹ Consume  token[0] - let - <LetTok>  âœ…\r\n *     â¡ï¸  BindingList\r\n *     â¡ï¸  LexicalBinding\r\n *     â¡ï¸  BindingIdentifier\r\n *       ğŸ”¹ Consume  token[1] - count - <Identifier>  âœ…\r\n *     â¡ï¸  Initializer\r\n *       ğŸ”¹ Consume  token[2] - = - <Assign>  âœ…\r\n *       â¡ï¸  AssignmentExpression\r\n *       â¡ï¸  ConditionalExpression\r\n *       â¡ï¸  PrimaryExpression\r\n *       â¡ï¸  Literal\r\n *         ğŸ”¹ Consume  token[3] - 1 - <DecimalLiteral>  âœ…\r\n * âª Backtrack  token[4] â†’ token[4]\r\n *\r\n * ============================================================\r\n *\r\n * ã€ç¬¬ä¸€éƒ¨åˆ†ï¼šæ€§èƒ½æ‘˜è¦ã€‘\r\n * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n *\r\n * â±ï¸  æ€§èƒ½æ‘˜è¦\r\n * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n * æ€»è€—æ—¶: 0.75ms\r\n * æ€»è°ƒç”¨: 25 æ¬¡\r\n * å®é™…æ‰§è¡Œ: 25 æ¬¡\r\n * ç¼“å­˜å‘½ä¸­: 0 æ¬¡ (0.0%)\r\n *\r\n * Top 5 æ…¢è§„åˆ™:\r\n *   1. Script: 0.75ms (1æ¬¡, å¹³å‡750.0Î¼s)\r\n *   2. StatementList: 0.68ms (1æ¬¡, å¹³å‡680.0Î¼s)\r\n *   3. Statement: 0.55ms (1æ¬¡, å¹³å‡550.0Î¼s)\r\n *   4. VariableStatement: 0.52ms (1æ¬¡, å¹³å‡520.0Î¼s)\r\n *   5. VariableDeclaration: 0.48ms (1æ¬¡, å¹³å‡480.0Î¼s)\r\n *\r\n * ğŸ“‹ æ‰€æœ‰è§„åˆ™è¯¦ç»†ç»Ÿè®¡:\r\n *   Script: 1æ¬¡ | æ‰§è¡Œ1æ¬¡ | è€—æ—¶0.75ms | ç¼“å­˜0%\r\n *   StatementList: 1æ¬¡ | æ‰§è¡Œ1æ¬¡ | è€—æ—¶0.68ms | ç¼“å­˜0%\r\n *   Statement: 1æ¬¡ | æ‰§è¡Œ1æ¬¡ | è€—æ—¶0.55ms | ç¼“å­˜0%\r\n *   VariableStatement: 1æ¬¡ | æ‰§è¡Œ1æ¬¡ | è€—æ—¶0.52ms | ç¼“å­˜0%\r\n *   VariableDeclaration: 1æ¬¡ | æ‰§è¡Œ1æ¬¡ | è€—æ—¶0.48ms | ç¼“å­˜0%\r\n *   ... (æ›´å¤šè§„åˆ™)\r\n *\r\n * ============================================================\r\n *\r\n * ã€ç¬¬äºŒéƒ¨åˆ†ï¼šCST éªŒè¯æŠ¥å‘Šã€‘\r\n * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n *\r\n * ğŸ” CST éªŒè¯æŠ¥å‘Š\r\n * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n *\r\n * ğŸ“Œ ç»“æ„å®Œæ•´æ€§: âœ…\r\n *    æ— ç»“æ„é”™è¯¯\r\n *\r\n * ğŸ“Œ Token å®Œæ•´æ€§: âœ…\r\n *    è¾“å…¥ tokens: 4 ä¸ª\r\n *    CST tokens:  4 ä¸ª\r\n *    è¾“å…¥åˆ—è¡¨: [let, count, =, 1]\r\n *    CSTåˆ—è¡¨:  [let, count, =, 1]\r\n *    âœ… å®Œæ•´ä¿ç•™\r\n *\r\n * ğŸ“Œ CST ç»Ÿè®¡:\r\n *    æ€»èŠ‚ç‚¹æ•°: 28\r\n *    å¶å­èŠ‚ç‚¹: 4\r\n *    æœ€å¤§æ·±åº¦: 13\r\n *    èŠ‚ç‚¹ç±»å‹: 14 ç§\r\n *\r\n *    èŠ‚ç‚¹ç±»å‹åˆ†å¸ƒ:\r\n *      Script: 1\r\n *      StatementList: 1\r\n *      Statement: 1\r\n *      VariableStatement: 1\r\n *      VariableDeclaration: 1\r\n *      ... (æ›´å¤šç±»å‹)\r\n *\r\n * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n *\r\n * ã€ç¬¬ä¸‰éƒ¨åˆ†ï¼šCST å¯è§†åŒ–ã€‘\r\n * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n *\r\n * ğŸ“Š CST ç»“æ„\r\n * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n * â””â”€Script [1:1-12]\r\n *    â””â”€StatementList [1:1-12]\r\n *       â””â”€Statement [1:1-12]\r\n *          â””â”€VariableStatement [1:1-12]\r\n *             â””â”€VariableDeclaration [1:1-12]\r\n *                â””â”€LetDeclaration [1:1-12]\r\n *                   â”œâ”€LetTok: \"let\" [1:1-3]\r\n *                   â””â”€BindingList [1:5-12]\r\n *                      â””â”€LexicalBinding [1:5-12]\r\n *                         â”œâ”€BindingIdentifier [1:5-9]\r\n *                         â”‚  â””â”€Identifier: \"count\" [1:5-9]\r\n *                         â””â”€Initializer [1:11-12]\r\n *                            â”œâ”€Assign: \"=\" [1:11-11]\r\n *                            â””â”€AssignmentExpression [1:13-13]\r\n *                               â””â”€ConditionalExpression [1:13-13]\r\n *                                  â””â”€PrimaryExpression [1:13-13]\r\n *                                     â””â”€Literal [1:13-13]\r\n *                                        â””â”€DecimalLiteral: \"1\" [1:13-13]\r\n * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n *\r\n * ============================================================\r\n * ğŸ‰ Debug è¾“å‡ºå®Œæˆ\r\n * ============================================================\r\n *\r\n * æ³¨æ„ï¼š\r\n * - æ­¤è¾“å‡ºæ ¼å¼å¯èƒ½éšç‰ˆæœ¬æ›´æ–°è€Œè°ƒæ•´\r\n * - å¦‚éœ€ä¿®æ”¹æ ¼å¼ï¼Œè¯·åŒæ­¥æ›´æ–°æ­¤æ³¨é‡Šä¸­çš„ç¤ºä¾‹\r\n */\r\n\r\nimport type SubhutiCst from \"./struct/SubhutiCst.ts\"\r\nimport {\r\n    type RuleStackItem,\r\n    SubhutiDebugRuleTracePrint,\r\n    TreeFormatHelper,\r\n} from \"./SubhutiDebugRuleTracePrint\"\r\n\r\n\r\n// ============================================\r\n// SubhutiDebugUtils - è°ƒè¯•å·¥å…·é›†ï¼ˆv4.0ï¼‰\r\n// ============================================\r\n\r\n/**\r\n * Subhuti è°ƒè¯•å·¥å…·é›†\r\n *\r\n * èŒè´£ï¼š\r\n * - æä¾›ç‹¬ç«‹çš„è°ƒè¯•å·¥å…·ï¼ˆæ— çŠ¶æ€ï¼‰\r\n * - CST åˆ†æã€Token éªŒè¯ã€é«˜çº§è°ƒè¯•æ–¹æ³•\r\n *\r\n * ä½¿ç”¨åœºæ™¯ï¼š\r\n * - æµ‹è¯•è„šæœ¬ç›´æ¥è°ƒç”¨\r\n * - å¤–éƒ¨å·¥å…·é›†æˆ\r\n * - è‡ªå®šä¹‰éªŒè¯é€»è¾‘\r\n *\r\n * @version 4.0.0 - èŒè´£åˆ†ç¦»\r\n * @date 2025-11-06\r\n */\r\nexport class SubhutiDebugUtils {\r\n    // ========================================\r\n    // CST Token åˆ†æ\r\n    // ========================================\r\n\r\n    /**\r\n     * æ”¶é›† CST ä¸­çš„æ‰€æœ‰ token å€¼\r\n     *\r\n     * @param node - CST èŠ‚ç‚¹\r\n     * @returns token å€¼æ•°ç»„\r\n     *\r\n     * @example\r\n     * ```typescript\r\n     * const cst = parser.Script()\r\n     * const tokens = SubhutiDebugUtils.collectTokens(cst)\r\n     * console.log(tokens)  // ['const', 'obj', '=', '{', 'sum', ':', '5', '+', '6', '}']\r\n     * ```\r\n     */\r\n    static collectTokens(node: SubhutiCst): string[] {\r\n        const values: string[] = []\r\n\r\n        if (!node) return values\r\n\r\n        if (node.value !== undefined && (!node.children || node.children.length === 0)) {\r\n            values.push(node.value)\r\n        }\r\n\r\n        if (node.children && Array.isArray(node.children)) {\r\n            for (const child of node.children) {\r\n                values.push(...SubhutiDebugUtils.collectTokens(child))\r\n            }\r\n        }\r\n\r\n        return values\r\n    }\r\n\r\n    /**\r\n     * éªŒè¯ CST çš„ token å®Œæ•´æ€§\r\n     *\r\n     * @param cst - CST èŠ‚ç‚¹\r\n     * @param inputTokens - è¾“å…¥ token æ•°ç»„æˆ– token å€¼æ•°ç»„\r\n     * @returns éªŒè¯ç»“æœ\r\n     *\r\n     * @example\r\n     * ```typescript\r\n     * const result = SubhutiDebugUtils.validateTokenCompleteness(cst, tokens)\r\n     * if (result.complete) {\r\n     *     console.log('âœ… Token å®Œæ•´')\r\n     * } else {\r\n     *     console.log('âŒ ç¼ºå¤±:', result.missing)\r\n     * }\r\n     * ```\r\n     */\r\n    static validateTokenCompleteness(\r\n        cst: any,\r\n        inputTokens: string[] | any[]\r\n    ): {\r\n        complete: boolean\r\n        inputCount: number\r\n        cstCount: number\r\n        inputTokens: string[]\r\n        cstTokens: string[]\r\n        missing: string[]\r\n    } {\r\n        // æå– token å€¼\r\n        const inputValues = inputTokens.map(t =>\r\n            typeof t === 'string' ? t : (t.tokenValue || '')\r\n        ).filter(v => v !== '')\r\n\r\n        const cstTokens = SubhutiDebugUtils.collectTokens(cst)\r\n\r\n        // æ‰¾å‡ºç¼ºå¤±çš„ tokenï¼ˆæŒ‰é¡ºåºæ¯”è¾ƒï¼‰\r\n        const missing: string[] = []\r\n        for (let i = 0; i < inputValues.length; i++) {\r\n            if (i >= cstTokens.length || inputValues[i] !== cstTokens[i]) {\r\n                missing.push(inputValues[i])\r\n            }\r\n        }\r\n\r\n        return {\r\n            complete: missing.length === 0 && inputValues.length === cstTokens.length,\r\n            inputCount: inputValues.length,\r\n            cstCount: cstTokens.length,\r\n            inputTokens: inputValues,\r\n            cstTokens: cstTokens,\r\n            missing: missing\r\n        }\r\n    }\r\n\r\n    // ========================================\r\n    // CST ç»“æ„éªŒè¯\r\n    // ========================================\r\n\r\n    /**\r\n     * éªŒè¯ CST ç»“æ„å®Œæ•´æ€§\r\n     *\r\n     * @param node - CST èŠ‚ç‚¹\r\n     * @param path - èŠ‚ç‚¹è·¯å¾„ï¼ˆç”¨äºé”™è¯¯æŠ¥å‘Šï¼‰\r\n     * @returns é”™è¯¯åˆ—è¡¨\r\n     */\r\n    static validateStructure(\r\n        node: any,\r\n        path: string = 'root'\r\n    ): Array<{ path: string, issue: string, node?: any }> {\r\n        const errors: Array<{ path: string, issue: string, node?: any }> = []\r\n\r\n        if (node === null) {\r\n            errors.push({path, issue: 'Node is null'})\r\n            return errors\r\n        }\r\n\r\n        if (node === undefined) {\r\n            errors.push({path, issue: 'Node is undefined'})\r\n            return errors\r\n        }\r\n\r\n        if (!node.name && node.value === undefined) {\r\n            errors.push({\r\n                path,\r\n                issue: 'Node has neither name nor value',\r\n                node: {...node, children: node.children ? `[${node.children.length} children]` : undefined}\r\n            })\r\n        }\r\n\r\n        if (node.children !== undefined) {\r\n            if (!Array.isArray(node.children)) {\r\n                errors.push({\r\n                    path,\r\n                    issue: `children is not an array (type: ${typeof node.children})`,\r\n                    node: {name: node.name, childrenType: typeof node.children}\r\n                })\r\n                return errors\r\n            }\r\n\r\n            node.children.forEach((child: any, index: number) => {\r\n                const childPath = `${path}.children[${index}]`\r\n\r\n                if (child === null) {\r\n                    errors.push({path: childPath, issue: 'Child is null'})\r\n                    return\r\n                }\r\n\r\n                if (child === undefined) {\r\n                    errors.push({path: childPath, issue: 'Child is undefined'})\r\n                    return\r\n                }\r\n\r\n                const childErrors = SubhutiDebugUtils.validateStructure(child, childPath)\r\n                errors.push(...childErrors)\r\n            })\r\n        }\r\n\r\n        if (node.value !== undefined && node.children && node.children.length > 0) {\r\n            errors.push({\r\n                path,\r\n                issue: `Leaf node has both value and non-empty children`,\r\n                node: {name: node.name, value: node.value, childrenCount: node.children.length}\r\n            })\r\n        }\r\n\r\n        return errors\r\n    }\r\n\r\n    /**\r\n     * è·å– CST ç»Ÿè®¡ä¿¡æ¯\r\n     *\r\n     * @param node - CST èŠ‚ç‚¹\r\n     * @returns ç»Ÿè®¡ä¿¡æ¯\r\n     */\r\n    static getCSTStatistics(node: any): {\r\n        totalNodes: number\r\n        leafNodes: number\r\n        maxDepth: number\r\n        nodeTypes: Map<string, number>\r\n    } {\r\n        const stats = {\r\n            totalNodes: 0,\r\n            leafNodes: 0,\r\n            maxDepth: 0,\r\n            nodeTypes: new Map<string, number>()\r\n        }\r\n\r\n        const traverse = (node: any, depth: number) => {\r\n            if (!node) return\r\n\r\n            stats.totalNodes++\r\n            stats.maxDepth = Math.max(stats.maxDepth, depth)\r\n\r\n            if (node.name) {\r\n                stats.nodeTypes.set(node.name, (stats.nodeTypes.get(node.name) || 0) + 1)\r\n            }\r\n\r\n            if (!node.children || node.children.length === 0) {\r\n                stats.leafNodes++\r\n            } else {\r\n                for (const child of node.children) {\r\n                    traverse(child, depth + 1)\r\n                }\r\n            }\r\n        }\r\n\r\n        traverse(node, 0)\r\n        return stats\r\n    }\r\n\r\n    /**\r\n     * æ ¼å¼åŒ– CST ä¸ºæ ‘å½¢ç»“æ„å­—ç¬¦ä¸²\r\n     *\r\n     * @param cst - CST èŠ‚ç‚¹\r\n     * @param prefix - å‰ç¼€ï¼ˆé€’å½’ä½¿ç”¨ï¼‰\r\n     * @param isLast - æ˜¯å¦ä¸ºæœ€åä¸€ä¸ªå­èŠ‚ç‚¹ï¼ˆé€’å½’ä½¿ç”¨ï¼‰\r\n     * @returns æ ‘å½¢ç»“æ„å­—ç¬¦ä¸²\r\n     */\r\n    static formatCst(cst: SubhutiCst, prefix: string = '', isLast: boolean = true): string {\r\n        const lines: string[] = []\r\n\r\n        // å½“å‰èŠ‚ç‚¹è¡Œ\r\n        const connector = isLast ? 'â””â”€' : 'â”œâ”€'\r\n        const nodeLine = SubhutiDebugUtils.formatNode(cst, prefix, connector)\r\n        lines.push(nodeLine)\r\n\r\n        // å­èŠ‚ç‚¹\r\n        if (cst.children && cst.children.length > 0) {\r\n            const childPrefix = prefix + (isLast ? '   ' : 'â”‚  ')\r\n\r\n            cst.children.forEach((child: any, index: number) => {\r\n                const isLastChild = index === cst.children.length - 1\r\n                lines.push(SubhutiDebugUtils.formatCst(child, childPrefix, isLastChild))\r\n            })\r\n        }\r\n\r\n        return lines.join('\\n')\r\n    }\r\n\r\n    /**\r\n     * æ ¼å¼åŒ–å•ä¸ªèŠ‚ç‚¹ï¼ˆä½¿ç”¨ TreeFormatHelperï¼‰\r\n     */\r\n    private static formatNode(cst: SubhutiCst, prefix: string, connector: string): string {\r\n        const isToken = cst.value !== undefined\r\n\r\n        if (isToken) {\r\n            // Token èŠ‚ç‚¹ï¼šæ˜¾ç¤ºåç§°ã€å€¼ã€ä½ç½®\r\n            const value = TreeFormatHelper.formatTokenValue(cst.value)\r\n            const location = cst.loc ? TreeFormatHelper.formatLocation(cst.loc) : null\r\n\r\n            return TreeFormatHelper.formatLine(\r\n                [connector, cst.name + ':', `\"${value}\"`, location].join(''),\r\n                {prefix}\r\n            )\r\n        } else {\r\n            // Rule èŠ‚ç‚¹ï¼šåªæ˜¾ç¤ºåç§°\r\n            return TreeFormatHelper.formatLine(\r\n                [connector, cst.name].join(''),\r\n                {prefix}\r\n            )\r\n        }\r\n    }\r\n\r\n    // ========================================\r\n    // é«˜çº§è°ƒè¯•æ–¹æ³•\r\n    // ========================================\r\n\r\n    /**\r\n     * äºŒåˆ†å¢é‡è°ƒè¯• - ä»æœ€åº•å±‚è§„åˆ™é€å±‚æµ‹è¯•åˆ°é¡¶å±‚\r\n     *\r\n     * è¿™æ˜¯ä¸€ä¸ªå¼ºå¤§çš„è°ƒè¯•å·¥å…·ï¼Œç”¨äºå¿«é€Ÿå®šä½é—®é¢˜å±‚çº§ã€‚\r\n     * å®ƒä¼šä»æœ€åº•å±‚è§„åˆ™å¼€å§‹é€å±‚æµ‹è¯•ï¼Œç›´åˆ°æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¤±è´¥çš„å±‚çº§ã€‚\r\n     *\r\n     * @param tokens - è¾“å…¥ token æµ\r\n     * @param ParserClass - Parser ç±»ï¼ˆæ„é€ å‡½æ•°ï¼‰\r\n     * @param levels - æµ‹è¯•å±‚çº§é…ç½®ï¼ˆä»åº•å±‚åˆ°é¡¶å±‚ï¼‰\r\n     * @param options - å¯é€‰é…ç½®\r\n     * @param options.enableDebugOnLastLevel - æ˜¯å¦åœ¨æœ€åä¸€å±‚å¯ç”¨ debugï¼ˆé»˜è®¤ trueï¼‰\r\n     * @param options.stopOnFirstError - é‡åˆ°ç¬¬ä¸€ä¸ªé”™è¯¯æ—¶åœæ­¢ï¼ˆé»˜è®¤ trueï¼‰\r\n     * @param options.showStackTrace - æ˜¾ç¤ºå †æ ˆè·Ÿè¸ªï¼ˆé»˜è®¤ trueï¼‰\r\n     * @param options.stackTraceLines - å †æ ˆè·Ÿè¸ªæ˜¾ç¤ºè¡Œæ•°ï¼ˆé»˜è®¤ 10ï¼‰\r\n     *\r\n     * @example\r\n     * ```typescript\r\n     * import { SubhutiDebugUtils } from 'subhuti/src/SubhutiDebug'\r\n     * import Es2025Parser from './Es2025Parser'\r\n     *\r\n     * const tokens = lexer.tokenize(\"let count = 1\")\r\n     *\r\n     * SubhutiDebugUtils.bisectDebug(tokens, Es2025Parser, [\r\n     *     { name: 'LexicalDeclaration', call: (p) => p.LexicalDeclaration({In: true}) },\r\n     *     { name: 'Declaration', call: (p) => p.Declaration() },\r\n     *     { name: 'StatementListItem', call: (p) => p.StatementListItem() },\r\n     *     { name: 'Script', call: (p) => p.Script() }\r\n     * ], { enableDebugOnLastLevel: false })\r\n     * ```\r\n     */\r\n    static bisectDebug(\r\n        tokens: any[],\r\n        ParserClass: new (tokens: any[]) => any,\r\n        levels: Array<{\r\n            name: string\r\n            call: (parser: any) => any\r\n        }>,\r\n        options?: {\r\n            enableDebugOnLastLevel?: boolean\r\n            stopOnFirstError?: boolean\r\n            showStackTrace?: boolean\r\n            stackTraceLines?: number\r\n        }\r\n    ): void {\r\n        // é»˜è®¤é€‰é¡¹\r\n        const opts = {\r\n            enableDebugOnLastLevel: true,\r\n            stopOnFirstError: true,\r\n            showStackTrace: true,\r\n            stackTraceLines: 10,\r\n            ...options\r\n        }\r\n\r\n        console.log('\\nğŸ”¬ äºŒåˆ†å¢é‡è°ƒè¯•æ¨¡å¼')\r\n        console.log('='.repeat(80))\r\n        console.log('ç­–ç•¥ï¼šä»æœ€åº•å±‚è§„åˆ™é€å±‚æµ‹è¯•ï¼Œæ‰¾å‡ºé—®é¢˜å±‚çº§\\n')\r\n\r\n        for (let i = 0; i < levels.length; i++) {\r\n            const level = levels[i]\r\n\r\n            console.log(`\\n[${'â–¸'.repeat(i + 1)}] æµ‹è¯•å±‚çº§ ${i + 1}: ${level.name}`)\r\n            console.log('-'.repeat(80))\r\n\r\n            try {\r\n                // åˆ›å»º parser å®ä¾‹\r\n                const parser = new ParserClass(tokens)\r\n\r\n                // åœ¨æœ€åä¸€å±‚ï¼ˆé¡¶å±‚è§„åˆ™ï¼‰å¼€å¯ debugï¼ˆå¦‚æœæ”¯æŒä¸”å·²å¯ç”¨ï¼‰\r\n                if (opts.enableDebugOnLastLevel && i === levels.length - 1) {\r\n                    if (typeof parser.debug === 'function') {\r\n                        parser.debug()\r\n                    }\r\n                }\r\n\r\n                const result = level.call(parser)\r\n\r\n                if (!result) {\r\n                    console.log(`\\nâš ï¸ ${level.name} è¿”å› undefined`)\r\n                    continue\r\n                }\r\n\r\n                // éªŒè¯ token å®Œæ•´æ€§\r\n                const validation = SubhutiDebugUtils.validateTokenCompleteness(result, tokens)\r\n\r\n                if (validation.complete) {\r\n                    console.log(`\\nâœ… ${level.name} è§£ææˆåŠŸï¼ˆTokenå®Œæ•´: ${validation.cstCount}/${validation.inputCount}ï¼‰`)\r\n                } else {\r\n                    console.log(`\\nâŒ ${level.name} Tokenä¸å®Œæ•´`)\r\n                    console.log(`   è¾“å…¥tokens: ${validation.inputCount} ä¸ª`)\r\n                    console.log(`   CST tokens:  ${validation.cstCount} ä¸ª`)\r\n                    console.log(`   è¾“å…¥åˆ—è¡¨: [${validation.inputTokens.join(', ')}]`)\r\n                    console.log(`   CSTåˆ—è¡¨:  [${validation.cstTokens.join(', ')}]`)\r\n\r\n                    if (validation.missing.length > 0) {\r\n                        console.log(`   âŒ ç¼ºå¤±æˆ–é”™ä½: [${validation.missing.join(', ')}]`)\r\n                    }\r\n\r\n                    console.log(`\\nğŸ” é—®é¢˜å®šä½: ${level.name} æœªèƒ½æ¶ˆè´¹æ‰€æœ‰token`)\r\n\r\n                    if (i > 0) {\r\n                        console.log(`   âš ï¸ å‰ä¸€å±‚çº§ï¼ˆ${levels[i - 1].name}ï¼‰ä¹Ÿå¯èƒ½æœ‰é—®é¢˜`)\r\n                        console.log(`   ğŸ’¡ å»ºè®®: æ£€æŸ¥ ${level.name} å’Œ ${levels[i - 1].name} çš„å®ç°`)\r\n                    } else {\r\n                        console.log(`   ğŸ’¡ å»ºè®®: æ£€æŸ¥ ${level.name} çš„å®ç°ï¼Œç¡®ä¿æ‰€æœ‰tokenéƒ½è¢«æ­£ç¡®å¤„ç†`)\r\n                    }\r\n\r\n                    if (opts.stopOnFirstError) {\r\n                        return // é‡åˆ° token ä¸å®Œæ•´å°±åœæ­¢\r\n                    }\r\n                }\r\n            } catch (error: any) {\r\n                console.log(`\\nâŒ ${level.name} è§£æå¤±è´¥`)\r\n                console.log(`   é”™è¯¯: ${error.message}`)\r\n                console.log(`\\nğŸ” é—®é¢˜å®šä½: ${level.name} å±‚çº§å‡ºç°é”™è¯¯`)\r\n\r\n                if (i > 0) {\r\n                    console.log(`   âœ… å‰ä¸€å±‚çº§ï¼ˆ${levels[i - 1].name}ï¼‰å¯ä»¥å·¥ä½œ`)\r\n                    console.log(`   âŒ å½“å‰å±‚çº§ï¼ˆ${level.name}ï¼‰å‡ºç°é—®é¢˜`)\r\n                    console.log(`\\nğŸ’¡ å»ºè®®: æ£€æŸ¥ ${level.name} çš„å®ç°ï¼Œç‰¹åˆ«æ˜¯å®ƒå¦‚ä½•è°ƒç”¨ ${levels[i - 1].name}`)\r\n                } else {\r\n                    console.log(`   âŒ æœ€åº•å±‚è§„åˆ™ï¼ˆ${level.name}ï¼‰å°±å·²ç»å¤±è´¥`)\r\n                    console.log(`\\nğŸ’¡ å»ºè®®: æ£€æŸ¥ ${level.name} çš„å®ç°å’Œ token å®šä¹‰`)\r\n                }\r\n\r\n                // è¾“å‡ºå †æ ˆè·Ÿè¸ª\r\n                if (opts.showStackTrace && error.stack) {\r\n                    console.log(`\\nğŸ“‹ å †æ ˆè·Ÿè¸ªï¼ˆå‰${opts.stackTraceLines}è¡Œï¼‰:`)\r\n                    const stackLines = error.stack.split('\\n').slice(0, opts.stackTraceLines)\r\n                    stackLines.forEach((line: string) => console.log(`   ${line}`))\r\n                }\r\n\r\n                if (opts.stopOnFirstError) {\r\n                    return // é‡åˆ°é”™è¯¯å°±åœæ­¢\r\n                }\r\n            }\r\n        }\r\n\r\n        console.log('\\n' + '='.repeat(80))\r\n        console.log('ğŸ‰ æ‰€æœ‰å±‚çº§æµ‹è¯•é€šè¿‡ï¼')\r\n        console.log('='.repeat(80))\r\n    }\r\n}\r\n\r\n// ============================================\r\n// SubhutiTraceDebugger - è¿½è¸ªå™¨ï¼ˆv4.0ï¼‰\r\n// ============================================\r\n\r\nexport class SubhutiTraceDebugger {\r\n    // ========================================\r\n    // è¿‡ç¨‹è¿½è¸ªæ•°æ®ï¼ˆæ–°ç‰ˆ - åªç”¨ ruleStackï¼‰\r\n    // ========================================\r\n    public ruleStack: RuleStackItem[] = []\r\n\r\n    // ========================================\r\n    // æ€§èƒ½ç»Ÿè®¡æ•°æ®\r\n    // ========================================\r\n    private stats = new Map<string, RuleStats>()\r\n\r\n    // ========================================\r\n    // è§„åˆ™è·¯å¾„ç¼“å­˜ï¼ˆç”¨äºç¼“å­˜å‘½ä¸­æ—¶å¿«é€Ÿæ¢å¤æ—¥å¿—è·¯å¾„ï¼‰\r\n    // ========================================\r\n    private rulePathCache = new Map<string, RuleStackItem>()\r\n\r\n    // ========================================\r\n    // Token æ•°æ®\r\n    // ========================================\r\n    private inputTokens: any[] = []  // å­˜å‚¨å®Œæ•´ token å¯¹è±¡ï¼ˆåŒ…å«ä½ç½®ä¿¡æ¯ï¼‰\r\n\r\n    // ========================================\r\n    // CST æ•°æ®\r\n    // ========================================\r\n    private topLevelCst: SubhutiCst | null = null\r\n\r\n    /**\r\n     * æ„é€ å‡½æ•°\r\n     *\r\n     * @param tokens - è¾“å…¥ token æµï¼ˆç”¨äºå®Œæ•´æ€§æ£€æŸ¥å’Œä½ç½®ä¿¡æ¯ï¼‰\r\n     */\r\n    constructor(tokens?: any[]) {\r\n        this.inputTokens = this.extractValidTokens(tokens || [])\r\n    }\r\n\r\n    /**\r\n     * é‡ç½®è°ƒè¯•å™¨çŠ¶æ€ï¼Œä¸ºæ–°ä¸€è½®è§£æåšå‡†å¤‡\r\n     *\r\n     * èŒè´£ï¼š\r\n     * - æ¸…ç©ºæ—§çš„è§„åˆ™è·¯å¾„ç¼“å­˜\r\n     * - æ¸…ç©ºæ—§çš„æ€§èƒ½ç»Ÿè®¡\r\n     * - åˆ·æ–° token å¿«ç…§\r\n     *\r\n     * è°ƒç”¨æ—¶æœºï¼šæ¯æ¬¡é¡¶å±‚è§„åˆ™å¼€å§‹å‰ï¼ˆç”± SubhutiParser è°ƒç”¨ï¼‰\r\n     */\r\n    resetForNewParse(tokens?: any[]): void {\r\n        // æ¸…ç©ºè§„åˆ™è·¯å¾„ç¼“å­˜ï¼ˆé˜²æ­¢ä¸Šä¸€æ¬¡è§£æçš„æ•°æ®æ±¡æŸ“æ–°è§£æï¼‰\r\n        this.rulePathCache.clear()\r\n\r\n        // æ¸…ç©ºæ€§èƒ½ç»Ÿè®¡ï¼ˆæ¯æ¬¡æ–°è§£æéƒ½é‡æ–°ç»Ÿè®¡ï¼‰\r\n        this.stats.clear()\r\n\r\n        // æ›´æ–° token å¿«ç…§ï¼ˆå¦‚æœä¼ å…¥äº†æ–°çš„ tokensï¼‰\r\n        if (tokens) {\r\n            // åˆ·æ–° token åˆ—è¡¨ï¼ˆæå–æœ‰æ•ˆ tokenï¼Œæ’é™¤æ³¨é‡Šç­‰ï¼‰\r\n            this.inputTokens = this.extractValidTokens(tokens)\r\n        }\r\n        // å¦åˆ™ä¿ç•™ç°æœ‰çš„ inputTokensï¼ˆä½†é€šå¸¸ Parser ä¼šä¼ å…¥å½“å‰ tokensï¼‰\r\n    }\r\n\r\n    /**\r\n     * ä» token æµä¸­æå–æœ‰æ•ˆ tokenï¼ˆæ’é™¤æ³¨é‡Šã€ç©ºæ ¼ç­‰ï¼‰\r\n     *\r\n     * @returns å®Œæ•´çš„ token å¯¹è±¡æ•°ç»„ï¼ˆåŒ…å« tokenValue, tokenName, loc ç­‰ï¼‰\r\n     */\r\n    private extractValidTokens(tokens: any[]): any[] {\r\n        const excludeNames = ['SingleLineComment', 'MultiLineComment', 'Spacing', 'LineBreak']\r\n        return tokens.filter(t => {\r\n            const name = t.tokenName || ''\r\n            return excludeNames.indexOf(name) === -1\r\n        })\r\n    }\r\n\r\n    /**\r\n     * æ·±æ‹·è´ RuleStackItemï¼ˆæ‰‹åŠ¨æ‹·è´æ¯ä¸ªå­—æ®µï¼‰\r\n     */\r\n    private deepCloneRuleStackItem(item: RuleStackItem): RuleStackItem {\r\n        if (item.ruleName) {\r\n            if (!item.childs.length) {\r\n                throw new Error('ç³»ç»Ÿé”™è¯¯')\r\n            }\r\n        }\r\n        const clone: RuleStackItem = {\r\n            ruleName: item.ruleName,\r\n            tokenName: item.tokenName,\r\n            tokenValue: item.tokenValue,\r\n            startTime: item.startTime,\r\n            outputted: item.outputted,\r\n            tokenIndex: item.tokenIndex,\r\n            tokenSuccess: item.tokenSuccess,\r\n            tokenExpectName: item.tokenExpectName,\r\n            shouldBreakLine: item.shouldBreakLine,\r\n            displayDepth: item.displayDepth,\r\n            childs: item.childs,  // ã€æ–°å¢ã€‘å…‹éš† childs æ•°ç»„\r\n            // relativeDepthByStack: item.relativeDepthByStack,    // ã€é˜²å¾¡æ€§ç¼–ç¨‹ã€‘å…‹éš†ç›¸å¯¹æ·±åº¦\r\n            // relativeDepthByChilds: item.relativeDepthByChilds,  // ã€é˜²å¾¡æ€§ç¼–ç¨‹ã€‘å…‹éš†ç›¸å¯¹æ·±åº¦\r\n            orBranchInfo: item.orBranchInfo ? {\r\n                orIndex: item.orBranchInfo.orIndex,\r\n                branchIndex: item.orBranchInfo.branchIndex,\r\n                isOrEntry: item.orBranchInfo.isOrEntry,\r\n                isOrBranch: item.orBranchInfo.isOrBranch,\r\n                totalBranches: item.orBranchInfo.totalBranches\r\n            } : undefined\r\n        }\r\n        return clone\r\n    }\r\n\r\n    // ========================================\r\n    // è¾…åŠ©æ–¹æ³•ï¼ˆå§”æ‰˜ç»™é™æ€å·¥å…·ç±»ï¼‰\r\n    // ========================================\r\n\r\n    /**\r\n     * ç”Ÿæˆç¼“å­˜é”®ï¼ˆåŒ…å« Or èŠ‚ç‚¹ä¿¡æ¯ï¼‰\r\n     */\r\n    private generateCacheKey(item: RuleStackItem): string {\r\n        // ã€ç»Ÿä¸€æ ¼å¼ã€‘ruleName:tokenIndex:isOrEntry:isOrBranch:orIndex:branchIndex:tokenValue:tokenName\r\n        const ruleName = item.ruleName\r\n        const tokenIndex = item.tokenIndex.toString()\r\n\r\n        const isOrEntry = item.orBranchInfo ? (item.orBranchInfo.isOrEntry ? '1' : '0') : '0'\r\n        const isOrBranch = item.orBranchInfo ? (item.orBranchInfo.isOrBranch ? '1' : '0') : '0'\r\n        const orIndex = item.orBranchInfo?.orIndex?.toString() ?? '-1'\r\n        const branchIndex = item.orBranchInfo?.branchIndex?.toString() ?? '-1'\r\n\r\n        const tokenValue = item.tokenValue ?? ''\r\n        const tokenName = item.tokenName ?? ''\r\n        const tokenExpectName = item.tokenExpectName ?? ''\r\n        const tokenSuccess = item.tokenSuccess ?? false\r\n\r\n        return `${ruleName}:${tokenIndex}:${isOrEntry}:${isOrBranch}:${orIndex}:${branchIndex}:${tokenValue}:${tokenName}:${tokenExpectName}:${tokenSuccess}`\r\n    }\r\n\r\n    private createTokenItem(tokenIndex: number, tokenValue: string, tokenName: string, expectName: string, success: boolean): RuleStackItem {\r\n        // ã€ç»Ÿä¸€ã€‘åˆ›å»º Token çš„ RuleStackItem\r\n        return {\r\n            ruleName: undefined,\r\n            tokenSuccess: success,\r\n            tokenExpectName: expectName,\r\n            startTime: 0,\r\n            outputted: false,\r\n            tokenIndex: tokenIndex,\r\n            shouldBreakLine: true,  // âœ… Token æ€»æ˜¯éœ€è¦å•ç‹¬æ˜¾ç¤ºï¼ˆæ–­é“¾ï¼‰\r\n            // childs: [], tokenä¸éœ€è¦ // åˆå§‹åŒ– childs æ•°ç»„\r\n            tokenValue: tokenValue,  // âœ… åˆ©ç”¨ [key: string]: any å­˜å‚¨\r\n            tokenName: tokenName,     // âœ… åˆ©ç”¨ [key: string]: any å­˜å‚¨\r\n        }\r\n    }\r\n\r\n    /**\r\n     * ä»ç¼“å­˜æ¢å¤è§„åˆ™è·¯å¾„ï¼ˆé€’å½’æ¢å¤æ•´ä¸ªé“¾æ¡ï¼‰\r\n     *\r\n     * @param cacheKey - ç¼“å­˜é”®\r\n     * @param isRoot - æ˜¯å¦æ˜¯æ ¹èŠ‚ç‚¹\r\n     * @param OrBranchNeedNewLine - æ˜¯å¦éœ€è¦å•ç‹¬è¡Œï¼Œorç›¸å…³ä¸“ç”¨\r\n     * @param displayDepth - çˆ¶èŠ‚ç‚¹çš„ displayDepthï¼ˆç”¨äºè®¡ç®—å½“å‰èŠ‚ç‚¹çš„æ·±åº¦ï¼‰\r\n     */\r\n    private restoreFromCacheAndPushAndPrint(cacheKey: string, displayDepth: number, OrBranchNeedNewLine: boolean, isRoot: boolean = true): RuleStackItem {\r\n        // ã€ç¬¬ 1 æ­¥ã€‘è¯»å–ç¼“å­˜çš„è§„åˆ™æˆ– Token\r\n        const cached = this.cacheGet(cacheKey)\r\n        if (!cached) {\r\n            throw new Error('ç³»ç»Ÿé”™è¯¯')\r\n        }\r\n\r\n        // ã€ç¬¬ 2 æ­¥ã€‘å…‹éš†å¹¶æ¨å…¥æ ˆ\r\n        const restoredItem = this.deepCloneRuleStackItem(cached)\r\n\r\n        restoredItem.outputted = false  // æ ‡è®°ä¸ºæœªè¾“å‡º\r\n        restoredItem.isManuallyAdded = true\r\n        restoredItem.shouldBreakLine = false\r\n\r\n        OrBranchNeedNewLine = false\r\n\r\n        const lastRowShouldBreakLine = this.ruleStack[this.ruleStack.length - 1].shouldBreakLine\r\n\r\n        let tempBreakLine = false\r\n        if (isRoot) {\r\n            displayDepth++\r\n            restoredItem.shouldBreakLine = true\r\n        } else if (OrBranchNeedNewLine) {\r\n            displayDepth++\r\n            restoredItem.shouldBreakLine = true\r\n        } else if (restoredItem.tokenExpectName) {\r\n            displayDepth++\r\n            restoredItem.shouldBreakLine = true\r\n        } else if (restoredItem.orBranchInfo && restoredItem.orBranchInfo.isOrEntry && restoredItem.childs.length > 1) {\r\n            displayDepth++\r\n            restoredItem.shouldBreakLine = true\r\n            OrBranchNeedNewLine = true\r\n        } else if (['UpdateExpression'].indexOf(restoredItem.ruleName) > -1) {\r\n            displayDepth++\r\n            restoredItem.shouldBreakLine = true\r\n        } else if (lastRowShouldBreakLine) {\r\n            //å¦‚æœä¸ºæŠ˜å é“¾çš„å¼€å¤´åˆ™+1\r\n            displayDepth++\r\n            tempBreakLine = true\r\n        }\r\n\r\n        restoredItem.displayDepth = displayDepth\r\n\r\n\r\n        if (OrBranchNeedNewLine && restoredItem.orBranchInfo) {\r\n            OrBranchNeedNewLine = restoredItem.orBranchInfo.isOrBranch || false\r\n        }\r\n\r\n\r\n        let childBeginIndex = this.ruleStack.push(restoredItem)\r\n\r\n\r\n        // ã€ç¬¬ 4 æ­¥ã€‘é€’å½’æ¢å¤å­èŠ‚ç‚¹ï¼Œä¼ é€’å½“å‰èŠ‚ç‚¹çš„ displayDepth\r\n        if (cached.childs) {\r\n            let i = 0\r\n            for (const childKey of cached.childs) {\r\n                const nextItem = this.restoreFromCacheAndPushAndPrint(childKey, displayDepth, OrBranchNeedNewLine, false)\r\n                //ä¸ä¸ºæ ¹èŠ‚ç‚¹ï¼Œä¸”ä¸Šä¸€è¡Œä¸ºæ¢è¡Œï¼Œä¸”å½“ä¸æ¢è¡Œï¼Œä¸”ä¸‹ä¸€ä¸ªæ¢è¡Œï¼Œåˆ™æ›´æ”¹æœ¬è¡Œä¸ºæ¢è¡Œï¼Œåˆ é™¤ä¸Šæ¬¡è°ƒç”¨ï¼Œé‡æ–°æ‰§è¡Œè°ƒç”¨é€»è¾‘ï¼Œå¹¶ä¸”é‡æ–°è°ƒç”¨\r\n                if (!isRoot && i === 0 && lastRowShouldBreakLine && !restoredItem.shouldBreakLine && nextItem.shouldBreakLine) {\r\n                    this.ruleStack.splice(childBeginIndex)\r\n                    //å¦‚æœä¸ºæ–­é“¾å¤´ï¼Œåˆ™å·²ç»åŠ è¿‡äº†ï¼Œæ— éœ€é‡å¤å¢åŠ \r\n                    if (!tempBreakLine) {\r\n                        displayDepth++\r\n                    }\r\n                    restoredItem.shouldBreakLine = true\r\n                    restoredItem.displayDepth = displayDepth\r\n                    this.restoreFromCacheAndPushAndPrint(childKey, displayDepth, OrBranchNeedNewLine, false)\r\n                }\r\n                i++\r\n            }\r\n        }\r\n\r\n        // ã€ç¬¬ 5 æ­¥ã€‘å¦‚æœæ˜¯æ ¹è§„åˆ™ï¼Œè§¦å‘æ—¥å¿—è¾“å‡ºï¼ˆç¼“å­˜åœºæ™¯ï¼‰\r\n        // å¦‚æœä¸æ˜¯æ ¹ï¼Œpop æ‰è‡ªå·±\r\n        if (isRoot) {\r\n            SubhutiDebugRuleTracePrint.flushPendingOutputs_Cache_Impl(this.ruleStack)\r\n            this.ruleStack.splice(childBeginIndex)\r\n        }\r\n\r\n        return restoredItem\r\n    }\r\n\r\n\r\n    // ========================================\r\n    // è¿‡ç¨‹è¿½è¸ªæ–¹æ³•\r\n    // ========================================\r\n\r\n    // openDebugLogCache = false\r\n    openDebugLogCache = true\r\n\r\n    /**\r\n     * è§„åˆ™è¿›å…¥äº‹ä»¶å¤„ç†å™¨ - ç«‹å³å»ºç«‹çˆ¶å­å…³ç³»ç‰ˆæœ¬\r\n     *\r\n     * æµç¨‹ï¼š\r\n     * 1. æ£€æŸ¥ç¼“å­˜å‘½ä¸­ï¼ˆç¼“å­˜å‘½ä¸­ç›´æ¥å›æ”¾ï¼‰\r\n     * 2. ä»æ ˆé¡¶è·å–çˆ¶èŠ‚ç‚¹ï¼ˆä¸Šä¸€è¡Œï¼‰\r\n     * 3. ç«‹å³å»ºç«‹çˆ¶â†’å­å…³ç³»\r\n     * 4. è®°å½•å½“å‰è§„åˆ™åˆ°ç¼“å­˜\r\n     * 5. æ¨å…¥æ ˆ\r\n     *\r\n     * @param ruleName - è§„åˆ™åç§°\r\n     * @param tokenIndex - è§„åˆ™è¿›å…¥æ—¶çš„ token ç´¢å¼•\r\n     */\r\n    onRuleEnter(ruleName: string, tokenIndex: number): number {\r\n        // è®°å½•å¼€å§‹æ—¶é—´ï¼Œç”¨äºæ€§èƒ½ç»Ÿè®¡\r\n        const startTime = performance.now()\r\n\r\n        // ============================================\r\n        // æ€§èƒ½ç»Ÿè®¡ï¼šè®°å½•è§„åˆ™è¢«è°ƒç”¨\r\n        // ============================================\r\n        let stat = this.stats.get(ruleName)\r\n        if (!stat) {\r\n            // ã€é¦–æ¬¡è°ƒç”¨æ­¤è§„åˆ™ã€‘åˆå§‹åŒ–ç»Ÿè®¡ä¿¡æ¯\r\n            stat = {\r\n                ruleName,\r\n                totalCalls: 0,\r\n                actualExecutions: 0,\r\n                cacheHits: 0,\r\n                totalTime: 0,\r\n                executionTime: 0,\r\n                avgTime: 0\r\n            }\r\n            this.stats.set(ruleName, stat)\r\n        }\r\n        // ç´¯åŠ æ€»è°ƒç”¨æ¬¡æ•°\r\n        stat.totalCalls++\r\n\r\n        // åˆ›å»ºå½“å‰è§„åˆ™çš„æ ˆé¡¹\r\n        const ruleItem: RuleStackItem = {\r\n            ruleName,\r\n            // è®°å½•è§„åˆ™è¿›å…¥æ—¶çš„ tokenIndexï¼Œç”¨äºç¼“å­˜é”®å”¯ä¸€æ ‡è¯†\r\n            tokenIndex,\r\n            startTime,\r\n            outputted: false,\r\n            childs: []\r\n        }\r\n\r\n        if (this.openDebugLogCache) {\r\n            // ç”Ÿæˆå½“å‰è§„åˆ™çš„ç¼“å­˜é”®ï¼ˆruleName:tokenIndex:orInfoï¼‰\r\n            const cacheKey = this.generateCacheKey(ruleItem)\r\n\r\n            // å°è¯•ä»ç¼“å­˜ä¸­è·å–è¯¥è§„åˆ™çš„å†å²æ‰§è¡Œæ•°æ®\r\n            const RuleStackItem = this.cacheGet(cacheKey)\r\n\r\n            // ã€ç¼“å­˜å‘½ä¸­ã€‘å¦‚æœä¹‹å‰å·²ç»æ‰§è¡Œè¿‡ç›¸åŒä½ç½®çš„è§„åˆ™ï¼Œç›´æ¥å›æ”¾\r\n            if (RuleStackItem) {\r\n                let depth = SubhutiDebugRuleTracePrint.flushPendingOutputs_NonCache_Impl(this.ruleStack)\r\n                // å°†å†å²æ‰§è¡Œè·¯å¾„æ¢å¤åˆ°æ ˆä¸­ï¼ˆåŒ…æ‹¬å­è§„åˆ™å’Œ Token æ¶ˆè´¹ï¼‰\r\n                this.restoreFromCacheAndPushAndPrint(cacheKey, depth, false)\r\n                // è¿”å›å¼€å§‹æ—¶é—´ç”¨äºæ€§èƒ½ç»Ÿè®¡\r\n                return startTime\r\n            }\r\n        }\r\n\r\n        // ã€ç¼“å­˜æœªå‘½ä¸­ã€‘è¿›å…¥æ–°çš„è§„åˆ™æ‰§è¡Œæµç¨‹\r\n\r\n        // ============================================\r\n        // ã€ç¬¬ä¸€æ­¥ã€‘æ¨å…¥æ ˆï¼Œæ ‡è®°è§„åˆ™å·²è¿›å…¥æ‰§è¡Œ\r\n        // ============================================\r\n        // æ­¤æ—¶ä¸è®°å½•ç¼“å­˜ï¼Œç­‰åˆ° onRuleExit æ—¶è§„åˆ™å®Œå…¨æ‰§è¡Œåå†è®°å½•\r\n        this.ruleStack.push(ruleItem)\r\n\r\n\r\n        // è¿”å›å¼€å§‹æ—¶é—´ï¼Œä¾› onRuleExit() è®¡ç®—è€—æ—¶\r\n        return startTime\r\n    }\r\n\r\n    onRuleExit(\r\n        ruleName: string,\r\n        cacheHit: boolean,\r\n        startTime?: number\r\n    ): void {\r\n        let duration = 0\r\n        if (startTime !== undefined && typeof startTime === 'number') {\r\n            duration = performance.now() - startTime\r\n        }\r\n\r\n        // éªŒè¯æ ˆé¡¶å¹¶è·å–è¦é€€å‡ºçš„è§„åˆ™\r\n        if (this.ruleStack.length === 0) {\r\n            throw new Error(`âŒ Rule exit error: ruleStack is empty when exiting ${ruleName}`)\r\n        }\r\n        const curRule = this.ruleStack.pop()\r\n\r\n        // å¿«é€Ÿå¤±è´¥ï¼šæ ˆé¡¶å¿…é¡»æ˜¯è¦é€€å‡ºçš„è§„åˆ™\r\n        if (!curRule || curRule.ruleName !== ruleName) {\r\n            throw new Error(\r\n                `âŒ Rule exit mismatch: expected ${ruleName} at top, got ${curRule?.ruleName || 'undefined'}`\r\n            )\r\n        }\r\n\r\n        // ============================================\r\n        // æ€§èƒ½ç»Ÿè®¡ï¼šè®°å½•è§„åˆ™æ‰§è¡Œæ•°æ®\r\n        // ============================================\r\n        const stat = this.stats.get(ruleName)\r\n        if (stat) {\r\n            stat.totalTime += duration\r\n\r\n            if (cacheHit) {\r\n                stat.cacheHits++\r\n            } else {\r\n                stat.actualExecutions++\r\n                stat.executionTime += duration\r\n\r\n                if (stat.actualExecutions > 0) {\r\n                    stat.avgTime = stat.executionTime / stat.actualExecutions\r\n                }\r\n            }\r\n        }\r\n\r\n        // å¦‚æœè§„åˆ™æ²¡æœ‰è¢«è¾“å‡ºï¼Œè¯´æ˜å®ƒæ²¡æœ‰æ¶ˆè´¹ Tokenï¼Œä¸åº”è¯¥è¢«è®°å½•åˆ°ç¼“å­˜\r\n        if (!curRule.outputted) {\r\n            return\r\n        }\r\n\r\n        // ç”Ÿæˆè§„åˆ™çš„ç¼“å­˜ key\r\n        const cacheKey = this.generateCacheKey(curRule)\r\n\r\n        // è·å–çˆ¶è§„åˆ™\r\n        // æ³¨æ„ï¼šå½“å‰è§„åˆ™å·²ç»è¢« pop æ‰äº†ï¼Œæ‰€ä»¥æ ˆé¡¶å°±æ˜¯çˆ¶èŠ‚ç‚¹\r\n        const parentItem = this.ruleStack[this.ruleStack.length - 1]\r\n\r\n        // ã€1ã€‘å¦‚æœæœ‰çˆ¶è§„åˆ™ï¼Œå°†å½“å‰è§„åˆ™åŠ å…¥åˆ°çˆ¶è§„åˆ™çš„ childs\r\n        if (parentItem) {\r\n            // å¿«é€Ÿå¤±è´¥ï¼šçˆ¶è§„åˆ™å¿…é¡»æœ‰ childs æ•°ç»„\r\n            if (!parentItem.childs) {\r\n                throw new Error(\r\n                    `âŒ Parent rule ${parentItem.ruleName} does not have childs array when exiting rule ${ruleName}`\r\n                )\r\n            }\r\n\r\n            // å¿«é€Ÿå¤±è´¥ï¼šå½“å‰è§„åˆ™ä¸åº”è¯¥é‡å¤æ·»åŠ \r\n            // æ³¨æ„ï¼šè¿™ä¸ªæ£€æŸ¥ç°åœ¨æ˜¯é’ˆå¯¹ Or åˆ†æ”¯èŠ‚ç‚¹çš„ï¼Œæ‰€ä»¥åŒä¸€è§„åˆ™å¯ä»¥åœ¨ä¸åŒåˆ†æ”¯ä¸­å‡ºç°\r\n            if (parentItem.childs.some(key => key === cacheKey)) {\r\n                console.log(`  âŒ é‡å¤æ£€æµ‹ï¼šè§„åˆ™ ${ruleName} å·²å­˜åœ¨äºçˆ¶èŠ‚ç‚¹çš„ childs ä¸­`)\r\n                console.log(`  çˆ¶èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹é”®:`)\r\n                parentItem.childs.forEach((key, idx) => {\r\n                    console.log(`    [${idx}] ${key}`)\r\n                })\r\n                throw new Error(\r\n                    `âŒ Rule ${ruleName} already exists in parent rule ${parentItem.ruleName}'s childs`\r\n                )\r\n            }\r\n\r\n            // å°†å½“å‰è§„åˆ™ key è¿½åŠ åˆ°çˆ¶è§„åˆ™çš„ childs\r\n            this.parentPushChild(parentItem, cacheKey)\r\n        }\r\n\r\n        const cacheCurRule = this.cacheGet(cacheKey)\r\n\r\n        // ã€2ã€‘å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œå°†è§„åˆ™å­˜å…¥ç¼“å­˜\r\n        if (!cacheCurRule) {\r\n            const cloned = this.deepCloneRuleStackItem(curRule)\r\n            this.cacheSet(cacheKey, cloned)\r\n        }\r\n    }\r\n\r\n    cacheSet(key: string, value: RuleStackItem) {\r\n        if (!value.tokenExpectName) {\r\n            if (!value.childs || value.childs?.length === 0) {\r\n                throw new Error('bugai wei 0')\r\n            }\r\n        }\r\n        this.rulePathCache.set(key, value)\r\n    }\r\n\r\n    cacheGet(key: string) {\r\n        const res = this.rulePathCache.get(key)\r\n        return res\r\n    }\r\n\r\n    onTokenConsume(\r\n        tokenIndex: number,\r\n        tokenValue: string,\r\n        tokenName: string,\r\n        expectName: string,\r\n        success: boolean\r\n    ): void {\r\n        // å¿«é€Ÿå¤±è´¥ï¼šå½“å‰è§„åˆ™æ ˆä¸èƒ½ä¸ºç©º\r\n        if (this.ruleStack.length === 0) {\r\n            throw new Error(`âŒ Token consume error: ruleStack is empty when consuming token ${tokenName}`)\r\n        }\r\n        // è·å–æ ˆé¡¶è§„åˆ™ï¼ˆå½“å‰æ¶ˆè´¹ token çš„è§„åˆ™ï¼‰\r\n        const parentRule = this.ruleStack[this.ruleStack.length - 1]\r\n\r\n        if (!success) {\r\n            //å¦‚æœå¤±è´¥åˆ†æ”¯æ²¡æœ‰æˆåŠŸæ¶ˆè´¹è¿‡tokenï¼Œåˆ™ä¸æ‰§è¡Œ\r\n            if (tokenIndex <= parentRule.tokenIndex) {\r\n                return\r\n            }\r\n        }\r\n\r\n        // åˆ›å»º Token çš„ RuleStackItem å’Œç”Ÿæˆå…¶ key\r\n        const tokenItem = this.createTokenItem(tokenIndex, tokenValue, tokenName, expectName, success)\r\n        const tokenKey = this.generateCacheKey(tokenItem)\r\n\r\n        // æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦å·²æœ‰æ­¤ Token â†’ æ²¡æœ‰åˆ™å­˜å…¥\r\n        if (!this.rulePathCache.has(tokenKey)) {\r\n            this.cacheSet(tokenKey, this.deepCloneRuleStackItem(tokenItem))\r\n        }\r\n\r\n        // å¿«é€Ÿå¤±è´¥ï¼šçˆ¶è§„åˆ™å¿…é¡»æœ‰ childs æ•°ç»„\r\n        if (!parentRule.childs) {\r\n            throw new Error(\r\n                `âŒ Parent rule ${parentRule.ruleName} does not have childs array when consuming token ${tokenName}`\r\n            )\r\n        }\r\n\r\n        // å¿«é€Ÿå¤±è´¥ï¼šToken ä¸åº”è¯¥é‡å¤æ·»åŠ \r\n        if (parentRule.childs.some(key => key === tokenKey)) {\r\n            throw new Error(\r\n                `âŒ Token ${tokenName} already exists in parent rule ${parentRule.ruleName}'s childs`\r\n            )\r\n        }\r\n\r\n        // æ·»åŠ  Token key åˆ°çˆ¶è§„åˆ™çš„ childs\r\n        this.parentPushChild(parentRule, tokenKey)\r\n\r\n        // ã€ç¬¬ 2 æ­¥ã€‘è¾“å‡ºå¾…å¤„ç†çš„è§„åˆ™æ—¥å¿—ï¼ˆéç¼“å­˜åœºæ™¯ï¼‰\r\n        // æ¯æ¬¡ token æ¶ˆè´¹æ—¶éƒ½è°ƒç”¨ï¼Œç¡®ä¿æ—¥å¿—åŠæ—¶è¾“å‡º\r\n        const depth = SubhutiDebugRuleTracePrint.flushPendingOutputs_NonCache_Impl(this.ruleStack)\r\n\r\n        // è·å– token çš„ä½ç½®ä¿¡æ¯ï¼ˆè¡Œåˆ—å·ï¼‰\r\n        const token = this.inputTokens[tokenIndex]\r\n\r\n        let location: string | null = null\r\n\r\n        if (success) {\r\n            if (token) {\r\n                if (token.loc) {\r\n                    // ä½¿ç”¨ token å¯¹è±¡ä¸­çš„ä½ç½®ä¿¡æ¯\r\n                    location = TreeFormatHelper.formatLocation(token.loc)\r\n                } else if (token.rowNum !== undefined && token.columnStartNum !== undefined) {\r\n                    // ä½¿ç”¨è¡Œåˆ—å·æ„é€ ä½ç½®ä¿¡æ¯\r\n                    const row = token.rowNum\r\n                    const start = token.columnStartNum\r\n                    const end = token.columnEndNum ?? start + tokenValue.length - 1\r\n                    location = `[${row}:${start}-${end}]`\r\n                }\r\n            }\r\n        }\r\n\r\n        const tokenStr = SubhutiDebugRuleTracePrint.getPrintToken(tokenItem, location)\r\n        const line = SubhutiDebugRuleTracePrint.formatLine(tokenStr, depth)\r\n        SubhutiDebugRuleTracePrint.consoleLog(line)\r\n    }\r\n\r\n    onOrEnter(\r\n        parentRuleName: string,\r\n        tokenIndex: number\r\n    ): void {\r\n        // è·å–å½“å‰çš„ tokenIndexï¼ˆä»æœ€è¿‘çš„è§„åˆ™èŠ‚ç‚¹è·å–ï¼Œæˆ–ä½¿ç”¨ 0 ä½œä¸ºé»˜è®¤å€¼ï¼‰\r\n\r\n        // ã€è®¡ç®— orIndexã€‘æ£€æŸ¥çˆ¶è§„åˆ™å·²æœ‰å¤šå°‘ä¸ª Or å­èŠ‚ç‚¹\r\n        let orIndex = 0\r\n        if (this.ruleStack.length > 0) {\r\n            const parentRule = this.ruleStack[this.ruleStack.length - 1]\r\n            if (parentRule.childs) {\r\n                // ç»Ÿè®¡çˆ¶è§„åˆ™çš„ childs ä¸­æœ‰å¤šå°‘ä¸ª Or åŒ…è£¹èŠ‚ç‚¹ï¼ˆisOrEntry=trueï¼‰\r\n                for (const childKey of parentRule.childs) {\r\n                    const childItem = this.cacheGet(childKey)\r\n                    if (childItem && childItem.orBranchInfo?.isOrEntry) {\r\n                        orIndex++\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        // åˆ›å»º Or åŒ…è£¹è™šæ‹Ÿè§„åˆ™é¡¹\r\n        // æ³¨æ„ï¼šruleName åªå­˜å‚¨çº¯ç²¹çš„è§„åˆ™åï¼Œä¸åŒ…å«æ˜¾ç¤ºæ ‡è®°\r\n        this.ruleStack.push({\r\n            ruleName: parentRuleName,\r\n            startTime: performance.now(),\r\n            outputted: false,\r\n            //orEntryé»˜è®¤æ¢è¡Œ\r\n            shouldBreakLine: true,\r\n            tokenIndex,\r\n            childs: [],  // åˆå§‹åŒ– childs æ•°ç»„\r\n            orBranchInfo: {\r\n                orIndex,  // ã€æ–°å¢ã€‘è®¾ç½® Or åºå·\r\n                isOrEntry: true,\r\n                isOrBranch: false,\r\n                startTokenIndex: tokenIndex,  // ã€æ–°å¢ã€‘è®°å½•Orå¼€å§‹æ—¶çš„tokenIndex\r\n                branchAttempts: []  // ã€æ–°å¢ã€‘è®°å½•æ‰€æœ‰åˆ†æ”¯å°è¯•\r\n            }\r\n        })\r\n    }\r\n\r\n    onOrExit(\r\n        parentRuleName: string\r\n    ): void {\r\n        // å¿«é€Ÿå¤±è´¥ï¼šè§„åˆ™æ ˆä¸èƒ½ä¸ºç©º\r\n        if (this.ruleStack.length === 0) {\r\n            throw new Error(`âŒ Or exit error: ruleStack is empty when exiting Or for ${parentRuleName}`)\r\n        }\r\n\r\n        const curOrNode = this.ruleStack.pop()\r\n\r\n        // å¿«é€Ÿå¤±è´¥ï¼šæ ˆé¡¶å¿…é¡»æ˜¯è¦é€€å‡ºçš„ Or åŒ…è£¹èŠ‚ç‚¹\r\n        if (!(curOrNode.ruleName === parentRuleName\r\n            && curOrNode.orBranchInfo\r\n            && curOrNode.orBranchInfo.isOrEntry\r\n            && !curOrNode.orBranchInfo.isOrBranch\r\n        )) {\r\n            const orInfo = curOrNode.orBranchInfo\r\n                ? `(entry=${curOrNode.orBranchInfo.isOrEntry}, branch=${curOrNode.orBranchInfo.isOrBranch})`\r\n                : '(no orBranchInfo)'\r\n            throw new Error(`âŒ Or exit mismatch: expected ${parentRuleName}(OrEntry) at top, got ${curOrNode.ruleName}${orInfo}`)\r\n        }\r\n\r\n        // å¦‚æœ Or åŒ…è£¹èŠ‚ç‚¹æ²¡æœ‰è¢«è¾“å‡ºï¼Œè¯´æ˜å®ƒæ²¡æœ‰æ¶ˆè´¹ Tokenï¼Œä¸åº”è¯¥è¢«è®°å½•åˆ°ç¼“å­˜\r\n        if (!curOrNode.outputted) {\r\n            return\r\n        }\r\n\r\n        // ç”Ÿæˆ Or åŒ…è£¹èŠ‚ç‚¹çš„ç¼“å­˜ key\r\n        const cacheKey = this.generateCacheKey(curOrNode)\r\n\r\n        // è·å–çˆ¶è§„åˆ™\r\n        const parentItem = this.ruleStack[this.ruleStack.length - 1]\r\n\r\n        // ã€1ã€‘å¦‚æœæœ‰çˆ¶è§„åˆ™ï¼Œå°† Or åŒ…è£¹èŠ‚ç‚¹åŠ å…¥åˆ°çˆ¶è§„åˆ™çš„ childs\r\n        if (parentItem) {\r\n            // å¿«é€Ÿå¤±è´¥ï¼šçˆ¶è§„åˆ™å¿…é¡»æœ‰ childs æ•°ç»„\r\n            if (!parentItem.childs) {\r\n                throw new Error(\r\n                    `âŒ Parent rule ${parentItem.ruleName} does not have childs array when exiting Or ${parentRuleName}`\r\n                )\r\n            }\r\n\r\n            // å¿«é€Ÿå¤±è´¥ï¼šOr åŒ…è£¹èŠ‚ç‚¹ä¸åº”è¯¥é‡å¤æ·»åŠ \r\n            if (parentItem.childs.some(key => key === cacheKey)) {\r\n                throw new Error(\r\n                    `âŒ ${cacheKey} Or ${parentRuleName} already exists in parent rule ${parentItem.ruleName}'s childs`\r\n                )\r\n            }\r\n\r\n            // å°† Or åŒ…è£¹èŠ‚ç‚¹ key è¿½åŠ åˆ°çˆ¶è§„åˆ™çš„ childs\r\n            this.parentPushChild(parentItem, cacheKey)\r\n        }\r\n\r\n        // ã€2ã€‘æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦å·²æœ‰æ­¤ Or åŒ…è£¹èŠ‚ç‚¹ â†’ æ²¡æœ‰åˆ™å­˜å…¥\r\n        const cachedOrNode = this.cacheGet(cacheKey)\r\n        if (!cachedOrNode) {\r\n            const cloned = this.deepCloneRuleStackItem(curOrNode)\r\n            this.cacheSet(cacheKey, cloned)\r\n        }\r\n    }\r\n\r\n    onOrBranch(\r\n        branchIndex: number,\r\n        totalBranches: number,\r\n        parentRuleName: string\r\n    ): void {\r\n        // ğŸ” è°ƒè¯•ï¼šæ‰“å°è°ƒç”¨ä¿¡æ¯\r\n\r\n        // è·å–å½“å‰çš„ tokenIndexï¼ˆä»æœ€è¿‘çš„è§„åˆ™èŠ‚ç‚¹è·å–ï¼Œæˆ–ä½¿ç”¨ 0 ä½œä¸ºé»˜è®¤å€¼ï¼‰\r\n        const tokenIndex = this.ruleStack.length > 0\r\n            ? (this.ruleStack[this.ruleStack.length - 1]?.tokenIndex ?? 0)\r\n            : 0\r\n\r\n        // ã€ç»§æ‰¿ orIndexã€‘ä»çˆ¶ Or åŒ…è£¹èŠ‚ç‚¹è·å– orIndex\r\n        let orIndex: number | undefined = undefined\r\n        if (this.ruleStack.length > 0) {\r\n            const parentOrEntry = this.ruleStack[this.ruleStack.length - 1]\r\n            if (parentOrEntry.orBranchInfo?.isOrEntry) {\r\n                orIndex = parentOrEntry.orBranchInfo.orIndex\r\n            }\r\n        }\r\n\r\n        // åˆ›å»ºè™šæ‹Ÿ Or åˆ†æ”¯è§„åˆ™é¡¹ï¼ˆæ¯æ¬¡åˆ†æ”¯å°è¯•éƒ½åˆ›å»ºï¼‰\r\n        // æ³¨æ„ï¼šruleName åªå­˜å‚¨çº¯ç²¹çš„è§„åˆ™åï¼Œä¸åŒ…å«æ˜¾ç¤ºæ ‡è®°\r\n        this.ruleStack.push({\r\n            ruleName: parentRuleName,\r\n            startTime: performance.now(),\r\n            outputted: false,\r\n            tokenIndex,\r\n            childs: [],  // åˆå§‹åŒ– childs æ•°ç»„\r\n            orBranchInfo: {\r\n                orIndex,              // ã€æ–°å¢ã€‘ç»§æ‰¿çˆ¶ Or åŒ…è£¹èŠ‚ç‚¹çš„ orIndex\r\n                isOrEntry: false,     // Or åˆ†æ”¯èŠ‚ç‚¹ä¸æ˜¯ Or åŒ…è£¹èŠ‚ç‚¹\r\n                isOrBranch: true,     // è¿™æ˜¯ Or åˆ†æ”¯èŠ‚ç‚¹\r\n                branchIndex,\r\n                totalBranches\r\n            }\r\n        })\r\n    }\r\n\r\n    onOrBranchExit(\r\n        parentRuleName: string,\r\n        branchIndex: number\r\n    ): void {\r\n        // å¿«é€Ÿå¤±è´¥ï¼šè§„åˆ™æ ˆä¸èƒ½ä¸ºç©º\r\n        if (this.ruleStack.length === 0) {\r\n            throw new Error(`âŒ OrBranch exit error: ruleStack is empty when exiting branch ${branchIndex} for ${parentRuleName}`)\r\n        }\r\n\r\n        // ã€3ã€‘Pop æ ˆé¡¶\r\n        const curBranchNode = this.ruleStack.pop()\r\n\r\n        // å¿«é€Ÿå¤±è´¥ï¼šæ ˆé¡¶å¿…é¡»æ˜¯è¦é€€å‡ºçš„ Or åˆ†æ”¯èŠ‚ç‚¹\r\n        if (!(curBranchNode.ruleName === parentRuleName\r\n            && curBranchNode.orBranchInfo\r\n            && curBranchNode.orBranchInfo.isOrBranch\r\n            && !curBranchNode.orBranchInfo.isOrEntry\r\n            && curBranchNode.orBranchInfo.branchIndex === branchIndex\r\n        )) {\r\n            const info = curBranchNode.orBranchInfo\r\n            const infoStr = info\r\n                ? `(entry=${info.isOrEntry}, branch=${info.isOrBranch}, idx=${info.branchIndex})`\r\n                : '(no orInfo)'\r\n            throw new Error(`âŒ OrBranch exit mismatch: expected ${parentRuleName}(branchIdx=${branchIndex}) at top, got ${curBranchNode.ruleName}${infoStr}`)\r\n        }\r\n\r\n        // å¦‚æœ Or åˆ†æ”¯æ²¡æœ‰è¢«è¾“å‡ºï¼Œè¯´æ˜å®ƒæ²¡æœ‰æ¶ˆè´¹ Tokenï¼Œä¸åº”è¯¥è¢«è®°å½•åˆ°ç¼“å­˜\r\n        if (!curBranchNode.outputted) {\r\n            return\r\n        }\r\n\r\n        // ç”Ÿæˆ Or åˆ†æ”¯èŠ‚ç‚¹çš„ç¼“å­˜ key\r\n        const cacheKey = this.generateCacheKey(curBranchNode)\r\n\r\n        // è·å–çˆ¶èŠ‚ç‚¹ï¼ˆOr åŒ…è£¹èŠ‚ç‚¹ï¼‰\r\n        const parentOrNode = this.ruleStack[this.ruleStack.length - 1]\r\n\r\n        // ã€1ã€‘å¦‚æœæœ‰çˆ¶èŠ‚ç‚¹ï¼Œå°† Or åˆ†æ”¯èŠ‚ç‚¹åŠ å…¥åˆ°çˆ¶èŠ‚ç‚¹çš„ childs\r\n        if (parentOrNode) {\r\n            // å¿«é€Ÿå¤±è´¥ï¼šçˆ¶èŠ‚ç‚¹å¿…é¡»æœ‰ childs æ•°ç»„\r\n            if (!parentOrNode.childs) {\r\n                throw new Error(\r\n                    `âŒ Parent Or node ${parentOrNode.ruleName} does not have childs array when exiting branch ${branchIndex}`\r\n                )\r\n            }\r\n\r\n            // å¿«é€Ÿå¤±è´¥ï¼šOr åˆ†æ”¯èŠ‚ç‚¹ä¸åº”è¯¥é‡å¤æ·»åŠ \r\n            if (parentOrNode.childs.some(key => key === cacheKey)) {\r\n                throw new Error(\r\n                    `âŒ OrBranch ${branchIndex} already exists in parent Or node ${parentOrNode.ruleName}'s childs`\r\n                )\r\n            }\r\n\r\n            // å°† Or åˆ†æ”¯èŠ‚ç‚¹ key è¿½åŠ åˆ°çˆ¶èŠ‚ç‚¹çš„ childs\r\n            this.parentPushChild(parentOrNode, cacheKey)\r\n        }\r\n\r\n        // ã€2ã€‘æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦å·²æœ‰æ­¤ Or åˆ†æ”¯èŠ‚ç‚¹ â†’ æ²¡æœ‰åˆ™å­˜å…¥\r\n        const cachedBranchNode = this.cacheGet(cacheKey)\r\n        if (!cachedBranchNode) {\r\n            const cloned = this.deepCloneRuleStackItem(curBranchNode)\r\n            this.cacheSet(cacheKey, cloned)\r\n        }\r\n    }\r\n\r\n    onBacktrack(\r\n        fromTokenIndex: number,\r\n        toTokenIndex: number\r\n    ): void {\r\n        // ä¸è¾“å‡ºæ­£å¸¸å›æº¯ï¼ˆåªåœ¨çœŸæ­£å‡ºé”™æ—¶æ‰éœ€è¦ï¼‰\r\n    }\r\n\r\n    // ========================================\r\n    // CST éªŒè¯æ–¹æ³•ï¼ˆè°ƒç”¨ SubhutiDebugUtilsï¼‰\r\n    // ========================================\r\n\r\n    /**\r\n     * æ”¶é›†æ‰€æœ‰ token å€¼ï¼ˆå†…éƒ¨è°ƒç”¨ SubhutiDebugUtilsï¼‰\r\n     */\r\n    private collectTokenValues(node: SubhutiCst): string[] {\r\n        return SubhutiDebugUtils.collectTokens(node)\r\n    }\r\n\r\n    /**\r\n     * æ£€æŸ¥ Token å®Œæ•´æ€§ï¼ˆå†…éƒ¨è°ƒç”¨ SubhutiDebugUtilsï¼‰\r\n     */\r\n    private checkTokenCompleteness(cst: SubhutiCst): {\r\n        input: string[]\r\n        cst: string[]\r\n        missing: string[]\r\n    } {\r\n        const result = SubhutiDebugUtils.validateTokenCompleteness(cst, this.inputTokens)\r\n        return {\r\n            input: result.inputTokens,\r\n            cst: result.cstTokens,\r\n            missing: result.missing\r\n        }\r\n    }\r\n\r\n    /**\r\n     * éªŒè¯ CST ç»“æ„å®Œæ•´æ€§ï¼ˆå†…éƒ¨è°ƒç”¨ SubhutiDebugUtilsï¼‰\r\n     */\r\n    private validateStructure(node: any, path: string = 'root'): Array<{ path: string, issue: string, node?: any }> {\r\n        return SubhutiDebugUtils.validateStructure(node, path)\r\n    }\r\n\r\n    /**\r\n     * è·å– CST ç»Ÿè®¡ä¿¡æ¯ï¼ˆå†…éƒ¨è°ƒç”¨ SubhutiDebugUtilsï¼‰\r\n     */\r\n    private getCSTStatistics(node: any): {\r\n        totalNodes: number\r\n        leafNodes: number\r\n        maxDepth: number\r\n        nodeTypes: Map<string, number>\r\n    } {\r\n        return SubhutiDebugUtils.getCSTStatistics(node)\r\n    }\r\n\r\n    // ========================================\r\n    // å‘åå…¼å®¹ - é™æ€æ–¹æ³•åˆ«å\r\n    // ========================================\r\n\r\n    /**\r\n     * @deprecated è¯·ä½¿ç”¨ SubhutiDebugUtils.collectTokens()\r\n     */\r\n    static collectTokens = SubhutiDebugUtils.collectTokens\r\n\r\n    /**\r\n     * @deprecated è¯·ä½¿ç”¨ SubhutiDebugUtils.validateTokenCompleteness()\r\n     */\r\n    static validateTokenCompleteness = SubhutiDebugUtils.validateTokenCompleteness\r\n\r\n    // ========================================\r\n    // æ€§èƒ½ç»Ÿè®¡è¾“å‡º\r\n    // ========================================\r\n\r\n    /**\r\n     * è·å–æ€§èƒ½æ‘˜è¦\r\n     */\r\n    private getSummary(): string {\r\n        const allStats = Array.from(this.stats.values())\r\n\r\n        if (allStats.length === 0) {\r\n            return 'ğŸ“Š æ€§èƒ½æ‘˜è¦ï¼šæ— æ•°æ®'\r\n        }\r\n\r\n        // è®¡ç®—æ€»è®¡\r\n        const totalCalls = allStats.reduce((sum, s) => sum + s.totalCalls, 0)\r\n        const totalExecutions = allStats.reduce((sum, s) => sum + s.actualExecutions, 0)\r\n        const totalCacheHits = allStats.reduce((sum, s) => sum + s.cacheHits, 0)\r\n        const totalTime = allStats.reduce((sum, s) => sum + s.totalTime, 0)\r\n        const cacheHitRate = totalCalls > 0 ? (totalCacheHits / totalCalls * 100).toFixed(1) : '0.0'\r\n\r\n        const lines: string[] = []\r\n        lines.push('â±ï¸  æ€§èƒ½æ‘˜è¦')\r\n        lines.push('â”€'.repeat(40))\r\n        lines.push(`æ€»è€—æ—¶: ${totalTime.toFixed(2)}ms`)\r\n        lines.push(`æ€»è°ƒç”¨: ${totalCalls.toLocaleString()} æ¬¡`)\r\n        lines.push(`å®é™…æ‰§è¡Œ: ${totalExecutions.toLocaleString()} æ¬¡`)\r\n        lines.push(`ç¼“å­˜å‘½ä¸­: ${totalCacheHits.toLocaleString()} æ¬¡ (${cacheHitRate}%)`)\r\n        lines.push('')\r\n\r\n        // Top 5 æ…¢è§„åˆ™ï¼ˆç®€åŒ–ç‰ˆï¼Œæ— è¡¨æ ¼è¾¹æ¡†ï¼‰\r\n        const top5 = allStats\r\n            .filter(s => s.actualExecutions > 0)\r\n            .sort((a, b) => b.executionTime - a.executionTime)\r\n            .slice(0, 5)\r\n\r\n        if (top5.length > 0) {\r\n            lines.push('Top 5 æ…¢è§„åˆ™:')\r\n            top5.forEach((stat, i) => {\r\n                const avgUs = (stat.avgTime * 1000).toFixed(1)\r\n                lines.push(\r\n                    `  ${i + 1}. ${stat.ruleName}: ${stat.executionTime.toFixed(2)}ms ` +\r\n                    `(${stat.totalCalls}æ¬¡, å¹³å‡${avgUs}Î¼s)`\r\n                )\r\n            })\r\n        }\r\n\r\n        return lines.join('\\n')\r\n    }\r\n\r\n    // ========================================\r\n    // CST ç›¸å…³æ–¹æ³•\r\n    // ========================================\r\n\r\n    /**\r\n     * è®¾ç½®è¦å±•ç¤ºçš„ CSTï¼ˆç”± Parser åœ¨è§£æå®Œæˆåè°ƒç”¨ï¼‰\r\n     */\r\n    setCst(cst: SubhutiCst | undefined): void {\r\n        this.topLevelCst = cst || null\r\n    }\r\n\r\n    parentPushChild(parent: RuleStackItem, child: string) {\r\n        parent.childs.push(child)\r\n    }\r\n\r\n    // ========================================\r\n    // è‡ªåŠ¨è¾“å‡ºï¼ˆç”± Parser åœ¨é¡¶å±‚è§„åˆ™å®Œæˆæ—¶è°ƒç”¨ï¼‰\r\n    // ========================================\r\n    /**\r\n     * è‡ªåŠ¨è¾“å‡ºå®Œæ•´è°ƒè¯•æŠ¥å‘Š\r\n     */\r\n    autoOutput(): void {\r\n        console.log('\\n' + '='.repeat(60))\r\n        console.log('ğŸ” Subhuti Debug è¾“å‡º')\r\n        console.log('='.repeat(60))\r\n\r\n        // ========================================\r\n        // ç¬¬ä¸€éƒ¨åˆ†ï¼šæ€§èƒ½æ‘˜è¦\r\n        // ========================================\r\n        console.log('\\nã€ç¬¬ä¸€éƒ¨åˆ†ï¼šæ€§èƒ½æ‘˜è¦ã€‘')\r\n        console.log('â”€'.repeat(60))\r\n        console.log('\\n' + this.getSummary())\r\n\r\n        // æ‰€æœ‰è§„åˆ™è¯¦ç»†ç»Ÿè®¡\r\n        console.log('\\nğŸ“‹ æ‰€æœ‰è§„åˆ™è¯¦ç»†ç»Ÿè®¡:')\r\n        const allStats = Array.from(this.stats.values())\r\n            .sort((a, b) => b.executionTime - a.executionTime)\r\n\r\n        allStats.forEach((stat) => {\r\n            const cacheRate = stat.totalCalls > 0\r\n                ? (stat.cacheHits / stat.totalCalls * 100).toFixed(1)\r\n                : '0.0'\r\n            console.log(\r\n                `  ${stat.ruleName}: ${stat.totalCalls}æ¬¡ | ` +\r\n                `æ‰§è¡Œ${stat.actualExecutions}æ¬¡ | ` +\r\n                `è€—æ—¶${stat.executionTime.toFixed(2)}ms | ` +\r\n                `ç¼“å­˜${cacheRate}%`\r\n            )\r\n        })\r\n\r\n        console.log('\\n' + '='.repeat(60))\r\n\r\n        // ========================================\r\n        // ç¬¬äºŒéƒ¨åˆ†ï¼šCST éªŒè¯æŠ¥å‘Š\r\n        // ========================================\r\n        if (this.topLevelCst) {\r\n            console.log('\\nã€ç¬¬äºŒéƒ¨åˆ†ï¼šCST éªŒè¯æŠ¥å‘Šã€‘')\r\n            console.log('â”€'.repeat(60))\r\n            console.log('\\nğŸ” CST éªŒè¯æŠ¥å‘Š')\r\n            console.log('â”€'.repeat(60))\r\n\r\n            // 2.1 ç»“æ„éªŒè¯\r\n            const structureErrors = this.validateStructure(this.topLevelCst)\r\n            console.log(`\\nğŸ“Œ ç»“æ„å®Œæ•´æ€§: ${structureErrors.length === 0 ? 'âœ…' : 'âŒ'}`)\r\n\r\n            if (structureErrors.length > 0) {\r\n                console.log(`   å‘ç° ${structureErrors.length} ä¸ªé”™è¯¯:`)\r\n                structureErrors.forEach((err, i) => {\r\n                    console.log(`\\n   [${i + 1}] ${err.path}`)\r\n                    console.log(`       é—®é¢˜: ${err.issue}`)\r\n                    if (err.node) {\r\n                        const nodeStr = JSON.stringify(err.node, null, 2)\r\n                            .split('\\n')\r\n                            .map(line => `       ${line}`)\r\n                            .join('\\n')\r\n                        console.log(nodeStr)\r\n                    }\r\n                })\r\n            } else {\r\n                console.log('   æ— ç»“æ„é”™è¯¯')\r\n            }\r\n\r\n            // 2.2 Token å®Œæ•´æ€§\r\n            const tokenResult = this.checkTokenCompleteness(this.topLevelCst)\r\n            console.log(`\\nğŸ“Œ Token å®Œæ•´æ€§: ${tokenResult.missing.length === 0 ? 'âœ…' : 'âŒ'}`)\r\n            console.log(`   è¾“å…¥ tokens: ${tokenResult.input.length} ä¸ª`)\r\n            console.log(`   CST tokens:  ${tokenResult.cst.length} ä¸ª`)\r\n            console.log(`   è¾“å…¥åˆ—è¡¨: [${tokenResult.input.join(', ')}]`)\r\n            console.log(`   CSTåˆ—è¡¨:  [${tokenResult.cst.join(', ')}]`)\r\n\r\n            if (tokenResult.missing.length > 0) {\r\n                console.log(`   âŒ ç¼ºå¤±: [${tokenResult.missing.join(', ')}]`)\r\n            } else {\r\n                console.log(`   âœ… å®Œæ•´ä¿ç•™`)\r\n            }\r\n\r\n            // 2.3 CST ç»Ÿè®¡\r\n            const stats = this.getCSTStatistics(this.topLevelCst)\r\n            console.log(`\\nğŸ“Œ CST ç»Ÿè®¡:`)\r\n            console.log(`   æ€»èŠ‚ç‚¹æ•°: ${stats.totalNodes}`)\r\n            console.log(`   å¶å­èŠ‚ç‚¹: ${stats.leafNodes}`)\r\n            console.log(`   æœ€å¤§æ·±åº¦: ${stats.maxDepth}`)\r\n            console.log(`   èŠ‚ç‚¹ç±»å‹: ${stats.nodeTypes.size} ç§`)\r\n\r\n            // èŠ‚ç‚¹ç±»å‹åˆ†å¸ƒ\r\n            console.log(`\\n   èŠ‚ç‚¹ç±»å‹åˆ†å¸ƒ:`)\r\n            const sortedTypes = Array.from(stats.nodeTypes.entries())\r\n                .sort((a, b) => b[1] - a[1])\r\n            sortedTypes.forEach(([name, count]) => {\r\n                console.log(`     ${name}: ${count}`)\r\n            })\r\n\r\n            console.log('â”€'.repeat(60))\r\n\r\n            // ========================================\r\n            // ç¬¬ä¸‰éƒ¨åˆ†ï¼šCST å¯è§†åŒ–\r\n            // ========================================\r\n            console.log('\\nã€ç¬¬ä¸‰éƒ¨åˆ†ï¼šCST å¯è§†åŒ–ã€‘')\r\n            console.log('â”€'.repeat(60))\r\n            console.log('\\nğŸ“Š CST ç»“æ„')\r\n            console.log('â”€'.repeat(60))\r\n            console.log(SubhutiDebugUtils.formatCst(this.topLevelCst))\r\n            console.log('â”€'.repeat(60))\r\n        }\r\n\r\n        console.log('\\n' + '='.repeat(60))\r\n        console.log('ğŸ‰ Debug è¾“å‡ºå®Œæˆ')\r\n        console.log('='.repeat(60))\r\n    }\r\n}\r\n\r\n// ============================================\r\n// å¯¼å‡º\r\n// ============================================\r\n\r\n","/**\r\n * Subhuti SubhutiPackratCache Cache - é«˜æ€§èƒ½ SubhutiPackratCache Parsing ç¼“å­˜ç³»ç»Ÿ\r\n *\r\n * åŒ…å«ï¼š\r\n * - SubhutiPackratCache: é›†æˆ LRU ç¼“å­˜ + ç»Ÿè®¡ + åˆ†æ\r\n *\r\n * @version 4.0.0 - ä½¿ç”¨ lru-cache å¼€æºåº“æ›¿ä»£æ‰‹å†™å®ç°\r\n * @date 2025-11-04\r\n */\r\n\r\nimport type SubhutiCst from \"./struct/SubhutiCst.ts\";\r\nimport type { ParseRecordNode } from \"./SubhutiParser.ts\";\r\nimport { LRUCache } from \"lru-cache\";\r\n\r\n// ============================================\r\n// [1] SubhutiPackratCache - SubhutiPackratCache Parsingç¼“å­˜ç®¡ç†å™¨ï¼ˆé›†æˆLRUï¼‰\r\n// ============================================\r\n\r\n/**\r\n * SubhutiPackratCache Parsing ç¼“å­˜ç»“æœï¼ˆå®Œæ•´çŠ¶æ€ï¼‰\r\n *\r\n * å…³é”®å­—æ®µï¼š\r\n * - endTokenIndex: è§£æç»“æŸæ—¶çš„ token ç´¢å¼•\r\n * - cst: CST èŠ‚ç‚¹ï¼ˆæˆåŠŸæ—¶æœ‰å€¼ï¼‰\r\n * - parseSuccess: è§£ææ˜¯å¦æˆåŠŸ\r\n * - recordNode: è§£æè®°å½•èŠ‚ç‚¹ï¼ˆå®¹é”™æ¨¡å¼ä¸‹ä½¿ç”¨ï¼‰\r\n * - parsedTokens: æ¶ˆè´¹çš„ token åˆ—è¡¨\r\n */\r\nexport interface SubhutiPackratCacheResult {\r\n    endTokenIndex: number                 // è§£æç»“æŸæ—¶çš„ token ç´¢å¼•\r\n    cst: SubhutiCst                       // CST èŠ‚ç‚¹\r\n    parseSuccess: boolean                 // è§£ææ˜¯å¦æˆåŠŸ\r\n    recordNode?: ParseRecordNode | null   // è§£æè®°å½•èŠ‚ç‚¹ï¼ˆå®¹é”™æ¨¡å¼ï¼‰\r\n    parsedTokens?: any[]                  // æ¶ˆè´¹çš„ token åˆ—è¡¨\r\n}\r\n\r\n/**\r\n * SubhutiPackratCache åŸºç¡€ç»Ÿè®¡å­—æ®µ\r\n * \r\n * ç”¨äº SubhutiPackratCacheStatsReport æ¥å£çš„å­—æ®µå®šä¹‰\r\n */\r\ninterface SubhutiPackratCacheStats {\r\n    hits: number       // ç¼“å­˜å‘½ä¸­æ¬¡æ•°\r\n    misses: number     // ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°\r\n    stores: number     // ç¼“å­˜å­˜å‚¨æ¬¡æ•°\r\n}\r\n\r\n/**\r\n * SubhutiPackratCache ç¼“å­˜ç»Ÿè®¡æŠ¥å‘Šï¼ˆå”¯ä¸€å¯¹å¤–æ¥å£ï¼‰â­\r\n * \r\n * é€šè¿‡ getStatsReport() è·å–ï¼ŒåŒ…å«å®Œæ•´çš„ç¼“å­˜åˆ†ææ•°æ®ï¼š\r\n * \r\n * åŸºç¡€ç»Ÿè®¡ï¼ˆç»§æ‰¿è‡ª SubhutiPackratCacheStatsï¼‰ï¼š\r\n * - hits: ç¼“å­˜å‘½ä¸­æ¬¡æ•°\r\n * - misses: ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°\r\n * - stores: ç¼“å­˜å­˜å‚¨æ¬¡æ•°\r\n * \r\n * è®¡ç®—å­—æ®µï¼š\r\n * - total: æ€»æŸ¥è¯¢æ¬¡æ•°ï¼ˆhits + missesï¼‰\r\n * - hitRate: å‘½ä¸­ç‡ï¼ˆå¦‚ï¼š\"68.5%\"ï¼‰\r\n * \r\n * ç¼“å­˜ä¿¡æ¯ï¼š\r\n * - maxCacheSize: æœ€å¤§å®¹é‡\r\n * - currentSize: å½“å‰å¤§å°\r\n * - usageRate: ä½¿ç”¨ç‡ï¼ˆå¦‚ï¼š\"45.2%\" æˆ– \"unlimited\"ï¼‰\r\n * \r\n * æ€§èƒ½å»ºè®®ï¼š\r\n * - suggestions: æ ¹æ®ç»Ÿè®¡æ•°æ®è‡ªåŠ¨ç”Ÿæˆçš„ä¼˜åŒ–å»ºè®®\r\n */\r\nexport interface SubhutiPackratCacheStatsReport extends SubhutiPackratCacheStats {\r\n    // è®¡ç®—å­—æ®µ\r\n    total: number\r\n    hitRate: string\r\n\r\n    // ç¼“å­˜ä¿¡æ¯\r\n    maxCacheSize: number        // æœ€å¤§å®¹é‡\r\n    currentSize: number         // å½“å‰å¤§å°\r\n    usageRate: string           // ä½¿ç”¨ç‡ï¼ˆå¦‚ï¼š\"45.2%\" æˆ– \"unlimited\"ï¼‰\r\n\r\n    // æ€§èƒ½å»ºè®®\r\n    suggestions: string[]\r\n}\r\n\r\n/**\r\n * Subhuti SubhutiPackratCache Cache - é›†æˆ LRU ç¼“å­˜ + ç»Ÿè®¡çš„ SubhutiPackratCache Parsing ç®¡ç†å™¨ â­â­â­\r\n *\r\n * èŒè´£ï¼š\r\n * - LRU ç¼“å­˜å®ç°ï¼ˆä½¿ç”¨æˆç†Ÿçš„ lru-cache åº“ï¼‰\r\n * - ç»Ÿè®¡ç¼“å­˜å‘½ä¸­ç‡\r\n * - åº”ç”¨å’Œå­˜å‚¨ç¼“å­˜ç»“æœ\r\n * - æä¾›æ€§èƒ½åˆ†æå»ºè®®\r\n *\r\n * è®¾è®¡ç†å¿µï¼š\r\n * - ä½¿ç”¨å¼€æºåº“ï¼šåŸºäº lru-cacheï¼ˆ10k+ starsï¼Œæ¯å‘¨ 4000ä¸‡+ ä¸‹è½½ï¼‰\r\n * - é»˜è®¤æœ€ä¼˜ï¼šLRU(10000) ç”Ÿäº§çº§é…ç½®\r\n * - é›¶é…ç½®ï¼šå¼€ç®±å³ç”¨\r\n * - é«˜æ€§èƒ½ï¼šlru-cache é«˜åº¦ä¼˜åŒ–ï¼Œæ‰€æœ‰æ“ä½œ O(1)\r\n * - é›†æˆç»Ÿè®¡ï¼šhits/misses/stores ä¸ç¼“å­˜æ“ä½œåŸå­åŒ–\r\n *\r\n * ä½¿ç”¨ç¤ºä¾‹ï¼š\r\n * ```typescript\r\n * // é»˜è®¤é…ç½®ï¼ˆæ¨è 99%ï¼‰- LRU(10000)\r\n * const cache = new SubhutiPackratCache()\r\n *\r\n * // è‡ªå®šä¹‰ç¼“å­˜å¤§å°ï¼ˆå¤§æ–‡ä»¶ï¼‰- LRU(50000)\r\n * const cache = new SubhutiPackratCache(50000)\r\n *\r\n * // æ— é™ç¼“å­˜ï¼ˆå°æ–‡ä»¶ + å†…å­˜å……è¶³ï¼‰\r\n * const cache = new SubhutiPackratCache(0)\r\n * ```\r\n *\r\n * æ€§èƒ½ï¼š\r\n * - get: O(1) å¸¸æ•°æ—¶é—´\r\n * - set: O(1) å¸¸æ•°æ—¶é—´\r\n * - ç»Ÿè®¡é›†æˆï¼šé›¶é¢å¤–å¼€é”€\r\n */\r\nexport class SubhutiPackratCache {\r\n    // ========================================\r\n    // LRU ç¼“å­˜å®ç°ï¼ˆä½¿ç”¨ lru-cache å¼€æºåº“ï¼‰\r\n    // ========================================\r\n\r\n    /**\r\n     * ç¼“å­˜ä¸»å­˜å‚¨ï¼ˆä½¿ç”¨ lru-cache åº“ï¼‰\r\n     *\r\n     * ä¼˜åŠ¿ï¼š\r\n     * - æˆç†Ÿç¨³å®šï¼š10+ å¹´ç»´æŠ¤ï¼Œæ¯å‘¨ 4000ä¸‡+ ä¸‹è½½\r\n     * - é«˜åº¦ä¼˜åŒ–ï¼šO(1) æ‰€æœ‰æ“ä½œ\r\n     * - åŠŸèƒ½ä¸°å¯Œï¼šæ”¯æŒ TTLã€dispose å›è°ƒç­‰\r\n     * - TypeScript åŸç”Ÿæ”¯æŒ\r\n     *\r\n     * å¤åˆé”®æ ¼å¼ï¼š`${ruleName}:${tokenIndex}`\r\n     * ç¤ºä¾‹ï¼š\"Expression:5\" â†’ è§„åˆ™Expressionåœ¨ç¬¬5ä¸ªtokenä½ç½®çš„ç¼“å­˜ç»“æœ\r\n     */\r\n    private cache: LRUCache<string, SubhutiPackratCacheResult>\r\n\r\n    /**\r\n     * æœ€å¤§å®¹é‡ï¼ˆ0 è¡¨ç¤ºæ— é™ç¼“å­˜ï¼‰\r\n     */\r\n    private readonly maxSize: number\r\n\r\n    // ========================================\r\n    // ç¼“å­˜ç»Ÿè®¡\r\n    // ========================================\r\n\r\n    /**\r\n     * ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯ï¼ˆå†…éƒ¨å­˜å‚¨ï¼‰\r\n     * \r\n     * ç®€å•å¯¹è±¡å­˜å‚¨ä¸‰ä¸ªè®¡æ•°å™¨ï¼Œæ— éœ€é¢å¤–å°è£…\r\n     */\r\n    private stats = {\r\n        hits: 0,\r\n        misses: 0,\r\n        stores: 0\r\n    }\r\n\r\n    // ========================================\r\n    // æ„é€ å‡½æ•°\r\n    // ========================================\r\n\r\n    /**\r\n     * æ„é€  SubhutiPackratCache Cache\r\n     *\r\n     * ä½¿ç”¨ç¤ºä¾‹ï¼š\r\n     * ```typescript\r\n     * // é»˜è®¤é…ç½®ï¼ˆæ¨è 99%ï¼‰\r\n     * new SubhutiPackratCache()          â†’ LRU(10000)\r\n     *\r\n     * // å¤§æ–‡ä»¶\r\n     * new SubhutiPackratCache(50000)     â†’ LRU(50000)\r\n     *\r\n     * // è¶…å¤§æ–‡ä»¶\r\n     * new SubhutiPackratCache(100000)    â†’ LRU(100000)\r\n     *\r\n     * // æ— é™ç¼“å­˜ï¼ˆå°æ–‡ä»¶ + å†…å­˜å……è¶³ï¼‰\r\n     * new SubhutiPackratCache(0)         â†’ Unlimited\r\n     * ```\r\n     *\r\n     * @param maxSize æœ€å¤§ç¼“å­˜æ¡ç›®æ•°\r\n     *                - 0ï¼šæ— é™ç¼“å­˜ï¼Œæ°¸ä¸æ·˜æ±°\r\n     *                - >0ï¼šå¯ç”¨ LRUï¼Œè¾¾åˆ°ä¸Šé™è‡ªåŠ¨æ·˜æ±°æœ€æ—§æ¡ç›®\r\n     *                - é»˜è®¤ï¼š10000ï¼ˆé€‚ç”¨ 99% åœºæ™¯ï¼‰\r\n     */\r\n    constructor(maxSize = 10000) {\r\n        this.maxSize = maxSize\r\n        \r\n        // åˆå§‹åŒ– lru-cache\r\n        if (maxSize === 0) {\r\n            // æ— é™ç¼“å­˜ï¼šè®¾ç½®ä¸ºæ— ç©·å¤§\r\n            this.cache = new LRUCache<string, SubhutiPackratCacheResult>({\r\n                max: Infinity\r\n            })\r\n        } else {\r\n            // LRU æ¨¡å¼ï¼šè®¾ç½®æœ€å¤§å®¹é‡\r\n            this.cache = new LRUCache<string, SubhutiPackratCacheResult>({\r\n                max: maxSize\r\n            })\r\n        }\r\n    }\r\n\r\n    // ========================================\r\n    // æ ¸å¿ƒç¼“å­˜æ“ä½œï¼ˆé›†æˆ LRU + ç»Ÿè®¡ï¼‰â­â­â­\r\n    // ========================================\r\n\r\n    /**\r\n     * æŸ¥è¯¢ç¼“å­˜ - O(1) â­â­â­\r\n     *\r\n     * é›†æˆåŠŸèƒ½ï¼š\r\n     * - LRU æŸ¥æ‰¾ï¼ˆç”± lru-cache åº“è‡ªåŠ¨å¤„ç†ï¼‰\r\n     * - ç»Ÿè®¡è®°å½•ï¼ˆhits / missesï¼‰\r\n     * - è‡ªåŠ¨æ›´æ–°è®¿é—®é¡ºåºï¼ˆç”± lru-cache åº“è‡ªåŠ¨å¤„ç†ï¼‰\r\n     *\r\n     * @param ruleName è§„åˆ™åç§°\r\n     * @param tokenIndex token ç´¢å¼•\r\n     * @returns ç¼“å­˜ç»“æœï¼Œæœªå‘½ä¸­è¿”å› undefined\r\n     */\r\n    get(ruleName: string, tokenIndex: number): SubhutiPackratCacheResult | undefined {\r\n        const key = `${ruleName}:${tokenIndex}`\r\n        const result = this.cache.get(key)\r\n\r\n        if (result === undefined) {\r\n            this.stats.misses++  // ğŸ‘ˆ ç»Ÿè®¡ï¼šæœªå‘½ä¸­\r\n            return undefined\r\n        }\r\n\r\n        // âœ… å‘½ä¸­\r\n        this.stats.hits++  // ğŸ‘ˆ ç»Ÿè®¡ï¼šå‘½ä¸­\r\n        return result\r\n    }\r\n\r\n    /**\r\n     * å­˜å‚¨ç¼“å­˜ - O(1) â­â­â­\r\n     *\r\n     * é›†æˆåŠŸèƒ½ï¼š\r\n     * - LRU å­˜å‚¨ï¼ˆç”± lru-cache åº“è‡ªåŠ¨å¤„ç†ï¼‰\r\n     * - ç»Ÿè®¡è®°å½•ï¼ˆstoresï¼‰\r\n     * - è‡ªåŠ¨æ·˜æ±°æ—§æ¡ç›®ï¼ˆç”± lru-cache åº“è‡ªåŠ¨å¤„ç†ï¼‰\r\n     *\r\n     * @param ruleName è§„åˆ™åç§°\r\n     * @param tokenIndex token ç´¢å¼•\r\n     * @param result ç¼“å­˜ç»“æœ\r\n     */\r\n    set(ruleName: string, tokenIndex: number, result: SubhutiPackratCacheResult): void {\r\n        const key = `${ruleName}:${tokenIndex}`\r\n        this.stats.stores++\r\n\r\n        // lru-cache è‡ªåŠ¨å¤„ç† LRU é€»è¾‘å’Œå®¹é‡é™åˆ¶\r\n        this.cache.set(key, result)\r\n    }\r\n\r\n    /**\r\n     * æ¸…ç©ºæ‰€æœ‰ç¼“å­˜\r\n     *\r\n     * ä½¿ç”¨åœºæ™¯ï¼š\r\n     * - è§£ææ–°æ–‡ä»¶å‰\r\n     * - æ‰‹åŠ¨æ¸…ç†å†…å­˜\r\n     * - æµ‹è¯•é‡ç½®\r\n     */\r\n    clear(): void {\r\n        this.cache.clear()\r\n\r\n        // é‡ç½®ç»Ÿè®¡\r\n        this.stats.hits = 0\r\n        this.stats.misses = 0\r\n        this.stats.stores = 0\r\n    }\r\n\r\n    /**\r\n     * è·å–ç¼“å­˜çš„æ€»æ¡ç›®æ•°\r\n     */\r\n    get size(): number {\r\n        return this.cache.size\r\n    }\r\n\r\n    // ========================================\r\n    // ç»Ÿè®¡å’Œåˆ†æ\r\n    // ========================================\r\n\r\n    /**\r\n     * è·å–ç¼“å­˜ç»Ÿè®¡æŠ¥å‘Šï¼ˆå”¯ä¸€å¯¹å¤–APIï¼‰â­\r\n     *\r\n     * è¿™æ˜¯è·å–ç»Ÿè®¡ä¿¡æ¯çš„å”¯ä¸€æ–¹æ³•ï¼ŒåŒ…å«å®Œæ•´çš„åˆ†ææ•°æ®ï¼š\r\n     * - åŸºç¡€ç»Ÿè®¡ï¼šhitsã€missesã€storesã€totalã€å‘½ä¸­ç‡\r\n     * - ç¼“å­˜ä¿¡æ¯ï¼šæœ€å¤§å®¹é‡ã€å½“å‰å¤§å°ã€ä½¿ç”¨ç‡\r\n     * - æ€§èƒ½å»ºè®®ï¼šæ ¹æ®æ•°æ®è‡ªåŠ¨ç”Ÿæˆ\r\n     *\r\n     * ä½¿ç”¨ç¤ºä¾‹ï¼š\r\n     * ```typescript\r\n     * const report = cache.getStatsReport()\r\n     * console.log(`å‘½ä¸­ç‡: ${report.hitRate}`)\r\n     * console.log(`å»ºè®®: ${report.suggestions.join(', ')}`)\r\n     * ```\r\n     */\r\n    getStatsReport(): SubhutiPackratCacheStatsReport {\r\n        const total = this.stats.hits + this.stats.misses\r\n        const hitRate = total > 0 ? (this.stats.hits / total * 100).toFixed(1) : '0.0'\r\n        const hitRateNum = parseFloat(hitRate)\r\n\r\n        // è®¡ç®—ä½¿ç”¨ç‡\r\n        const usageRate = this.maxSize > 0\r\n            ? ((this.size / this.maxSize) * 100).toFixed(1) + '%'\r\n            : 'unlimited'\r\n\r\n        // æ€§èƒ½å»ºè®®ï¼ˆæ™ºèƒ½åˆ†æï¼‰\r\n        const suggestions: string[] = []\r\n\r\n        if (hitRateNum >= 70) {\r\n            suggestions.push('âœ… ç¼“å­˜å‘½ä¸­ç‡ä¼˜ç§€ï¼ˆâ‰¥ 70%ï¼‰')\r\n        } else if (hitRateNum >= 50) {\r\n            suggestions.push('âœ… ç¼“å­˜å‘½ä¸­ç‡è‰¯å¥½ï¼ˆ50-70%ï¼‰')\r\n        } else if (hitRateNum >= 30) {\r\n            suggestions.push('âš ï¸ ç¼“å­˜å‘½ä¸­ç‡åä½ï¼ˆ30-50%ï¼‰ï¼Œå¯èƒ½è¯­æ³•å¤æ‚')\r\n        } else {\r\n            suggestions.push('âŒ ç¼“å­˜å‘½ä¸­ç‡ä½ï¼ˆ< 30%ï¼‰ï¼Œå»ºè®®æ£€æŸ¥è¯­æ³•è§„åˆ™')\r\n        }\r\n\r\n        // æ£€æŸ¥ç¼“å­˜ä½¿ç”¨ç‡ï¼ˆåŠ¨æ€é˜ˆå€¼ï¼Œä»… LRU æ¨¡å¼ï¼‰\r\n        if (this.maxSize > 0) {\r\n            const usageRatio = this.size / this.maxSize\r\n\r\n            if (usageRatio > 0.9) {\r\n                suggestions.push('âš ï¸ ç¼“å­˜ä½¿ç”¨ç‡é«˜ï¼ˆ> 90%ï¼‰ï¼Œå»ºè®®å¢åŠ  maxSize')\r\n            } else if (usageRatio > 0.7) {\r\n                suggestions.push('âš ï¸ ç¼“å­˜ä½¿ç”¨ç‡è¾ƒé«˜ï¼ˆ70-90%ï¼‰ï¼Œå¯è€ƒè™‘å¢åŠ  maxSize')\r\n            }\r\n\r\n            // ç¼“å­˜ä½¿ç”¨ç‡ä½ ä¸” æ€»è¯·æ±‚æ•°å¤šï¼ˆè¯´æ˜ç¼“å­˜åˆ†é…è¿‡å¤§ï¼‰\r\n            if (usageRatio < 0.1 && total > 10000) {\r\n                suggestions.push('ğŸ’¡ ç¼“å­˜ä½¿ç”¨ç‡ä½ï¼ˆ< 10%ï¼‰ï¼Œå¯è€ƒè™‘å‡å° maxSize èŠ‚çœå†…å­˜')\r\n            }\r\n        }\r\n\r\n        return {\r\n            // åŸºç¡€ç»Ÿè®¡\r\n            hits: this.stats.hits,\r\n            misses: this.stats.misses,\r\n            stores: this.stats.stores,\r\n            total,\r\n            hitRate: `${hitRate}%`,\r\n\r\n            // ç¼“å­˜ä¿¡æ¯\r\n            maxCacheSize: this.maxSize,\r\n            currentSize: this.size,\r\n            usageRate,\r\n\r\n            // æ€§èƒ½å»ºè®®\r\n            suggestions\r\n        }\r\n    }\r\n\r\n}\r\n","/**\r\n * Subhuti Token Consumer - Token æ¶ˆè´¹æ‰©å±•åŸºç±»\r\n *\r\n * èŒè´£ï¼š\r\n * 1. æä¾›é«˜çº§ token æ¶ˆè´¹æ–¹æ³•\r\n * 2. å°è£… consume è°ƒç”¨ï¼Œé¿å…å­ç±»é‡å¤ä»£ç \r\n * 3. æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰æ‰©å±•\r\n *\r\n * è®¾è®¡æ¨¡å¼ï¼š\r\n * - ç›´æ¥ä¾èµ– SubhutiParser\r\n * - å¯è¢«ç»§æ‰¿ï¼Œæ·»åŠ è‡ªå®šä¹‰æ¶ˆè´¹æ–¹æ³•ï¼ˆå¦‚ Semicolon/Commaï¼‰\r\n *\r\n * @version 3.0.0\r\n */\r\n\r\nimport type SubhutiParser from \"./SubhutiParser.ts\"\r\nimport type SubhutiCst from \"./struct/SubhutiCst.ts\"\r\nimport type {LexicalGoal} from \"./SubhutiLexer.ts\"\r\n\r\nexport default class SubhutiTokenConsumer {\r\n    /**\r\n     * Parser å®ä¾‹\r\n     */\r\n    protected readonly parser: SubhutiParser\r\n\r\n    constructor(parser: SubhutiParser) {\r\n        this.parser = parser\r\n    }\r\n\r\n    // ============================================\r\n    // Token æ¶ˆè´¹åŠŸèƒ½ï¼ˆä¿®æ”¹çŠ¶æ€ï¼‰\r\n    // ============================================\r\n\r\n    /**\r\n     * æ¶ˆè´¹ä¸€ä¸ª tokenï¼ˆä¿®æ”¹ Parser çŠ¶æ€ï¼‰\r\n     * @param tokenName token åç§°ï¼ˆæ¥è‡ª TokenNamesï¼‰\r\n     * @param goal å¯é€‰çš„è¯æ³•ç›®æ ‡ï¼ˆç”¨äºæ¨¡æ¿å°¾éƒ¨ç­‰åœºæ™¯ï¼‰\r\n     */\r\n    protected consume(tokenName: string, goal?: LexicalGoal): SubhutiCst | undefined {\r\n        return this.parser._consumeToken(tokenName, goal)\r\n    }\r\n}\r\n\r\n","import { SubhutiCreateToken } from './struct/SubhutiCreateToken.ts'\r\nimport SubhutiMatchToken from './struct/SubhutiMatchToken.ts'\r\n\r\n/**\r\n * æ­£åˆ™è¡¨è¾¾å¼å­—é¢é‡çš„ patternï¼ˆç”¨äº Parser å±‚çš„ rescanï¼‰\r\n * æ ¹æ® ECMAScript è§„èŒƒï¼ŒRegularExpressionFirstChar ä¸èƒ½æ˜¯ * (é¿å…ä¸ /* æ³¨é‡Šå†²çª)\r\n */\r\nexport const REGEXP_LITERAL_PATTERN = /^\\/(?:[^\\n\\r\\/\\\\[*]|\\\\[^\\n\\r]|\\[(?:[^\\n\\r\\]\\\\]|\\\\[^\\n\\r])*\\])(?:[^\\n\\r\\/\\\\[]|\\\\[^\\n\\r]|\\[(?:[^\\n\\r\\]\\\\]|\\\\[^\\n\\r])*\\])*\\/[dgimsuvy]*/\r\n\r\n/**\r\n * å°è¯•åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼å­—é¢é‡\r\n * ç”¨äº Parser å±‚åœ¨éœ€è¦æ—¶é‡æ–°æ‰«æ Slash ä¸º RegularExpressionLiteral\r\n *\r\n * @param text è¦åŒ¹é…çš„æ–‡æœ¬ï¼ˆåº”ä»¥ / å¼€å¤´ï¼‰\r\n * @returns åŒ¹é…çš„æ­£åˆ™è¡¨è¾¾å¼å­—é¢é‡å­—ç¬¦ä¸²ï¼Œæˆ– null\r\n */\r\nexport function matchRegExpLiteral(text: string): string | null {\r\n    const match = text.match(REGEXP_LITERAL_PATTERN)\r\n    return match ? match[0] : null\r\n}\r\n\r\n/**\r\n * è¯æ³•ç›®æ ‡ï¼ˆå¯¹åº” ECMAScript è§„èŒƒçš„ InputElementï¼‰\r\n */\r\nexport enum LexicalGoal {\r\n    /** InputElementDiv - æœŸæœ›é™¤æ³•è¿ç®—ç¬¦ */\r\n    InputElementDiv = 'InputElementDiv',\r\n    /** InputElementRegExp - æœŸæœ›æ­£åˆ™è¡¨è¾¾å¼ */\r\n    InputElementRegExp = 'InputElementRegExp',\r\n    /** InputElementTemplateTail - æœŸæœ›æ¨¡æ¿å°¾éƒ¨ï¼ˆ} å¼€å¤´çš„æ¨¡æ¿éƒ¨åˆ†ï¼‰ */\r\n    InputElementTemplateTail = 'InputElementTemplateTail',\r\n}\r\n\r\n/**\r\n * Token ç¼“å­˜æ¡ç›®\r\n * å­˜å‚¨è§£æå‡ºçš„ token åŠå…¶åç»­ä½ç½®ä¿¡æ¯\r\n */\r\nexport interface TokenCacheEntry {\r\n    /** è§£æå‡ºçš„ token */\r\n    token: SubhutiMatchToken\r\n    /** token ç»“æŸåçš„ä¸‹ä¸€ä¸ªä½ç½®ï¼ˆè·³è¿‡ç©ºç™½åï¼‰ */\r\n    nextCodeIndex: number\r\n    /** ä¸‹ä¸€ä¸ªä½ç½®çš„è¡Œå· */\r\n    nextLine: number\r\n    /** ä¸‹ä¸€ä¸ªä½ç½®çš„åˆ—å· */\r\n    nextColumn: number\r\n    /** ä¸Šä¸€ä¸ª token çš„åç§°ï¼ˆç”¨äºä¸Šä¸‹æ–‡çº¦æŸæ£€æŸ¥ï¼‰ */\r\n    lastTokenName: string | null\r\n}\r\n\r\nexport const SubhutiLexerTokenNames = {\r\n    TemplateHead: 'TemplateHead',\r\n    TemplateMiddle: 'TemplateMiddle',\r\n    TemplateTail: 'TemplateTail',\r\n}\r\n\r\n/**\r\n * Subhuti Lexer - è¯æ³•åˆ†æå™¨\r\n * \r\n * æ ¸å¿ƒç‰¹æ€§ï¼š\r\n * - é¢„ç¼–è¯‘æ­£åˆ™ï¼ˆæ„é€ æ—¶ä¸€æ¬¡æ€§å¤„ç†ï¼‰\r\n * - è¯æ³•å±‚ lookaheadï¼ˆOptionalChaining ç­‰ï¼‰\r\n * - æ¨¡æ¿å­—ç¬¦ä¸²çŠ¶æ€ç®¡ç†ï¼ˆInputElement åˆ‡æ¢ï¼‰\r\n * \r\n * @version 1.0.0\r\n */\r\nexport default class SubhutiLexer {\r\n  private readonly _allTokens: SubhutiCreateToken[]\r\n  private readonly _tokensOutsideTemplate: SubhutiCreateToken[]\r\n  private _templateDepth = 0\r\n  private _lastRowNum = 1  // è®°å½•ä¸Šä¸€ä¸ª token çš„è¡Œå·ï¼ˆç”¨äºè®¡ç®— hasLineBreakBeforeï¼‰\r\n\r\n  constructor(tokens: SubhutiCreateToken[]) {\r\n    // é¢„ç¼–è¯‘ï¼šç»™æ‰€æœ‰æ­£åˆ™åŠ  ^ é”šç‚¹ï¼Œå¹¶ä¿ç•™åŸæœ‰ flags\r\n    // æ³¨æ„ï¼šå¿…é¡»ç”¨ (?:...) åŒ…è£¹æ•´ä¸ªæ­£åˆ™ï¼Œå¦åˆ™ ^A|B åªä¼šé”šå®š A åˆ†æ”¯\r\n    // ä¾‹å¦‚ï¼š^abc|\\.14 åŒ¹é… \"float = 3.14\" ä¼šåœ¨ä½ç½® 9 åŒ¹é…åˆ° .14ï¼ˆé”™è¯¯ï¼‰\r\n    //       ^(?:abc|\\.14) åˆ™ä¸ä¼šåŒ¹é…ï¼ˆæ­£ç¡®ï¼‰\r\n    this._allTokens = tokens.map(token => {\r\n      if (!token.pattern) return token\r\n\r\n      return {\r\n        ...token,\r\n        pattern: new RegExp('^(?:' + token.pattern.source + ')', token.pattern.flags)\r\n      }\r\n    })\r\n    \r\n    // é¢„è¿‡æ»¤ï¼šåªè¿‡æ»¤ä¸€æ¬¡ï¼Œæ„å»ºæ¨¡æ¿å¤–éƒ¨ä½¿ç”¨çš„ token é›†åˆ\r\n    // ä½¿ç”¨ç¡¬ç¼–ç å¸¸é‡ï¼ˆç¬¦åˆ ECMAScript è§„èŒƒå’Œè¡Œä¸šæ ‡å‡†ï¼‰\r\n    this._tokensOutsideTemplate = this._allTokens.filter(\r\n      t => t.name !== SubhutiLexerTokenNames.TemplateMiddle && \r\n           t.name !== SubhutiLexerTokenNames.TemplateTail\r\n    )\r\n  }\r\n\r\n  /**\r\n   * è¯æ³•åˆ†æä¸»å…¥å£\r\n   * @param code æºä»£ç \r\n   * @returns Token æµ\r\n   */\r\n  tokenize(code: string): SubhutiMatchToken[] {\r\n    const result: SubhutiMatchToken[] = []\r\n    let index = 0\r\n    let rowNum = 1\r\n    let columnNum = 1\r\n    this._lastRowNum = 1  // é‡ç½®ä¸Šä¸€ä¸ª token çš„è¡Œå·\r\n\r\n    while (index < code.length) {\r\n      // ä¼ å…¥å·²åŒ¹é…çš„ tokensï¼Œç”¨äºä¸Šä¸‹æ–‡çº¦æŸæ£€æŸ¥\r\n      const matched = this._matchToken(code, index, rowNum, columnNum, result)\r\n\r\n      if (!matched) {\r\n        const errorChar = code[index]\r\n        throw new Error(\r\n          `Unexpected character \"${errorChar}\" at position ${index} (line ${rowNum}, column ${columnNum})`\r\n        )\r\n      }\r\n\r\n      // skip ç±»å‹çš„ token ä¸åŠ å…¥ç»“æœ\r\n      if (!matched.skip) {\r\n        result.push(matched.token)\r\n        // åªåœ¨é skip token æ—¶æ›´æ–°è¡Œå·ï¼ˆç”¨äºä¸‹ä¸€ä¸ª token è®¡ç®— hasLineBreakBeforeï¼‰\r\n        this._lastRowNum = rowNum\r\n      }\r\n\r\n      // æ›´æ–°ä½ç½®\r\n      const valueLength = matched.token.tokenValue.length\r\n      index += valueLength\r\n\r\n      // æ›´æ–°è¡Œåˆ—å·\r\n      // LineTerminator åŒ…æ‹¬: LF(\\n), CR(\\r), LS(\\u2028), PS(\\u2029)\r\n      // æ³¨æ„: \\r\\n ç®—ä½œä¸€ä¸ªæ¢è¡Œ\r\n      const lineBreaks = matched.token.tokenValue.match(/\\r\\n|[\\n\\r\\u2028\\u2029]/g)\r\n      if (lineBreaks && lineBreaks.length > 0) {\r\n        rowNum += lineBreaks.length\r\n        // æœ€åä¸€ä¸ªæ¢è¡Œç¬¦ä¹‹åçš„å†…å®¹é•¿åº¦\r\n        const lastBreakIndex = matched.token.tokenValue.lastIndexOf(lineBreaks[lineBreaks.length - 1])\r\n        const lastBreakLen = lineBreaks[lineBreaks.length - 1].length\r\n        columnNum = matched.token.tokenValue.length - lastBreakIndex - lastBreakLen + 1\r\n      } else {\r\n        columnNum += valueLength\r\n      }\r\n\r\n      // æ›´æ–°æ¨¡æ¿æ·±åº¦\r\n      this._updateTemplateDepth(matched.token.tokenName)\r\n    }\r\n\r\n    return result\r\n  }\r\n\r\n  private _matchToken(\r\n    code: string,\r\n    index: number,\r\n    rowNum: number,\r\n    columnNum: number,\r\n    matchedTokens: SubhutiMatchToken[]\r\n  ) {\r\n    const remaining = code.slice(index)\r\n    // è·å–å‰ä¸€ä¸ª token çš„åç§°ï¼ˆç”¨äºä¸Šä¸‹æ–‡çº¦æŸæ£€æŸ¥ï¼‰\r\n    const lastTokenName = matchedTokens.length > 0\r\n      ? matchedTokens[matchedTokens.length - 1].tokenName\r\n      : null\r\n\r\n    for (const token of this._getActiveTokens()) {\r\n      const match = remaining.match(token.pattern)\r\n      if (!match) continue\r\n\r\n      // ä¸Šä¸‹æ–‡çº¦æŸæ£€æŸ¥ï¼šonlyAtStart - åªèƒ½åœ¨æ–‡ä»¶å¼€å¤´åŒ¹é…ï¼ˆå¦‚ Hashbangï¼‰\r\n      if (token.contextConstraint?.onlyAtStart && index !== 0) {\r\n        continue  // ä¸åœ¨æ–‡ä»¶å¼€å¤´ï¼Œè·³è¿‡è¿™ä¸ª token\r\n      }\r\n\r\n      // ä¸Šä¸‹æ–‡çº¦æŸæ£€æŸ¥ï¼šonlyAtLineStart - åªèƒ½åœ¨è¡Œé¦–åŒ¹é…ï¼ˆå¦‚ HTMLCloseComment -->ï¼‰\r\n      // æ¡ä»¶ï¼šå½“å‰è¡Œå· > ä¸Šä¸€ä¸ªé skip token çš„è¡Œå·ï¼Œè¯´æ˜åœ¨æ–°è¡Œå¼€å§‹\r\n      if (token.contextConstraint?.onlyAtLineStart && rowNum <= this._lastRowNum) {\r\n        continue  // ä¸åœ¨è¡Œé¦–ï¼Œè·³è¿‡è¿™ä¸ª token\r\n      }\r\n\r\n      // ä¸Šä¸‹æ–‡çº¦æŸæ£€æŸ¥ï¼šonlyAfter - åªæœ‰å‰ä¸€ä¸ª token åœ¨é›†åˆä¸­æ‰åŒ¹é…\r\n      if (token.contextConstraint?.onlyAfter) {\r\n        if (!lastTokenName || !token.contextConstraint.onlyAfter.has(lastTokenName)) {\r\n          continue  // ä¸æ»¡è¶³æ¡ä»¶ï¼Œè·³è¿‡è¿™ä¸ª token\r\n        }\r\n      }\r\n\r\n      // ä¸Šä¸‹æ–‡çº¦æŸæ£€æŸ¥ï¼šnotAfter - å‰ä¸€ä¸ª token ä¸èƒ½åœ¨é›†åˆä¸­\r\n      if (token.contextConstraint?.notAfter) {\r\n        if (lastTokenName && token.contextConstraint.notAfter.has(lastTokenName)) {\r\n          continue  // ä¸æ»¡è¶³æ¡ä»¶ï¼Œè·³è¿‡è¿™ä¸ª token\r\n        }\r\n      }\r\n\r\n      // è¯æ³•å±‚ lookahead æ£€æŸ¥\r\n      if (token.lookaheadAfter?.not) {\r\n        const afterText = remaining.slice(match[0].length)\r\n        const { not } = token.lookaheadAfter\r\n\r\n        const shouldSkip = not instanceof RegExp\r\n          ? not.test(afterText)\r\n          : afterText.startsWith(not)\r\n\r\n        if (shouldSkip) continue\r\n      }\r\n\r\n      return {\r\n        token: this._createMatchToken(token, match[0], index, rowNum, columnNum),\r\n        skip: token.skip\r\n      }\r\n    }\r\n\r\n    return null\r\n  }\r\n\r\n  private _createMatchToken(\r\n    token: SubhutiCreateToken,\r\n    value: string,\r\n    index: number,\r\n    rowNum: number,\r\n    columnNum: number\r\n  ): SubhutiMatchToken {\r\n    return {\r\n      tokenName: token.name,\r\n      tokenValue: value,\r\n      index: index,\r\n      rowNum: rowNum,\r\n      columnStartNum: columnNum,\r\n      columnEndNum: columnNum + value.length - 1,\r\n      hasLineBreakBefore: rowNum > this._lastRowNum  // è®¡ç®—æ˜¯å¦æœ‰æ¢è¡Œï¼ˆBabel é£æ ¼ï¼‰\r\n    }\r\n  }\r\n\r\n  /**\r\n   * æ ¹æ®æ¨¡æ¿æ·±åº¦è¿”å›æ´»è·ƒçš„ tokens\r\n   * å®ç° ECMAScript è§„èŒƒçš„ InputElement åˆ‡æ¢æœºåˆ¶\r\n   * \r\n   * ä½¿ç”¨é¢„ç¼–è¯‘ç­–ç•¥ï¼šæ„é€ æ—¶è¿‡æ»¤ä¸€æ¬¡ï¼Œè¿è¡Œæ—¶åªé€‰æ‹©æ•°ç»„ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰\r\n   */\r\n  private _getActiveTokens(): SubhutiCreateToken[] {\r\n    // åœ¨æ¨¡æ¿å†…éƒ¨ï¼šæ‰€æœ‰ tokens éƒ½å¯ç”¨\r\n    // åœ¨æ¨¡æ¿å¤–éƒ¨ï¼šä½¿ç”¨é¢„è¿‡æ»¤çš„ token é›†åˆ\r\n    return this._templateDepth > 0 \r\n      ? this._allTokens \r\n      : this._tokensOutsideTemplate\r\n  }\r\n\r\n  /**\r\n   * æ›´æ–°æ¨¡æ¿å­—ç¬¦ä¸²åµŒå¥—æ·±åº¦\r\n   *\r\n   * å®ç° ECMAScript è§„èŒƒçš„ InputElement åˆ‡æ¢æœºåˆ¶ï¼š\r\n   * - TemplateHead (`${`) è¿›å…¥æ¨¡æ¿ä¸Šä¸‹æ–‡ï¼ˆæ·±åº¦ +1ï¼‰\r\n   * - TemplateTail (}`) é€€å‡ºæ¨¡æ¿ä¸Šä¸‹æ–‡ï¼ˆæ·±åº¦ -1ï¼‰\r\n   * - TemplateMiddle: ä¿æŒæ·±åº¦ä¸å˜\r\n   *\r\n   * å‚è€ƒå®ç°ï¼šBabelã€Acornã€TypeScript Scanner\r\n   * è¡Œä¸šæ ‡å‡†åšæ³•ï¼šç›´æ¥ç¡¬ç¼–ç  token åç§°ï¼Œæ— éœ€é…ç½®\r\n   */\r\n  private _updateTemplateDepth(tokenName: string): void {\r\n    if (tokenName === SubhutiLexerTokenNames.TemplateHead) {\r\n      this._templateDepth++\r\n    } else if (tokenName === SubhutiLexerTokenNames.TemplateTail) {\r\n      this._templateDepth--\r\n    }\r\n  }\r\n\r\n  /**\r\n   * å°è¯•åŒ¹é…æ¨¡æ¿ token (TemplateMiddle æˆ– TemplateTail)\r\n   * ä»…åœ¨ InputElementTemplateTail æ¨¡å¼ä¸‹ä½¿ç”¨\r\n   */\r\n  private _matchTemplateToken(\r\n    remaining: string,\r\n    index: number,\r\n    rowNum: number,\r\n    columnNum: number\r\n  ) {\r\n    for (const token of this._allTokens) {\r\n      if (token.name !== SubhutiLexerTokenNames.TemplateMiddle &&\r\n          token.name !== SubhutiLexerTokenNames.TemplateTail) {\r\n        continue\r\n      }\r\n\r\n      const match = remaining.match(token.pattern)\r\n      if (match) {\r\n        return {\r\n          token: this._createMatchTokenWithLastRow(\r\n            token.name,\r\n            match[0],\r\n            index,\r\n            rowNum,\r\n            columnNum,\r\n            rowNum\r\n          ),\r\n          skip: false\r\n        }\r\n      }\r\n    }\r\n    return null\r\n  }\r\n\r\n  // ============================================\r\n  // æŒ‰éœ€è¯æ³•åˆ†æ APIï¼ˆOn-Demand Lexingï¼‰\r\n  // ç¬¦åˆ ECMAScript è§„èŒƒçš„ InputElement åˆ‡æ¢æœºåˆ¶\r\n  // ============================================\r\n\r\n  /**\r\n   * åˆ›å»ºåˆå§‹è¯æ³•çŠ¶æ€\r\n   */\r\n  createInitialState(): LexerState {\r\n    return {\r\n      position: 0,\r\n      rowNum: 1,\r\n      columnNum: 1,\r\n      templateDepth: 0,\r\n      lastTokenRowNum: 1,\r\n      lastTokenName: null\r\n    }\r\n  }\r\n\r\n  /**\r\n   * æŒ‰éœ€è¯»å–ä¸‹ä¸€ä¸ª token\r\n   *\r\n   * @param code æºä»£ç \r\n   * @param state å½“å‰è¯æ³•çŠ¶æ€ï¼ˆä¼šè¢«ä¿®æ”¹ï¼‰\r\n   * @param lexicalGoal è¯æ³•ç›®æ ‡ï¼ˆInputElementDiv æˆ– InputElementRegExpï¼‰\r\n   * @returns token æˆ– nullï¼ˆEOFï¼‰\r\n   */\r\n  readNextToken(\r\n    code: string,\r\n    state: LexerState,\r\n    lexicalGoal: LexicalGoal = LexicalGoal.InputElementDiv\r\n  ): SubhutiMatchToken | null {\r\n    // è·³è¿‡ç©ºç™½å’Œæ³¨é‡Šï¼Œç›´åˆ°æ‰¾åˆ°æœ‰æ•ˆ token\r\n    while (state.position < code.length) {\r\n      const matched = this._matchTokenWithGoal(\r\n        code,\r\n        state.position,\r\n        state.rowNum,\r\n        state.columnNum,\r\n        state.lastTokenName,\r\n        state.templateDepth,\r\n        lexicalGoal\r\n      )\r\n\r\n      if (!matched) {\r\n        const errorChar = code[state.position]\r\n        throw new Error(\r\n          `Unexpected character \"${errorChar}\" at position ${state.position} (line ${state.rowNum}, column ${state.columnNum})`\r\n        )\r\n      }\r\n\r\n      // æ›´æ–°ä½ç½®\r\n      const valueLength = matched.token.tokenValue.length\r\n      state.position += valueLength\r\n\r\n      // æ›´æ–°è¡Œåˆ—å·\r\n      const lineBreaks = matched.token.tokenValue.match(/\\r\\n|[\\n\\r\\u2028\\u2029]/g)\r\n      if (lineBreaks && lineBreaks.length > 0) {\r\n        state.rowNum += lineBreaks.length\r\n        const lastBreakIndex = matched.token.tokenValue.lastIndexOf(lineBreaks[lineBreaks.length - 1])\r\n        const lastBreakLen = lineBreaks[lineBreaks.length - 1].length\r\n        state.columnNum = matched.token.tokenValue.length - lastBreakIndex - lastBreakLen + 1\r\n      } else {\r\n        state.columnNum += valueLength\r\n      }\r\n\r\n      // æ›´æ–°æ¨¡æ¿æ·±åº¦\r\n      if (matched.token.tokenName === SubhutiLexerTokenNames.TemplateHead) {\r\n        state.templateDepth++\r\n      } else if (matched.token.tokenName === SubhutiLexerTokenNames.TemplateTail) {\r\n        state.templateDepth--\r\n      }\r\n\r\n      // skip ç±»å‹çš„ token ç»§ç»­è¯»å–ä¸‹ä¸€ä¸ª\r\n      if (matched.skip) {\r\n        continue\r\n      }\r\n\r\n      // æ›´æ–°çŠ¶æ€\r\n      state.lastTokenRowNum = matched.token.rowNum\r\n      state.lastTokenName = matched.token.tokenName\r\n\r\n      return matched.token\r\n    }\r\n\r\n    return null  // EOF\r\n  }\r\n\r\n  /**\r\n   * æ£€æŸ¥æ˜¯å¦åˆ°è¾¾æ–‡ä»¶æœ«å°¾\r\n   */\r\n  isEOF(code: string, state: LexerState): boolean {\r\n    // è·³è¿‡ç©ºç™½æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å†…å®¹\r\n    let pos = state.position\r\n    while (pos < code.length) {\r\n      const remaining = code.slice(pos)\r\n      // æ£€æŸ¥æ˜¯å¦æ˜¯ç©ºç™½æˆ–æ³¨é‡Š\r\n      const whitespaceMatch = remaining.match(/^[\\s]+/)\r\n      if (whitespaceMatch) {\r\n        pos += whitespaceMatch[0].length\r\n        continue\r\n      }\r\n      const singleLineComment = remaining.match(/^\\/\\/[^\\n\\r]*/)\r\n      if (singleLineComment) {\r\n        pos += singleLineComment[0].length\r\n        continue\r\n      }\r\n      const multiLineComment = remaining.match(/^\\/\\*[\\s\\S]*?\\*\\//)\r\n      if (multiLineComment) {\r\n        pos += multiLineComment[0].length\r\n        continue\r\n      }\r\n      // è¿˜æœ‰å…¶ä»–å†…å®¹\r\n      return false\r\n    }\r\n    return true\r\n  }\r\n\r\n  /**\r\n   * å¸¦è¯æ³•ç›®æ ‡çš„ token åŒ¹é…\r\n   */\r\n  private _matchTokenWithGoal(\r\n    code: string,\r\n    index: number,\r\n    rowNum: number,\r\n    columnNum: number,\r\n    lastTokenName: string | null,\r\n    templateDepth: number,\r\n    lexicalGoal: LexicalGoal\r\n  ) {\r\n    const remaining = code.slice(index)\r\n\r\n    // è·å–æ´»è·ƒçš„ tokens\r\n    // æ³¨æ„ï¼šå³ä½¿ templateDepth > 0ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¹Ÿä¸åº”è¯¥åŒ¹é… TemplateMiddle/TemplateTail\r\n    // åªæœ‰åœ¨ InputElementTemplateTail æ¨¡å¼ä¸‹æ‰åŒ¹é…å®ƒä»¬\r\n    const activeTokens = this._tokensOutsideTemplate\r\n\r\n    for (const token of activeTokens) {\r\n      // InputElementTemplateTail æ¨¡å¼ï¼šåªåŒ¹é… TemplateMiddle æˆ– TemplateTail\r\n      // è¿™æ˜¯æ¨¡æ¿è¡¨è¾¾å¼ç»“æŸåï¼Œéœ€è¦åŒ¹é… } å¼€å¤´çš„æ¨¡æ¿éƒ¨åˆ†\r\n      if (lexicalGoal === LexicalGoal.InputElementTemplateTail) {\r\n        // åœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ï¼Œä¼˜å…ˆå°è¯•åŒ¹é…æ¨¡æ¿ token\r\n        const templateMatch = this._matchTemplateToken(remaining, index, rowNum, columnNum)\r\n        if (templateMatch) {\r\n          return templateMatch\r\n        }\r\n        // å¦‚æœæ²¡æœ‰åŒ¹é…ï¼Œç»§ç»­æ­£å¸¸åŒ¹é…\r\n      }\r\n\r\n      // æ ¹æ®è¯æ³•ç›®æ ‡å¤„ç† Slash\r\n      if (token.name === 'Slash' || token.name === 'DivideAssign') {\r\n        if (lexicalGoal === LexicalGoal.InputElementRegExp && remaining.startsWith('/')) {\r\n          // åœ¨ InputElementRegExp æ¨¡å¼ä¸‹ï¼Œå°è¯•åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼\r\n          const regexpMatch = matchRegExpLiteral(remaining)\r\n          if (regexpMatch) {\r\n            return {\r\n              token: this._createMatchTokenWithLastRow(\r\n                'RegularExpressionLiteral',\r\n                regexpMatch,\r\n                index,\r\n                rowNum,\r\n                columnNum,\r\n                rowNum  // lastRowNum ä¼ å…¥å½“å‰è¡Œå·\r\n              ),\r\n              skip: false\r\n            }\r\n          }\r\n          // æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å¤±è´¥ï¼Œç»§ç»­å°è¯•å…¶ä»– tokenï¼ˆåŒ…æ‹¬ Slashï¼‰\r\n        }\r\n      }\r\n\r\n      const match = remaining.match(token.pattern)\r\n      if (!match) continue\r\n\r\n      // ä¸Šä¸‹æ–‡çº¦æŸæ£€æŸ¥ï¼šonlyAtStart\r\n      if (token.contextConstraint?.onlyAtStart && index !== 0) {\r\n        continue\r\n      }\r\n\r\n      // ä¸Šä¸‹æ–‡çº¦æŸæ£€æŸ¥ï¼šonlyAtLineStart - åªèƒ½åœ¨è¡Œé¦–åŒ¹é…ï¼ˆå¦‚ HTMLCloseComment -->ï¼‰\r\n      if (token.contextConstraint?.onlyAtLineStart && rowNum <= this._lastRowNum) {\r\n        continue\r\n      }\r\n\r\n      // ä¸Šä¸‹æ–‡çº¦æŸæ£€æŸ¥ï¼šonlyAfterï¼ˆåœ¨æŒ‰éœ€æ¨¡å¼ä¸‹ä»ç„¶æ£€æŸ¥ï¼Œç”¨äºé Slash tokenï¼‰\r\n      if (token.contextConstraint?.onlyAfter) {\r\n        if (!lastTokenName || !token.contextConstraint.onlyAfter.has(lastTokenName)) {\r\n          continue\r\n        }\r\n      }\r\n\r\n      // ä¸Šä¸‹æ–‡çº¦æŸæ£€æŸ¥ï¼šnotAfter\r\n      if (token.contextConstraint?.notAfter) {\r\n        if (lastTokenName && token.contextConstraint.notAfter.has(lastTokenName)) {\r\n          continue\r\n        }\r\n      }\r\n\r\n      // è¯æ³•å±‚ lookahead æ£€æŸ¥\r\n      if (token.lookaheadAfter?.not) {\r\n        const afterText = remaining.slice(match[0].length)\r\n        const { not } = token.lookaheadAfter\r\n        const shouldSkip = not instanceof RegExp\r\n          ? not.test(afterText)\r\n          : afterText.startsWith(not)\r\n        if (shouldSkip) continue\r\n      }\r\n\r\n      return {\r\n        token: this._createMatchTokenWithLastRow(token.name, match[0], index, rowNum, columnNum, this._lastRowNum),\r\n        skip: token.skip\r\n      }\r\n    }\r\n\r\n    return null\r\n  }\r\n\r\n  // ============================================\r\n  // æ–°çš„æŒ‰ä½ç½®+æ¨¡å¼è¯»å– API\r\n  // ============================================\r\n\r\n  /**\r\n   * åœ¨æŒ‡å®šä½ç½®ç”¨æŒ‡å®šæ¨¡å¼è¯»å–å•ä¸ª token\r\n   *\r\n   * @param code æºä»£ç \r\n   * @param codeIndex èµ·å§‹ä½ç½®\r\n   * @param line èµ·å§‹è¡Œå·\r\n   * @param column èµ·å§‹åˆ—å·\r\n   * @param goal è¯æ³•ç›®æ ‡\r\n   * @param lastTokenName ä¸Šä¸€ä¸ª token çš„åç§°ï¼ˆç”¨äºä¸Šä¸‹æ–‡çº¦æŸï¼‰\r\n   * @param templateDepth æ¨¡æ¿å­—ç¬¦ä¸²æ·±åº¦\r\n   * @returns TokenCacheEntry æˆ– nullï¼ˆEOFï¼‰\r\n   */\r\n  readTokenAt(\r\n    code: string,\r\n    codeIndex: number,\r\n    line: number,\r\n    column: number,\r\n    goal: LexicalGoal,\r\n    lastTokenName: string | null = null,\r\n    templateDepth: number = 0\r\n  ): TokenCacheEntry | null {\r\n    let pos = codeIndex\r\n    let rowNum = line\r\n    let columnNum = column\r\n    let lastRowNum = line  // ç”¨äº hasLineBreakBefore è®¡ç®—\r\n    let currentLastTokenName = lastTokenName\r\n\r\n    // è·³è¿‡ç©ºç™½å’Œæ³¨é‡Šï¼Œç›´åˆ°æ‰¾åˆ°æœ‰æ•ˆ token\r\n    while (pos < code.length) {\r\n      const matched = this._matchTokenWithGoal(\r\n        code,\r\n        pos,\r\n        rowNum,\r\n        columnNum,\r\n        currentLastTokenName,\r\n        templateDepth,\r\n        goal\r\n      )\r\n\r\n      if (!matched) {\r\n        const errorChar = code[pos]\r\n        throw new Error(\r\n          `Unexpected character \"${errorChar}\" at position ${pos} (line ${rowNum}, column ${columnNum})`\r\n        )\r\n      }\r\n\r\n      const valueLength = matched.token.tokenValue.length\r\n      const nextPos = pos + valueLength\r\n\r\n      // è®¡ç®—ä¸‹ä¸€ä¸ªä½ç½®çš„è¡Œåˆ—å·\r\n      let nextRowNum = rowNum\r\n      let nextColumnNum = columnNum\r\n      const lineBreaks = matched.token.tokenValue.match(/\\r\\n|[\\n\\r\\u2028\\u2029]/g)\r\n      if (lineBreaks && lineBreaks.length > 0) {\r\n        nextRowNum += lineBreaks.length\r\n        const lastBreakIndex = matched.token.tokenValue.lastIndexOf(lineBreaks[lineBreaks.length - 1])\r\n        const lastBreakLen = lineBreaks[lineBreaks.length - 1].length\r\n        nextColumnNum = matched.token.tokenValue.length - lastBreakIndex - lastBreakLen + 1\r\n      } else {\r\n        nextColumnNum += valueLength\r\n      }\r\n\r\n      // skip ç±»å‹çš„ token ç»§ç»­è¯»å–ä¸‹ä¸€ä¸ª\r\n      if (matched.skip) {\r\n        // æ³¨æ„ï¼šä¸æ›´æ–° lastRowNumï¼\r\n        // lastRowNum åº”è¯¥ä¿æŒä¸ºä¸Šä¸€ä¸ªé skip token çš„è¡Œå·\r\n        // è¿™æ · hasLineBreakBefore æ‰èƒ½æ­£ç¡®è®¡ç®—\r\n        pos = nextPos\r\n        rowNum = nextRowNum\r\n        columnNum = nextColumnNum\r\n        continue\r\n      }\r\n\r\n      // æ‰¾åˆ°æœ‰æ•ˆ tokenï¼Œè¿”å›ç¼“å­˜æ¡ç›®\r\n      // é‡æ–°åˆ›å»º token ä»¥åŒ…å«æ­£ç¡®çš„ hasLineBreakBefore\r\n      const token: SubhutiMatchToken = {\r\n        tokenName: matched.token.tokenName,\r\n        tokenValue: matched.token.tokenValue,\r\n        index: pos,\r\n        rowNum: rowNum,\r\n        columnStartNum: columnNum,\r\n        columnEndNum: columnNum + valueLength - 1,\r\n        hasLineBreakBefore: rowNum > lastRowNum\r\n      }\r\n\r\n      return {\r\n        token,\r\n        nextCodeIndex: nextPos,\r\n        nextLine: nextRowNum,\r\n        nextColumn: nextColumnNum,\r\n        lastTokenName: token.tokenName\r\n      }\r\n    }\r\n\r\n    return null  // EOF\r\n  }\r\n\r\n  /**\r\n   * åˆ›å»º tokenï¼ˆå¸¦ lastRowNum å‚æ•°ï¼‰\r\n   */\r\n  private _createMatchTokenWithLastRow(\r\n    tokenName: string,\r\n    value: string,\r\n    index: number,\r\n    rowNum: number,\r\n    columnNum: number,\r\n    lastRowNum: number\r\n  ): SubhutiMatchToken {\r\n    return {\r\n      tokenName: tokenName,\r\n      tokenValue: value,\r\n      index: index,\r\n      rowNum: rowNum,\r\n      columnStartNum: columnNum,\r\n      columnEndNum: columnNum + value.length - 1,\r\n      hasLineBreakBefore: rowNum > lastRowNum\r\n    }\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n","/**\r\n * Subhuti Grammar Validation - ç±»å‹å®šä¹‰\r\n *\r\n * åŠŸèƒ½ï¼šå®šä¹‰è¯­æ³•éªŒè¯ç›¸å…³çš„ç±»å‹ã€æ¥å£å’Œå¼‚å¸¸ç±»\r\n *\r\n * @version 1.0.0\r\n */\r\n\r\n// ============================================\r\n// éªŒè¯é”™è¯¯ç±»å‹\r\n// ============================================\r\n\r\n/**\r\n * éªŒè¯é”™è¯¯æ¥å£\r\n */\r\nexport interface ValidationError {\r\n    /** é”™è¯¯çº§åˆ« */\r\n    level: 'ERROR' | 'FATAL'\r\n\r\n    /** é”™è¯¯ç±»å‹ */\r\n    type: 'empty-path' | 'prefix-conflict' | 'left-recursion' | 'or-conflict' | 'or-identical-branches'\r\n\r\n    /** è§„åˆ™åç§° */\r\n    ruleName: string\r\n\r\n    /** å†²çªçš„åˆ†æ”¯ç´¢å¼• [å‰, å] */\r\n    branchIndices: [number, number] | []\r\n\r\n    /** å†²çªè·¯å¾„ï¼ˆå¯é€‰ï¼Œéƒ¨åˆ†é”™è¯¯ç±»å‹ä¸éœ€è¦ï¼‰ */\r\n    conflictPaths?: {\r\n        pathA: string  // å‰ç¼€è·¯å¾„ï¼ˆçŸ­ï¼‰æˆ–åˆ†æ”¯ A çš„ First é›†åˆ\r\n        pathB: string  // è¢«é®è”½è·¯å¾„ï¼ˆé•¿ï¼‰æˆ–åˆ†æ”¯ B çš„ First é›†åˆ\r\n    }\r\n\r\n    /** é”™è¯¯æ¶ˆæ¯ */\r\n    message: string\r\n\r\n    /** ä¿®å¤å»ºè®® */\r\n    suggestion: string\r\n}\r\n\r\n/**\r\n * éªŒè¯ç»“æœæ¥å£ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰\r\n */\r\nexport interface ValidationResult {\r\n    /** æ˜¯å¦é€šè¿‡éªŒè¯ */\r\n    success: boolean\r\n\r\n    /** é”™è¯¯åˆ—è¡¨ */\r\n    errors: ValidationError[]\r\n}\r\n\r\n// ============================================\r\n// å¼‚å¸¸ç±»\r\n// ============================================\r\n\r\n/**\r\n * ç»Ÿè®¡ä¿¡æ¯æ¥å£\r\n */\r\nexport interface ValidationStats {\r\n    /** First(K) ç¼“å­˜ç”Ÿæˆç”¨æ—¶ */\r\n    dfsFirstKTime: number\r\n    /** MaxLevel ç¼“å­˜ç”Ÿæˆç”¨æ—¶ */\r\n    bfsMaxLevelTime: number\r\n    /** Or å†²çªæ£€æµ‹ç”¨æ—¶ */\r\n    orDetectionTime: number\r\n    /** å·¦é€’å½’é”™è¯¯æ•°é‡ */\r\n    leftRecursionCount: number\r\n    /** Or åˆ†æ”¯å†²çªæ•°é‡ */\r\n    orConflictCount: number\r\n    /** æ€»ç”¨æ—¶ */\r\n    totalTime: number\r\n    /** dfsFirstKCache å¤§å° */\r\n    dfsFirstKCacheSize: number\r\n    /** bfsAllCache å¤§å° */\r\n    bfsAllCacheSize: number\r\n    /** First(K) çš„ K å€¼ */\r\n    firstK: number\r\n    /** ç¼“å­˜ä½¿ç”¨ç‡ç»Ÿè®¡ */\r\n    cacheUsage?: {\r\n        dfsFirstK: { hit: number, miss: number, total: number, hitRate: number, getCount: number }\r\n        bfsAllCache: { getCount: number, size: number }\r\n        bfsLevelCache: { hit: number, miss: number, total: number, hitRate: number, size: number, getCount: number }\r\n        getDirectChildren: { hit: number, miss: number, total: number, hitRate: number }\r\n    }\r\n}\r\n\r\n/**\r\n * è¯­æ³•éªŒè¯å¼‚å¸¸\r\n */\r\nexport class SubhutiGrammarValidationError extends Error {\r\n    constructor(\r\n        public errors: ValidationError[],\r\n        public stats?: ValidationStats\r\n    ) {\r\n        super('Grammar validation failed')\r\n        this.name = 'SubhutiGrammarValidationError'\r\n    }\r\n\r\n    /**\r\n     * æ ¼å¼åŒ–é”™è¯¯ä¿¡æ¯ï¼ˆåŒ…å«ç»Ÿè®¡ä¿¡æ¯ï¼‰\r\n     */\r\n    toString(): string {\r\n        const lines: string[] = []\r\n        \r\n        // è¾“å‡ºé”™è¯¯è¯¦æƒ…\r\n        for (const error of this.errors) {\r\n            // æ ¼å¼åŒ–æ ‡é¢˜\r\n            let title = ''\r\n            if (error.type === 'prefix-conflict' && error.branchIndices.length === 2) {\r\n                // å‰ç¼€å†²çªï¼šåˆ†æ”¯ j è¢«åˆ†æ”¯ i é®è”½\r\n                const [i, j] = error.branchIndices\r\n                title = `[${error.level}] åˆ†æ”¯ ${j} è¢«åˆ†æ”¯ ${i} é®è”½`\r\n            } else if (error.type === 'or-identical-branches' && error.branchIndices.length === 2) {\r\n                // ç›¸åŒåˆ†æ”¯ï¼šåˆ†æ”¯ i å’Œåˆ†æ”¯ j å®Œå…¨ç›¸åŒ\r\n                const [i, j] = error.branchIndices\r\n                title = `[${error.level}] åˆ†æ”¯ ${i} å’Œåˆ†æ”¯ ${j} å®Œå…¨ç›¸åŒ`\r\n            } else {\r\n                // å…¶ä»–ç±»å‹ï¼šä½¿ç”¨åŸå§‹ message\r\n                title = `[${error.level}] ${error.message}`\r\n            }\r\n            \r\n            lines.push(title)\r\n            lines.push(`  Rule: ${error.ruleName}`)\r\n            lines.push(`  Branches: [${error.branchIndices.join(', ')}]`)\r\n            \r\n            // conflictPaths æ˜¯å¯é€‰çš„\r\n            if (error.conflictPaths) {\r\n                lines.push(`  Path A: ${error.conflictPaths.pathA}`)\r\n                lines.push(`  Path B: ${error.conflictPaths.pathB}`)\r\n            }\r\n            \r\n            // æ ¼å¼åŒ– Suggestionï¼ˆç®€åŒ–ï¼‰\r\n            if (error.type === 'prefix-conflict' && error.branchIndices.length === 2) {\r\n                const [i, j] = error.branchIndices\r\n                lines.push(`  Suggestion: å°†åˆ†æ”¯ ${j} ç§»åˆ°åˆ†æ”¯ ${i} å‰é¢ï¼ˆé•¿è§„åˆ™åœ¨å‰ï¼ŒçŸ­è§„åˆ™åœ¨åï¼‰`)\r\n            } else {\r\n                lines.push(`  Suggestion: ${error.suggestion}`)\r\n            }\r\n            \r\n            lines.push('')\r\n        }\r\n\r\n        // è¾“å‡ºç»Ÿè®¡ä¿¡æ¯ï¼ˆåœ¨æœ€åï¼‰\r\n        if (this.stats) {\r\n            const s = this.stats\r\n            lines.push('')\r\n            lines.push('='.repeat(60))\r\n            lines.push('ğŸ“Š ========== ç»Ÿè®¡ä¿¡æ¯ ==========')\r\n            lines.push('='.repeat(60))\r\n            lines.push('')\r\n            lines.push('â±ï¸  æ—¶é—´ç»Ÿè®¡ï¼š')\r\n            lines.push(`   æ€»è€—æ—¶: ${s.totalTime}ms`)\r\n            lines.push(`   â”œâ”€ First(K) ç¼“å­˜ç”Ÿæˆ: ${s.dfsFirstKTime}ms (${(s.dfsFirstKTime / s.totalTime * 100).toFixed(1)}%)`)\r\n            lines.push(`   â”œâ”€ MaxLevel ç¼“å­˜ç”Ÿæˆ: ${s.bfsMaxLevelTime}ms (${(s.bfsMaxLevelTime / s.totalTime * 100).toFixed(1)}%)`)\r\n            lines.push(`   â””â”€ Or å†²çªæ£€æµ‹: ${s.orDetectionTime}ms (${(s.orDetectionTime / s.totalTime * 100).toFixed(1)}%)`)\r\n            lines.push('')\r\n            lines.push('ğŸ” æ£€æµ‹ç»“æœï¼š')\r\n            lines.push(`   â”œâ”€ å·¦é€’å½’é”™è¯¯: ${s.leftRecursionCount} ä¸ª`)\r\n            lines.push(`   â””â”€ Or åˆ†æ”¯é®è”½: ${s.orConflictCount} ä¸ª`)\r\n            lines.push(`   æ€»è®¡: ${this.errors.length} ä¸ªé”™è¯¯`)\r\n            lines.push('')\r\n            lines.push('ğŸ“¦ ç¼“å­˜ä¿¡æ¯ï¼š')\r\n            lines.push(`   â”œâ”€ dfsFirstKCache: ${s.dfsFirstKCacheSize} æ¡ (First(${s.firstK}))`)\r\n            lines.push(`   â””â”€ bfsAllCache: ${s.bfsAllCacheSize} æ¡ (MaxLevel)`)\r\n            \r\n            // è¾“å‡ºç¼“å­˜ä½¿ç”¨ç‡ï¼ˆç»Ÿä¸€æ ¼å¼ï¼‰\r\n            if (s.cacheUsage) {\r\n                lines.push('')\r\n                lines.push('ğŸ’¾ ç¼“å­˜ä½¿ç”¨ç‡ï¼š')\r\n                \r\n                // dfsFirstKCache\r\n                const dfs = s.cacheUsage.dfsFirstK\r\n                lines.push(`   dfsFirstKCache:`)\r\n                lines.push(`      æŸ¥è¯¢æ¬¡æ•°: ${dfs.getCount}`)\r\n                lines.push(`      å‘½ä¸­æ¬¡æ•°: ${dfs.hit}`)\r\n                lines.push(`      æœªå‘½ä¸­æ¬¡æ•°: ${dfs.miss}`)\r\n                lines.push(`      å‘½ä¸­ç‡: ${dfs.hitRate.toFixed(1)}%`)\r\n                lines.push(`      ç¼“å­˜æ€»æ¡æ•°: ${s.dfsFirstKCacheSize}`)\r\n                \r\n                // bfsAllCache\r\n                const bfsAll = s.cacheUsage.bfsAllCache\r\n                lines.push(`   bfsAllCache:`)\r\n                lines.push(`      æŸ¥è¯¢æ¬¡æ•°: ${bfsAll.getCount}`)\r\n                lines.push(`      å‘½ä¸­æ¬¡æ•°: ${bfsAll.hit}`)\r\n                lines.push(`      æœªå‘½ä¸­æ¬¡æ•°: ${bfsAll.miss}`)\r\n                lines.push(`      å‘½ä¸­ç‡: ${bfsAll.total > 0 ? bfsAll.hitRate.toFixed(1) : '0.0'}%`)\r\n                lines.push(`      ç¼“å­˜æ€»æ¡æ•°: ${bfsAll.size}`)\r\n                \r\n                // bfsLevelCache\r\n                const bfsLevel = s.cacheUsage.bfsLevelCache\r\n                lines.push(`   bfsLevelCache:`)\r\n                lines.push(`      æŸ¥è¯¢æ¬¡æ•°: ${bfsLevel.getCount}`)\r\n                lines.push(`      å‘½ä¸­æ¬¡æ•°: ${bfsLevel.hit}`)\r\n                lines.push(`      æœªå‘½ä¸­æ¬¡æ•°: ${bfsLevel.miss}`)\r\n                lines.push(`      å‘½ä¸­ç‡: ${bfsLevel.total > 0 ? bfsLevel.hitRate.toFixed(1) : 'N/A'}%`)\r\n                lines.push(`      ç¼“å­˜æ€»æ¡æ•°: ${bfsLevel.size}`)\r\n                \r\n                // getDirectChildren\r\n                const gdc = s.cacheUsage.getDirectChildren\r\n                if (gdc.total > 0) {\r\n                    lines.push(`   getDirectChildren (æ‡’åŠ è½½):`)\r\n                    lines.push(`      æŸ¥è¯¢æ¬¡æ•°: ${gdc.total}`)\r\n                    lines.push(`      å‘½ä¸­æ¬¡æ•°: ${gdc.hit}`)\r\n                    lines.push(`      æœªå‘½ä¸­æ¬¡æ•°: ${gdc.miss}`)\r\n                    lines.push(`      å‘½ä¸­ç‡: ${gdc.hitRate.toFixed(1)}%`)\r\n                    lines.push(`      ç¼“å­˜æ€»æ¡æ•°: ä¸ bfsLevelCache å…±ç”¨`)\r\n                }\r\n            }\r\n            \r\n            lines.push('')\r\n            lines.push('='.repeat(60))\r\n        }\r\n\r\n        return lines.join('\\n')\r\n    }\r\n}\r\n\r\n// ============================================\r\n// è§„åˆ™ AST å®šä¹‰\r\n// ============================================\r\n\r\n/**\r\n * è§„åˆ™èŠ‚ç‚¹ç±»å‹ï¼ˆè”åˆç±»å‹ï¼‰\r\n */\r\nexport type RuleNode =\r\n    | ConsumeNode\r\n    | SequenceNode\r\n    | OrNode\r\n    | OptionNode\r\n    | ManyNode\r\n    | AtLeastOneNode\r\n    | SubruleNode\r\n\r\n/**\r\n * Consume èŠ‚ç‚¹\r\n */\r\nexport interface ConsumeNode {\r\n    type: 'consume'\r\n    tokenName: string\r\n}\r\n\r\n/**\r\n * Sequence èŠ‚ç‚¹ï¼ˆé¡ºåºæ‰§è¡Œï¼‰\r\n */\r\nexport interface SequenceNode {\r\n    type: 'sequence'\r\n    ruleName?: string\r\n    nodes: RuleNode[]\r\n}\r\n\r\n/**\r\n * Or èŠ‚ç‚¹ï¼ˆé¡ºåºé€‰æ‹©ï¼‰\r\n */\r\nexport interface OrNode {\r\n    type: 'or'\r\n    alternatives: SequenceNode[]\r\n}\r\n\r\n/**\r\n * Option èŠ‚ç‚¹ï¼ˆ0æ¬¡æˆ–1æ¬¡ï¼‰\r\n */\r\nexport interface OptionNode {\r\n    type: 'option'\r\n    node: SequenceNode\r\n}\r\n\r\n/**\r\n * Many èŠ‚ç‚¹ï¼ˆ0æ¬¡æˆ–å¤šæ¬¡ï¼‰\r\n */\r\nexport interface ManyNode {\r\n    type: 'many'\r\n    node: SequenceNode\r\n}\r\n\r\n/**\r\n * AtLeastOne èŠ‚ç‚¹ï¼ˆ1æ¬¡æˆ–å¤šæ¬¡ï¼‰\r\n */\r\nexport interface AtLeastOneNode {\r\n    type: 'atLeastOne'\r\n    node: SequenceNode\r\n}\r\n\r\n/**\r\n * Subrule èŠ‚ç‚¹ï¼ˆè°ƒç”¨å…¶ä»–è§„åˆ™ï¼‰\r\n */\r\nexport interface SubruleNode {\r\n    type: 'subrule'\r\n    ruleName: string\r\n}\r\n\r\n// ============================================\r\n// è·¯å¾„ç±»å‹ï¼ˆå­—ç¬¦ä¸²ï¼‰\r\n// ============================================\r\n\r\n/**\r\n * è·¯å¾„ç±»å‹ï¼šæ‰å¹³åŒ–å­—ç¬¦ä¸²\r\n *\r\n * æ ¼å¼ï¼š'Token1,Token2,Token3,'\r\n *\r\n * ç¤ºä¾‹ï¼š\r\n * - 'Identifier,'\r\n * - 'Identifier,Dot,Identifier,'\r\n * - '' (ç©ºè·¯å¾„ï¼Œè¡¨ç¤º Option è·³è¿‡)\r\n */\r\nexport type Path = string\r\n\r\n\r\n\r\n","/**\r\n * Subhuti Grammar Validation - è§„åˆ™æ”¶é›†å™¨\r\n *\r\n * åŠŸèƒ½ï¼šæ”¶é›† Parser ä¸­æ‰€æœ‰è§„åˆ™çš„ AST ç»“æ„\r\n *\r\n * å®ç°æ–¹æ¡ˆï¼šä½¿ç”¨åŒå±‚Proxyæ‹¦æˆªParseræ–¹æ³•è°ƒç”¨ï¼Œè®°å½•è§„åˆ™ç»“æ„\r\n *\r\n * æ ¸å¿ƒåŸç†ï¼š\r\n * 1. **Parser Proxy**ï¼šæ‹¦æˆªè§„åˆ™æ–¹æ³•è°ƒç”¨ï¼ˆOr/Many/Option/AtLeastOne/å­è§„åˆ™ï¼‰\r\n * 2. **TokenConsumer Proxy**ï¼šæ‹¦æˆªtokenæ¶ˆè´¹è°ƒç”¨ï¼ˆLParen/RParen/Identifierç­‰ï¼‰\r\n * 3. **åŒå±‚Proxyçš„å¿…è¦æ€§**ï¼š\r\n *    - tokenConsumeræ˜¯ç‹¬ç«‹å¯¹è±¡ï¼Œä¸æ˜¯Parserçš„æ–¹æ³•\r\n *    - è§„åˆ™å†…éƒ¨é€šè¿‡this.tokenConsumer.XXX()æ¶ˆè´¹token\r\n *    - å¦‚æœåªæœ‰Parser Proxyï¼Œæ— æ³•æ‹¦æˆªtokenConsumerçš„æ–¹æ³•è°ƒç”¨\r\n *\r\n * å…³é”®æ”¹è¿›ï¼ˆç›¸æ¯”åˆå§‹ç‰ˆæœ¬ï¼‰ï¼š\r\n * 1. âœ… åŒæ—¶æ‹¦æˆªconsumeå’Œ_consumeTokenï¼ˆå…¼å®¹ä¸¤ç§è°ƒç”¨æ–¹å¼ï¼‰\r\n * 2. âœ… ä»£ç†tokenConsumerå¯¹è±¡ï¼ˆæ‹¦æˆªæ‰€æœ‰tokenæ¶ˆè´¹ï¼‰\r\n * 3. âœ… æ‹¦æˆªå­è§„åˆ™è°ƒç”¨ï¼ˆè®°å½•subruleèŠ‚ç‚¹ï¼‰\r\n * 4. âœ… ä¿®å¤thisç»‘å®šé—®é¢˜ï¼ˆæ‰€æœ‰handlerä½¿ç”¨proxyè€Œä¸æ˜¯targetï¼‰\r\n * 5. âœ… ä½¿ç”¨åˆ†ææ¨¡å¼ï¼ˆParserä¸æŠ›å¼‚å¸¸ï¼Œé¿å…ç”¨å¼‚å¸¸æ§åˆ¶æµç¨‹ï¼‰\r\n *\r\n * æ”¶é›†åˆ°çš„ASTç”¨é€”ï¼š\r\n * - æä¾›ç»™SubhutiGrammarAnalyzerè®¡ç®—è·¯å¾„ï¼ˆå±•å¼€subruleä¸ºå®é™…tokenåºåˆ—ï¼‰\r\n * - æä¾›ç»™SubhutiConflictDetectoræ£€æµ‹Oråˆ†æ”¯å†²çªï¼ˆåŸºäºtokenè·¯å¾„çš„å‰ç¼€æ£€æµ‹ï¼‰\r\n *\r\n * @version 3.0.0 - ä½¿ç”¨åˆ†ææ¨¡å¼ï¼Œä¸å†ä¾èµ–å¼‚å¸¸å¤„ç†\r\n */\r\n\r\nimport type SubhutiParser from \"../SubhutiParser\"\r\nimport type {ConsumeNode, RuleNode, SequenceNode} from \"./SubhutiValidationError\"\r\n\r\n/**\r\n * è§„åˆ™æ”¶é›†å™¨\r\n *\r\n * èŒè´£ï¼š\r\n * 1. å¯ç”¨ Parser çš„åˆ†ææ¨¡å¼ï¼ˆä¸æŠ›å¼‚å¸¸ï¼‰\r\n * 2. åˆ›å»º Parser çš„ Proxy ä»£ç†\r\n * 3. æ‹¦æˆª Or/Many/Option/AtLeastOne/consume æ–¹æ³•è°ƒç”¨\r\n * 4. è®°å½•è°ƒç”¨åºåˆ—å½¢æˆ AST\r\n *\r\n * ä¼˜åŠ¿ï¼š\r\n * - Parser ä»£ç å®Œå…¨å¹²å‡€ï¼Œæ— éœ€ä»»ä½•éªŒè¯ç›¸å…³ä»£ç \r\n * - éªŒè¯é€»è¾‘å®Œå…¨ç‹¬ç«‹ï¼Œæ˜“äºç»´æŠ¤\r\n * - ç”Ÿäº§ç¯å¢ƒé›¶æ€§èƒ½å¼€é”€\r\n * - ä¸ä½¿ç”¨å¼‚å¸¸æ§åˆ¶æµç¨‹ï¼Œæ€§èƒ½æ›´å¥½\r\n */\r\nexport class SubhutiRuleCollector {\r\n    /** æ”¶é›†åˆ°çš„è§„åˆ™ AST */\r\n    private ruleASTs = new Map<string, SequenceNode>()\r\n\r\n\r\n    private tokenAstCache = new Map<string, ConsumeNode>()\r\n\r\n    /** å½“å‰æ­£åœ¨è®°å½•çš„è§„åˆ™æ ˆ */\r\n    private currentRuleStack: SequenceNode[] = []\r\n\r\n    /** å½“å‰è§„åˆ™åç§° */\r\n    private currentRuleName: string = ''\r\n\r\n    /** æ˜¯å¦æ­£åœ¨æ‰§è¡Œé¡¶å±‚è§„åˆ™è°ƒç”¨ */\r\n    private isExecutingTopLevelRule: boolean = false\r\n\r\n    /** æ­£åœ¨æ‰§è¡Œçš„è§„åˆ™æ ˆï¼ˆç”¨äºæ£€æµ‹é€’å½’ï¼‰ */\r\n    private executingRuleStack: Set<string> = new Set()\r\n\r\n    /**\r\n     * æ”¶é›†æ‰€æœ‰è§„åˆ™ - é™æ€æ–¹æ³•\r\n     *\r\n     * @param parser Parser å®ä¾‹\r\n     * @returns è§„åˆ™åç§° â†’ AST çš„æ˜ å°„\r\n     */\r\n    static collectRules(parser: SubhutiParser): { cstMap: Map<string, SequenceNode>, tokenMap: Map<string, ConsumeNode> } {\r\n        const collector = new SubhutiRuleCollector()\r\n        return collector.collect(parser)\r\n    }\r\n\r\n    /**\r\n     * æ”¶é›†æ‰€æœ‰è§„åˆ™ï¼ˆç§æœ‰å®ç°ï¼‰\r\n     */\r\n    private collect(parser: SubhutiParser): { cstMap: Map<string, SequenceNode>, tokenMap: Map<string, ConsumeNode> } {\r\n        // âœ… å¯ç”¨åˆ†ææ¨¡å¼ï¼ˆä¸æŠ›å¼‚å¸¸ï¼‰\r\n        parser.enableAnalysisMode()\r\n\r\n        // åˆ›å»ºä»£ç†ï¼Œæ‹¦æˆªæ–¹æ³•è°ƒç”¨\r\n        const proxy = this.createAnalyzeProxy(parser)\r\n\r\n        // è·å–æ‰€æœ‰ @SubhutiRule æ–¹æ³•\r\n        const ruleNames = this.getAllRuleNames(parser)\r\n\r\n        // éå†æ‰§è¡Œæ¯ä¸ªè§„åˆ™\r\n        for (const ruleName of ruleNames) {\r\n            this.collectRule(proxy, ruleName)\r\n        }\r\n\r\n        // âœ… æ¢å¤æ­£å¸¸æ¨¡å¼\r\n        parser.disableAnalysisMode()\r\n\r\n        return {\r\n            cstMap: this.ruleASTs,\r\n            tokenMap: this.tokenAstCache\r\n        }\r\n    }\r\n\r\n    /**\r\n     * åˆ›å»ºåˆ†æä»£ç†ï¼ˆæ‹¦æˆª Parser æ–¹æ³•è°ƒç”¨ï¼‰\r\n     */\r\n    private createAnalyzeProxy(parser: SubhutiParser): SubhutiParser {\r\n        const collector = this\r\n\r\n        const proxy = new Proxy(parser, {\r\n            get(target: any, prop: string | symbol) {\r\n                // if (prop === 'Or' || prop === 'Arguments') {\r\n                //     console.log(`[PROXY] get: ${String(prop)}`)\r\n                // }\r\n\r\n                // æ‹¦æˆªæ ¸å¿ƒæ–¹æ³•\r\n                if (prop === 'Or') {\r\n                    const debugRules = ['ConditionalExpression', 'AssignmentExpression', 'Expression', 'Statement']\r\n                    const isDebugRule = debugRules.includes(collector.currentRuleName)\r\n\r\n                    return (alternatives: Array<{ alt: () => any }>) => {\r\n                        return collector.handleOr(alternatives, proxy)\r\n                    }\r\n                }\r\n                if (prop === 'Many') {\r\n                    return (fn: () => any) =>\r\n                        collector.handleMany(fn, proxy)\r\n                }\r\n                if (prop === 'Option') {\r\n                    return (fn: () => any) =>\r\n                        collector.handleOption(fn, proxy)\r\n                }\r\n                if (prop === 'AtLeastOne') {\r\n                    return (fn: () => any) =>\r\n                        collector.handleAtLeastOne(fn, proxy)\r\n                }\r\n                // æ‹¦æˆª consume å’Œ _consumeTokenï¼ˆå…¼å®¹ä¸¤ç§è°ƒç”¨æ–¹å¼ï¼‰\r\n                if (prop === 'consume' || prop === '_consumeToken') {\r\n                    return (tokenName: string) =>\r\n                        collector.handleConsume(tokenName)\r\n                }\r\n\r\n                // æ‹¦æˆª tokenConsumerï¼Œè¿”å›ä»£ç†å¯¹è±¡\r\n                if (prop === 'tokenConsumer') {\r\n                    const originalConsumer = Reflect.get(target, prop)\r\n                    return collector.createTokenConsumerProxy(originalConsumer)\r\n                }\r\n\r\n                // æ‹¦æˆªå­è§„åˆ™è°ƒç”¨ï¼ˆä»¥å¤§å†™å­—æ¯å¼€å¤´çš„æ–¹æ³•ï¼Œä½†æ’é™¤æ ¸å¿ƒæ–¹æ³•ï¼‰\r\n                const original = Reflect.get(target, prop)\r\n                const coreMethod = ['Or', 'Many', 'Option', 'AtLeastOne', 'consume', '_consumeToken', 'tokenConsumer']\r\n                if (typeof original === 'function' &&\r\n                    typeof prop === 'string' &&\r\n                    /^[A-Z]/.test(prop) &&\r\n                    !coreMethod.includes(prop)) {\r\n                    return function (...args: any[]) {\r\n                        const debugRules = ['ConditionalExpression', 'AssignmentExpression', 'Expression', 'Statement']\r\n                        const isDebugRule = debugRules.includes(prop)\r\n\r\n                        // å¦‚æœæ˜¯é¡¶å±‚è§„åˆ™è°ƒç”¨ï¼ˆæ”¶é›†è¯¥è§„åˆ™æœ¬èº«ï¼‰ï¼Œæ‰§è¡ŒåŸæ–¹æ³•\r\n                        if (collector.isExecutingTopLevelRule && prop === collector.currentRuleName) {\r\n                            collector.isExecutingTopLevelRule = false\r\n\r\n                            // æ£€æµ‹é€’å½’ï¼šå¦‚æœè§„åˆ™å·²åœ¨æ‰§è¡Œæ ˆä¸­ï¼Œè¯´æ˜æ˜¯é€’å½’è°ƒç”¨\r\n                            if (collector.executingRuleStack.has(prop)) {\r\n                                // è®°å½•é€’å½’è°ƒç”¨ï¼Œä½†ä¸æ‰§è¡Œï¼ˆé˜²æ­¢æ— é™é€’å½’ï¼‰\r\n                                return collector.handleSubrule(prop)\r\n                            }\r\n\r\n                            // å°†è§„åˆ™åŠ å…¥æ‰§è¡Œæ ˆ\r\n                            collector.executingRuleStack.add(prop)\r\n\r\n                            try {\r\n                                // è·å–åŸå§‹å‡½æ•°ï¼ˆç»•è¿‡è£…é¥°å™¨ï¼‰ï¼Œåœ¨ proxy ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ\r\n                                const originalFun = (original as any).__originalFunction__ || original\r\n\r\n                                // åœ¨ proxy ä¸Šä¸‹æ–‡ä¸­æ‰§è¡ŒåŸå§‹å‡½æ•°\r\n                                const result = originalFun.call(proxy, ...args)\r\n\r\n                                return result\r\n                            } finally {\r\n                                // æ‰§è¡Œå®Œæˆåï¼Œä»æ‰§è¡Œæ ˆä¸­ç§»é™¤\r\n                                collector.executingRuleStack.delete(prop)\r\n                            }\r\n                        }\r\n\r\n                        // å¦‚æœæ˜¯å­è§„åˆ™è°ƒç”¨ï¼Œåªè®°å½•ï¼Œä¸æ‰§è¡Œ\r\n                        return collector.handleSubrule(prop)\r\n                    }\r\n                }\r\n\r\n                // å…¶ä»–å±æ€§/æ–¹æ³•ä¿æŒåŸæ ·\r\n                return original\r\n            }\r\n        })\r\n\r\n        return proxy\r\n    }\r\n\r\n    /**\r\n     * åˆ›å»º TokenConsumer ä»£ç†ï¼ˆæ‹¦æˆª token æ¶ˆè´¹è°ƒç”¨ï¼‰\r\n     */\r\n    private createTokenConsumerProxy(tokenConsumer: any): any {\r\n        const collector = this\r\n\r\n        return new Proxy(tokenConsumer, {\r\n            get(target: any, prop: string | symbol) {\r\n                const original = Reflect.get(target, prop)\r\n\r\n                // æ‹¦æˆªæ‰€æœ‰æ–¹æ³•è°ƒç”¨ï¼ˆé™¤äº†ç‰¹æ®Šå±æ€§ï¼‰\r\n                if (typeof original === 'function' && typeof prop === 'string') {\r\n                    return function (...args: any[]) {\r\n                        // è®°å½• token æ¶ˆè´¹ï¼ˆæ–¹æ³•åå³ token åï¼‰\r\n                        collector.handleConsume(prop)\r\n\r\n                        // ä¸éœ€è¦æ‰§è¡ŒåŸæ–¹æ³•ï¼Œå› ä¸ºæˆ‘ä»¬åªæ˜¯æ”¶é›† AST ç»“æ„\r\n                        // ç›´æ¥è¿”å› undefined\r\n                        return undefined\r\n\r\n                        // // å°è¯•æ‰§è¡ŒåŸæ–¹æ³•ï¼Œä½†æ•è·å¼‚å¸¸\r\n                        // try {\r\n                        //     return original.apply(target, args)\r\n                        // } catch (error: any) {\r\n                        //     // æ¶ˆè´¹å¤±è´¥ï¼ˆç¼ºå°‘tokenï¼‰ï¼Œä½†æˆ‘ä»¬å·²ç»è®°å½•äº†consumeè°ƒç”¨\r\n                        //     // è¿”å›undefinedï¼Œè®©è§„åˆ™ç»§ç»­æ‰§è¡Œ\r\n                        //     return undefined\r\n                        // }\r\n                    }\r\n                }\r\n\r\n                return original\r\n            }\r\n        })\r\n    }\r\n\r\n    /**\r\n     * æ”¶é›†å•ä¸ªè§„åˆ™\r\n     *\r\n     * å¼‚å¸¸å¤„ç†è¯´æ˜ï¼š\r\n     * - âœ… Parser åœ¨åˆ†ææ¨¡å¼ä¸‹ä¸ä¼šæŠ›å‡ºè§£æç›¸å…³çš„å¼‚å¸¸ï¼ˆå·¦é€’å½’ã€æ— é™å¾ªç¯ã€Token æ¶ˆè´¹å¤±è´¥ç­‰ï¼‰\r\n     * - âœ… ä½†ä»éœ€ try-catch æ•è·ä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼ˆå¦‚åºŸå¼ƒæ–¹æ³•ä¸»åŠ¨æŠ›å‡ºçš„ Errorï¼‰\r\n     * - âœ… å³ä½¿æŠ›å‡ºé”™è¯¯ï¼ŒProxy ä¹Ÿå·²ç»æ”¶é›†åˆ°äº†éƒ¨åˆ† ASTï¼Œä»ç„¶ä¿å­˜\r\n     *\r\n     * è¿™ä¸ä¹‹å‰çš„è®¾è®¡ä¸åŒï¼š\r\n     * - ä¹‹å‰ï¼šä¾èµ–å¼‚å¸¸æ¥æ§åˆ¶æµç¨‹ï¼ˆä¸å¥½çš„è®¾è®¡ï¼‰\r\n     * - ç°åœ¨ï¼šåªæ•è·çœŸæ­£çš„ä¸šåŠ¡é”™è¯¯ï¼ˆæ­£å¸¸çš„å¼‚å¸¸å¤„ç†ï¼‰\r\n     */\r\n    private collectRule(proxy: SubhutiParser, ruleName: string): void {\r\n        // â±ï¸ è®°å½•å¼€å§‹æ—¶é—´\r\n        const startTime = Date.now()\r\n\r\n        // é‡ç½®çŠ¶æ€\r\n        this.currentRuleName = ruleName\r\n        this.currentRuleStack = []\r\n        this.isExecutingTopLevelRule = false\r\n\r\n        // åˆ›å»ºæ ¹ Sequence èŠ‚ç‚¹\r\n        const rootNode: SequenceNode = {\r\n            type: 'sequence',\r\n            ruleName: ruleName,\r\n            nodes: []\r\n        }\r\n        this.currentRuleStack.push(rootNode)\r\n\r\n        try {\r\n            // æ‰§è¡Œè§„åˆ™ï¼ˆåˆ†ææ¨¡å¼ä¸‹ä¼šè®°å½•è°ƒç”¨ï¼Œä¸ä¼šæŠ›è§£æå¼‚å¸¸ï¼‰\r\n            // æ³¨æ„ï¼šè¿™é‡Œè°ƒç”¨proxyçš„æ–¹æ³•ï¼Œè®©å†…éƒ¨çš„å­è§„åˆ™è°ƒç”¨è¢«æ‹¦æˆª\r\n            const ruleMethod = (proxy as any)[ruleName]\r\n            if (typeof ruleMethod === 'function') {\r\n                this.isExecutingTopLevelRule = true\r\n                ruleMethod.call(proxy)\r\n                this.isExecutingTopLevelRule = false\r\n            }\r\n\r\n            // ä¿å­˜ AST\r\n            this.ruleASTs.set(ruleName, rootNode)\r\n\r\n            // â±ï¸ è®¡ç®—è€—æ—¶\r\n            const elapsed = Date.now() - startTime\r\n\r\n            // å¦‚æœè¶…è¿‡10ç§’ï¼Œè¾“å‡ºè­¦å‘Š\r\n            if (elapsed > 10000) {\r\n                console.error(`âŒâŒâŒ Rule \"${ruleName}\" took ${elapsed}ms (${(elapsed / 1000).toFixed(2)}s) - EXTREMELY SLOW!`)\r\n            }\r\n        } catch (error: any) {\r\n            // æ•è·ä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼ˆå¦‚åºŸå¼ƒæ–¹æ³•ã€æœªå®ç°æ–¹æ³•ç­‰ï¼‰\r\n            // å³ä½¿æŠ›å‡ºé”™è¯¯ï¼Œæˆ‘ä»¬ä¹Ÿå·²ç»é€šè¿‡ Proxy æ”¶é›†åˆ°äº†éƒ¨åˆ† AST\r\n            this.ruleASTs.set(ruleName, rootNode)\r\n\r\n            // â±ï¸ è®¡ç®—è€—æ—¶\r\n            const elapsed = Date.now() - startTime\r\n\r\n            // è§„åˆ™æ”¶é›†å¤±è´¥ï¼Œä½†å·²ä¿å­˜éƒ¨åˆ† ASTï¼ˆä¸è¾“å‡ºæ—¥å¿—ï¼‰\r\n        }\r\n    }\r\n\r\n    /**\r\n     * è·å–æ‰€æœ‰è§„åˆ™åç§°ï¼ˆéå†æ•´ä¸ªåŸå‹é“¾ï¼Œåªæ”¶é›†è¢« @SubhutiRule è£…é¥°çš„æ–¹æ³•ï¼‰\r\n     *\r\n     * é€šè¿‡æ£€æŸ¥ __isSubhutiRule__ å…ƒæ•°æ®æ ‡è®°æ¥åŒºåˆ†è§„åˆ™æ–¹æ³•å’Œæ™®é€šæ–¹æ³•\r\n     */\r\n    private getAllRuleNames(parser: SubhutiParser): string[] {\r\n        const ruleNames = new Set<string>()\r\n        let prototype = Object.getPrototypeOf(parser)\r\n\r\n        // éå†æ•´ä¸ªåŸå‹é“¾ï¼Œç›´åˆ° Object.prototype\r\n        while (prototype && prototype !== Object.prototype) {\r\n            // éå†å½“å‰åŸå‹çš„æ‰€æœ‰æ–¹æ³•\r\n            for (const key of Object.getOwnPropertyNames(prototype)) {\r\n                if (key === 'constructor') continue\r\n\r\n                const descriptor = Object.getOwnPropertyDescriptor(prototype, key)\r\n                if (descriptor && typeof descriptor.value === 'function') {\r\n                    // âœ… æ£€æŸ¥æ˜¯å¦æ˜¯ @SubhutiRule è£…é¥°çš„æ–¹æ³•\r\n                    const method = descriptor.value\r\n                    if (method.__isSubhutiRule__ === true) {\r\n                        ruleNames.add(key)\r\n                    }\r\n                }\r\n            }\r\n\r\n            // ç§»åŠ¨åˆ°çˆ¶ç±»åŸå‹\r\n            prototype = Object.getPrototypeOf(prototype)\r\n        }\r\n\r\n        return Array.from(ruleNames)\r\n    }\r\n\r\n    // ============================================\r\n    // Proxy æ‹¦æˆªæ–¹æ³•\r\n    // ============================================\r\n\r\n    /**\r\n     * å¤„ç† Or è§„åˆ™\r\n     */\r\n    private handleOr(alternatives: Array<{ alt: () => any }>, target: any): void {\r\n        const altNodes: any[] = []\r\n\r\n        for (let i = 0; i < alternatives.length; i++) {\r\n            const alt = alternatives[i]\r\n            // è¿›å…¥æ–°çš„åºåˆ—\r\n            const seqNode: SequenceNode = {type: 'sequence', nodes: []}\r\n            this.currentRuleStack.push(seqNode)\r\n\r\n            try {\r\n                // æ‰§è¡Œåˆ†æ”¯ï¼ˆä¼šé€šè¿‡ proxy æ‹¦æˆªï¼‰\r\n                alt.alt.call(target)\r\n\r\n                // é€€å‡ºåºåˆ—ï¼Œè·å–ç»“æœ\r\n                const result = this.currentRuleStack.pop()\r\n                if (result) {\r\n                    altNodes.push(result)\r\n                }\r\n            } catch (error: any) {\r\n                // åˆ†æ”¯æ‰§è¡Œå¤±è´¥ï¼ˆå¯èƒ½æ˜¯ç¼ºå°‘tokenæˆ–å…¶ä»–é”™è¯¯ï¼‰\r\n                // ä½†æˆ‘ä»¬ä»ç„¶å°è¯•ä¿å­˜å·²æ”¶é›†çš„éƒ¨åˆ†AST\r\n                const result = this.currentRuleStack.pop()\r\n                if (result && result.nodes && result.nodes.length > 0) {\r\n                    // å¦‚æœæ”¶é›†åˆ°äº†éƒ¨åˆ†èŠ‚ç‚¹ï¼Œä»ç„¶ä¿å­˜\r\n                    altNodes.push(result)\r\n                }\r\n                // æ³¨æ„ï¼šæˆ‘ä»¬ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªåˆ†æ”¯\r\n            }\r\n        }\r\n\r\n        // è®°å½• Or èŠ‚ç‚¹ï¼ˆå³ä½¿æŸäº›åˆ†æ”¯å¤±è´¥ï¼Œåªè¦æœ‰è‡³å°‘ä¸€ä¸ªåˆ†æ”¯æˆåŠŸï¼‰\r\n        if (altNodes.length > 0) {\r\n            this.recordNode({type: 'or', alternatives: altNodes})\r\n        }\r\n    }\r\n\r\n    /**\r\n     * å¤„ç† Many è§„åˆ™\r\n     */\r\n    private handleMany(fn: () => any, target: any): void {\r\n        const seqNode: SequenceNode = {type: 'sequence', nodes: []}\r\n        this.currentRuleStack.push(seqNode)\r\n\r\n        try {\r\n            // æ‰§è¡Œä¸€æ¬¡ï¼ˆæ”¶é›†å†…éƒ¨ç»“æ„ï¼‰\r\n            fn.call(target)\r\n\r\n            const innerNode = this.currentRuleStack.pop()\r\n            if (innerNode) {\r\n                this.recordNode({type: 'many', node: innerNode})\r\n            }\r\n        } catch (error: any) {\r\n            // æ‰§è¡Œå¤±è´¥ï¼Œä½†ä»ç„¶å°è¯•ä¿å­˜å·²æ”¶é›†çš„éƒ¨åˆ†\r\n            const innerNode = this.currentRuleStack.pop()\r\n            if (innerNode && innerNode.nodes && innerNode.nodes.length > 0) {\r\n                this.recordNode({type: 'many', node: innerNode})\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * å¤„ç† Option è§„åˆ™\r\n     */\r\n    private handleOption(fn: () => any, target: any): void {\r\n        const seqNode: SequenceNode = {type: 'sequence', nodes: []}\r\n        this.currentRuleStack.push(seqNode)\r\n\r\n        try {\r\n            fn.call(target)\r\n\r\n            const innerNode = this.currentRuleStack.pop()\r\n            if (innerNode) {\r\n                this.recordNode({type: 'option', node: innerNode})\r\n            }\r\n        } catch (error: any) {\r\n            // æ‰§è¡Œå¤±è´¥ï¼Œä½†ä»ç„¶å°è¯•ä¿å­˜å·²æ”¶é›†çš„éƒ¨åˆ†\r\n            const innerNode = this.currentRuleStack.pop()\r\n            if (innerNode && innerNode.nodes && innerNode.nodes.length > 0) {\r\n                this.recordNode({type: 'option', node: innerNode})\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * å¤„ç† AtLeastOne è§„åˆ™\r\n     */\r\n    private handleAtLeastOne(fn: () => any, target: any): void {\r\n        const seqNode: SequenceNode = {type: 'sequence', nodes: []}\r\n        this.currentRuleStack.push(seqNode)\r\n\r\n        try {\r\n            fn.call(target)\r\n\r\n            const innerNode = this.currentRuleStack.pop()\r\n            if (innerNode) {\r\n                this.recordNode({type: 'atLeastOne', node: innerNode})\r\n            }\r\n        } catch (error: any) {\r\n            // æ‰§è¡Œå¤±è´¥ï¼Œä½†ä»ç„¶å°è¯•ä¿å­˜å·²æ”¶é›†çš„éƒ¨åˆ†\r\n            const innerNode = this.currentRuleStack.pop()\r\n            if (innerNode && innerNode.nodes && innerNode.nodes.length > 0) {\r\n                this.recordNode({type: 'atLeastOne', node: innerNode})\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * å¤„ç† consume\r\n     */\r\n    private handleConsume(tokenName: string): void {\r\n        const tokenNode: ConsumeNode = {type: 'consume', tokenName}\r\n        this.tokenAstCache.set(tokenName, tokenNode)\r\n        this.recordNode(tokenNode)\r\n    }\r\n\r\n    /**\r\n     * å¤„ç†å­è§„åˆ™è°ƒç”¨\r\n     */\r\n    private handleSubrule(ruleName: string): any {\r\n        this.recordNode({type: 'subrule', ruleName})\r\n    }\r\n\r\n    /**\r\n     * è®°å½•èŠ‚ç‚¹åˆ°å½“å‰åºåˆ—\r\n     */\r\n    private recordNode(node: RuleNode): void {\r\n        const currentSeq = this.currentRuleStack[this.currentRuleStack.length - 1]\r\n        if (currentSeq) {\r\n            currentSeq.nodes.push(node)\r\n        }\r\n    }\r\n}\r\n\r\n","/**\r\n * å‰ç¼€æ ‘èŠ‚ç‚¹ï¼ˆé’ˆå¯¹å­—ç¬¦ä¸²æ•°ç»„ï¼‰\r\n *\r\n * æ ¸å¿ƒè®¾è®¡ï¼š\r\n * - children: Map<string, ArrayTrieNode> - å­˜å‚¨å­èŠ‚ç‚¹ï¼Œkey æ˜¯ tokenï¼ˆå­—ç¬¦ä¸²ï¼‰\r\n * - fullPaths: string[][] - å­˜å‚¨æ‰€æœ‰ç»è¿‡æ­¤èŠ‚ç‚¹çš„å®Œæ•´è·¯å¾„\r\n *\r\n * ç¤ºä¾‹ï¼š\r\n * è·¯å¾„ [\"If\", \"LParen\", \"Expression\"] ä¼šåˆ›å»ºï¼š\r\n * root -> \"If\" -> \"LParen\" -> \"Expression\"\r\n * æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šå­˜å‚¨å®Œæ•´è·¯å¾„çš„å¼•ç”¨\r\n */\r\nclass ArrayTrieNode {\r\n    /** å­èŠ‚ç‚¹æ˜ å°„ï¼štokenï¼ˆå­—ç¬¦ä¸²ï¼‰-> å­èŠ‚ç‚¹ */\r\n    children = new Map<string, ArrayTrieNode>()\r\n\r\n    /** å­˜å‚¨æ‰€æœ‰ç»è¿‡æ­¤èŠ‚ç‚¹çš„å®Œæ•´è·¯å¾„ï¼ˆç”¨äºå¿«é€ŸæŸ¥æ‰¾ï¼‰ */\r\n    fullPaths: string[][] = []\r\n}\r\n\r\n/**\r\n * å­—ç¬¦ä¸²æ•°ç»„å‰ç¼€æ ‘\r\n *\r\n * æ ¸å¿ƒåŸç†ï¼š\r\n * 1. å°†å­—ç¬¦ä¸²æ•°ç»„ä¸­çš„æ¯ä¸ªå­—ç¬¦ä¸²å½“ä½œåŸºæœ¬å•å…ƒï¼ˆç±»ä¼¼å­—ç¬¦ï¼‰\r\n * 2. æ„å»ºæ ‘å½¢ç»“æ„ï¼Œå…±äº«ç›¸åŒå‰ç¼€\r\n * 3. æŸ¥è¯¢æ—¶åªéœ€éå†å‰ç¼€çš„ tokenï¼Œæ— éœ€éå†æ‰€æœ‰è·¯å¾„\r\n */\r\nexport default class ArrayTrie {\r\n    private root = new ArrayTrieNode()\r\n\r\n    /**\r\n     * æ’å…¥è·¯å¾„åˆ°å‰ç¼€æ ‘\r\n     *\r\n     * æ ¸å¿ƒé€»è¾‘ï¼š\r\n     * 1. ä» root å¼€å§‹\r\n     * 2. éå†è·¯å¾„çš„æ¯ä¸ª tokenï¼ˆå­—ç¬¦ä¸²ï¼‰\r\n     * 3. å¦‚æœå­èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°èŠ‚ç‚¹\r\n     * 4. ç§»åŠ¨åˆ°å­èŠ‚ç‚¹\r\n     * 5. åœ¨æ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨å®Œæ•´è·¯å¾„çš„å¼•ç”¨\r\n     *\r\n     * æ—¶é—´å¤æ‚åº¦ï¼šO(k)ï¼Œk=è·¯å¾„é•¿åº¦ï¼ˆtokenæ•°ï¼‰\r\n     */\r\n    insert(path: string[]): void {\r\n        let node = this.root\r\n\r\n        // éå†æ¯ä¸ª tokenï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼Œæ„å»ºæ ‘è·¯å¾„\r\n        for (const ruleName of path) {\r\n            // å¦‚æœå­èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°èŠ‚ç‚¹\r\n            if (!node.children.has(ruleName)) {\r\n                node.children.set(ruleName, new ArrayTrieNode())\r\n            }\r\n\r\n            // ç§»åŠ¨åˆ°å­èŠ‚ç‚¹\r\n            node = node.children.get(ruleName)!\r\n\r\n            // ğŸ”´ æ ¸å¿ƒï¼šåœ¨æ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨å®Œæ•´è·¯å¾„ï¼ˆç”¨äºå¿«é€ŸæŸ¥æ‰¾ï¼‰\r\n            // è¿™æ ·æŸ¥è¯¢æ—¶å¯ä»¥ç›´æ¥è·å–æ‰€æœ‰ç»è¿‡æ­¤èŠ‚ç‚¹çš„å®Œæ•´è·¯å¾„\r\n            node.fullPaths.push(path)\r\n        }\r\n    }\r\n\r\n    /**\r\n     * æŸ¥æ‰¾å®Œå…¨ç›¸åŒçš„è·¯å¾„\r\n     */\r\n    findEqual(path: string[]): string[] | null {\r\n        let node = this.root\r\n\r\n        // æ²¿ç€è·¯å¾„å‘ä¸‹éå†\r\n        for (const token of path) {\r\n            if (!node.children.has(token)) {\r\n                return null  // è·¯å¾„ä¸å­˜åœ¨\r\n            }\r\n            node = node.children.get(token)!\r\n        }\r\n\r\n        // æ£€æŸ¥ fullPaths ä¸­æ˜¯å¦æœ‰å®Œå…¨ç›¸åŒçš„è·¯å¾„\r\n        for (const fullPath of node.fullPaths) {\r\n            // ğŸ”´ ä½¿ç”¨æå–çš„ isEqual æ–¹æ³•\r\n            if (this.isEqual(path, fullPath)) {\r\n                return fullPath\r\n            }\r\n        }\r\n\r\n        return null\r\n    }\r\n\r\n    /**\r\n     * æŸ¥æ‰¾ä»¥ prefix ä¸ºå‰ç¼€çš„è·¯å¾„ï¼ˆä¸”ä¸ç­‰äº prefixï¼‰\r\n     *\r\n     * æ ¸å¿ƒé€»è¾‘ï¼š\r\n     * 1. ä» root å¼€å§‹\r\n     * 2. æ²¿ç€ prefix çš„æ¯ä¸ª token å‘ä¸‹éå†\r\n     * 3. å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”çš„å­èŠ‚ç‚¹ï¼Œè¿”å› null\r\n     * 4. æ‰¾åˆ°å‰ç¼€èŠ‚ç‚¹åï¼Œæ£€æŸ¥ fullPaths ä¸­æ˜¯å¦æœ‰æ›´é•¿çš„è·¯å¾„\r\n     * 5. è¿”å›ç¬¬ä¸€ä¸ªåŒ¹é…çš„å®Œæ•´è·¯å¾„\r\n     *\r\n     * æ—¶é—´å¤æ‚åº¦ï¼šO(k)ï¼Œk=å‰ç¼€é•¿åº¦ï¼ˆtokenæ•°ï¼‰\r\n     */\r\n    findPrefixMatch(prefix: string[]): string[] | null {\r\n        let node = this.root\r\n\r\n        // ğŸ”´ æ ¸å¿ƒï¼šæ²¿ç€å‰ç¼€è·¯å¾„å‘ä¸‹éå†\r\n        for (const token of prefix) {\r\n            // å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”çš„å­èŠ‚ç‚¹ï¼Œè¯´æ˜æ²¡æœ‰åŒ¹é…çš„å‰ç¼€\r\n            if (!node.children.has(token)) {\r\n                return null\r\n            }\r\n\r\n            // ç§»åŠ¨åˆ°å­èŠ‚ç‚¹\r\n            node = node.children.get(token)!\r\n        }\r\n\r\n        // ğŸ”´ æ ¸å¿ƒï¼šæ‰¾åˆ°å‰ç¼€èŠ‚ç‚¹ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ›´é•¿çš„è·¯å¾„\r\n        // fullPaths ä¸­å­˜å‚¨çš„æ˜¯æ‰€æœ‰ç»è¿‡æ­¤èŠ‚ç‚¹çš„å®Œæ•´è·¯å¾„\r\n        for (const fullPath of node.fullPaths) {\r\n            // ç¡®ä¿ä¸æ˜¯å®Œå…¨ç›¸åŒï¼ˆå®Œå…¨ç›¸åŒä¸ç®—å‰ç¼€å…³ç³»ï¼‰\r\n            // ç¡®ä¿ fullPath ç¡®å®ä»¥ prefix å¼€å¤´ï¼ˆé˜²å¾¡æ€§æ£€æŸ¥ï¼‰\r\n            if (this.isPrefix(prefix, fullPath)) {\r\n                return fullPath\r\n            }\r\n        }\r\n\r\n        // æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è·¯å¾„\r\n        return null\r\n    }\r\n\r\n    /**\r\n     * æ£€æŸ¥ä¸¤ä¸ªè·¯å¾„æ•°ç»„æ˜¯å¦å®Œå…¨ç›¸åŒ\r\n     *\r\n     * æ ¸å¿ƒé€»è¾‘ï¼š\r\n     * 1. é•¿åº¦å¿…é¡»ç›¸åŒ\r\n     * 2. é€ä¸ªæ¯”è¾ƒ tokenï¼Œå¿…é¡»å®Œå…¨ç›¸åŒ\r\n     *\r\n     * æ—¶é—´å¤æ‚åº¦ï¼šO(k)ï¼Œk=è·¯å¾„é•¿åº¦\r\n     *\r\n     * @returns å¦‚æœä¸¤ä¸ªè·¯å¾„å®Œå…¨ç›¸åŒè¿”å› trueï¼Œå¦åˆ™è¿”å› false\r\n     * @param prefix\r\n     * @param fullPath\r\n     */\r\n    private isEqual(prefix: string[], fullPath: string[]): boolean {\r\n        // é•¿åº¦å¿…é¡»ç›¸åŒ\r\n        if (prefix.length !== fullPath.length) {\r\n            return false\r\n        }\r\n\r\n        // ğŸ”´ æ ¸å¿ƒï¼šé€ä¸ªæ¯”è¾ƒ token\r\n        for (let i = 0; i < prefix.length; i++) {\r\n            if (prefix[i] !== fullPath[i]) {\r\n                return false\r\n            }\r\n        }\r\n\r\n        return true\r\n    }\r\n\r\n    /**\r\n     * æ£€æŸ¥ prefix æ˜¯å¦æ˜¯ fullPath çš„å‰ç¼€\r\n     *\r\n     * æ ¸å¿ƒé€»è¾‘ï¼š\r\n     * 1. å‰ç¼€å¿…é¡»æ¯”å®Œæ•´è·¯å¾„çŸ­\r\n     * 2. é€ä¸ªæ¯”è¾ƒ tokenï¼Œå¿…é¡»å®Œå…¨ç›¸åŒ\r\n     *\r\n     * æ—¶é—´å¤æ‚åº¦ï¼šO(k)ï¼Œk=å‰ç¼€é•¿åº¦\r\n     */\r\n    private isPrefix(prefix: string[], fullPath: string[]): boolean {\r\n        // ğŸ”´ ä¿®å¤ï¼šå‰ç¼€å¿…é¡»æ¯”å®Œæ•´è·¯å¾„çŸ­ï¼ˆå‰ç¼€é•¿åº¦ < å®Œæ•´è·¯å¾„é•¿åº¦ï¼‰\r\n        if (fullPath.length < prefix.length) {\r\n            return false\r\n        }\r\n\r\n        // ğŸ”´ æ ¸å¿ƒï¼šé€ä¸ªæ¯”è¾ƒ tokenï¼ˆåªæ¯”è¾ƒå‰ç¼€çš„é•¿åº¦ï¼‰\r\n        for (let i = 0; i < prefix.length; i++) {\r\n            if (prefix[i] !== fullPath[i]) {\r\n                return false\r\n            }\r\n        }\r\n\r\n        return true\r\n    }\r\n}","/**\r\n * Subhuti Grammar Validation - è¯­æ³•åˆ†æå™¨\r\n *\r\n * åŠŸèƒ½ï¼šè®¡ç®—è§„åˆ™çš„æ‰€æœ‰å¯èƒ½è·¯å¾„ï¼ˆæŒ‰å±‚çº§å±•å¼€ï¼‰\r\n *\r\n * å®ç°æ–¹æ¡ˆï¼šæ–¹æ¡ˆB - æŒ‰æœ€å¤§å±‚çº§å±•å¼€ï¼Œåˆ†å±‚å­˜å‚¨\r\n *\r\n * æ ¸å¿ƒåŸç†ï¼š\r\n * 1. **åˆ†å±‚å±•å¼€**ï¼šä¸å†å®Œå…¨å±•å¼€åˆ°tokenï¼Œè€Œæ˜¯æŒ‰å±‚çº§é€æ­¥å±•å¼€\r\n *    - Level 0: ç›´æ¥å­èŠ‚ç‚¹ï¼ˆå¯èƒ½æ˜¯tokenæˆ–è§„åˆ™å¼•ç”¨ï¼‰\r\n *    - Level 1: å±•å¼€ä¸€å±‚è§„åˆ™å¼•ç”¨\r\n *    - Level N: å±•å¼€Nå±‚è§„åˆ™å¼•ç”¨\r\n *\r\n * 2. **ç¼“å­˜ç­–ç•¥**ï¼šåªç¼“å­˜è§„åˆ™çš„ç›´æ¥å­èŠ‚ç‚¹ï¼Œä¸é€’å½’å±•å¼€\r\n *    - cache.set(\"A\", [ç›´æ¥å­èŠ‚ç‚¹])\r\n *    - ä½¿ç”¨æ—¶æŒ‰éœ€é€’å½’æŸ¥æ‰¾å’Œå±•å¼€\r\n *\r\n * 3. **åˆ†å±‚å­˜å‚¨**ï¼šæ¯ä¸ªè§„åˆ™å­˜å‚¨å¤šå±‚å±•å¼€ç»“æœ\r\n *    - expansion[0]: ç¬¬1å±‚çš„æ‰€æœ‰åˆ†æ”¯\r\n *    - expansion[1]: ç¬¬2å±‚çš„æ‰€æœ‰åˆ†æ”¯\r\n *    - expansion[N]: ç¬¬Nå±‚çš„æ‰€æœ‰åˆ†æ”¯\r\n *\r\n * 4. **æ€§èƒ½ä¼˜åŒ–**ï¼š\r\n *    - åªå±•å¼€åˆ°é…ç½®çš„æœ€å¤§å±‚çº§ï¼ˆé»˜è®¤3å±‚ï¼‰\r\n *    - æ¯å±‚ç‹¬ç«‹å­˜å‚¨ï¼Œé¿å…é‡å¤è®¡ç®—\r\n *    - è·¯å¾„æ•°é‡é™åˆ¶ï¼šé»˜è®¤10000æ¡ï¼ˆé˜²æ­¢è·¯å¾„çˆ†ç‚¸ï¼‰\r\n *\r\n * âš ï¸âš ï¸âš ï¸ å…³é”®ï¼šç©ºåˆ†æ”¯ [] çš„å¤„ç† âš ï¸âš ï¸âš ï¸\r\n *\r\n * ç©ºåˆ†æ”¯æ¥æºï¼š\r\n * - option(X) å’Œ many(X) ä¼šäº§ç”Ÿç©ºåˆ†æ”¯ []ï¼Œè¡¨ç¤ºå¯ä»¥è·³è¿‡ï¼ˆ0æ¬¡ï¼‰\r\n * - ç©ºåˆ†æ”¯åœ¨å±•å¼€ç»“æœä¸­è¡¨ç¤ºä¸º []ï¼ˆç©ºæ•°ç»„ï¼‰\r\n *\r\n * ç©ºåˆ†æ”¯çš„é‡è¦æ€§ï¼š\r\n * - ç©ºåˆ†æ”¯å¿…é¡»ä¿ç•™ï¼Œå¦åˆ™ option/many çš„è¯­ä¹‰å°±é”™äº†ï¼\r\n * - ä¾‹å¦‚ï¼šoption(a) çš„ First é›†åˆ = {Îµ, a}\r\n * - å¦‚æœè¿‡æ»¤æ‰ç©ºåˆ†æ”¯ï¼Œå°±å˜æˆ First é›†åˆ = {a}ï¼Œè¯­ä¹‰é”™è¯¯ï¼\r\n *\r\n * ç©ºåˆ†æ”¯åœ¨å„ä¸ªå¤„ç†ç¯èŠ‚çš„è¡Œä¸ºï¼š\r\n * 1. deduplicateï¼š\r\n *  *    - [] join(RuleJoinSymbol) = \"\"ï¼ˆç©ºå­—ç¬¦ä¸²ï¼‰\r\n *    - ç©ºå­—ç¬¦ä¸²æ˜¯åˆæ³•çš„ Set keyï¼Œä¸ä¼šè¢«è¿‡æ»¤\r\n *    - ä¾‹å¦‚ï¼š[[], [a], []] â†’ [[], [a]]ï¼ˆæ­£å¸¸å»é‡ï¼‰\r\n *\r\n * 2. cartesianProductï¼š\r\n *    - [...seq, ...[]] = [...seq]ï¼ˆç©ºåˆ†æ”¯æ‹¼æ¥ä¸å½±å“ç»“æœï¼‰\r\n *    - [...[], ...branch] = [...branch]ï¼ˆç©ºåºåˆ—æ‹¼æ¥ï¼‰\r\n *    - ä¾‹å¦‚ï¼š[[a]] Ã— [[], [b]] â†’ [[a], [a,b]]ï¼ˆæ­£å¸¸ç¬›å¡å°”ç§¯ï¼‰\r\n *\r\n * 3. truncateAndDeduplicateï¼š\r\n *    - [] slice(0, firstK) = []ï¼ˆç©ºåˆ†æ”¯æˆªå–è¿˜æ˜¯ç©ºåˆ†æ”¯ï¼‰\r\n *    - ä¾‹å¦‚ï¼š[[], [a,b]], firstK=1 â†’ [[], [a]]ï¼ˆæ­£å¸¸æˆªå–ï¼‰\r\n *\r\n * 4. expandSequenceNodeï¼š\r\n *    - ç©ºåˆ†æ”¯å‚ä¸ç¬›å¡å°”ç§¯å’Œæˆªå–ï¼Œä¸ä¼šè¢«è¿‡æ»¤\r\n *\r\n * 5. expandOrï¼š\r\n *    - ç©ºåˆ†æ”¯å‚ä¸åˆå¹¶ï¼Œä¸ä¼šè¢«è¿‡æ»¤\r\n *\r\n * ç»“è®ºï¼š\r\n * - æ•´ä¸ªç³»ç»Ÿä¸­æ²¡æœ‰ä»»ä½•åœ°æ–¹ä¼šè¿‡æ»¤ç©ºåˆ†æ”¯ []\r\n * - ç©ºåˆ†æ”¯åœ¨æ‰€æœ‰å¤„ç†ç¯èŠ‚éƒ½æ˜¯ä¸€ç­‰å…¬æ°‘\r\n * - ç©ºåˆ†æ”¯çš„è¯­ä¹‰è¢«å®Œæ•´ä¿ç•™\r\n *\r\n * ç”¨é€”ï¼šä¸ºSubhutiConflictDetectoræä¾›è·¯å¾„æ•°æ®ï¼Œç”¨äºæ£€æµ‹Oråˆ†æ”¯å†²çª\r\n *\r\n * @version 2.0.0 - åˆ†å±‚å±•å¼€ç‰ˆæœ¬\r\n */\r\n\r\nimport type {\r\n    RuleNode,\r\n    Path,\r\n    SequenceNode,\r\n    ValidationError,\r\n    SubruleNode,\r\n    ConsumeNode,\r\n    OrNode, ManyNode, OptionNode, AtLeastOneNode\r\n} from \"./SubhutiValidationError\"\r\nimport {SubhutiValidationLogger} from './SubhutiValidationLogger'\r\nimport ArrayTrie from \"./ArrayTria.ts\";\r\nimport * as fs from 'fs';\r\nimport * as path from 'path';\r\nimport {fileURLToPath} from 'url';\r\nimport fastCartesian from \"fast-cartesian\";\r\nimport graphlib from '@dagrejs/graphlib'\r\nconst {Graph, alg} = graphlib\r\n\r\n/**\r\n * å·¦é€’å½’é”™è¯¯ç±»å‹\r\n */\r\nexport type LeftRecursionError = ValidationError\r\n\r\n/**\r\n * æ€§èƒ½åˆ†æå™¨\r\n */\r\nclass PerformanceAnalyzer {\r\n    private stats = new Map<string, {\r\n        count: number\r\n        totalTime: number      // æ€»è€—æ—¶ï¼ˆåŒ…å«å­æ–¹æ³•ï¼‰\r\n        netTime: number         // å‡€è€—æ—¶ï¼ˆæ’é™¤å­æ–¹æ³•ï¼‰\r\n        maxTime: number\r\n        minTime: number\r\n        inputSizes: number[]\r\n        outputSizes: number[]\r\n    }>()\r\n\r\n    // è°ƒç”¨æ ˆè·Ÿè¸ªï¼ˆç”¨äºè®¡ç®—å‡€è€—æ—¶ï¼‰\r\n    private callStack: Array<{ methodName: string, startTime: number, childTime: number }> = []\r\n\r\n    // ç¼“å­˜ç»Ÿè®¡\r\n    public cacheStats = {\r\n        subRuleHandlerTotal: 0,  // subRuleHandler æ€»è°ƒç”¨æ¬¡æ•°\r\n        recursiveReturn: 0,  // é€’å½’æ£€æµ‹è¿”å›æ¬¡æ•°\r\n        levelLimitReturn: 0,  // å±‚çº§é™åˆ¶è¿”å›æ¬¡æ•°\r\n        // ç‹¬ç«‹çš„ç¼“å­˜ç»Ÿè®¡ï¼ˆæ¯ä¸ªç¼“å­˜éƒ½æœ‰è‡ªå·±çš„ hit/miss/totalï¼‰\r\n        dfsFirstKCache: {hit: 0, miss: 0, total: 0},  // DFS First(K) ç¼“å­˜\r\n        bfsAllCache: {hit: 0, miss: 0, total: 0},  // BFS æ‰€æœ‰å±‚çº§èšåˆç¼“å­˜\r\n        bfsLevelCache: {hit: 0, miss: 0, total: 0},  // BFS æŒ‰å±‚çº§ç¼“å­˜\r\n        getDirectChildren: {hit: 0, miss: 0, total: 0},  // getDirectChildren æ‡’åŠ è½½ç¼“å­˜\r\n        // åºŸå¼ƒçš„ç»Ÿè®¡ï¼ˆä¿ç•™ç”¨äºå…¼å®¹æ€§ï¼‰\r\n        dfsFirst1: {hit: 0, miss: 0, total: 0},\r\n        dfsFirstK: {hit: 0, miss: 0, total: 0},\r\n        bfsLevel: {hit: 0, miss: 0, total: 0},\r\n        expandOneLevel: {hit: 0, miss: 0, total: 0},\r\n        expandOneLevelTruncated: {hit: 0, miss: 0, total: 0},\r\n        actualCompute: 0,  // å®é™…è®¡ç®—æ¬¡æ•°ï¼ˆgetDirectChildrenï¼‰\r\n        bfsOptimization: {\r\n            totalCalls: 0,           // BFS æ€»è°ƒç”¨æ¬¡æ•°\r\n            skippedLevels: 0,        // è·³è¿‡çš„å±‚çº§æ•°ï¼ˆå¢é‡ä¼˜åŒ–æ•ˆæœï¼‰\r\n            fromLevel1: 0,           // ä» level 1 å¼€å§‹çš„æ¬¡æ•°\r\n            fromCachedLevel: 0       // ä»ç¼“å­˜å±‚çº§å¼€å§‹çš„æ¬¡æ•°\r\n        }\r\n    }\r\n\r\n    // å¼€å§‹æ–¹æ³•è°ƒç”¨ï¼ˆè¿”å›è°ƒç”¨IDï¼Œç”¨äºç»“æŸè°ƒç”¨ï¼‰\r\n    startMethod(methodName: string): number {\r\n        const callId = this.callStack.length\r\n        this.callStack.push({\r\n            methodName,\r\n            startTime: Date.now(),\r\n            childTime: 0\r\n        })\r\n        return callId\r\n    }\r\n\r\n    // ç»“æŸæ–¹æ³•è°ƒç”¨å¹¶è®°å½•ï¼ˆè¿”å›å‡€è€—æ—¶ï¼‰\r\n    endMethod(callId: number, inputSize?: number, outputSize?: number): number {\r\n        const call = this.callStack[callId]\r\n        if (!call) {\r\n            throw new Error(`è°ƒç”¨æ ˆé”™è¯¯: callId ${callId} ä¸å­˜åœ¨`)\r\n        }\r\n\r\n        const totalDuration = Date.now() - call.startTime\r\n        const netDuration = totalDuration - call.childTime\r\n\r\n        // æ›´æ–°çˆ¶æ–¹æ³•çš„å­æ–¹æ³•è€—æ—¶\r\n        if (callId > 0) {\r\n            const parentCall = this.callStack[callId - 1]\r\n            parentCall.childTime += totalDuration\r\n        }\r\n\r\n        // è®°å½•ç»Ÿè®¡\r\n        if (!this.stats.has(call.methodName)) {\r\n            this.stats.set(call.methodName, {\r\n                count: 0,\r\n                totalTime: 0,\r\n                netTime: 0,\r\n                maxTime: 0,\r\n                minTime: Infinity,\r\n                inputSizes: [],\r\n                outputSizes: []\r\n            })\r\n        }\r\n\r\n        const stat = this.stats.get(call.methodName)!\r\n        stat.count++\r\n        stat.totalTime += totalDuration\r\n        stat.netTime += netDuration\r\n        stat.maxTime = Math.max(stat.maxTime, netDuration)\r\n        stat.minTime = Math.min(stat.minTime, netDuration)\r\n\r\n        if (inputSize !== undefined) {\r\n            stat.inputSizes.push(inputSize)\r\n        }\r\n        if (outputSize !== undefined) {\r\n            stat.outputSizes.push(outputSize)\r\n        }\r\n\r\n        // ä»è°ƒç”¨æ ˆç§»é™¤\r\n        this.callStack.pop()\r\n\r\n        return netDuration\r\n    }\r\n\r\n    // è®°å½•æ–¹æ³•è°ƒç”¨ï¼ˆå…¼å®¹æ—§æ¥å£ï¼Œä½†ä½¿ç”¨å‡€è€—æ—¶ï¼‰\r\n    record(methodName: string, duration: number, inputSize?: number, outputSize?: number) {\r\n        // è¿™ä¸ªæ¥å£ç”¨äºç›´æ¥è®°å½•è€—æ—¶ï¼ˆä¸é€šè¿‡è°ƒç”¨æ ˆï¼‰\r\n        // å‡è®¾è¿™æ˜¯å‡€è€—æ—¶ï¼ˆå·²ç»æ’é™¤äº†å­æ–¹æ³•ï¼‰\r\n        if (!this.stats.has(methodName)) {\r\n            this.stats.set(methodName, {\r\n                count: 0,\r\n                totalTime: 0,\r\n                netTime: 0,\r\n                maxTime: 0,\r\n                minTime: Infinity,\r\n                inputSizes: [],\r\n                outputSizes: []\r\n            })\r\n        }\r\n\r\n        const stat = this.stats.get(methodName)!\r\n        stat.count++\r\n        stat.totalTime += duration\r\n        stat.netTime += duration  // å‡è®¾ä¼ å…¥çš„å·²ç»æ˜¯å‡€è€—æ—¶\r\n        stat.maxTime = Math.max(stat.maxTime, duration)\r\n        stat.minTime = Math.min(stat.minTime, duration)\r\n\r\n        if (inputSize !== undefined) {\r\n            stat.inputSizes.push(inputSize)\r\n        }\r\n        if (outputSize !== undefined) {\r\n            stat.outputSizes.push(outputSize)\r\n        }\r\n    }\r\n\r\n    // è®°å½•ç¼“å­˜å‘½ä¸­/æœªå‘½ä¸­\r\n    recordCacheHit(cacheType: 'dfsFirstKCache' | 'bfsAllCache' | 'bfsLevelCache' | 'getDirectChildren' |\r\n        'dfsFirst1' | 'dfsFirstK' | 'bfsLevel' | 'expandOneLevel' | 'expandOneLevelTruncated') {\r\n        this.cacheStats[cacheType].hit++\r\n        this.cacheStats[cacheType].total++\r\n    }\r\n\r\n    recordCacheMiss(cacheType: 'dfsFirstKCache' | 'bfsAllCache' | 'bfsLevelCache' | 'getDirectChildren' |\r\n        'dfsFirst1' | 'dfsFirstK' | 'bfsLevel' | 'expandOneLevel' | 'expandOneLevelTruncated') {\r\n        this.cacheStats[cacheType].miss++\r\n        this.cacheStats[cacheType].total++\r\n    }\r\n\r\n    // è®°å½•å®é™…è®¡ç®—\r\n    recordActualCompute() {\r\n        this.cacheStats.actualCompute++\r\n    }\r\n\r\n    // è¾“å‡ºç»Ÿè®¡æŠ¥å‘Š\r\n    report() {\r\n        console.log('\\nğŸ“Š ===== æ€§èƒ½åˆ†ææŠ¥å‘Š =====\\n')\r\n\r\n        // 1. subRuleHandler æ€»ä½“ç»Ÿè®¡\r\n        console.log('ğŸ¯ subRuleHandler è°ƒç”¨ç»Ÿè®¡:')\r\n        console.log(`   æ€»è°ƒç”¨æ¬¡æ•°: ${this.cacheStats.subRuleHandlerTotal}`)\r\n        console.log(`   é€’å½’æ£€æµ‹è¿”å›: ${this.cacheStats.recursiveReturn}`)\r\n        console.log(`   å±‚çº§é™åˆ¶è¿”å›: ${this.cacheStats.levelLimitReturn}`)\r\n        console.log(`   æ­£å¸¸å¤„ç†: ${this.cacheStats.subRuleHandlerTotal - this.cacheStats.recursiveReturn - this.cacheStats.levelLimitReturn}`)\r\n        console.log('')\r\n\r\n        // 2. ç¼“å­˜ç»Ÿè®¡\r\n        console.log('ğŸ’¾ ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡:')\r\n        console.log(`   DFS_First1 (æ·±åº¦ä¼˜å…ˆ First(1)):`)\r\n        console.log(`     å‘½ä¸­: ${this.cacheStats.dfsFirst1.hit}`)\r\n        console.log(`     æœªå‘½ä¸­: ${this.cacheStats.dfsFirst1.miss}`)\r\n        console.log(`     æ€»æ¬¡æ•°: ${this.cacheStats.dfsFirst1.total}`)\r\n        console.log(`     å‘½ä¸­ç‡: ${this.cacheStats.dfsFirst1.total > 0 ? ((this.cacheStats.dfsFirst1.hit / this.cacheStats.dfsFirst1.total) * 100).toFixed(1) : 0}%`)\r\n\r\n        console.log(`   DFS_FirstK (æ·±åº¦ä¼˜å…ˆ First(K)):`)\r\n        console.log(`     å‘½ä¸­: ${this.cacheStats.dfsFirstK.hit}`)\r\n        console.log(`     æœªå‘½ä¸­: ${this.cacheStats.dfsFirstK.miss}`)\r\n        console.log(`     æ€»æ¬¡æ•°: ${this.cacheStats.dfsFirstK.total}`)\r\n        console.log(`     å‘½ä¸­ç‡: ${this.cacheStats.dfsFirstK.total > 0 ? ((this.cacheStats.dfsFirstK.hit / this.cacheStats.dfsFirstK.total) * 100).toFixed(1) : 0}%`)\r\n\r\n        console.log(`   GetDirectChildren (æ‡’åŠ è½½ç¼“å­˜):`)\r\n        console.log(`     å‘½ä¸­: ${this.cacheStats.getDirectChildren.hit}`)\r\n        console.log(`     æœªå‘½ä¸­: ${this.cacheStats.getDirectChildren.miss}`)\r\n        console.log(`     æ€»æ¬¡æ•°: ${this.cacheStats.getDirectChildren.total}`)\r\n        console.log(`     å‘½ä¸­ç‡: ${this.cacheStats.getDirectChildren.total > 0 ? ((this.cacheStats.getDirectChildren.hit / this.cacheStats.getDirectChildren.total) * 100).toFixed(1) : 0}%`)\r\n\r\n        // BFS å¢é‡ä¼˜åŒ–æ•ˆæœ\r\n        if (this.cacheStats.bfsOptimization.totalCalls > 0) {\r\n            console.log(`\\n   ğŸš€ BFS å¢é‡ä¼˜åŒ–æ•ˆæœ:`)\r\n            console.log(`     æ€»è°ƒç”¨æ¬¡æ•°: ${this.cacheStats.bfsOptimization.totalCalls}`)\r\n            console.log(`     ä» level 1 å¼€å§‹: ${this.cacheStats.bfsOptimization.fromLevel1} (${((this.cacheStats.bfsOptimization.fromLevel1 / this.cacheStats.bfsOptimization.totalCalls) * 100).toFixed(1)}%)`)\r\n            console.log(`     ä»ç¼“å­˜å±‚çº§å¼€å§‹: ${this.cacheStats.bfsOptimization.fromCachedLevel} (${((this.cacheStats.bfsOptimization.fromCachedLevel / this.cacheStats.bfsOptimization.totalCalls) * 100).toFixed(1)}%)`)\r\n            console.log(`     æ€»è®¡è·³è¿‡å±‚æ•°: ${this.cacheStats.bfsOptimization.skippedLevels}`)\r\n            if (this.cacheStats.bfsOptimization.fromCachedLevel > 0) {\r\n                const avgSkipped = this.cacheStats.bfsOptimization.skippedLevels / this.cacheStats.bfsOptimization.fromCachedLevel\r\n                console.log(`     å¹³å‡æ¯æ¬¡è·³è¿‡: ${avgSkipped.toFixed(2)} å±‚`)\r\n            }\r\n        }\r\n\r\n        // ä»¥ä¸‹ç¼“å­˜ä»…åœ¨ç‰¹æ®Šåœºæ™¯ä½¿ç”¨ï¼Œé€šå¸¸å‘½ä¸­ç‡è¾ƒä½\r\n        if (this.cacheStats.bfsLevel.total > 0) {\r\n            console.log(`   BFS_Level (handleDFSç‰¹æ®Šåœºæ™¯: firstK=âˆ, maxLevel=1):`)\r\n            console.log(`     å‘½ä¸­: ${this.cacheStats.bfsLevel.hit}`)\r\n            console.log(`     æœªå‘½ä¸­: ${this.cacheStats.bfsLevel.miss}`)\r\n            console.log(`     æ€»æ¬¡æ•°: ${this.cacheStats.bfsLevel.total}`)\r\n            console.log(`     å‘½ä¸­ç‡: ${((this.cacheStats.bfsLevel.hit / this.cacheStats.bfsLevel.total) * 100).toFixed(1)}%`)\r\n        }\r\n\r\n        if (this.cacheStats.expandOneLevel.total > 0) {\r\n            console.log(`   ExpandOneLevel (BFSè·¯å¾„å±•å¼€ç¼“å­˜):`)\r\n            console.log(`     å‘½ä¸­: ${this.cacheStats.expandOneLevel.hit}`)\r\n            console.log(`     æœªå‘½ä¸­: ${this.cacheStats.expandOneLevel.miss}`)\r\n            console.log(`     æ€»æ¬¡æ•°: ${this.cacheStats.expandOneLevel.total}`)\r\n            console.log(`     å‘½ä¸­ç‡: ${((this.cacheStats.expandOneLevel.hit / this.cacheStats.expandOneLevel.total) * 100).toFixed(1)}%`)\r\n        }\r\n\r\n        console.log(`   å®é™…è®¡ç®—æ¬¡æ•° (getDirectChildren): ${this.cacheStats.actualCompute}`)\r\n        console.log('')\r\n\r\n        // éªŒè¯ç»Ÿè®¡å®Œæ•´æ€§\r\n        const expectedNormalProcess = this.cacheStats.subRuleHandlerTotal - this.cacheStats.recursiveReturn - this.cacheStats.levelLimitReturn\r\n        const actualCacheOperations = this.cacheStats.dfsFirst1.hit +\r\n            this.cacheStats.dfsFirstK.hit +\r\n            this.cacheStats.actualCompute\r\n        console.log(`ğŸ“ˆ ç»Ÿè®¡éªŒè¯:`)\r\n        console.log(`   é¢„æœŸæ­£å¸¸å¤„ç†: ${expectedNormalProcess}`)\r\n        console.log(`   å®é™…ç¼“å­˜æ“ä½œ: ${actualCacheOperations}`)\r\n        console.log(`   å·®å¼‚: ${expectedNormalProcess - actualCacheOperations} (åº”è¯¥æ¥è¿‘0)`)\r\n        console.log('')\r\n\r\n        // 2. æ–¹æ³•è°ƒç”¨ç»Ÿè®¡ï¼ˆæŒ‰å‡€è€—æ—¶æ’åºï¼‰\r\n        const sorted = Array.from(this.stats.entries())\r\n            .sort((a, b) => b[1].netTime - a[1].netTime)\r\n            .slice(0, 20)  // åªæ˜¾ç¤ºå‰20ä¸ª\r\n\r\n        // è®¡ç®—æ€»è€—æ—¶\r\n        const totalTime = Array.from(this.stats.values())\r\n            .reduce((sum, stat) => sum + stat.totalTime, 0)\r\n\r\n        // è®¡ç®—å‡€è€—æ—¶æ€»å’Œï¼ˆç”¨äºç™¾åˆ†æ¯”è®¡ç®—ï¼‰\r\n        const totalNetTime = Array.from(this.stats.values())\r\n            .reduce((sum, stat) => sum + stat.netTime, 0)\r\n\r\n        console.log('â±ï¸  æ–¹æ³•è€—æ—¶ç»Ÿè®¡ (æŒ‰å‡€è€—æ—¶æ’åº, Top 20):')\r\n        console.log('='.repeat(80))\r\n        for (const [method, stat] of sorted) {\r\n            const avgNetTime = stat.netTime / stat.count\r\n            const avgTotalTime = stat.totalTime / stat.count\r\n            const percentage = totalNetTime > 0 ? (stat.netTime / totalNetTime * 100).toFixed(1) : '0.0'\r\n            const avgInput = stat.inputSizes.length > 0\r\n                ? stat.inputSizes.reduce((a, b) => a + b, 0) / stat.inputSizes.length\r\n                : 0\r\n            const avgOutput = stat.outputSizes.length > 0\r\n                ? stat.outputSizes.reduce((a, b) => a + b, 0) / stat.outputSizes.length\r\n                : 0\r\n\r\n            console.log(`ğŸ“Œ ${method}:`)\r\n            console.log(`   å‡€è€—æ—¶: ${stat.netTime.toFixed(0)}ms (${percentage}%) | æ€»è€—æ—¶: ${stat.totalTime.toFixed(0)}ms`)\r\n            console.log(`   è°ƒç”¨æ¬¡æ•°: ${stat.count}æ¬¡, å¹³å‡å‡€è€—æ—¶: ${avgNetTime.toFixed(2)}ms, å¹³å‡æ€»è€—æ—¶: ${avgTotalTime.toFixed(2)}ms`)\r\n            console.log(`   æœ€å¤§è€—æ—¶: ${stat.maxTime.toFixed(0)}ms, æœ€å°è€—æ—¶: ${stat.minTime === Infinity ? 0 : stat.minTime.toFixed(0)}ms`)\r\n\r\n            if (stat.inputSizes.length > 0 && stat.outputSizes.length > 0) {\r\n                console.log(`   è¾“å…¥â†’è¾“å‡º: ${avgInput.toFixed(1)} â†’ ${avgOutput.toFixed(1)} (${(avgOutput / avgInput).toFixed(1)}x)`)\r\n            }\r\n            console.log('')\r\n        }\r\n\r\n        console.log(`â±ï¸  æ‰€æœ‰æ–¹æ³•å‡€è€—æ—¶æ€»å’Œ: ${totalNetTime.toFixed(2)}ms`)\r\n        console.log(`â±ï¸  æ‰€æœ‰æ–¹æ³•æ€»è€—æ—¶æ€»å’Œ: ${totalTime.toFixed(2)}ms`)\r\n        console.log('='.repeat(80))\r\n        console.log('')\r\n    }\r\n\r\n    // æ¸…ç©ºç»Ÿè®¡\r\n    clear() {\r\n        this.stats.clear()\r\n        this.cacheStats = {\r\n            subRuleHandlerTotal: 0,\r\n            recursiveReturn: 0,\r\n            levelLimitReturn: 0,\r\n            // æ–°çš„ç‹¬ç«‹ç¼“å­˜ç»Ÿè®¡\r\n            dfsFirstKCache: {hit: 0, miss: 0, total: 0},\r\n            bfsAllCache: {hit: 0, miss: 0, total: 0},\r\n            bfsLevelCache: {hit: 0, miss: 0, total: 0},\r\n            getDirectChildren: {hit: 0, miss: 0, total: 0},\r\n            // åºŸå¼ƒçš„ç»Ÿè®¡ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰\r\n            dfsFirst1: {hit: 0, miss: 0, total: 0},\r\n            dfsFirstK: {hit: 0, miss: 0, total: 0},\r\n            bfsLevel: {hit: 0, miss: 0, total: 0},\r\n            expandOneLevel: {hit: 0, miss: 0, total: 0},\r\n            expandOneLevelTruncated: {hit: 0, miss: 0, total: 0},\r\n            actualCompute: 0,\r\n            bfsOptimization: {\r\n                totalCalls: 0,\r\n                skippedLevels: 0,\r\n                fromLevel1: 0,\r\n                fromCachedLevel: 0\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * å…¨å±€ç»Ÿä¸€é™åˆ¶é…ç½®\r\n *\r\n * è®¾è®¡ç†å¿µï¼š\r\n * - MAX_LEVELï¼šæ§åˆ¶å±•å¼€æ·±åº¦ï¼Œé˜²æ­¢æ— é™é€’å½’\r\n * - MAX_BRANCHESï¼šä»…ç”¨äºå†²çªæ£€æµ‹æ—¶çš„è·¯å¾„æ¯”è¾ƒä¼˜åŒ–\r\n */\r\nexport const EXPANSION_LIMITS = {\r\n    FIRST_K: 3,\r\n    FIRST_Max: 100,\r\n\r\n    LEVEL_1: 1,\r\n    LEVEL_K: 1,\r\n\r\n    INFINITY: Infinity,\r\n    RuleJoinSymbol: '\\x1F',\r\n\r\n    /**\r\n     * å†²çªæ£€æµ‹è·¯å¾„æ¯”è¾ƒé™åˆ¶\r\n     *\r\n     * âš ï¸ æ³¨æ„ï¼šæ­¤é™åˆ¶ä»…ç”¨äºå†²çªæ£€æµ‹é˜¶æ®µçš„è·¯å¾„æ¯”è¾ƒä¼˜åŒ–\r\n     * - ä¸å½±å“è§„åˆ™å±•å¼€é˜¶æ®µï¼ˆå±•å¼€é˜¶æ®µä¸åšä»»ä½•æˆªæ–­ï¼‰\r\n     * - ä»…åœ¨ SubhutiConflictDetector.detectOrConflicts ä¸­ä½¿ç”¨\r\n     * - ç”¨äºé™åˆ¶æ¯ä¸ªåˆ†æ”¯çš„è·¯å¾„æ•°é‡ï¼Œé˜²æ­¢è·¯å¾„æ¯”è¾ƒçˆ†ç‚¸\r\n     *\r\n     * æ€§èƒ½è€ƒè™‘ï¼š\r\n     * - è·¯å¾„æ¯”è¾ƒå¤æ‚åº¦ï¼šO(nÂ²)\r\n     * - 1000æ¡è·¯å¾„ Ã— 1000æ¡è·¯å¾„ = 100ä¸‡æ¬¡æ¯”è¾ƒï¼ˆå¯æ¥å—ï¼‰\r\n     * - è¶…è¿‡1000æ¡è·¯å¾„ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ï¼ˆå¦‚ 28260æ¡ = 8äº¿æ¬¡æ¯”è¾ƒï¼‰\r\n     *\r\n     * å½“å‰è®¾ç½®ï¼šå·²å–æ¶ˆé™åˆ¶ï¼ˆInfinityï¼‰ï¼Œå¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜\r\n     */\r\n    MAX_BRANCHES: Infinity,\r\n} as const\r\n\r\n/**\r\n * è¯­æ³•åˆ†æå™¨é…ç½®\r\n */\r\nexport interface GrammarAnalyzerOptions {\r\n    /**\r\n     * æœ€å¤§å±•å¼€å±‚çº§\r\n     * é»˜è®¤: 3\r\n     *\r\n     * è¯´æ˜ï¼š\r\n     * - æ§åˆ¶è§„åˆ™å±•å¼€çš„æ·±åº¦\r\n     * - Level 0: ç›´æ¥å­èŠ‚ç‚¹\r\n     * - Level 1: å±•å¼€ä¸€å±‚\r\n     * - Level N: å±•å¼€Nå±‚\r\n     */\r\n    maxLevel?: number\r\n}\r\n\r\n/**\r\n * è¯­æ³•åˆ†æå™¨\r\n *\r\n * èŒè´£ï¼š\r\n * 1. æ¥æ”¶è§„åˆ™ AST\r\n * 2. æŒ‰å±‚çº§å±•å¼€è§„åˆ™ï¼ˆä¸å†å®Œå…¨å±•å¼€åˆ°tokenï¼‰\r\n * 3. åˆ†å±‚å­˜å‚¨å±•å¼€ç»“æœ\r\n * 4. åªç¼“å­˜ç›´æ¥å­èŠ‚ç‚¹ï¼Œä½¿ç”¨æ—¶æŒ‰éœ€å±•å¼€\r\n *\r\n * æ€§èƒ½ï¼š\r\n * - é»˜è®¤é™åˆ¶ï¼š3å±‚å±•å¼€ï¼Œ10000æ¡è·¯å¾„\r\n * - ç¼“å­˜æœºåˆ¶ï¼šåªç¼“å­˜ç›´æ¥å­èŠ‚ç‚¹\r\n * - æŒ‰éœ€è®¡ç®—ï¼šä½¿ç”¨æ—¶æ‰é€’å½’å±•å¼€\r\n */\r\nexport class SubhutiGrammarAnalyzer {\r\n    /** æ­£åœ¨è®¡ç®—çš„è§„åˆ™ï¼ˆç”¨äºæ£€æµ‹å¾ªç¯ä¾èµ–ï¼‰ */\r\n    private recursiveDetectionSet = new Set<string>()\r\n\r\n    /** å½“å‰è§„åˆ™åï¼ˆç”¨äºæ—¥å¿—è®°å½•ï¼‰ */\r\n    private currentRuleName: string | null = null\r\n\r\n    /** å½“å‰è§„åˆ™çš„æ—¥å¿—æ–‡ä»¶æè¿°ç¬¦ï¼ˆä½¿ç”¨åŒæ­¥å†™å…¥ï¼‰ */\r\n    private currentLogFd: number | null = null\r\n\r\n    /** å½“å‰è§„åˆ™çš„æ—¥å¿—æ–‡ä»¶è·¯å¾„ */\r\n    private currentLogFilePath: string | null = null\r\n\r\n    /** å½“å‰è°ƒç”¨æ·±åº¦ï¼ˆç”¨äºç¼©è¿›ï¼‰ */\r\n    private currentDepth: number = 0\r\n\r\n    /**\r\n     * å†™å…¥æ—¥å¿—ï¼ˆä½¿ç”¨å½“å‰æ·±åº¦æ§åˆ¶ç¼©è¿›ï¼Œè‡ªåŠ¨æ·»åŠ æ–‡ä»¶åå‰ç¼€ï¼‰\r\n     * ä½¿ç”¨åŒæ­¥å†™å…¥ç¡®ä¿æ—¥å¿—ç«‹å³åˆ·æ–°åˆ°ç£ç›˜\r\n     */\r\n    private writeLog(message: string, depth?: number): void {\r\n        if (this.currentLogFd !== null && this.currentRuleName) {\r\n            const indent = '  '.repeat(depth !== undefined ? depth : this.currentDepth)\r\n            const logFileName = `${this.currentRuleName}-æ‰§è¡Œä¸­.log`\r\n            const logLine = `${indent}[${logFileName}] ${message}\\n`\r\n            try {\r\n                // ä½¿ç”¨åŒæ­¥å†™å…¥ï¼Œç¡®ä¿ç«‹å³åˆ·æ–°åˆ°ç£ç›˜\r\n                fs.writeSync(this.currentLogFd, logLine, null, 'utf8')\r\n            } catch (error) {\r\n                console.error(`å†™å…¥æ—¥å¿—å¤±è´¥: ${logFileName}`, error)\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * å¼€å§‹è®°å½•è§„åˆ™æ—¥å¿—\r\n     */\r\n    private startRuleLogging(ruleName: string): void {\r\n        console.log(`ğŸ” startRuleLogging è¢«è°ƒç”¨: ${ruleName}`)\r\n        // ç»“æŸä¹‹å‰çš„æ—¥å¿—\r\n        this.endRuleLogging()\r\n\r\n        // è®¾ç½®å½“å‰è§„åˆ™å’Œæ·±åº¦\r\n        this.currentRuleName = ruleName\r\n        this.currentDepth = 0\r\n\r\n        // åˆ›å»ºæ—¥å¿—ç›®å½•ï¼ˆç›¸å¯¹äº subhuti ç›®å½•ï¼‰\r\n        // ä»å½“å‰æ–‡ä»¶ä½ç½®å‘ä¸ŠæŸ¥æ‰¾ï¼Œæ‰¾åˆ° subhuti ç›®å½•\r\n        // ESM ä½¿ç”¨ import.meta.url\r\n        const __filename = fileURLToPath(import.meta.url)\r\n        const currentDir = path.dirname(__filename)\r\n\r\n        let subhutiDir = currentDir\r\n        while (subhutiDir !== path.dirname(subhutiDir)) {\r\n            const dirName = path.basename(subhutiDir)\r\n            if (dirName === 'subhuti') {\r\n                break\r\n            }\r\n            subhutiDir = path.dirname(subhutiDir)\r\n        }\r\n        const logDir = path.join(subhutiDir, 'logall')\r\n        if (!fs.existsSync(logDir)) {\r\n            fs.mkdirSync(logDir, {recursive: true})\r\n            console.log(`ğŸ“ åˆ›å»ºæ—¥å¿—ç›®å½•: ${logDir}`)\r\n        } else {\r\n            console.log(`ğŸ“ ä½¿ç”¨æ—¥å¿—ç›®å½•: ${logDir}`)\r\n        }\r\n\r\n        // åˆ›å»ºæ—¥å¿—æ–‡ä»¶ï¼ˆæ‰§è¡Œä¸­çŠ¶æ€ï¼‰\r\n        const logFilePath = path.join(logDir, `${ruleName}-æ‰§è¡Œä¸­.log`)\r\n        this.currentLogFilePath = logFilePath\r\n        console.log(`[DEBUG] å‡†å¤‡åˆ›å»ºæ—¥å¿—æ–‡ä»¶: ${logFilePath}`)\r\n\r\n        // ä½¿ç”¨åŒæ­¥æ–¹å¼åˆ›å»ºæ–‡ä»¶å¹¶æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦\r\n        try {\r\n            console.log(`[DEBUG] å¼€å§‹å†™å…¥æ–‡ä»¶å†…å®¹...`)\r\n            const initialContent = `========== å¼€å§‹å¤„ç†è§„åˆ™: ${ruleName} ==========\\næ—¶é—´: ${new Date().toISOString()}\\n\\n`\r\n\r\n            // æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦ï¼ˆå†™å…¥æ¨¡å¼ï¼Œå¦‚æœæ–‡ä»¶å­˜åœ¨åˆ™æˆªæ–­ï¼‰\r\n            this.currentLogFd = fs.openSync(logFilePath, 'w')\r\n\r\n            // å†™å…¥åˆå§‹å†…å®¹\r\n            fs.writeSync(this.currentLogFd, initialContent, null, 'utf8')\r\n            console.log(`[DEBUG] æ–‡ä»¶æè¿°ç¬¦å·²æ‰“å¼€å¹¶å†™å…¥åˆå§‹å†…å®¹`)\r\n\r\n            // éªŒè¯æ–‡ä»¶æ˜¯å¦åˆ›å»ºæˆåŠŸ\r\n            if (fs.existsSync(logFilePath)) {\r\n                const stats = fs.statSync(logFilePath)\r\n                console.log(`âœ… æ—¥å¿—æ–‡ä»¶å·²åˆ›å»º: ${logFilePath}, å¤§å°: ${stats.size} bytes`)\r\n            } else {\r\n                console.error(`âŒ æ–‡ä»¶å†™å…¥åä¸å­˜åœ¨: ${logFilePath}`)\r\n                if (this.currentLogFd !== null) {\r\n                    fs.closeSync(this.currentLogFd)\r\n                    this.currentLogFd = null\r\n                }\r\n                return\r\n            }\r\n\r\n        } catch (error: any) {\r\n            console.error(`âŒ åˆ›å»ºæ—¥å¿—æ–‡ä»¶å¤±è´¥: ${logFilePath}`)\r\n            console.error(`é”™è¯¯ç±»å‹: ${error?.constructor?.name || typeof error}`)\r\n            console.error(`é”™è¯¯æ¶ˆæ¯: ${error?.message || String(error)}`)\r\n            if (error?.stack) {\r\n                console.error(`é”™è¯¯å †æ ˆ:`, error.stack)\r\n            }\r\n            if (this.currentLogFd !== null) {\r\n                try {\r\n                    fs.closeSync(this.currentLogFd)\r\n                } catch (e) {\r\n                    // å¿½ç•¥å…³é—­é”™è¯¯\r\n                }\r\n                this.currentLogFd = null\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * ç»“æŸè®°å½•è§„åˆ™æ—¥å¿—\r\n     */\r\n    private endRuleLogging(): void {\r\n        if (this.currentLogFd !== null && this.currentRuleName && this.currentLogFilePath) {\r\n            this.writeLog('', 0)\r\n            this.writeLog(`========== ç»“æŸå¤„ç†è§„åˆ™: ${this.currentRuleName} ==========`, 0)\r\n\r\n            // ä¿å­˜è§„åˆ™åå’Œæ–‡ä»¶è·¯å¾„ï¼Œç”¨äºé‡å‘½å\r\n            const ruleName = this.currentRuleName\r\n            const executingFilePath = this.currentLogFilePath\r\n\r\n            // ä»å½“å‰æ–‡ä»¶ä½ç½®å‘ä¸ŠæŸ¥æ‰¾ï¼Œæ‰¾åˆ° subhuti ç›®å½•\r\n            // ESM ä½¿ç”¨ import.meta.url\r\n            const __filename = fileURLToPath(import.meta.url)\r\n            const currentDir = path.dirname(__filename)\r\n            let subhutiDir = currentDir\r\n            while (subhutiDir !== path.dirname(subhutiDir)) {\r\n                const dirName = path.basename(subhutiDir)\r\n                if (dirName === 'subhuti') {\r\n                    break\r\n                }\r\n                subhutiDir = path.dirname(subhutiDir)\r\n            }\r\n            const logDir = path.join(subhutiDir, 'logall')\r\n            const completedFilePath = path.join(logDir, `${ruleName}-æ‰§è¡Œå®Œ.log`)\r\n\r\n            console.log(`[DEBUG] å‡†å¤‡å…³é—­æ—¥å¿—æ–‡ä»¶: ${ruleName}`)\r\n\r\n            // åŒæ­¥å…³é—­æ–‡ä»¶æè¿°ç¬¦å¹¶é‡å‘½åæ–‡ä»¶\r\n            try {\r\n                // å…³é—­æ–‡ä»¶æè¿°ç¬¦\r\n                fs.closeSync(this.currentLogFd)\r\n                this.currentLogFd = null\r\n                this.currentLogFilePath = null\r\n\r\n                console.log(`[DEBUG] æ–‡ä»¶æè¿°ç¬¦å·²å…³é—­ï¼Œå‡†å¤‡é‡å‘½åæ–‡ä»¶`)\r\n                console.log(`[DEBUG] æºæ–‡ä»¶: ${executingFilePath}`)\r\n                console.log(`[DEBUG] ç›®æ ‡æ–‡ä»¶: ${completedFilePath}`)\r\n\r\n                // æ£€æŸ¥æºæ–‡ä»¶æ˜¯å¦å­˜åœ¨\r\n                if (fs.existsSync(executingFilePath)) {\r\n                    console.log(`[DEBUG] æºæ–‡ä»¶å­˜åœ¨ï¼Œå¼€å§‹é‡å‘½å`)\r\n                    fs.renameSync(executingFilePath, completedFilePath)\r\n                    console.log(`âœ… æ—¥å¿—æ–‡ä»¶å·²é‡å‘½å: ${ruleName}-æ‰§è¡Œä¸­.log -> ${ruleName}-æ‰§è¡Œå®Œ.log`)\r\n                } else {\r\n                    console.error(`âŒ æºæ–‡ä»¶ä¸å­˜åœ¨: ${executingFilePath}`)\r\n                }\r\n            } catch (error) {\r\n                console.error(`âŒ å…³é—­æˆ–é‡å‘½åæ—¥å¿—æ–‡ä»¶å¤±è´¥: ${executingFilePath} -> ${completedFilePath}`, error)\r\n            }\r\n        }\r\n        this.currentRuleName = null\r\n        this.currentDepth = 0\r\n        this.currentLogFd = null\r\n        this.currentLogFilePath = null\r\n    }\r\n\r\n    // ========================================\r\n    // DFSï¼ˆæ·±åº¦ä¼˜å…ˆï¼‰ä¸“å±ç¼“å­˜\r\n    // é€‚ç”¨ï¼šmaxLevel = INFINITYï¼ˆæ— é™å±‚æ•°ï¼Œé€’å½’åˆ°tokenï¼‰\r\n    // ========================================\r\n\r\n    /** DFS ä¸»ç¼“å­˜ï¼škey=\"ruleName\"ï¼ŒFirst(K) + æ— é™å±‚çº§ */\r\n    private dfsFirstKCache = new Map<string, string[][]>()\r\n\r\n    // ========================================\r\n    // BFSï¼ˆå¹¿åº¦ä¼˜å…ˆï¼‰ä¸“å±ç¼“å­˜\r\n    // é€‚ç”¨ï¼šmaxLevel = å…·ä½“å€¼ï¼ˆé™åˆ¶å±‚æ•°ï¼ŒæŒ‰å±‚çº§å±•å¼€ï¼‰\r\n    // ç‰¹ç‚¹ï¼šBFS åªè´Ÿè´£æŒ‰å±‚çº§å±•å¼€ï¼Œä¸è´Ÿè´£æˆªå–\r\n    // ========================================\r\n\r\n    //todo bfsæ— æ³•å…¨å±‚å±•å¼€ï¼Œä¼˜åŒ–æ–¹å‘ï¼Œä½¿ç”¨å›¾æ‰¾åˆ°å¾ªç¯ç‚¹ï¼Œå»ç¯ï¼Œè®¡ç®—æ·±åº¦ï¼Œæ ¹æ®æ·±åº¦æ’åºï¼Œæµ…å±‚ä¼˜å…ˆè®¡ç®—å’Œç¼“å­˜ï¼Œæ·±å±‚è°ƒç”¨çš„æ¯ä¸€ä¸ªéƒ½æ¢å­˜è¿‡çš„æ–¹å¼å°è¯•è§£å†³é—®é¢˜\r\n    /** BFS ç¼“å­˜ï¼škey=\"ruleName\"ï¼ˆå®Œæ•´å±•å¼€ï¼Œä¸æˆªå–ï¼Œæ‰€æœ‰å±‚çº§èšåˆï¼‰ */\r\n    private bfsAllCache = new Map<string, string[][]>()\r\n    /** BFS ç¼“å­˜ï¼škey=\"ruleName:level\"ï¼ˆå®Œæ•´å±•å¼€ï¼Œä¸æˆªå–ï¼‰ */\r\n    private bfsLevelCache = new Map<string, string[][]>()\r\n\r\n    /** æ€§èƒ½åˆ†æå™¨ï¼ˆåŒ…å«æ‰€æœ‰ç¼“å­˜ç»Ÿè®¡ï¼‰ */\r\n    private perfAnalyzer = new PerformanceAnalyzer()\r\n\r\n    /** æ”¶é›†æ£€æµ‹è¿‡ç¨‹ä¸­å‘ç°çš„å·¦é€’å½’é”™è¯¯ï¼ˆä½¿ç”¨ Map æé«˜æŸ¥é‡æ€§èƒ½ï¼‰ */\r\n    private detectedLeftRecursionErrors = new Map<string, LeftRecursionError>()\r\n\r\n    /**\r\n     * å°è£…çš„ç¼“å­˜ get æ–¹æ³•ï¼ˆç»Ÿä¸€ç®¡ç†æ‰€æœ‰ç¼“å­˜ç»Ÿè®¡ï¼‰\r\n     *\r\n     * âœ… è®¾è®¡åŸåˆ™ï¼š\r\n     * - æ¯æ¬¡ get è°ƒç”¨éƒ½ä¼šå¢åŠ  total è®¡æ•°\r\n     * - å¦‚æœç¼“å­˜å­˜åœ¨åˆ™ hit++ï¼Œå¦åˆ™ miss++\r\n     * - total å§‹ç»ˆç­‰äº hit + miss\r\n     *\r\n     * @param cacheType - ç¼“å­˜ç±»å‹\r\n     * @param key - ç¼“å­˜é”®\r\n     * @returns ç¼“å­˜çš„å€¼ï¼Œå¦‚æœä¸å­˜åœ¨è¿”å› undefined\r\n     */\r\n    private getCacheValue(\r\n        cacheType: 'dfsFirstKCache' | 'bfsAllCache' | 'bfsLevelCache',\r\n        key: string\r\n    ): string[][] | undefined {\r\n        // æ ¹æ®ç±»å‹è·å–å¯¹åº”çš„ç¼“å­˜\r\n        let result: string[][] | undefined\r\n        switch (cacheType) {\r\n            case 'dfsFirstKCache':\r\n                result = this.dfsFirstKCache.get(key)\r\n                break\r\n            case 'bfsAllCache':\r\n                result = this.bfsAllCache.get(key)\r\n                break\r\n            case 'bfsLevelCache':\r\n                result = this.bfsLevelCache.get(key)\r\n                break\r\n        }\r\n\r\n        // ç»Ÿä¸€è®°å½•å‘½ä¸­/æœªå‘½ä¸­ç»Ÿè®¡\r\n        if (result !== undefined) {\r\n            this.perfAnalyzer.recordCacheHit(cacheType)\r\n        } else {\r\n            if (cacheType === 'bfsAllCache') {\r\n            }\r\n            this.perfAnalyzer.recordCacheMiss(cacheType)\r\n        }\r\n\r\n        return result\r\n    }\r\n\r\n    /** é…ç½®é€‰é¡¹ */\r\n    private options: Required<GrammarAnalyzerOptions>\r\n\r\n    /**\r\n     * æ„é€ å‡½æ•°\r\n     *\r\n     * @param ruleASTs è§„åˆ™åç§° â†’ AST çš„æ˜ å°„\r\n     * @param tokenCache\r\n     * @param options é…ç½®é€‰é¡¹\r\n     */\r\n    constructor(\r\n        private ruleASTs: Map<string, SequenceNode>,\r\n        private tokenCache: Map<string, ConsumeNode>,\r\n        options?: GrammarAnalyzerOptions\r\n    ) {\r\n        this.options = {\r\n            maxLevel: options?.maxLevel ?? 5\r\n        }\r\n    }\r\n\r\n\r\n    getRuleNodeByAst(ruleName: string) {\r\n        const ruleNode = this.ruleASTs.get(ruleName)\r\n        if (!ruleNode) {\r\n            throw new Error('ç³»ç»Ÿé”™è¯¯')\r\n        }\r\n        return ruleNode\r\n    }\r\n\r\n    /**\r\n     * æ£€æµ‹æ‰€æœ‰è§„åˆ™çš„ Or åˆ†æ”¯å†²çªï¼ˆæ™ºèƒ½æ¨¡å¼ï¼šå…ˆ First(1)ï¼Œæœ‰å†²çªå† First(5)ï¼‰\r\n     *\r\n     * å®ç°æ–¹å¼ï¼š\r\n     * - éå†æ‰€æœ‰è§„åˆ™çš„ AST\r\n     * - é€’å½’æŸ¥æ‰¾æ‰€æœ‰ Or èŠ‚ç‚¹\r\n     * - å…ˆè®¡ç®—æ¯ä¸ªåˆ†æ”¯çš„ First(1) é›†åˆ\r\n     * - å¦‚æœæœ‰å†²çªï¼Œå†æ·±å…¥æ£€æµ‹ First(5)\r\n     *\r\n     * @returns Or å†²çªé”™è¯¯åˆ—è¡¨\r\n     */\r\n    /**\r\n     * æ£€æµ‹æ‰€æœ‰è§„åˆ™çš„ Or åˆ†æ”¯å†²çªï¼ˆæ™ºèƒ½æ¨¡å¼ï¼šå…ˆ First(1)ï¼Œæœ‰å†²çªå† First(5)ï¼‰\r\n     *\r\n     * å®ç°æ–¹å¼ï¼š\r\n     * - éå†æ‰€æœ‰è§„åˆ™çš„ AST\r\n     * - é€’å½’æŸ¥æ‰¾æ‰€æœ‰ Or èŠ‚ç‚¹\r\n     * - å…ˆè®¡ç®—æ¯ä¸ªåˆ†æ”¯çš„ First(1) é›†åˆ\r\n     * - å¦‚æœæœ‰å†²çªï¼Œå†æ·±å…¥æ£€æµ‹ First(5)\r\n     *\r\n     * @returns Or å†²çªé”™è¯¯åˆ—è¡¨\r\n     */\r\n    public checkAllOrConflicts(): ValidationError[] {\r\n        const orConflictErrors: ValidationError[] = []\r\n\r\n        // é‡ç½®ç»Ÿè®¡\r\n        this.compareStats = { firstKDetected: 0, bothDetected: 0, firstKOnlyDetected: 0 }\r\n\r\n        // è¯¦ç»†çš„æ€§èƒ½ç»Ÿè®¡\r\n        const perfStats = {\r\n            totalTime: 0,\r\n            ruleStats: new Map<string, {\r\n                time: number,\r\n                orNodeCount: number,\r\n                pathCount: number,\r\n                maxPathCount: number\r\n            }>()\r\n        }\r\n\r\n        const startTime = Date.now()\r\n\r\n        // éå†æ‰€æœ‰è§„åˆ™\r\n        for (const [ruleName, ruleAST] of this.ruleASTs.entries()) {\r\n            const ruleStartTime = Date.now()\r\n\r\n            const ruleStats = {\r\n                time: 0,\r\n                orNodeCount: 0,\r\n                pathCount: 0,\r\n                maxPathCount: 0\r\n            }\r\n\r\n            const error = this.checkOrConflictsInNodeSmart(ruleName, ruleAST, ruleStats)\r\n            if (error) {\r\n                orConflictErrors.push(error)\r\n            }\r\n\r\n            ruleStats.time = Date.now() - ruleStartTime\r\n            perfStats.ruleStats.set(ruleName, ruleStats)\r\n        }\r\n\r\n        perfStats.totalTime = Date.now() - startTime\r\n\r\n        // è¾“å‡º FirstK vs MaxLevel æ£€æµ‹å¯¹æ¯”ç»Ÿè®¡\r\n        console.log(`\\nğŸ“Š FirstK vs MaxLevel æ£€æµ‹å¯¹æ¯”ç»Ÿè®¡:`)\r\n        console.log(`   FirstK æ£€æµ‹åˆ°é—®é¢˜: ${this.compareStats.firstKDetected} ä¸ª`)\r\n        console.log(`   ä¸¤è€…éƒ½æ£€æµ‹åˆ°: ${this.compareStats.bothDetected} ä¸ª`)\r\n        console.log(`   ä»… FirstK æ£€æµ‹åˆ° (MaxLevel æœªæ£€æµ‹åˆ°): ${this.compareStats.firstKOnlyDetected} ä¸ª`)\r\n\r\n        return orConflictErrors\r\n    }\r\n\r\n\r\n    /**\r\n     * é€’å½’æ£€æŸ¥èŠ‚ç‚¹ä¸­çš„ Or å†²çªï¼ˆæ™ºèƒ½æ¨¡å¼ï¼šå…ˆ First(1)ï¼Œæœ‰å†²çªå† First(5)ï¼‰\r\n     *\r\n     * @param ruleName è§„åˆ™å\r\n     * @param node å½“å‰èŠ‚ç‚¹\r\n     * @param ruleStats è§„åˆ™ç»Ÿè®¡ä¿¡æ¯\r\n     */\r\n    private checkOrConflictsInNodeSmart(\r\n        ruleName: string,\r\n        node: RuleNode,\r\n        ruleStats?: any\r\n    ) {\r\n        let error\r\n        switch (node.type) {\r\n            case 'or':\r\n                // ç»Ÿè®¡ Or èŠ‚ç‚¹æ•°é‡\r\n                if (ruleStats) ruleStats.orNodeCount++\r\n\r\n                // æ‰§è¡Œå†²çªæ£€æµ‹ï¼ˆå¸¦æ€§èƒ½ç»Ÿè®¡ï¼‰\r\n                error = this.detectOrBranchConflictsWithCache(ruleName, node, ruleStats)\r\n                if (error) return error\r\n\r\n                // é€’å½’æ£€æŸ¥æ¯ä¸ªåˆ†æ”¯\r\n                for (const alt of node.alternatives) {\r\n                    error = this.checkOrConflictsInNodeSmart(ruleName, alt, ruleStats)\r\n                    if (error) return error\r\n                }\r\n                break\r\n\r\n            case 'sequence':\r\n                // é€’å½’æ£€æŸ¥åºåˆ—ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹\r\n                for (const child of node.nodes) {\r\n                    error = this.checkOrConflictsInNodeSmart(ruleName, child, ruleStats)\r\n                    if (error) return error\r\n                }\r\n                break\r\n\r\n            case 'option':\r\n            case 'many':\r\n            case 'atLeastOne':\r\n                // é€’å½’æ£€æŸ¥å†…éƒ¨èŠ‚ç‚¹\r\n                error = this.checkOrConflictsInNodeSmart(ruleName, node.node, ruleStats)\r\n                if (error) return error\r\n                break\r\n\r\n            case 'consume':\r\n            case 'subrule':\r\n                // å¶å­èŠ‚ç‚¹ï¼Œä¸éœ€è¦é€’å½’\r\n                break\r\n        }\r\n    }\r\n\r\n\r\n    /**\r\n     * è·å– Or èŠ‚ç‚¹æ‰€æœ‰åˆ†æ”¯çš„å®Œæ•´è·¯å¾„ï¼ˆæ·±åº¦å±•å¼€ï¼‰\r\n     *\r\n     * æ ¸å¿ƒé€»è¾‘ï¼š\r\n     * 1. å±•å¼€æ¯ä¸ªåˆ†æ”¯åˆ°ç¬¬ä¸€å±‚ï¼ˆå¾—åˆ°è§„åˆ™ååºåˆ—ï¼‰\r\n     * 2. ä» cache è·å–æ¯ä¸ªè§„åˆ™çš„æ‰€æœ‰è·¯å¾„\r\n     * 3. ç¬›å¡å°”ç§¯ç»„åˆï¼Œå¾—åˆ°åˆ†æ”¯çš„æ‰€æœ‰å¯èƒ½è·¯å¾„\r\n     * 4. è¿”å›æ¯ä¸ªåˆ†æ”¯çš„è·¯å¾„é›†åˆ\r\n     *\r\n     * @param orNode - Or èŠ‚ç‚¹\r\n     * @param firstK - First(K) çš„ K å€¼\r\n     * @param cacheType - ç¼“å­˜ç±»å‹\r\n     * @returns æ¯ä¸ªåˆ†æ”¯çš„è·¯å¾„é›†åˆæ•°ç»„\r\n     */\r\n    getOrNodeAllBranchRules(\r\n        ruleName: string,\r\n        orNode: OrNode,\r\n        firstK: number,\r\n        cacheType: 'dfsFirstKCache' | 'bfsAllCache'\r\n    ): string[][][] {\r\n        // å­˜å‚¨æ¯ä¸ªåˆ†æ”¯çš„è·¯å¾„é›†åˆ\r\n        let allOrs: string[][][] = []\r\n\r\n        //allor\r\n        // éå† Or çš„æ¯ä¸ªåˆ†æ”¯\r\n        for (const seqNode of orNode.alternatives) {\r\n            // æ­¥éª¤1ï¼šå±•å¼€åˆ†æ”¯åˆ°ç¬¬ä¸€å±‚ï¼ˆå¾—åˆ°è§„åˆ™ååºåˆ—ï¼‰\r\n            // ä¾‹å¦‚ï¼šsequence(If, Expression, Block) â†’ [['If', 'Expression', 'Block']]\r\n            const nodeAllBranches = this.expandNode(seqNode, EXPANSION_LIMITS.INFINITY, 1, 1, false)\r\n\r\n            const isMore = firstK === EXPANSION_LIMITS.INFINITY\r\n\r\n            if (isMore) {\r\n                if (['ImportCall'].includes(ruleName)) {\r\n                    console.log(ruleName)\r\n                    console.log(nodeAllBranches)\r\n                }\r\n            }\r\n\r\n            let allBranchAllSeq: string[][] = []\r\n\r\n            //allbranch/allSeq\r\n            for (const branch of nodeAllBranches) {\r\n                //branch\r\n\r\n                // æ­¥éª¤2ï¼šä» cache è·å–æ¯ä¸ªè§„åˆ™çš„æ‰€æœ‰è·¯å¾„\r\n                // ä¾‹å¦‚ï¼š['If', 'Expression'] â†’ [[Ifçš„è·¯å¾„], [Expressionçš„è·¯å¾„]]\r\n                const seqAllBranches = branch.map(rule => {\r\n                    if (this.tokenCache.has(rule)) {\r\n                        return [[rule]]\r\n                    }\r\n                    const paths = this.getCacheValue(cacheType, rule)\r\n\r\n                    if (!paths) {\r\n                        throw new Error('ç³»ç»Ÿé”™è¯¯')\r\n                    }\r\n                    // é˜²å¾¡ï¼šå¦‚æœè§„åˆ™ä¸åœ¨ç¼“å­˜ä¸­ï¼Œè¿”å› [[rule]]\r\n                    return paths\r\n                })\r\n\r\n\r\n                // æ­¥éª¤3ï¼šç¬›å¡å°”ç§¯ç»„åˆï¼Œå¾—åˆ°å½“å‰åˆ†æ”¯çš„æ‰€æœ‰å¯èƒ½è·¯å¾„\r\n                // ä¾‹å¦‚ï¼š[[a,b], [c,d]] Ã— [[e], [f,g]] â†’ [[a,b,e], [a,b,f,g], [c,d,e], [c,d,f,g]]\r\n                const branchAllSeq = this.cartesianProduct(seqAllBranches, firstK)\r\n\r\n                if (isMore) {\r\n                    if (branchAllSeq.length > 10000) {\r\n                        console.log(ruleName)\r\n                        console.log('branchAllSeq.length')\r\n                        console.log(branchAllSeq.length)\r\n                    }\r\n                }\r\n\r\n                // åˆå¹¶åˆ°ç»“æœä¸­\r\n                allBranchAllSeq = allBranchAllSeq.concat(branchAllSeq)\r\n            }\r\n            allOrs.push(this.deduplicate(allBranchAllSeq))\r\n        }\r\n\r\n        // ç»Ÿä¸€å»é‡ï¼šå¤šä¸ªåˆ†æ”¯å¯èƒ½äº§ç”Ÿç›¸åŒçš„è·¯å¾„\r\n        return allOrs\r\n    }\r\n\r\n    private removeDuplicatePaths(\r\n        pathsFront: string[][],\r\n        pathsBehind: string[][]\r\n    ): string[][] {\r\n        // é˜²å¾¡ï¼šå¦‚æœè¾“å…¥ä¸ºç©ºï¼Œç›´æ¥è¿”å›\r\n        if (pathsBehind.length === 0) {\r\n            return []\r\n        }\r\n\r\n        // æ­¥éª¤1ï¼šå°† pathsFront è½¬æ¢ä¸º Set<string>ï¼ˆç”¨äºå¿«é€ŸæŸ¥æ‰¾ï¼‰\r\n        const frontSet = new Set<string>()\r\n        for (const path of pathsFront) {\r\n            // å°†è·¯å¾„æ•°ç»„è½¬æ¢ä¸ºå­—ç¬¦ä¸²ä½œä¸º key\r\n            const key = path.join(EXPANSION_LIMITS.RuleJoinSymbol)\r\n            frontSet.add(key)\r\n        }\r\n\r\n        // æ­¥éª¤2ï¼šè¿‡æ»¤ pathsBehindï¼Œåªä¿ç•™ä¸åœ¨ Set ä¸­çš„è·¯å¾„\r\n        const uniqueBehind: string[][] = []\r\n        for (const path of pathsBehind) {\r\n            const key = path.join(EXPANSION_LIMITS.RuleJoinSymbol)\r\n            if (!frontSet.has(key)) {\r\n                uniqueBehind.push(path)\r\n            }\r\n        }\r\n        return uniqueBehind\r\n    }\r\n\r\n    /**\r\n     * ä½¿ç”¨å‰ç¼€æ ‘æ£€æµ‹ä¸¤ä¸ªè·¯å¾„é›†åˆä¸­æ˜¯å¦å­˜åœ¨å®Œå…¨ç›¸åŒçš„è·¯å¾„\r\n     *\r\n     * @param pathsFront - å‰é¢åˆ†æ”¯çš„è·¯å¾„æ•°ç»„\r\n     * @param pathsBehind - åé¢åˆ†æ”¯çš„è·¯å¾„æ•°ç»„\r\n     * @returns å¦‚æœæ‰¾åˆ°å®Œå…¨ç›¸åŒçš„è·¯å¾„è¿”å›è¯¥è·¯å¾„ï¼Œå¦åˆ™è¿”å› null\r\n     */\r\n    private findEqualPath(\r\n        pathsFront: string[][],\r\n        pathsBehind: string[][]\r\n    ): string[] | null {\r\n        // æ—¶é—´å¤æ‚åº¦ï¼šO((m+n)*k)\r\n        // ç©ºé—´å¤æ‚åº¦ï¼šO(m) - åªéœ€è¦å­˜å‚¨å­—ç¬¦ä¸²\r\n        const behindSet = new Set<string>()\r\n        for (const path of pathsBehind) {\r\n            behindSet.add(path.join(EXPANSION_LIMITS.RuleJoinSymbol))  // O(k)\r\n        }\r\n        for (const pathFront of pathsFront) {\r\n            const key = pathFront.join(EXPANSION_LIMITS.RuleJoinSymbol)  // O(k)\r\n            if (behindSet.has(key)) {  // O(1)\r\n                return pathFront\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * ä½¿ç”¨å‰ç¼€æ ‘æ£€æµ‹ä¸¤ä¸ªè·¯å¾„é›†åˆä¸­çš„å‰ç¼€å…³ç³»\r\n     *\r\n     * @param pathsFront - å‰é¢åˆ†æ”¯çš„è·¯å¾„æ•°ç»„\r\n     * @param pathsBehind - åé¢åˆ†æ”¯çš„è·¯å¾„æ•°ç»„\r\n     * @returns å¦‚æœæ‰¾åˆ°å‰ç¼€å…³ç³»è¿”å› { prefix, full }ï¼Œå¦åˆ™è¿”å› null\r\n     */\r\n    private trieTreeFindPrefixMatch(\r\n        pathsFront: string[][],\r\n        pathsBehind: string[][]\r\n    ): { prefix: string[], full: string[] } | null {\r\n        // é˜²å¾¡ï¼šå¦‚æœæ²¡æœ‰å¯æ¯”è¾ƒçš„è·¯å¾„ï¼Œç›´æ¥è¿”å›\r\n        if (pathsBehind.length === 0 || pathsFront.length === 0) {\r\n            return null\r\n        }\r\n\r\n        // è¿‡æ»¤æ‰ä¸ pathsFront å®Œå…¨ç›¸åŒçš„è·¯å¾„\r\n        const uniqueBehind = this.removeDuplicatePaths(pathsFront, pathsBehind)\r\n\r\n        // å¦‚æœè¿‡æ»¤åæ²¡æœ‰è·¯å¾„ï¼Œç›´æ¥è¿”å›\r\n        if (uniqueBehind.length === 0) {\r\n            return null\r\n        }\r\n\r\n        // æ­¥éª¤2ï¼šæ„å»ºå‰ç¼€æ ‘ï¼ˆO(m*k)ï¼Œm=pathsBehind.lengthï¼Œk=å¹³å‡è·¯å¾„é•¿åº¦ï¼‰\r\n        const trie = new ArrayTrie()\r\n        for (const path of uniqueBehind) {\r\n            // å°†æ¯ä¸ªè·¯å¾„æ’å…¥åˆ°å‰ç¼€æ ‘ä¸­\r\n            trie.insert(path)\r\n        }\r\n\r\n        // æ­¥éª¤3ï¼šæŸ¥è¯¢å‰ç¼€å…³ç³»ï¼ˆO(n*k)ï¼Œn=pathsFront.lengthï¼‰\r\n        for (const pathFront of pathsFront) {\r\n            // ä½¿ç”¨å‰ç¼€æ ‘æŸ¥æ‰¾åŒ¹é…\r\n            // æŸ¥æ‰¾æ˜¯å¦æœ‰ä»¥ pathFront ä¸ºå‰ç¼€çš„æ›´é•¿è·¯å¾„\r\n            const fullPath = trie.findPrefixMatch(pathFront)\r\n\r\n            if (fullPath) {\r\n                // æ‰¾åˆ°å‰ç¼€å…³ç³»\r\n                return {\r\n                    prefix: pathFront,\r\n                    full: fullPath\r\n                }\r\n            }\r\n        }\r\n\r\n        // æ²¡æœ‰å‰ç¼€å…³ç³»\r\n        return null\r\n    }\r\n\r\n    /**\r\n     * ç”Ÿæˆå‰ç¼€å†²çªçš„ä¿®å¤å»ºè®®\r\n     *\r\n     * @param ruleName - è§„åˆ™å\r\n     * @param branchA - åˆ†æ”¯Aç´¢å¼•\r\n     * @param branchB - åˆ†æ”¯Bç´¢å¼•\r\n     * @param conflict - å†²çªä¿¡æ¯\r\n     * @returns ä¿®å¤å»ºè®®\r\n     */\r\n    private getPrefixConflictSuggestion(\r\n        ruleName: string,\r\n        branchA: number,\r\n        branchB: number,\r\n        conflict: { prefix: string, full: string, type: 'prefix' | 'equal' }\r\n    ): string {\r\n        if (conflict.type === 'equal') {\r\n            return `åˆ†æ”¯ ${branchA + 1} å’Œåˆ†æ”¯ ${branchB + 1} çš„è·¯å¾„å®Œå…¨ç›¸åŒï¼\r\n\r\nè¿™æ„å‘³ç€ï¼š\r\n- ä¸¤ä¸ªåˆ†æ”¯ä¼šåŒ¹é…ç›¸åŒçš„è¾“å…¥\r\n- åˆ†æ”¯ ${branchB + 1} æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œï¼ˆå› ä¸ºåˆ†æ”¯ ${branchA + 1} åœ¨å‰é¢ï¼‰\r\n\r\nç¤ºä¾‹ï¼š\r\nor([A, A, B]) â†’ or([A, B])  // åˆ é™¤é‡å¤çš„A`\r\n        }\r\n\r\n        return ``\r\n    }\r\n\r\n    /**\r\n     * çº¿è·¯1ï¼šä½¿ç”¨ First(K) æ£€æµ‹ Or åˆ†æ”¯å†²çªï¼ˆæ™ºèƒ½æ£€æµ‹ï¼‰\r\n     *\r\n     * æ£€æµ‹é€»è¾‘ï¼šå¯¹æ¯ä¸ªè·¯å¾„å¯¹ï¼Œæ ¹æ®é•¿åº¦é€‰æ‹©æ£€æµ‹æ–¹æ³•\r\n     * - è·¯å¾„é•¿åº¦éƒ½ç­‰äº firstKï¼šæ£€æµ‹æ˜¯å¦å®Œå…¨ç›¸åŒï¼ˆfindEqualPathï¼‰\r\n     * - å‰é¢è·¯å¾„é•¿åº¦ < firstKï¼šæ£€æµ‹æ˜¯å¦æ˜¯å‰ç¼€ï¼ˆfindPrefixRelationï¼‰\r\n     *\r\n     * æ•°æ®æºï¼šdfsFirstKCacheï¼ˆFirst(K) çš„å±•å¼€ç»“æœï¼‰\r\n     *\r\n     * @param ruleName è¾“å‡ºé”™è¯¯æ—¥å¿—ä½¿ç”¨\r\n     * @param orNode - Or èŠ‚ç‚¹\r\n     * @param ruleStats\r\n     */\r\n    detectOrBranchEqualWithFirstK(\r\n        ruleName: string,\r\n        orNode: OrNode,\r\n        ruleStats?: any\r\n    ) {\r\n        // é˜²å¾¡ï¼šè‡³å°‘éœ€è¦2ä¸ªåˆ†æ”¯\r\n        if (orNode.alternatives.length < 2) {\r\n            return\r\n        }\r\n\r\n        // è·å–æ¯ä¸ªåˆ†æ”¯çš„ First(K) è·¯å¾„é›†åˆ\r\n        const branchPathSets = this.getOrNodeAllBranchRules(ruleName, orNode, EXPANSION_LIMITS.FIRST_K, 'dfsFirstKCache')\r\n        const firstK = EXPANSION_LIMITS.FIRST_K\r\n\r\n        // ç»Ÿè®¡è·¯å¾„æ•°é‡\r\n        if (ruleStats) {\r\n            const totalPaths = branchPathSets.reduce((sum, paths) => sum + paths.length, 0)\r\n            const maxPaths = Math.max(...branchPathSets.map(paths => paths.length))\r\n            ruleStats.pathCount += totalPaths\r\n            ruleStats.maxPathCount = Math.max(ruleStats.maxPathCount, maxPaths)\r\n        }\r\n\r\n        // å•å‘éå†ï¼šæ£€æµ‹å‰é¢çš„åˆ†æ”¯æ˜¯å¦ä¸åé¢çš„åˆ†æ”¯å†²çª\r\n        for (let i = 0; i < branchPathSets.length; i++) {\r\n            for (let j = i + 1; j < branchPathSets.length; j++) {\r\n                const pathsFront = branchPathSets[i]\r\n                const pathsBehind = branchPathSets[j]\r\n\r\n                // æ£€æµ‹ç›¸ç­‰å†²çª\r\n                const equalPath = this.findEqualPath(pathsFront, pathsBehind)\r\n                if (equalPath) {\r\n                    const equalPathStr = equalPath.join(EXPANSION_LIMITS.RuleJoinSymbol)\r\n                    return {\r\n                        level: 'ERROR',\r\n                        type: 'or-identical-branches',\r\n                        ruleName,\r\n                        branchIndices: [i, j],\r\n                        conflictPaths: {\r\n                            pathA: equalPathStr,\r\n                            pathB: equalPathStr\r\n                        },\r\n                        message: `è§„åˆ™ \"${ruleName}\" çš„ Or åˆ†æ”¯ ${i + 1} å’Œåˆ†æ”¯ ${j + 1} çš„å‰ ${firstK} ä¸ª token å®Œå…¨ç›¸åŒ`,\r\n                        suggestion: this.getEqualBranchSuggestion(ruleName, i, j, equalPathStr)\r\n                    }\r\n                }\r\n\r\n                // æ£€æµ‹å‰ç¼€å†²çª\r\n                const prefixRelation = this.trieTreeFindPrefixMatch(pathsFront, pathsBehind)\r\n                if (prefixRelation) {\r\n                    const prefixStr = prefixRelation.prefix.join(EXPANSION_LIMITS.RuleJoinSymbol)\r\n                    const fullStr = prefixRelation.full.join(EXPANSION_LIMITS.RuleJoinSymbol)\r\n                    return {\r\n                        level: 'ERROR',\r\n                        type: 'prefix-conflict',\r\n                        ruleName,\r\n                        branchIndices: [i, j],\r\n                        conflictPaths: {\r\n                            pathA: prefixStr,\r\n                            pathB: fullStr\r\n                        },\r\n                        message: `è§„åˆ™ \"${ruleName}\" çš„ Or åˆ†æ”¯ ${i + 1} ä¼šé®è”½åˆ†æ”¯ ${j + 1}ï¼ˆåœ¨ First(${firstK}) é˜¶æ®µæ£€æµ‹åˆ°ï¼‰`,\r\n                        suggestion: this.getPrefixConflictSuggestion(ruleName, i, j, {\r\n                            prefix: prefixStr,\r\n                            full: fullStr,\r\n                            type: 'prefix'\r\n                        })\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n\r\n    /**\r\n     * çº¿è·¯2ï¼šä½¿ç”¨ MaxLevel æ£€æµ‹ Or åˆ†æ”¯çš„å‰ç¼€é®è”½å…³ç³»\r\n     *\r\n     * æ£€æµ‹ç›®æ ‡ï¼šå‰é¢çš„åˆ†æ”¯æ˜¯å¦æ˜¯åé¢åˆ†æ”¯çš„å‰ç¼€\r\n     * æ•°æ®æºï¼šbfsAllCacheï¼ˆæ·±åº¦å±•å¼€çš„å®Œæ•´è·¯å¾„ï¼‰\r\n     * æ£€æµ‹æ–¹æ³•ï¼šfindPrefixRelation()\r\n     * æ€§èƒ½ï¼šO(nÂ²) - æ·±åº¦æ£€æµ‹\r\n     *\r\n     * é€‚ç”¨åœºæ™¯ï¼š\r\n     * - æ£€æµ‹å‰ç¼€é®è”½é—®é¢˜\r\n     * - éœ€è¦æ·±åº¦å±•å¼€æ‰èƒ½å‘ç°çš„å†²çª\r\n     *\r\n     * @param ruleName - è§„åˆ™å\r\n     * @param orNode - Or èŠ‚ç‚¹\r\n     */\r\n    detectOrBranchPrefixWithMaxLevel(\r\n        ruleName: string,\r\n        orNode: OrNode,\r\n        ruleStats?: any\r\n    ) {\r\n        // é˜²å¾¡ï¼šè‡³å°‘éœ€è¦2ä¸ªåˆ†æ”¯\r\n        if (orNode.alternatives.length < 2) {\r\n            return\r\n        }\r\n\r\n        // è·å–æ¯ä¸ªåˆ†æ”¯çš„æ·±åº¦å±•å¼€è·¯å¾„é›†åˆ\r\n        const branchPathSets = this.getOrNodeAllBranchRules(ruleName, orNode, EXPANSION_LIMITS.INFINITY, 'bfsAllCache')\r\n\r\n        // ç»Ÿè®¡è·¯å¾„æ•°é‡ï¼ˆMaxLevel çš„è·¯å¾„å¯èƒ½éå¸¸å¤šï¼‰\r\n        if (ruleStats) {\r\n            const totalPaths = branchPathSets.reduce((sum, paths) => sum + paths.length, 0)\r\n            const maxPaths = Math.max(...branchPathSets.map(paths => paths.length))\r\n\r\n        }\r\n\r\n        // å•å‘éå†ï¼šæ£€æµ‹å‰é¢çš„åˆ†æ”¯æ˜¯å¦é®è”½åé¢çš„åˆ†æ”¯\r\n        for (let i = 0; i < branchPathSets.length; i++) {\r\n            for (let j = i + 1; j < branchPathSets.length; j++) {\r\n                const pathsFront = branchPathSets[i]\r\n                const pathsBehind = branchPathSets[j]\r\n\r\n                // æ£€æµ‹å‰ç¼€å…³ç³»ï¼ˆO(nÂ²)ï¼‰\r\n                const prefixRelation = this.trieTreeFindPrefixMatch(pathsFront, pathsBehind)\r\n\r\n                if (prefixRelation) {\r\n                    // å°†è·¯å¾„æ•°ç»„è½¬æ¢ä¸ºå­—ç¬¦ä¸²\r\n                    const prefixStr = prefixRelation.prefix.join(EXPANSION_LIMITS.RuleJoinSymbol)\r\n                    const fullStr = prefixRelation.full.join(EXPANSION_LIMITS.RuleJoinSymbol)\r\n\r\n                    // å‘ç°å‰ç¼€é®è”½ï¼ŒæŠ¥å‘Šé”™è¯¯\r\n                    return ({\r\n                        level: 'ERROR' as const,\r\n                        type: 'prefix-conflict' as const,\r\n                        ruleName,\r\n                        branchIndices: [i, j] as [number, number],\r\n                        conflictPaths: {\r\n                            pathA: prefixStr,\r\n                            pathB: fullStr\r\n                        },\r\n                        message: `è§„åˆ™ \"${ruleName}\" çš„ Or åˆ†æ”¯ ${i + 1} ä¼šé®è”½åˆ†æ”¯ ${j + 1}`,\r\n                        suggestion: this.getPrefixConflictSuggestion(ruleName, i, j, {\r\n                            prefix: prefixStr,\r\n                            full: fullStr,\r\n                            type: 'prefix'\r\n                        })\r\n                    })\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * ç”Ÿæˆç›¸åŒåˆ†æ”¯çš„ä¿®å¤å»ºè®®\r\n     */\r\n    private getEqualBranchSuggestion(\r\n        ruleName: string,\r\n        branchA: number,\r\n        branchB: number,\r\n        equalPath: string\r\n    ): string {\r\n        return `åˆ†æ”¯ ${branchA + 1} å’Œåˆ†æ”¯ ${branchB + 1} çš„è·¯å¾„å®Œå…¨ç›¸åŒï¼\r\n\r\næ£€æµ‹åˆ°çš„é—®é¢˜ï¼š\r\n  ç›¸åŒè·¯å¾„: ${equalPath}\r\n\r\nè¿™æ„å‘³ç€ï¼š\r\n- ä¸¤ä¸ªåˆ†æ”¯ä¼šåŒ¹é…ç›¸åŒçš„è¾“å…¥\r\n- åˆ†æ”¯ ${branchB + 1} æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œï¼ˆå› ä¸ºåˆ†æ”¯ ${branchA + 1} åœ¨å‰é¢ï¼‰\r\n\r\nä¿®å¤å»ºè®®ï¼š\r\n1. **åˆ é™¤é‡å¤åˆ†æ”¯**ï¼šä¿ç•™å…¶ä¸­ä¸€ä¸ªåˆ†æ”¯å³å¯\r\n2. **æ£€æŸ¥é€»è¾‘**ï¼šç¡®è®¤æ˜¯å¦æ˜¯å¤åˆ¶ç²˜è´´é”™è¯¯\r\n3. **åˆå¹¶åˆ†æ”¯**ï¼šå¦‚æœè¯­ä¹‰ç›¸åŒï¼Œåˆå¹¶ä¸ºä¸€ä¸ªåˆ†æ”¯\r\n\r\nç¤ºä¾‹ï¼š\r\nor([A, A, B]) â†’ or([A, B])  // åˆ é™¤é‡å¤çš„A`\r\n    }\r\n\r\n    /**\r\n     * å®Œæ•´çš„ Or åˆ†æ”¯æ·±åº¦æ£€æµ‹ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰- å¸¦é˜²å¾¡æ€§æ ¡éªŒ\r\n     *\r\n     * æ£€æµ‹æµç¨‹ï¼š\r\n     * 1. çº¿è·¯1ï¼šä½¿ç”¨ First(K) å¿«é€Ÿæ£€æµ‹\r\n     * 2. å¦‚æœå‘ç°\"é®è”½\"é”™è¯¯ï¼šä½¿ç”¨ MaxLevel æ·±åº¦æ£€æµ‹è¿›è¡ŒéªŒè¯ï¼ˆé˜²å¾¡æ€§ç¼–ç¨‹ï¼‰\r\n     * 3. å¦‚æœå‘ç°\"ç›¸åŒ\"é”™è¯¯ï¼šç›´æ¥è¿”å›ï¼ˆä¸éœ€è¦éªŒè¯ï¼‰\r\n     *\r\n     * é˜²å¾¡æ€§ç¼–ç¨‹ï¼š\r\n     * - å¦‚æœ First(K) æ£€æµ‹åˆ°é®è”½ï¼ŒMaxLevel å¿…é¡»ä¹Ÿèƒ½æ£€æµ‹åˆ°\r\n     * - å¦åˆ™è¯´æ˜ä¸¤ä¸ªæ£€æµ‹é€»è¾‘ä¸ä¸€è‡´ï¼ŒæŠ›å‡ºé”™è¯¯\r\n     *\r\n     * @param ruleName - è§„åˆ™å\r\n     * @param orNode - Or èŠ‚ç‚¹\r\n     * @returns æ£€æµ‹åˆ°çš„é”™è¯¯ï¼Œå¦‚æœæ²¡æœ‰é”™è¯¯è¿”å› undefined\r\n     */\r\n    /**\r\n     * å®Œæ•´çš„ Or åˆ†æ”¯æ£€æµ‹ï¼ˆFirst(K) é¢„æ£€ + MaxLevel æ·±åº¦æ£€æµ‹ï¼‰\r\n     *\r\n     * ä¸šåŠ¡é€»è¾‘ï¼š\r\n     * 1. First(K) é¢„æ£€ï¼šå¿«é€Ÿæ£€æµ‹ç›¸åŒ/é®è”½é”™è¯¯\r\n     * 2. æœ‰ä»»ä½•é”™è¯¯ â†’ æ‰§è¡Œ MaxLevel æ·±åº¦æ£€æµ‹\r\n     * 3. é˜²å¾¡æ€§æ£€æŸ¥ï¼šå¦‚æœ First(K) æ£€æµ‹åˆ°é®è”½ï¼ŒMaxLevel å¿…é¡»ä¹Ÿèƒ½æ£€æµ‹åˆ°\r\n     * 4. è¿”å›ç»“æœï¼šä¼˜å…ˆè¿”å› MaxLevel ç»“æœï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å› First(K) ç»“æœ\r\n     *\r\n     * @param ruleName - è§„åˆ™å\r\n     * @param orNode - Or èŠ‚ç‚¹\r\n     * @returns æ£€æµ‹åˆ°çš„é”™è¯¯ï¼Œå¦‚æœæ²¡æœ‰é”™è¯¯è¿”å› undefined\r\n     */\r\n    // FirstK vs MaxLevel æ£€æµ‹å¯¹æ¯”ç»Ÿè®¡ï¼ˆå…¨å±€å±æ€§ï¼‰\r\n    private compareStats = {\r\n        firstKDetected: 0,\r\n        bothDetected: 0,\r\n        firstKOnlyDetected: 0,\r\n    }\r\n\r\n    detectOrBranchConflictsWithCache(\r\n        ruleName: string,\r\n        orNode: OrNode,\r\n        ruleStats?: any\r\n    ) {\r\n        const orStartTime = Date.now()\r\n\r\n        // ğŸš€ çº¿è·¯1ï¼šFirst(K) é¢„æ£€ï¼ˆå¿«é€Ÿï¼‰\r\n        let firstKError = this.detectOrBranchEqualWithFirstK(ruleName, orNode, ruleStats)\r\n\r\n        // æƒ…å†µ1ï¼šé¢„æ£€é€šè¿‡ï¼Œæ²¡æœ‰å‘ç°é”™è¯¯\r\n        if (!firstKError) {\r\n            // ç›´æ¥è¿”å›ï¼Œæ— éœ€æ·±åº¦æ£€æµ‹\r\n            return\r\n        }\r\n\r\n        // FirstK æ£€æµ‹åˆ°é—®é¢˜\r\n        this.compareStats.firstKDetected++\r\n\r\n        // æƒ…å†µ2ï¼šé¢„æ£€å‘ç°é”™è¯¯ï¼ˆç›¸åŒ/é®è”½ï¼‰ï¼Œæ‰§è¡Œæ·±åº¦æ£€æµ‹\r\n        const maxLevelError = this.detectOrBranchPrefixWithMaxLevel(ruleName, orNode, ruleStats)\r\n\r\n        // ç»Ÿè®¡ FirstK vs MaxLevel ç»“æœå¯¹æ¯”\r\n        if (maxLevelError) {\r\n            this.compareStats.bothDetected++\r\n        } else {\r\n            this.compareStats.firstKOnlyDetected++\r\n        }\r\n\r\n        const orTime = Date.now() - orStartTime\r\n\r\n        // ğŸ›¡ï¸ é˜²å¾¡æ€§ç¼–ç¨‹ï¼šå¦‚æœ First(K) æ£€æµ‹åˆ°é®è”½ï¼ŒMaxLevel å¿…é¡»ä¹Ÿèƒ½æ£€æµ‹åˆ°\r\n        if (firstKError.type === 'prefix-conflict') {\r\n            if (!maxLevelError) {\r\n                const errorMsg = `\r\nğŸ”´ ========== é˜²å¾¡æ€§æ£€æŸ¥å¤±è´¥ ==========\r\nè§„åˆ™: ${ruleName}\r\né—®é¢˜: First(K) æ£€æµ‹åˆ°é®è”½ï¼Œä½† MaxLevel æœªæ£€æµ‹åˆ°\r\n\r\nFirst(K) æ£€æµ‹ç»“æœ:\r\n  ç±»å‹: ${firstKError.type}\r\n  åˆ†æ”¯: ${firstKError.branchIndices[0] + 1} â†’ ${firstKError.branchIndices[1] + 1}\r\n  å‰ç¼€: ${firstKError.conflictPaths?.pathA}\r\n  å®Œæ•´: ${firstKError.conflictPaths?.pathB}\r\n\r\nMaxLevel æ£€æµ‹ç»“æœ: æ— å†²çª\r\n\r\nå¯èƒ½åŸå› :\r\n1. First(K) è¯¯æŠ¥ï¼ˆæ£€æµ‹é€»è¾‘é”™è¯¯ï¼‰\r\n2. MaxLevel æ¼æ£€ï¼ˆæ£€æµ‹é€»è¾‘é”™è¯¯ï¼‰\r\n3. dfsFirstKCache å’Œ bfsAllCache æ•°æ®ä¸ä¸€è‡´\r\n==========================================`\r\n                console.error(errorMsg)\r\n                throw new Error(`é˜²å¾¡æ€§æ£€æŸ¥å¤±è´¥: First(K) æ£€æµ‹åˆ°é®è”½ä½† MaxLevel æœªæ£€æµ‹åˆ° (è§„åˆ™: ${ruleName})`)\r\n            }\r\n        }\r\n\r\n        // åªè¿”å›é®è”½é—®é¢˜ï¼Œéé®è”½ä¸ç®—é—®é¢˜\r\n        return maxLevelError\r\n    }\r\n\r\n    depthMap = new Map()\r\n\r\n    private findRuleDepth(\r\n        ruleName: string,\r\n    ) {\r\n        // console.log('è¿›å…¥å­è§„åˆ™')\r\n        // console.log(ruleName)\r\n        // å±‚çº§+1ï¼ˆè¿›å…¥å­è§„åˆ™ï¼‰\r\n        // curLevel++\r\n        // ========================================\r\n        // é˜¶æ®µ2ï¼šé€’å½’æ£€æµ‹ï¼ˆDFS ä¸“å±ï¼‰\r\n        // ========================================\r\n\r\n        // é€’å½’æ£€æµ‹ï¼šå¦‚æœè§„åˆ™æ­£åœ¨è®¡ç®—ä¸­\r\n        if (this.recursiveDetectionSet.has(ruleName)) {\r\n            // è®°å½•é€’å½’æ£€æµ‹è¿”å›ï¼Œç”¨äºåˆ†æä¸ºä»€ä¹ˆéƒ½æ˜¯1\r\n            return 1\r\n        }\r\n\r\n        // æ ‡è®°å½“å‰è§„åˆ™æ­£åœ¨è®¡ç®—ï¼ˆé˜²æ­¢å¾ªç¯é€’å½’ï¼‰\r\n        this.recursiveDetectionSet.add(ruleName)\r\n\r\n        try {\r\n            const node = this.ruleASTs.get(ruleName)\r\n            // ä¿®å¤ï¼šnode ä¸ä¸€å®šæ˜¯ SequenceNodeï¼Œåº”è¯¥è°ƒç”¨ findNodeDepth æ¥æ­£ç¡®å¤„ç†æ‰€æœ‰ç±»å‹\r\n\r\n            const result = this.findNodeDepth(node)\r\n\r\n            if (result > 1000000) {\r\n                console.log(ruleName)\r\n                console.log(result)\r\n            }\r\n            return result\r\n        } finally {\r\n            // æ¸…é™¤é€’å½’æ ‡è®°ï¼ˆç¡®ä¿å³ä½¿å¼‚å¸¸ä¹Ÿèƒ½æ¸…é™¤ï¼‰\r\n            this.recursiveDetectionSet.delete(ruleName)\r\n        }\r\n    }\r\n\r\n    //0å’Œ1å¥½ 1å’Œ2 ï¼Œéƒ½æ˜¯ä¸¤ç§å¯èƒ½æ€§\r\n    manyAndOptionDepth(node: ManyNode | OptionNode) {\r\n        const num = this.findNodeDepth(node.node)\r\n        // option å’Œ many çš„ 0 æ¬¡éƒ½æ²¡æœ‰æ„ä¹‰ï¼Œåªè®¡ç®—åŒ¹é…çš„æƒ…å†µ\r\n        return num + num\r\n    }\r\n\r\n\r\n    atLeastOneDepth(node: AtLeastOneNode) {\r\n        const num = this.findNodeDepth(node.node)\r\n        return num + num\r\n    }\r\n\r\n    seqDepth(seq: SequenceNode) {\r\n        if (seq.nodes.length < 1) {\r\n            return 1\r\n        }\r\n        let all = 1\r\n        for (let i = 0; i < seq.nodes.length; i++) {\r\n            const node = seq.nodes[i]\r\n            const depth = this.findNodeDepth(node)\r\n            all = all * depth\r\n        }\r\n        return all\r\n    }\r\n\r\n    orDepth(or: OrNode) {\r\n        if (or.alternatives.length < 1) {\r\n            throw new Error('xitongcuowu')\r\n        }\r\n        let orPossibility: number = 0\r\n\r\n        for (let i = 0; i < or.alternatives.length; i++) {\r\n            const alternative = or.alternatives[i]\r\n            const depth = this.findNodeDepth(alternative)\r\n\r\n            orPossibility += depth\r\n        }\r\n        if (orPossibility === 0) {\r\n            throw new Error('ç³»ç»Ÿé”™è¯¯')\r\n        }\r\n        return orPossibility\r\n    }\r\n\r\n    findNodeDepth(\r\n        node: RuleNode\r\n    ): number {\r\n        // è¶…æ—¶æ£€æµ‹\r\n        this.checkTimeout('findNodeDepth')\r\n        const callId = this.perfAnalyzer.startMethod('findNodeDepth')\r\n\r\n        // DFS æ€»æ˜¯æ— é™å±•å¼€\r\n        // æ ¹æ®èŠ‚ç‚¹ç±»å‹åˆ†å‘å¤„ç†\r\n        let result: number\r\n        switch (node.type) {\r\n            case 'consume':\r\n                // Token èŠ‚ç‚¹ï¼šç›´æ¥è¿”å› token å\r\n                result = 1\r\n                break\r\n\r\n            case 'subrule':\r\n                // å­è§„åˆ™å¼•ç”¨ï¼šè½¬å‘ç»™ subRuleHandler å¤„ç†\r\n                result = this.findRuleDepth(node.ruleName)\r\n                break\r\n\r\n            case 'or':\r\n                // Or èŠ‚ç‚¹ï¼šéå†æ‰€æœ‰åˆ†æ”¯ï¼Œåˆå¹¶ç»“æœ\r\n                // ğŸ”´ å…³é”®ï¼šOr åˆ†æ”¯ä¸­çš„ç¬¬ä¸€ä¸ªè§„åˆ™ä¹Ÿéœ€è¦ä¼ é€’ isFirstPosition\r\n                result = this.orDepth(node)\r\n                break\r\n\r\n            case 'sequence':\r\n                // Sequence èŠ‚ç‚¹ï¼šç¬›å¡å°”ç§¯ç»„åˆå­èŠ‚ç‚¹\r\n                result = this.seqDepth(node)\r\n                break\r\n\r\n            case 'option':\r\n            case 'many':\r\n            case 'atLeastOne':\r\n                // Option/Many èŠ‚ç‚¹ï¼š0æ¬¡æˆ–å¤šæ¬¡ï¼Œæ·»åŠ ç©ºåˆ†æ”¯\r\n                // ğŸ”´ å…³é”®ï¼šOption å†…çš„ç¬¬ä¸€ä¸ªè§„åˆ™ä¹Ÿéœ€è¦ä¼ é€’ isFirstPosition\r\n                result = this.manyAndOptionDepth(node)\r\n                break\r\n\r\n            default:\r\n                // æœªçŸ¥èŠ‚ç‚¹ç±»å‹ï¼ŒæŠ›å‡ºé”™è¯¯\r\n                throw new Error(`æœªçŸ¥èŠ‚ç‚¹ç±»å‹: ${(node as any).type}`)\r\n        }\r\n\r\n        // è®°å½•æ€§èƒ½ç»Ÿè®¡\r\n        this.perfAnalyzer.endMethod(callId, undefined)\r\n\r\n        // æ·»åŠ èŠ‚ç‚¹ç±»å‹ä¿¡æ¯ï¼Œä¾¿äºåˆ†æ\r\n        return result\r\n    }\r\n\r\n\r\n    deepDepth(node: RuleNode, depth: number) {\r\n        // è¶…æ—¶æ£€æµ‹\r\n        this.checkTimeout('deepDepth')\r\n        const callId = this.perfAnalyzer.startMethod('findNodeDepth')\r\n\r\n        // DFS æ€»æ˜¯æ— é™å±•å¼€\r\n        // æ ¹æ®èŠ‚ç‚¹ç±»å‹åˆ†å‘å¤„ç†\r\n        let result: number\r\n        let tempary = []\r\n        switch (node.type) {\r\n            case 'consume':\r\n                // Token èŠ‚ç‚¹ï¼šç›´æ¥è¿”å› token å\r\n                result = depth\r\n                break\r\n\r\n            case 'subrule':\r\n                const ruleName = (node as SubruleNode).ruleName\r\n\r\n                if (this.depmap.has(ruleName)) {\r\n                    return this.depmap.get(ruleName)\r\n                }\r\n\r\n                if (this.recursiveDetectionSet.has(ruleName)) {\r\n                    // è®°å½•é€’å½’æ£€æµ‹è¿”å›ï¼Œç”¨äºåˆ†æä¸ºä»€ä¹ˆéƒ½æ˜¯1\r\n                    return depth\r\n                }\r\n                depth++\r\n\r\n                // æ ‡è®°å½“å‰è§„åˆ™æ­£åœ¨è®¡ç®—ï¼ˆé˜²æ­¢å¾ªç¯é€’å½’ï¼‰\r\n                this.recursiveDetectionSet.add(ruleName)\r\n\r\n                const subNode = this.ruleASTs.get(ruleName)\r\n\r\n                result = this.deepDepth(subNode, depth)\r\n                // æ¸…é™¤é€’å½’æ ‡è®°ï¼ˆç¡®ä¿å³ä½¿å¼‚å¸¸ä¹Ÿèƒ½æ¸…é™¤ï¼‰\r\n                this.recursiveDetectionSet.delete(ruleName)\r\n                break\r\n\r\n            case 'or':\r\n                tempary = []\r\n                for (const alternative of node.alternatives) {\r\n                    tempary.push(this.deepDepth(alternative, depth))\r\n                }\r\n                result = Math.max(...tempary)\r\n                break\r\n\r\n            case 'sequence':\r\n                tempary = []\r\n                for (const alternative of node.nodes) {\r\n                    tempary.push(this.deepDepth(alternative, depth))\r\n                }\r\n                result = Math.max(...tempary)\r\n                break\r\n\r\n            case 'option':\r\n            case 'many':\r\n            case 'atLeastOne':\r\n                result = this.deepDepth((node as OptionNode).node, depth)\r\n                break\r\n\r\n            default:\r\n                // æœªçŸ¥èŠ‚ç‚¹ç±»å‹ï¼ŒæŠ›å‡ºé”™è¯¯\r\n                throw new Error(`æœªçŸ¥èŠ‚ç‚¹ç±»å‹: ${(node as any).type}`)\r\n        }\r\n\r\n        // è®°å½•æ€§èƒ½ç»Ÿè®¡\r\n        this.perfAnalyzer.endMethod(callId, undefined)\r\n\r\n        // æ·»åŠ èŠ‚ç‚¹ç±»å‹ä¿¡æ¯ï¼Œä¾¿äºåˆ†æ\r\n        return result\r\n    }\r\n\r\n\r\n    depmap = new Map<string, number>()\r\n\r\n\r\n    private graph: Graph\r\n\r\n\r\n    // é€’å½’æ”¶é›†ä¾èµ–\r\n    collectDependencies(node: RuleNode, fromRule: string) {\r\n        switch (node.type) {\r\n            case 'consume':\r\n                this.graph.setEdge(fromRule, node.tokenName)\r\n                break\r\n            case 'subrule':\r\n                this.graph.setEdge(fromRule, node.ruleName)\r\n                break\r\n            case 'sequence':\r\n                node.nodes.forEach(n => this.collectDependencies(n, fromRule))\r\n                break\r\n            case 'or':\r\n                node.alternatives.forEach(alt => this.collectDependencies(alt, fromRule))\r\n                break\r\n            case 'option':\r\n            case 'many':\r\n            case 'atLeastOne':\r\n                this.collectDependencies(node.node, fromRule)\r\n                break\r\n        }\r\n    }\r\n\r\n    graphToMermaid(g: Graph): string {\r\n        const lines = ['graph TD']\r\n\r\n        for (const edge of g.edges()) {\r\n            lines.push(`    ${edge.v} --> ${edge.w}`)\r\n        }\r\n\r\n        return lines.join('\\n')\r\n    }\r\n\r\n    grachScc() {\r\n        this.graph = new Graph({directed: true})\r\n\r\n        for (const [ruleName, node] of this.ruleASTs) {\r\n            this.graph.setNode(ruleName)\r\n            this.collectDependencies(node, ruleName)\r\n        }\r\n\r\n\r\n        const dotString = write(this.graph)\r\n        console.log(dotString)\r\n\r\n        // Tarjan ç®—æ³•æ‰¾å¼ºè¿é€šåˆ†é‡\r\n        const sccs = alg.tarjan(this.graph)\r\n\r\n        console.log('=== å¼ºè¿é€šåˆ†é‡ï¼ˆå¾ªç¯ï¼‰ ===')\r\n        for (const scc of sccs) {\r\n            if (scc.length > 1) {\r\n                // å¤šä¸ªèŠ‚ç‚¹çš„ SCC = æœ‰å¾ªç¯\r\n                console.log('====================')\r\n                console.log(`å¾ªç¯: `)\r\n                console.log(`${scc.length}`)\r\n            }\r\n        }\r\n    }\r\n\r\n    computeRuleDepth() {\r\n        for (const node of this.ruleASTs.values()) {\r\n            this.recursiveDetectionSet.clear()\r\n            const result = this.deepDepth(node, 1)\r\n            console.log(node.ruleName)\r\n            console.log(result)\r\n            this.depmap.set(node.ruleName, result)\r\n        }\r\n    }\r\n\r\n    computeRulePossibility() {\r\n        for (const node of this.ruleASTs.values()) {\r\n            this.recursiveDetectionSet.clear()\r\n            const ruleName = node.ruleName\r\n            console.log('è¿›å…¥è§„åˆ™ï¼š' + ruleName)\r\n            const result = this.findNodeDepth(node)\r\n            if (this.depthMap.has(ruleName)) {\r\n                const num = this.depthMap.get(ruleName)\r\n                if (result !== num) {\r\n                    console.log('æ›´æ–°è®¾ç½®')\r\n                    console.log(ruleName)\r\n                    console.log('jiuzhi')\r\n                    console.log(num)\r\n                    console.log('å¿ƒæ™º')\r\n                    console.log(result)\r\n                    this.depthMap.set(ruleName, result)\r\n                    throw new Error('ç³»ç»Ÿé”™è¯¯')\r\n                }\r\n            } else {\r\n                this.depthMap.set(ruleName, result)\r\n                console.log('åˆæ¬¡è®¾ç½®')\r\n                console.log(ruleName)\r\n                console.log(result)\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * åˆå§‹åŒ–ç¼“å­˜ï¼ˆéå†æ‰€æœ‰è§„åˆ™ï¼Œè®¡ç®—ç›´æ¥å­èŠ‚ç‚¹ã€First é›†åˆå’Œåˆ†å±‚å±•å¼€ï¼‰\r\n     *\r\n     * åº”è¯¥åœ¨æ”¶é›† AST ä¹‹åç«‹å³è°ƒç”¨\r\n     *\r\n     * @returns { errors: éªŒè¯é”™è¯¯åˆ—è¡¨, stats: ç»Ÿè®¡ä¿¡æ¯ }\r\n     */\r\n    initCacheAndCheckLeftRecursion(): { errors: ValidationError[], stats: any } {\r\n        // å¯åŠ¨è¶…æ—¶æ£€æµ‹ï¼ˆ20ç§’ï¼‰\r\n        this.operationStartTime = Date.now()\r\n\r\n        const totalStartTime = Date.now()\r\n\r\n        // ç»Ÿè®¡å¯¹è±¡\r\n        const stats: any = {\r\n            dfsFirstKTime: 0,  // First(K) ç¼“å­˜ç”Ÿæˆç”¨æ—¶\r\n            bfsMaxLevelTime: 0,  // MaxLevel ç¼“å­˜ç”Ÿæˆç”¨æ—¶\r\n            orDetectionTime: 0,  // Or å†²çªæ£€æµ‹ç”¨æ—¶\r\n            leftRecursionCount: 0,  // å·¦é€’å½’é”™è¯¯æ•°é‡\r\n            orConflictCount: 0,  // Or åˆ†æ”¯å†²çªæ•°é‡\r\n            totalTime: 0,  // æ€»ç”¨æ—¶\r\n            dfsFirstKCacheSize: 0,  // dfsFirstKCache å¤§å°\r\n            bfsAllCacheSize: 0,  // bfsAllCache å¤§å°\r\n            firstK: 0,  // First(K) çš„ K å€¼\r\n            cacheUsage: {\r\n                dfsFirstK: {hit: 0, miss: 0, total: 0, hitRate: 0},\r\n                bfsLevelCache: {hit: 0, miss: 0, total: 0, hitRate: 0, size: 0},\r\n                getDirectChildren: {hit: 0, miss: 0, total: 0, hitRate: 0}\r\n            }\r\n        }\r\n\r\n        // æ¸…ç©ºé”™è¯¯ Map\r\n        this.detectedLeftRecursionErrors.clear()\r\n\r\n        // é˜¶æ®µ1.2ï¼šBFS MaxLevel ç¼“å­˜ç”Ÿæˆ\r\n        // å¯åŠ¨è¶…æ—¶æ£€æµ‹ï¼ˆåœ¨ BFS ç¼“å­˜ç”Ÿæˆé˜¶æ®µï¼‰\r\n        this.operationStartTime = Date.now()\r\n        const t1_2_start = Date.now()\r\n        console.log(`\\nğŸ“¦ ===== BFS MaxLevel ç¼“å­˜ç”Ÿæˆå¼€å§‹ =====`)\r\n        console.log(`ç›®æ ‡å±‚çº§: Level 1 åˆ° Level ${EXPANSION_LIMITS.LEVEL_K}`)\r\n\r\n\r\n        const ruleNames = Array.from(this.ruleASTs.keys())\r\n\r\n        //éå†æ£€æŸ¥å·¦é€’å½’é—®é¢˜\r\n        for (const ruleName of ruleNames) {\r\n            this.recursiveDetectionSet.clear()\r\n            this.expandPathsByDFSCache(ruleName, EXPANSION_LIMITS.FIRST_K, 0, EXPANSION_LIMITS.INFINITY, true)\r\n        }\r\n\r\n        const startLevel = EXPANSION_LIMITS.LEVEL_K\r\n\r\n        // BFS ç¼“å­˜é¢„å¡«å……\r\n        // é¢„å¡«å…… level 1 åˆ° level_k\r\n        for (let level = startLevel; level <= EXPANSION_LIMITS.LEVEL_K; level++) {\r\n            console.log(`\\nğŸ“Š æ­£åœ¨ç”Ÿæˆ Level ${level} çš„ç¼“å­˜...`)\r\n            let levelRuleIndex = 0\r\n            for (const ruleName of ruleNames) {\r\n                levelRuleIndex++\r\n                const key = `${ruleName}:${level}`\r\n\r\n                // å¦‚æœå·²ç»å­˜åœ¨ç¼“å­˜ï¼Œè·³è¿‡\r\n                if (this.bfsLevelCache.has(key)) {\r\n                    continue\r\n                }\r\n\r\n                // è®°å½•å¼€å§‹æ—¶é—´\r\n                const ruleStartTime = Date.now()\r\n                // console.log(`  [${levelRuleIndex}/${ruleNames.length}] å¼€å§‹ç”Ÿæˆ: ${ruleName}, Level ${level}, Key: ${key}`)\r\n\r\n                // ç”Ÿæˆç¼“å­˜\r\n                this.expandPathsByBFSCache(ruleName, level)\r\n\r\n                // è®°å½•ç»“æŸæ—¶é—´å’Œè€—æ—¶\r\n                const ruleEndTime = Date.now()\r\n                const ruleDuration = ruleEndTime - ruleStartTime\r\n                const cachedPaths = this.bfsLevelCache.get(key)\r\n                const pathCount = cachedPaths ? cachedPaths.length : 0\r\n\r\n                // å¦‚æœè€—æ—¶è¶…è¿‡ 10ms æˆ–è·¯å¾„æ•°é‡å¾ˆå¤šï¼Œè¾“å‡ºè¯¦ç»†ä¿¡æ¯\r\n                if (ruleDuration > 10 || pathCount > 100) {\r\n                    console.log(`  âœ… ç”Ÿæˆå®Œæˆ: ${ruleName}, Level ${level} (è€—æ—¶: ${ruleDuration}ms, è·¯å¾„æ•°: ${pathCount})`)\r\n                }\r\n            }\r\n            console.log(`ğŸ“Š Level ${level} ç¼“å­˜ç”Ÿæˆå®Œæˆ`)\r\n        }\r\n\r\n        // èšåˆæ‰€æœ‰å±‚çº§çš„æ•°æ®åˆ° bfsAllCache\r\n        console.log(`\\nğŸ“¦ æ­£åœ¨èšåˆæ‰€æœ‰å±‚çº§çš„æ•°æ®åˆ° bfsAllCache...`)\r\n        let aggregateIndex = 0\r\n        for (const ruleName of ruleNames) {\r\n            aggregateIndex++\r\n            const aggregateStartTime = Date.now()\r\n            let allLevelPaths: string[][] = []\r\n\r\n            // æ”¶é›†è¯¥è§„åˆ™çš„æ‰€æœ‰å±‚çº§æ•°æ®\r\n            for (let level = startLevel; level <= EXPANSION_LIMITS.LEVEL_K; level++) {\r\n                const key = `${ruleName}:${level}`\r\n                if (this.bfsLevelCache.has(key)) {\r\n                    const levelPaths = this.getCacheValue('bfsLevelCache', key)!\r\n                    allLevelPaths = allLevelPaths.concat(levelPaths)\r\n                }\r\n            }\r\n\r\n            // å»é‡å¹¶å­˜å…¥ bfsAllCache\r\n            const deduplicated = this.deduplicate(allLevelPaths)\r\n            this.bfsAllCache.set(ruleName, deduplicated)\r\n\r\n            // å¦‚æœèšåˆçš„æ•°æ®å¾ˆå¤šï¼Œè¾“å‡ºæ—¥å¿—\r\n            if (deduplicated.length > 1000) {\r\n                const aggregateDuration = Date.now() - aggregateStartTime\r\n                console.log(`  [${aggregateIndex}/${ruleNames.length}] èšåˆå®Œæˆ: ${ruleName} (è€—æ—¶: ${aggregateDuration}ms, è·¯å¾„æ•°: ${deduplicated.length})`)\r\n            }\r\n        }\r\n        /*ass.forEach((ass1, index) => {\r\n            console.log('fenzhi:' + index)\r\n            let temp = ass1.map(string => this.expandPathsByBFSCache(string, 1))\r\n            const fsaf = this.cartesianProduct(temp, EXPANSION_LIMITS.INFINITY)\r\n            console.log('posible:' + fsaf.length)\r\n            for (const fsafElement of fsaf) {\r\n                console.log(fsafElement.join('->'))\r\n            }\r\n        })*/\r\n\r\n        // ass = this.expandPathsByBFSCache('LeftHandSideExpression', 1)\r\n        // console.log(ass.length)\r\n\r\n        // console.log(this.bfsAllCache.size)\r\n        // for (const ruleName of ruleNames) {\r\n        //     console.log(ruleName)\r\n        //     console.log(this.bfsAllCache.get(ruleName))\r\n        // }\r\n\r\n\r\n        const t1_2_end = Date.now()\r\n        stats.bfsMaxLevelTime = t1_2_end - t1_2_start\r\n        console.log(`\\nâœ… BFS MaxLevel ç¼“å­˜ç”Ÿæˆå®Œæˆ (æ€»è€—æ—¶: ${stats.bfsMaxLevelTime}ms)`)\r\n        console.log(`========================================\\n`)\r\n\r\n        // é‡ç½®è¶…æ—¶æ£€æµ‹\r\n        this.operationStartTime = 0\r\n\r\n        // ä¸ºæ¯ä¸ªé”™è¯¯è¡¥å…… suggestion\r\n        for (const error of this.detectedLeftRecursionErrors.values()) {\r\n            const ruleAST = this.getRuleNodeByAst(error.ruleName)\r\n            error.suggestion = this.getLeftRecursionSuggestion(\r\n                error.ruleName,\r\n                ruleAST,\r\n                new Set([error.ruleName])\r\n            )\r\n        }\r\n        stats.leftRecursionCount = this.detectedLeftRecursionErrors.size\r\n\r\n        const leftRecursionErrors = Array.from(this.detectedLeftRecursionErrors.values())\r\n\r\n        // 2. Or åˆ†æ”¯å†²çªæ£€æµ‹\r\n        const t2 = Date.now()\r\n        // const orConflictErrors = []\r\n        const orConflictErrors = this.checkAllOrConflicts()\r\n        const t2End = Date.now()\r\n        const stage2Time = t2End - t2\r\n\r\n        // è®°å½• Or æ£€æµ‹ç»Ÿè®¡\r\n        stats.orDetectionTime = stage2Time\r\n        stats.orConflictCount = orConflictErrors.length\r\n\r\n        // 3. åˆå¹¶æ‰€æœ‰é”™è¯¯ï¼ˆå·¦é€’å½’ä¼˜å…ˆï¼‰\r\n        const allErrors: ValidationError[] = []\r\n        allErrors.push(...leftRecursionErrors)\r\n        allErrors.push(...orConflictErrors)\r\n\r\n        // 5. å‡†å¤‡ç»Ÿè®¡ä¿¡æ¯ï¼ˆä¸åœ¨è¿™é‡Œè¾“å‡ºï¼Œæ”¾åˆ° error å¯¹è±¡ä¸­ï¼‰\r\n        stats.totalTime = Date.now() - totalStartTime\r\n        stats.dfsFirstKCacheSize = this.dfsFirstKCache.size\r\n        stats.bfsAllCacheSize = this.bfsAllCache.size\r\n        stats.firstK = EXPANSION_LIMITS.FIRST_K\r\n\r\n        // æ”¶é›†ç¼“å­˜ä½¿ç”¨ç‡ç»Ÿè®¡ï¼ˆä½¿ç”¨æ–°çš„ç‹¬ç«‹ç»Ÿè®¡å­—æ®µï¼‰\r\n        const dfsFirstKCacheStats = this.perfAnalyzer.cacheStats.dfsFirstKCache\r\n        const bfsAllCacheStats = this.perfAnalyzer.cacheStats.bfsAllCache\r\n        const bfsLevelCacheStats = this.perfAnalyzer.cacheStats.bfsLevelCache\r\n        const getDirectChildrenStats = this.perfAnalyzer.cacheStats.getDirectChildren\r\n\r\n        stats.cacheUsage = {\r\n            dfsFirstK: {\r\n                hit: dfsFirstKCacheStats.hit,\r\n                miss: dfsFirstKCacheStats.miss,\r\n                total: dfsFirstKCacheStats.total,\r\n                hitRate: dfsFirstKCacheStats.total > 0 ? (dfsFirstKCacheStats.hit / dfsFirstKCacheStats.total * 100) : 0,\r\n                // total å°±æ˜¯æŸ¥è¯¢æ¬¡æ•°ï¼ˆæ¯æ¬¡ getCacheValue éƒ½ä¼šå¢åŠ  totalï¼‰\r\n                getCount: dfsFirstKCacheStats.total\r\n            },\r\n            bfsAllCache: {\r\n                hit: bfsAllCacheStats.hit,\r\n                miss: bfsAllCacheStats.miss,\r\n                total: bfsAllCacheStats.total,\r\n                hitRate: bfsAllCacheStats.total > 0 ? (bfsAllCacheStats.hit / bfsAllCacheStats.total * 100) : 0,\r\n                getCount: bfsAllCacheStats.total,\r\n                size: this.bfsAllCache.size\r\n            },\r\n            bfsLevelCache: {\r\n                hit: bfsLevelCacheStats.hit,\r\n                miss: bfsLevelCacheStats.miss,\r\n                total: bfsLevelCacheStats.total,\r\n                hitRate: bfsLevelCacheStats.total > 0 ? (bfsLevelCacheStats.hit / bfsLevelCacheStats.total * 100) : 0,\r\n                size: this.bfsLevelCache.size,\r\n                getCount: bfsLevelCacheStats.total\r\n            },\r\n            getDirectChildren: {\r\n                hit: getDirectChildrenStats.hit,\r\n                miss: getDirectChildrenStats.miss,\r\n                total: getDirectChildrenStats.total,\r\n                hitRate: getDirectChildrenStats.total > 0 ? (getDirectChildrenStats.hit / getDirectChildrenStats.total * 100) : 0\r\n            }\r\n        }\r\n\r\n        // è¾“å‡ºæ€§èƒ½åˆ†ææŠ¥å‘Š\r\n        this.perfAnalyzer.report()\r\n\r\n        // è¿”å›é”™è¯¯åˆ—è¡¨å’Œç»Ÿè®¡ä¿¡æ¯\r\n        return {\r\n            errors: allErrors,\r\n            stats: stats\r\n        }\r\n    }\r\n\r\n\r\n    private cartesianProductInner1(arrays: string[][][], firstK: number): string[][] {\r\n        const callId = this.perfAnalyzer.startMethod('cartesianProduct')\r\n\r\n        // ç©ºæ•°ç»„ï¼Œè¿”å›åŒ…å«ä¸€ä¸ªç©ºåºåˆ—çš„æ•°ç»„\r\n        if (arrays.length === 0) {\r\n            return [[]]\r\n        }\r\n\r\n        // åªæœ‰ä¸€ä¸ªæ•°ç»„ï¼Œç›´æ¥è¿”å›ï¼ˆå¯èƒ½åŒ…å«ç©ºåˆ†æ”¯ï¼‰\r\n        if (arrays.length === 1) {\r\n            const inputSize = arrays[0].length\r\n            this.perfAnalyzer.endMethod(callId, inputSize, inputSize)\r\n            return arrays[0]\r\n        }\r\n\r\n        // æ€§èƒ½ç›‘æ§ç»Ÿè®¡\r\n        const perfStats = {\r\n            totalBranches: 0,           // æ€»åˆ†æ”¯æ•°\r\n            skippedByLength: 0,         // å› é•¿åº¦å·²æ»¡è·³è¿‡çš„\r\n            skippedByDuplicate: 0,      // å› é‡å¤è·³è¿‡çš„ï¼ˆseqçº§åˆ«ï¼‰\r\n            actualCombined: 0,          // å®é™…æ‹¼æ¥çš„\r\n            maxResultSize: 0,           // æœ€å¤§ç»“æœé›†å¤§å°\r\n            movedToFinal: 0             // ç§»å…¥æœ€ç»ˆç»“æœé›†çš„æ•°é‡\r\n        }\r\n\r\n        //ç¬¬ä¸€ä¸ªè§„åˆ™çš„æ¯ç§å¯èƒ½æ€§\r\n        const arrayFirst = arrays[0]\r\n\r\n        //ç¬¬ä¸€å±‚é¡ºåºï¼Œç¬¬äºŒå±‚å¯èƒ½æ€§ï¼Œç¬¬ä¸‰å±‚æ¯ç§å¯èƒ½æ€§çš„é¡ºåº\r\n        // åˆå§‹ç»“æœä¸ºç¬¬ä¸€ä¸ªæ•°ç»„\r\n        let result = arrayFirst.filter(item => item.length < firstK)\r\n        let finalResult = arrayFirst.filter(item => item.length >= firstK).map(item => item.join(EXPANSION_LIMITS.RuleJoinSymbol))\r\n\r\n        // æœ€ç»ˆç»“æœé›†ï¼ˆé•¿åº¦å·²è¾¾ FIRST_K çš„åºåˆ—ï¼‰\r\n        const finalResultSet = new Set<string>(finalResult)\r\n\r\n        // é€ä¸ªå¤„ç†åç»­æ•°ç»„\r\n        for (let i = 1; i < arrays.length; i++) {\r\n            this.checkTimeout(`cartesianProduct-æ•°ç»„${i}/${arrays.length}`)\r\n\r\n            //å·²ç»æ˜¯å»é‡çš„äº†ï¼Œæ²¡å¿…è¦å»é‡äº†\r\n            const arrilen = arrays[i].length\r\n            // æ•°ç»„å±‚é¢å»é‡ï¼šç»Ÿä¸€å¤„ç†æ‰€æœ‰æ•°ç»„\r\n            const currentArray = this.deduplicate(arrays[i])\r\n\r\n\r\n            if (arrilen > currentArray.length) {\r\n                throw new Error('ç³»ç»Ÿé”™è¯¯')\r\n            }\r\n\r\n            const temp: string[][] = []\r\n\r\n            // éå†å½“å‰ç»“æœçš„æ¯ä¸ªåºåˆ—\r\n            let seqIndex = 0\r\n            const totalSeqs = result.length\r\n            const arrayIndex = i\r\n            const shouldLogProgress = totalSeqs > 1000 || currentArray.length > 1000\r\n            const cartesianStartTime = shouldLogProgress ? Date.now() : 0\r\n\r\n            if (shouldLogProgress) {\r\n                const estimatedTotal = totalSeqs * currentArray.length\r\n            }\r\n\r\n            for (const seq of result) {\r\n                const pla = currentArray.length * seq.length\r\n                if (pla > 30000) {\r\n\r\n                }\r\n\r\n\r\n                seqIndex++\r\n\r\n                // æ¯å¤„ç†1000ä¸ªseqè¾“å‡ºä¸€æ¬¡è¿›åº¦\r\n                if (seqIndex % 1000 === 0 || seqIndex === totalSeqs) {\r\n                    this.checkTimeout(`cartesianProduct-seq${seqIndex}/${totalSeqs}`)\r\n\r\n                    if (shouldLogProgress) {\r\n                        const elapsed = Date.now() - cartesianStartTime\r\n                        const progress = ((seqIndex / totalSeqs) * 100).toFixed(1)\r\n                    }\r\n                }\r\n\r\n                // è®¡ç®—å½“å‰ seq çš„å¯æ‹¼æ¥é•¿åº¦\r\n                const availableLength = firstK - seq.length\r\n\r\n                // æƒ…å†µ2ï¼šseq è¶…è¿‡ firstKï¼ˆä¸åº”è¯¥å‘ç”Ÿï¼Œå·²æœ‰é˜²å¾¡æ£€æŸ¥ï¼‰\r\n                if (availableLength < 0) {\r\n                    throw new Error('ç³»ç»Ÿé”™è¯¯ï¼šåºåˆ—é•¿åº¦è¶…è¿‡é™åˆ¶')\r\n                } else if (availableLength === 0) {\r\n                    // æƒ…å†µ1ï¼šseq å·²è¾¾åˆ° firstKï¼Œç›´æ¥æ”¾å…¥æœ€ç»ˆç»“æœé›†\r\n                    const seqKey = seq.join(EXPANSION_LIMITS.RuleJoinSymbol)\r\n                    finalResultSet.add(seqKey)\r\n                    perfStats.movedToFinal++\r\n                    perfStats.skippedByLength += currentArray.length\r\n                    continue  // ä¸å†å‚ä¸åç»­è®¡ç®—\r\n                }\r\n\r\n                // seq çº§åˆ«çš„å»é‡é›†åˆ\r\n                const seqDeduplicateSet = new Set<string>()\r\n\r\n\r\n                // æƒ…å†µ3ï¼šseq é•¿åº¦ < FIRST_Kï¼Œç»§ç»­æ‹¼æ¥\r\n                // ğŸ”§ æ€§èƒ½ä¼˜åŒ–ï¼šé¢„è®¡ç®— seq çš„é•¿åº¦å’Œ join ç»“æœï¼ˆå¦‚æœè¾¾åˆ° FIRST_K æ—¶éœ€è¦ï¼‰\r\n                const seqLength = seq.length\r\n                const seqKey = seqLength > 0 ? seq.join(EXPANSION_LIMITS.RuleJoinSymbol) : ''\r\n\r\n                for (const branch of currentArray) {\r\n                    perfStats.totalBranches++\r\n\r\n                    // ğŸ”§ æ€§èƒ½ä¼˜åŒ–ï¼šå‡å°‘ä¸å¿…è¦çš„ slice\r\n                    // å¦‚æœ branch.length <= availableLengthï¼Œç›´æ¥ä½¿ç”¨ branchï¼Œé¿å… slice å¼€é”€\r\n                    const branchLength = branch.length\r\n                    const truncatedBranch = branchLength <= availableLength\r\n                        ? branch\r\n                        : branch.slice(0, availableLength)\r\n                    const truncatedLength = truncatedBranch.length\r\n\r\n                    // ğŸ”§ æ€§èƒ½ä¼˜åŒ–ï¼šåªåœ¨éœ€è¦å»é‡æ—¶æ‰ join\r\n                    // å¦‚æœ truncatedBranch === branchï¼Œå¯ä»¥å¤ç”¨ï¼ˆä½†ä¸ºäº†å®‰å…¨ï¼Œè¿˜æ˜¯æ¯æ¬¡éƒ½ joinï¼‰\r\n                    const branchKey = truncatedBranch.join(EXPANSION_LIMITS.RuleJoinSymbol)\r\n\r\n                    // seq çº§åˆ«å»é‡\r\n                    if (seqDeduplicateSet.has(branchKey)) {\r\n                        perfStats.skippedByDuplicate++\r\n                        continue\r\n                    }\r\n\r\n                    seqDeduplicateSet.add(branchKey)\r\n\r\n                    // ğŸ”§ æ€§èƒ½ä¼˜åŒ–ï¼šå…ˆè®¡ç®—é•¿åº¦ï¼Œé¿å…åˆ›å»ºæ•°ç»„åå†æ£€æŸ¥\r\n                    const combinedLength = seqLength + truncatedLength\r\n\r\n                    // æ£€æŸ¥æ‹¼æ¥åçš„é•¿åº¦\r\n                    if (combinedLength > firstK) {\r\n                        throw new Error('ç³»ç»Ÿé”™è¯¯ï¼šç¬›å¡å°”ç§¯æ‹¼æ¥åé•¿åº¦è¶…è¿‡é™åˆ¶')\r\n                    }\r\n\r\n                    // åˆ¤æ–­æ‹¼æ¥åæ˜¯å¦è¾¾åˆ° firstK\r\n                    if (combinedLength === firstK) {\r\n                        // è¾¾åˆ°æœ€å¤§é•¿åº¦ï¼Œæ”¾å…¥æœ€ç»ˆç»“æœé›†\r\n                        // ğŸ”§ æ€§èƒ½ä¼˜åŒ–ï¼šå¤ç”¨å·²è®¡ç®—çš„ seqKey å’Œ branchKeyï¼Œé¿å…é‡å¤ join\r\n                        const combinedKey = seqKey\r\n                            ? (seqKey + EXPANSION_LIMITS.RuleJoinSymbol + branchKey)\r\n                            : branchKey\r\n                        finalResultSet.add(combinedKey)\r\n                        perfStats.movedToFinal++\r\n                    } else {\r\n                        // æœªè¾¾åˆ°æœ€å¤§é•¿åº¦ï¼Œæ”¾å…¥ temp ç»§ç»­å‚ä¸åç»­è®¡ç®—\r\n                        // ğŸ”§ æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨é¢„åˆ†é…æ•°ç»„ + å¾ªç¯èµ‹å€¼ï¼Œæ¯” concat æ›´å¿«\r\n                        const combined: string[] = new Array(combinedLength)\r\n                        for (let j = 0; j < seqLength; j++) {\r\n                            combined[j] = seq[j]\r\n                        }\r\n                        for (let j = 0; j < truncatedLength; j++) {\r\n                            combined[seqLength + j] = truncatedBranch[j]\r\n                        }\r\n                        temp.push(combined)\r\n                    }\r\n\r\n                    perfStats.actualCombined++\r\n\r\n                }\r\n            }\r\n\r\n            // æ›´æ–°ç»“æœä¸ºæœ¬è½®ç¬›å¡å°”ç§¯ï¼ˆåªåŒ…å«æœªè¾¾åˆ° FIRST_K çš„ï¼‰\r\n            const dedupStartTime = Date.now()\r\n            result = this.deduplicate(temp)\r\n            const dedupDuration = Date.now() - dedupStartTime\r\n\r\n            // æ›´æ–°ç»Ÿè®¡\r\n            perfStats.maxResultSize = Math.max(perfStats.maxResultSize, result.length + finalResultSet.size)\r\n\r\n            // ç§»é™¤è¯¦ç»†æ—¥å¿—\r\n\r\n            if (result.length + finalResultSet.size > 100000) {\r\n                console.warn(`âš ï¸ ç¬›å¡å°”ç§¯ä¸­é—´ç»“æœè¾ƒå¤§: temp=${result.length}, final=${finalResultSet.size} (æ•°ç»„ ${i}/${arrays.length - 1})`)\r\n            }\r\n\r\n            // ä¼˜åŒ–ï¼šå¦‚æœ result ä¸ºç©ºä¸”è¿˜æœ‰åç»­æ•°ç»„ï¼Œå¯ä»¥æå‰ç»“æŸ\r\n            if (result.length === 0 && finalResultSet.size > 0) {\r\n                // console.log(`âœ… æ‰€æœ‰åºåˆ—å·²è¾¾ FIRST_Kï¼Œè·³è¿‡å‰©ä½™ ${arrays.length - i - 1} ä¸ªæ•°ç»„çš„è®¡ç®—`)\r\n                break\r\n            }\r\n        }\r\n\r\n        // åˆå¹¶æœ€ç»ˆç»“æœï¼šfinalResultSet + result\r\n        let finalArray: string[][] = []\r\n\r\n        // 1. å°† Set ä¸­çš„å­—ç¬¦ä¸²è½¬å›äºŒç»´æ•°ç»„\r\n        for (const seqStr of finalResultSet) {\r\n            if (seqStr === '') {\r\n                finalArray.push([])  // ç©ºåºåˆ—\r\n            } else {\r\n                finalArray.push(seqStr.split(EXPANSION_LIMITS.RuleJoinSymbol))\r\n            }\r\n        }\r\n\r\n        // 2. æ·»åŠ æœªè¾¾åˆ° FIRST_K çš„åºåˆ—\r\n        finalArray = finalArray.concat(result)\r\n\r\n\r\n        // 3. ç»Ÿä¸€å»é‡ï¼šä½¿ç”¨ this.deduplicate å¯¹æœ€ç»ˆç»“æœå»é‡\r\n        const finalDedupStartTime = Date.now()\r\n        const deduplicatedFinalArray = this.deduplicate(finalArray)\r\n        const finalDedupDuration = Date.now() - finalDedupStartTime\r\n\r\n        // æœ€ç»ˆéªŒè¯\r\n        for (const resultElement of deduplicatedFinalArray) {\r\n            if (resultElement.length > firstK) {\r\n                throw new Error('ç³»ç»Ÿé”™è¯¯ï¼šæœ€ç»ˆç»“æœé•¿åº¦è¶…è¿‡é™åˆ¶')\r\n            }\r\n        }\r\n        // è®°å½•æ€§èƒ½æ•°æ®\r\n        const inputSize = arrays.reduce((sum, arr) => sum + arr.length, 0)\r\n        this.perfAnalyzer.endMethod(callId, inputSize, deduplicatedFinalArray.length)\r\n\r\n        return deduplicatedFinalArray\r\n    }\r\n\r\n    /**\r\n     * è®¡ç®—ç¬›å¡å°”ç§¯ï¼ˆä¼˜åŒ–ç‰ˆï¼šå…ˆæˆªå–å†æ‹¼æ¥ + seqçº§åˆ«å»é‡ + æå‰ç§»å…¥æœ€ç»ˆç»“æœé›†ï¼‰\r\n     * [[a1, a2], [b1, b2]] â†’ [[a1, b1], [a1, b2], [a2, b1], [a2, b2]]\r\n     *\r\n     * âš ï¸ é‡è¦ï¼šç©ºåˆ†æ”¯å¤„ç†\r\n     * - ç©ºåˆ†æ”¯ [] å‚ä¸ç¬›å¡å°”ç§¯æ—¶ï¼Œä¼šè¢«æ­£å¸¸æ‹¼æ¥\r\n     * - [...seq, ...[]] = [...seq]ï¼Œç›¸å½“äºåªä¿ç•™ seq\r\n     * - ä¾‹å¦‚ï¼š[[a]] Ã— [[], [b]] â†’ [[a], [a,b]]\r\n     * - è¿™æ­£æ˜¯ option/many éœ€è¦çš„è¡Œä¸ºï¼šå¯ä»¥è·³è¿‡æˆ–æ‰§è¡Œ\r\n     *\r\n     * ğŸ”§ ä¼˜åŒ–ç­–ç•¥ï¼š\r\n     * 1. å…ˆè®¡ç®—å¯æ‹¼æ¥é•¿åº¦ï¼Œé¿å…æ‹¼æ¥è¶…é•¿æ•°æ®\r\n     * 2. seq çº§åˆ«å»é‡ï¼Œæå‰è·³è¿‡é‡å¤åˆ†æ”¯\r\n     * 3. ä¿®å¤å¾ªç¯é€»è¾‘ï¼Œé€ä¸ªæ•°ç»„å¤„ç†\r\n     * 4. é•¿åº¦è¾¾åˆ° firstK çš„åºåˆ—ç«‹å³ç§»å…¥æœ€ç»ˆç»“æœé›†ï¼Œä¸å†å‚ä¸åç»­è®¡ç®—\r\n     * 5. æ‰€æœ‰åºåˆ—éƒ½è¾¾åˆ° firstK æ—¶æå‰ç»“æŸï¼Œè·³è¿‡å‰©ä½™æ•°ç»„\r\n     */\r\n    private cartesianProduct(arrays: string[][][], firstK: number): string[][] {\r\n        // å°†æ¯ä¸ªç»„åˆä¸­çš„å­—ç¬¦ä¸² split å›æ•°ç»„ï¼Œç„¶ååˆå¹¶æˆä¸€ä¸ªå®Œæ•´è·¯å¾„\r\n        // æœ€åæˆªå–åˆ° firstK é•¿åº¦\r\n        let deduplicatedFinalArray = this.cartesianProductInner1(arrays, firstK)\r\n        // let deduplicatedFinalArray = this.cartesianProductInner2(arrays,firstK)\r\n\r\n        return deduplicatedFinalArray\r\n    }\r\n\r\n    private cartesianProductInner2(arrays: string[][][], firstK: number): string[][] {\r\n        const callId = this.perfAnalyzer.startMethod('cartesianProduct')\r\n\r\n\r\n        const tempr = fastCartesian(arrays)\r\n\r\n        // å°†æ¯ä¸ªç»„åˆä¸­çš„å­—ç¬¦ä¸² split å›æ•°ç»„ï¼Œç„¶ååˆå¹¶æˆä¸€ä¸ªå®Œæ•´è·¯å¾„\r\n        // æœ€åæˆªå–åˆ° firstK é•¿åº¦\r\n        let deduplicatedFinalArray = tempr.map(item => {\r\n            // item æ˜¯ string[]ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ª join åçš„è·¯å¾„å­—ç¬¦ä¸²\r\n            // éœ€è¦ split æ¯ä¸ªå­—ç¬¦ä¸²ï¼Œç„¶å flat æˆä¸€ä¸ªå®Œæ•´è·¯å¾„\r\n            const combinedPath = item.flat()\r\n            // æˆªå–åˆ° firstK é•¿åº¦\r\n            return combinedPath\r\n        })\r\n        const inputSize = arrays.reduce((sum, arr) => sum + arr.length, 0)\r\n\r\n        this.perfAnalyzer.endMethod(callId, inputSize, deduplicatedFinalArray.length)\r\n\r\n        return deduplicatedFinalArray\r\n    }\r\n\r\n    /**\r\n     * æ·±åº¦ä¼˜å…ˆå±•å¼€ï¼ˆDFS - Depth-First Searchï¼‰\r\n     *\r\n     * ğŸš€ ç®—æ³•ï¼šé€’å½’æ·±å…¥ï¼Œè‡ªç„¶å±•å¼€åˆ°token\r\n     *\r\n     * é€‚ç”¨åœºæ™¯ï¼š\r\n     * - maxLevel = INFINITYï¼ˆæ— é™å±‚çº§ï¼‰\r\n     * - éœ€è¦å®Œå…¨å±•å¼€åˆ°token\r\n     * - é€‚åˆ First(K) + å®Œå…¨å±•å¼€\r\n     *\r\n     * ä¼˜åŠ¿ï¼š\r\n     * - é€’å½’å¤„ç†ASTï¼Œä»£ç ç®€æ´\r\n     * - è‡ªç„¶æ·±å…¥åˆ°å¶å­èŠ‚ç‚¹\r\n     * - é…åˆ firstK æˆªå–ï¼Œå¯æå‰ç»ˆæ­¢éƒ¨åˆ†åˆ†æ”¯\r\n     *\r\n     * @param node - AST èŠ‚ç‚¹ï¼ˆå¯é€‰ï¼‰\r\n     * @param ruleName - è§„åˆ™åï¼ˆå¯é€‰ï¼‰\r\n     * @param firstK - å–å‰ K ä¸ªç¬¦å·\r\n     * @param curLevel - å½“å‰å±‚çº§ï¼ˆé»˜è®¤ 0ï¼‰\r\n     * @param maxLevel - æœ€å¤§å±•å¼€å±‚çº§ï¼ˆé€šå¸¸ä¸º Infinityï¼‰\r\n     * @param isFirstPosition - æ˜¯å¦åœ¨ç¬¬ä¸€ä¸ªä½ç½®ï¼ˆç”¨äºå·¦é€’å½’æ£€æµ‹ï¼‰\r\n     * @returns å±•å¼€åçš„è·¯å¾„æ•°ç»„ string[][]\r\n     *\r\n     * è°ƒç”¨æ–¹å¼ï¼š\r\n     * - expandPathsByDFS(node, null, firstK, curLevel, maxLevel) - ä¼ å…¥èŠ‚ç‚¹\r\n     * - expandPathsByDFS(null, ruleName, firstK, curLevel, maxLevel) - ä¼ å…¥è§„åˆ™å\r\n     *\r\n     * æ ¸å¿ƒé€»è¾‘ï¼šé€’å½’å¤„ç† AST èŠ‚ç‚¹\r\n     * - consume: è¿”å› [[tokenName]]\r\n     * - subrule: é€’å½’å±•å¼€\r\n     * - sequence: ç¬›å¡å°”ç§¯ç»„åˆå­èŠ‚ç‚¹\r\n     * - or: åˆå¹¶æ‰€æœ‰åˆ†æ”¯\r\n     * - option/many: æ·»åŠ ç©ºåˆ†æ”¯\r\n     */\r\n    private expandNode(\r\n        node: RuleNode,\r\n        firstK: number,\r\n        curLevel: number,\r\n        maxLevel: number,\r\n        isFirstPosition: boolean = false\r\n    ): string[][] {\r\n        const callId = this.perfAnalyzer.startMethod('expandNode')\r\n\r\n        // DFS æ€»æ˜¯æ— é™å±•å¼€\r\n        // æ ¹æ®èŠ‚ç‚¹ç±»å‹åˆ†å‘å¤„ç†\r\n        let result: string[][]\r\n        switch (node.type) {\r\n            case 'consume':\r\n                // Token èŠ‚ç‚¹ï¼šç›´æ¥è¿”å› token å\r\n                result = [[node.tokenName]]\r\n                break\r\n\r\n            case 'subrule':\r\n                // å­è§„åˆ™å¼•ç”¨ï¼šè½¬å‘ç»™ subRuleHandler å¤„ç†\r\n                result = this.expandPathsByDFSCache(node.ruleName, firstK, curLevel, maxLevel, isFirstPosition)\r\n                break\r\n\r\n            case 'or':\r\n                // Or èŠ‚ç‚¹ï¼šéå†æ‰€æœ‰åˆ†æ”¯ï¼Œåˆå¹¶ç»“æœ\r\n                // ğŸ”´ å…³é”®ï¼šOr åˆ†æ”¯ä¸­çš„ç¬¬ä¸€ä¸ªè§„åˆ™ä¹Ÿéœ€è¦ä¼ é€’ isFirstPosition\r\n                result = this.expandOr(node.alternatives, firstK, curLevel, maxLevel, isFirstPosition)\r\n                break\r\n\r\n            case 'sequence':\r\n                // Sequence èŠ‚ç‚¹ï¼šç¬›å¡å°”ç§¯ç»„åˆå­èŠ‚ç‚¹\r\n                result = this.expandSequenceNode(node, firstK, curLevel, maxLevel, isFirstPosition)\r\n                break\r\n\r\n            case 'option':\r\n            case 'many':\r\n                // Option/Many èŠ‚ç‚¹ï¼š0æ¬¡æˆ–å¤šæ¬¡ï¼Œæ·»åŠ ç©ºåˆ†æ”¯\r\n                // ğŸ”´ å…³é”®ï¼šOption å†…çš„ç¬¬ä¸€ä¸ªè§„åˆ™ä¹Ÿéœ€è¦ä¼ é€’ isFirstPosition\r\n                result = this.expandOption(node.node, firstK, curLevel, maxLevel, isFirstPosition)\r\n                break\r\n\r\n            case 'atLeastOne':\r\n                // AtLeastOne èŠ‚ç‚¹ï¼š1æ¬¡æˆ–å¤šæ¬¡ï¼Œæ·»åŠ  double åˆ†æ”¯\r\n                // ğŸ”´ å…³é”®ï¼šAtLeastOne å†…çš„ç¬¬ä¸€ä¸ªè§„åˆ™ä¹Ÿéœ€è¦ä¼ é€’ isFirstPosition\r\n                result = this.expandAtLeastOne(node.node, firstK, curLevel, maxLevel, isFirstPosition)\r\n                break\r\n\r\n            default:\r\n                // æœªçŸ¥èŠ‚ç‚¹ç±»å‹ï¼ŒæŠ›å‡ºé”™è¯¯\r\n                throw new Error(`æœªçŸ¥èŠ‚ç‚¹ç±»å‹: ${(node as any).type}`)\r\n        }\r\n\r\n        // è®°å½•æ€§èƒ½ç»Ÿè®¡\r\n        this.perfAnalyzer.endMethod(callId, undefined, result.length)\r\n\r\n        return result\r\n    }\r\n\r\n    /**\r\n     * å±•å¼€ Sequence èŠ‚ç‚¹\r\n     *\r\n     * æ ¸å¿ƒé€»è¾‘ï¼š\r\n     * - First(1)ï¼šåªå±•å¼€ç¬¬1ä¸ªå­èŠ‚ç‚¹\r\n     * - First(K)ï¼šç¬›å¡å°”ç§¯å±•å¼€æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œç„¶åæˆªå–\r\n     *\r\n     * âš ï¸ é‡è¦ï¼šç©ºåˆ†æ”¯åœ¨ sequence ä¸­çš„å¤„ç†\r\n     * - å¦‚æœå­èŠ‚ç‚¹åŒ…å«ç©ºåˆ†æ”¯ []ï¼ˆæ¥è‡ª option/manyï¼‰\r\n     * - ç¬›å¡å°”ç§¯ä¼šæ­£å¸¸å¤„ç†ï¼š[[a]] Ã— [[], [b]] â†’ [[a], [a,b]]\r\n     * - ç©ºåˆ†æ”¯ä¸ä¼šè¢«è¿‡æ»¤ï¼Œä¼šæ­£å¸¸å‚ä¸ç¬›å¡å°”ç§¯\r\n     *\r\n     * @param node\r\n     * @param firstK\r\n     * @param curLevel\r\n     * @param maxLevel\r\n     * @param isFirstPosition æ˜¯å¦åœ¨ç¬¬ä¸€ä¸ªä½ç½®ï¼ˆç”¨äºå·¦é€’å½’æ£€æµ‹ï¼‰\r\n     */\r\n        // è¶…æ—¶æ£€æµ‹ç›¸å…³\r\n    private operationStartTime: number = 0\r\n    private currentProcessingRule: string = ''\r\n    private timeoutSeconds: number = 1000\r\n\r\n    private checkTimeout(location: string): void {\r\n        if (!this.operationStartTime) return\r\n\r\n        const elapsed = (Date.now() - this.operationStartTime) / 1000\r\n        const remainingTime = this.timeoutSeconds - elapsed\r\n\r\n        if (elapsed > this.timeoutSeconds) {\r\n            const errorMsg = `\r\nâŒ ========== æ“ä½œè¶…æ—¶ ==========\r\nè¶…æ—¶ä½ç½®: ${location}\r\nå½“å‰è§„åˆ™: ${this.currentProcessingRule}\r\nå·²è€—æ—¶: ${elapsed.toFixed(2)}ç§’\r\nè¶…æ—¶é˜ˆå€¼: ${this.timeoutSeconds}ç§’\r\n\r\nå»ºè®®ï¼š\r\n1. æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç¬›å¡å°”ç§¯çˆ†ç‚¸\r\n2. æ£€æŸ¥æ˜¯å¦æœ‰å¾ªç¯é€’å½’æœªè¢«æ£€æµ‹\r\n3. æŸ¥çœ‹æ—¥å¿—æœ€åå¤„ç†çš„è§„åˆ™å’Œå­èŠ‚ç‚¹\r\n================================`\r\n            console.error(errorMsg)\r\n            throw new Error(`æ“ä½œè¶…æ—¶: ${elapsed.toFixed(2)}ç§’ (è¶…æ—¶ä½ç½®: ${location})`)\r\n        }\r\n    }\r\n\r\n    private expandSequenceNode(\r\n        node: SequenceNode,\r\n        firstK: number,\r\n        curLevel: number,\r\n        maxLevel: number,\r\n        isFirstPosition: boolean = true\r\n    ) {\r\n        const callId = this.perfAnalyzer.startMethod('expandSequenceNode')\r\n        this.checkTimeout('expandSequenceNode-å¼€å§‹')\r\n\r\n        // æ£€æŸ¥æ˜¯å¦ä¸ºç©ºåºåˆ—\r\n        if (node.nodes.length === 0) {\r\n            // ç©ºåºåˆ—ï¼Œè¿”å›åŒ…å«ä¸€ä¸ªç©ºåˆ†æ”¯\r\n            return [[]]\r\n        }\r\n\r\n        // First(K)ï¼šéœ€è¦ç¬›å¡å°”ç§¯\r\n        // âš ï¸âš ï¸âš ï¸ åŒé‡ä¼˜åŒ–ç­–ç•¥ï¼š\r\n        //\r\n        // ä¼˜åŒ–1ï¼šç¡¬æ€§ä¸Šé™ - slice(0, firstK)\r\n        // - æœ€å¤šåªå±•å¼€å‰ firstK ä¸ªå­èŠ‚ç‚¹\r\n        // - ä¾‹å¦‚ï¼šfirstK=2ï¼Œæœ€å¤šå±•å¼€å‰2ä¸ªï¼Œåç»­èŠ‚ç‚¹å®Œå…¨ä¸çœ‹\r\n        //\r\n        // ä¼˜åŒ–2ï¼šç´¯åŠ æå‰åœæ­¢ - åœ¨å‰ firstK ä¸ªèŠ‚ç‚¹å†…æå‰åœæ­¢\r\n        // - åŸç†ï¼šç¬›å¡å°”ç§¯åçš„æœ€çŸ­è·¯å¾„ = å„å­èŠ‚ç‚¹æœ€çŸ­åˆ†æ”¯çš„æ‹¼æ¥\r\n        // - å¦‚æœç´¯åŠ çš„æœ€çŸ­é•¿åº¦ >= firstKï¼Œåç»­èŠ‚ç‚¹ä¸å½±å“æˆªå–åçš„ç»“æœ\r\n        // - å¯èƒ½åªå±•å¼€1ä¸ªæˆ–å‡ ä¸ªèŠ‚ç‚¹å°±å¤Ÿäº†\r\n        //\r\n        // ç¤ºä¾‹1ï¼šsequence([a,b,c], [d], [e], [f])  firstK=2\r\n        //   ä¼˜åŒ–1ï¼šslice(0,2) â†’ æœ€å¤šå±•å¼€ [a,b,c], [d]\r\n        //   ä¼˜åŒ–2ï¼š\r\n        //     1. [a,b,c] â†’ [[a,b,c]]ï¼Œæœ€çŸ­=3\r\n        //        ç´¯åŠ ï¼š3 >= 2 âœ… åœæ­¢ï¼åªå±•å¼€1ä¸ªèŠ‚ç‚¹\r\n        //   ç¬›å¡å°”ç§¯ï¼š[[a,b,c]]\r\n        //   æˆªå–åˆ°2ï¼š[[a,b]]\r\n        //\r\n        // ç¤ºä¾‹2ï¼šsequence([a], or([b]/[c,d]), [e])  firstK=3\r\n        //   ä¼˜åŒ–1ï¼šslice(0,3) â†’ æœ€å¤šå±•å¼€å‰3ä¸ª\r\n        //   ä¼˜åŒ–2ï¼š\r\n        //     1. [a] â†’ [[a]]ï¼Œæœ€çŸ­=1ï¼Œç´¯åŠ =1 < 3ï¼Œç»§ç»­\r\n        //     2. or([b]/[c,d]) â†’ [[b],[c,d]]ï¼Œæœ€çŸ­=1ï¼Œç´¯åŠ =2 < 3ï¼Œç»§ç»­\r\n        //     3. [e] â†’ [[e]]ï¼Œæœ€çŸ­=1ï¼Œç´¯åŠ =3 >= 3 âœ… åœæ­¢\r\n        //   ç¬›å¡å°”ç§¯ï¼š[[a]] Ã— [[b],[c,d]] Ã— [[e]] = [[a,b,e],[a,c,d,e]]\r\n        //   æˆªå–åˆ°3ï¼š[[a,b,e],[a,c,d]]\r\n        //\r\n        // ç¤ºä¾‹3ï¼šåŒ…å«ç©ºåˆ†æ”¯ sequence([a], option([b]), [c,d])  firstK=2\r\n        //   ä¼˜åŒ–1ï¼šslice(0,2) â†’ æœ€å¤šå±•å¼€å‰2ä¸ª\r\n        //   ä¼˜åŒ–2ï¼š\r\n        //     1. [a] â†’ [[a]]ï¼Œæœ€çŸ­=1ï¼Œç´¯åŠ =1 < 2ï¼Œç»§ç»­\r\n        //     2. option([b]) â†’ [[],[b]]ï¼Œæœ€çŸ­=0ï¼ˆç©ºåˆ†æ”¯ï¼ï¼‰ï¼Œç´¯åŠ =1 < 2ï¼Œç»§ç»­\r\n        //   ç´¯åŠ ä¸å¤Ÿï¼Œéœ€è¦å±•å¼€ç¬¬3ä¸ªèŠ‚ç‚¹ï¼Œä½† slice(0,2) é™åˆ¶äº†\r\n        //   ç¬›å¡å°”ç§¯ï¼š[[a]] Ã— [[],[b]] = [[a],[a,b]]\r\n        //   æˆªå–åˆ°2ï¼š[[a],[a,b]]ï¼ˆä¸éœ€è¦æˆªå–ï¼‰\r\n        //\r\n        // âœ… åŒé‡ä¿æŠ¤ï¼š\r\n        // - æœ€åæƒ…å†µï¼šå±•å¼€ firstK ä¸ªèŠ‚ç‚¹ï¼ˆä¼˜åŒ–1ï¼‰\r\n        // - æœ€å¥½æƒ…å†µï¼šå±•å¼€ 1 ä¸ªèŠ‚ç‚¹ï¼ˆä¼˜åŒ–2ï¼‰\r\n        // - å¹³å‡æƒ…å†µï¼šå±•å¼€ < firstK ä¸ªèŠ‚ç‚¹\r\n\r\n        // âš ï¸âš ï¸âš ï¸ åŒé‡ä¼˜åŒ–ç­–ç•¥ï¼š\r\n        // 1. ç¬¬ä¸€å±‚ä¿æŠ¤ï¼šslice(0, firstK) - æœ€å¤šå±•å¼€ firstK ä¸ªèŠ‚ç‚¹\r\n        // 2. ç¬¬äºŒå±‚ä¼˜åŒ–ï¼šç´¯åŠ æå‰åœæ­¢ - åœ¨ firstK ä¸ªèŠ‚ç‚¹å†…æå‰åœæ­¢\r\n\r\n        // ğŸ”´ æ–°å¢ï¼šè®¡ç®—éœ€è¦å±•å¼€åˆ°çš„ç´¢å¼•ï¼ˆè€ƒè™‘ option/many ä¸è®¡å…¥å¿…éœ€å…ƒç´ ï¼‰\r\n        let requiredCount = 0  // é option/many çš„è®¡æ•°\r\n        let expandToIndex = node.nodes.length  // é»˜è®¤å…¨éƒ¨å±•å¼€\r\n\r\n        // éå†æ‰¾åˆ°ç¬¬ firstK ä¸ªå¿…éœ€å…ƒç´ çš„ä½ç½®\r\n        for (let i = 0; i < node.nodes.length; i++) {\r\n            const child = node.nodes[i]\r\n\r\n            // é option/many æ‰è®¡æ•°\r\n            if (child.type !== 'option' && child.type !== 'many') {\r\n                requiredCount++\r\n\r\n                // æ‰¾åˆ°ç¬¬ firstK ä¸ªå¿…éœ€å…ƒç´ \r\n                if (requiredCount >= firstK) {\r\n                    // åŒ…å«å½“å‰å…ƒç´ ï¼Œæ‰€ä»¥æ˜¯ i + 1\r\n                    expandToIndex = i + 1\r\n                    break\r\n                }\r\n            }\r\n\r\n        }\r\n\r\n        // ä½¿ç”¨è®¡ç®—å‡ºçš„ç´¢å¼•è¿›è¡Œæˆªå–ï¼ˆæ›¿æ¢åŸæ¥çš„ç®€å• firstKï¼‰\r\n        // const nodesToExpand = node.nodes.slice(0, firstK)\r\n        const nodesToExpand = node.nodes.slice(0, expandToIndex)\r\n\r\n        const allBranches: string[][][] = []\r\n        let minLengthSum = 0  // ç´¯åŠ çš„æœ€çŸ­é•¿åº¦\r\n\r\n        // éå†å‰ firstK ä¸ªå­èŠ‚ç‚¹ï¼Œç´¯åŠ æœ€çŸ­åˆ†æ”¯é•¿åº¦\r\n        for (let i = 0; i < nodesToExpand.length; i++) {\r\n            this.checkTimeout(`expandSequenceNode-å­èŠ‚ç‚¹${i + 1}`)\r\n\r\n            const expandChildStartTime = Date.now()\r\n\r\n            // å±•å¼€å½“å‰å­èŠ‚ç‚¹\r\n            // ğŸ’¡ ä¼ é€’ç´¯ç§¯çš„ä½ç½®ä¿¡æ¯ï¼šçˆ¶çº§æ˜¯ç¬¬1ä¸ª AND å½“å‰ä¹Ÿæ˜¯ç¬¬1ä¸ª\r\n            let branches = this.expandNode(\r\n                nodesToExpand[i],\r\n                firstK,\r\n                curLevel,\r\n                maxLevel,\r\n                isFirstPosition && i === 0  // ç´¯ç§¯ä½ç½®ï¼šåªæœ‰å½“çˆ¶çº§å’Œå½“å‰éƒ½æ˜¯ç¬¬1ä¸ªæ—¶æ‰æ˜¯ true\r\n            )\r\n\r\n            const expandChildDuration = Date.now() - expandChildStartTime\r\n\r\n            // å¦‚æœ branches ä¸ºç©ºï¼ˆå¯èƒ½æ˜¯å·¦é€’å½’æ£€æµ‹è¿”å›çš„ç©ºæ•°ç»„ï¼‰\r\n            if (branches.length === 0) {\r\n                // å·¦é€’å½’æƒ…å†µï¼Œè¿”å›ç©ºåˆ†æ”¯\r\n                return []\r\n            }\r\n\r\n            branches = branches.map(item => item.slice(0, firstK));\r\n            allBranches.push(branches);\r\n\r\n\r\n            // æ‰¾åˆ°å½“å‰å­èŠ‚ç‚¹çš„æœ€çŸ­åˆ†æ”¯é•¿åº¦ï¼ˆå®‰å…¨å†™æ³•ï¼‰\r\n            let minLength = Infinity;\r\n            for (const b of branches) {\r\n                const len = b.length;\r\n                if (len < minLength) {\r\n                    minLength = len;\r\n                    if (minLength === 0) break; // å·²ç»æœ€å°ï¼Œæå‰ç»“æŸ\r\n                }\r\n            }\r\n\r\n            minLengthSum += minLength;\r\n\r\n            // å¦‚æœç´¯åŠ çš„æœ€çŸ­é•¿åº¦ >= firstKï¼Œå¯ä»¥åœæ­¢\r\n            if (minLengthSum >= firstK) {\r\n                break;\r\n            }\r\n        }\r\n\r\n        // å¦‚æœæ²¡æœ‰å±•å¼€ä»»ä½•èŠ‚ç‚¹ï¼ˆå¯èƒ½æ˜¯å·¦é€’å½’æ£€æµ‹è¿”å›çš„ç©ºæ•°ç»„ï¼‰\r\n        if (allBranches.length === 0) {\r\n            // å·¦é€’å½’æƒ…å†µï¼Œè¿”å›ç©ºåˆ†æ”¯\r\n            return []\r\n        }\r\n\r\n        // è°ƒç”¨ç¬›å¡å°”ç§¯\r\n        this.checkTimeout('expandSequenceNode-ç¬›å¡å°”ç§¯å‰')\r\n        const result = this.cartesianProduct(allBranches, firstK)\r\n        this.checkTimeout('expandSequenceNode-ç¬›å¡å°”ç§¯å')\r\n\r\n        // æ³¨æ„ï¼šå¦‚æœæŸäº›èŠ‚ç‚¹åŒ…å«ç©ºåˆ†æ”¯ï¼Œç¬›å¡å°”ç§¯åå¯èƒ½äº§ç”Ÿä¸åŒé•¿åº¦çš„è·¯å¾„\r\n        const finalResult = this.truncateAndDeduplicate(result, firstK)\r\n\r\n        // è®°å½•æ€§èƒ½ç»Ÿè®¡\r\n        this.perfAnalyzer.endMethod(callId, node.nodes.length, finalResult.length)\r\n\r\n        return finalResult\r\n    }\r\n\r\n\r\n    /**\r\n     * å¹¿åº¦ä¼˜å…ˆå±•å¼€ï¼ˆBFS - Breadth-First Searchï¼‰\r\n     *\r\n     * ğŸš€ ç®—æ³•ï¼šé€å±‚å¾ªç¯ï¼Œç²¾ç¡®æ§åˆ¶å±‚æ•°\r\n     * ğŸ”¥ ä¼˜åŒ–ï¼šå¢é‡å¤ç”¨ - ä»æœ€è¿‘çš„ç¼“å­˜å±‚çº§å¼€å§‹ï¼Œè€Œéæ¯æ¬¡ä» level 1 å¼€å§‹\r\n     *\r\n     * é€‚ç”¨åœºæ™¯ï¼š\r\n     * - maxLevel = å…·ä½“å€¼ï¼ˆå¦‚ 3, 5ï¼‰\r\n     * - éœ€è¦å±•å¼€åˆ°æŒ‡å®šå±‚çº§\r\n     * - é€‚åˆ First(âˆ) + é™åˆ¶å±‚æ•°\r\n     *\r\n     * è®¾è®¡ç†å¿µï¼š\r\n     * - BFS åªè´Ÿè´£æŒ‰å±‚çº§å®Œæ•´å±•å¼€ï¼ˆfirstK=âˆï¼‰\r\n     * - ä¸è´Ÿè´£æˆªå–æ“ä½œ\r\n     * - æˆªå–ç”±å¤–å±‚è°ƒç”¨è€…ç»Ÿä¸€å¤„ç†\r\n     *\r\n     * ä¼˜åŒ–ç­–ç•¥ï¼š\r\n     * - å¢é‡å¤ç”¨ï¼šlevel3 = level2 + å±•å¼€1å±‚\r\n     * - ç¼“å­˜æŸ¥æ‰¾ï¼šä» maxLevel-1 â†’ maxLevel-2 â†’ ... â†’ level 1\r\n     * - è·³è¿‡ä¸­é—´è®¡ç®—ï¼šé¿å…é‡å¤å±•å¼€ä½å±‚çº§\r\n     *\r\n     * @param ruleName é¡¶å±‚è§„åˆ™å\r\n     * @param maxLevel ç›®æ ‡å±‚çº§\r\n     * @returns å±•å¼€åˆ°ç›®æ ‡å±‚çº§çš„å®Œæ•´è·¯å¾„ï¼ˆä¸æˆªå–ï¼‰\r\n     *\r\n     * æ ¸å¿ƒé€»è¾‘ï¼ˆå¢é‡å±•å¼€ï¼‰ï¼š\r\n     * 1. æŸ¥æ‰¾æœ€è¿‘çš„ç¼“å­˜å±‚çº§ï¼ˆmaxLevel-1, maxLevel-2, ..., 1ï¼‰\r\n     * 2. ä»æœ€è¿‘çš„ç¼“å­˜å¼€å§‹å±•å¼€ï¼ˆè€Œéæ€»æ˜¯ä» level 1ï¼‰\r\n     * 3. æ¯æ¬¡å±•å¼€1å±‚ï¼šè°ƒç”¨ expandSinglePath\r\n     * 4. åˆ†ç¦»å·²å®Œæˆï¼ˆå…¨tokenï¼‰å’Œæœªå®Œæˆï¼ˆå«è§„åˆ™åï¼‰çš„è·¯å¾„\r\n     * 5. ç»§ç»­å±•å¼€æœªå®Œæˆçš„è·¯å¾„\r\n     * 6. è¾¾åˆ°ç›®æ ‡å±‚çº§ååœæ­¢\r\n     *\r\n     * ç¤ºä¾‹ï¼š\r\n     * å±•å¼€ level 4ï¼š\r\n     *   - æŸ¥æ‰¾ level 3 ç¼“å­˜ â†’ æ‰¾åˆ° âœ…\r\n     *   - level 3 + å±•å¼€1å±‚ = level 4\r\n     *   - èŠ‚çœï¼šlevel 1â†’2â†’3 çš„è®¡ç®—\r\n     */\r\n    /**\r\n     * BFS å±•å¼€ï¼ˆçº¯é€’å½’å®ç°ï¼Œæ™ºèƒ½ç¼“å­˜å¤ç”¨ï¼‰\r\n     *\r\n     * æ ¸å¿ƒæ€æƒ³ï¼š\r\n     * 1. æŸ¥æ‰¾æœ€å¤§å¯ç”¨ç¼“å­˜å—ï¼ˆå¦‚ level 3ï¼‰\r\n     * 2. å¯¹ç¼“å­˜çš„æ¯ä¸ªè·¯å¾„ä¸­çš„è§„åˆ™åï¼Œé€’å½’è°ƒç”¨è‡ªå·±\r\n     * 3. ç¼“å­˜å¹¶è¿”å›ç»“æœ\r\n     *\r\n     * ç¤ºä¾‹ï¼šæŸ¥æ‰¾ A:10ï¼Œç¼“å­˜æœ‰ A:3\r\n     * - æ‰¾åˆ° A:3 = [a1, B, c1]\r\n     * - å¯¹ B é€’å½’è°ƒç”¨ expandPathsByBFSCache(B, 7, [B])\r\n     *   - æ‰¾åˆ° B:3 = [b1, C, c1]\r\n     *   - å¯¹ C é€’å½’è°ƒç”¨ expandPathsByBFSCache(C, 4, [C])\r\n     *     - æ‰¾åˆ° C:3 = [c1, D, c3]\r\n     *     - å¯¹ D é€’å½’è°ƒç”¨ expandPathsByBFSCache(D, 1, [D])\r\n     *       - è¿”å› getDirectChildren(D)\r\n     *     - ç¼“å­˜ C:4 âœ…\r\n     *   - ç¼“å­˜ B:7 âœ…\r\n     * - ç¼“å­˜ A:10 âœ…\r\n     *\r\n     * BFS å±•å¼€ï¼ˆçº¯å‡€ç‰ˆï¼Œå•æ–¹æ³•é€’å½’å®ç°ï¼‰\r\n     *\r\n     * æ ¸å¿ƒé€»è¾‘ï¼š\r\n     * 1. æŸ¥æ‰¾ ruleName çš„æœ€è¿‘ç¼“å­˜\r\n     * 2. å¯¹ç¼“å­˜çš„æ¯ä¸ªè·¯å¾„ä¸­çš„è§„åˆ™åï¼Œé€’å½’è°ƒç”¨è‡ªå·±\r\n     * 3. è‡ªåŠ¨ç¼“å­˜ä¸­é—´ç»“æœ\r\n     *\r\n     * ç¤ºä¾‹ï¼šæŸ¥æ‰¾ A:10ï¼Œç¼“å­˜æœ‰ A:3\r\n     * - æŸ¥æ‰¾ A:10 â†’ æ‰¾åˆ° A:3 = [[a1, B, c1]]\r\n     * - å¯¹ B é€’å½’ï¼šexpandPathsByBFSCacheClean(B, 7)\r\n     *   - æŸ¥æ‰¾ B:7 â†’ æ‰¾åˆ° B:3 = [[b1, C, d1]]\r\n     *   - å¯¹ C é€’å½’ï¼šexpandPathsByBFSCacheClean(C, 4)\r\n     *     - æŸ¥æ‰¾ C:4 â†’ æ‰¾åˆ° C:3 = [[c1, D, e1]]\r\n     *     - å¯¹ D é€’å½’ï¼šexpandPathsByBFSCacheClean(D, 1)\r\n     *       â†’ è¿”å› getDirectChildren(D)\r\n     *     - ç¼“å­˜ C:4 âœ…\r\n     *   - ç¼“å­˜ B:7 âœ…\r\n     * - ç¼“å­˜ A:10 âœ…\r\n     *\r\n     * @param ruleName è§„åˆ™å\r\n     * @param targetLevel ç›®æ ‡å±‚çº§\r\n     * @returns å±•å¼€ç»“æœ\r\n     */\r\n    private expandPathsByBFSCache(\r\n        ruleName: string,\r\n        targetLevel: number,\r\n    ): string[][] {\r\n        const depth = this.currentDepth\r\n\r\n        // é˜²å¾¡æ£€æŸ¥\r\n        if (targetLevel === 0) {\r\n            throw new Error('ç³»ç»Ÿé”™è¯¯')\r\n        }\r\n\r\n        // tokenï¼Œç›´æ¥è¿”å›\r\n        // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿ token æ£€æŸ¥é€»è¾‘ä¸ getDirectChildren ä¸€è‡´ï¼Œå¹¶è®¾ç½®ç¼“å­˜\r\n        const tokenNode = this.tokenCache?.get(ruleName)\r\n        if (tokenNode && tokenNode.type === 'consume') {\r\n            const result = [[ruleName]]\r\n            return result\r\n        }\r\n\r\n        // åŸºç¡€æƒ…å†µï¼šlevel 1\r\n        if (targetLevel === EXPANSION_LIMITS.LEVEL_1) {\r\n            this.writeLog(`è§¦å‘ getDirectChildren(${ruleName}) [æ‰§è¡Œä¸­]`, depth)\r\n            this.currentDepth = depth + 1\r\n            const result = this.getDirectChildren(ruleName)\r\n            this.currentDepth = depth\r\n            this.writeLog(`è§¦å‘ getDirectChildren(${ruleName}) [æ‰§è¡Œå®Œ]`, depth)\r\n            this.writeLog(`â—€ è¿”å›: expandPathsByBFSCache(${ruleName}, targetLevel=1), è·¯å¾„æ•°: ${result.length} [æ‰§è¡Œå®Œ]`, depth)\r\n            return result\r\n        }\r\n\r\n        const key = `${ruleName}:${targetLevel}`\r\n\r\n        // æ›´æ–°å½“å‰å¤„ç†è§„åˆ™ï¼ˆç”¨äºè¶…æ—¶æ—¥å¿—ï¼‰\r\n        this.currentProcessingRule = `${ruleName}:Level${targetLevel}`\r\n\r\n        // è¶…æ—¶æ£€æµ‹\r\n        this.checkTimeout(`expandPathsByBFSCache-${ruleName}-Level${targetLevel}`)\r\n\r\n        // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ç¼“å­˜\r\n        if (this.bfsLevelCache.has(key)) {\r\n            const cached = this.getCacheValue('bfsLevelCache', key)!\r\n            this.writeLog(`âœ… BFSç¼“å­˜å‘½ä¸­: ${key}, è·¯å¾„æ•°: ${cached.length}`, depth)\r\n            this.writeLog(`â—€ è¿”å›: expandPathsByBFSCache(${ruleName}, targetLevel=${targetLevel}), ç¼“å­˜å‘½ä¸­, è·¯å¾„æ•°: ${cached.length} [æ‰§è¡Œå®Œ]`, depth)\r\n            return cached\r\n        }\r\n\r\n        this.writeLog(`âŒ BFSç¼“å­˜æœªå‘½ä¸­: ${key}`, depth)\r\n\r\n        // æŸ¥æ‰¾ ruleName çš„æœ€è¿‘ç¼“å­˜\r\n        let cachedLevel = 1\r\n        let cachedBranches: string[][] | null = null\r\n\r\n        for (let level = Math.min(targetLevel, EXPANSION_LIMITS.LEVEL_K); level >= 2; level--) {\r\n            const cacheKey = `${ruleName}:${level}`\r\n            if (this.bfsLevelCache.has(cacheKey)) {\r\n                cachedLevel = level\r\n                cachedBranches = this.getCacheValue('bfsLevelCache', cacheKey)!\r\n                this.writeLog(`âœ… æ‰¾åˆ°ç¼“å­˜: ${cacheKey}, è·¯å¾„æ•°: ${cachedBranches.length}`, depth)\r\n\r\n                // æå‰è¿”å›ï¼šæ‰¾åˆ°ç›®æ ‡å±‚çº§\r\n                if (level === targetLevel) {\r\n                    this.writeLog(`â—€ è¿”å›: expandPathsByBFSCache(${ruleName}, targetLevel=${targetLevel}), ä½¿ç”¨ç¼“å­˜, è·¯å¾„æ•°: ${cachedBranches.length} [æ‰§è¡Œå®Œ]`, depth)\r\n                    return cachedBranches\r\n                }\r\n                break\r\n            } else {\r\n                this.writeLog(`âŒ æ²¡æœ‰ç¼“å­˜: ${cacheKey}`, depth)\r\n            }\r\n        }\r\n\r\n        // æ²¡æœ‰æ‰¾åˆ°ç¼“å­˜ï¼ˆä¸åº”è¯¥å‘ç”Ÿï¼‰\r\n        if (!cachedBranches) {\r\n            this.writeLog(`è§¦å‘ getDirectChildren(${ruleName}) [æ‰§è¡Œä¸­]`, depth)\r\n            cachedLevel = EXPANSION_LIMITS.LEVEL_1\r\n            this.currentDepth = depth + 1\r\n            cachedBranches = this.getDirectChildren(ruleName)\r\n            this.currentDepth = depth\r\n            this.writeLog(`è§¦å‘ getDirectChildren(${ruleName}) [æ‰§è¡Œå®Œ]`, depth)\r\n        }\r\n\r\n        // è®¡ç®—å‰©ä½™å±‚æ•°\r\n        const remainingLevels = targetLevel - cachedLevel\r\n\r\n        // é˜²å¾¡æ£€æŸ¥\r\n        if (remainingLevels <= 0) {\r\n            throw new Error('ç³»ç»Ÿé”™è¯¯')\r\n        }\r\n\r\n        // å¯¹ cachedPaths çš„æ¯ä¸ªè·¯å¾„é€’å½’å±•å¼€\r\n        let expandedPaths: string[][] = []\r\n        const totalPaths = cachedBranches.length\r\n\r\n        // å¦‚æœæ˜¯æœ€ç»ˆå±‚çº§ï¼Œè®°å½•æ¯ä¸ªåˆ†æ”¯çš„ç»“æœ\r\n        const branchResults: Array<{ branchName: string, paths: string[][] }> = []\r\n\r\n        for (let branchIndex = 0; branchIndex < cachedBranches.length; branchIndex++) {\r\n            const branchSeqRules = cachedBranches[branchIndex]\r\n\r\n            // è¶…æ—¶æ£€æµ‹\r\n            if (branchIndex % 10 === 0 || branchIndex === cachedBranches.length - 1) {\r\n                this.checkTimeout(`expandPathsByBFSCache-${ruleName}-å¤„ç†è·¯å¾„${branchIndex + 1}/${totalPaths}`)\r\n            }\r\n\r\n            const branchAllRuleBranchSeqs: string[][][] = []\r\n\r\n            // éå†è·¯å¾„ä¸­çš„æ¯ä¸ªç¬¦å·ï¼Œé€’å½’å±•å¼€\r\n            for (let ruleIndex = 0; ruleIndex < branchSeqRules.length; ruleIndex++) {\r\n                const subRuleName = branchSeqRules[ruleIndex]\r\n\r\n                // è¶…æ—¶æ£€æµ‹\r\n                this.checkTimeout(`expandPathsByBFSCache-${ruleName}-å±•å¼€ç¬¦å·${ruleIndex + 1}/${branchSeqRules.length}:${subRuleName}`)\r\n\r\n                // ğŸ”´ é€’å½’æ£€æµ‹ï¼šå¦‚æœå½“å‰è·¯å¾„ä¸­å·²ç»åŒ…å«äº†è¿™ä¸ªè§„åˆ™åï¼Œä¸å†å±•å¼€\r\n                // è¿™å¯ä»¥é˜²æ­¢å³é€’å½’å¯¼è‡´çš„è·¯å¾„çˆ†ç‚¸\r\n                // ä¾‹å¦‚ï¼šAssignmentExpression â†’ LeftHandSideExpression Assign AssignmentExpression\r\n                //       å¦‚æœè·¯å¾„ä¸­å·²ç»æœ‰ AssignmentExpressionï¼Œå°±ä¸å†å±•å¼€ç¬¬äºŒä¸ª AssignmentExpression\r\n                if (branchSeqRules.includes(subRuleName) && branchSeqRules.indexOf(subRuleName) < ruleIndex) {\r\n                    // è·¯å¾„ä¸­å·²ç»åŒ…å«äº†è¿™ä¸ªè§„åˆ™åï¼Œç›´æ¥è¿”å›è§„åˆ™åæœ¬èº«ï¼Œä¸å†å±•å¼€\r\n                    this.writeLog(`âš ï¸ é€’å½’æ£€æµ‹: ${subRuleName} å·²åœ¨è·¯å¾„ä¸­ï¼Œä¸å†å±•å¼€`, depth)\r\n                    branchAllRuleBranchSeqs.push([[subRuleName]])\r\n                    continue\r\n                }\r\n\r\n                // å±•å¼€å­è§„åˆ™ï¼ˆä¼šè‡ªåŠ¨ä½¿ç”¨ bfsLevelCache ç¼“å­˜ï¼‰\r\n                this.writeLog(`å±•å¼€å­è§„åˆ™: ${subRuleName}, å‰©ä½™å±‚æ•°: ${remainingLevels} [æ‰§è¡Œä¸­]`, depth)\r\n                this.currentDepth = depth + 1\r\n                const result = this.expandPathsByBFSCache(subRuleName, remainingLevels)\r\n                this.currentDepth = depth\r\n                branchAllRuleBranchSeqs.push(result)\r\n                this.writeLog(`å±•å¼€å­è§„åˆ™: ${subRuleName}, å‰©ä½™å±‚æ•°: ${remainingLevels} [æ‰§è¡Œå®Œ], ç»“æœæ•°: ${result.length}`, depth)\r\n            }\r\n\r\n            // è®¡ç®—ç¬›å¡å°”ç§¯çš„æ€»è®¡ç®—é‡\r\n            const branchSizes = branchAllRuleBranchSeqs.map(b => b.length)\r\n            const estimatedCombinations = branchSizes.reduce((a, b) => a * b, 1)\r\n            const totalInputSize = branchSizes.reduce((a, b) => a + b, 0)\r\n            this.writeLog(`ç¬›å¡å°”ç§¯è®¡ç®— [æ‰§è¡Œä¸­]: åˆ†æ”¯æ•°: ${branchAllRuleBranchSeqs.length}, å„åˆ†æ”¯å¤§å°: [${branchSizes.join(', ')}], é¢„è®¡ç»„åˆæ•°: ${estimatedCombinations}, æ€»è¾“å…¥å¤§å°: ${totalInputSize}`, depth)\r\n\r\n            const pathResult = this.cartesianProduct(branchAllRuleBranchSeqs, EXPANSION_LIMITS.INFINITY)\r\n\r\n            this.writeLog(`ç¬›å¡å°”ç§¯è®¡ç®— [æ‰§è¡Œå®Œ]: ç»“æœæ•°: ${pathResult.length}, é¢„è®¡ç»„åˆæ•°: ${estimatedCombinations}`, depth)\r\n\r\n            // è¶…æ—¶æ£€æµ‹\r\n            this.checkTimeout(`expandPathsByBFSCache-${ruleName}-è·¯å¾„${branchIndex + 1}-ç¬›å¡å°”ç§¯å`)\r\n\r\n            // å¦‚æœæ˜¯æœ€ç»ˆå±‚çº§ï¼Œè®°å½•è¿™ä¸ªåˆ†æ”¯çš„ç»“æœ\r\n            if (targetLevel === EXPANSION_LIMITS.LEVEL_K) {\r\n                const branchName = branchSeqRules.join(' ')\r\n                branchResults.push({\r\n                    branchName: branchName,\r\n                    paths: pathResult\r\n                })\r\n            }\r\n\r\n            expandedPaths = expandedPaths.concat(pathResult)\r\n        }\r\n        this.checkTimeout(`expandPathsByBFSCache-${ruleName}-å»é‡å‰`)\r\n        const finalResult = this.deduplicate(expandedPaths)\r\n\r\n        // å­˜å…¥ç¼“å­˜ï¼ˆæ— è®ºæ˜¯å¦æ˜¯æœ€ç»ˆå±‚çº§ï¼‰\r\n        // å¤ç”¨ä¹‹å‰å®šä¹‰çš„ key å˜é‡\r\n        if (this.bfsLevelCache.has(key)) {\r\n            throw new Error('ç³»ç»Ÿé”™è¯¯')\r\n        }\r\n        // ğŸ”§ ä¼˜åŒ–ï¼šå¦‚æœç»“æœæ˜¯è§„åˆ™åæœ¬èº«ï¼ˆæœªå±•å¼€ï¼‰ï¼Œä¸åŠ å…¥ç¼“å­˜\r\n        const shouldCache = !this.isRuleNameOnly(finalResult, ruleName)\r\n        if (shouldCache) {\r\n            this.bfsLevelCache.set(key, finalResult)\r\n            this.writeLog(`ğŸ“¦ å­˜å‚¨ç¼“å­˜: ${key}, è·¯å¾„æ•°: ${finalResult.length}`, depth)\r\n        } else {\r\n            this.writeLog(`âš ï¸ è·³è¿‡ç¼“å­˜ï¼ˆè§„åˆ™åæœ¬èº«ï¼‰: ${key}`, depth)\r\n        }\r\n\r\n        // åªåœ¨æœ€ç»ˆå±‚çº§è¾“å‡ºè¯¦ç»†æ—¥å¿—\r\n        if (targetLevel === EXPANSION_LIMITS.LEVEL_K) {\r\n            // è¾“å‡ºæ¯ä¸ªåˆ†æ”¯çš„ç»“æœ\r\n            this.writeLog(``, depth)\r\n            this.writeLog(`ğŸ“‹ å®Œæ•´ç»“æœ (å…± ${finalResult.length} æ¡è·¯å¾„, ${branchResults.length} ä¸ªè¯­æ³•åˆ†æ”¯):`, depth)\r\n            this.writeLog(`${'='.repeat(80)}`, depth)\r\n\r\n            for (let i = 0; i < branchResults.length; i++) {\r\n                const branch = branchResults[i]\r\n                this.writeLog(``, depth)\r\n                this.writeLog(`åˆ†æ”¯ ${i + 1}: ${branch.branchName} (${branch.paths.length} æ¡è·¯å¾„)`, depth)\r\n                this.writeLog(`${'-'.repeat(80)}`, depth)\r\n\r\n                branch.paths.forEach((path, index) => {\r\n                    this.writeLog(`   ${(index + 1).toString().padStart(4, ' ')}. ${path.join(' ')}`, depth)\r\n                })\r\n            }\r\n\r\n            this.writeLog(`${'='.repeat(80)}`, depth)\r\n            this.writeLog(``, depth)\r\n        }\r\n        this.writeLog(`â—€ è¿”å›: expandPathsByBFSCache(${ruleName}, targetLevel=${targetLevel}), è·¯å¾„æ•°: ${finalResult.length} [æ‰§è¡Œå®Œ]`, depth)\r\n        return finalResult\r\n    }\r\n\r\n    /**\r\n     * è·å–è§„åˆ™çš„ç›´æ¥å­èŠ‚ç‚¹ï¼ˆå±•å¼€1å±‚ï¼‰\r\n     *\r\n     * @param ruleName è§„åˆ™å\r\n     * @returns ç›´æ¥å­èŠ‚ç‚¹çš„æ‰€æœ‰è·¯å¾„ï¼ˆå±•å¼€1å±‚ï¼‰\r\n     *\r\n     * ä¼˜å…ˆçº§ï¼š\r\n     * 1. ä» bfsLevelCache è·å– \"ruleName:1\"ï¼ˆå¦‚æœå·²åˆå§‹åŒ–ï¼‰\r\n     * 2. åŠ¨æ€è®¡ç®—å¹¶ç¼“å­˜\r\n     *\r\n     * ç¤ºä¾‹ï¼š\r\n     * - Statement â†’ [[BlockStatement], [IfStatement], [ExpressionStatement], ...]\r\n     * - IfStatement â†’ [[If, LParen, Expression, RParen, Statement]]\r\n     */\r\n    private getDirectChildren(ruleName: string): string[][] {\r\n        const maxLevel = EXPANSION_LIMITS.LEVEL_1\r\n\r\n        // 1. ä¼˜å…ˆä» bfsLevelCache è·å– level 1 çš„æ•°æ®ï¼ˆæ‡’åŠ è½½ç¼“å­˜ï¼‰\r\n        const key = `${ruleName}:${maxLevel}`\r\n        const depth = this.currentDepth\r\n\r\n        if (this.bfsLevelCache.has(key)) {\r\n            this.perfAnalyzer.recordCacheHit('getDirectChildren')\r\n            const cached = this.getCacheValue('bfsLevelCache', key)!\r\n            this.writeLog(`âœ… getDirectChildrenç¼“å­˜å‘½ä¸­: ${key}, è·¯å¾„æ•°: ${cached.length}`, depth)\r\n            this.writeLog(`â—€ è¿”å›: getDirectChildren(${ruleName}), ç¼“å­˜å‘½ä¸­, è·¯å¾„æ•°: ${cached.length} [æ‰§è¡Œå®Œ]`, depth)\r\n            return cached\r\n        }\r\n\r\n        // ç¼“å­˜æœªå‘½ä¸­ï¼Œéœ€è¦åŠ¨æ€è®¡ç®—\r\n        this.perfAnalyzer.recordCacheMiss('getDirectChildren')\r\n        this.writeLog(`âŒ getDirectChildrenç¼“å­˜æœªå‘½ä¸­: ${key}`, depth)\r\n\r\n        // 2. æ£€æŸ¥æ˜¯å¦æ˜¯ token\r\n        const tokenNode = this.tokenCache?.get(ruleName)\r\n        if (tokenNode && tokenNode.type === 'consume') {\r\n            const result = [[ruleName]]\r\n            this.writeLog(`â—€ è¿”å›: getDirectChildren(${ruleName}), TokenèŠ‚ç‚¹, è·¯å¾„æ•°: 1 [æ‰§è¡Œå®Œ]`, depth)\r\n            return result\r\n        }\r\n\r\n        // 3. è·å–è§„åˆ™çš„ AST èŠ‚ç‚¹\r\n        const subNode = this.getRuleNodeByAst(ruleName)\r\n        if (!subNode) {\r\n            throw new Error(`ç³»ç»Ÿé”™è¯¯ï¼šè§„åˆ™ä¸å­˜åœ¨: ${ruleName}`)\r\n        }\r\n\r\n        // 4. åŠ¨æ€è®¡ç®—ï¼šå±•å¼€1å±‚\r\n        // expandPathsByDFS â†’ subRuleHandler ä¼šè‡ªåŠ¨ç¼“å­˜åˆ° \"ruleName:1\"\r\n        const t0 = Date.now()\r\n        const result = this.expandPathsByDFSCache(\r\n            ruleName,\r\n            EXPANSION_LIMITS.INFINITY,\r\n            0,\r\n            maxLevel,\r\n            false,\r\n        )\r\n        const duration = Date.now() - t0\r\n\r\n        // ç¼“å­˜è®¡ç®—ç»“æœï¼ˆæ‡’åŠ è½½å¡«å……ï¼‰\r\n        // ğŸ”§ ä¼˜åŒ–ï¼šå¦‚æœç»“æœæ˜¯è§„åˆ™åæœ¬èº«ï¼ˆæœªå±•å¼€ï¼‰ï¼Œä¸åŠ å…¥ç¼“å­˜\r\n        const shouldCache = !this.isRuleNameOnly(result, ruleName)\r\n        if (shouldCache && !this.bfsLevelCache.has(key)) {\r\n            this.bfsLevelCache.set(key, result)\r\n            this.writeLog(`ğŸ“¦ å­˜å‚¨BFSç¼“å­˜: ${key}, è·¯å¾„æ•°: ${result.length}`, depth)\r\n        } else if (!shouldCache) {\r\n            this.writeLog(`âš ï¸ è·³è¿‡ç¼“å­˜ï¼ˆè§„åˆ™åæœ¬èº«ï¼‰: ${key}`, depth)\r\n        }\r\n\r\n        this.writeLog(`â—€ è¿”å›: getDirectChildren(${ruleName}), è·¯å¾„æ•°: ${result.length} [æ‰§è¡Œå®Œ]`, depth)\r\n        return result\r\n    }\r\n\r\n    /**\r\n     * å¤„ç† DFS æ¨¡å¼ï¼ˆæ·±åº¦ä¼˜å…ˆå±•å¼€ï¼Œæ— é™å±‚çº§ï¼‰\r\n     *\r\n     * @param ruleName è§„åˆ™å\r\n     * @param firstK æˆªå–æ•°é‡\r\n     * @param curLevel å½“å‰å±‚çº§\r\n     * @param maxLevel\r\n     * @param isFirstPosition æ˜¯å¦åœ¨ç¬¬ä¸€ä¸ªä½ç½®ï¼ˆç”¨äºå·¦é€’å½’æ£€æµ‹ï¼‰\r\n     * @returns å±•å¼€ç»“æœ\r\n     */\r\n    private expandPathsByDFSCache(\r\n        ruleName: string,\r\n        firstK: number,\r\n        curLevel: number,\r\n        maxLevel: number,\r\n        isFirstPosition: boolean\r\n    ): string[][] {\r\n\r\n        // è®°å½•å…¥å£è°ƒç”¨\r\n        const t0 = Date.now()\r\n        this.perfAnalyzer.cacheStats.subRuleHandlerTotal++\r\n\r\n\r\n        // é˜²å¾¡ï¼šè§„åˆ™åä¸èƒ½ä¸ºç©º\r\n        if (!ruleName) {\r\n            throw new Error('ç³»ç»Ÿé”™è¯¯')\r\n        }\r\n\r\n        // å±‚çº§é™åˆ¶æ£€æŸ¥ï¼ˆBFS éœ€è¦ï¼‰\r\n        if (curLevel === maxLevel) {\r\n            // è¿”å›è§„åˆ™åæœ¬èº«ï¼ˆè¾¾åˆ°æœ€å¤§æ·±åº¦ï¼‰\r\n            this.perfAnalyzer.cacheStats.levelLimitReturn++\r\n            return [[ruleName]]\r\n        } else if (curLevel > maxLevel) {\r\n            throw new Error('ç³»ç»Ÿé”™è¯¯')\r\n        }\r\n\r\n        // å±‚çº§+1ï¼ˆè¿›å…¥å­è§„åˆ™ï¼‰\r\n        curLevel++\r\n\r\n        // ========================================\r\n        // é˜¶æ®µ1ï¼šDFS ç¼“å­˜æŸ¥æ‰¾ï¼ˆåœ¨é€’å½’æ£€æµ‹ä¹‹å‰ï¼ï¼‰\r\n        // ========================================\r\n\r\n        if (firstK === EXPANSION_LIMITS.FIRST_K) {\r\n            // æŸ¥æ‰¾ firstK ç¼“å­˜ï¼ˆgetCacheValue ä¼šè‡ªåŠ¨è®°å½•å‘½ä¸­/æœªå‘½ä¸­ç»Ÿè®¡ï¼‰\r\n            const cached = this.getCacheValue('dfsFirstKCache', ruleName)\r\n            if (cached !== undefined) {\r\n                // DFS ä¸éœ€è¦æ—¥å¿—\r\n                const duration = Date.now() - t0\r\n                this.perfAnalyzer.record('subRuleHandler', duration)\r\n                return cached\r\n            }\r\n            // ç¼“å­˜æœªå‘½ä¸­ï¼Œç»§ç»­æ‰§è¡Œä¸‹é¢çš„é€»è¾‘\r\n        } else if (firstK === EXPANSION_LIMITS.INFINITY) {\r\n            if (maxLevel !== EXPANSION_LIMITS.LEVEL_1) {\r\n                throw new Error(`ç³»ç»Ÿé”™è¯¯ï¼šä¸æ”¯æŒçš„å‚æ•°ç»„åˆ firstK=${firstK}, maxLevel=${maxLevel}`)\r\n            }\r\n        }\r\n\r\n        // ========================================\r\n        // é˜¶æ®µ2ï¼šé€’å½’æ£€æµ‹ï¼ˆDFS ä¸“å±ï¼‰\r\n        // ========================================\r\n\r\n        // é€’å½’æ£€æµ‹ï¼šå¦‚æœè§„åˆ™æ­£åœ¨è®¡ç®—ä¸­\r\n        if (this.recursiveDetectionSet.has(ruleName)) {\r\n            // åŒºåˆ†å·¦é€’å½’å’Œæ™®é€šé€’å½’\r\n            if (isFirstPosition) {\r\n                // åœ¨ç¬¬ä¸€ä¸ªä½ç½®é€’å½’ â†’ å·¦é€’å½’ï¼\r\n                // æ£€æŸ¥æ˜¯å¦å·²ç»è®°å½•è¿‡è¿™ä¸ªè§„åˆ™çš„å·¦é€’å½’é”™è¯¯\r\n                if (!this.detectedLeftRecursionErrors.has(ruleName)) {\r\n                    // åˆ›å»ºå·¦é€’å½’é”™è¯¯å¯¹è±¡\r\n                    const error: LeftRecursionError = {\r\n                        level: 'FATAL',\r\n                        type: 'left-recursion',\r\n                        ruleName,\r\n                        branchIndices: [],\r\n                        conflictPaths: {pathA: '', pathB: ''},\r\n                        message: `è§„åˆ™ \"${ruleName}\" å­˜åœ¨å·¦é€’å½’`,\r\n                        suggestion: '' // ç¨ååœ¨å¤–å±‚å¡«å……\r\n                    }\r\n\r\n                    // æ·»åŠ åˆ°é”™è¯¯ Map\r\n                    this.detectedLeftRecursionErrors.set(ruleName, error)\r\n                }\r\n\r\n                // è¿”å›ç©ºæ•°ç»„ï¼Œä¸­æ–­å½“å‰åˆ†æ”¯çš„è®¡ç®—\r\n                this.perfAnalyzer.cacheStats.recursiveReturn++\r\n                return [[ruleName]]\r\n            } else {\r\n                // ä¸åœ¨ç¬¬ä¸€ä¸ªä½ç½®é€’å½’ â†’ æ™®é€šé€’å½’\r\n                // è¿”å›è§„åˆ™åï¼Œé˜²æ­¢æ— é™é€’å½’\r\n                this.perfAnalyzer.cacheStats.recursiveReturn++\r\n                return [[ruleName]]\r\n            }\r\n        }\r\n\r\n        // æ ‡è®°å½“å‰è§„åˆ™æ­£åœ¨è®¡ç®—ï¼ˆé˜²æ­¢å¾ªç¯é€’å½’ï¼‰\r\n        this.recursiveDetectionSet.add(ruleName)\r\n\r\n        try {\r\n            // ========================================\r\n            // é˜¶æ®µ3ï¼šDFS å®é™…è®¡ç®—ï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰\r\n            // ========================================\r\n\r\n            this.perfAnalyzer.recordActualCompute()\r\n\r\n            // ä½¿ç”¨ DFS ä»å¤´å±•å¼€åˆ° token\r\n            const expandCallId = this.perfAnalyzer.startMethod('expandPathsByDFSCache')\r\n            const subNode = this.getRuleNodeByAst(ruleName)\r\n            const finalResult = this.expandNode(subNode, firstK, curLevel, maxLevel, isFirstPosition)\r\n            this.perfAnalyzer.endMethod(expandCallId, undefined, finalResult.length)\r\n\r\n            // ========================================\r\n            // é˜¶æ®µ4ï¼šDFS ç¼“å­˜è®¾ç½®ï¼ˆåœ¨ä»»ä½•å±‚çº§éƒ½ç¼“å­˜ï¼ï¼‰\r\n            // ========================================\r\n\r\n            // ğŸ”§ ä¼˜åŒ–ï¼šå¦‚æœç»“æœæ˜¯è§„åˆ™åæœ¬èº«ï¼ˆæœªå±•å¼€ï¼‰ï¼Œä¸åŠ å…¥ç¼“å­˜\r\n            // è¿™æ ·å¯ä»¥é¿å…ç¼“å­˜æ±¡æŸ“ï¼Œåç»­æŸ¥æ‰¾ç¼“å­˜æ—¶ä¸ä¼šè¿”å›æœªå±•å¼€çš„è§„åˆ™å\r\n            const shouldCache = !this.isRuleNameOnly(finalResult, ruleName)\r\n\r\n            if (firstK === EXPANSION_LIMITS.FIRST_K) {\r\n                // DFS ä¸»ç¼“å­˜ï¼šè®¡ç®—å’Œç¼“å­˜ firstK\r\n                if (shouldCache && !this.dfsFirstKCache.has(ruleName)) {\r\n                    // ğŸ”§ æ³¨æ„ï¼šè¿™é‡Œä¸åº”è¯¥ recordCacheMissï¼Œå› ä¸ºæœªå‘½ä¸­å·²ç»åœ¨å‰é¢è®°å½•è¿‡äº†\r\n                    this.dfsFirstKCache.set(ruleName, finalResult)\r\n                }\r\n            } else if (firstK === EXPANSION_LIMITS.INFINITY) {\r\n                if (maxLevel === EXPANSION_LIMITS.LEVEL_1) {\r\n                    const key = ruleName + `:${EXPANSION_LIMITS.LEVEL_1}`\r\n                    if (shouldCache && !this.bfsLevelCache.has(key)) {\r\n                        this.bfsLevelCache.set(key, finalResult)\r\n                    }\r\n                }\r\n            }\r\n\r\n            return finalResult\r\n        } finally {\r\n            // æ¸…é™¤é€’å½’æ ‡è®°ï¼ˆç¡®ä¿å³ä½¿å¼‚å¸¸ä¹Ÿèƒ½æ¸…é™¤ï¼‰\r\n            this.recursiveDetectionSet.delete(ruleName)\r\n        }\r\n    }\r\n\r\n\r\n    /**\r\n     * åˆ¤æ–­å±•å¼€ç»“æœæ˜¯å¦æ˜¯è§„åˆ™åæœ¬èº«ï¼ˆæœªå±•å¼€ï¼‰\r\n     *\r\n     * è§„åˆ™åæœ¬èº«çš„æƒ…å†µï¼š[[ruleName]] - åªæœ‰ä¸€ä¸ªè·¯å¾„ï¼Œä¸”è¿™ä¸ªè·¯å¾„åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œå°±æ˜¯è¿™ä¸ªè§„åˆ™å\r\n     *\r\n     * @param result å±•å¼€ç»“æœ\r\n     * @param ruleName è§„åˆ™å\r\n     * @returns å¦‚æœæ˜¯è§„åˆ™åæœ¬èº«è¿”å› trueï¼Œå¦åˆ™è¿”å› false\r\n     */\r\n    private isRuleNameOnly(result: string[][], ruleName: string): boolean {\r\n        // è§„åˆ™åæœ¬èº«çš„æƒ…å†µï¼š[[ruleName]] - åªæœ‰ä¸€ä¸ªè·¯å¾„ï¼Œä¸”è¿™ä¸ªè·¯å¾„åªæœ‰ä¸€ä¸ªå…ƒç´ \r\n        if (result.length === 1 && result[0].length === 1 && result[0][0] === ruleName) {\r\n            return true\r\n        }\r\n        return false\r\n    }\r\n\r\n    /**\r\n     * å»é‡ï¼šç§»é™¤é‡å¤çš„åˆ†æ”¯\r\n     *\r\n     * ä¾‹å¦‚ï¼š[[a,b], [c,d], [a,b]] â†’ [[a,b], [c,d]]\r\n     *\r\n     * âš ï¸ é‡è¦ï¼šç©ºåˆ†æ”¯å¤„ç†\r\n     * - ç©ºåˆ†æ”¯ [] ä¼šè¢«åºåˆ—åŒ–ä¸ºç©ºå­—ç¬¦ä¸² \"\"\r\n     * - ç©ºåˆ†æ”¯ä¸ä¼šè¢«è¿‡æ»¤ï¼Œä¼šæ­£å¸¸å‚ä¸å»é‡\r\n     * - ä¾‹å¦‚ï¼š[[], [a], []] â†’ [[], [a]]\r\n     */\r\n    private deduplicate(branches: string[][]): string[][] {\r\n        const callId = this.perfAnalyzer.startMethod('deduplicate')\r\n\r\n        // ç”¨äºè®°å½•å·²ç»è§è¿‡çš„åˆ†æ”¯ï¼ˆåºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²ï¼‰\r\n        const seen = new Set<string>()\r\n        // å­˜å‚¨å»é‡åçš„ç»“æœ\r\n        const result: string[][] = []\r\n\r\n        // éå†æ‰€æœ‰åˆ†æ”¯\r\n        for (const branch of branches) {\r\n            // å°†åˆ†æ”¯åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²ï¼ˆç”¨ä½œ Set çš„ keyï¼‰\r\n            // âš ï¸ ç©ºåˆ†æ”¯ [] ä¼šè¢«åºåˆ—åŒ–ä¸º \"\"ï¼Œä¸ä¼šè¢«è¿‡æ»¤\r\n            const key = branch.join(EXPANSION_LIMITS.RuleJoinSymbol)\r\n            // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨\r\n            if (!seen.has(key)) {\r\n                // æœªè§è¿‡ï¼Œæ·»åŠ åˆ° Set å’Œç»“æœä¸­\r\n                // âš ï¸ ç©ºåˆ†æ”¯ [] ä¹Ÿä¼šè¢«æ·»åŠ åˆ°ç»“æœä¸­\r\n                seen.add(key)\r\n                result.push(branch)\r\n            }\r\n            // å·²è§è¿‡ï¼Œè·³è¿‡\r\n        }\r\n\r\n        // è¿”å›å»é‡åçš„ç»“æœï¼ˆå¯èƒ½åŒ…å«ç©ºåˆ†æ”¯ []ï¼‰\r\n        // è®°å½•æ€§èƒ½ç»Ÿè®¡\r\n        this.perfAnalyzer.endMethod(callId, branches.length, result.length)\r\n\r\n        return result\r\n    }\r\n\r\n    /**\r\n     * æˆªå–å¹¶å»é‡ï¼šå…ˆæˆªå–åˆ° firstKï¼Œå†å»é‡\r\n     *\r\n     * ä½¿ç”¨åœºæ™¯ï¼šç¬›å¡å°”ç§¯åè·¯å¾„å˜é•¿ï¼Œéœ€è¦æˆªå–\r\n     *\r\n     * ä¾‹å¦‚ï¼š[[a,b,c], [d,e,f]], firstK=2 â†’ [[a,b], [d,e]]\r\n     *\r\n     * âš ï¸ é‡è¦ï¼šç©ºåˆ†æ”¯å¤„ç†\r\n     * - ç©ºåˆ†æ”¯ [] slice(0, firstK) è¿˜æ˜¯ []\r\n     * - ç©ºåˆ†æ”¯ä¸ä¼šè¢«è¿‡æ»¤ï¼Œä¼šæ­£å¸¸å‚ä¸å»é‡\r\n     * - ä¾‹å¦‚ï¼š[[], [a,b,c]], firstK=2 â†’ [[], [a,b]]\r\n     *\r\n     * ğŸ”§ ä¼˜åŒ–ï¼šå¦‚æœ firstK=INFINITYï¼Œä¸éœ€è¦æˆªå–ï¼Œåªå»é‡\r\n     */\r\n    private truncateAndDeduplicate(branches: string[][], firstK: number): string[][] {\r\n        const callId = this.perfAnalyzer.startMethod('truncateAndDeduplicate')\r\n\r\n        // å¦‚æœ firstK ä¸º INFINITYï¼Œä¸éœ€è¦æˆªå–ï¼Œåªå»é‡\r\n        if (firstK === EXPANSION_LIMITS.INFINITY) {\r\n            const result = this.deduplicate(branches)\r\n            this.perfAnalyzer.endMethod(callId, branches.length, result.length)\r\n            return result\r\n        }\r\n\r\n        // æˆªå–æ¯ä¸ªåˆ†æ”¯åˆ° firstK\r\n        const truncated = branches.map(branch => branch.slice(0, firstK))\r\n\r\n        // å»é‡ï¼ˆæˆªå–åå¯èƒ½äº§ç”Ÿé‡å¤åˆ†æ”¯ï¼‰\r\n        const result = this.deduplicate(truncated)\r\n\r\n        // è®°å½•æ€§èƒ½ç»Ÿè®¡\r\n        this.perfAnalyzer.endMethod(callId, branches.length, result.length)\r\n\r\n        return result\r\n    }\r\n\r\n    /**\r\n     * å±•å¼€ Or èŠ‚ç‚¹\r\n     *\r\n     * æ ¸å¿ƒé€»è¾‘ï¼šåˆå¹¶æ‰€æœ‰åˆ†æ”¯çš„å±•å¼€ç»“æœ\r\n     *\r\n     * ä¾‹å¦‚ï¼šor(abc / de) firstK=2\r\n     *   â†’ abc å±•å¼€ä¸º [[a,b]]\r\n     *   â†’ de å±•å¼€ä¸º [[d,e]]\r\n     *   â†’ åˆå¹¶ä¸º [[a,b], [d,e]]\r\n     *\r\n     * âš ï¸ é‡è¦ï¼šç©ºåˆ†æ”¯åœ¨ or ä¸­çš„å¤„ç†\r\n     * - å¦‚æœæŸä¸ªåˆ†æ”¯æ˜¯ option/manyï¼Œå¯èƒ½åŒ…å«ç©ºåˆ†æ”¯ []\r\n     * - ä¾‹å¦‚ï¼šor(option(a) / b)\r\n     *   â†’ option(a) å±•å¼€ä¸º [[], [a]]\r\n     *   â†’ b å±•å¼€ä¸º [[b]]\r\n     *   â†’ åˆå¹¶ä¸º [[], [a], [b]]\r\n     * - ç©ºåˆ†æ”¯ä¼šè¢«æ­£å¸¸ä¿ç•™ï¼Œä¸ä¼šè¢«è¿‡æ»¤\r\n     *\r\n     * æ³¨æ„ï¼šä¸éœ€è¦æˆªå–ï¼Œå› ä¸ºå­èŠ‚ç‚¹å·²ä¿è¯é•¿åº¦â‰¤firstK\r\n     *\r\n     * ğŸ”´ å…³é”®ï¼šOr åˆ†æ”¯ä¸­çš„æ¯ä¸ªæ›¿ä»£ä¹Ÿæ˜¯\"ç¬¬ä¸€ä¸ªä½ç½®\"\r\n     * - åœ¨ PEG çš„é€‰æ‹©ä¸­ï¼Œæ¯ä¸ªåˆ†æ”¯éƒ½æ˜¯ç‹¬ç«‹çš„èµ·ç‚¹\r\n     * - Or åˆ†æ”¯å†…çš„ç¬¬ä¸€ä¸ªè§„åˆ™éœ€è¦æ£€æµ‹å·¦é€’å½’\r\n     * - ä¾‹å¦‚ï¼šA â†’ A '+' B | C\r\n     *   - ç¬¬ä¸€ä¸ªåˆ†æ”¯ A '+' B ä¸­ï¼ŒA åœ¨ç¬¬ä¸€ä¸ªä½ç½®ï¼Œéœ€è¦æ£€æµ‹\r\n     *   - ç¬¬äºŒä¸ªåˆ†æ”¯ C ä¸­ï¼ŒC ä¹Ÿåœ¨ç¬¬ä¸€ä¸ªä½ç½®\r\n     */\r\n    private expandOr(\r\n        alternatives: RuleNode[],\r\n        firstK: number,\r\n        curLevel: number,\r\n        maxLevel: number,\r\n        isFirstPosition: boolean = true  // ğŸ”´ Or åˆ†æ”¯ä¸­çš„ç¬¬ä¸€ä¸ªè§„åˆ™ä¹Ÿéœ€è¦æ£€æµ‹\r\n    ): string[][] {\r\n        const callId = this.perfAnalyzer.startMethod('expandOr')\r\n\r\n        // é˜²å¾¡ï¼šå¦‚æœ or æ²¡æœ‰åˆ†æ”¯\r\n        if (alternatives.length === 0) {\r\n            throw new Error('ç³»ç»Ÿé”™è¯¯ï¼šOr èŠ‚ç‚¹æ²¡æœ‰åˆ†æ”¯')\r\n        }\r\n\r\n        // å­˜å‚¨æ‰€æœ‰åˆ†æ”¯çš„å±•å¼€ç»“æœ\r\n        let result: string[][] = []\r\n\r\n        // éå† Or çš„æ¯ä¸ªé€‰æ‹©åˆ†æ”¯\r\n        for (const alt of alternatives) {\r\n            // ğŸ”´ å…³é”®ï¼šæ¯ä¸ª Or åˆ†æ”¯éƒ½æ˜¯ç‹¬ç«‹çš„èµ·ç‚¹ï¼Œç¬¬ä¸€ä¸ªä½ç½®çš„è§„åˆ™éœ€è¦æ£€æµ‹å·¦é€’å½’\r\n            const branches = this.expandNode(alt, firstK, curLevel, maxLevel, isFirstPosition)\r\n            result = result.concat(branches)\r\n        }\r\n\r\n        // é˜²å¾¡ï¼šå¦‚æœæ‰€æœ‰åˆ†æ”¯éƒ½æ²¡æœ‰ç»“æœ\r\n        if (result.length === 0) {\r\n            throw new Error('ç³»ç»Ÿé”™è¯¯ï¼šOr èŠ‚ç‚¹æ‰€æœ‰åˆ†æ”¯éƒ½æ²¡æœ‰ç»“æœ')\r\n        }\r\n\r\n        // åªå»é‡ï¼Œä¸æˆªå–ï¼ˆå­èŠ‚ç‚¹å·²ç»å¤„ç†è¿‡æˆªå–ï¼‰\r\n        const finalResult = this.deduplicate(result)\r\n\r\n        // è®°å½•æ€§èƒ½ç»Ÿè®¡\r\n        this.perfAnalyzer.endMethod(callId, alternatives.length, finalResult.length)\r\n\r\n        return finalResult\r\n    }\r\n\r\n\r\n    /**\r\n     * å±•å¼€ Option/Many èŠ‚ç‚¹\r\n     *\r\n     * option(X) = Îµ | Xï¼ˆ0æ¬¡æˆ–1æ¬¡ï¼‰\r\n     * many(X) = Îµ | X | XX | XXX...ï¼ˆ0æ¬¡æˆ–å¤šæ¬¡ï¼‰\r\n     *\r\n     * First é›†åˆï¼š\r\n     * First(option(X)) = {Îµ} âˆª First(X)\r\n     * First(many(X)) = {Îµ} âˆª First(X)\r\n     *\r\n     * ä¾‹å¦‚ï¼šoption(abc) firstK=2\r\n     *   â†’ abc å±•å¼€ä¸º [[a,b]]\r\n     *   â†’ ç»“æœä¸º [[], [a,b]]ï¼ˆç©ºåˆ†æ”¯ + å†…éƒ¨åˆ†æ”¯ï¼‰\r\n     *\r\n     * âš ï¸âš ï¸âš ï¸ å…³é”®ï¼šç©ºåˆ†æ”¯ [] çš„é‡è¦æ€§ âš ï¸âš ï¸âš ï¸\r\n     * - ç©ºåˆ†æ”¯ [] è¡¨ç¤º option/many å¯ä»¥è·³è¿‡ï¼ˆ0æ¬¡ï¼‰\r\n     * - ç©ºåˆ†æ”¯åœ¨åç»­å¤„ç†ä¸­ä¸ä¼šè¢«è¿‡æ»¤ï¼š\r\n     *   1. deduplicateï¼š[] join(',') = \"\"ï¼Œæ­£å¸¸å»é‡\r\n     *   2. cartesianProductï¼š[...seq, ...[]] = [...seq]ï¼Œæ­£å¸¸æ‹¼æ¥\r\n     *   3. truncateAndDeduplicateï¼š[] slice(0,k) = []ï¼Œæ­£å¸¸æˆªå–\r\n     * - ç©ºåˆ†æ”¯å¿…é¡»ä¿ç•™ï¼Œå¦åˆ™ option/many çš„è¯­ä¹‰å°±é”™äº†ï¼\r\n     *\r\n     * æ³¨æ„ï¼šä¸éœ€è¦æˆªå–ï¼Œå› ä¸ºå­èŠ‚ç‚¹å·²ä¿è¯é•¿åº¦â‰¤firstK\r\n     *\r\n     * ğŸ”´ å…³é”®ï¼šOption å†…çš„è§„åˆ™ä¹Ÿéœ€è¦æ£€æµ‹å·¦é€’å½’\r\n     * - è™½ç„¶ option(X) å¯ä»¥è·³è¿‡ï¼Œä½†å½“å†…éƒ¨æœ‰é€’å½’æ—¶ä¹Ÿæ˜¯å·¦é€’å½’\r\n     * - ä¾‹å¦‚ï¼šA â†’ option(A) B\r\n     *   - option(A) ä¸­çš„ A åœ¨ç¬¬ä¸€ä¸ªä½ç½®ï¼Œéœ€è¦æ£€æµ‹å·¦é€’å½’\r\n     */\r\n    private expandOption(\r\n        node: SequenceNode,\r\n        firstK: number,\r\n        curLevel: number,\r\n        maxLevel: number,\r\n        isFirstPosition: boolean = true  // ğŸ”´ Option å†…çš„ç¬¬ä¸€ä¸ªè§„åˆ™ä¹Ÿéœ€è¦æ£€æµ‹\r\n    ): string[][] {\r\n        const callId = this.perfAnalyzer.startMethod('expandOption')\r\n\r\n        // é€’å½’å±•å¼€å†…éƒ¨èŠ‚ç‚¹ï¼Œä¼ é€’æ‰€æœ‰å¿…éœ€å‚æ•°\r\n        const innerBranches = this.expandNode(node, firstK, curLevel, maxLevel, isFirstPosition)\r\n\r\n        // âš ï¸âš ï¸âš ï¸ å…³é”®ï¼šæ·»åŠ ç©ºåˆ†æ”¯ [] è¡¨ç¤ºå¯ä»¥è·³è¿‡ï¼ˆ0æ¬¡ï¼‰\r\n        // ç©ºåˆ†æ”¯å¿…é¡»åœ¨ç¬¬ä¸€ä¸ªä½ç½®ï¼Œè¡¨ç¤ºä¼˜å…ˆåŒ¹é…ç©ºï¼ˆPEG é¡ºåºé€‰æ‹©ï¼‰\r\n        const result = [[], ...innerBranches]\r\n\r\n        // åªå»é‡ï¼Œä¸æˆªå–ï¼ˆå­èŠ‚ç‚¹å·²ç»å¤„ç†è¿‡æˆªå–ï¼‰\r\n        const finalResult = this.deduplicate(result)\r\n\r\n        // è®°å½•æ€§èƒ½ç»Ÿè®¡\r\n        this.perfAnalyzer.endMethod(callId, undefined, finalResult.length)\r\n\r\n        return finalResult\r\n    }\r\n\r\n    /**\r\n     * å±•å¼€ AtLeastOne èŠ‚ç‚¹\r\n     *\r\n     * atLeastOne(X) = X | XX | XXX...ï¼ˆè‡³å°‘1æ¬¡ï¼‰\r\n     *\r\n     * First é›†åˆï¼š\r\n     * First(atLeastOne(X)) = First(X) âˆª First(XX)\r\n     *\r\n     * ä¾‹å¦‚ï¼šatLeastOne(ab) firstK=3\r\n     *   â†’ ab å±•å¼€ä¸º [[a,b]]\r\n     *   â†’ 1æ¬¡ï¼š[[a,b]]\r\n     *   â†’ 2æ¬¡ï¼š[[a,b,a,b]] æˆªå–åˆ°3 â†’ [[a,b,a]]\r\n     *   â†’ ç»“æœä¸º [[a,b], [a,b,a]]\r\n     *\r\n     * âš ï¸ é‡è¦ï¼šç©ºåˆ†æ”¯è¯´æ˜\r\n     * - atLeastOne è‡³å°‘æ‰§è¡Œ1æ¬¡ï¼Œä¸ä¼šäº§ç”Ÿç©ºåˆ†æ”¯ []\r\n     * - ä¸ option/many ä¸åŒï¼ŒatLeastOne çš„ç»“æœä¸åŒ…å« []\r\n     * - ä½†å¦‚æœå†…éƒ¨èŠ‚ç‚¹åŒ…å«ç©ºåˆ†æ”¯ï¼ˆæ¥è‡ªåµŒå¥—çš„ option/manyï¼‰ï¼š\r\n     *   ä¾‹å¦‚ï¼šatLeastOne(option(a))\r\n     *   â†’ option(a) å±•å¼€ä¸º [[], [a]]\r\n     *   â†’ 1æ¬¡ï¼š[[], [a]]\r\n     *   â†’ 2æ¬¡ï¼š[[], [a]] Ã— 2 â†’ [[], [a]]ï¼ˆç©ºåˆ†æ”¯æ‹¼æ¥è¿˜æ˜¯ç©ºåˆ†æ”¯ï¼‰\r\n     *   â†’ ç»“æœä¸º [[], [a]]\r\n     * - ç©ºåˆ†æ”¯ä¼šè¢«æ­£å¸¸ä¿ç•™ï¼Œä¸ä¼šè¢«è¿‡æ»¤\r\n     *\r\n     * æ³¨æ„ï¼šdoubleBranches éœ€è¦å†…éƒ¨æˆªå–ï¼Œå› ä¸ºæ‹¼æ¥åä¼šè¶…è¿‡ firstK\r\n     *\r\n     * ğŸ”´ å…³é”®ï¼šAtLeastOne å†…çš„è§„åˆ™ä¹Ÿéœ€è¦æ£€æµ‹å·¦é€’å½’\r\n     */\r\n    private expandAtLeastOne(\r\n        node: SequenceNode,\r\n        firstK: number,\r\n        curLevel: number,\r\n        maxLevel: number,\r\n        isFirstPosition: boolean = true  // ğŸ”´ AtLeastOne å†…çš„ç¬¬ä¸€ä¸ªè§„åˆ™ä¹Ÿéœ€è¦æ£€æµ‹\r\n    ): string[][] {\r\n        const callId = this.perfAnalyzer.startMethod('expandAtLeastOne')\r\n\r\n        // é€’å½’å±•å¼€å†…éƒ¨èŠ‚ç‚¹ï¼ˆ1æ¬¡çš„æƒ…å†µï¼‰ï¼Œä¼ é€’æ‰€æœ‰å¿…éœ€å‚æ•°\r\n        const innerBranches = this.expandNode(node, firstK, curLevel, maxLevel, isFirstPosition)\r\n\r\n        // ç”Ÿæˆ doubleBranchesï¼ˆ2æ¬¡çš„æƒ…å†µï¼‰\r\n        const doubleBranches = innerBranches.map(branch => {\r\n            // æ‹¼æ¥ä¸¤æ¬¡ï¼ˆä¾‹å¦‚ï¼š[a,b] â†’ [a,b,a,b]ï¼‰\r\n            // âš ï¸ å¦‚æœ branch æ˜¯ç©ºåˆ†æ”¯ []ï¼Œåˆ™ [...[], ...[]] = []\r\n            const doubled = [...branch, ...branch]\r\n            // æˆªå–åˆ° firstKï¼ˆé˜²æ­¢è¶…é•¿ï¼‰\r\n            // âš ï¸ ç©ºåˆ†æ”¯ [] slice(0, firstK) è¿˜æ˜¯ []\r\n            return doubled.slice(0, firstK)\r\n        })\r\n\r\n        // åˆå¹¶1æ¬¡å’Œ2æ¬¡çš„ç»“æœï¼ˆå¯èƒ½åŒ…å«ç©ºåˆ†æ”¯ []ï¼‰\r\n        const result = [...innerBranches, ...doubleBranches]\r\n\r\n        // åªå»é‡ï¼Œä¸å†æˆªå–ï¼ˆå·²ç»åœ¨å†…éƒ¨æˆªå–è¿‡äº†ï¼‰\r\n        // âš ï¸ deduplicate ä¸ä¼šè¿‡æ»¤ç©ºåˆ†æ”¯ []\r\n        const finalResult = this.deduplicate(result)\r\n\r\n        // è®°å½•æ€§èƒ½ç»Ÿè®¡\r\n        this.perfAnalyzer.endMethod(callId, undefined, finalResult.length)\r\n\r\n        return finalResult\r\n    }\r\n\r\n    /**\r\n     * ç”Ÿæˆå·¦é€’å½’ä¿®å¤å»ºè®®\r\n     *\r\n     * @param ruleName è§„åˆ™å\r\n     * @param node è§„åˆ™èŠ‚ç‚¹\r\n     * @param firstSet First é›†åˆ\r\n     * @returns ä¿®å¤å»ºè®®\r\n     */\r\n    private getLeftRecursionSuggestion(\r\n        ruleName: string,\r\n        node: RuleNode,\r\n        firstSet: Set<string>\r\n    ): string {\r\n        // åˆ†æè§„åˆ™ç»“æ„ï¼Œæä¾›å…·ä½“å»ºè®®\r\n        if (node.type === 'or') {\r\n            return `PEG ä¸æ”¯æŒå·¦é€’å½’ï¼è¯·å°†å·¦é€’å½’æ”¹ä¸ºå³é€’å½’ï¼Œæˆ–ä½¿ç”¨ Many/AtLeastOneã€‚\r\n\r\nç¤ºä¾‹ï¼š\r\n  âŒ å·¦é€’å½’ï¼ˆéæ³•ï¼‰ï¼š\r\n     ${ruleName} â†’ ${ruleName} '+' Term | Term\r\n\r\n  âœ… å³é€’å½’ï¼ˆåˆæ³•ï¼‰ï¼š\r\n     ${ruleName} â†’ Term ('+' Term)*\r\n\r\n  æˆ–ä½¿ç”¨ Manyï¼š\r\n     ${ruleName} â†’ Term\r\n     ${ruleName}Suffix â†’ '+' Term\r\n     å®Œæ•´å½¢å¼ â†’ ${ruleName} ${ruleName}Suffix*\r\n\r\nFirst(${ruleName}) = {${Array.from(firstSet).slice(0, 5).join(', ')}${firstSet.size > 5 ? ', ...' : ''}}\r\nåŒ…å« ${ruleName} æœ¬èº«ï¼Œè¯´æ˜å­˜åœ¨å·¦é€’å½’ã€‚`\r\n        }\r\n\r\n        return `PEG ä¸æ”¯æŒå·¦é€’å½’ï¼è¯·é‡æ„è¯­æ³•ä»¥æ¶ˆé™¤å·¦é€’å½’ã€‚\r\n\r\nFirst(${ruleName}) = {${Array.from(firstSet).slice(0, 5).join(', ')}${firstSet.size > 5 ? ', ...' : ''}}\r\nåŒ…å« ${ruleName} æœ¬èº«ï¼Œè¯´æ˜å­˜åœ¨å·¦é€’å½’ã€‚`\r\n    }\r\n\r\n}\r\n\r\n","/**\r\n * SubhutiConflictDetector - å†²çªæ£€æµ‹å™¨\r\n * TODO: å¾…å®ç°\r\n */\r\nexport class SubhutiConflictDetector {\r\n    // å ä½å®ç°\r\n}\r\n","/**\r\n * Subhuti Validation Debugger - è¯­æ³•éªŒè¯è°ƒè¯•å™¨ï¼ˆå®Œå…¨æ— ä¾µå…¥ç‰ˆï¼‰\r\n * \r\n * è®¾è®¡ç†å¿µï¼š\r\n * - ç±»ä¼¼ SubhutiTraceDebuggerï¼Œæä¾›å®Œæ•´çš„éªŒè¯è¿‡ç¨‹è¿½è¸ª\r\n * - å®Œå…¨ç‹¬ç«‹ï¼šä¸ä¿®æ”¹ Parser æ ¸å¿ƒä»£ç \r\n * - ä¸¤ç§ä½¿ç”¨æ–¹å¼ï¼šç‹¬ç«‹è°ƒç”¨ æˆ– é’©å­æ¨¡å¼\r\n * \r\n * åŠŸèƒ½ï¼š\r\n * - âœ… è§„åˆ™æ”¶é›†è¿½è¸ªï¼ˆå“ªäº›è§„åˆ™è¢«æ”¶é›†ï¼‰\r\n * - âœ… è·¯å¾„è®¡ç®—è¿½è¸ªï¼ˆæ¯ä¸ªè§„åˆ™ç”Ÿæˆäº†å“ªäº›è·¯å¾„ï¼‰\r\n * - âœ… å†²çªæ£€æµ‹è¿½è¸ªï¼ˆå“ªäº›åˆ†æ”¯è¢«æ¯”è¾ƒï¼‰\r\n * - âœ… è·¯å¾„å¯è§†åŒ–ï¼ˆæ ‘å½¢ç»“æ„ï¼‰\r\n * - âœ… ç»Ÿè®¡ä¿¡æ¯ï¼ˆè§„åˆ™æ•°ã€è·¯å¾„æ•°ã€è€—æ—¶ç­‰ï¼‰\r\n * - âœ… é”™è¯¯è¯¦ç»†è¯´æ˜ï¼ˆä¸ºä»€ä¹ˆå†²çªã€å¦‚ä½•ä¿®å¤ï¼‰\r\n * \r\n * ä½¿ç”¨æ–¹å¼1ï¼šç‹¬ç«‹è°ƒç”¨ï¼ˆå®Œå…¨æ— ä¾µå…¥ï¼‰\r\n * ```typescript\r\n * const parser = new MyParser()\r\n * const debugger = new SubhutiValidationDebugger()\r\n * \r\n * // æ‰§è¡Œè°ƒè¯•ï¼ˆè‡ªåŠ¨è¾“å‡ºè¯¦ç»†æŠ¥å‘Šï¼‰\r\n * const result = debugger.debug(parser)\r\n * ```\r\n * \r\n * ä½¿ç”¨æ–¹å¼2ï¼šé’©å­æ¨¡å¼ï¼ˆè½»é‡ä¾µå…¥ï¼Œéœ€è¦ Parser ä¼ é€’ debug é€‰é¡¹ï¼‰\r\n * ```typescript\r\n * const parser = new MyParser()\r\n * const debugger = new SubhutiValidationDebugger()\r\n * \r\n * // Parser ä¼šåœ¨éªŒè¯å®Œæˆåè°ƒç”¨ debugger.onValidationComplete()\r\n * const result = parser.validateGrammar({ debug: debugger })\r\n * ```\r\n * \r\n * @version 1.0.0\r\n * @date 2025-11-06\r\n */\r\n\r\nimport type { SubhutiGrammarAnalyzer } from \"./SubhutiGrammarAnalyzer\"\r\nimport type { SubhutiRuleCollector } from \"./SubhutiRuleCollector\"\r\nimport type {\r\n    ValidationError,\r\n    RuleNode,\r\n    Path\r\n} from \"./SubhutiValidationError\"\r\n\r\n// ============================================\r\n// ç±»å‹å®šä¹‰\r\n// ============================================\r\n\r\n/**\r\n * è°ƒè¯•äº‹ä»¶ç±»å‹\r\n */\r\nexport interface DebugEvent {\r\n    type: 'rule-collect' | 'path-compute' | 'conflict-detect' | 'error-found'\r\n    timestamp: number\r\n    data: any\r\n}\r\n\r\n/**\r\n * è§„åˆ™ç»Ÿè®¡ä¿¡æ¯\r\n */\r\nexport interface RuleDebugInfo {\r\n    ruleName: string\r\n    /** AST èŠ‚ç‚¹æ•°é‡ */\r\n    astNodeCount: number\r\n    /** ç”Ÿæˆçš„è·¯å¾„æ•°é‡ */\r\n    pathCount: number\r\n    /** æœ€é•¿è·¯å¾„é•¿åº¦ */\r\n    maxPathLength: number\r\n    /** è·¯å¾„è®¡ç®—è€—æ—¶ï¼ˆmsï¼‰ */\r\n    pathComputeTime: number\r\n    /** æ˜¯å¦æœ‰å†²çª */\r\n    hasConflict: boolean\r\n}\r\n\r\n/**\r\n * å†²çªè¯¦ç»†ä¿¡æ¯\r\n */\r\nexport interface ConflictDebugInfo {\r\n    error: ValidationError\r\n    /** å†²çªçš„å…·ä½“ä½ç½®ï¼ˆç¬¬å‡ ä¸ªtokenï¼‰ */\r\n    conflictPosition: number\r\n    /** åˆ†æ”¯Açš„å®Œæ•´è·¯å¾„åˆ—è¡¨ */\r\n    branchAPaths: Path[]\r\n    /** åˆ†æ”¯Bçš„å®Œæ•´è·¯å¾„åˆ—è¡¨ */\r\n    branchBPaths: Path[]\r\n    /** è·¯å¾„å·®å¼‚åˆ†æ */\r\n    pathDiff: {\r\n        common: string[]  // å…¬å…±éƒ¨åˆ†\r\n        onlyA: string[]   // åªåœ¨Aä¸­\r\n        onlyB: string[]   // åªåœ¨Bä¸­\r\n    }\r\n}\r\n\r\n// ============================================\r\n// SubhutiValidationDebugger - éªŒè¯è°ƒè¯•å™¨\r\n// ============================================\r\n\r\nexport class SubhutiValidationDebugger {\r\n    // ========================================\r\n    // è¿½è¸ªæ•°æ®\r\n    // ========================================\r\n    private events: DebugEvent[] = []\r\n    private ruleInfos = new Map<string, RuleDebugInfo>()\r\n    private conflictInfos: ConflictDebugInfo[] = []\r\n    \r\n    // ========================================\r\n    // ç»Ÿè®¡æ•°æ®\r\n    // ========================================\r\n    private stats = {\r\n        totalRules: 0,\r\n        collectedRules: 0,\r\n        totalPaths: 0,\r\n        totalConflicts: 0,\r\n        fatalErrors: 0,\r\n        warnings: 0,\r\n        collectTime: 0,\r\n        analyzeTime: 0,\r\n        detectTime: 0,\r\n        totalTime: 0\r\n    }\r\n    \r\n    // ========================================\r\n    // é…ç½®é€‰é¡¹\r\n    // ========================================\r\n    private options = {\r\n        /** æ˜¯å¦è¾“å‡ºè§„åˆ™æ”¶é›†è¿‡ç¨‹ */\r\n        traceCollect: true,\r\n        /** æ˜¯å¦è¾“å‡ºè·¯å¾„è®¡ç®—è¿‡ç¨‹ */\r\n        traceCompute: true,\r\n        /** æ˜¯å¦è¾“å‡ºå†²çªæ£€æµ‹è¿‡ç¨‹ */\r\n        traceDetect: true,\r\n        /** æ˜¯å¦æ˜¾ç¤ºè·¯å¾„è¯¦æƒ… */\r\n        showPaths: true,\r\n        /** è·¯å¾„æ˜¾ç¤ºæ•°é‡ä¸Šé™ */\r\n        maxPathsToShow: 10,\r\n        /** æ˜¯å¦è‡ªåŠ¨è¾“å‡ºæŠ¥å‘Š */\r\n        autoOutput: true\r\n    }\r\n    \r\n    /**\r\n     * é…ç½®è°ƒè¯•é€‰é¡¹\r\n     */\r\n    configure(options: Partial<typeof this.options>): this {\r\n        Object.assign(this.options, options)\r\n        return this\r\n    }\r\n    \r\n    // ========================================\r\n    // å…¬å¼€ API\r\n    // ========================================\r\n    \r\n    /**\r\n     * é’©å­æ–¹æ³•ï¼šéªŒè¯å®Œæˆåè°ƒç”¨ï¼ˆè½»é‡ä¾µå…¥æ¨¡å¼ï¼‰\r\n     * \r\n     * Parser ä¼šåœ¨ validateGrammar() å®Œæˆåè°ƒç”¨æ­¤æ–¹æ³•\r\n     * \r\n     * @param ruleASTs æ”¶é›†åˆ°çš„è§„åˆ™ AST\r\n     * @param errors æ£€æµ‹åˆ°çš„é”™è¯¯\r\n     */\r\n    onValidationComplete(ruleASTs: Map<string, RuleNode>, errors: ValidationError[]): void {\r\n        // è®°å½•æ•°æ®\r\n        this.stats.collectedRules = ruleASTs.size\r\n        this.stats.totalRules = ruleASTs.size\r\n        this.stats.totalConflicts = errors.length\r\n        this.stats.fatalErrors = errors.filter(e => e.level === 'FATAL').length\r\n        this.stats.warnings = errors.filter(e => e.level === 'ERROR').length\r\n        \r\n        // åˆ›å»ºè¯­æ³•åˆ†æå™¨å¹¶è®¡ç®—è·¯å¾„\r\n        const { SubhutiGrammarAnalyzer } = require('./SubhutiGrammarAnalyzer')\r\n        const analyzer = new SubhutiGrammarAnalyzer(ruleASTs, { maxPaths: 100 })\r\n        \r\n        let totalPaths = 0\r\n        \r\n        // æ”¶é›†è§„åˆ™ä¿¡æ¯å¹¶è®¡ç®—è·¯å¾„\r\n        for (const [ruleName, ast] of ruleASTs) {\r\n            const nodeCount = this.countASTNodes(ast)\r\n            const paths = analyzer.computePaths(ruleName)\r\n            totalPaths += paths.length\r\n            \r\n            this.ruleInfos.set(ruleName, {\r\n                ruleName,\r\n                astNodeCount: nodeCount,\r\n                pathCount: paths.length,\r\n                maxPathLength: Math.max(...paths.map(p => this.countTokens(p)), 0),\r\n                pathComputeTime: 0,\r\n                hasConflict: false\r\n            })\r\n        }\r\n        \r\n        this.stats.totalPaths = totalPaths\r\n        \r\n        // æ ‡è®°æœ‰å†²çªçš„è§„åˆ™\r\n        for (const error of errors) {\r\n            const info = this.ruleInfos.get(error.ruleName)\r\n            if (info) {\r\n                info.hasConflict = true\r\n            }\r\n        }\r\n        \r\n        // è¾“å‡ºç®€åŒ–æŠ¥å‘Š\r\n        console.log('\\n' + '='.repeat(80))\r\n        console.log('ğŸ” Subhuti Grammar Validation Debug')\r\n        console.log('='.repeat(80))\r\n        console.log(`\\nâœ“ æ”¶é›†äº† ${ruleASTs.size} ä¸ªè§„åˆ™`)\r\n        console.log(`âœ“ è®¡ç®—äº† ${totalPaths.toLocaleString()} æ¡è·¯å¾„`)\r\n        console.log(`âœ“ å‘ç° ${errors.length} ä¸ªå†²çª`)\r\n        \r\n        if (errors.length > 0) {\r\n            this.outputReport(errors)\r\n        }\r\n        \r\n        console.log('='.repeat(80))\r\n    }\r\n    \r\n    /**\r\n     * è°ƒè¯•å®Œæ•´çš„éªŒè¯æµç¨‹ï¼ˆç‹¬ç«‹è°ƒç”¨ï¼Œå®Œå…¨æ— ä¾µå…¥ï¼‰\r\n     * \r\n     * @param parser Parser å®ä¾‹\r\n     * @param validateOptions éªŒè¯é€‰é¡¹\r\n     * @returns éªŒè¯ç»“æœ\r\n     */\r\n    debug(parser: any, validateOptions?: ValidateOptions): { success: boolean; errors: ValidationError[] } {\r\n        const startTime = performance.now()\r\n        \r\n        console.log('\\n' + '='.repeat(80))\r\n        console.log('ğŸ” Subhuti Grammar Validation Debug')\r\n        console.log('='.repeat(80))\r\n        \r\n        try {\r\n            // æ­¥éª¤1ï¼šè§„åˆ™æ”¶é›†\r\n            console.log('\\nã€æ­¥éª¤ 1ï¼šè§„åˆ™æ”¶é›†ã€‘')\r\n            console.log('â”€'.repeat(80))\r\n            const { SubhutiRuleCollector } = require('./SubhutiRuleCollector')\r\n            const collector = new SubhutiRuleCollector()\r\n            \r\n            const collectStart = performance.now()\r\n            const ruleASTs = this.instrumentCollector(collector, parser)\r\n            this.stats.collectTime = performance.now() - collectStart\r\n            \r\n            console.log(`âœ“ æ”¶é›†å®Œæˆï¼š${ruleASTs.size} ä¸ªè§„åˆ™ï¼Œè€—æ—¶ ${this.stats.collectTime.toFixed(2)}ms`)\r\n            \r\n            // æ­¥éª¤2ï¼šè·¯å¾„è®¡ç®—\r\n            console.log('\\nã€æ­¥éª¤ 2ï¼šè·¯å¾„è®¡ç®—ã€‘')\r\n            console.log('â”€'.repeat(80))\r\n            const { SubhutiGrammarAnalyzer } = require('./SubhutiGrammarAnalyzer')\r\n            const analyzer = new SubhutiGrammarAnalyzer(ruleASTs, {\r\n                maxPaths: validateOptions?.maxPaths || 100\r\n            })\r\n            \r\n            const analyzeStart = performance.now()\r\n            this.instrumentAnalyzer(analyzer, ruleASTs)\r\n            this.stats.analyzeTime = performance.now() - analyzeStart\r\n            \r\n            console.log(`âœ“ è®¡ç®—å®Œæˆï¼š${this.stats.totalPaths} æ¡è·¯å¾„ï¼Œè€—æ—¶ ${this.stats.analyzeTime.toFixed(2)}ms`)\r\n            \r\n            // æ­¥éª¤3ï¼šå†²çªæ£€æµ‹\r\n            console.log('\\nã€æ­¥éª¤ 3ï¼šå†²çªæ£€æµ‹ã€‘')\r\n            console.log('â”€'.repeat(80))\r\n            const { SubhutiConflictDetector } = require('./SubhutiConflictDetector')\r\n            const detector = new SubhutiConflictDetector(analyzer, ruleASTs)\r\n            \r\n            const detectStart = performance.now()\r\n            const errors = this.instrumentDetector(detector, ruleASTs)\r\n            this.stats.detectTime = performance.now() - detectStart\r\n            \r\n            this.stats.totalConflicts = errors.length\r\n            this.stats.fatalErrors = errors.filter(e => e.level === 'FATAL').length\r\n            this.stats.warnings = errors.filter(e => e.level === 'ERROR').length\r\n            \r\n            console.log(`âœ“ æ£€æµ‹å®Œæˆï¼š${errors.length} ä¸ªå†²çªï¼Œè€—æ—¶ ${this.stats.detectTime.toFixed(2)}ms`)\r\n            \r\n            // æ€»è€—æ—¶\r\n            this.stats.totalTime = performance.now() - startTime\r\n            \r\n            // è‡ªåŠ¨è¾“å‡ºæŠ¥å‘Š\r\n            if (this.options.autoOutput) {\r\n                this.outputReport(errors)\r\n            }\r\n            \r\n            // è¿”å›éªŒè¯ç»“æœ\r\n            return {\r\n                success: errors.length === 0,\r\n                errors: errors\r\n            }\r\n        } catch (error: any) {\r\n            console.error('\\nâŒ éªŒè¯è°ƒè¯•å¤±è´¥:', error.message)\r\n            throw error\r\n        }\r\n    }\r\n    \r\n    // ========================================\r\n    // è¿½è¸ªæ–¹æ³•ï¼ˆæ³¨å…¥åˆ°å„ä¸ªç»„ä»¶ï¼‰\r\n    // ========================================\r\n    \r\n    /**\r\n     * æ³¨å…¥è§„åˆ™æ”¶é›†å™¨ï¼ˆè¿½è¸ªæ”¶é›†è¿‡ç¨‹ï¼‰\r\n     */\r\n    private instrumentCollector(collector: any, parser: any): Map<string, RuleNode> {\r\n        if (this.options.traceCollect) {\r\n            console.log('å¼€å§‹æ”¶é›†è§„åˆ™...\\n')\r\n        }\r\n        \r\n        const ruleASTs = collector.collectRules(parser)\r\n        \r\n        this.stats.collectedRules = ruleASTs.size\r\n        this.stats.totalRules = ruleASTs.size\r\n        \r\n        if (this.options.traceCollect) {\r\n            console.log('\\næ”¶é›†åˆ°çš„è§„åˆ™ï¼š')\r\n            let index = 1\r\n            for (const [ruleName, ast] of ruleASTs) {\r\n                const nodeCount = this.countASTNodes(ast)\r\n                console.log(`  ${index}. ${ruleName} (${nodeCount} ä¸ªèŠ‚ç‚¹)`)\r\n                \r\n                // è®°å½•è§„åˆ™ä¿¡æ¯\r\n                this.ruleInfos.set(ruleName, {\r\n                    ruleName,\r\n                    astNodeCount: nodeCount,\r\n                    pathCount: 0,\r\n                    maxPathLength: 0,\r\n                    pathComputeTime: 0,\r\n                    hasConflict: false\r\n                })\r\n                \r\n                index++\r\n            }\r\n        }\r\n        \r\n        return ruleASTs\r\n    }\r\n    \r\n    /**\r\n     * æ³¨å…¥è¯­æ³•åˆ†æå™¨ï¼ˆè¿½è¸ªè·¯å¾„è®¡ç®—ï¼‰\r\n     */\r\n    private instrumentAnalyzer(analyzer: SubhutiGrammarAnalyzer, ruleASTs: Map<string, RuleNode>): void {\r\n        if (this.options.traceCompute) {\r\n            console.log('å¼€å§‹è®¡ç®—è·¯å¾„...\\n')\r\n        }\r\n        \r\n        let totalPaths = 0\r\n        \r\n        for (const ruleName of ruleASTs.keys()) {\r\n            const start = performance.now()\r\n            const paths = analyzer.computePaths(ruleName)\r\n            const duration = performance.now() - start\r\n            \r\n            totalPaths += paths.length\r\n            \r\n            // æ›´æ–°è§„åˆ™ä¿¡æ¯\r\n            const info = this.ruleInfos.get(ruleName)\r\n            if (info) {\r\n                info.pathCount = paths.length\r\n                info.maxPathLength = Math.max(...paths.map(p => this.countTokens(p)))\r\n                info.pathComputeTime = duration\r\n            }\r\n            \r\n            if (this.options.traceCompute) {\r\n                console.log(\r\n                    `  ${ruleName}: ${paths.length} æ¡è·¯å¾„ ` +\r\n                    `(æœ€é•¿ ${this.countTokens(paths[0] || '')} tokens, ${duration.toFixed(2)}ms)`\r\n                )\r\n                \r\n                // æ˜¾ç¤ºå‰å‡ æ¡è·¯å¾„\r\n                if (this.options.showPaths && paths.length > 0) {\r\n                    const showCount = Math.min(paths.length, this.options.maxPathsToShow)\r\n                    for (let i = 0; i < showCount; i++) {\r\n                        const path = paths[i]\r\n                        const tokens = path === '' ? '(ç©ºè·¯å¾„)' : path.replace(/,/g, ' â†’ ').slice(0, -3)\r\n                        console.log(`    [${i}] ${tokens}`)\r\n                    }\r\n                    \r\n                    if (paths.length > showCount) {\r\n                        console.log(`    ... è¿˜æœ‰ ${paths.length - showCount} æ¡è·¯å¾„`)\r\n                    }\r\n                    console.log('')\r\n                }\r\n            }\r\n        }\r\n        \r\n        this.stats.totalPaths = totalPaths\r\n    }\r\n    \r\n    /**\r\n     * æ³¨å…¥å†²çªæ£€æµ‹å™¨ï¼ˆè¿½è¸ªæ£€æµ‹è¿‡ç¨‹ï¼‰\r\n     */\r\n    private instrumentDetector(detector: any, ruleASTs: Map<string, RuleNode>): ValidationError[] {\r\n        if (this.options.traceDetect) {\r\n            console.log('å¼€å§‹æ£€æµ‹å†²çª...\\n')\r\n        }\r\n        \r\n        const errors = detector.detectAllConflicts()\r\n        \r\n        if (this.options.traceDetect) {\r\n            if (errors.length === 0) {\r\n                console.log('  âœ“ æœªå‘ç°å†²çª')\r\n            } else {\r\n                console.log(`  âœ— å‘ç° ${errors.length} ä¸ªå†²çª:\\n`)\r\n                \r\n                errors.forEach((error: ValidationError, index: number) => {\r\n                    console.log(`  [${index + 1}] ${error.ruleName} - ${error.message}`)\r\n                    console.log(`      ç±»å‹: ${error.type}`)\r\n                    console.log(`      åˆ†æ”¯: [${error.branchIndices.join(', ')}]`)\r\n                    console.log(`      è·¯å¾„A: ${this.formatPath(error.conflictPaths.pathA)}`)\r\n                    console.log(`      è·¯å¾„B: ${this.formatPath(error.conflictPaths.pathB)}`)\r\n                    console.log(`      å»ºè®®: ${error.suggestion}`)\r\n                    console.log('')\r\n                    \r\n                    // æ ‡è®°è§„åˆ™æœ‰å†²çª\r\n                    const info = this.ruleInfos.get(error.ruleName)\r\n                    if (info) {\r\n                        info.hasConflict = true\r\n                    }\r\n                })\r\n            }\r\n        }\r\n        \r\n        return errors\r\n    }\r\n    \r\n    // ========================================\r\n    // è¾“å‡ºæŠ¥å‘Š\r\n    // ========================================\r\n    \r\n    /**\r\n     * è¾“å‡ºå®Œæ•´è°ƒè¯•æŠ¥å‘Š\r\n     */\r\n    private outputReport(errors: ValidationError[]): void {\r\n        console.log('\\n' + '='.repeat(80))\r\n        console.log('ğŸ“Š éªŒè¯è°ƒè¯•æŠ¥å‘Š')\r\n        console.log('='.repeat(80))\r\n        \r\n        // ========================================\r\n        // ç¬¬ä¸€éƒ¨åˆ†ï¼šæ€»ä½“ç»Ÿè®¡\r\n        // ========================================\r\n        console.log('\\nã€ç¬¬ä¸€éƒ¨åˆ†ï¼šæ€»ä½“ç»Ÿè®¡ã€‘')\r\n        console.log('â”€'.repeat(80))\r\n        console.log('\\nâ±ï¸  æ€§èƒ½ç»Ÿè®¡')\r\n        console.log(`  æ€»è€—æ—¶: ${this.stats.totalTime.toFixed(2)}ms`)\r\n        console.log(`    - è§„åˆ™æ”¶é›†: ${this.stats.collectTime.toFixed(2)}ms (${(this.stats.collectTime / this.stats.totalTime * 100).toFixed(1)}%)`)\r\n        console.log(`    - è·¯å¾„è®¡ç®—: ${this.stats.analyzeTime.toFixed(2)}ms (${(this.stats.analyzeTime / this.stats.totalTime * 100).toFixed(1)}%)`)\r\n        console.log(`    - å†²çªæ£€æµ‹: ${this.stats.detectTime.toFixed(2)}ms (${(this.stats.detectTime / this.stats.totalTime * 100).toFixed(1)}%)`)\r\n        \r\n        console.log('\\nğŸ“‹ è§„åˆ™ç»Ÿè®¡')\r\n        console.log(`  æ€»è§„åˆ™æ•°: ${this.stats.totalRules}`)\r\n        console.log(`  å·²æ”¶é›†: ${this.stats.collectedRules}`)\r\n        console.log(`  æ€»è·¯å¾„æ•°: ${this.stats.totalPaths.toLocaleString()}`)\r\n        console.log(`  å¹³å‡è·¯å¾„/è§„åˆ™: ${(this.stats.totalPaths / this.stats.collectedRules).toFixed(1)}`)\r\n        \r\n        console.log('\\nâš ï¸  å†²çªç»Ÿè®¡')\r\n        console.log(`  æ€»å†²çªæ•°: ${this.stats.totalConflicts}`)\r\n        console.log(`  è‡´å‘½é”™è¯¯: ${this.stats.fatalErrors}`)\r\n        console.log(`  è­¦å‘Š: ${this.stats.warnings}`)\r\n        \r\n        // ========================================\r\n        // ç¬¬äºŒéƒ¨åˆ†ï¼šè§„åˆ™è¯¦æƒ…\r\n        // ========================================\r\n        console.log('\\nã€ç¬¬äºŒéƒ¨åˆ†ï¼šè§„åˆ™è¯¦æƒ…ã€‘')\r\n        console.log('â”€'.repeat(80))\r\n        \r\n        // Top 5 è·¯å¾„æœ€å¤šçš„è§„åˆ™\r\n        const topPathRules = Array.from(this.ruleInfos.values())\r\n            .sort((a, b) => b.pathCount - a.pathCount)\r\n            .slice(0, 5)\r\n        \r\n        console.log('\\nğŸ“ˆ è·¯å¾„æœ€å¤šçš„è§„åˆ™ï¼ˆTop 5ï¼‰:')\r\n        topPathRules.forEach((info, i) => {\r\n            const conflictMark = info.hasConflict ? 'âš ï¸ ' : 'âœ“ '\r\n            console.log(\r\n                `  ${i + 1}. ${conflictMark}${info.ruleName}: ${info.pathCount.toLocaleString()} æ¡è·¯å¾„ ` +\r\n                `(æœ€é•¿ ${info.maxPathLength} tokens, ${info.pathComputeTime.toFixed(2)}ms)`\r\n            )\r\n        })\r\n        \r\n        // æœ‰å†²çªçš„è§„åˆ™\r\n        const conflictRules = Array.from(this.ruleInfos.values())\r\n            .filter(info => info.hasConflict)\r\n        \r\n        if (conflictRules.length > 0) {\r\n            console.log('\\nâš ï¸  æœ‰å†²çªçš„è§„åˆ™:')\r\n            conflictRules.forEach((info, i) => {\r\n                console.log(\r\n                    `  ${i + 1}. ${info.ruleName}: ${info.pathCount} æ¡è·¯å¾„, ` +\r\n                    `AST ${info.astNodeCount} ä¸ªèŠ‚ç‚¹`\r\n                )\r\n            })\r\n        }\r\n        \r\n        // ========================================\r\n        // ç¬¬ä¸‰éƒ¨åˆ†ï¼šå†²çªè¯¦æƒ…\r\n        // ========================================\r\n        if (errors.length > 0) {\r\n            console.log('\\nã€ç¬¬ä¸‰éƒ¨åˆ†ï¼šå†²çªè¯¦æƒ…ã€‘')\r\n            console.log('â”€'.repeat(80))\r\n            \r\n            errors.forEach((error, index) => {\r\n                console.log(`\\nğŸ”´ å†²çª ${index + 1}/${errors.length}`)\r\n                console.log('â”€'.repeat(40))\r\n                console.log(`è§„åˆ™: ${error.ruleName}`)\r\n                console.log(`ç±»å‹: ${error.type}`)\r\n                console.log(`çº§åˆ«: ${error.level}`)\r\n                console.log(`åˆ†æ”¯: [${error.branchIndices.join(', ')}]`)\r\n                console.log(`\\né—®é¢˜: ${error.message}`)\r\n                console.log(`\\nè·¯å¾„å¯¹æ¯”:`)\r\n                console.log(`  åˆ†æ”¯ ${error.branchIndices[0]}: ${this.formatPath(error.conflictPaths.pathA)}`)\r\n                console.log(`  åˆ†æ”¯ ${error.branchIndices[1]}: ${this.formatPath(error.conflictPaths.pathB)}`)\r\n                \r\n                // åˆ†æå†²çªåŸå› \r\n                const analysis = this.analyzeConflict(error)\r\n                console.log(`\\nåŸå› åˆ†æ:`)\r\n                console.log(`  ${analysis}`)\r\n                \r\n                console.log(`\\nä¿®å¤å»ºè®®:`)\r\n                console.log(`  ${error.suggestion}`)\r\n            })\r\n        }\r\n        \r\n        // ========================================\r\n        // ç»“å°¾\r\n        // ========================================\r\n        console.log('\\n' + '='.repeat(80))\r\n        console.log('ğŸ‰ éªŒè¯è°ƒè¯•å®Œæˆ')\r\n        console.log('='.repeat(80))\r\n    }\r\n    \r\n    // ========================================\r\n    // è¾…åŠ©æ–¹æ³•\r\n    // ========================================\r\n    \r\n    /**\r\n     * è®¡ç®— AST èŠ‚ç‚¹æ•°é‡\r\n     */\r\n    private countASTNodes(node: RuleNode): number {\r\n        switch (node.type) {\r\n            case 'consume':\r\n            case 'subrule':\r\n                return 1\r\n            \r\n            case 'sequence':\r\n                return 1 + node.nodes.reduce((sum, n) => sum + this.countASTNodes(n), 0)\r\n            \r\n            case 'or':\r\n                return 1 + node.alternatives.reduce((sum, n) => sum + this.countASTNodes(n), 0)\r\n            \r\n            case 'option':\r\n            case 'many':\r\n            case 'atLeastOne':\r\n                return 1 + this.countASTNodes(node.node)\r\n            \r\n            default:\r\n                return 0\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * è®¡ç®—è·¯å¾„ä¸­çš„ token æ•°é‡\r\n     */\r\n    private countTokens(path: Path): number {\r\n        if (path === '') return 0\r\n        return (path.match(/,/g) || []).length\r\n    }\r\n    \r\n    /**\r\n     * æ ¼å¼åŒ–è·¯å¾„ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰\r\n     */\r\n    private formatPath(path: Path): string {\r\n        if (path === '') {\r\n            return '(ç©ºè·¯å¾„)'\r\n        }\r\n        \r\n        if (path.startsWith('<')) {\r\n            return path  // ç‰¹æ®Šæ ‡è®°ï¼Œç›´æ¥è¿”å›\r\n        }\r\n        \r\n        // 'Token1,Token2,' â†’ 'Token1 â†’ Token2'\r\n        return path.replace(/,/g, ' â†’ ').slice(0, -3)\r\n    }\r\n    \r\n    /**\r\n     * åˆ†æå†²çªåŸå› \r\n     */\r\n    private analyzeConflict(error: ValidationError): string {\r\n        if (error.type === 'empty-path') {\r\n            return `åˆ†æ”¯ ${error.branchIndices[0]} å¯ä»¥åŒ¹é…ç©ºè¾“å…¥ï¼ˆ0ä¸ªtokenï¼‰ï¼Œ` +\r\n                   `å¯¼è‡´åç»­æ‰€æœ‰åˆ†æ”¯ï¼ˆåŒ…æ‹¬åˆ†æ”¯ ${error.branchIndices[1]}ï¼‰éƒ½ä¸å¯è¾¾ã€‚` +\r\n                   `è¿™é€šå¸¸æ˜¯ç”± Option() æˆ– Many() å¼•èµ·çš„ã€‚`\r\n        }\r\n        \r\n        if (error.type === 'prefix-conflict') {\r\n            const pathA = error.conflictPaths.pathA\r\n            const pathB = error.conflictPaths.pathB\r\n            const tokensA = this.countTokens(pathA)\r\n            const tokensB = this.countTokens(pathB)\r\n            \r\n            return `åˆ†æ”¯ ${error.branchIndices[0]} çš„è·¯å¾„ï¼ˆ${tokensA} tokensï¼‰æ˜¯ ` +\r\n                   `åˆ†æ”¯ ${error.branchIndices[1]} è·¯å¾„ï¼ˆ${tokensB} tokensï¼‰çš„å‰ç¼€ã€‚` +\r\n                   `è¿™æ„å‘³ç€å½“è¾“å…¥åŒ¹é…å‰ ${tokensA} ä¸ªtokenæ—¶ï¼ŒParserä¼šä¼˜å…ˆé€‰æ‹©åˆ†æ”¯ ${error.branchIndices[0]}ï¼Œ` +\r\n                   `å¯¼è‡´åˆ†æ”¯ ${error.branchIndices[1]} æ°¸è¿œä¸ä¼šè¢«å°è¯•ã€‚`\r\n        }\r\n        \r\n        return 'æœªçŸ¥å†²çªç±»å‹'\r\n    }\r\n    \r\n    /**\r\n     * è·å–ç»Ÿè®¡ä¿¡æ¯ï¼ˆä¾›å¤–éƒ¨ä½¿ç”¨ï¼‰\r\n     */\r\n    getStats() {\r\n        return { ...this.stats }\r\n    }\r\n    \r\n    /**\r\n     * è·å–è§„åˆ™ä¿¡æ¯ï¼ˆä¾›å¤–éƒ¨ä½¿ç”¨ï¼‰\r\n     */\r\n    getRuleInfos() {\r\n        return new Map(this.ruleInfos)\r\n    }\r\n    \r\n    /**\r\n     * æ¸…é™¤æ‰€æœ‰æ•°æ®\r\n     */\r\n    clear(): void {\r\n        this.events = []\r\n        this.ruleInfos.clear()\r\n        this.conflictInfos = []\r\n        this.stats = {\r\n            totalRules: 0,\r\n            collectedRules: 0,\r\n            totalPaths: 0,\r\n            totalConflicts: 0,\r\n            fatalErrors: 0,\r\n            warnings: 0,\r\n            collectTime: 0,\r\n            analyzeTime: 0,\r\n            detectTime: 0,\r\n            totalTime: 0\r\n        }\r\n    }\r\n}\r\n\r\n","/**\r\n * Subhuti Validation Logger - ç»Ÿä¸€çš„æ—¥å¿—å·¥å…·\r\n * \r\n * åŠŸèƒ½ï¼š\r\n * 1. æä¾›ç»Ÿä¸€çš„æ—¥å¿—æ¥å£\r\n * 2. æ”¯æŒæ—¥å¿—çº§åˆ«æ§åˆ¶\r\n * 3. æ”¯æŒæŒ‰è§„åˆ™åè¿‡æ»¤æ—¥å¿—\r\n * 4. æ€§èƒ½ä¼˜åŒ–ï¼šæ—¥å¿—å…³é—­æ—¶é›¶å¼€é”€\r\n * \r\n * @version 1.0.0\r\n */\r\n\r\n/**\r\n * æ—¥å¿—çº§åˆ«\r\n */\r\nexport enum LogLevel {\r\n    NONE = 0,    // ä¸è¾“å‡ºä»»ä½•æ—¥å¿—\r\n    ERROR = 1,   // åªè¾“å‡ºé”™è¯¯\r\n    WARN = 2,    // è¾“å‡ºè­¦å‘Šå’Œé”™è¯¯\r\n    INFO = 3,    // è¾“å‡ºä¿¡æ¯ã€è­¦å‘Šå’Œé”™è¯¯\r\n    DEBUG = 4    // è¾“å‡ºæ‰€æœ‰æ—¥å¿—ï¼ˆåŒ…æ‹¬è°ƒè¯•ä¿¡æ¯ï¼‰\r\n}\r\n\r\n/**\r\n * æ—¥å¿—é…ç½®\r\n */\r\nexport interface LoggerConfig {\r\n    /** æ—¥å¿—çº§åˆ« */\r\n    level: LogLevel\r\n    \r\n    /** å¯ç”¨æ—¥å¿—çš„è§„åˆ™ååˆ—è¡¨ï¼ˆä¸ºç©ºè¡¨ç¤ºæ‰€æœ‰è§„åˆ™ï¼‰ */\r\n    enabledRules?: string[]\r\n    \r\n    /** æ˜¯å¦è¾“å‡ºåˆ°æ–‡ä»¶ */\r\n    outputToFile?: boolean\r\n    \r\n    /** æ–‡ä»¶è·¯å¾„ */\r\n    filePath?: string\r\n}\r\n\r\n/**\r\n * éªŒè¯æ—¥å¿—å·¥å…·\r\n */\r\nexport class SubhutiValidationLogger {\r\n    private static config: LoggerConfig = {\r\n        level: LogLevel.NONE,  // é»˜è®¤å…³é—­æ‰€æœ‰æ—¥å¿—\r\n        enabledRules: []\r\n    }\r\n    \r\n    /**\r\n     * é…ç½®æ—¥å¿—\r\n     * \r\n     * @param config æ—¥å¿—é…ç½®\r\n     */\r\n    static configure(config: Partial<LoggerConfig>): void {\r\n        this.config = {\r\n            ...this.config,\r\n            ...config\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * æ£€æŸ¥æ˜¯å¦åº”è¯¥è¾“å‡ºæ—¥å¿—\r\n     * \r\n     * @param level æ—¥å¿—çº§åˆ«\r\n     * @param ruleName è§„åˆ™åï¼ˆå¯é€‰ï¼‰\r\n     * @returns æ˜¯å¦åº”è¯¥è¾“å‡º\r\n     */\r\n    private static shouldLog(level: LogLevel, ruleName?: string): boolean {\r\n        // æ£€æŸ¥æ—¥å¿—çº§åˆ«\r\n        if (this.config.level < level) {\r\n            return false\r\n        }\r\n        \r\n        // æ£€æŸ¥è§„åˆ™åè¿‡æ»¤\r\n        if (ruleName && this.config.enabledRules && this.config.enabledRules.length > 0) {\r\n            if (!this.config.enabledRules.includes(ruleName)) {\r\n                return false\r\n            }\r\n        }\r\n        \r\n        return true\r\n    }\r\n    \r\n    /**\r\n     * è¾“å‡ºè°ƒè¯•æ—¥å¿—\r\n     * \r\n     * @param message æ¶ˆæ¯\r\n     * @param ruleName è§„åˆ™åï¼ˆå¯é€‰ï¼‰\r\n     */\r\n    static debug(message: string, ruleName?: string): void {\r\n        if (!this.shouldLog(LogLevel.DEBUG, ruleName)) {\r\n            return\r\n        }\r\n        console.log(`[DEBUG] ${message}`)\r\n    }\r\n    \r\n    /**\r\n     * è¾“å‡ºä¿¡æ¯æ—¥å¿—\r\n     * \r\n     * @param message æ¶ˆæ¯\r\n     * @param ruleName è§„åˆ™åï¼ˆå¯é€‰ï¼‰\r\n     */\r\n    static info(message: string, ruleName?: string): void {\r\n        if (!this.shouldLog(LogLevel.INFO, ruleName)) {\r\n            return\r\n        }\r\n        console.log(`[INFO] ${message}`)\r\n    }\r\n    \r\n    /**\r\n     * è¾“å‡ºè­¦å‘Šæ—¥å¿—\r\n     * \r\n     * @param message æ¶ˆæ¯\r\n     * @param ruleName è§„åˆ™åï¼ˆå¯é€‰ï¼‰\r\n     */\r\n    static warn(message: string, ruleName?: string): void {\r\n        if (!this.shouldLog(LogLevel.WARN, ruleName)) {\r\n            return\r\n        }\r\n        console.warn(`[WARN] ${message}`)\r\n    }\r\n    \r\n    /**\r\n     * è¾“å‡ºé”™è¯¯æ—¥å¿—\r\n     * \r\n     * @param message æ¶ˆæ¯\r\n     * @param ruleName è§„åˆ™åï¼ˆå¯é€‰ï¼‰\r\n     */\r\n    static error(message: string, ruleName?: string): void {\r\n        if (!this.shouldLog(LogLevel.ERROR, ruleName)) {\r\n            return\r\n        }\r\n        console.error(`[ERROR] ${message}`)\r\n    }\r\n    \r\n    /**\r\n     * è·å–å½“å‰é…ç½®\r\n     */\r\n    static getConfig(): LoggerConfig {\r\n        return { ...this.config }\r\n    }\r\n    \r\n    /**\r\n     * é‡ç½®é…ç½®ä¸ºé»˜è®¤å€¼\r\n     */\r\n    static reset(): void {\r\n        this.config = {\r\n            level: LogLevel.NONE,\r\n            enabledRules: []\r\n        }\r\n    }\r\n}\r\n\r\n","/**\r\n * SubhutiGrammarValidator - è¯­æ³•éªŒè¯å™¨\r\n *\r\n * èŒè´£ï¼š\r\n * 1. æä¾›é™æ€éªŒè¯æ–¹æ³•\r\n * 2. å°è£…éªŒè¯æµç¨‹ï¼ˆæ”¶é›† â†’ åˆ†æ â†’ æ£€æµ‹ â†’ æŠ¥å‘Šï¼‰\r\n *\r\n * è®¾è®¡ï¼š\r\n * - çº¯é™æ€æ–¹æ³•ï¼Œæ— å®ä¾‹çŠ¶æ€\r\n * - ä½¿ç”¨ Proxy æ–¹æ¡ˆæ”¶é›† ASTï¼ˆé›¶ä¾µå…¥ï¼‰\r\n * - æœ‰é—®é¢˜ç›´æ¥æŠ›å¼‚å¸¸\r\n *\r\n * @version 2.0.0 - é™æ€æ–¹æ³•é‡æ„\r\n */\r\n\r\nimport {\r\n    SubhutiRuleCollector,\r\n    SubhutiGrammarAnalyzer,\r\n    SubhutiConflictDetector,\r\n    SubhutiGrammarValidationError,\r\n    ValidationStats,\r\n    EXPANSION_LIMITS\r\n} from \"./index\";\r\n\r\nexport class SubhutiGrammarValidator {\r\n    /**\r\n     * éªŒè¯è¯­æ³•ï¼šæœ‰é—®é¢˜ç›´æ¥æŠ›å¼‚å¸¸\r\n     *\r\n     * æµç¨‹ï¼ˆåˆ†å±‚æ£€æµ‹ï¼‰ï¼š\r\n     * 1. ä½¿ç”¨ Proxy æ”¶é›†è§„åˆ™ AST\r\n     * 2. åˆ†ææ‰€æœ‰å¯èƒ½è·¯å¾„å’Œ First é›†åˆ\r\n     * 3. Level 0: å·¦é€’å½’æ£€æµ‹ (FATAL) - æœ€å…ˆæ£€æµ‹ï¼Œæœ€è‡´å‘½\r\n     * 4. Level 1 & 2: Or åˆ†æ”¯å†²çªæ£€æµ‹ (FATAL/ERROR)\r\n     * 5. æœ‰é”™è¯¯æŠ› SubhutiGrammarValidationError\r\n     *\r\n     * @param parser Parser å®ä¾‹\r\n     * @param maxLevel æœ€å¤§å±•å¼€å±‚çº§ï¼ˆé»˜è®¤ä½¿ç”¨é…ç½®ä¸­çš„ MAX_LEVELï¼‰\r\n     * @throws SubhutiGrammarValidationError è¯­æ³•æœ‰å†²çªæ—¶æŠ›å‡º\r\n     */\r\n    static validate(parser: any): void {\r\n        // 1. æ”¶é›†è§„åˆ™ ASTï¼ˆé€šè¿‡ Proxyï¼Œæ— éœ€ Parser é…åˆï¼‰\r\n        const ruleASTs = SubhutiRuleCollector.collectRules(parser)\r\n\r\n        // 2. åˆ›å»ºè¯­æ³•åˆ†æå™¨\r\n        const analyzer = new SubhutiGrammarAnalyzer(ruleASTs.cstMap, ruleASTs.tokenMap)\r\n\r\n        // 3. åˆå§‹åŒ–ç¼“å­˜ï¼ˆè®¡ç®—ç›´æ¥å­èŠ‚ç‚¹ã€First é›†åˆã€è·¯å¾„å±•å¼€ï¼‰\r\n        // åŒæ—¶è¿›è¡Œå·¦é€’å½’æ£€æµ‹å’Œ Or åˆ†æ”¯å†²çªæ£€æµ‹\r\n        const result = analyzer.initCacheAndCheckLeftRecursion()\r\n\r\n        // 4. èšåˆæ‰€æœ‰é”™è¯¯ï¼Œä¸€èµ·æŠ¥å‘Šï¼ˆç»Ÿè®¡ä¿¡æ¯ä¼šåœ¨å¼‚å¸¸çš„ toString() ä¸­è¾“å‡ºï¼‰\r\n        if (result.errors.length > 0) {\r\n            const error = new SubhutiGrammarValidationError(result.errors, result.stats)\r\n            console.error('\\n' + error.toString())\r\n        }\r\n    }\r\n\r\n}\r\n\r\n","/**\r\n * Subhuti Parser - é«˜æ€§èƒ½ PEG Parser æ¡†æ¶\r\n *\r\n * æ ¸å¿ƒç‰¹æ€§ï¼š\r\n * - Packrat Parsingï¼ˆçº¿æ€§æ—¶é—´å¤æ‚åº¦ï¼ŒLRU ç¼“å­˜ï¼‰\r\n * - è¿”å›å€¼è¯­ä¹‰ï¼ˆæˆåŠŸè¿”å› CSTï¼Œå¤±è´¥è¿”å› undefinedï¼‰\r\n *\r\n * æ¶æ„è®¾è®¡ï¼š\r\n * - ç»§æ‰¿ SubhutiTokenLookaheadï¼ˆå‰ç»èƒ½åŠ›ï¼‰\r\n * - å®ç° ITokenConsumerContextï¼ˆæä¾›æ¶ˆè´¹æ¥å£ï¼‰\r\n * - æ”¯æŒæ³›å‹æ‰©å±• SubhutiTokenConsumer\r\n *\r\n * @version 5.0.0\r\n */\r\n\r\nimport SubhutiTokenLookahead from \"./SubhutiTokenLookahead.ts\"\r\nimport SubhutiCst from \"./struct/SubhutiCst.ts\";\r\nimport type SubhutiMatchToken from \"./struct/SubhutiMatchToken.ts\";\r\nimport {SubhutiErrorHandler, ParsingError} from \"./SubhutiError.ts\";\r\nimport {SubhutiTraceDebugger} from \"./SubhutiDebug.ts\";\r\nimport {SubhutiPackratCache, type SubhutiPackratCacheResult} from \"./SubhutiPackratCache.ts\";\r\nimport SubhutiTokenConsumer from \"./SubhutiTokenConsumer.ts\";\r\nimport {SubhutiDebugRuleTracePrint, setShowRulePath} from \"./SubhutiDebugRuleTracePrint.ts\";\r\nimport SubhutiLexer, {LexicalGoal, TokenCacheEntry} from \"./SubhutiLexer.ts\";\r\nimport {SubhutiCreateToken} from \"./struct/SubhutiCreateToken.ts\";\r\n\r\n// Grammar Validation\r\nimport {SubhutiGrammarValidator} from \"./validation/SubhutiGrammarValidator.ts\";\r\n\r\n// ============================================\r\n// ç±»å‹å®šä¹‰\r\n// ============================================\r\n\r\nexport type RuleFunction = () => SubhutiCst | undefined\r\n\r\nexport interface SubhutiParserOr {\r\n    alt: RuleFunction\r\n}\r\n\r\nexport interface SubhutiBackData {\r\n    /** æºç ä½ç½® */\r\n    codeIndex: number\r\n    /** è¡Œå· */\r\n    codeLine: number\r\n    /** åˆ—å· */\r\n    codeColumn: number\r\n    /** ä¸Šä¸€ä¸ª token åç§° */\r\n    lastTokenName: string | null\r\n    /** CST children é•¿åº¦ */\r\n    curCstChildrenLength: number\r\n    /** å·²è§£æ token æ•°é‡ï¼ˆç”¨äºæ¢å¤ parsedTokensï¼‰ */\r\n    parsedTokensLength: number\r\n}\r\n\r\n/**\r\n * éƒ¨åˆ†åŒ¹é…è®°å½•ï¼ˆç”¨äºå®¹é”™æ¨¡å¼ï¼‰\r\n * åœ¨å›æº¯æ—¶è®°å½•å·²æ¶ˆè´¹ token çš„ CST ç»“æ„\r\n */\r\nexport interface PartialMatchRecord {\r\n    children: SubhutiCst[]    // éƒ¨åˆ†åŒ¹é…çš„ childrenï¼ˆå¼•ç”¨ï¼‰\r\n    parentCst: SubhutiCst     // çˆ¶èŠ‚ç‚¹ï¼ˆæ¢å¤æ—¶æŠŠ children æ”¾åˆ°è¿™é‡Œï¼‰\r\n    endTokenIndex: number     // æ¶ˆè€—åˆ°çš„ token ç´¢å¼•\r\n    startTokenIndex: number   // èµ·å§‹ token ç´¢å¼•\r\n}\r\n\r\n/**\r\n * è§£æè®°å½•æ ‘èŠ‚ç‚¹ï¼ˆç”¨äºå®¹é”™æ¨¡å¼ï¼‰\r\n * åªå¢ä¸åˆ ï¼Œè®°å½•æ‰€æœ‰è§£æå°è¯•è·¯å¾„\r\n */\r\nexport interface ParseRecordNode {\r\n    name: string                  // è§„åˆ™åæˆ– token å\r\n    children: ParseRecordNode[]   // å­èŠ‚ç‚¹ï¼ˆåªå¢ä¸åˆ ï¼‰\r\n    startTokenIndex: number       // è¯¥èŠ‚ç‚¹å¼€å§‹çš„ token ç´¢å¼•\r\n    endTokenIndex: number         // è¯¥èŠ‚ç‚¹æ¶ˆè€—åˆ°çš„ token ç´¢å¼•\r\n    token?: SubhutiMatchToken     // å¦‚æœæ˜¯ token å¶å­èŠ‚ç‚¹\r\n    value?: string                // token å€¼\r\n}\r\n\r\n// ============================================\r\n// è£…é¥°å™¨ç³»ç»Ÿ\r\n// ============================================\r\n\r\nexport function Subhuti<E extends SubhutiTokenLookahead, T extends new (...args: any[]) => SubhutiParser<E>>(\r\n    target: T,\r\n    context: ClassDecoratorContext\r\n) {\r\n    // ä¸ä½¿ç”¨ context.metadataï¼Œå› ä¸º tsdown/rolldown ç¼–è¯‘åä¸æ”¯æŒ\r\n    return target\r\n}\r\n\r\nexport function SubhutiRule(targetFun: any, context: ClassMethodDecoratorContext) {\r\n    const ruleName = targetFun.name\r\n    // åœ¨è¿è¡Œæ—¶é€šè¿‡ this.constructor.name è·å–ç±»å\r\n    const wrappedFunction = function (...args: any[]): SubhutiCst | undefined {\r\n        const className = this.constructor.name\r\n        return this.executeRuleWrapper(targetFun, ruleName, className, ...args)\r\n    }\r\n\r\n    Object.defineProperty(wrappedFunction, 'name', {value: ruleName})\r\n\r\n    // âœ… ä¿å­˜åŸå§‹å‡½æ•°å¼•ç”¨ï¼ˆä¾› SubhutiRuleCollector ä½¿ç”¨ï¼‰\r\n    Object.defineProperty(wrappedFunction, '__originalFunction__', {\r\n        value: targetFun,\r\n        writable: false,\r\n        enumerable: false,\r\n        configurable: false\r\n    })\r\n\r\n    // âœ… æ·»åŠ å…ƒæ•°æ®æ ‡è®°ï¼Œæ ‡è¯†è¿™æ˜¯ä¸€ä¸ªè§„åˆ™æ–¹æ³•\r\n    Object.defineProperty(wrappedFunction, '__isSubhutiRule__', {\r\n        value: true,\r\n        writable: false,\r\n        enumerable: false,\r\n        configurable: false\r\n    })\r\n\r\n    return wrappedFunction\r\n}\r\n\r\nexport type SubhutiTokenConsumerConstructor<T extends SubhutiTokenConsumer> =\r\n    new (parser: SubhutiParser) => T\r\n\r\n/**\r\n * Parser æ„é€ é€‰é¡¹\r\n */\r\nexport interface SubhutiParserOptions<T extends SubhutiTokenConsumer = SubhutiTokenConsumer> {\r\n    /** TokenConsumer ç±»ï¼ˆå¯é€‰ï¼‰ */\r\n    tokenConsumer?: SubhutiTokenConsumerConstructor<T>\r\n    /** Token å®šä¹‰ï¼ˆç”¨äºæŒ‰éœ€è¯æ³•åˆ†ææ¨¡å¼ï¼‰ */\r\n    tokenDefinitions?: SubhutiCreateToken[]\r\n}\r\n\r\n// ============================================\r\n// SubhutiParser æ ¸å¿ƒç±»\r\n// ============================================\r\n\r\nexport default class SubhutiParser<T extends SubhutiTokenConsumer = SubhutiTokenConsumer>\r\n    extends SubhutiTokenLookahead {\r\n    // æ ¸å¿ƒå­—æ®µ\r\n    readonly tokenConsumer: T\r\n\r\n    private readonly cstStack: SubhutiCst[] = []\r\n    private readonly className: string\r\n\r\n    // ============================================\r\n    // æŒ‰éœ€è¯æ³•åˆ†æç›¸å…³å­—æ®µï¼ˆæ–°æ¶æ„ï¼‰\r\n    // ============================================\r\n\r\n    /** è¯æ³•åˆ†æå™¨ */\r\n    protected _lexer: SubhutiLexer | null = null\r\n\r\n    /** æºä»£ç  */\r\n    protected _sourceCode: string = ''\r\n\r\n    /** å½“å‰æºç ä½ç½® */\r\n    protected _codeIndex: number = 0\r\n\r\n    /** å½“å‰è¡Œå· */\r\n    protected _codeLine: number = 1\r\n\r\n    /** å½“å‰åˆ—å· */\r\n    protected _codeColumn: number = 1\r\n\r\n    /** ä¸Šä¸€ä¸ª token åç§°ï¼ˆç”¨äºä¸Šä¸‹æ–‡çº¦æŸï¼‰ */\r\n    protected _lastTokenName: string | null = null\r\n\r\n    /** æ¨¡æ¿å­—ç¬¦ä¸²æ·±åº¦ */\r\n    protected _templateDepth: number = 0\r\n\r\n    /** é»˜è®¤è¯æ³•ç›®æ ‡ */\r\n    protected _defaultGoal: LexicalGoal = LexicalGoal.InputElementDiv\r\n\r\n    /** Token ç¼“å­˜ï¼šä½ç½® â†’ æ¨¡å¼ â†’ ç¼“å­˜æ¡ç›® */\r\n    protected _tokenCache: Map<number, Map<LexicalGoal, TokenCacheEntry>> = new Map()\r\n\r\n    /** å·²è§£æçš„ token åˆ—è¡¨ï¼ˆç”¨äºè¾“å‡ºç»™ä½¿ç”¨è€…ï¼‰ */\r\n    protected _parsedTokens: SubhutiMatchToken[] = []\r\n\r\n    /**\r\n     * åˆ†ææ¨¡å¼æ ‡å¿—\r\n     * - true: åˆ†ææ¨¡å¼ï¼ˆç”¨äºè¯­æ³•éªŒè¯ï¼Œä¸æŠ›å¼‚å¸¸ï¼‰\r\n     * - false: æ­£å¸¸æ¨¡å¼ï¼ˆç”¨äºè§£æï¼ŒæŠ›å¼‚å¸¸ï¼‰\r\n     */\r\n    private _analysisMode: boolean = false\r\n\r\n    /**\r\n     * å®¹é”™æ¨¡å¼æ ‡å¿—\r\n     * - true: å¯ç”¨å®¹é”™ï¼ˆè§£æå¤±è´¥æ—¶è·³è¿‡ token ç»§ç»­è§£æï¼‰\r\n     * - false: ä¸å¯ç”¨å®¹é”™ï¼ˆè§£æå¤±è´¥æ—¶åœæ­¢ï¼‰\r\n     */\r\n    private _errorRecoveryMode: boolean = false\r\n\r\n    /**\r\n     * åŒæ­¥ç‚¹ Token åç§°é›†åˆ\r\n     * è¿™äº› token é€šå¸¸æ˜¯è¯­å¥çš„å¼€å§‹ï¼Œç”¨äºå®¹é”™æ¨¡å¼ä¸‹çš„æ¢å¤ç‚¹\r\n     */\r\n    protected _syncTokens: Set<string> = new Set([\r\n        'LetTok', 'ConstTok', 'VarTok',\r\n        'FunctionTok', 'ClassTok', 'AsyncTok',\r\n        'IfTok', 'ForTok', 'WhileTok', 'DoTok', 'SwitchTok',\r\n        'TryTok', 'ThrowTok', 'ReturnTok', 'BreakTok', 'ContinueTok',\r\n        'ImportTok', 'ExportTok',\r\n        'DebuggerTok',\r\n        'Semicolon',\r\n    ])\r\n\r\n    /**\r\n     * è®¾ç½®åŒæ­¥ç‚¹ Token\r\n     */\r\n    setSyncTokens(tokens: string[]): this {\r\n        this._syncTokens = new Set(tokens)\r\n        return this\r\n    }\r\n\r\n    /**\r\n     * æ·»åŠ åŒæ­¥ç‚¹ Token\r\n     */\r\n    addSyncTokens(tokens: string[]): this {\r\n        for (const token of tokens) {\r\n            this._syncTokens.add(token)\r\n        }\r\n        return this\r\n    }\r\n\r\n    /**\r\n     * å¯ç”¨å®¹é”™æ¨¡å¼\r\n     */\r\n    enableErrorRecovery(): this {\r\n        this._errorRecoveryMode = true\r\n        return this\r\n    }\r\n\r\n    /**\r\n     * è·å–å®¹é”™æ¨¡å¼çŠ¶æ€\r\n     */\r\n    get errorRecoveryMode(): boolean {\r\n        return this._errorRecoveryMode\r\n    }\r\n\r\n    getRuleStack() {\r\n        return this.cstStack.map(item => item.name)\r\n    }\r\n\r\n    // è°ƒè¯•å’Œé”™è¯¯å¤„ç†\r\n    private _debugger?: SubhutiTraceDebugger\r\n    private readonly _errorHandler = new SubhutiErrorHandler()\r\n\r\n    // æ— é™å¾ªç¯æ£€æµ‹ï¼ˆè°ƒç”¨æ ˆçŠ¶æ€æ£€æµ‹ï¼‰\r\n    /**\r\n     * å¾ªç¯æ£€æµ‹é›†åˆï¼šO(1) æ£€æµ‹ (rule, position) æ˜¯å¦é‡å¤\r\n     * æ ¼å¼: \"ruleName:position\"\r\n     */\r\n    private readonly loopDetectionSet: Set<string> = new Set()\r\n\r\n    // Packrat Parsingï¼ˆé»˜è®¤ LRU ç¼“å­˜ï¼‰\r\n    enableMemoization: boolean = true\r\n    private readonly _cache: SubhutiPackratCache\r\n\r\n    /**\r\n     * éƒ¨åˆ†åŒ¹é…å€™é€‰åˆ—è¡¨ï¼ˆå®¹é”™æ¨¡å¼ä¸“ç”¨ï¼‰\r\n     * è®°å½•åœ¨å›æº¯æ—¶è¢«åˆ é™¤ä½†æ¶ˆè´¹äº† token çš„ CST ç‰‡æ®µ\r\n     */\r\n    private _partialMatchCandidates: PartialMatchRecord[] = []\r\n\r\n    /**\r\n     * æœªè¢«è§£æçš„ tokens åˆ—è¡¨ï¼ˆå®¹é”™æ¨¡å¼ä¸“ç”¨ï¼‰\r\n     * ç”¨äºæœ€ç»ˆåˆ¤æ–­è§£ææ˜¯å¦å®Œå…¨æˆåŠŸ\r\n     */\r\n    private _unparsedTokens: SubhutiMatchToken[] = []\r\n\r\n    // ============================================\r\n    // è§£æè®°å½•æ ‘ç›¸å…³ï¼ˆå®¹é”™æ¨¡å¼ä¸“ç”¨ï¼‰\r\n    // ============================================\r\n\r\n    /** è§£æè®°å½•æ ‘æ ¹èŠ‚ç‚¹ */\r\n    private _parseRecordRoot: ParseRecordNode | null = null\r\n\r\n    /** è§£æè®°å½•æ ‘èŠ‚ç‚¹æ ˆï¼ˆè·Ÿè¸ªå½“å‰è·¯å¾„ï¼‰ */\r\n    private _parseRecordStack: ParseRecordNode[] = []\r\n\r\n    /**\r\n     * è·å–æœªè¢«è§£æçš„ tokens åˆ—è¡¨\r\n     */\r\n    get unparsedTokens(): SubhutiMatchToken[] {\r\n        return this._unparsedTokens\r\n    }\r\n\r\n    /**\r\n     * æ˜¯å¦æœ‰æœªè¢«è§£æçš„ tokens\r\n     */\r\n    get hasUnparsedTokens(): boolean {\r\n        return this._unparsedTokens.length > 0\r\n    }\r\n\r\n    /**\r\n     * æ„é€ å‡½æ•° - æŒ‰éœ€è¯æ³•åˆ†ææ¨¡å¼\r\n     *\r\n     * @param sourceCode æºä»£ç \r\n     * @param options é…ç½®é€‰é¡¹\r\n     */\r\n    constructor(\r\n        sourceCode: string = '',\r\n        options?: SubhutiParserOptions<T>,\r\n    ) {\r\n        super()\r\n        this.className = this.constructor.name\r\n        this._cache = new SubhutiPackratCache()\r\n\r\n        // åˆå§‹åŒ–æºä»£ç å’Œä½ç½®\r\n        this._sourceCode = sourceCode\r\n        this._codeIndex = 0\r\n        this._codeLine = 1\r\n        this._codeColumn = 1\r\n        this._lastTokenName = null\r\n        this._templateDepth = 0\r\n        this._tokenCache = new Map()\r\n        this._parsedTokens = []\r\n\r\n        // åˆå§‹åŒ–è¯æ³•åˆ†æå™¨\r\n        if (options?.tokenDefinitions) {\r\n            this._lexer = new SubhutiLexer(options.tokenDefinitions)\r\n        }\r\n\r\n        // åˆå§‹åŒ– TokenConsumer\r\n        if (options?.tokenConsumer) {\r\n            this.tokenConsumer = new options.tokenConsumer(this)\r\n        } else {\r\n            this.tokenConsumer = new SubhutiTokenConsumer(this) as T\r\n        }\r\n    }\r\n\r\n    /**\r\n     * è·å–å·²è§£æçš„ token åˆ—è¡¨\r\n     */\r\n    get parsedTokens(): SubhutiMatchToken[] {\r\n        return this._parsedTokens\r\n    }\r\n\r\n    /**\r\n     * è·å–æœ€åè§£æçš„ token ç´¢å¼•\r\n     * @returns token ç´¢å¼•ï¼Œå¦‚æœæ²¡æœ‰å·²è§£æçš„ token åˆ™è¿”å› -1\r\n     */\r\n    get lastTokenIndex(): number {\r\n        return this._parsedTokens.length - 1\r\n    }\r\n\r\n    /**\r\n     * è·å–å½“å‰æ­£åœ¨å¤„ç†çš„ token ç´¢å¼•ï¼ˆä¸‹ä¸€ä¸ªå°†è¢« consume çš„ tokenï¼‰\r\n     * @returns å½“å‰ token ç´¢å¼•\r\n     */\r\n    get currentTokenIndex(): number {\r\n        return this._parsedTokens.length\r\n    }\r\n\r\n    // ============================================\r\n    // æŒ‰éœ€è¯æ³•åˆ†æ\r\n    // ============================================\r\n\r\n    /**\r\n     * è·å–æˆ–è§£ææŒ‡å®šä½ç½®å’Œæ¨¡å¼çš„ token\r\n     *\r\n     * @param codeIndex æºç ä½ç½®\r\n     * @param line è¡Œå·\r\n     * @param column åˆ—å·\r\n     * @param goal è¯æ³•ç›®æ ‡\r\n     * @returns TokenCacheEntry æˆ– nullï¼ˆEOFï¼‰\r\n     */\r\n    protected _getOrParseToken(\r\n        codeIndex: number,\r\n        line: number,\r\n        column: number,\r\n        goal: LexicalGoal\r\n    ): TokenCacheEntry | null {\r\n        if (!this._lexer) return null\r\n\r\n        // 1. æŸ¥ç¼“å­˜\r\n        const positionCache = this._tokenCache.get(codeIndex)\r\n        if (positionCache?.has(goal)) {\r\n            return positionCache.get(goal)!\r\n        }\r\n\r\n        // 2. è§£ææ–° token\r\n        const entry = this._lexer.readTokenAt(\r\n            this._sourceCode,\r\n            codeIndex,\r\n            line,\r\n            column,\r\n            goal,\r\n            this._lastTokenName,\r\n            this._templateDepth\r\n        )\r\n\r\n        if (!entry) return null  // EOF\r\n\r\n        // 3. å­˜å…¥ç¼“å­˜\r\n        if (!positionCache) {\r\n            this._tokenCache.set(codeIndex, new Map())\r\n        }\r\n        this._tokenCache.get(codeIndex)!.set(goal, entry)\r\n\r\n        return entry\r\n    }\r\n\r\n    /**\r\n     * LA (LookAhead) - å‰ç»è·å– tokenï¼ˆæ”¯æŒæ¨¡å¼æ•°ç»„ï¼‰\r\n     *\r\n     * @param offset åç§»é‡ï¼ˆ1 = å½“å‰ tokenï¼Œ2 = ä¸‹ä¸€ä¸ª...ï¼‰\r\n     * @param goals æ¯ä¸ªä½ç½®çš„è¯æ³•ç›®æ ‡ï¼ˆå¯é€‰ï¼Œä¸ä¼ ç”¨é»˜è®¤å€¼ï¼‰\r\n     * @returns token æˆ– undefinedï¼ˆEOFï¼‰\r\n     */\r\n    protected override LA(offset: number = 1, goals?: LexicalGoal[]): SubhutiMatchToken | undefined {\r\n        let currentIndex = this._codeIndex\r\n        let currentLine = this._codeLine\r\n        let currentColumn = this._codeColumn\r\n\r\n        for (let i = 0; i < offset; i++) {\r\n            // ç¡®å®šå½“å‰ token çš„è¯æ³•ç›®æ ‡\r\n            const goal = goals?.[i] ?? this._defaultGoal\r\n\r\n            // ä»ç¼“å­˜è·å–æˆ–è§£æ\r\n            const entry = this._getOrParseToken(currentIndex, currentLine, currentColumn, goal)\r\n\r\n            if (!entry) return undefined  // EOF\r\n\r\n            // å¦‚æœæ˜¯æœ€åä¸€ä¸ªï¼Œè¿”å› token\r\n            if (i === offset - 1) {\r\n                return entry.token\r\n            }\r\n\r\n            // å¦åˆ™ï¼Œç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªä½ç½®\r\n            currentIndex = entry.nextCodeIndex\r\n            currentLine = entry.nextLine\r\n            currentColumn = entry.nextColumn\r\n        }\r\n\r\n        return undefined\r\n    }\r\n\r\n    /**\r\n     * peek - å‰ç»è·å– tokenï¼ˆæ”¯æŒæ¨¡å¼æ•°ç»„ï¼‰\r\n     */\r\n    protected override peek(offset: number = 1, goals?: LexicalGoal[]): SubhutiMatchToken | undefined {\r\n        return this.LA(offset, goals)\r\n    }\r\n\r\n    /**\r\n     * è·å–å½“å‰ tokenï¼ˆä½¿ç”¨é»˜è®¤è¯æ³•ç›®æ ‡ï¼‰\r\n     */\r\n    override get curToken(): SubhutiMatchToken | undefined {\r\n        return this.LA(1)\r\n    }\r\n\r\n    // ============================================\r\n    // å…¬å¼€ç»™ TokenConsumer ä½¿ç”¨çš„æ–¹æ³•\r\n    // ============================================\r\n\r\n    /**\r\n     * ä¾› TokenConsumer ä½¿ç”¨çš„ consume æ–¹æ³•\r\n     * @param tokenName token åç§°\r\n     * @param goal å¯é€‰çš„è¯æ³•ç›®æ ‡ï¼ˆç”¨äºæ¨¡æ¿å°¾éƒ¨ç­‰åœºæ™¯ï¼‰\r\n     */\r\n    _consumeToken(tokenName: string, goal?: LexicalGoal): SubhutiCst | undefined {\r\n        return this.consume(tokenName, goal)\r\n    }\r\n\r\n    /**\r\n     * ä¾› TokenConsumer ä½¿ç”¨çš„æ ‡è®°è§£æå¤±è´¥æ–¹æ³•\r\n     * ç”¨äºè½¯å…³é”®å­—æ£€æŸ¥å¤±è´¥æ—¶æ ‡è®°è§£æå¤±è´¥\r\n     */\r\n    _markParseFail(): void {\r\n        this._parseSuccess = false\r\n    }\r\n\r\n    // ============================================\r\n    // Parser å†…éƒ¨ Getter\r\n    // ============================================\r\n\r\n    get curCst(): SubhutiCst | undefined {\r\n        return this.cstStack[this.cstStack.length - 1]\r\n    }\r\n\r\n    // åŠŸèƒ½å¼€å…³ï¼ˆé“¾å¼è°ƒç”¨ï¼‰\r\n    cache(enable: boolean = true): this {\r\n        this.enableMemoization = enable\r\n        return this\r\n    }\r\n\r\n    /**\r\n     * å¯ç”¨è°ƒè¯•æ¨¡å¼\r\n     * @param showRulePath - æ˜¯å¦æ˜¾ç¤ºè§„åˆ™æ‰§è¡Œè·¯å¾„ï¼ˆé»˜è®¤ trueï¼‰\r\n     *                       ä¼ å…¥ false æ—¶åªæ˜¾ç¤ºæ€§èƒ½ç»Ÿè®¡å’Œ CST éªŒè¯æŠ¥å‘Š\r\n     */\r\n    debug(showRulePath: boolean = true): this {\r\n        setShowRulePath(showRulePath)\r\n        this._debugger = new SubhutiTraceDebugger(this._parsedTokens)\r\n        return this\r\n    }\r\n\r\n    errorHandler(enable: boolean = true): this {\r\n        this._errorHandler.setDetailed(enable)\r\n        return this\r\n    }\r\n\r\n    /**\r\n     * å¯ç”¨åˆ†ææ¨¡å¼ï¼ˆç”¨äºè¯­æ³•éªŒè¯ï¼Œä¸æŠ›å¼‚å¸¸ï¼‰\r\n     *\r\n     * åœ¨åˆ†ææ¨¡å¼ä¸‹ï¼š\r\n     * - ä¸æŠ›å‡ºå·¦é€’å½’å¼‚å¸¸\r\n     * - ä¸æŠ›å‡ºæ— é™å¾ªç¯å¼‚å¸¸\r\n     * - ä¸æŠ›å‡º Token æ¶ˆè´¹å¤±è´¥å¼‚å¸¸\r\n     * - ä¸æŠ›å‡º EOF æ£€æµ‹å¼‚å¸¸\r\n     *\r\n     * @internal ä»…ä¾› SubhutiRuleCollector ä½¿ç”¨\r\n     */\r\n    enableAnalysisMode(): void {\r\n        this._analysisMode = true\r\n    }\r\n\r\n    /**\r\n     * ç¦ç”¨åˆ†ææ¨¡å¼ï¼ˆæ¢å¤æ­£å¸¸æ¨¡å¼ï¼‰\r\n     *\r\n     * @internal ä»…ä¾› SubhutiRuleCollector ä½¿ç”¨\r\n     */\r\n    disableAnalysisMode(): void {\r\n        this._analysisMode = false\r\n    }\r\n\r\n    /**\r\n     * å¯ç”¨è¯­æ³•éªŒè¯ï¼ˆé“¾å¼è°ƒç”¨ï¼‰ï¼ŒéªŒè¯è¯­æ³•ï¼ˆæ£€æµ‹ Or è§„åˆ™å†²çªï¼‰\r\n     *\r\n     * ç”¨æ³•ï¼š\r\n     * ```typescript\r\n     * const parser = new Es2025Parser(tokens).validate()\r\n     * const cst = parser.Script()\r\n     * ```\r\n     *\r\n     * @returns this - æ”¯æŒé“¾å¼è°ƒç”¨\r\n     * @throws SubhutiGrammarValidationError - è¯­æ³•æœ‰å†²çªæ—¶æŠ›å‡º\r\n     */\r\n    validate(): this {\r\n        SubhutiGrammarValidator.validate(this)\r\n        return this\r\n    }\r\n\r\n    /**\r\n     * æ£€æµ‹æ˜¯å¦æ˜¯ç›´æ¥æˆ–é—´æ¥å·¦é€’å½’\r\n     *\r\n     * âœ… è¿™ä¸ªæ–¹æ³•å¯ä»¥å‡†ç¡®åˆ¤æ–­å·¦é€’å½’\r\n     * âŒ ä¸èƒ½åˆ¤æ–­æ˜¯å¦æ˜¯ Or åˆ†æ”¯é®è”½ï¼ˆè¿”å› false åªè¡¨ç¤ºä¸æ˜¯å·¦é€’å½’ï¼‰\r\n     *\r\n     * @param ruleName å½“å‰è§„åˆ™åç§°\r\n     * @param ruleStack è§„åˆ™è°ƒç”¨æ ˆ\r\n     * @returns true: ç¡®å®šæ˜¯å·¦é€’å½’, false: ä¸æ˜¯å·¦é€’å½’ï¼ˆä½†ä¸èƒ½ç¡®å®šæ˜¯ä»€ä¹ˆé—®é¢˜ï¼‰\r\n     */\r\n    private isDirectLeftRecursion(ruleName: string, ruleStack: string[]): boolean {\r\n        // æ£€æŸ¥è§„åˆ™æ ˆä¸­æ˜¯å¦æœ‰ä»»ä½•è§„åˆ™å‡ºç°äº† >= 2 æ¬¡\r\n        // è¿™å¯ä»¥æ£€æµ‹ç›´æ¥å·¦é€’å½’å’Œé—´æ¥å·¦é€’å½’\r\n\r\n        const ruleCounts = new Map<string, number>()\r\n\r\n        for (const rule of ruleStack) {\r\n            ruleCounts.set(rule, (ruleCounts.get(rule) || 0) + 1)\r\n        }\r\n\r\n        // å¦‚æœä»»ä½•è§„åˆ™å‡ºç° >= 2 æ¬¡ï¼Œè¯´æ˜æœ‰é€’å½’\r\n        for (const count of ruleCounts.values()) {\r\n            if (count >= 2) {\r\n                return true  // âœ… ç¡®å®šæ˜¯å·¦é€’å½’ï¼ˆç›´æ¥æˆ–é—´æ¥ï¼‰\r\n            }\r\n        }\r\n\r\n        // å¦åˆ™ï¼Œä¸æ˜¯å·¦é€’å½’\r\n        // ä½†å¯èƒ½æ˜¯å…¶ä»–é—®é¢˜ï¼šOr åˆ†æ”¯é®è”½ã€è§„åˆ™å®ç°é”™è¯¯ã€è¯­æ³•é”™è¯¯ç­‰\r\n        return false  // âŒ ä¸æ˜¯å·¦é€’å½’ï¼ˆä½†ä¸ç¡®å®šå…·ä½“æ˜¯ä»€ä¹ˆé—®é¢˜ï¼‰\r\n    }\r\n\r\n    /**\r\n     * æŠ›å‡ºå¾ªç¯é”™è¯¯ä¿¡æ¯\r\n     *\r\n     * @param ruleName å½“å‰è§„åˆ™åç§°\r\n     */\r\n    private throwLoopError(ruleName: string): never {\r\n        // ğŸ” åˆ†ææ¨¡å¼ï¼šä¸æŠ›å¼‚å¸¸ï¼Œç›´æ¥è¿”å›\r\n        if (this._analysisMode) {\r\n            // æ ‡è®°è§£æå¤±è´¥ï¼Œè®© RuleCollector çŸ¥é“è¿™ä¸ªè§„åˆ™æœ‰é—®é¢˜\r\n            this._parseSuccess = false\r\n            return undefined as never\r\n        }\r\n\r\n        // è·å–å½“å‰ token ä¿¡æ¯\r\n        const currentToken = this.curToken\r\n\r\n        // ä» parsedTokens è·å–ä¸Šä¸‹æ–‡ï¼ˆæœ€è¿‘ 2 ä¸ª tokenï¼‰\r\n        const tokenContext = this.getTokenContext(2)\r\n\r\n        // è·å–ç¼“å­˜ç»Ÿè®¡\r\n        const cacheStatsReport = this._cache.getStatsReport()\r\n\r\n        // ğŸ” åˆ†æå¾ªç¯ç±»å‹ï¼šçœŸæ­£çš„å·¦é€’å½’ vs Or åˆ†æ”¯é®è”½\r\n        const ruleStack = this.getRuleStack()\r\n        const isDirectLeftRecursion = this.isDirectLeftRecursion(ruleName, ruleStack)\r\n        const errorType = isDirectLeftRecursion ? 'left-recursion' : 'or-branch-shadowing'\r\n\r\n        // åˆ›å»ºå¾ªç¯é”™è¯¯ï¼ˆå¹³é“ºç»“æ„ï¼‰\r\n        throw this._errorHandler.createError({\r\n            type: errorType,\r\n            expected: '',\r\n            found: currentToken,\r\n            position: {\r\n                tokenIndex: this.currentTokenIndex,\r\n                codeIndex: this._codeIndex,\r\n                line: currentToken?.rowNum || this._codeLine,\r\n                column: currentToken?.columnStartNum || this._codeColumn\r\n            },\r\n            ruleStack: [...ruleStack],\r\n            loopRuleName: ruleName,\r\n            loopDetectionSet: Array.from(this.loopDetectionSet),\r\n            loopCstDepth: this.cstStack.length,\r\n            loopCacheStats: {\r\n                hits: cacheStatsReport.hits,\r\n                misses: cacheStatsReport.misses,\r\n                hitRate: cacheStatsReport.hitRate,\r\n                currentSize: cacheStatsReport.currentSize\r\n            },\r\n            loopTokenContext: tokenContext,\r\n            hint: 'æ£€æŸ¥è§„åˆ™å®šä¹‰ï¼Œç¡®ä¿åœ¨é€’å½’å‰æ¶ˆè´¹äº† token'\r\n        })\r\n    }\r\n\r\n    /**\r\n     * è§„åˆ™æ‰§è¡Œå…¥å£ï¼ˆç”± @SubhutiRule è£…é¥°å™¨è°ƒç”¨ï¼‰\r\n     * èŒè´£ï¼šå‰ç½®æ£€æŸ¥ â†’ å¾ªç¯æ£€æµ‹ â†’ Packrat ç¼“å­˜ â†’ æ ¸å¿ƒæ‰§è¡Œ â†’ åç½®å¤„ç†\r\n     */\r\n    private executeRuleWrapper(targetFun: Function, ruleName: string, className: string, ...args: any[]): SubhutiCst | undefined {\r\n        if (this.checkRuleIsThisClass(ruleName, className)) {\r\n            return\r\n        }\r\n        const isTopLevel = this.cstStack.length === 0\r\n\r\n        if (isTopLevel) {\r\n            this.initTopLevelData()\r\n        }\r\n\r\n        if (this.parserFail) {\r\n            return\r\n        }\r\n\r\n        const tokenIndex = this.currentTokenIndex\r\n        const key = `${ruleName}:${tokenIndex}`\r\n\r\n        // O(1) å¿«é€Ÿæ£€æµ‹æ˜¯å¦é‡å¤ï¼ˆå¾ªç¯æ£€æµ‹ï¼‰\r\n        if (this.loopDetectionSet.has(key)) {\r\n            this.throwLoopError(ruleName)\r\n        }\r\n\r\n        // å…¥æ ˆ\r\n        this.loopDetectionSet.add(key)\r\n\r\n        try {\r\n            const startTime = this._debugger?.onRuleEnter(ruleName, tokenIndex)\r\n\r\n            // Packrat Parsing ç¼“å­˜æŸ¥è¯¢\r\n            if (this.enableMemoization) {\r\n                const cached = this._cache.get(ruleName, tokenIndex)\r\n                if (cached !== undefined) {\r\n                    this._debugger?.onRuleExit(ruleName, true, startTime)\r\n\r\n                    // è§£æè®°å½•æ¨¡å¼ï¼šç¼“å­˜å‘½ä¸­æ—¶ä¹Ÿè¦è®°å½•èŠ‚ç‚¹ï¼Œå¹¶æ›´æ–°æ•´ä¸ªç¥–å…ˆé“¾çš„ endTokenIndex\r\n                    if (this.errorRecoveryMode && cached.endTokenIndex > tokenIndex) {\r\n                        // åˆ›å»ºè®°å½•èŠ‚ç‚¹ï¼Œå¤åˆ¶ç¼“å­˜ä¸­çš„ children\r\n                        const recordNode: ParseRecordNode = {\r\n                            name: ruleName,\r\n                            startTokenIndex: tokenIndex,\r\n                            endTokenIndex: cached.endTokenIndex,\r\n                            children: cached.recordNode?.children ? [...cached.recordNode.children] : []\r\n                        }\r\n                        const recordParent = this._parseRecordStack[this._parseRecordStack.length - 1]\r\n                        if (recordParent) {\r\n                            recordParent.children.push(recordNode)\r\n                        }\r\n                        // æ›´æ–°æ•´ä¸ªç¥–å…ˆé“¾çš„ endTokenIndex\r\n                        for (let i = this._parseRecordStack.length - 1; i >= 0; i--) {\r\n                            const ancestor = this._parseRecordStack[i]\r\n                            if (cached.endTokenIndex > ancestor.endTokenIndex) {\r\n                                ancestor.endTokenIndex = cached.endTokenIndex\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    const cst = this.applyCachedResult(cached)\r\n                    if (!cst.children?.length) {\r\n                        cst.children = undefined\r\n                    }\r\n                    return cst\r\n                }\r\n            }\r\n\r\n            // æ ¸å¿ƒæ‰§è¡Œ\r\n            const startTokenIndex = tokenIndex\r\n\r\n            // è§£æè®°å½•æ ‘ï¼šåˆ›å»ºèŠ‚ç‚¹å¹¶å…¥æ ˆï¼ˆåœ¨ executeRuleCore ä¹‹å‰ï¼‰\r\n            let recordNode: ParseRecordNode | null = null\r\n            if (this.errorRecoveryMode) {\r\n                recordNode = {\r\n                    name: ruleName,\r\n                    children: [],\r\n                    startTokenIndex: tokenIndex,\r\n                    endTokenIndex: tokenIndex\r\n                }\r\n                this._parseRecordStack.push(recordNode)\r\n            }\r\n\r\n            const cst = this.executeRuleCore(ruleName, targetFun, ...args)\r\n\r\n            // è§£æè®°å½•æ ‘ï¼šå‡ºæ ˆï¼Œåªæœ‰æ¶ˆè´¹äº† token æ‰æ·»åŠ åˆ°çˆ¶èŠ‚ç‚¹\r\n            if (this.errorRecoveryMode && recordNode) {\r\n                this._parseRecordStack.pop()\r\n                if (recordNode.endTokenIndex > recordNode.startTokenIndex) {\r\n                    const recordParent = this._parseRecordStack[this._parseRecordStack.length - 1]\r\n                    if (recordParent) {\r\n                        recordParent.children.push(recordNode)\r\n                    }\r\n                }\r\n            }\r\n\r\n            // ç¼“å­˜å­˜å‚¨\r\n            if (this.enableMemoization) {\r\n                const endTokenIndex = this.currentTokenIndex\r\n                const finalEndIndex = recordNode ? Math.max(recordNode.endTokenIndex, endTokenIndex) : endTokenIndex\r\n\r\n                // æå–æœ¬æ¬¡è§„åˆ™æ¶ˆè´¹çš„ token\r\n                const consumedTokens = this._parseSuccess\r\n                    ? this._parsedTokens.slice(startTokenIndex)\r\n                    : undefined\r\n\r\n                this._cache.set(ruleName, startTokenIndex, {\r\n                    endTokenIndex: finalEndIndex,\r\n                    cst: cst,\r\n                    parseSuccess: this._parseSuccess,\r\n                    recordNode: recordNode,\r\n                    parsedTokens: consumedTokens\r\n                })\r\n            }\r\n\r\n            this.onRuleExitDebugHandler(ruleName, cst, isTopLevel, startTime)\r\n\r\n            // é¡¶å±‚è§„åˆ™ï¼šæ£€æŸ¥æ˜¯å¦æ‰€æœ‰æºç éƒ½è¢«æ¶ˆè´¹\r\n            if (isTopLevel && this._parseSuccess) {\r\n                if (!this.isEof) {\r\n                    const nextToken = this.LA(1)\r\n                    throw new Error(\r\n                        `Parser internal error: parsing succeeded but source code remains unconsumed. ` +\r\n                        `Next token: \"${nextToken?.tokenValue}\" (${nextToken?.tokenName}) at position ${this._codeIndex}`\r\n                    )\r\n                }\r\n            }\r\n\r\n            // é¡¶å±‚è§„åˆ™å¤±è´¥æ—¶çš„é”™è¯¯å¤„ç†\r\n            if (isTopLevel && this.parserFail) {\r\n                this.handleTopLevelError(ruleName, startTokenIndex)\r\n            }\r\n\r\n            if (!cst.children?.length) {\r\n                cst.children = undefined\r\n            }\r\n            return cst\r\n        } finally {\r\n            // å‡ºæ ˆï¼ˆæ— è®ºæˆåŠŸã€returnã€å¼‚å¸¸éƒ½ä¼šæ‰§è¡Œï¼‰\r\n            this.loopDetectionSet.delete(key)\r\n        }\r\n    }\r\n\r\n    private initTopLevelData() {\r\n        // ã€é¡¶å±‚è§„åˆ™å¼€å§‹ã€‘é‡ç½®è§£æå™¨çŠ¶æ€\r\n        this._parseSuccess = true\r\n        this.cstStack.length = 0\r\n        this.loopDetectionSet.clear()\r\n        this._codeIndex = 0\r\n        this._codeLine = 1\r\n        this._codeColumn = 1\r\n        this._parsedTokens = []\r\n        this._tokenCache.clear()\r\n\r\n        // é‡ç½®è°ƒè¯•å™¨çš„ç¼“å­˜å’Œç»Ÿè®¡\r\n        this._debugger?.resetForNewParse?.(this._parsedTokens)\r\n    }\r\n\r\n    private checkRuleIsThisClass(ruleName: string, className: string): boolean {\r\n        if (this.hasOwnProperty(ruleName)) {\r\n            if (className !== this.className) {\r\n                return true\r\n            }\r\n        }\r\n    }\r\n\r\n    private onRuleExitDebugHandler(\r\n        ruleName: string,\r\n        cst: SubhutiCst | undefined,\r\n        isTopLevel: boolean,\r\n        startTime?: number\r\n    ): void {\r\n        if (cst && !cst.children?.length) {\r\n            cst.children = undefined\r\n        }\r\n\r\n        if (!isTopLevel) {\r\n            this._debugger?.onRuleExit(ruleName, false, startTime)\r\n        } else {\r\n            // é¡¶å±‚è§„åˆ™å®Œæˆï¼Œè¾“å‡ºè°ƒè¯•ä¿¡æ¯\r\n            if (this._debugger) {\r\n                if ('setCst' in this._debugger) {\r\n                    (this._debugger as any).setCst(cst)\r\n                }\r\n                (this._debugger as any)?.autoOutput?.()\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * æ‰§è¡Œè§„åˆ™å‡½æ•°æ ¸å¿ƒé€»è¾‘\r\n     * èŒè´£ï¼šåˆ›å»º CST â†’ æ‰§è¡Œè§„åˆ™ â†’ æˆåŠŸåˆ™æ·»åŠ åˆ°çˆ¶èŠ‚ç‚¹\r\n     */\r\n    private executeRuleCore(ruleName: string, targetFun: Function, ...args: any[]): SubhutiCst {\r\n        const cst = new SubhutiCst()\r\n        cst.name = ruleName\r\n        cst.children = []\r\n\r\n        this.cstStack.push(cst)\r\n\r\n        // æ‰§è¡Œè§„åˆ™å‡½æ•°\r\n        targetFun.apply(this, args)\r\n\r\n        this.cstStack.pop()\r\n\r\n        // æˆåŠŸæ—¶æ·»åŠ åˆ°çˆ¶èŠ‚ç‚¹å¹¶è®¾ç½®ä½ç½®\r\n        if (this._parseSuccess) {\r\n            const parentCst = this.cstStack[this.cstStack.length - 1]\r\n            if (parentCst) {\r\n                parentCst.children.push(cst)\r\n            }\r\n            this.setLocation(cst)\r\n        }\r\n\r\n        return cst\r\n    }\r\n\r\n    private setLocation(cst: SubhutiCst): void {\r\n        if (cst.children && cst.children[0]?.loc) {\r\n            const lastChild = cst.children[cst.children.length - 1]\r\n            cst.loc = {\r\n                type: cst.name,\r\n                start: cst.children[0].loc.start,\r\n                end: lastChild?.loc?.end || cst.children[0].loc.end\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Or è§„åˆ™ - é¡ºåºé€‰æ‹©ï¼ˆPEG é£æ ¼ï¼‰\r\n     *\r\n     * æ ¸å¿ƒé€»è¾‘ï¼š\r\n     * - ä¾æ¬¡å°è¯•æ¯ä¸ªåˆ†æ”¯ï¼Œç¬¬ä¸€ä¸ªæˆåŠŸçš„åˆ†æ”¯ç”Ÿæ•ˆ\r\n     * - æ‰€æœ‰åˆ†æ”¯éƒ½å¤±è´¥åˆ™æ•´ä½“å¤±è´¥\r\n     *\r\n     * ä¼˜åŒ–ï¼šåªæœ‰æ¶ˆè´¹äº† token æ‰éœ€è¦å›æº¯ï¼ˆæ²¡æ¶ˆè´¹ = çŠ¶æ€æ²¡å˜ï¼‰\r\n     */\r\n    Or(alternatives: SubhutiParserOr[]): void {\r\n        if (this.parserFail) {\r\n            return\r\n        }\r\n\r\n        const savedState = this.saveState()\r\n        const startCodeIndex = this._codeIndex\r\n        const totalCount = alternatives.length\r\n        const parentRuleName = this.curCst?.name || 'Unknown'\r\n\r\n        // è¿›å…¥ Orï¼ˆæ•´ä¸ª Or è°ƒç”¨å¼€å§‹ï¼‰\r\n        this._debugger?.onOrEnter?.(parentRuleName, startCodeIndex)\r\n\r\n        for (let i = 0; i < totalCount; i++) {\r\n            const alt = alternatives[i]\r\n            const isLast = i === totalCount - 1\r\n\r\n            // è¿›å…¥ Or åˆ†æ”¯\r\n            this._debugger?.onOrBranch?.(i, totalCount, parentRuleName)\r\n\r\n            alt.alt()\r\n\r\n            // é€€å‡º Or åˆ†æ”¯ï¼ˆæ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼‰\r\n            this._debugger?.onOrBranchExit?.(parentRuleName, i)\r\n\r\n            if (this._parseSuccess) {\r\n                // é€€å‡º Orï¼ˆæ•´ä¸ª Or è°ƒç”¨æˆåŠŸç»“æŸï¼‰\r\n                this._debugger?.onOrExit?.(parentRuleName)\r\n                return\r\n            }\r\n\r\n            // å‰ N-1 ä¸ªåˆ†æ”¯ï¼šå¤±è´¥åå›æº¯å¹¶é‡ç½®çŠ¶æ€ï¼Œç»§ç»­å°è¯•ä¸‹ä¸€ä¸ª\r\n            if (!isLast) {\r\n                this.recordPartialMatchAndRestore(savedState, startCodeIndex)\r\n                this._parseSuccess = true\r\n            }\r\n            // æœ€åä¸€ä¸ªåˆ†æ”¯ï¼šå¤±è´¥åä¸å›æº¯ï¼Œä¿æŒå¤±è´¥çŠ¶æ€\r\n        }\r\n\r\n        // é€€å‡º Orï¼ˆæ•´ä¸ª Or è°ƒç”¨å¤±è´¥ç»“æŸï¼‰\r\n        this._debugger?.onOrExit?.(parentRuleName)\r\n    }\r\n\r\n    /**\r\n     * Many è§„åˆ™ - 0æ¬¡æˆ–å¤šæ¬¡ï¼ˆEBNF { ... }ï¼‰\r\n     *\r\n     * å¾ªç¯æ‰§è¡Œç›´åˆ°å¤±è´¥æˆ–æ²¡æ¶ˆè´¹ token\r\n     */\r\n    Many(fn: RuleFunction): void {\r\n        while (this.tryAndRestore(fn)) {\r\n            // ç»§ç»­å¾ªç¯\r\n        }\r\n    }\r\n\r\n    /**\r\n     * å¸¦å®¹é”™çš„ Many è§„åˆ™ï¼ˆä½¿ç”¨è§£æè®°å½•æ ‘ï¼‰\r\n     * - å½“å…¨å±€ errorRecoveryMode å¼€å¯æ—¶ï¼Œè§£æå¤±è´¥ä¼šå°è¯•æ¢å¤å¹¶ç»§ç»­\r\n     * - ä½¿ç”¨è§£æè®°å½•æ ‘è®°å½•æ‰€æœ‰è§£æå°è¯•ï¼Œåªå¢ä¸åˆ \r\n     * - å¤±è´¥æ—¶ä»è§£æè®°å½•æ ‘æå–æœ€ä¼˜è·¯å¾„æ¢å¤ CST\r\n     * @param fn è¦æ‰§è¡Œçš„è§„åˆ™å‡½æ•°\r\n     */\r\n    ManyWithRecovery(fn: RuleFunction): void {\r\n        if (!this.errorRecoveryMode) {\r\n            throw new Error('éå®¹é”™æ¨¡å¼ä¸åº”è¯¥è¿›å…¥ ManyWithRecovery')\r\n        }\r\n\r\n        // æ¸…ç†è®°å½•\r\n        this._unparsedTokens.length = 0\r\n\r\n        while (!this.parserFailOrIsEof) {\r\n            const startTokenIndex = this.currentTokenIndex\r\n\r\n            // å¯ç”¨è§£æè®°å½•ï¼Œä¸ºæœ¬æ¬¡è¿­ä»£åˆ›å»ºæ ¹èŠ‚ç‚¹\r\n            this._parseRecordRoot = {\r\n                name: '__ParseRecordRoot__',\r\n                children: [],\r\n                startTokenIndex: startTokenIndex,\r\n                endTokenIndex: startTokenIndex\r\n            }\r\n            this._parseRecordStack = [this._parseRecordRoot]\r\n\r\n            const success = this.tryAndRestore(fn)\r\n\r\n            if (success) {\r\n                // æˆåŠŸï¼Œæ¸…ç†è§£æè®°å½•æ ‘ï¼Œç»§ç»­ä¸‹ä¸€ä¸ª\r\n                this._parseRecordRoot = null\r\n                this._parseRecordStack = []\r\n                continue\r\n            }\r\n\r\n            // è§£æå¤±è´¥ï¼Œå°è¯•ä»è§£æè®°å½•æ ‘æ¢å¤\r\n            const syncIndex = this.findNextSyncPoint(this._codeIndex + 1)\r\n            const recoveredCST = this.recoverFromParseRecord(this._parseRecordRoot!, syncIndex)\r\n\r\n            if (recoveredCST && recoveredCST.children && recoveredCST.children.length > 0) {\r\n                // æ¢å¤æˆåŠŸï¼Œå°† CST æ·»åŠ åˆ°å½“å‰èŠ‚ç‚¹\r\n                const currentCst = this.curCst\r\n                if (currentCst) {\r\n                    currentCst.children.push(...recoveredCST.children)\r\n                }\r\n                // ä»æ¢å¤çš„ä½ç½®ç»§ç»­ï¼ˆéœ€è¦ä» parsedTokens æ¢å¤ codeIndexï¼‰\r\n                const maxTokenIndex = this.getParseRecordMaxEndIndex(this._parseRecordRoot!, syncIndex)\r\n                if (maxTokenIndex > 0 && maxTokenIndex <= this._parsedTokens.length) {\r\n                    const lastToken = this._parsedTokens[maxTokenIndex - 1]\r\n                    this._codeIndex = lastToken.index + lastToken.tokenValue.length\r\n                }\r\n            } else {\r\n                // æ²¡æœ‰å¯æ¢å¤çš„å†…å®¹ï¼Œè·³è¿‡ä¸€ä¸ªå­—ç¬¦ç»§ç»­\r\n                this._codeIndex++\r\n            }\r\n\r\n            // æ¸…ç†è§£æè®°å½•æ ‘\r\n            this._parseRecordRoot = null\r\n            this._parseRecordStack = []\r\n            this._parseSuccess = true\r\n        }\r\n\r\n        // å‡ºå£ï¼šå¦‚æœæœ‰æœªè§£æçš„ tokensï¼Œæ ‡è®°è§£æå¤±è´¥\r\n        if (this._unparsedTokens.length > 0) {\r\n            this._parseSuccess = false\r\n        }\r\n    }\r\n\r\n    /**\r\n     * ä»è§£æè®°å½•æ ‘æ¢å¤ CST\r\n     * æ‰¾åˆ° endTokenIndex <= maxIndex çš„æœ€æ·±è·¯å¾„ï¼Œè½¬æ¢ä¸º CST\r\n     */\r\n    private recoverFromParseRecord(root: ParseRecordNode, maxIndex: number): SubhutiCst | null {\r\n        if (!root || root.children.length === 0) {\r\n            return null\r\n        }\r\n\r\n        const cst = new SubhutiCst()\r\n        cst.name = root.name\r\n        cst.children = this.parseRecordChildrenToCST(root.children, maxIndex)\r\n\r\n        if (!cst.children || cst.children.length === 0) {\r\n            return null\r\n        }\r\n\r\n        return cst\r\n    }\r\n\r\n    /**\r\n     * å°†è§£æè®°å½•æ ‘å­èŠ‚ç‚¹è½¬æ¢ä¸º CST å­èŠ‚ç‚¹\r\n     *\r\n     * é€‰æ‹©ç­–ç•¥ï¼š\r\n     * 1. æŒ‰ startTokenIndex åˆ†ç»„ï¼ˆåŒä¸€ä½ç½®å¼€å§‹çš„æ˜¯ Or çš„ä¸åŒåˆ†æ”¯ï¼‰\r\n     * 2. å¯¹äºæ¯ç»„ï¼Œé€‰æ‹© endTokenIndex <= maxIndex ä¸”æœ€å¤§çš„\r\n     * 3. å¦‚æœæœ‰å¤šä¸ªç›¸åŒæ·±åº¦çš„ï¼Œé€‰æ‹©æœ€åä¸€ä¸ª\r\n     */\r\n    private parseRecordChildrenToCST(nodes: ParseRecordNode[], maxIndex: number): SubhutiCst[] {\r\n        // æŒ‰ startTokenIndex åˆ†ç»„\r\n        const groups = new Map<number, ParseRecordNode[]>()\r\n        for (const node of nodes) {\r\n            // è·³è¿‡è¶…è¿‡åŒæ­¥ç‚¹çš„èŠ‚ç‚¹\r\n            if (node.endTokenIndex > maxIndex) {\r\n                continue\r\n            }\r\n            const key = node.startTokenIndex\r\n            if (!groups.has(key)) {\r\n                groups.set(key, [])\r\n            }\r\n            groups.get(key)!.push(node)\r\n        }\r\n\r\n        // å¯¹æ¯ç»„é€‰æ‹©æœ€ä¼˜èŠ‚ç‚¹\r\n        const selectedNodes: ParseRecordNode[] = []\r\n        for (const [startIdx, group] of groups) {\r\n            // é€‰æ‹© endTokenIndex æœ€å¤§çš„ï¼Œå¦‚æœç›¸åŒåˆ™é€‰æœ€åä¸€ä¸ªï¼ˆå…œåº•åˆ†æ”¯ï¼Œæ›´é€šç”¨ï¼‰\r\n            let best: ParseRecordNode | null = null\r\n            for (const node of group) {\r\n                if (!best || node.endTokenIndex >= best.endTokenIndex) {\r\n                    best = node\r\n                }\r\n            }\r\n            if (best) {\r\n                selectedNodes.push(best)\r\n            }\r\n        }\r\n\r\n        // æŒ‰ startTokenIndex æ’åºï¼Œä¿è¯é¡ºåºæ­£ç¡®\r\n        selectedNodes.sort((a, b) => a.startTokenIndex - b.startTokenIndex)\r\n\r\n        // è½¬æ¢ä¸º CST\r\n        return selectedNodes.map(node => this.parseRecordNodeToCST(node, maxIndex))\r\n    }\r\n\r\n    /**\r\n     * å°†å•ä¸ªè§£æè®°å½•èŠ‚ç‚¹è½¬æ¢ä¸º CST èŠ‚ç‚¹\r\n     */\r\n    private parseRecordNodeToCST(node: ParseRecordNode, maxIndex: number): SubhutiCst {\r\n        const cst = new SubhutiCst()\r\n        cst.name = node.name\r\n\r\n        // å¦‚æœæ˜¯ token èŠ‚ç‚¹\r\n        if (node.token) {\r\n            cst.value = node.value\r\n            cst.loc = {\r\n                type: node.token.tokenName,\r\n                value: node.token.tokenValue,\r\n                start: {\r\n                    index: node.token.index || 0,\r\n                    line: node.token.rowNum || 0,\r\n                    column: node.token.columnStartNum || 0\r\n                },\r\n                end: {\r\n                    index: (node.token.index || 0) + node.token.tokenValue.length,\r\n                    line: node.token.rowNum || 0,\r\n                    column: node.token.columnEndNum || 0\r\n                }\r\n            }\r\n        }\r\n\r\n        // é€’å½’è½¬æ¢å­èŠ‚ç‚¹\r\n        if (node.children.length > 0) {\r\n            cst.children = this.parseRecordChildrenToCST(node.children, maxIndex)\r\n            if (cst.children.length === 0) {\r\n                cst.children = undefined\r\n            } else {\r\n                // è®¾ç½®ä½ç½®ä¿¡æ¯\r\n                this.setLocation(cst)\r\n            }\r\n        }\r\n\r\n        return cst\r\n    }\r\n\r\n    /**\r\n     * è·å–è§£æè®°å½•æ ‘ä¸­ <= maxIndex çš„æœ€å¤§ endTokenIndex\r\n     */\r\n    private getParseRecordMaxEndIndex(root: ParseRecordNode, maxIndex: number): number {\r\n        let maxEnd = root.endTokenIndex <= maxIndex ? root.endTokenIndex : 0\r\n\r\n        for (const child of root.children) {\r\n            const childMax = this.getParseRecordMaxEndIndex(child, maxIndex)\r\n            if (childMax > maxEnd) {\r\n                maxEnd = childMax\r\n            }\r\n        }\r\n\r\n        return maxEnd\r\n    }\r\n\r\n    /**\r\n     * æ‰¾åˆ°ä¸‹ä¸€ä¸ªåŒæ­¥ç‚¹ï¼ˆè¯­å¥å¼€å§‹ tokenï¼‰\r\n     * @param fromIndex ä»å“ªä¸ªæºç ä½ç½®å¼€å§‹æŸ¥æ‰¾\r\n     * @returns åŒæ­¥ç‚¹çš„æºç ä½ç½®ï¼Œå¦‚æœæ²¡æ‰¾åˆ°è¿”å›æºç æœ«å°¾\r\n     */\r\n    protected findNextSyncPoint(fromIndex: number): number {\r\n        // ä»æŒ‡å®šä½ç½®å¼€å§‹ï¼Œå°è¯•è§£ææ¯ä¸ªä½ç½®çš„ token\r\n        for (let i = fromIndex; i < this._sourceCode.length; i++) {\r\n            const entry = this._getOrParseToken(i, this._codeLine, this._codeColumn, this._defaultGoal)\r\n            if (entry && this._syncTokens.has(entry.token.tokenName)) {\r\n                return i\r\n            }\r\n        }\r\n        return this._sourceCode.length  // æ²¡æ‰¾åˆ°ï¼Œè¿”å›æºç æœ«å°¾\r\n    }\r\n\r\n    /**\r\n     * åˆ›å»º ErrorNodeï¼ŒåŒ…å«æŒ‡å®šèŒƒå›´å†…çš„ token\r\n     * @param startIndex èµ·å§‹æºç ä½ç½®ï¼ˆåŒ…å«ï¼‰\r\n     * @param endIndex ç»“æŸæºç ä½ç½®ï¼ˆä¸åŒ…å«ï¼‰\r\n     * @returns ErrorNode CST èŠ‚ç‚¹\r\n     */\r\n    protected createErrorNode(startIndex: number, endIndex: number): SubhutiCst {\r\n        const errorNode = new SubhutiCst()\r\n        errorNode.name = 'ErrorNode'\r\n        errorNode.children = []\r\n\r\n        // ä» parsedTokens ä¸­æ‰¾å‡ºåœ¨èŒƒå›´å†…çš„ tokens\r\n        for (const token of this._parsedTokens) {\r\n            if (token.index >= startIndex && token.index < endIndex) {\r\n                const tokenNode = new SubhutiCst()\r\n                tokenNode.name = token.tokenName\r\n                tokenNode.value = token.tokenValue\r\n                tokenNode.loc = {\r\n                    type: token.tokenName,\r\n                    value: token.tokenValue,\r\n                    start: {\r\n                        index: token.index,\r\n                        line: token.rowNum,\r\n                        column: token.columnStartNum\r\n                    },\r\n                    end: {\r\n                        index: token.index + (token.tokenValue?.length || 0),\r\n                        line: token.rowNum,\r\n                        column: token.columnEndNum\r\n                    }\r\n                }\r\n                errorNode.children.push(tokenNode)\r\n            }\r\n        }\r\n\r\n        // è®¾ç½® ErrorNode çš„ä½ç½®ä¿¡æ¯\r\n        if (errorNode.children.length > 0) {\r\n            const first = errorNode.children[0]\r\n            const last = errorNode.children[errorNode.children.length - 1]\r\n            errorNode.loc = {\r\n                type: 'ErrorNode',\r\n                start: first.loc.start,\r\n                end: last.loc.end\r\n            }\r\n        }\r\n\r\n        return errorNode\r\n    }\r\n\r\n    /**\r\n     * Option è§„åˆ™ - 0æ¬¡æˆ–1æ¬¡ï¼ˆEBNF [ ... ]ï¼‰\r\n     *\r\n     * å°è¯•æ‰§è¡Œä¸€æ¬¡ï¼Œå¤±è´¥åˆ™å›æº¯ï¼Œä¸å½±å“æ•´ä½“è§£æçŠ¶æ€\r\n     */\r\n    Option(fn: RuleFunction): void {\r\n        this.tryAndRestore(fn)\r\n    }\r\n\r\n    /**\r\n     * AtLeastOne è§„åˆ™ - 1æ¬¡æˆ–å¤šæ¬¡\r\n     *\r\n     * ç¬¬ä¸€æ¬¡å¿…é¡»æˆåŠŸï¼Œåç»­å¾ªç¯æ‰§è¡Œç›´åˆ°å¤±è´¥\r\n     */\r\n    AtLeastOne(fn: RuleFunction): void {\r\n        if (this.parserFail) {\r\n            return\r\n        }\r\n\r\n        fn()\r\n\r\n        while (this.tryAndRestore(fn)) {\r\n            // ç»§ç»­å¾ªç¯\r\n        }\r\n    }\r\n\r\n    /**\r\n     * é¡¶å±‚è§„åˆ™å¤±è´¥æ—¶çš„é”™è¯¯å¤„ç†\r\n     *\r\n     * @param ruleName è§„åˆ™å\r\n     * @param startIndex è§„åˆ™å¼€å§‹æ—¶çš„æºç ä½ç½®\r\n     */\r\n    private handleTopLevelError(ruleName: string, startIndex: number): void {\r\n        // åˆ†ææ¨¡å¼ï¼šä¸æŠ›é”™ï¼Œç”¨äºè¯­æ³•éªŒè¯\r\n        if (this._analysisMode) {\r\n            return\r\n        }\r\n\r\n        // æ­£å¸¸æ¨¡å¼ï¼šæŠ›å‡ºè§£æé”™è¯¯\r\n        const noTokenConsumed = this.currentTokenIndex === startIndex\r\n        const found = this.curToken\r\n\r\n        throw this._errorHandler.createError({\r\n            type: 'parsing',\r\n            expected: noTokenConsumed ? 'valid syntax' : 'EOF (end of file)',\r\n            found: found,\r\n            position: {\r\n                tokenIndex: this.currentTokenIndex,\r\n                codeIndex: this._codeIndex,\r\n                line: found?.rowNum ?? this._codeLine,\r\n                column: found?.columnStartNum ?? this._codeColumn\r\n            },\r\n            ruleStack: this.getRuleStack().length > 0 ? this.getRuleStack() : [ruleName]\r\n        })\r\n    }\r\n\r\n    get parserFailOrIsEof() {\r\n        return this.parserFail || this.isEof\r\n    }\r\n\r\n    /**\r\n     * æ¶ˆè´¹ tokenï¼ˆæ™ºèƒ½é”™è¯¯ç®¡ç†ï¼‰\r\n     * - å¤±è´¥æ—¶è¿”å› undefinedï¼Œä¸æŠ›å¼‚å¸¸\r\n     * - æ”¯æŒä¼ å…¥è¯æ³•ç›®æ ‡ï¼ˆå¯é€‰ï¼‰\r\n     */\r\n    consume(tokenName: string, goal?: LexicalGoal): SubhutiCst | undefined {\r\n        if (this.parserFail) {\r\n            return\r\n        }\r\n\r\n        if (this.isEof) {\r\n            this._parseSuccess = false\r\n            return\r\n        }\r\n\r\n        // è·å–å½“å‰ token\r\n        const actualGoal = goal ?? this._defaultGoal\r\n        const entry = this._getOrParseToken(\r\n            this._codeIndex,\r\n            this._codeLine,\r\n            this._codeColumn,\r\n            actualGoal\r\n        )\r\n\r\n        if (!entry) {\r\n            this._parseSuccess = false\r\n            return\r\n        }\r\n\r\n        const token = entry.token\r\n\r\n        if (token.tokenName !== tokenName) {\r\n            this._parseSuccess = false\r\n\r\n            this._debugger?.onTokenConsume(\r\n                this._codeIndex,\r\n                token.tokenValue,\r\n                token.tokenName,\r\n                tokenName,\r\n                false\r\n            )\r\n\r\n            return\r\n        }\r\n\r\n        this._debugger?.onTokenConsume(\r\n            this._codeIndex,\r\n            token.tokenValue,\r\n            token.tokenName,\r\n            tokenName,\r\n            true\r\n        )\r\n\r\n        const cst = this.generateCstByToken(token)\r\n\r\n        // æ›´æ–°æ¨¡æ¿æ·±åº¦\r\n        if (token.tokenName === 'TemplateHead') {\r\n            this._templateDepth++\r\n        } else if (token.tokenName === 'TemplateTail') {\r\n            this._templateDepth--\r\n        }\r\n\r\n        // æ›´æ–°ä½ç½®\r\n        this._codeIndex = entry.nextCodeIndex\r\n        this._codeLine = entry.nextLine\r\n        this._codeColumn = entry.nextColumn\r\n        this._lastTokenName = entry.lastTokenName\r\n\r\n        // æ·»åŠ åˆ°å·²è§£æåˆ—è¡¨\r\n        this._parsedTokens.push(token)\r\n\r\n        return cst\r\n    }\r\n\r\n    private generateCstByToken(token: SubhutiMatchToken): SubhutiCst {\r\n        const cst = new SubhutiCst()\r\n        cst.name = token.tokenName\r\n        cst.value = token.tokenValue\r\n        cst.loc = {\r\n            type: token.tokenName,\r\n            value: token.tokenValue,\r\n            start: {\r\n                index: token.index || 0,\r\n                line: token.rowNum || 0,\r\n                column: token.columnStartNum || 0\r\n            },\r\n            end: {\r\n                index: (token.index || 0) + token.tokenValue.length,\r\n                line: token.rowNum || 0,\r\n                column: token.columnEndNum || 0\r\n            }\r\n        }\r\n\r\n        // æ·»åŠ åˆ°å½“å‰ CST\r\n        const currentCst = this.curCst\r\n        if (currentCst) {\r\n            currentCst.children.push(cst)\r\n        }\r\n\r\n        // è§£æè®°å½•æ ‘ï¼šè®°å½• token å¹¶æ›´æ–°ç¥–å…ˆçš„ endTokenIndex\r\n        if (this.errorRecoveryMode) {\r\n            const newEndIndex = this.currentTokenIndex  // consume åä¼š +1\r\n            const tokenNode: ParseRecordNode = {\r\n                name: token.tokenName,\r\n                children: [],\r\n                startTokenIndex: this.lastTokenIndex,  // consume åçš„ç´¢å¼•\r\n                endTokenIndex: newEndIndex,\r\n                token: token,\r\n                value: token.tokenValue\r\n            }\r\n            const recordCurrent = this._parseRecordStack[this._parseRecordStack.length - 1]\r\n            if (recordCurrent) {\r\n                recordCurrent.children.push(tokenNode)\r\n            }\r\n            // æ›´æ–°æ‰€æœ‰ç¥–å…ˆçš„ endTokenIndex\r\n            for (const ancestor of this._parseRecordStack) {\r\n                ancestor.endTokenIndex = newEndIndex\r\n            }\r\n        }\r\n\r\n        return cst\r\n    }\r\n\r\n    // å›æº¯æœºåˆ¶\r\n    private saveState(): SubhutiBackData {\r\n        const currentCst = this.curCst\r\n        return {\r\n            codeIndex: this._codeIndex,\r\n            codeLine: this._codeLine,\r\n            codeColumn: this._codeColumn,\r\n            lastTokenName: this._lastTokenName,\r\n            curCstChildrenLength: currentCst?.children?.length || 0,\r\n            parsedTokensLength: this._parsedTokens.length\r\n        }\r\n    }\r\n\r\n    private restoreState(backData: SubhutiBackData): void {\r\n        const fromIndex = this._codeIndex\r\n        const toIndex = backData.codeIndex\r\n\r\n        if (fromIndex !== toIndex) {\r\n            this._debugger?.onBacktrack?.(fromIndex, toIndex)\r\n        }\r\n\r\n        this._codeIndex = backData.codeIndex\r\n        this._codeLine = backData.codeLine\r\n        this._codeColumn = backData.codeColumn\r\n        this._lastTokenName = backData.lastTokenName\r\n\r\n        // æ¢å¤ parsedTokens\r\n        this._parsedTokens.length = backData.parsedTokensLength\r\n\r\n        const currentCst = this.curCst\r\n        if (currentCst) {\r\n            currentCst.children.length = backData.curCstChildrenLength\r\n        }\r\n    }\r\n\r\n    /**\r\n     * ã€å®¹é”™æ¨¡å¼ã€‘è®°å½•éƒ¨åˆ†åŒ¹é…å¹¶å›æº¯\r\n     * - è§£æè®°å½•æ ‘æ–¹æ¡ˆä¸­ï¼Œéƒ¨åˆ†åŒ¹é…ç”± _parseRecordRoot è®°å½•\r\n     * - è¿™é‡Œåªéœ€è¦å›æº¯ CSTï¼ˆè§£æè®°å½•æ ‘æ˜¯åªå¢ä¸åˆ çš„ï¼‰\r\n     *\r\n     * @param savedState ä¿å­˜çš„çŠ¶æ€\r\n     * @param startCodeIndex èµ·å§‹æºç ä½ç½®\r\n     */\r\n    private recordPartialMatchAndRestore(savedState: SubhutiBackData, startCodeIndex: number): void {\r\n        this.restoreState(savedState)\r\n    }\r\n\r\n    /**\r\n     * æ£€æŸ¥æ˜¯å¦å·²åˆ°è¾¾æºç æœ«å°¾\r\n     */\r\n    get isEof(): boolean {\r\n        const entry = this._getOrParseToken(\r\n            this._codeIndex,\r\n            this._codeLine,\r\n            this._codeColumn,\r\n            this._defaultGoal\r\n        )\r\n        return entry === null\r\n    }\r\n\r\n    /**\r\n     * å°è¯•æ‰§è¡Œå‡½æ•°ï¼Œå¤±è´¥æ—¶è‡ªåŠ¨å›æº¯å¹¶é‡ç½®çŠ¶æ€\r\n     *\r\n     * @param fn è¦æ‰§è¡Œçš„å‡½æ•°\r\n     * @returns true: æˆåŠŸä¸”æ¶ˆè´¹äº† tokenï¼Œfalse: å¤±è´¥æˆ–æ²¡æ¶ˆè´¹ token\r\n     */\r\n    private tryAndRestore(fn: () => void): boolean {\r\n        if (this.parserFailOrIsEof) {\r\n            return false\r\n        }\r\n        const savedState = this.saveState()\r\n        const startIndex = this._codeIndex\r\n\r\n        fn()\r\n\r\n        if (this.parserFail) {\r\n            // è®°å½•éƒ¨åˆ†åŒ¹é…å¹¶å›æº¯\r\n            this.recordPartialMatchAndRestore(savedState, startIndex)\r\n            this._parseSuccess = true\r\n            return false\r\n        }\r\n\r\n        // æˆåŠŸä½†æ²¡æ¶ˆè´¹ token â†’ è¿”å› falseï¼ˆé˜²æ­¢æ— é™å¾ªç¯ï¼‰\r\n        return this._codeIndex !== startIndex\r\n    }\r\n\r\n    /**\r\n     * åº”ç”¨ç¼“å­˜ç»“æœï¼ˆæ¢å¤çŠ¶æ€ï¼‰\r\n     */\r\n    private applyCachedResult(cached: SubhutiPackratCacheResult): SubhutiCst {\r\n        // æ¢å¤æ¶ˆè´¹çš„ token\r\n        if (cached.parsedTokens && cached.parsedTokens.length > 0) {\r\n            this._parsedTokens.push(...cached.parsedTokens)\r\n\r\n            // ä»æœ€åä¸€ä¸ª token æ¢å¤è¯æ³•åˆ†æä½ç½®\r\n            const lastToken = cached.parsedTokens[cached.parsedTokens.length - 1]\r\n            this._codeIndex = lastToken.index + lastToken.tokenValue.length\r\n            this._codeLine = lastToken.rowNum\r\n            this._codeColumn = lastToken.columnEndNum\r\n            this._lastTokenName = lastToken.tokenName\r\n        }\r\n\r\n        this._parseSuccess = cached.parseSuccess\r\n\r\n        // æˆåŠŸæ—¶æ·»åŠ åˆ°çˆ¶èŠ‚ç‚¹\r\n        if (cached.parseSuccess) {\r\n            const parentCst = this.cstStack[this.cstStack.length - 1]\r\n            if (parentCst) {\r\n                parentCst.children.push(cached.cst)\r\n            }\r\n        }\r\n\r\n        return cached.cst\r\n    }\r\n\r\n    // ============================================\r\n    // Error Helper Methods\r\n    // ============================================\r\n\r\n    /**\r\n     * è·å– token ä¸Šä¸‹æ–‡ï¼ˆä» parsedTokens è·å–æœ€è¿‘çš„ N ä¸ª tokenï¼‰\r\n     *\r\n     * @param contextSize - ä¸Šä¸‹æ–‡å¤§å°ï¼ˆé»˜è®¤ 2ï¼‰\r\n     * @returns token ä¸Šä¸‹æ–‡æ•°ç»„\r\n     */\r\n    private getTokenContext(contextSize: number = 2): SubhutiMatchToken[] {\r\n        const tokens = this._parsedTokens\r\n        const len = tokens.length\r\n        const start = Math.max(0, len - contextSize)\r\n        return tokens.slice(start)\r\n    }\r\n\r\n    /**\r\n     * ç”Ÿæˆå½“å‰è§„åˆ™è·¯å¾„çš„å­—ç¬¦ä¸²ï¼ˆç”¨äºé”™è¯¯ä¿¡æ¯ï¼‰\r\n     *\r\n     * @returns æ ¼å¼åŒ–åçš„è§„åˆ™è·¯å¾„å­—ç¬¦ä¸²æ•°ç»„\r\n     */\r\n    private formatCurrentRulePath(): string[] {\r\n        if (!this._debugger) {\r\n            // å¦‚æœæ²¡æœ‰è°ƒè¯•å™¨ï¼Œä½¿ç”¨ç®€å•æ ¼å¼\r\n            return this.formatSimpleRulePath()\r\n        }\r\n\r\n        // ä½¿ç”¨è°ƒè¯•å™¨çš„æ ¼å¼åŒ–æ–¹æ³•\r\n        const ruleStack = this._debugger.ruleStack\r\n        if (!ruleStack || ruleStack.length === 0) {\r\n            return ['  (empty)']\r\n        }\r\n\r\n        return SubhutiDebugRuleTracePrint.formatPendingOutputs_NonCache_Impl(ruleStack)\r\n    }\r\n\r\n    /**\r\n     * ç®€å•æ ¼å¼åŒ–è§„åˆ™è·¯å¾„ï¼ˆå½“æ²¡æœ‰è°ƒè¯•å™¨æ—¶ï¼‰\r\n     */\r\n    private formatSimpleRulePath(): string[] {\r\n        const ruleStack = this.getRuleStack()\r\n        if (ruleStack.length === 0) {\r\n            return ['  (empty)']\r\n        }\r\n\r\n        const lines: string[] = []\r\n        for (let i = 0; i < ruleStack.length; i++) {\r\n            const rule = ruleStack[i]\r\n            const isLast = i === ruleStack.length - 1\r\n            const indent = '  '.repeat(i)\r\n            const connector = i === 0 ? '' : 'â””â”€ '\r\n            const marker = isLast ? ' â† å½“å‰ä½ç½®' : ''\r\n\r\n            lines.push(`  ${indent}${connector}${rule}${marker}`)\r\n        }\r\n\r\n        return lines\r\n    }\r\n\r\n    /**\r\n     * åˆ›å»ºæ— é™å¾ªç¯é”™è¯¯\r\n     *\r\n     * @param ruleName - è§„åˆ™åç§°\r\n     * @param hint - ä¿®å¤æç¤º\r\n     * @returns ParsingError å®ä¾‹ï¼ˆåˆ†ææ¨¡å¼ä¸‹è¿”å› nullï¼‰\r\n     */\r\n    private createInfiniteLoopError(ruleName: string, hint: string): ParsingError {\r\n        // ğŸ” åˆ†ææ¨¡å¼ï¼šä¸åˆ›å»ºé”™è¯¯ï¼Œæ ‡è®°å¤±è´¥å¹¶è¿”å› null\r\n        if (this._analysisMode) {\r\n            this._parseSuccess = false\r\n            return null as any  // åˆ†ææ¨¡å¼ä¸‹ä¸ä¼šçœŸæ­£ä½¿ç”¨è¿™ä¸ªè¿”å›å€¼\r\n        }\r\n\r\n        // ç”Ÿæˆè§„åˆ™è·¯å¾„\r\n        const rulePathLines = this.formatCurrentRulePath()\r\n        const rulePath = rulePathLines.join('\\n')\r\n\r\n        // ğŸ” æ£€æµ‹æ˜¯å¦æ˜¯å·¦é€’å½’ï¼ˆå‡†ç¡®åˆ¤æ–­ï¼‰\r\n        const ruleStack = this.getRuleStack()\r\n        const isLeftRecursion = this.isDirectLeftRecursion(ruleName, ruleStack)\r\n\r\n        // âœ… åªæœ‰ç¡®å®šæ˜¯å·¦é€’å½’æ—¶æ‰ä½¿ç”¨ 'left-recursion' ç±»å‹\r\n        // âŒ ä¸ç¡®å®šçš„æƒ…å†µä½¿ç”¨ 'infinite-loop'ï¼Œä¸æ–­è¨€æ˜¯ Or é®è”½\r\n        const errorType = isLeftRecursion ? 'left-recursion' : 'infinite-loop'\r\n\r\n        return this._errorHandler.createError({\r\n            type: errorType,\r\n            expected: '',\r\n            found: this.curToken,\r\n            position: {\r\n                tokenIndex: this.currentTokenIndex,\r\n                codeIndex: this._codeIndex,\r\n                line: this.curToken?.rowNum || this._codeLine,\r\n                column: this.curToken?.columnStartNum || this._codeColumn\r\n            },\r\n            ruleStack: [...ruleStack],\r\n            loopRuleName: ruleName,\r\n            loopDetectionSet: [],\r\n            loopCstDepth: this.cstStack.length,\r\n            loopTokenContext: this.getTokenContext(2),\r\n            hint: hint,\r\n            rulePath: rulePath\r\n        })\r\n    }\r\n}\r\n\r\n","export default class SubhutiMatchToken {\r\n    tokenName: string;\r\n    //åªèƒ½ä¸ºå­—ç¬¦ä¸²ï¼Œä¸ºparserè§£ææ—¶è¾“å…¥çš„å­—ç¬¦ä¸²\r\n    tokenValue: string;\r\n    rowNum?: number;\r\n    columnStartNum?: number;\r\n    columnEndNum?: number;\r\n    index?: number\r\n    // length?: number\r\n    hasLineBreakBefore?: boolean;  // æ­¤ token å‰æ˜¯å¦æœ‰æ¢è¡Œï¼ˆBabel é£æ ¼ï¼‰\r\n\r\n    constructor(osvToken: SubhutiMatchToken) {\r\n        this.tokenName = osvToken.tokenName;\r\n        this.tokenValue = osvToken.tokenValue;\r\n        this.rowNum = osvToken.rowNum;\r\n        this.columnStartNum = osvToken.columnStartNum;\r\n        this.columnEndNum = osvToken.columnEndNum;\r\n        // this.length = osvToken.length;\r\n        this.index = osvToken.index;\r\n        this.hasLineBreakBefore = osvToken.hasLineBreakBefore;\r\n    }\r\n}\r\n\r\nexport function createMatchToken(osvToken: SubhutiMatchToken) {\r\n    return new SubhutiMatchToken(osvToken);\r\n}\r\n","/**\r\n * è¯æ³•å‰ç»é…ç½®\r\n */\r\nexport interface SubhutiTokenLookahead {\r\n    is?: RegExp | string       // åé¢å¿…é¡»æ˜¯\r\n    not?: RegExp | string      // åé¢ä¸èƒ½æ˜¯\r\n    in?: (RegExp | string)[]   // åé¢å¿…é¡»åœ¨é›†åˆä¸­\r\n    notIn?: (RegExp | string)[] // åé¢ä¸èƒ½åœ¨é›†åˆä¸­\r\n}\r\n\r\n/**\r\n * ä¸Šä¸‹æ–‡çº¦æŸé…ç½®\r\n * ç”¨äºå¤„ç†è¯æ³•æ­§ä¹‰ï¼ˆå¦‚æ­£åˆ™è¡¨è¾¾å¼ vs é™¤æ³•ï¼‰\r\n */\r\nexport interface SubhutiTokenContextConstraint {\r\n    onlyAfter?: Set<string>    // åªæœ‰å‰ä¸€ä¸ª token åœ¨æ­¤é›†åˆä¸­æ‰åŒ¹é…\r\n    notAfter?: Set<string>     // å‰ä¸€ä¸ª token ä¸èƒ½åœ¨æ­¤é›†åˆä¸­\r\n    onlyAtStart?: boolean      // åªèƒ½åœ¨æ–‡ä»¶å¼€å¤´ï¼ˆindex === 0ï¼‰åŒ¹é…ï¼ˆå¦‚ Hashbangï¼‰\r\n    onlyAtLineStart?: boolean  // åªèƒ½åœ¨è¡Œé¦–åŒ¹é…ï¼ˆå‰ä¸€ä¸ªé skip token åœ¨ä¸Šä¸€è¡Œï¼Œå¦‚ HTMLCloseComment -->ï¼‰\r\n}\r\n\r\n/**\r\n * SubhutiCreateToken æ„é€ å‡½æ•°å‚æ•°ç±»å‹\r\n */\r\nexport interface SubhutiCreateTokenOptions {\r\n    name: string;\r\n    type?: string;\r\n    pattern?: RegExp;\r\n    isKeyword?: boolean;\r\n    skip?: boolean;\r\n    value?: string;\r\n    categories?: any;\r\n    lookaheadAfter?: SubhutiTokenLookahead;\r\n    contextConstraint?: SubhutiTokenContextConstraint;\r\n}\r\n\r\nexport class SubhutiCreateToken {\r\n    name: string;\r\n    type: string;\r\n    pattern?: RegExp;\r\n    isKeyword?: boolean;\r\n    skip?: boolean;  // æ˜¯å¦è·³è¿‡æ­¤ tokenï¼ˆä¸åŠ å…¥ç»“æœï¼‰\r\n    value?: string;\r\n    categories?: any;\r\n    lookaheadAfter?: SubhutiTokenLookahead;  // å‰ç»é…ç½®\r\n    contextConstraint?: SubhutiTokenContextConstraint;  // ä¸Šä¸‹æ–‡çº¦æŸé…ç½®\r\n\r\n    constructor(ovsToken: SubhutiCreateTokenOptions) {\r\n        this.name = ovsToken.name;\r\n        this.type = ovsToken.type || ovsToken.name;  // type é»˜è®¤ç­‰äº name\r\n        this.pattern = ovsToken.pattern\r\n        if (ovsToken.value) {\r\n            this.value = ovsToken.value\r\n        } else {\r\n            this.value = emptyValue\r\n        }\r\n        this.isKeyword = ovsToken.isKeyword ?? false;\r\n        this.skip = ovsToken.skip;\r\n        this.lookaheadAfter = ovsToken.lookaheadAfter;  // å¤åˆ¶å‰ç»é…ç½®\r\n        this.contextConstraint = ovsToken.contextConstraint;  // å¤åˆ¶ä¸Šä¸‹æ–‡çº¦æŸ\r\n    }\r\n}\r\n\r\nexport const emptyValue = 'Error:CannotUseValue'\r\n\r\nexport function createToken(osvToken: SubhutiCreateToken) {\r\n    return new SubhutiCreateToken(osvToken);\r\n}\r\n\r\nexport function createKeywordToken(name: string, pattern: string): SubhutiCreateToken {\r\n    // æ·»åŠ è´Ÿå‘å‰ç»ï¼Œç¡®ä¿å…³é”®å­—åä¸æ˜¯æ ‡è¯†ç¬¦å­—ç¬¦ï¼ˆé˜²æ­¢ do åŒ¹é… doubleï¼‰\r\n    const keywordPattern = new RegExp(pattern + '(?![a-zA-Z0-9_$])')\r\n    const token = new SubhutiCreateToken({name: name, pattern: keywordPattern, value: pattern});\r\n    token.isKeyword = true;\r\n    return token;\r\n}\r\n\r\nexport function createRegToken(name: string, pattern: RegExp) {\r\n    const token = new SubhutiCreateToken({name: name, pattern: pattern, value: pattern.source});\r\n    return token;\r\n}\r\n\r\nexport function createValueRegToken(\r\n    name: string,\r\n    pattern: RegExp,\r\n    value: string,\r\n    skip?: boolean,\r\n    lookahead?: SubhutiTokenLookahead,\r\n    contextConstraint?: SubhutiTokenContextConstraint\r\n) {\r\n    const token = new SubhutiCreateToken({\r\n        name: name,\r\n        pattern: pattern,\r\n        value: value,\r\n        skip: skip,\r\n        lookaheadAfter: lookahead,\r\n        contextConstraint: contextConstraint\r\n    });\r\n    return token;\r\n}\r\n\r\nexport function createEmptyValueRegToken(\r\n    name: string,\r\n    pattern: RegExp,\r\n    contextConstraint?: SubhutiTokenContextConstraint\r\n) {\r\n    const token = new SubhutiCreateToken({\r\n        name: name,\r\n        pattern: pattern,\r\n        contextConstraint: contextConstraint\r\n    });\r\n    return token;\r\n}\r\n","import * as fs from 'fs'\r\nimport * as path from 'path'\r\nimport { fileURLToPath } from 'url'\r\n\r\nexport class LogUtil {\r\n    private static logFilePath: string\r\n\r\n    private static ensureLogFile(): string {\r\n        if (!this.logFilePath) {\r\n            // ESM ä½¿ç”¨ import.meta.url\r\n            const __filename = fileURLToPath(import.meta.url)\r\n            const __dirname = path.dirname(__filename)\r\n            this.logFilePath = path.join(__dirname, 'templog.txt')\r\n            // ç¡®ä¿æ–‡ä»¶å­˜åœ¨\r\n            if (!fs.existsSync(this.logFilePath)) {\r\n                fs.writeFileSync(this.logFilePath, '=== Log Started ===\\n')\r\n            }\r\n        }\r\n        return this.logFilePath\r\n    }\r\n\r\n    static log(data?: any, msg = null) {\r\n        // JsonUtil.log(data)\r\n        try {\r\n            const timestamp = new Date().toISOString()\r\n            // let logMessage = `\\n[${timestamp}]`\r\n            let logMessage = ``\r\n\r\n            if (data !== undefined) {\r\n                if (typeof data === 'object') {\r\n                    logMessage += '\\n' + JSON.stringify(data, null, 2)\r\n                } else {\r\n                    logMessage += '\\n' + String(data)\r\n                }\r\n            }\r\n\r\n            // logMessage += '\\n' + '='.repeat(80) + '\\n'\r\n\r\n            fs.appendFileSync(this.ensureLogFile(), logMessage)\r\n        } catch (error) {\r\n            console.error('Failed to write log:', error)\r\n        }\r\n    }\r\n\r\n    static clear() {\r\n        try {\r\n            fs.writeFileSync(this.ensureLogFile(), '=== Log Cleared ===\\n')\r\n        } catch (error) {\r\n            console.error('Failed to clear log:', error)\r\n        }\r\n    }\r\n}\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAoBA,IAAqB,wBAArB,MAA2C;;OAU7B,gBAAgB;;CAE1B,IAAI,aAAa;AACb,SAAO,CAAC,KAAK;;;;;;;;;CAUjB,AAAU,eAAsB;AAC5B,OAAK,gBAAgB;;;;;CAOzB,IAAI,WAA0C;;;;;;;;CAgB9C,AAAU,KAAK,SAAiB,GAAkC;;;;;;;;;;;;CAgBlE,AAAU,GAAG,SAAiB,GAAkC;AAC5D,SAAO,KAAK,KAAK,OAAO;;;;;;;;CAS5B,AAAQ,aAAa,OAAoC;EACrD,MAAMA,SAA8B,EAAE;AACtC,OAAK,IAAI,IAAI,GAAG,KAAK,OAAO,KAAK;GAC7B,MAAM,QAAQ,KAAK,KAAK,EAAE;AAC1B,OAAI,CAAC,MAAO;AACZ,UAAO,KAAK,MAAM;;AAEtB,SAAO;;;;;;CAOX,AAAQ,UAAU,WAAmB,SAAiB,GAAY;AAC9D,SAAO,KAAK,KAAK,OAAO,EAAE,cAAc;;;;;;CAO5C,AAAQ,aAAa,WAAmB,SAAiB,GAAY;EACjE,MAAM,QAAQ,KAAK,KAAK,OAAO;AAE/B,SAAO,QAAQ,MAAM,cAAc,YAAY;;;;;;CAOnD,AAAQ,YAAY,YAAsB,SAAiB,GAAY;EACnE,MAAM,QAAQ,KAAK,KAAK,OAAO;AAC/B,SAAO,QAAQ,WAAW,SAAS,MAAM,UAAU,GAAG;;;;;;CAO1D,AAAQ,eAAe,YAAsB,SAAiB,GAAY;EACtE,MAAM,QAAQ,KAAK,KAAK,OAAO;AAE/B,SAAO,QAAQ,CAAC,WAAW,SAAS,MAAM,UAAU,GAAG;;;;;;CAO3D,AAAQ,kBAAkB,YAA+B;EACrD,MAAM,SAAS,KAAK,aAAa,WAAW,OAAO;AACnD,MAAI,OAAO,WAAW,WAAW,OAC7B,QAAO;AAEX,SAAO,OAAO,OAAO,OAAO,MAAM,MAAM,cAAc,WAAW,GAAG;;;;;;CAOxE,AAAQ,qBAAqB,YAA+B;AACxD,SAAO,CAAC,KAAK,kBAAkB,WAAW;;;;;;;;;;;;CAc9C,AAAU,sBAAsB,YAA+B;EAC3D,MAAM,SAAS,KAAK,aAAa,WAAW,OAAO;AACnD,MAAI,OAAO,WAAW,WAAW,OAC7B,QAAO;AAIX,OAAK,IAAI,IAAI,GAAG,IAAI,WAAW,QAAQ,KAAK;AACxC,OAAI,OAAO,GAAG,cAAc,WAAW,GACnC,QAAO;AAIX,OAAI,IAAI,KAAK,OAAO,GAAG,mBACnB,QAAO;;AAIf,SAAO;;;;;;CAOX,AAAQ,wBAAiC;AACrC,SAAO,KAAK,UAAU,sBAAsB;;;;;;;;;;;;;;CAqBhD,AAAU,gBAAgB,WAAmB,SAAiB,GAAY;AACtE,MAAI,CAAC,KAAK,cAAe,QAAO;EAEhC,MAAM,SAAS,KAAK,UAAU,WAAW,OAAO;AAChD,MAAI,CAAC,OACD,MAAK,gBAAgB;AAEzB,SAAO;;;;;;;;;;;;;;CAeX,AAAU,mBAAmB,WAAmB,SAAiB,GAAY;AACzE,MAAI,CAAC,KAAK,cAAe,QAAO;EAEhC,MAAM,SAAS,KAAK,aAAa,WAAW,OAAO;AACnD,MAAI,CAAC,OACD,MAAK,gBAAgB;AAEzB,SAAO;;;;;;;;;;;;;;CAeX,AAAU,kBAAkB,YAAsB,SAAiB,GAAY;AAC3E,MAAI,CAAC,KAAK,cAAe,QAAO;EAEhC,MAAM,SAAS,KAAK,YAAY,YAAY,OAAO;AACnD,MAAI,CAAC,OACD,MAAK,gBAAgB;AAEzB,SAAO;;;;;;;;;;;;;;CAeX,AAAU,qBAAqB,YAAsB,SAAiB,GAAY;AAC9E,MAAI,CAAC,KAAK,cAAe,QAAO;EAEhC,MAAM,SAAS,KAAK,eAAe,YAAY,OAAO;AACtD,MAAI,CAAC,OACD,MAAK,gBAAgB;AAEzB,SAAO;;;;;;;;;;;;;CAcX,AAAU,wBAAwB,YAA+B;AAC7D,MAAI,CAAC,KAAK,cAAe,QAAO;EAEhC,MAAM,SAAS,KAAK,kBAAkB,WAAW;AACjD,MAAI,CAAC,OACD,MAAK,gBAAgB;AAEzB,SAAO;;;;;;;;;;;;;CAcX,AAAU,2BAA2B,YAA+B;AAChE,MAAI,CAAC,KAAK,cAAe,QAAO;EAEhC,MAAM,SAAS,KAAK,qBAAqB,WAAW;AACpD,MAAI,CAAC,OACD,MAAK,gBAAgB;AAEzB,SAAO;;;;;;;;;;;;;CAcX,AAAU,+BAA+B,YAA+B;AACpE,MAAI,CAAC,KAAK,cAAe,QAAO;EAEhC,MAAM,SAAS,CAAC,KAAK,sBAAsB,WAAW;AACtD,MAAI,CAAC,OACD,MAAK,gBAAgB;AAEzB,SAAO;;;;;;;;;;;;CAaX,AAAU,oBAA6B;AACnC,MAAI,CAAC,KAAK,cAAe,QAAO;EAEhC,MAAM,SAAS,CAAC,KAAK,uBAAuB;AAC5C,MAAI,CAAC,OACD,MAAK,gBAAgB;AAEzB,SAAO;;;;;;;;;;;;;;CAeX,AAAU,gBAAgB,WAA6B;AACnD,MAAI,CAAC,KAAK,cAAe,QAAO;AAEhC,MAAI,CAAC,UACD,MAAK,gBAAgB;AAEzB,SAAO;;;;;;;CAcX,AAAU,MAAM,WAA4B;AACxC,SAAO,KAAK,UAAU,cAAc;;;;;;ACzY5C,IAAqB,aAArB,MAAgC;CAO5B,YAAY,KAAkB;AAC1B,MAAI,KAAK;AACL,QAAK,OAAO,IAAI;AAEhB,QAAK,WAAW,IAAI;AACpB,QAAK,QAAQ,IAAI;;;;;;;;;;;;;;;;CAqBzB,SAAS,MAAc,QAAgB,GAA2B;AAC9D,MAAI,CAAC,KAAK,SAAU,QAAO;AAG3B,SADgB,KAAK,SAAS,QAAO,MAAK,EAAE,SAAS,KAAK,CAC3C;;;;;;;;;;;;;CAcnB,YAAY,MAA4B;AACpC,MAAI,CAAC,KAAK,SAAU,QAAO,EAAE;AAE7B,SAAO,KAAK,SAAS,QAAO,MAAK,EAAE,SAAS,KAAK;;;;;;;;;;;;;;CAerD,SAAS,WAA2C;AAChD,MAAI,CAAC,KAAK,SAAU,QAAO;AAE3B,SAAO,KAAK,SAAS,MAAK,MAAK,EAAE,SAAS,aAAa,EAAE,UAAU,OAAU;;;;;;;;;;;;;;;CAgBjF,SAAS,MAAuB;AAC5B,MAAI,CAAC,KAAK,SAAU,QAAO;AAE3B,SAAO,KAAK,SAAS,MAAK,MAAK,EAAE,SAAS,KAAK;;;;;CAMnD,IAAI,aAAqB;AACrB,SAAO,KAAK,UAAU,UAAU;;;;;CAMpC,IAAI,UAAmB;AACnB,SAAO,KAAK,UAAU;;;;;CAM1B,IAAI,UAAmB;AACnB,SAAO,CAAC,KAAK,YAAY,KAAK,SAAS,WAAW;;;;;;;;;;;;;;;;AC/D1D,IAAa,eAAb,cAAkC,MAAM;CAwCpC,YACI,SACA,SACA,cAAuB,MACzB;AACE,QAAM,QAAQ;AACd,OAAK,OAAO;AACZ,OAAK,OAAO,QAAQ,QAAQ;AAC5B,OAAK,WAAW,QAAQ;AACxB,OAAK,QAAQ,QAAQ;AACrB,OAAK,WAAW,QAAQ;AACxB,OAAK,YAAY,OAAO,OAAO,CAAC,GAAG,QAAQ,UAAU,CAAC;AAGtD,OAAK,eAAe,QAAQ;AAC5B,OAAK,mBAAmB,QAAQ,mBAAmB,OAAO,OAAO,CAAC,GAAG,QAAQ,iBAAiB,CAAC,GAAG;AAClG,OAAK,eAAe,QAAQ;AAC5B,OAAK,iBAAiB,QAAQ;AAC9B,OAAK,mBAAmB,QAAQ,mBAAmB,OAAO,OAAO,CAAC,GAAG,QAAQ,iBAAiB,CAAC,GAAG;AAGlG,OAAK,OAAO,QAAQ;AAGpB,OAAK,WAAW,QAAQ;AAExB,OAAK,cAAc;AAGnB,MAAI,QAAQ,eAAe,QAAQ,YAAY,SAAS,EACpD,MAAK,cAAc,OAAO,OAAO,CAAC,GAAG,QAAQ,YAAY,CAAC;WACnD,KAAK,SAAS,aAAa,YAClC,MAAK,cAAc,OAAO,OAAO,KAAK,qBAAqB,CAAC;MAE5D,MAAK,cAAc,OAAO,OAAO,EAAE,CAAC;;;;;;;;;;;;CAc5C,AAAQ,sBAAgC;EACpC,MAAMC,cAAwB,EAAE;EAChC,MAAM,EAAE,UAAU,UAAU;AAG5B,MAAI,aAAa,SACb,aAAY,KAAK,iBAAiB;WAC3B,aAAa,SACpB,aAAY,KAAK,gBAAgB;WAC1B,aAAa,WACpB,aAAY,KAAK,iBAAiB;WAI7B,aAAa,YAClB,aAAY,KAAK,cAAc;WACxB,OAAO,cAAc,eAAe,aAAa,YACxD,aAAY,KAAK,WAAW;WAIvB,SAAS,SAAS,MAAM,IAAI,OAAO,cAAc,cAAc;GACpE,MAAM,UAAU,SAAS,QAAQ,OAAO,GAAG,CAAC,aAAa;AACzD,eAAY,KAAK,aAAa,QAAQ,YAAY;aAI7C,aAAa,cAClB;OAAI,OAAO,cAAc,SACrB,aAAY,KAAK,gBAAgB;YAC1B,OAAO,WAAW,SAAS,MAAM,EAAE;IAC1C,MAAM,UAAU,MAAM,UAAU,QAAQ,OAAO,GAAG,CAAC,aAAa;AAChE,gBAAY,KAAK,OAAO,QAAQ,kBAAkB;;;AAK1D,MAAI,CAAC,SAAS,MAAM,cAAc,MAC9B,aAAY,KAAK,+BAA+B;AAIpD,SAAO,YAAY,MAAM,GAAG,EAAE;;;;;CAMlC,WAAmB;AAEf,MAAI,KAAK,SAAS,sBACd,QAAO,KAAK,2BAA2B;AAI3C,MAAI,KAAK,SAAS,oBAAoB,KAAK,SAAS,gBAChD,QAAO,KAAK,sBAAsB;AAItC,SAAO,KAAK,cAAc,KAAK,kBAAkB,GAAG,KAAK,gBAAgB;;;;;CAM7E,AAAQ,mBAA2B;EAC/B,MAAMC,QAAkB,EAAE;AAG1B,QAAM,KAAK,kBAAkB;AAC7B,QAAM,KAAK,GAAG;AAGd,QAAM,KAAK,SAAS,KAAK,SAAS,WAAW,KAAK,KAAK,OAAO,aAAa,MAAM,UAAU,KAAK,SAAS,KAAK,GAAG,KAAK,SAAS,OAAO,QAAQ,KAAK,SAAS,UAAU,GAAG;AACzK,QAAM,KAAK,GAAG;AAGd,QAAM,KAAK,aAAa,KAAK,WAAW;AACxC,QAAM,KAAK,aAAa,KAAK,OAAO,aAAa,QAAQ;AAGzD,MAAI,KAAK,UAAU,SAAS,GAAG;AAC3B,SAAM,KAAK,GAAG;AACd,SAAM,KAAK,cAAc;GAGzB,MAAM,UAAU,KAAK,UAAU,MAAM,GAAY;GACjD,MAAM,SAAS,KAAK,UAAU,SAAS,QAAQ;AAE/C,OAAI,SAAS,EACT,OAAM,KAAK,UAAU,OAAO,QAAQ;AAGxC,WAAQ,SAAS,MAAM,MAAM;IAEzB,MAAM,SADS,MAAM,QAAQ,SAAS,IACd,QAAQ;AAChC,UAAM,KAAK,KAAK,OAAO,GAAG,OAAO;KACnC;;AAIN,MAAI,KAAK,YAAY,SAAS,GAAG;AAC7B,SAAM,KAAK,GAAG;AACd,SAAM,KAAK,eAAe;AAC1B,QAAK,YAAY,SAAQ,eAAc;AACnC,UAAM,KAAK,KAAK,aAAa;KAC/B;;AAGN,SAAO,MAAM,KAAK,KAAK;;;;;CAM3B,AAAQ,iBAAyB;AAC7B,SAAO,0BAA0B,KAAK,SAAS,WAAW,SAAS,KAAK,SAAS,KAAK,GAAG,KAAK,SAAS,OAAO,aAAa,KAAK,SAAS,UAAU,KAAK,OAAO,aAAa;;;;;CAMhL,gBAAwB;AACpB,SAAO,KAAK,gBAAgB;;;;;CAMhC,AAAQ,wBAAwB,OAAuB;AACnD,MAAI,CAAC,KAAK,gBAAgB,KAAK,UAAU,WAAW,EAChD;EAIJ,IAAI,sBAAsB;EAC1B,IAAI,oBAAoB,KAAK;EAE7B,MAAM,6BAAa,IAAI,KAAqB;AAC5C,OAAK,IAAI,IAAI,GAAG,IAAI,KAAK,UAAU,QAAQ,KAAK;GAC5C,MAAM,OAAO,KAAK,UAAU;GAC5B,MAAM,SAAS,WAAW,IAAI,KAAK,IAAI,KAAK;AAC5C,cAAW,IAAI,MAAM,MAAM;AAG3B,OAAI,UAAU,KAAK,wBAAwB,IAAI;AAC3C,0BAAsB,KAAK,UAAU,QAAQ,KAAK;AAClD,wBAAoB;;;AAI5B,MAAI,wBAAwB,IAAI;AAE5B,SAAM,KAAK,WAAW;AACtB,QAAK,UAAU,SAAS,MAAM,MAAM;AAChC,UAAM,KAAK,OAAO,IAAI,EAAE,IAAI,OAAO;KACrC;AACF;;EAIJ,MAAM,gBAAgB,KAAK,UAAU,MAAM,oBAAoB;EAI/D,MAAM,WADW,cAAc,WAAW,IACd,UAAU;AAEtC,QAAM,KAAK,SAAS,WAAW;AAC/B,QAAM,KAAK,WAAW,oBAAoB;AAC1C,QAAM,KAAK,SAAS,cAAc,KAAK,MAAM,CAAC,KAAK,kBAAkB,KAAK;AAC1E,QAAM,KAAK,GAAG;AACd,QAAM,KAAK,WAAW;AAEtB,gBAAc,SAAS,MAAM,MAAM;GAG/B,MAAM,SAFU,MAAM,IAEG,YADL,SAAS,oBACuB,UAAU;AAC9D,SAAM,KAAK,OAAO,IAAI,EAAE,IAAI,OAAO,SAAS;IAC9C;AAEF,QAAM,KAAK,OAAO,cAAc,SAAS,EAAE,IAAI,kBAAkB,SAAS;;;;;;;;;;;;;;;CAgB9E,AAAQ,uBAA+B;EACnC,MAAMA,QAAkB,EAAE;AAG1B,QAAM,KAAK,QAAQ,KAAK,SAAS,mBAAmB,QAAQ,SAAS;AACrE,QAAM,KAAK,GAAG;AAGd,QAAM,KAAK,OAAO,KAAK,aAAa,YAAY,KAAK,SAAS,WAAW,WAAW;AACpF,QAAM,KAAK,SAAS,KAAK,SAAS,WAAW,KAAK,KAAK,OAAO,aAAa,MAAM,IAAI,KAAK,OAAO,cAAc,GAAG,YAAY,KAAK,SAAS,KAAK,GAAG,KAAK,SAAS,SAAS;AAC3K,QAAM,KAAK,GAAG;AAGd,MAAI,KAAK,UAAU;AACf,SAAM,KAAK,QAAQ;AACnB,SAAM,KAAK,KAAK,SAAS;AACzB,SAAM,KAAK,GAAG;aACP,KAAK,UAAU,SAAS,EAE/B,KAAI,KAAK,SAAS,kBAAkB;AAChC,SAAM,KAAK,SAAS;AACpB,QAAK,wBAAwB,MAAM;AACnC,SAAM,KAAK,GAAG;SACX;AAEH,SAAM,KAAK,SAAS;GAEpB,MAAM,UAAU,KAAK,UAAU,MAAM,GAAY;GACjD,MAAM,SAAS,KAAK,UAAU,SAAS,QAAQ;AAE/C,OAAI,SAAS,EACT,OAAM,KAAK,aAAa,OAAO,KAAK;AAGxC,WAAQ,SAAS,MAAM,MAAM;IACzB,MAAM,SAAS,MAAM,QAAQ,SAAS;IACtC,MAAM,SAAS,OAAO,KAAK,OAAO,EAAE,IAAI,SAAS,QAAQ;AACzD,UAAM,KAAK,GAAG,OAAO,GAAG,OAAO;KACjC;AACF,SAAM,KAAK,KAAK,KAAK,OAAO,QAAQ,OAAO,CAAC,MAAM,KAAK,aAAa,SAAS;AAC7E,SAAM,KAAK,GAAG;;AAKtB,QAAM,KAAK,QAAQ;AACnB,QAAM,KAAK,gBAAgB,KAAK,eAAe;AAE/C,MAAI,KAAK,kBAAkB;AACvB,SAAM,KAAK,cAAc,KAAK,iBAAiB,OAAO,IAAI;AAE1D,OAAI,KAAK,iBAAiB,SAAS,KAAK,KAAK,iBAAiB,UAAU,GACpE,OAAM,KAAK,OAAO,KAAK,iBAAiB,KAAK,KAAK,GAAG;YAC9C,KAAK,iBAAiB,SAAS,GACtC,OAAM,KAAK,OAAO,KAAK,iBAAiB,MAAM,GAAG,GAAG,CAAC,KAAK,KAAK,CAAC,MAAM;;AAK9E,MAAI,KAAK,gBAAgB;AACrB,SAAM,KAAK,cAAc,KAAK,eAAe,QAAQ,IAAI,KAAK,eAAe,KAAK,UAAU,KAAK,eAAe,OAAO,UAAU;AACjI,SAAM,KAAK,aAAa,KAAK,eAAe,cAAc;;AAI9D,MAAI,KAAK,oBAAoB,KAAK,iBAAiB,SAAS,GAAG;AAC3D,SAAM,KAAK,GAAG;AACd,SAAM,KAAK,aAAa;AACxB,QAAK,iBAAiB,SAAS,UAAU;IAErC,MAAM,SADY,UAAU,KAAK,QACN,cAAc;AACzC,UAAM,KAAK,KAAK,MAAM,UAAU,IAAI,MAAM,WAAW,IAAI,SAAS;KACpE;;AAIN,MAAI,KAAK,MAAM;AACX,SAAM,KAAK,SAAS;AACpB,SAAM,KAAK,KAAK,KAAK,OAAO;AAC5B,SAAM,KAAK,GAAG;;AAGlB,QAAM,KAAK,GAAG;AAEd,QAAM,KAAK,uBAAuB;AAClC,QAAM,KAAK,eAAe;AAC1B,QAAM,KAAK,GAAG;AACd,QAAM,KAAK,MAAM;AACjB,QAAM,KAAK,mDAAqD;AAChE,QAAM,KAAK,yCAA2C;AACtD,QAAM,KAAK,GAAG;AACd,QAAM,KAAK,QAAQ;AACnB,QAAM,KAAK,gEAAwE;AACnF,QAAM,KAAK,qDAAqD;AAChE,QAAM,KAAK,uDAAuD;AAElE,SAAO,MAAM,KAAK,KAAK;;;;;CAM3B,AAAQ,4BAAoC;EACxC,MAAMA,QAAkB,EAAE;AAE1B,QAAM,KAAK,GAAG;AACd,QAAM,KAAK,IAAI,OAAO,GAAG,CAAC;AAC1B,QAAM,KAAK,kBAAkB;AAC7B,QAAM,KAAK,IAAI,OAAO,GAAG,CAAC;AAC1B,QAAM,KAAK,OAAO,KAAK,aAAa,YAAY,KAAK,SAAS,WAAW,WAAW;AACpF,QAAM,KAAK,SAAS,KAAK,SAAS,WAAW,KAAK,KAAK,OAAO,UAAU,IAAI,KAAK,OAAO,WAAW,YAAY,KAAK,SAAS,KAAK,GAAG,KAAK,SAAS,SAAS;AAC5J,QAAM,KAAK,GAAG;AAGd,MAAI,KAAK,UAAU,SAAS,GAAG;AAC3B,SAAM,KAAK,SAAS;AACpB,QAAK,UAAU,SAAS,MAAM,UAAU;IACpC,MAAM,SAAS,UAAU,KAAK,UAAU,SAAS,IAAI,cAAc;AACnE,UAAM,KAAK,MAAM,MAAM,IAAI,OAAO,SAAS;KAC7C;AACF,SAAM,KAAK,GAAG;;AAIlB,MAAI,KAAK,oBAAoB,KAAK,iBAAiB,SAAS,GAAG;AAC3D,SAAM,KAAK,aAAa;AACxB,QAAK,iBAAiB,SAAQ,UAAS;IAEnC,MAAM,SADY,UAAU,KAAK,QACN,cAAc;AACzC,UAAM,KAAK,KAAK,MAAM,UAAU,IAAI,MAAM,WAAW,IAAI,SAAS;KACpE;AACF,SAAM,KAAK,GAAG;;AAIlB,MAAI,KAAK,MAAM;AACX,SAAM,KAAK,SAAS;AACpB,SAAM,KAAK,KAAK,KAAK,OAAO;AAC5B,SAAM,KAAK,GAAG;;AAGlB,QAAM,KAAK,GAAG;AAEd,QAAM,KAAK,4BAA4B;AACvC,QAAM,KAAK,GAAG;AACd,QAAM,KAAK,QAAQ;AACnB,QAAM,KAAK,sCAAsC;AACjD,QAAM,KAAK,oBAAoB;AAC/B,QAAM,KAAK,qCAAmC;AAC9C,QAAM,KAAK,oBAAoB;AAC/B,QAAM,KAAK,GAAG;AACd,QAAM,KAAK,MAAM;AACjB,QAAM,KAAK,YAAY;AACvB,QAAM,KAAK,8DAA8D;AACzE,QAAM,KAAK,2CAA2C;AACtD,QAAM,KAAK,2DAA2D;AACtE,QAAM,KAAK,wFAAoF;AAC/F,QAAM,KAAK,GAAG;AACd,QAAM,KAAK,YAAY;AACvB,QAAM,KAAK,8DAA8D;AACzE,QAAM,KAAK,kCAAkC;AAC7C,QAAM,KAAK,iCAAiC;AAC5C,QAAM,KAAK,GAAG;AACd,QAAM,KAAK,QAAQ;AACnB,QAAM,KAAK,iCAAiC;AAC5C,QAAM,KAAK,4BAA0B;AACrC,QAAM,KAAK,kCAAgC;AAE3C,SAAO,MAAM,KAAK,KAAK;;;;;;;;AAS/B,IAAa,sBAAb,MAAiC;;OACrB,uBAAgC;;;;;;;CAOxC,YAAY,QAAuB;AAC/B,OAAK,uBAAuB;;;;;;;;CAShC,YAAY,SAAqC;AAC7C,SAAO,IAAI,aACP,YAAY,QAAQ,YACpB,SACA,KAAK,qBACR;;;;;;;;;;;;;;;;;;;;;;;;ACnhBT,IAAI,gBAAgB;;;;;AAMpB,SAAgB,gBAAgB,MAAqB;AACjD,iBAAgB;;;;;AAMpB,SAAgB,kBAA2B;AACvC,QAAO;;;;;;;;;;;;;AAoBX,IAAa,mBAAb,MAA8B;;;;;;;CAO1B,OAAO,WACH,SACA,SAIM;AAEN,UADe,QAAQ,UAAU,KAAK,OAAO,QAAQ,SAAS,EAAE,IAChD;;CAGpB,OAAO,YAAY,OAAiB;AAGhC,SAFgB,MACX,QAAO,MAAK,MAAM,QAAQ,MAAM,UAAa,MAAM,GAAG;;;;;;;;CAU/D,OAAO,iBAAiB,OAAe,YAAoB,IAAY;EAEnE,IAAI,UAAU,MACT,QAAQ,OAAO,OAAO,CACtB,QAAQ,OAAO,MAAM,CACrB,QAAQ,OAAO,MAAM,CACrB,QAAQ,OAAO,MAAM;AAG1B,MAAI,QAAQ,SAAS,UACjB,WAAU,QAAQ,MAAM,GAAG,UAAU,GAAG;AAG5C,SAAO;;;;;;;CAQX,OAAO,eAAe,KAAkB;AACpC,MAAI,CAAC,KAAK,SAAS,CAAC,KAAK,IACrB,QAAO;EAGX,MAAM,YAAY,IAAI,MAAM;EAC5B,MAAM,WAAW,IAAI,MAAM;EAC3B,MAAM,UAAU,IAAI,IAAI;EACxB,MAAM,SAAS,IAAI,IAAI;AAEvB,MAAI,cAAc,QACd,QAAO,IAAI,UAAU,GAAG,SAAS,GAAG,OAAO;MAE3C,QAAO,IAAI,UAAU,GAAG,SAAS,GAAG,QAAQ,GAAG,OAAO;;;;;;;;CAU9D,OAAO,gBAAgB,OAAiB,YAAoB,OAAe;AACvE,SAAO,MAAM,KAAK,UAAU;;;AAuDpC,IAAa,6BAAb,MAAa,2BAA2B;;;;;;;;CAQpC,OAAO,eAAe,MAA6B;AAE/C,MAAI,KAAK,cAAc;GACnB,MAAM,OAAO,KAAK;AAElB,OAAI,KAAK,UAEL,QAAO;YACA,KAAK,WACZ,QAAO,SAAS,KAAK,cAAc,EAAE,GAAG,KAAK,cAAc;OAE3D,QAAO;;AAIf,SAAO;;;;;CAMX,OAAO,UAAU,MAA8B;AAE3C,SAAO,KAAK,cAAc;;CAI9B,OAAc,cAAc,WAA0B,UAA2B;EAG7E,MAAM,QAAQ,iBAAiB,iBAAiB,UAAU,cAAc,IAAI,GAAG;AAE/E,MAAI,UAAU,aACV,QAAO;GAAC;GAAK;GAAW,SAAS,UAAU,WAAW;GAAI;GAAO;GAAK,IAAI,UAAU,UAAU;GAAK,YAAY;GAAM,CAAC,KAAK,IAAI;MAE/H,QAAO;GAAC;GAAK,SAAS,UAAU,WAAW;GAAI;GAAW,UAAU;GAAiB;GAAK;GAAQ;GAAO;GAAK,IAAI,UAAU,UAAU;GAAG,CAAC,KAAK,IAAI;;;;;CAQ3J,OAAc,WAAW,KAAa,OAAe,SAAiB,MAAc;AAChF,SAAO,iBAAiB,WACpB,KAEA,EAAC,QAAQ,MAAM,OAAO,MAAM,GAAG,QAAO,CACzC;;CAKL,OAAc,WAAW,GAAG,MAAM;AAC9B,MAAI,CAAC,cAAe;AACpB,UAAQ,IAAI,GAAG,KAAK;;;;;;;;;;;;CAexB,OAAc,mCAAmC,WAAsC;AACnF,MAAI,CAAC,UAAU,OACX,OAAM,IAAI,MAAM,oBAAoB;EAGxC,MAAMC,WAAqB,EAAE;EAE7B,IAAI,gBAAgB,UAAU,WAAU,SAAQ,CAAC,KAAK,UAAU;AAEhE,MAAI,gBAAgB,EAEhB,iBAAgB,UAAU;EAE9B,IAAI,eAAe,UAAU,MAAM,cAAc;EAGjD,MAAM,gBAAgB,UAAU,gBAAgB;EAIhD,IAAI,YAAY;AAChB,MAAI,cAEA,aAAY,cAAc;EAI9B,IAAI,cAAc,CAAC,GAAG,aAAa,CAAC,SAAS,CAAC,WAAU,SAAQ,CAAC,CAAC,KAAK,cAAc,UAAU;EAO/F,MAAM,aAAa,KAAK,IAAI,cAAc,GALd,EAKqC;AAGjE,MAAI,aAAa,aAAa,SAAS,GAAG;GACtC,MAAM,cAAc,aAAa,OAAO,CAAC,WAAW;GAEpD,MAAMC,SAA4B,EAAE;GACpC,IAAIC,eAAgC,CAAC,aAAa,GAAG;AACrD,UAAO,KAAK,aAAa;AAEzB,QAAK,IAAI,IAAI,GAAG,IAAI,aAAa,QAAQ,KAAK;IAC1C,MAAM,OAAO,aAAa;IAC1B,MAAM,WAAW,aAAa,IAAI;AAGlC,QAAI,KAAK,oBAAoB,SAAS,gBAClC,cAAa,KAAK,KAAK;SACpB;AAEH,oBAAe,CAAC,KAAK;AACrB,YAAO,KAAK,aAAa;;;AAGjC,QAAK,MAAM,SAAS,OAChB,KAAI,MAAM,GAAG,iBAAiB;IAC1B,MAAMC,WAAS,KAAK,yBAAyB,OAAO,UAAU;AAC9D,aAAS,KAAK,GAAGA,SAAO,MAAM;AAC9B,gBAAYA,SAAO;UAChB;AACH;IACA,MAAM,QAAQ,KAAK,gBAAgB,OAAO,UAAU;AACpD,aAAS,KAAK,GAAG,MAAM;;GAI/B,MAAM,SAAS,KAAK,yBAAyB,aAAa,UAAU;AACpE,YAAS,KAAK,GAAG,OAAO,MAAM;SAC3B;GACH,MAAM,SAAS,KAAK,yBAAyB,cAAc,UAAU;AACrE,YAAS,KAAK,GAAG,OAAO,MAAM;;AAGlC,SAAO;;;;;CAMX,OAAc,kCAAkC,WAAoC;AAEhF,EADc,KAAK,mCAAmC,UAAU,CAC1D,SAAQ,SAAQ,KAAK,WAAW,KAAK,CAAC;AAI5C,SADiB,UAAU,UAAU,SAAS,IAC7B,gBAAgB;;CAGrC,OAAc,+BAA+B,WAAkC;EAC3E,IAAI,eAAe,UAAU,QAAO,SAAQ,CAAC,KAAK,UAAU;AAE5D,MAAI,aAAa,WAAW,EACxB,OAAM,IAAI,MAAM,aAAa;EAOjC,MAAMF,SAA4B,EAAE;EACpC,IAAIC,eAAgC,CAAC,aAAa,GAAG;AACrD,SAAO,KAAK,aAAa;AAEzB,OAAK,IAAI,IAAI,GAAG,IAAI,aAAa,QAAQ,KAAK;GAC1C,MAAM,OAAO,aAAa;GAC1B,MAAM,WAAW,aAAa,IAAI;AAGlC,OAAI,KAAK,oBAAoB,SAAS,gBAClC,cAAa,KAAK,KAAK;QACpB;AAEH,mBAAe,CAAC,KAAK;AACrB,WAAO,KAAK,aAAa;;;AAKjC,OAAK,MAAM,SAAS,OAChB,KAAI,MAAM,GAAG,gBAET,MAAK,wBAAwB,MAAM;MAGnC,MAAK,eAAe,MAAM;;;;;;;CAUtC,OAAO,gBAAgB,OAAwB,QAAgB,MAAM,GAAG,cAAwB;AAC5F,MAAI,CAAC,MAAM,OACP,OAAM,IAAI,MAAM,OAAO;EAE3B,MAAM,QAAQ,MAAM,KAAI,MAAK,2BAA2B,sBAAsB,EAAE,CAAC;EAEjF,MAAM,eAAe,MAAM,SAAS,IAC9B;GAAC,GAAG,MAAM,MAAM,GAAG,EAAE;GAAE;GAAO,GAAG,MAAM,MAAM,GAAG;GAAC,GACjD;EAEN,MAAM,OAAO,2BAA2B,WAAW,aAAa,KAAK,MAAM,EAAE,OAAO,KAAK;AAEzF,QAAM,SAAQ,MAAK;AACf,KAAE,eAAe;AACjB,KAAE,YAAY;IAChB;AAEF,SAAO,CAAC,KAAK;;;;;;;CAQjB,OAAO,eAAe,OAAwB,QAAgB,MAAM,GAAG,cAAc;AAEjF,EADc,KAAK,gBAAgB,OAAO,MAAM,CAC1C,SAAQ,SAAQ,KAAK,WAAW,KAAK,CAAC;;;;;;;;;CAUhD,OAAO,yBAAyB,OAAwB,QAAgB,MAAM,GAAG,cAAkD;EAC/H,MAAME,QAAkB,EAAE;AAE1B,QAAM,SAAS,MAAM,UAAU;AAC3B;GAGA,MAAM,SAAS,UAAU,MAAM,SAAS;AAExC,OAAI,CAAC,KAAK,gBACN,MAAK,eAAe;GAGxB,IAAI,SAAS,SAAS,OAAO;GAC7B,IAAI,WAAW,KAAK,sBAAsB,KAAK;GAE/C,MAAM,OAAO,2BAA2B,WAAW,UAAU,KAAK,cAAc,OAAO;AACvF,SAAM,KAAK,KAAK;AAEhB,QAAK,YAAY;IACnB;AAEF,SAAO;GAAE;GAAO;GAAO;;;;;;;;;CAU3B,OAAO,wBAAwB,OAAwB,QAAgB,MAAM,GAAG,cAAsB;EAClG,MAAM,SAAS,KAAK,yBAAyB,OAAO,MAAM;AAC1D,SAAO,MAAM,SAAQ,SAAQ,KAAK,WAAW,KAAK,CAAC;AACnD,SAAO,OAAO;;CAGlB,OAAe,sBAAsB,WAA0B;EAC3D,IAAI,MAAM;AACV,MAAI,UAAU,cAAc;GACxB,MAAM,aAAa,UAAU;AAC7B,OAAI,UAAU,aAAa,UAGvB,OAAM,QAAQ,UAAU,WAAW;YAC5B,UAAU,aAAa,WAC9B,OAAM,YAAY,WAAW,cAAc,EAAE,IAAI,UAAU,SAAS;aAIpE,UAAU,gBACV,OAAM,2BAA2B,cAAc,UAAU;MAEzD,OAAM,UAAU;AAGxB,MAAI,UAAU,gBAEV,QAAO;AAEX,SAAO;;;;;;;;;;;;;;;;;;;;;AC7Mf,IAAa,oBAAb,MAAa,kBAAkB;;;;;;;;;;;;;;CAkB3B,OAAO,cAAc,MAA4B;EAC7C,MAAMC,SAAmB,EAAE;AAE3B,MAAI,CAAC,KAAM,QAAO;AAElB,MAAI,KAAK,UAAU,WAAc,CAAC,KAAK,YAAY,KAAK,SAAS,WAAW,GACxE,QAAO,KAAK,KAAK,MAAM;AAG3B,MAAI,KAAK,YAAY,MAAM,QAAQ,KAAK,SAAS,CAC7C,MAAK,MAAM,SAAS,KAAK,SACrB,QAAO,KAAK,GAAG,kBAAkB,cAAc,MAAM,CAAC;AAI9D,SAAO;;;;;;;;;;;;;;;;;;;CAoBX,OAAO,0BACH,KACA,aAQF;EAEE,MAAM,cAAc,YAAY,KAAI,MAChC,OAAO,MAAM,WAAW,IAAK,EAAE,cAAc,GAChD,CAAC,QAAO,MAAK,MAAM,GAAG;EAEvB,MAAM,YAAY,kBAAkB,cAAc,IAAI;EAGtD,MAAMC,UAAoB,EAAE;AAC5B,OAAK,IAAI,IAAI,GAAG,IAAI,YAAY,QAAQ,IACpC,KAAI,KAAK,UAAU,UAAU,YAAY,OAAO,UAAU,GACtD,SAAQ,KAAK,YAAY,GAAG;AAIpC,SAAO;GACH,UAAU,QAAQ,WAAW,KAAK,YAAY,WAAW,UAAU;GACnE,YAAY,YAAY;GACxB,UAAU,UAAU;GACpB,aAAa;GACF;GACF;GACZ;;;;;;;;;CAcL,OAAO,kBACH,MACA,SAAe,QACmC;EAClD,MAAMC,SAA6D,EAAE;AAErE,MAAI,SAAS,MAAM;AACf,UAAO,KAAK;IAAC;IAAM,OAAO;IAAe,CAAC;AAC1C,UAAO;;AAGX,MAAI,SAAS,QAAW;AACpB,UAAO,KAAK;IAAC;IAAM,OAAO;IAAoB,CAAC;AAC/C,UAAO;;AAGX,MAAI,CAAC,KAAK,QAAQ,KAAK,UAAU,OAC7B,QAAO,KAAK;GACR;GACA,OAAO;GACP,MAAM;IAAC,GAAG;IAAM,UAAU,KAAK,WAAW,IAAI,KAAK,SAAS,OAAO,cAAc;IAAU;GAC9F,CAAC;AAGN,MAAI,KAAK,aAAa,QAAW;AAC7B,OAAI,CAAC,MAAM,QAAQ,KAAK,SAAS,EAAE;AAC/B,WAAO,KAAK;KACR;KACA,OAAO,mCAAmC,OAAO,KAAK,SAAS;KAC/D,MAAM;MAAC,MAAM,KAAK;MAAM,cAAc,OAAO,KAAK;MAAS;KAC9D,CAAC;AACF,WAAO;;AAGX,QAAK,SAAS,SAAS,OAAY,UAAkB;IACjD,MAAM,YAAY,GAAGC,OAAK,YAAY,MAAM;AAE5C,QAAI,UAAU,MAAM;AAChB,YAAO,KAAK;MAAC,MAAM;MAAW,OAAO;MAAgB,CAAC;AACtD;;AAGJ,QAAI,UAAU,QAAW;AACrB,YAAO,KAAK;MAAC,MAAM;MAAW,OAAO;MAAqB,CAAC;AAC3D;;IAGJ,MAAM,cAAc,kBAAkB,kBAAkB,OAAO,UAAU;AACzE,WAAO,KAAK,GAAG,YAAY;KAC7B;;AAGN,MAAI,KAAK,UAAU,UAAa,KAAK,YAAY,KAAK,SAAS,SAAS,EACpE,QAAO,KAAK;GACR;GACA,OAAO;GACP,MAAM;IAAC,MAAM,KAAK;IAAM,OAAO,KAAK;IAAO,eAAe,KAAK,SAAS;IAAO;GAClF,CAAC;AAGN,SAAO;;;;;;;;CASX,OAAO,iBAAiB,MAKtB;EACE,MAAM,QAAQ;GACV,YAAY;GACZ,WAAW;GACX,UAAU;GACV,2BAAW,IAAI,KAAqB;GACvC;EAED,MAAM,YAAY,QAAW,UAAkB;AAC3C,OAAI,CAACC,OAAM;AAEX,SAAM;AACN,SAAM,WAAW,KAAK,IAAI,MAAM,UAAU,MAAM;AAEhD,OAAIA,OAAK,KACL,OAAM,UAAU,IAAIA,OAAK,OAAO,MAAM,UAAU,IAAIA,OAAK,KAAK,IAAI,KAAK,EAAE;AAG7E,OAAI,CAACA,OAAK,YAAYA,OAAK,SAAS,WAAW,EAC3C,OAAM;OAEN,MAAK,MAAM,SAASA,OAAK,SACrB,UAAS,OAAO,QAAQ,EAAE;;AAKtC,WAAS,MAAM,EAAE;AACjB,SAAO;;;;;;;;;;CAWX,OAAO,UAAU,KAAiB,SAAiB,IAAI,SAAkB,MAAc;EACnF,MAAMC,QAAkB,EAAE;EAG1B,MAAM,YAAY,SAAS,OAAO;EAClC,MAAM,WAAW,kBAAkB,WAAW,KAAK,QAAQ,UAAU;AACrE,QAAM,KAAK,SAAS;AAGpB,MAAI,IAAI,YAAY,IAAI,SAAS,SAAS,GAAG;GACzC,MAAM,cAAc,UAAU,SAAS,QAAQ;AAE/C,OAAI,SAAS,SAAS,OAAY,UAAkB;IAChD,MAAM,cAAc,UAAU,IAAI,SAAS,SAAS;AACpD,UAAM,KAAK,kBAAkB,UAAU,OAAO,aAAa,YAAY,CAAC;KAC1E;;AAGN,SAAO,MAAM,KAAK,KAAK;;;;;CAM3B,OAAe,WAAW,KAAiB,QAAgB,WAA2B;AAGlF,MAFgB,IAAI,UAAU,QAEjB;GAET,MAAM,QAAQ,iBAAiB,iBAAiB,IAAI,MAAM;GAC1D,MAAM,WAAW,IAAI,MAAM,iBAAiB,eAAe,IAAI,IAAI,GAAG;AAEtE,UAAO,iBAAiB,WACpB;IAAC;IAAW,IAAI,OAAO;IAAK,IAAI,MAAM;IAAI;IAAS,CAAC,KAAK,GAAG,EAC5D,EAAC,QAAO,CACX;QAGD,QAAO,iBAAiB,WACpB,CAAC,WAAW,IAAI,KAAK,CAAC,KAAK,GAAG,EAC9B,EAAC,QAAO,CACX;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;CAsCT,OAAO,YACH,QACA,aACA,QAIA,SAMI;EAEJ,MAAM,OAAO;GACT,wBAAwB;GACxB,kBAAkB;GAClB,gBAAgB;GAChB,iBAAiB;GACjB,GAAG;GACN;AAED,UAAQ,IAAI,gBAAgB;AAC5B,UAAQ,IAAI,IAAI,OAAO,GAAG,CAAC;AAC3B,UAAQ,IAAI,yBAAyB;AAErC,OAAK,IAAI,IAAI,GAAG,IAAI,OAAO,QAAQ,KAAK;GACpC,MAAM,QAAQ,OAAO;AAErB,WAAQ,IAAI,MAAM,IAAI,OAAO,IAAI,EAAE,CAAC,SAAS,IAAI,EAAE,IAAI,MAAM,OAAO;AACpE,WAAQ,IAAI,IAAI,OAAO,GAAG,CAAC;AAE3B,OAAI;IAEA,MAAM,SAAS,IAAI,YAAY,OAAO;AAGtC,QAAI,KAAK,0BAA0B,MAAM,OAAO,SAAS,GACrD;SAAI,OAAO,OAAO,UAAU,WACxB,QAAO,OAAO;;IAItB,MAAM,SAAS,MAAM,KAAK,OAAO;AAEjC,QAAI,CAAC,QAAQ;AACT,aAAQ,IAAI,QAAQ,MAAM,KAAK,eAAe;AAC9C;;IAIJ,MAAM,aAAa,kBAAkB,0BAA0B,QAAQ,OAAO;AAE9E,QAAI,WAAW,SACX,SAAQ,IAAI,OAAO,MAAM,KAAK,iBAAiB,WAAW,SAAS,GAAG,WAAW,WAAW,GAAG;SAC5F;AACH,aAAQ,IAAI,OAAO,MAAM,KAAK,WAAW;AACzC,aAAQ,IAAI,gBAAgB,WAAW,WAAW,IAAI;AACtD,aAAQ,IAAI,mBAAmB,WAAW,SAAS,IAAI;AACvD,aAAQ,IAAI,aAAa,WAAW,YAAY,KAAK,KAAK,CAAC,GAAG;AAC9D,aAAQ,IAAI,eAAe,WAAW,UAAU,KAAK,KAAK,CAAC,GAAG;AAE9D,SAAI,WAAW,QAAQ,SAAS,EAC5B,SAAQ,IAAI,gBAAgB,WAAW,QAAQ,KAAK,KAAK,CAAC,GAAG;AAGjE,aAAQ,IAAI,cAAc,MAAM,KAAK,cAAc;AAEnD,SAAI,IAAI,GAAG;AACP,cAAQ,IAAI,cAAc,OAAO,IAAI,GAAG,KAAK,SAAS;AACtD,cAAQ,IAAI,gBAAgB,MAAM,KAAK,KAAK,OAAO,IAAI,GAAG,KAAK,MAAM;WAErE,SAAQ,IAAI,gBAAgB,MAAM,KAAK,sBAAsB;AAGjE,SAAI,KAAK,iBACL;;YAGHC,OAAY;AACjB,YAAQ,IAAI,OAAO,MAAM,KAAK,OAAO;AACrC,YAAQ,IAAI,UAAU,MAAM,UAAU;AACtC,YAAQ,IAAI,cAAc,MAAM,KAAK,SAAS;AAE9C,QAAI,IAAI,GAAG;AACP,aAAQ,IAAI,aAAa,OAAO,IAAI,GAAG,KAAK,OAAO;AACnD,aAAQ,IAAI,aAAa,MAAM,KAAK,OAAO;AAC3C,aAAQ,IAAI,eAAe,MAAM,KAAK,gBAAgB,OAAO,IAAI,GAAG,OAAO;WACxE;AACH,aAAQ,IAAI,cAAc,MAAM,KAAK,QAAQ;AAC7C,aAAQ,IAAI,eAAe,MAAM,KAAK,gBAAgB;;AAI1D,QAAI,KAAK,kBAAkB,MAAM,OAAO;AACpC,aAAQ,IAAI,cAAc,KAAK,gBAAgB,KAAK;AAEpD,KADmB,MAAM,MAAM,MAAM,KAAK,CAAC,MAAM,GAAG,KAAK,gBAAgB,CAC9D,SAAS,SAAiB,QAAQ,IAAI,MAAM,OAAO,CAAC;;AAGnE,QAAI,KAAK,iBACL;;;AAKZ,UAAQ,IAAI,OAAO,IAAI,OAAO,GAAG,CAAC;AAClC,UAAQ,IAAI,eAAe;AAC3B,UAAQ,IAAI,IAAI,OAAO,GAAG,CAAC;;;AAQnC,IAAa,uBAAb,MAAkC;;;;;;CA+B9B,YAAY,QAAgB;OA3BrB,YAA6B,EAAE;OAK9B,wBAAQ,IAAI,KAAwB;OAKpC,gCAAgB,IAAI,KAA4B;OAKhD,cAAqB,EAAE;OAKvB,cAAiC;OA4NzC,oBAAoB;AApNhB,OAAK,cAAc,KAAK,mBAAmB,UAAU,EAAE,CAAC;;;;;;;;;;;;CAa5D,iBAAiB,QAAsB;AAEnC,OAAK,cAAc,OAAO;AAG1B,OAAK,MAAM,OAAO;AAGlB,MAAI,OAEA,MAAK,cAAc,KAAK,mBAAmB,OAAO;;;;;;;CAU1D,AAAQ,mBAAmB,QAAsB;EAC7C,MAAM,eAAe;GAAC;GAAqB;GAAoB;GAAW;GAAY;AACtF,SAAO,OAAO,QAAO,MAAK;GACtB,MAAM,OAAO,EAAE,aAAa;AAC5B,UAAO,aAAa,QAAQ,KAAK,KAAK;IACxC;;;;;CAMN,AAAQ,uBAAuB,MAAoC;AAC/D,MAAI,KAAK,UACL;OAAI,CAAC,KAAK,OAAO,OACb,OAAM,IAAI,MAAM,OAAO;;AAyB/B,SAtB6B;GACzB,UAAU,KAAK;GACf,WAAW,KAAK;GAChB,YAAY,KAAK;GACjB,WAAW,KAAK;GAChB,WAAW,KAAK;GAChB,YAAY,KAAK;GACjB,cAAc,KAAK;GACnB,iBAAiB,KAAK;GACtB,iBAAiB,KAAK;GACtB,cAAc,KAAK;GACnB,QAAQ,KAAK;GAGb,cAAc,KAAK,eAAe;IAC9B,SAAS,KAAK,aAAa;IAC3B,aAAa,KAAK,aAAa;IAC/B,WAAW,KAAK,aAAa;IAC7B,YAAY,KAAK,aAAa;IAC9B,eAAe,KAAK,aAAa;IACpC,GAAG;GACP;;;;;CAWL,AAAQ,iBAAiB,MAA6B;AAelD,SAAO,GAbU,KAAK,SAaH,GAZA,KAAK,WAAW,UAAU,CAYZ,GAVf,KAAK,eAAgB,KAAK,aAAa,YAAY,MAAM,MAAO,IAUpC,GAT3B,KAAK,eAAgB,KAAK,aAAa,aAAa,MAAM,MAAO,IASxB,GAR5C,KAAK,cAAc,SAAS,UAAU,IAAI,KAQa,GAPnD,KAAK,cAAc,aAAa,UAAU,IAAI,KAOoB,GALnE,KAAK,cAAc,GAK8D,GAJlF,KAAK,aAAa,GAI6E,GAHzF,KAAK,mBAAmB,GAGoF,GAF/G,KAAK,gBAAgB;;CAK9C,AAAQ,gBAAgB,YAAoB,YAAoB,WAAmB,YAAoB,SAAiC;AAEpI,SAAO;GACH,UAAU;GACV,cAAc;GACd,iBAAiB;GACjB,WAAW;GACX,WAAW;GACC;GACZ,iBAAiB;GAEL;GACD;GACd;;;;;;;;;;CAWL,AAAQ,gCAAgC,UAAkB,cAAsB,qBAA8B,SAAkB,MAAqB;EAEjJ,MAAM,SAAS,KAAK,SAAS,SAAS;AACtC,MAAI,CAAC,OACD,OAAM,IAAI,MAAM,OAAO;EAI3B,MAAM,eAAe,KAAK,uBAAuB,OAAO;AAExD,eAAa,YAAY;AACzB,eAAa,kBAAkB;AAC/B,eAAa,kBAAkB;AAE/B,wBAAsB;EAEtB,MAAM,yBAAyB,KAAK,UAAU,KAAK,UAAU,SAAS,GAAG;EAEzE,IAAI,gBAAgB;AACpB,MAAI,QAAQ;AACR;AACA,gBAAa,kBAAkB;aACxB,qBAAqB;AAC5B;AACA,gBAAa,kBAAkB;aACxB,aAAa,iBAAiB;AACrC;AACA,gBAAa,kBAAkB;aACxB,aAAa,gBAAgB,aAAa,aAAa,aAAa,aAAa,OAAO,SAAS,GAAG;AAC3G;AACA,gBAAa,kBAAkB;AAC/B,yBAAsB;aACf,CAAC,mBAAmB,CAAC,QAAQ,aAAa,SAAS,GAAG,IAAI;AACjE;AACA,gBAAa,kBAAkB;aACxB,wBAAwB;AAE/B;AACA,mBAAgB;;AAGpB,eAAa,eAAe;AAG5B,MAAI,uBAAuB,aAAa,aACpC,uBAAsB,aAAa,aAAa,cAAc;EAIlE,IAAI,kBAAkB,KAAK,UAAU,KAAK,aAAa;AAIvD,MAAI,OAAO,QAAQ;GACf,IAAI,IAAI;AACR,QAAK,MAAM,YAAY,OAAO,QAAQ;IAClC,MAAM,WAAW,KAAK,gCAAgC,UAAU,cAAc,qBAAqB,MAAM;AAEzG,QAAI,CAAC,UAAU,MAAM,KAAK,0BAA0B,CAAC,aAAa,mBAAmB,SAAS,iBAAiB;AAC3G,UAAK,UAAU,OAAO,gBAAgB;AAEtC,SAAI,CAAC,cACD;AAEJ,kBAAa,kBAAkB;AAC/B,kBAAa,eAAe;AAC5B,UAAK,gCAAgC,UAAU,cAAc,qBAAqB,MAAM;;AAE5F;;;AAMR,MAAI,QAAQ;AACR,8BAA2B,+BAA+B,KAAK,UAAU;AACzE,QAAK,UAAU,OAAO,gBAAgB;;AAG1C,SAAO;;;;;;;;;;;;;;;CAwBX,YAAY,UAAkB,YAA4B;EAEtD,MAAM,YAAY,YAAY,KAAK;EAKnC,IAAI,OAAO,KAAK,MAAM,IAAI,SAAS;AACnC,MAAI,CAAC,MAAM;AAEP,UAAO;IACH;IACA,YAAY;IACZ,kBAAkB;IAClB,WAAW;IACX,WAAW;IACX,eAAe;IACf,SAAS;IACZ;AACD,QAAK,MAAM,IAAI,UAAU,KAAK;;AAGlC,OAAK;EAGL,MAAMC,WAA0B;GAC5B;GAEA;GACA;GACA,WAAW;GACX,QAAQ,EAAE;GACb;AAED,MAAI,KAAK,mBAAmB;GAExB,MAAM,WAAW,KAAK,iBAAiB,SAAS;AAMhD,OAHsB,KAAK,SAAS,SAAS,EAG1B;IACf,IAAI,QAAQ,2BAA2B,kCAAkC,KAAK,UAAU;AAExF,SAAK,gCAAgC,UAAU,OAAO,MAAM;AAE5D,WAAO;;;AAUf,OAAK,UAAU,KAAK,SAAS;AAI7B,SAAO;;CAGX,WACI,UACA,UACA,WACI;EACJ,IAAI,WAAW;AACf,MAAI,cAAc,UAAa,OAAO,cAAc,SAChD,YAAW,YAAY,KAAK,GAAG;AAInC,MAAI,KAAK,UAAU,WAAW,EAC1B,OAAM,IAAI,MAAM,sDAAsD,WAAW;EAErF,MAAM,UAAU,KAAK,UAAU,KAAK;AAGpC,MAAI,CAAC,WAAW,QAAQ,aAAa,SACjC,OAAM,IAAI,MACN,kCAAkC,SAAS,eAAe,SAAS,YAAY,cAClF;EAML,MAAM,OAAO,KAAK,MAAM,IAAI,SAAS;AACrC,MAAI,MAAM;AACN,QAAK,aAAa;AAElB,OAAI,SACA,MAAK;QACF;AACH,SAAK;AACL,SAAK,iBAAiB;AAEtB,QAAI,KAAK,mBAAmB,EACxB,MAAK,UAAU,KAAK,gBAAgB,KAAK;;;AAMrD,MAAI,CAAC,QAAQ,UACT;EAIJ,MAAM,WAAW,KAAK,iBAAiB,QAAQ;EAI/C,MAAM,aAAa,KAAK,UAAU,KAAK,UAAU,SAAS;AAG1D,MAAI,YAAY;AAEZ,OAAI,CAAC,WAAW,OACZ,OAAM,IAAI,MACN,iBAAiB,WAAW,SAAS,gDAAgD,WACxF;AAKL,OAAI,WAAW,OAAO,MAAK,QAAO,QAAQ,SAAS,EAAE;AACjD,YAAQ,IAAI,eAAe,SAAS,oBAAoB;AACxD,YAAQ,IAAI,gBAAgB;AAC5B,eAAW,OAAO,SAAS,KAAK,QAAQ;AACpC,aAAQ,IAAI,QAAQ,IAAI,IAAI,MAAM;MACpC;AACF,UAAM,IAAI,MACN,UAAU,SAAS,iCAAiC,WAAW,SAAS,WAC3E;;AAIL,QAAK,gBAAgB,YAAY,SAAS;;AAM9C,MAAI,CAHiB,KAAK,SAAS,SAAS,EAGzB;GACf,MAAM,SAAS,KAAK,uBAAuB,QAAQ;AACnD,QAAK,SAAS,UAAU,OAAO;;;CAIvC,SAAS,KAAa,OAAsB;AACxC,MAAI,CAAC,MAAM,iBACP;OAAI,CAAC,MAAM,UAAU,MAAM,QAAQ,WAAW,EAC1C,OAAM,IAAI,MAAM,cAAc;;AAGtC,OAAK,cAAc,IAAI,KAAK,MAAM;;CAGtC,SAAS,KAAa;AAElB,SADY,KAAK,cAAc,IAAI,IAAI;;CAI3C,eACI,YACA,YACA,WACA,YACA,SACI;AAEJ,MAAI,KAAK,UAAU,WAAW,EAC1B,OAAM,IAAI,MAAM,kEAAkE,YAAY;EAGlG,MAAM,aAAa,KAAK,UAAU,KAAK,UAAU,SAAS;AAE1D,MAAI,CAAC,SAED;OAAI,cAAc,WAAW,WACzB;;EAKR,MAAM,YAAY,KAAK,gBAAgB,YAAY,YAAY,WAAW,YAAY,QAAQ;EAC9F,MAAM,WAAW,KAAK,iBAAiB,UAAU;AAGjD,MAAI,CAAC,KAAK,cAAc,IAAI,SAAS,CACjC,MAAK,SAAS,UAAU,KAAK,uBAAuB,UAAU,CAAC;AAInE,MAAI,CAAC,WAAW,OACZ,OAAM,IAAI,MACN,iBAAiB,WAAW,SAAS,mDAAmD,YAC3F;AAIL,MAAI,WAAW,OAAO,MAAK,QAAO,QAAQ,SAAS,CAC/C,OAAM,IAAI,MACN,WAAW,UAAU,iCAAiC,WAAW,SAAS,WAC7E;AAIL,OAAK,gBAAgB,YAAY,SAAS;EAI1C,MAAM,QAAQ,2BAA2B,kCAAkC,KAAK,UAAU;EAG1F,MAAM,QAAQ,KAAK,YAAY;EAE/B,IAAIC,WAA0B;AAE9B,MAAI,SACA;OAAI,OACA;QAAI,MAAM,IAEN,YAAW,iBAAiB,eAAe,MAAM,IAAI;aAC9C,MAAM,WAAW,UAAa,MAAM,mBAAmB,QAAW;KAEzE,MAAM,MAAM,MAAM;KAClB,MAAM,QAAQ,MAAM;AAEpB,gBAAW,IAAI,IAAI,GAAG,MAAM,GADhB,MAAM,gBAAgB,QAAQ,WAAW,SAAS,EAC3B;;;;EAK/C,MAAM,WAAW,2BAA2B,cAAc,WAAW,SAAS;EAC9E,MAAM,OAAO,2BAA2B,WAAW,UAAU,MAAM;AACnE,6BAA2B,WAAW,KAAK;;CAG/C,UACI,gBACA,YACI;EAIJ,IAAI,UAAU;AACd,MAAI,KAAK,UAAU,SAAS,GAAG;GAC3B,MAAM,aAAa,KAAK,UAAU,KAAK,UAAU,SAAS;AAC1D,OAAI,WAAW,OAEX,MAAK,MAAM,YAAY,WAAW,QAAQ;IACtC,MAAM,YAAY,KAAK,SAAS,SAAS;AACzC,QAAI,aAAa,UAAU,cAAc,UACrC;;;AAQhB,OAAK,UAAU,KAAK;GAChB,UAAU;GACV,WAAW,YAAY,KAAK;GAC5B,WAAW;GAEX,iBAAiB;GACjB;GACA,QAAQ,EAAE;GACV,cAAc;IACV;IACA,WAAW;IACX,YAAY;IACZ,iBAAiB;IACjB,gBAAgB,EAAE;IACrB;GACJ,CAAC;;CAGN,SACI,gBACI;AAEJ,MAAI,KAAK,UAAU,WAAW,EAC1B,OAAM,IAAI,MAAM,2DAA2D,iBAAiB;EAGhG,MAAM,YAAY,KAAK,UAAU,KAAK;AAGtC,MAAI,EAAE,UAAU,aAAa,kBACtB,UAAU,gBACV,UAAU,aAAa,aACvB,CAAC,UAAU,aAAa,aAC5B;GACC,MAAM,SAAS,UAAU,eACnB,UAAU,UAAU,aAAa,UAAU,WAAW,UAAU,aAAa,WAAW,KACxF;AACN,SAAM,IAAI,MAAM,gCAAgC,eAAe,wBAAwB,UAAU,WAAW,SAAS;;AAIzH,MAAI,CAAC,UAAU,UACX;EAIJ,MAAM,WAAW,KAAK,iBAAiB,UAAU;EAGjD,MAAM,aAAa,KAAK,UAAU,KAAK,UAAU,SAAS;AAG1D,MAAI,YAAY;AAEZ,OAAI,CAAC,WAAW,OACZ,OAAM,IAAI,MACN,iBAAiB,WAAW,SAAS,8CAA8C,iBACtF;AAIL,OAAI,WAAW,OAAO,MAAK,QAAO,QAAQ,SAAS,CAC/C,OAAM,IAAI,MACN,KAAK,SAAS,MAAM,eAAe,iCAAiC,WAAW,SAAS,WAC3F;AAIL,QAAK,gBAAgB,YAAY,SAAS;;AAK9C,MAAI,CADiB,KAAK,SAAS,SAAS,EACzB;GACf,MAAM,SAAS,KAAK,uBAAuB,UAAU;AACrD,QAAK,SAAS,UAAU,OAAO;;;CAIvC,WACI,aACA,eACA,gBACI;EAIJ,MAAM,aAAa,KAAK,UAAU,SAAS,IACpC,KAAK,UAAU,KAAK,UAAU,SAAS,IAAI,cAAc,IAC1D;EAGN,IAAIC,UAA8B;AAClC,MAAI,KAAK,UAAU,SAAS,GAAG;GAC3B,MAAM,gBAAgB,KAAK,UAAU,KAAK,UAAU,SAAS;AAC7D,OAAI,cAAc,cAAc,UAC5B,WAAU,cAAc,aAAa;;AAM7C,OAAK,UAAU,KAAK;GAChB,UAAU;GACV,WAAW,YAAY,KAAK;GAC5B,WAAW;GACX;GACA,QAAQ,EAAE;GACV,cAAc;IACV;IACA,WAAW;IACX,YAAY;IACZ;IACA;IACH;GACJ,CAAC;;CAGN,eACI,gBACA,aACI;AAEJ,MAAI,KAAK,UAAU,WAAW,EAC1B,OAAM,IAAI,MAAM,iEAAiE,YAAY,OAAO,iBAAiB;EAIzH,MAAM,gBAAgB,KAAK,UAAU,KAAK;AAG1C,MAAI,EAAE,cAAc,aAAa,kBAC1B,cAAc,gBACd,cAAc,aAAa,cAC3B,CAAC,cAAc,aAAa,aAC5B,cAAc,aAAa,gBAAgB,cAC/C;GACC,MAAM,OAAO,cAAc;GAC3B,MAAM,UAAU,OACV,UAAU,KAAK,UAAU,WAAW,KAAK,WAAW,QAAQ,KAAK,YAAY,KAC7E;AACN,SAAM,IAAI,MAAM,sCAAsC,eAAe,aAAa,YAAY,gBAAgB,cAAc,WAAW,UAAU;;AAIrJ,MAAI,CAAC,cAAc,UACf;EAIJ,MAAM,WAAW,KAAK,iBAAiB,cAAc;EAGrD,MAAM,eAAe,KAAK,UAAU,KAAK,UAAU,SAAS;AAG5D,MAAI,cAAc;AAEd,OAAI,CAAC,aAAa,OACd,OAAM,IAAI,MACN,oBAAoB,aAAa,SAAS,kDAAkD,cAC/F;AAIL,OAAI,aAAa,OAAO,MAAK,QAAO,QAAQ,SAAS,CACjD,OAAM,IAAI,MACN,cAAc,YAAY,oCAAoC,aAAa,SAAS,WACvF;AAIL,QAAK,gBAAgB,cAAc,SAAS;;AAKhD,MAAI,CADqB,KAAK,SAAS,SAAS,EACzB;GACnB,MAAM,SAAS,KAAK,uBAAuB,cAAc;AACzD,QAAK,SAAS,UAAU,OAAO;;;CAIvC,YACI,gBACA,cACI;;;;CAWR,AAAQ,mBAAmB,MAA4B;AACnD,SAAO,kBAAkB,cAAc,KAAK;;;;;CAMhD,AAAQ,uBAAuB,KAI7B;EACE,MAAM,SAAS,kBAAkB,0BAA0B,KAAK,KAAK,YAAY;AACjF,SAAO;GACH,OAAO,OAAO;GACd,KAAK,OAAO;GACZ,SAAS,OAAO;GACnB;;;;;CAML,AAAQ,kBAAkB,MAAW,SAAe,QAA4D;AAC5G,SAAO,kBAAkB,kBAAkB,MAAMN,OAAK;;;;;CAM1D,AAAQ,iBAAiB,MAKvB;AACE,SAAO,kBAAkB,iBAAiB,KAAK;;;;;CAwBnD,AAAQ,aAAqB;EACzB,MAAM,WAAW,MAAM,KAAK,KAAK,MAAM,QAAQ,CAAC;AAEhD,MAAI,SAAS,WAAW,EACpB,QAAO;EAIX,MAAM,aAAa,SAAS,QAAQ,KAAK,MAAM,MAAM,EAAE,YAAY,EAAE;EACrE,MAAM,kBAAkB,SAAS,QAAQ,KAAK,MAAM,MAAM,EAAE,kBAAkB,EAAE;EAChF,MAAM,iBAAiB,SAAS,QAAQ,KAAK,MAAM,MAAM,EAAE,WAAW,EAAE;EACxE,MAAM,YAAY,SAAS,QAAQ,KAAK,MAAM,MAAM,EAAE,WAAW,EAAE;EACnE,MAAM,eAAe,aAAa,KAAK,iBAAiB,aAAa,KAAK,QAAQ,EAAE,GAAG;EAEvF,MAAME,QAAkB,EAAE;AAC1B,QAAM,KAAK,WAAW;AACtB,QAAM,KAAK,IAAI,OAAO,GAAG,CAAC;AAC1B,QAAM,KAAK,QAAQ,UAAU,QAAQ,EAAE,CAAC,IAAI;AAC5C,QAAM,KAAK,QAAQ,WAAW,gBAAgB,CAAC,IAAI;AACnD,QAAM,KAAK,SAAS,gBAAgB,gBAAgB,CAAC,IAAI;AACzD,QAAM,KAAK,SAAS,eAAe,gBAAgB,CAAC,MAAM,aAAa,IAAI;AAC3E,QAAM,KAAK,GAAG;EAGd,MAAM,OAAO,SACR,QAAO,MAAK,EAAE,mBAAmB,EAAE,CACnC,MAAM,GAAG,MAAM,EAAE,gBAAgB,EAAE,cAAc,CACjD,MAAM,GAAG,EAAE;AAEhB,MAAI,KAAK,SAAS,GAAG;AACjB,SAAM,KAAK,aAAa;AACxB,QAAK,SAAS,MAAM,MAAM;IACtB,MAAM,SAAS,KAAK,UAAU,KAAM,QAAQ,EAAE;AAC9C,UAAM,KACF,KAAK,IAAI,EAAE,IAAI,KAAK,SAAS,IAAI,KAAK,cAAc,QAAQ,EAAE,CAAC,MAC3D,KAAK,WAAW,OAAO,MAAM,KACpC;KACH;;AAGN,SAAO,MAAM,KAAK,KAAK;;;;;CAU3B,OAAO,KAAmC;AACtC,OAAK,cAAc,OAAO;;CAG9B,gBAAgB,QAAuB,OAAe;AAClD,SAAO,OAAO,KAAK,MAAM;;;;;CAS7B,aAAmB;AACf,UAAQ,IAAI,OAAO,IAAI,OAAO,GAAG,CAAC;AAClC,UAAQ,IAAI,sBAAsB;AAClC,UAAQ,IAAI,IAAI,OAAO,GAAG,CAAC;AAK3B,UAAQ,IAAI,gBAAgB;AAC5B,UAAQ,IAAI,IAAI,OAAO,GAAG,CAAC;AAC3B,UAAQ,IAAI,OAAO,KAAK,YAAY,CAAC;AAGrC,UAAQ,IAAI,iBAAiB;AAI7B,EAHiB,MAAM,KAAK,KAAK,MAAM,QAAQ,CAAC,CAC3C,MAAM,GAAG,MAAM,EAAE,gBAAgB,EAAE,cAAc,CAE7C,SAAS,SAAS;GACvB,MAAM,YAAY,KAAK,aAAa,KAC7B,KAAK,YAAY,KAAK,aAAa,KAAK,QAAQ,EAAE,GACnD;AACN,WAAQ,IACJ,KAAK,KAAK,SAAS,IAAI,KAAK,WAAW,QAClC,KAAK,iBAAiB,QACtB,KAAK,cAAc,QAAQ,EAAE,CAAC,SAC9B,UAAU,GAClB;IACH;AAEF,UAAQ,IAAI,OAAO,IAAI,OAAO,GAAG,CAAC;AAKlC,MAAI,KAAK,aAAa;AAClB,WAAQ,IAAI,oBAAoB;AAChC,WAAQ,IAAI,IAAI,OAAO,GAAG,CAAC;AAC3B,WAAQ,IAAI,gBAAgB;AAC5B,WAAQ,IAAI,IAAI,OAAO,GAAG,CAAC;GAG3B,MAAM,kBAAkB,KAAK,kBAAkB,KAAK,YAAY;AAChE,WAAQ,IAAI,eAAe,gBAAgB,WAAW,IAAI,MAAM,MAAM;AAEtE,OAAI,gBAAgB,SAAS,GAAG;AAC5B,YAAQ,IAAI,SAAS,gBAAgB,OAAO,OAAO;AACnD,oBAAgB,SAAS,KAAK,MAAM;AAChC,aAAQ,IAAI,SAAS,IAAI,EAAE,IAAI,IAAI,OAAO;AAC1C,aAAQ,IAAI,cAAc,IAAI,QAAQ;AACtC,SAAI,IAAI,MAAM;MACV,MAAM,UAAU,KAAK,UAAU,IAAI,MAAM,MAAM,EAAE,CAC5C,MAAM,KAAK,CACX,KAAI,SAAQ,UAAU,OAAO,CAC7B,KAAK,KAAK;AACf,cAAQ,IAAI,QAAQ;;MAE1B;SAEF,SAAQ,IAAI,WAAW;GAI3B,MAAM,cAAc,KAAK,uBAAuB,KAAK,YAAY;AACjE,WAAQ,IAAI,mBAAmB,YAAY,QAAQ,WAAW,IAAI,MAAM,MAAM;AAC9E,WAAQ,IAAI,iBAAiB,YAAY,MAAM,OAAO,IAAI;AAC1D,WAAQ,IAAI,mBAAmB,YAAY,IAAI,OAAO,IAAI;AAC1D,WAAQ,IAAI,aAAa,YAAY,MAAM,KAAK,KAAK,CAAC,GAAG;AACzD,WAAQ,IAAI,eAAe,YAAY,IAAI,KAAK,KAAK,CAAC,GAAG;AAEzD,OAAI,YAAY,QAAQ,SAAS,EAC7B,SAAQ,IAAI,aAAa,YAAY,QAAQ,KAAK,KAAK,CAAC,GAAG;OAE3D,SAAQ,IAAI,YAAY;GAI5B,MAAM,QAAQ,KAAK,iBAAiB,KAAK,YAAY;AACrD,WAAQ,IAAI,eAAe;AAC3B,WAAQ,IAAI,YAAY,MAAM,aAAa;AAC3C,WAAQ,IAAI,YAAY,MAAM,YAAY;AAC1C,WAAQ,IAAI,YAAY,MAAM,WAAW;AACzC,WAAQ,IAAI,YAAY,MAAM,UAAU,KAAK,IAAI;AAGjD,WAAQ,IAAI,eAAe;AAG3B,GAFoB,MAAM,KAAK,MAAM,UAAU,SAAS,CAAC,CACpD,MAAM,GAAG,MAAM,EAAE,KAAK,EAAE,GAAG,CACpB,SAAS,CAAC,MAAM,WAAW;AACnC,YAAQ,IAAI,QAAQ,KAAK,IAAI,QAAQ;KACvC;AAEF,WAAQ,IAAI,IAAI,OAAO,GAAG,CAAC;AAK3B,WAAQ,IAAI,mBAAmB;AAC/B,WAAQ,IAAI,IAAI,OAAO,GAAG,CAAC;AAC3B,WAAQ,IAAI,cAAc;AAC1B,WAAQ,IAAI,IAAI,OAAO,GAAG,CAAC;AAC3B,WAAQ,IAAI,kBAAkB,UAAU,KAAK,YAAY,CAAC;AAC1D,WAAQ,IAAI,IAAI,OAAO,GAAG,CAAC;;AAG/B,UAAQ,IAAI,OAAO,IAAI,OAAO,GAAG,CAAC;AAClC,UAAQ,IAAI,gBAAgB;AAC5B,UAAQ,IAAI,IAAI,OAAO,GAAG,CAAC;;;qBAxLxB,gBAAgB,kBAAkB;qBAKlC,4BAA4B,kBAAkB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC90CzD,IAAa,sBAAb,MAAiC;;;;;;;;;;;;;;;;;;;;;;;;CAkE7B,YAAY,UAAU,KAAO;OAjCrB,QAAQ;GACZ,MAAM;GACN,QAAQ;GACR,QAAQ;GACX;AA8BG,OAAK,UAAU;AAGf,MAAI,YAAY,EAEZ,MAAK,QAAQ,IAAI,SAA4C,EACzD,KAAK,UACR,CAAC;MAGF,MAAK,QAAQ,IAAI,SAA4C,EACzD,KAAK,SACR,CAAC;;;;;;;;;;;;;;CAoBV,IAAI,UAAkB,YAA2D;EAC7E,MAAM,MAAM,GAAG,SAAS,GAAG;EAC3B,MAAM,SAAS,KAAK,MAAM,IAAI,IAAI;AAElC,MAAI,WAAW,QAAW;AACtB,QAAK,MAAM;AACX;;AAIJ,OAAK,MAAM;AACX,SAAO;;;;;;;;;;;;;;CAeX,IAAI,UAAkB,YAAoB,QAAyC;EAC/E,MAAM,MAAM,GAAG,SAAS,GAAG;AAC3B,OAAK,MAAM;AAGX,OAAK,MAAM,IAAI,KAAK,OAAO;;;;;;;;;;CAW/B,QAAc;AACV,OAAK,MAAM,OAAO;AAGlB,OAAK,MAAM,OAAO;AAClB,OAAK,MAAM,SAAS;AACpB,OAAK,MAAM,SAAS;;;;;CAMxB,IAAI,OAAe;AACf,SAAO,KAAK,MAAM;;;;;;;;;;;;;;;;;CAsBtB,iBAAiD;EAC7C,MAAM,QAAQ,KAAK,MAAM,OAAO,KAAK,MAAM;EAC3C,MAAM,UAAU,QAAQ,KAAK,KAAK,MAAM,OAAO,QAAQ,KAAK,QAAQ,EAAE,GAAG;EACzE,MAAM,aAAa,WAAW,QAAQ;EAGtC,MAAM,YAAY,KAAK,UAAU,KACzB,KAAK,OAAO,KAAK,UAAW,KAAK,QAAQ,EAAE,GAAG,MAChD;EAGN,MAAMK,cAAwB,EAAE;AAEhC,MAAI,cAAc,GACd,aAAY,KAAK,mBAAmB;WAC7B,cAAc,GACrB,aAAY,KAAK,oBAAoB;WAC9B,cAAc,GACrB,aAAY,KAAK,4BAA4B;MAE7C,aAAY,KAAK,2BAA2B;AAIhD,MAAI,KAAK,UAAU,GAAG;GAClB,MAAM,aAAa,KAAK,OAAO,KAAK;AAEpC,OAAI,aAAa,GACb,aAAY,KAAK,gCAAgC;YAC1C,aAAa,GACpB,aAAY,KAAK,mCAAmC;AAIxD,OAAI,aAAa,MAAO,QAAQ,IAC5B,aAAY,KAAK,sCAAsC;;AAI/D,SAAO;GAEH,MAAM,KAAK,MAAM;GACjB,QAAQ,KAAK,MAAM;GACnB,QAAQ,KAAK,MAAM;GACnB;GACA,SAAS,GAAG,QAAQ;GAGpB,cAAc,KAAK;GACnB,aAAa,KAAK;GAClB;GAGA;GACH;;;;;;ACvUT,IAAqB,uBAArB,MAA0C;CAMtC,YAAY,QAAuB;AAC/B,OAAK,SAAS;;;;;;;CAYlB,AAAU,QAAQ,WAAmB,MAA4C;AAC7E,SAAO,KAAK,OAAO,cAAc,WAAW,KAAK;;;;;;;;;;AChCzD,MAAa,yBAAyB;;;;;;;;AAStC,SAAgB,mBAAmB,MAA6B;CAC5D,MAAM,QAAQ,KAAK,MAAM,uBAAuB;AAChD,QAAO,QAAQ,MAAM,KAAK;;;;;AAM9B,IAAY,sDAAL;;AAEH;;AAEA;;AAEA;;;AAoBJ,MAAa,yBAAyB;CAClC,cAAc;CACd,gBAAgB;CAChB,cAAc;CACjB;;;;;;;;;;;AAYD,IAAqB,eAArB,MAAkC;CAMhC,YAAY,QAA8B;OAHlC,iBAAiB;OACjB,cAAc;AAOpB,OAAK,aAAa,OAAO,KAAI,UAAS;AACpC,OAAI,CAAC,MAAM,QAAS,QAAO;AAE3B,UAAO;IACL,GAAG;IACH,SAAS,IAAI,OAAO,SAAS,MAAM,QAAQ,SAAS,KAAK,MAAM,QAAQ,MAAM;IAC9E;IACD;AAIF,OAAK,yBAAyB,KAAK,WAAW,QAC5C,MAAK,EAAE,SAAS,uBAAuB,kBAClC,EAAE,SAAS,uBAAuB,aACxC;;;;;;;CAQH,SAAS,MAAmC;EAC1C,MAAMC,SAA8B,EAAE;EACtC,IAAI,QAAQ;EACZ,IAAI,SAAS;EACb,IAAI,YAAY;AAChB,OAAK,cAAc;AAEnB,SAAO,QAAQ,KAAK,QAAQ;GAE1B,MAAM,UAAU,KAAK,YAAY,MAAM,OAAO,QAAQ,WAAW,OAAO;AAExE,OAAI,CAAC,SAAS;IACZ,MAAM,YAAY,KAAK;AACvB,UAAM,IAAI,MACR,yBAAyB,UAAU,gBAAgB,MAAM,SAAS,OAAO,WAAW,UAAU,GAC/F;;AAIH,OAAI,CAAC,QAAQ,MAAM;AACjB,WAAO,KAAK,QAAQ,MAAM;AAE1B,SAAK,cAAc;;GAIrB,MAAM,cAAc,QAAQ,MAAM,WAAW;AAC7C,YAAS;GAKT,MAAM,aAAa,QAAQ,MAAM,WAAW,MAAM,2BAA2B;AAC7E,OAAI,cAAc,WAAW,SAAS,GAAG;AACvC,cAAU,WAAW;IAErB,MAAM,iBAAiB,QAAQ,MAAM,WAAW,YAAY,WAAW,WAAW,SAAS,GAAG;IAC9F,MAAM,eAAe,WAAW,WAAW,SAAS,GAAG;AACvD,gBAAY,QAAQ,MAAM,WAAW,SAAS,iBAAiB,eAAe;SAE9E,cAAa;AAIf,QAAK,qBAAqB,QAAQ,MAAM,UAAU;;AAGpD,SAAO;;CAGT,AAAQ,YACN,MACA,OACA,QACA,WACA,eACA;EACA,MAAM,YAAY,KAAK,MAAM,MAAM;EAEnC,MAAM,gBAAgB,cAAc,SAAS,IACzC,cAAc,cAAc,SAAS,GAAG,YACxC;AAEJ,OAAK,MAAM,SAAS,KAAK,kBAAkB,EAAE;GAC3C,MAAM,QAAQ,UAAU,MAAM,MAAM,QAAQ;AAC5C,OAAI,CAAC,MAAO;AAGZ,OAAI,MAAM,mBAAmB,eAAe,UAAU,EACpD;AAKF,OAAI,MAAM,mBAAmB,mBAAmB,UAAU,KAAK,YAC7D;AAIF,OAAI,MAAM,mBAAmB,WAC3B;QAAI,CAAC,iBAAiB,CAAC,MAAM,kBAAkB,UAAU,IAAI,cAAc,CACzE;;AAKJ,OAAI,MAAM,mBAAmB,UAC3B;QAAI,iBAAiB,MAAM,kBAAkB,SAAS,IAAI,cAAc,CACtE;;AAKJ,OAAI,MAAM,gBAAgB,KAAK;IAC7B,MAAM,YAAY,UAAU,MAAM,MAAM,GAAG,OAAO;IAClD,MAAM,EAAE,QAAQ,MAAM;AAMtB,QAJmB,eAAe,SAC9B,IAAI,KAAK,UAAU,GACnB,UAAU,WAAW,IAAI,CAEb;;AAGlB,UAAO;IACL,OAAO,KAAK,kBAAkB,OAAO,MAAM,IAAI,OAAO,QAAQ,UAAU;IACxE,MAAM,MAAM;IACb;;AAGH,SAAO;;CAGT,AAAQ,kBACN,OACA,OACA,OACA,QACA,WACmB;AACnB,SAAO;GACL,WAAW,MAAM;GACjB,YAAY;GACL;GACC;GACR,gBAAgB;GAChB,cAAc,YAAY,MAAM,SAAS;GACzC,oBAAoB,SAAS,KAAK;GACnC;;;;;;;;CASH,AAAQ,mBAAyC;AAG/C,SAAO,KAAK,iBAAiB,IACzB,KAAK,aACL,KAAK;;;;;;;;;;;;;CAcX,AAAQ,qBAAqB,WAAyB;AACpD,MAAI,cAAc,uBAAuB,aACvC,MAAK;WACI,cAAc,uBAAuB,aAC9C,MAAK;;;;;;CAQT,AAAQ,oBACN,WACA,OACA,QACA,WACA;AACA,OAAK,MAAM,SAAS,KAAK,YAAY;AACnC,OAAI,MAAM,SAAS,uBAAuB,kBACtC,MAAM,SAAS,uBAAuB,aACxC;GAGF,MAAM,QAAQ,UAAU,MAAM,MAAM,QAAQ;AAC5C,OAAI,MACF,QAAO;IACL,OAAO,KAAK,6BACV,MAAM,MACN,MAAM,IACN,OACA,QACA,WACA,OACD;IACD,MAAM;IACP;;AAGL,SAAO;;;;;CAWT,qBAAiC;AAC/B,SAAO;GACL,UAAU;GACV,QAAQ;GACR,WAAW;GACX,eAAe;GACf,iBAAiB;GACjB,eAAe;GAChB;;;;;;;;;;CAWH,cACE,MACA,OACA,cAA2B,YAAY,iBACb;AAE1B,SAAO,MAAM,WAAW,KAAK,QAAQ;GACnC,MAAM,UAAU,KAAK,oBACnB,MACA,MAAM,UACN,MAAM,QACN,MAAM,WACN,MAAM,eACN,MAAM,eACN,YACD;AAED,OAAI,CAAC,SAAS;IACZ,MAAM,YAAY,KAAK,MAAM;AAC7B,UAAM,IAAI,MACR,yBAAyB,UAAU,gBAAgB,MAAM,SAAS,SAAS,MAAM,OAAO,WAAW,MAAM,UAAU,GACpH;;GAIH,MAAM,cAAc,QAAQ,MAAM,WAAW;AAC7C,SAAM,YAAY;GAGlB,MAAM,aAAa,QAAQ,MAAM,WAAW,MAAM,2BAA2B;AAC7E,OAAI,cAAc,WAAW,SAAS,GAAG;AACvC,UAAM,UAAU,WAAW;IAC3B,MAAM,iBAAiB,QAAQ,MAAM,WAAW,YAAY,WAAW,WAAW,SAAS,GAAG;IAC9F,MAAM,eAAe,WAAW,WAAW,SAAS,GAAG;AACvD,UAAM,YAAY,QAAQ,MAAM,WAAW,SAAS,iBAAiB,eAAe;SAEpF,OAAM,aAAa;AAIrB,OAAI,QAAQ,MAAM,cAAc,uBAAuB,aACrD,OAAM;YACG,QAAQ,MAAM,cAAc,uBAAuB,aAC5D,OAAM;AAIR,OAAI,QAAQ,KACV;AAIF,SAAM,kBAAkB,QAAQ,MAAM;AACtC,SAAM,gBAAgB,QAAQ,MAAM;AAEpC,UAAO,QAAQ;;AAGjB,SAAO;;;;;CAMT,MAAM,MAAc,OAA4B;EAE9C,IAAI,MAAM,MAAM;AAChB,SAAO,MAAM,KAAK,QAAQ;GACxB,MAAM,YAAY,KAAK,MAAM,IAAI;GAEjC,MAAM,kBAAkB,UAAU,MAAM,SAAS;AACjD,OAAI,iBAAiB;AACnB,WAAO,gBAAgB,GAAG;AAC1B;;GAEF,MAAM,oBAAoB,UAAU,MAAM,gBAAgB;AAC1D,OAAI,mBAAmB;AACrB,WAAO,kBAAkB,GAAG;AAC5B;;GAEF,MAAM,mBAAmB,UAAU,MAAM,oBAAoB;AAC7D,OAAI,kBAAkB;AACpB,WAAO,iBAAiB,GAAG;AAC3B;;AAGF,UAAO;;AAET,SAAO;;;;;CAMT,AAAQ,oBACN,MACA,OACA,QACA,WACA,eACA,eACA,aACA;EACA,MAAM,YAAY,KAAK,MAAM,MAAM;EAKnC,MAAM,eAAe,KAAK;AAE1B,OAAK,MAAM,SAAS,cAAc;AAGhC,OAAI,gBAAgB,YAAY,0BAA0B;IAExD,MAAM,gBAAgB,KAAK,oBAAoB,WAAW,OAAO,QAAQ,UAAU;AACnF,QAAI,cACF,QAAO;;AAMX,OAAI,MAAM,SAAS,WAAW,MAAM,SAAS,gBAC3C;QAAI,gBAAgB,YAAY,sBAAsB,UAAU,WAAW,IAAI,EAAE;KAE/E,MAAM,cAAc,mBAAmB,UAAU;AACjD,SAAI,YACF,QAAO;MACL,OAAO,KAAK,6BACV,4BACA,aACA,OACA,QACA,WACA,OACD;MACD,MAAM;MACP;;;GAMP,MAAM,QAAQ,UAAU,MAAM,MAAM,QAAQ;AAC5C,OAAI,CAAC,MAAO;AAGZ,OAAI,MAAM,mBAAmB,eAAe,UAAU,EACpD;AAIF,OAAI,MAAM,mBAAmB,mBAAmB,UAAU,KAAK,YAC7D;AAIF,OAAI,MAAM,mBAAmB,WAC3B;QAAI,CAAC,iBAAiB,CAAC,MAAM,kBAAkB,UAAU,IAAI,cAAc,CACzE;;AAKJ,OAAI,MAAM,mBAAmB,UAC3B;QAAI,iBAAiB,MAAM,kBAAkB,SAAS,IAAI,cAAc,CACtE;;AAKJ,OAAI,MAAM,gBAAgB,KAAK;IAC7B,MAAM,YAAY,UAAU,MAAM,MAAM,GAAG,OAAO;IAClD,MAAM,EAAE,QAAQ,MAAM;AAItB,QAHmB,eAAe,SAC9B,IAAI,KAAK,UAAU,GACnB,UAAU,WAAW,IAAI,CACb;;AAGlB,UAAO;IACL,OAAO,KAAK,6BAA6B,MAAM,MAAM,MAAM,IAAI,OAAO,QAAQ,WAAW,KAAK,YAAY;IAC1G,MAAM,MAAM;IACb;;AAGH,SAAO;;;;;;;;;;;;;;CAmBT,YACE,MACA,WACA,MACA,QACA,MACA,gBAA+B,MAC/B,gBAAwB,GACA;EACxB,IAAI,MAAM;EACV,IAAI,SAAS;EACb,IAAI,YAAY;EAChB,IAAI,aAAa;EACjB,IAAI,uBAAuB;AAG3B,SAAO,MAAM,KAAK,QAAQ;GACxB,MAAM,UAAU,KAAK,oBACnB,MACA,KACA,QACA,WACA,sBACA,eACA,KACD;AAED,OAAI,CAAC,SAAS;IACZ,MAAM,YAAY,KAAK;AACvB,UAAM,IAAI,MACR,yBAAyB,UAAU,gBAAgB,IAAI,SAAS,OAAO,WAAW,UAAU,GAC7F;;GAGH,MAAM,cAAc,QAAQ,MAAM,WAAW;GAC7C,MAAM,UAAU,MAAM;GAGtB,IAAI,aAAa;GACjB,IAAI,gBAAgB;GACpB,MAAM,aAAa,QAAQ,MAAM,WAAW,MAAM,2BAA2B;AAC7E,OAAI,cAAc,WAAW,SAAS,GAAG;AACvC,kBAAc,WAAW;IACzB,MAAM,iBAAiB,QAAQ,MAAM,WAAW,YAAY,WAAW,WAAW,SAAS,GAAG;IAC9F,MAAM,eAAe,WAAW,WAAW,SAAS,GAAG;AACvD,oBAAgB,QAAQ,MAAM,WAAW,SAAS,iBAAiB,eAAe;SAElF,kBAAiB;AAInB,OAAI,QAAQ,MAAM;AAIhB,UAAM;AACN,aAAS;AACT,gBAAY;AACZ;;GAKF,MAAMC,QAA2B;IAC/B,WAAW,QAAQ,MAAM;IACzB,YAAY,QAAQ,MAAM;IAC1B,OAAO;IACC;IACR,gBAAgB;IAChB,cAAc,YAAY,cAAc;IACxC,oBAAoB,SAAS;IAC9B;AAED,UAAO;IACL;IACA,eAAe;IACf,UAAU;IACV,YAAY;IACZ,eAAe,MAAM;IACtB;;AAGH,SAAO;;;;;CAMT,AAAQ,6BACN,WACA,OACA,OACA,QACA,WACA,YACmB;AACnB,SAAO;GACM;GACX,YAAY;GACL;GACC;GACR,gBAAgB;GAChB,cAAc,YAAY,MAAM,SAAS;GACzC,oBAAoB,SAAS;GAC9B;;;;;;;;;AChiBL,IAAa,gCAAb,cAAmD,MAAM;CACrD,YACI,AAAOC,QACP,AAAOC,OACT;AACE,QAAM,4BAA4B;EAH3B;EACA;AAGP,OAAK,OAAO;;;;;CAMhB,WAAmB;EACf,MAAMC,QAAkB,EAAE;AAG1B,OAAK,MAAM,SAAS,KAAK,QAAQ;GAE7B,IAAI,QAAQ;AACZ,OAAI,MAAM,SAAS,qBAAqB,MAAM,cAAc,WAAW,GAAG;IAEtE,MAAM,CAAC,GAAG,KAAK,MAAM;AACrB,YAAQ,IAAI,MAAM,MAAM,OAAO,EAAE,OAAO,EAAE;cACnC,MAAM,SAAS,2BAA2B,MAAM,cAAc,WAAW,GAAG;IAEnF,MAAM,CAAC,GAAG,KAAK,MAAM;AACrB,YAAQ,IAAI,MAAM,MAAM,OAAO,EAAE,OAAO,EAAE;SAG1C,SAAQ,IAAI,MAAM,MAAM,IAAI,MAAM;AAGtC,SAAM,KAAK,MAAM;AACjB,SAAM,KAAK,WAAW,MAAM,WAAW;AACvC,SAAM,KAAK,gBAAgB,MAAM,cAAc,KAAK,KAAK,CAAC,GAAG;AAG7D,OAAI,MAAM,eAAe;AACrB,UAAM,KAAK,aAAa,MAAM,cAAc,QAAQ;AACpD,UAAM,KAAK,aAAa,MAAM,cAAc,QAAQ;;AAIxD,OAAI,MAAM,SAAS,qBAAqB,MAAM,cAAc,WAAW,GAAG;IACtE,MAAM,CAAC,GAAG,KAAK,MAAM;AACrB,UAAM,KAAK,qBAAqB,EAAE,QAAQ,EAAE,kBAAkB;SAE9D,OAAM,KAAK,iBAAiB,MAAM,aAAa;AAGnD,SAAM,KAAK,GAAG;;AAIlB,MAAI,KAAK,OAAO;GACZ,MAAM,IAAI,KAAK;AACf,SAAM,KAAK,GAAG;AACd,SAAM,KAAK,IAAI,OAAO,GAAG,CAAC;AAC1B,SAAM,KAAK,gCAAgC;AAC3C,SAAM,KAAK,IAAI,OAAO,GAAG,CAAC;AAC1B,SAAM,KAAK,GAAG;AACd,SAAM,KAAK,YAAY;AACvB,SAAM,KAAK,WAAW,EAAE,UAAU,IAAI;AACtC,SAAM,KAAK,wBAAwB,EAAE,cAAc,OAAO,EAAE,gBAAgB,EAAE,YAAY,KAAK,QAAQ,EAAE,CAAC,IAAI;AAC9G,SAAM,KAAK,wBAAwB,EAAE,gBAAgB,OAAO,EAAE,kBAAkB,EAAE,YAAY,KAAK,QAAQ,EAAE,CAAC,IAAI;AAClH,SAAM,KAAK,kBAAkB,EAAE,gBAAgB,OAAO,EAAE,kBAAkB,EAAE,YAAY,KAAK,QAAQ,EAAE,CAAC,IAAI;AAC5G,SAAM,KAAK,GAAG;AACd,SAAM,KAAK,WAAW;AACtB,SAAM,KAAK,gBAAgB,EAAE,mBAAmB,IAAI;AACpD,SAAM,KAAK,kBAAkB,EAAE,gBAAgB,IAAI;AACnD,SAAM,KAAK,UAAU,KAAK,OAAO,OAAO,MAAM;AAC9C,SAAM,KAAK,GAAG;AACd,SAAM,KAAK,WAAW;AACtB,SAAM,KAAK,yBAAyB,EAAE,mBAAmB,YAAY,EAAE,OAAO,IAAI;AAClF,SAAM,KAAK,sBAAsB,EAAE,gBAAgB,eAAe;AAGlE,OAAI,EAAE,YAAY;AACd,UAAM,KAAK,GAAG;AACd,UAAM,KAAK,YAAY;IAGvB,MAAM,MAAM,EAAE,WAAW;AACzB,UAAM,KAAK,qBAAqB;AAChC,UAAM,KAAK,eAAe,IAAI,WAAW;AACzC,UAAM,KAAK,eAAe,IAAI,MAAM;AACpC,UAAM,KAAK,gBAAgB,IAAI,OAAO;AACtC,UAAM,KAAK,cAAc,IAAI,QAAQ,QAAQ,EAAE,CAAC,GAAG;AACnD,UAAM,KAAK,gBAAgB,EAAE,qBAAqB;IAGlD,MAAM,SAAS,EAAE,WAAW;AAC5B,UAAM,KAAK,kBAAkB;AAC7B,UAAM,KAAK,eAAe,OAAO,WAAW;AAC5C,UAAM,KAAK,eAAe,OAAO,MAAM;AACvC,UAAM,KAAK,gBAAgB,OAAO,OAAO;AACzC,UAAM,KAAK,cAAc,OAAO,QAAQ,IAAI,OAAO,QAAQ,QAAQ,EAAE,GAAG,MAAM,GAAG;AACjF,UAAM,KAAK,gBAAgB,OAAO,OAAO;IAGzC,MAAM,WAAW,EAAE,WAAW;AAC9B,UAAM,KAAK,oBAAoB;AAC/B,UAAM,KAAK,eAAe,SAAS,WAAW;AAC9C,UAAM,KAAK,eAAe,SAAS,MAAM;AACzC,UAAM,KAAK,gBAAgB,SAAS,OAAO;AAC3C,UAAM,KAAK,cAAc,SAAS,QAAQ,IAAI,SAAS,QAAQ,QAAQ,EAAE,GAAG,MAAM,GAAG;AACrF,UAAM,KAAK,gBAAgB,SAAS,OAAO;IAG3C,MAAM,MAAM,EAAE,WAAW;AACzB,QAAI,IAAI,QAAQ,GAAG;AACf,WAAM,KAAK,8BAA8B;AACzC,WAAM,KAAK,eAAe,IAAI,QAAQ;AACtC,WAAM,KAAK,eAAe,IAAI,MAAM;AACpC,WAAM,KAAK,gBAAgB,IAAI,OAAO;AACtC,WAAM,KAAK,cAAc,IAAI,QAAQ,QAAQ,EAAE,CAAC,GAAG;AACnD,WAAM,KAAK,kCAAkC;;;AAIrD,SAAM,KAAK,GAAG;AACd,SAAM,KAAK,IAAI,OAAO,GAAG,CAAC;;AAG9B,SAAO,MAAM,KAAK,KAAK;;;;;;;;;CCvKlB,uBAAb,MAAa,qBAAqB;;QAEtB,2BAAW,IAAI,KAA2B;QAG1C,gCAAgB,IAAI,KAA0B;QAG9C,mBAAmC,EAAE;QAGrC,kBAA0B;QAG1B,0BAAmC;QAGnC,qCAAkC,IAAI,KAAK;;;;;;;;EAQnD,OAAO,aAAa,QAAkG;AAElH,UADkB,IAAI,sBAAsB,CAC3B,QAAQ,OAAO;;;;;EAMpC,AAAQ,QAAQ,QAAkG;AAE9G,UAAO,oBAAoB;GAG3B,MAAM,QAAQ,KAAK,mBAAmB,OAAO;GAG7C,MAAM,YAAY,KAAK,gBAAgB,OAAO;AAG9C,QAAK,MAAM,YAAY,UACnB,MAAK,YAAY,OAAO,SAAS;AAIrC,UAAO,qBAAqB;AAE5B,UAAO;IACH,QAAQ,KAAK;IACb,UAAU,KAAK;IAClB;;;;;EAML,AAAQ,mBAAmB,QAAsC;GAC7D,MAAM,YAAY;GAElB,MAAM,QAAQ,IAAI,MAAM,QAAQ,EAC5B,IAAI,QAAa,MAAuB;AAMpC,QAAI,SAAS,MAAM;AAEK,KADD;MAAC;MAAyB;MAAwB;MAAc;MAAY,CAChE,SAAS,UAAU,gBAAgB;AAElE,aAAQ,iBAA4C;AAChD,aAAO,UAAU,SAAS,cAAc,MAAM;;;AAGtD,QAAI,SAAS,OACT,SAAQ,OACJ,UAAU,WAAW,IAAI,MAAM;AAEvC,QAAI,SAAS,SACT,SAAQ,OACJ,UAAU,aAAa,IAAI,MAAM;AAEzC,QAAI,SAAS,aACT,SAAQ,OACJ,UAAU,iBAAiB,IAAI,MAAM;AAG7C,QAAI,SAAS,aAAa,SAAS,gBAC/B,SAAQ,cACJ,UAAU,cAAc,UAAU;AAI1C,QAAI,SAAS,iBAAiB;KAC1B,MAAM,mBAAmB,QAAQ,IAAI,QAAQ,KAAK;AAClD,YAAO,UAAU,yBAAyB,iBAAiB;;IAI/D,MAAM,WAAW,QAAQ,IAAI,QAAQ,KAAK;AAE1C,QAAI,OAAO,aAAa,cACpB,OAAO,SAAS,YAChB,SAAS,KAAK,KAAK,IACnB,CAJe;KAAC;KAAM;KAAQ;KAAU;KAAc;KAAW;KAAiB;KAAgB,CAItF,SAAS,KAAK,CAC1B,QAAO,SAAU,GAAG,MAAa;AAET,KADD;MAAC;MAAyB;MAAwB;MAAc;MAAY,CAChE,SAAS,KAAK;AAG7C,SAAI,UAAU,2BAA2B,SAAS,UAAU,iBAAiB;AACzE,gBAAU,0BAA0B;AAGpC,UAAI,UAAU,mBAAmB,IAAI,KAAK,CAEtC,QAAO,UAAU,cAAc,KAAK;AAIxC,gBAAU,mBAAmB,IAAI,KAAK;AAEtC,UAAI;AAOA,eALqB,SAAiB,wBAAwB,UAGnC,KAAK,OAAO,GAAG,KAAK;gBAGzC;AAEN,iBAAU,mBAAmB,OAAO,KAAK;;;AAKjD,YAAO,UAAU,cAAc,KAAK;;AAK5C,WAAO;MAEd,CAAC;AAEF,UAAO;;;;;EAMX,AAAQ,yBAAyB,eAAyB;GACtD,MAAM,YAAY;AAElB,UAAO,IAAI,MAAM,eAAe,EAC5B,IAAI,QAAa,MAAuB;IACpC,MAAM,WAAW,QAAQ,IAAI,QAAQ,KAAK;AAG1C,QAAI,OAAO,aAAa,cAAc,OAAO,SAAS,SAClD,QAAO,SAAU,GAAG,MAAa;AAE7B,eAAU,cAAc,KAAK;;AAiBrC,WAAO;MAEd,CAAC;;;;;;;;;;;;;;EAeN,AAAQ,YAAY,OAAsB,UAAwB;GAE9D,MAAM,YAAY,KAAK,KAAK;AAG5B,QAAK,kBAAkB;AACvB,QAAK,mBAAmB,EAAE;AAC1B,QAAK,0BAA0B;GAG/B,MAAMC,WAAyB;IAC3B,MAAM;IACI;IACV,OAAO,EAAE;IACZ;AACD,QAAK,iBAAiB,KAAK,SAAS;AAEpC,OAAI;IAGA,MAAM,aAAc,MAAc;AAClC,QAAI,OAAO,eAAe,YAAY;AAClC,UAAK,0BAA0B;AAC/B,gBAAW,KAAK,MAAM;AACtB,UAAK,0BAA0B;;AAInC,SAAK,SAAS,IAAI,UAAU,SAAS;IAGrC,MAAM,UAAU,KAAK,KAAK,GAAG;AAG7B,QAAI,UAAU,IACV,SAAQ,MAAM,aAAa,SAAS,SAAS,QAAQ,OAAO,UAAU,KAAM,QAAQ,EAAE,CAAC,sBAAsB;YAE5GC,OAAY;AAGjB,SAAK,SAAS,IAAI,UAAU,SAAS;AAGrB,SAAK,KAAK,GAAG;;;;;;;;EAWrC,AAAQ,gBAAgB,QAAiC;GACrD,MAAM,4BAAY,IAAI,KAAa;GACnC,IAAI,YAAY,OAAO,eAAe,OAAO;AAG7C,UAAO,aAAa,cAAc,OAAO,WAAW;AAEhD,SAAK,MAAM,OAAO,OAAO,oBAAoB,UAAU,EAAE;AACrD,SAAI,QAAQ,cAAe;KAE3B,MAAM,aAAa,OAAO,yBAAyB,WAAW,IAAI;AAClE,SAAI,cAAc,OAAO,WAAW,UAAU,YAG1C;UADe,WAAW,MACf,sBAAsB,KAC7B,WAAU,IAAI,IAAI;;;AAM9B,gBAAY,OAAO,eAAe,UAAU;;AAGhD,UAAO,MAAM,KAAK,UAAU;;;;;EAUhC,AAAQ,SAAS,cAAyC,QAAmB;GACzE,MAAMC,WAAkB,EAAE;AAE1B,QAAK,IAAI,IAAI,GAAG,IAAI,aAAa,QAAQ,KAAK;IAC1C,MAAM,MAAM,aAAa;AAGzB,SAAK,iBAAiB,KADQ;KAAC,MAAM;KAAY,OAAO,EAAE;KAAC,CACxB;AAEnC,QAAI;AAEA,SAAI,IAAI,KAAK,OAAO;KAGpB,MAAM,SAAS,KAAK,iBAAiB,KAAK;AAC1C,SAAI,OACA,UAAS,KAAK,OAAO;aAEpBD,OAAY;KAGjB,MAAM,SAAS,KAAK,iBAAiB,KAAK;AAC1C,SAAI,UAAU,OAAO,SAAS,OAAO,MAAM,SAAS,EAEhD,UAAS,KAAK,OAAO;;;AAOjC,OAAI,SAAS,SAAS,EAClB,MAAK,WAAW;IAAC,MAAM;IAAM,cAAc;IAAS,CAAC;;;;;EAO7D,AAAQ,WAAW,IAAe,QAAmB;AAEjD,QAAK,iBAAiB,KADQ;IAAC,MAAM;IAAY,OAAO,EAAE;IAAC,CACxB;AAEnC,OAAI;AAEA,OAAG,KAAK,OAAO;IAEf,MAAM,YAAY,KAAK,iBAAiB,KAAK;AAC7C,QAAI,UACA,MAAK,WAAW;KAAC,MAAM;KAAQ,MAAM;KAAU,CAAC;YAE/CA,OAAY;IAEjB,MAAM,YAAY,KAAK,iBAAiB,KAAK;AAC7C,QAAI,aAAa,UAAU,SAAS,UAAU,MAAM,SAAS,EACzD,MAAK,WAAW;KAAC,MAAM;KAAQ,MAAM;KAAU,CAAC;;;;;;EAQ5D,AAAQ,aAAa,IAAe,QAAmB;AAEnD,QAAK,iBAAiB,KADQ;IAAC,MAAM;IAAY,OAAO,EAAE;IAAC,CACxB;AAEnC,OAAI;AACA,OAAG,KAAK,OAAO;IAEf,MAAM,YAAY,KAAK,iBAAiB,KAAK;AAC7C,QAAI,UACA,MAAK,WAAW;KAAC,MAAM;KAAU,MAAM;KAAU,CAAC;YAEjDA,OAAY;IAEjB,MAAM,YAAY,KAAK,iBAAiB,KAAK;AAC7C,QAAI,aAAa,UAAU,SAAS,UAAU,MAAM,SAAS,EACzD,MAAK,WAAW;KAAC,MAAM;KAAU,MAAM;KAAU,CAAC;;;;;;EAQ9D,AAAQ,iBAAiB,IAAe,QAAmB;AAEvD,QAAK,iBAAiB,KADQ;IAAC,MAAM;IAAY,OAAO,EAAE;IAAC,CACxB;AAEnC,OAAI;AACA,OAAG,KAAK,OAAO;IAEf,MAAM,YAAY,KAAK,iBAAiB,KAAK;AAC7C,QAAI,UACA,MAAK,WAAW;KAAC,MAAM;KAAc,MAAM;KAAU,CAAC;YAErDA,OAAY;IAEjB,MAAM,YAAY,KAAK,iBAAiB,KAAK;AAC7C,QAAI,aAAa,UAAU,SAAS,UAAU,MAAM,SAAS,EACzD,MAAK,WAAW;KAAC,MAAM;KAAc,MAAM;KAAU,CAAC;;;;;;EAQlE,AAAQ,cAAc,WAAyB;GAC3C,MAAME,YAAyB;IAAC,MAAM;IAAW;IAAU;AAC3D,QAAK,cAAc,IAAI,WAAW,UAAU;AAC5C,QAAK,WAAW,UAAU;;;;;EAM9B,AAAQ,cAAc,UAAuB;AACzC,QAAK,WAAW;IAAC,MAAM;IAAW;IAAS,CAAC;;;;;EAMhD,AAAQ,WAAW,MAAsB;GACrC,MAAM,aAAa,KAAK,iBAAiB,KAAK,iBAAiB,SAAS;AACxE,OAAI,WACA,YAAW,MAAM,KAAK,KAAK;;;;;;;;;CCpcjC,gBAAN,MAAoB;;QAEhB,2BAAW,IAAI,KAA4B;QAG3C,YAAwB,EAAE;;;CAWT,YAArB,MAA+B;;QACnB,OAAO,IAAI,eAAe;;;;;;;;;;;;;;EAclC,OAAO,QAAsB;GACzB,IAAI,OAAO,KAAK;AAGhB,QAAK,MAAM,YAAYC,QAAM;AAEzB,QAAI,CAAC,KAAK,SAAS,IAAI,SAAS,CAC5B,MAAK,SAAS,IAAI,UAAU,IAAI,eAAe,CAAC;AAIpD,WAAO,KAAK,SAAS,IAAI,SAAS;AAIlC,SAAK,UAAU,KAAKA,OAAK;;;;;;EAOjC,UAAU,QAAiC;GACvC,IAAI,OAAO,KAAK;AAGhB,QAAK,MAAM,SAASA,QAAM;AACtB,QAAI,CAAC,KAAK,SAAS,IAAI,MAAM,CACzB,QAAO;AAEX,WAAO,KAAK,SAAS,IAAI,MAAM;;AAInC,QAAK,MAAM,YAAY,KAAK,UAExB,KAAI,KAAK,QAAQA,QAAM,SAAS,CAC5B,QAAO;AAIf,UAAO;;;;;;;;;;;;;;EAeX,gBAAgB,QAAmC;GAC/C,IAAI,OAAO,KAAK;AAGhB,QAAK,MAAM,SAAS,QAAQ;AAExB,QAAI,CAAC,KAAK,SAAS,IAAI,MAAM,CACzB,QAAO;AAIX,WAAO,KAAK,SAAS,IAAI,MAAM;;AAKnC,QAAK,MAAM,YAAY,KAAK,UAGxB,KAAI,KAAK,SAAS,QAAQ,SAAS,CAC/B,QAAO;AAKf,UAAO;;;;;;;;;;;;;;;EAgBX,AAAQ,QAAQ,QAAkB,UAA6B;AAE3D,OAAI,OAAO,WAAW,SAAS,OAC3B,QAAO;AAIX,QAAK,IAAI,IAAI,GAAG,IAAI,OAAO,QAAQ,IAC/B,KAAI,OAAO,OAAO,SAAS,GACvB,QAAO;AAIf,UAAO;;;;;;;;;;;EAYX,AAAQ,SAAS,QAAkB,UAA6B;AAE5D,OAAI,SAAS,SAAS,OAAO,OACzB,QAAO;AAIX,QAAK,IAAI,IAAI,GAAG,IAAI,OAAO,QAAQ,IAC/B,KAAI,OAAO,OAAO,SAAS,GACvB,QAAO;AAIf,UAAO;;;;;;;;;;;;;iBCnGwB;GAMhC,OAAO,OAAO;CAUf,sBAAN,MAA0B;;QACd,wBAAQ,IAAI,KAQhB;QAGI,YAAiF,EAAE;QAGpF,aAAa;IAChB,qBAAqB;IACrB,iBAAiB;IACjB,kBAAkB;IAElB,gBAAgB;KAAC,KAAK;KAAG,MAAM;KAAG,OAAO;KAAE;IAC3C,aAAa;KAAC,KAAK;KAAG,MAAM;KAAG,OAAO;KAAE;IACxC,eAAe;KAAC,KAAK;KAAG,MAAM;KAAG,OAAO;KAAE;IAC1C,mBAAmB;KAAC,KAAK;KAAG,MAAM;KAAG,OAAO;KAAE;IAE9C,WAAW;KAAC,KAAK;KAAG,MAAM;KAAG,OAAO;KAAE;IACtC,WAAW;KAAC,KAAK;KAAG,MAAM;KAAG,OAAO;KAAE;IACtC,UAAU;KAAC,KAAK;KAAG,MAAM;KAAG,OAAO;KAAE;IACrC,gBAAgB;KAAC,KAAK;KAAG,MAAM;KAAG,OAAO;KAAE;IAC3C,yBAAyB;KAAC,KAAK;KAAG,MAAM;KAAG,OAAO;KAAE;IACpD,eAAe;IACf,iBAAiB;KACb,YAAY;KACZ,eAAe;KACf,YAAY;KACZ,iBAAiB;KACpB;IACJ;;EAGD,YAAY,YAA4B;GACpC,MAAM,SAAS,KAAK,UAAU;AAC9B,QAAK,UAAU,KAAK;IAChB;IACA,WAAW,KAAK,KAAK;IACrB,WAAW;IACd,CAAC;AACF,UAAO;;EAIX,UAAU,QAAgB,WAAoB,YAA6B;GACvE,MAAM,OAAO,KAAK,UAAU;AAC5B,OAAI,CAAC,KACD,OAAM,IAAI,MAAM,iBAAiB,OAAO,MAAM;GAGlD,MAAM,gBAAgB,KAAK,KAAK,GAAG,KAAK;GACxC,MAAM,cAAc,gBAAgB,KAAK;AAGzC,OAAI,SAAS,GAAG;IACZ,MAAM,aAAa,KAAK,UAAU,SAAS;AAC3C,eAAW,aAAa;;AAI5B,OAAI,CAAC,KAAK,MAAM,IAAI,KAAK,WAAW,CAChC,MAAK,MAAM,IAAI,KAAK,YAAY;IAC5B,OAAO;IACP,WAAW;IACX,SAAS;IACT,SAAS;IACT,SAAS;IACT,YAAY,EAAE;IACd,aAAa,EAAE;IAClB,CAAC;GAGN,MAAM,OAAO,KAAK,MAAM,IAAI,KAAK,WAAW;AAC5C,QAAK;AACL,QAAK,aAAa;AAClB,QAAK,WAAW;AAChB,QAAK,UAAU,KAAK,IAAI,KAAK,SAAS,YAAY;AAClD,QAAK,UAAU,KAAK,IAAI,KAAK,SAAS,YAAY;AAElD,OAAI,cAAc,OACd,MAAK,WAAW,KAAK,UAAU;AAEnC,OAAI,eAAe,OACf,MAAK,YAAY,KAAK,WAAW;AAIrC,QAAK,UAAU,KAAK;AAEpB,UAAO;;EAIX,OAAO,YAAoB,UAAkB,WAAoB,YAAqB;AAGlF,OAAI,CAAC,KAAK,MAAM,IAAI,WAAW,CAC3B,MAAK,MAAM,IAAI,YAAY;IACvB,OAAO;IACP,WAAW;IACX,SAAS;IACT,SAAS;IACT,SAAS;IACT,YAAY,EAAE;IACd,aAAa,EAAE;IAClB,CAAC;GAGN,MAAM,OAAO,KAAK,MAAM,IAAI,WAAW;AACvC,QAAK;AACL,QAAK,aAAa;AAClB,QAAK,WAAW;AAChB,QAAK,UAAU,KAAK,IAAI,KAAK,SAAS,SAAS;AAC/C,QAAK,UAAU,KAAK,IAAI,KAAK,SAAS,SAAS;AAE/C,OAAI,cAAc,OACd,MAAK,WAAW,KAAK,UAAU;AAEnC,OAAI,eAAe,OACf,MAAK,YAAY,KAAK,WAAW;;EAKzC,eAAe,WAC4E;AACvF,QAAK,WAAW,WAAW;AAC3B,QAAK,WAAW,WAAW;;EAG/B,gBAAgB,WAC2E;AACvF,QAAK,WAAW,WAAW;AAC3B,QAAK,WAAW,WAAW;;EAI/B,sBAAsB;AAClB,QAAK,WAAW;;EAIpB,SAAS;AACL,WAAQ,IAAI,4BAA4B;AAGxC,WAAQ,IAAI,0BAA0B;AACtC,WAAQ,IAAI,aAAa,KAAK,WAAW,sBAAsB;AAC/D,WAAQ,IAAI,cAAc,KAAK,WAAW,kBAAkB;AAC5D,WAAQ,IAAI,cAAc,KAAK,WAAW,mBAAmB;AAC7D,WAAQ,IAAI,YAAY,KAAK,WAAW,sBAAsB,KAAK,WAAW,kBAAkB,KAAK,WAAW,mBAAmB;AACnI,WAAQ,IAAI,GAAG;AAGf,WAAQ,IAAI,cAAc;AAC1B,WAAQ,IAAI,iCAAiC;AAC7C,WAAQ,IAAI,YAAY,KAAK,WAAW,UAAU,MAAM;AACxD,WAAQ,IAAI,aAAa,KAAK,WAAW,UAAU,OAAO;AAC1D,WAAQ,IAAI,aAAa,KAAK,WAAW,UAAU,QAAQ;AAC3D,WAAQ,IAAI,aAAa,KAAK,WAAW,UAAU,QAAQ,KAAM,KAAK,WAAW,UAAU,MAAM,KAAK,WAAW,UAAU,QAAS,KAAK,QAAQ,EAAE,GAAG,EAAE,GAAG;AAE3J,WAAQ,IAAI,iCAAiC;AAC7C,WAAQ,IAAI,YAAY,KAAK,WAAW,UAAU,MAAM;AACxD,WAAQ,IAAI,aAAa,KAAK,WAAW,UAAU,OAAO;AAC1D,WAAQ,IAAI,aAAa,KAAK,WAAW,UAAU,QAAQ;AAC3D,WAAQ,IAAI,aAAa,KAAK,WAAW,UAAU,QAAQ,KAAM,KAAK,WAAW,UAAU,MAAM,KAAK,WAAW,UAAU,QAAS,KAAK,QAAQ,EAAE,GAAG,EAAE,GAAG;AAE3J,WAAQ,IAAI,gCAAgC;AAC5C,WAAQ,IAAI,YAAY,KAAK,WAAW,kBAAkB,MAAM;AAChE,WAAQ,IAAI,aAAa,KAAK,WAAW,kBAAkB,OAAO;AAClE,WAAQ,IAAI,aAAa,KAAK,WAAW,kBAAkB,QAAQ;AACnE,WAAQ,IAAI,aAAa,KAAK,WAAW,kBAAkB,QAAQ,KAAM,KAAK,WAAW,kBAAkB,MAAM,KAAK,WAAW,kBAAkB,QAAS,KAAK,QAAQ,EAAE,GAAG,EAAE,GAAG;AAGnL,OAAI,KAAK,WAAW,gBAAgB,aAAa,GAAG;AAChD,YAAQ,IAAI,sBAAsB;AAClC,YAAQ,IAAI,eAAe,KAAK,WAAW,gBAAgB,aAAa;AACxE,YAAQ,IAAI,sBAAsB,KAAK,WAAW,gBAAgB,WAAW,KAAM,KAAK,WAAW,gBAAgB,aAAa,KAAK,WAAW,gBAAgB,aAAc,KAAK,QAAQ,EAAE,CAAC,IAAI;AAClM,YAAQ,IAAI,iBAAiB,KAAK,WAAW,gBAAgB,gBAAgB,KAAM,KAAK,WAAW,gBAAgB,kBAAkB,KAAK,WAAW,gBAAgB,aAAc,KAAK,QAAQ,EAAE,CAAC,IAAI;AACvM,YAAQ,IAAI,gBAAgB,KAAK,WAAW,gBAAgB,gBAAgB;AAC5E,QAAI,KAAK,WAAW,gBAAgB,kBAAkB,GAAG;KACrD,MAAM,aAAa,KAAK,WAAW,gBAAgB,gBAAgB,KAAK,WAAW,gBAAgB;AACnG,aAAQ,IAAI,gBAAgB,WAAW,QAAQ,EAAE,CAAC,IAAI;;;AAK9D,OAAI,KAAK,WAAW,SAAS,QAAQ,GAAG;AACpC,YAAQ,IAAI,sDAAsD;AAClE,YAAQ,IAAI,YAAY,KAAK,WAAW,SAAS,MAAM;AACvD,YAAQ,IAAI,aAAa,KAAK,WAAW,SAAS,OAAO;AACzD,YAAQ,IAAI,aAAa,KAAK,WAAW,SAAS,QAAQ;AAC1D,YAAQ,IAAI,cAAe,KAAK,WAAW,SAAS,MAAM,KAAK,WAAW,SAAS,QAAS,KAAK,QAAQ,EAAE,CAAC,GAAG;;AAGnH,OAAI,KAAK,WAAW,eAAe,QAAQ,GAAG;AAC1C,YAAQ,IAAI,iCAAiC;AAC7C,YAAQ,IAAI,YAAY,KAAK,WAAW,eAAe,MAAM;AAC7D,YAAQ,IAAI,aAAa,KAAK,WAAW,eAAe,OAAO;AAC/D,YAAQ,IAAI,aAAa,KAAK,WAAW,eAAe,QAAQ;AAChE,YAAQ,IAAI,cAAe,KAAK,WAAW,eAAe,MAAM,KAAK,WAAW,eAAe,QAAS,KAAK,QAAQ,EAAE,CAAC,GAAG;;AAG/H,WAAQ,IAAI,kCAAkC,KAAK,WAAW,gBAAgB;AAC9E,WAAQ,IAAI,GAAG;GAGf,MAAM,wBAAwB,KAAK,WAAW,sBAAsB,KAAK,WAAW,kBAAkB,KAAK,WAAW;GACtH,MAAM,wBAAwB,KAAK,WAAW,UAAU,MACpD,KAAK,WAAW,UAAU,MAC1B,KAAK,WAAW;AACpB,WAAQ,IAAI,WAAW;AACvB,WAAQ,IAAI,cAAc,wBAAwB;AAClD,WAAQ,IAAI,cAAc,wBAAwB;AAClD,WAAQ,IAAI,UAAU,wBAAwB,sBAAsB,UAAU;AAC9E,WAAQ,IAAI,GAAG;GAGf,MAAM,SAAS,MAAM,KAAK,KAAK,MAAM,SAAS,CAAC,CAC1C,MAAM,GAAG,MAAM,EAAE,GAAG,UAAU,EAAE,GAAG,QAAQ,CAC3C,MAAM,GAAG,GAAG;GAGjB,MAAM,YAAY,MAAM,KAAK,KAAK,MAAM,QAAQ,CAAC,CAC5C,QAAQ,KAAK,SAAS,MAAM,KAAK,WAAW,EAAE;GAGnD,MAAM,eAAe,MAAM,KAAK,KAAK,MAAM,QAAQ,CAAC,CAC/C,QAAQ,KAAK,SAAS,MAAM,KAAK,SAAS,EAAE;AAEjD,WAAQ,IAAI,+BAA+B;AAC3C,WAAQ,IAAI,IAAI,OAAO,GAAG,CAAC;AAC3B,QAAK,MAAM,CAAC,QAAQ,SAAS,QAAQ;IACjC,MAAM,aAAa,KAAK,UAAU,KAAK;IACvC,MAAM,eAAe,KAAK,YAAY,KAAK;IAC3C,MAAM,aAAa,eAAe,KAAK,KAAK,UAAU,eAAe,KAAK,QAAQ,EAAE,GAAG;IACvF,MAAM,WAAW,KAAK,WAAW,SAAS,IACpC,KAAK,WAAW,QAAQ,GAAG,MAAM,IAAI,GAAG,EAAE,GAAG,KAAK,WAAW,SAC7D;IACN,MAAM,YAAY,KAAK,YAAY,SAAS,IACtC,KAAK,YAAY,QAAQ,GAAG,MAAM,IAAI,GAAG,EAAE,GAAG,KAAK,YAAY,SAC/D;AAEN,YAAQ,IAAI,MAAM,OAAO,GAAG;AAC5B,YAAQ,IAAI,WAAW,KAAK,QAAQ,QAAQ,EAAE,CAAC,MAAM,WAAW,YAAY,KAAK,UAAU,QAAQ,EAAE,CAAC,IAAI;AAC1G,YAAQ,IAAI,YAAY,KAAK,MAAM,YAAY,WAAW,QAAQ,EAAE,CAAC,aAAa,aAAa,QAAQ,EAAE,CAAC,IAAI;AAC9G,YAAQ,IAAI,YAAY,KAAK,QAAQ,QAAQ,EAAE,CAAC,YAAY,KAAK,YAAY,WAAW,IAAI,KAAK,QAAQ,QAAQ,EAAE,CAAC,IAAI;AAExH,QAAI,KAAK,WAAW,SAAS,KAAK,KAAK,YAAY,SAAS,EACxD,SAAQ,IAAI,aAAa,SAAS,QAAQ,EAAE,CAAC,KAAK,UAAU,QAAQ,EAAE,CAAC,KAAK,YAAY,UAAU,QAAQ,EAAE,CAAC,IAAI;AAErH,YAAQ,IAAI,GAAG;;AAGnB,WAAQ,IAAI,kBAAkB,aAAa,QAAQ,EAAE,CAAC,IAAI;AAC1D,WAAQ,IAAI,kBAAkB,UAAU,QAAQ,EAAE,CAAC,IAAI;AACvD,WAAQ,IAAI,IAAI,OAAO,GAAG,CAAC;AAC3B,WAAQ,IAAI,GAAG;;EAInB,QAAQ;AACJ,QAAK,MAAM,OAAO;AAClB,QAAK,aAAa;IACd,qBAAqB;IACrB,iBAAiB;IACjB,kBAAkB;IAElB,gBAAgB;KAAC,KAAK;KAAG,MAAM;KAAG,OAAO;KAAE;IAC3C,aAAa;KAAC,KAAK;KAAG,MAAM;KAAG,OAAO;KAAE;IACxC,eAAe;KAAC,KAAK;KAAG,MAAM;KAAG,OAAO;KAAE;IAC1C,mBAAmB;KAAC,KAAK;KAAG,MAAM;KAAG,OAAO;KAAE;IAE9C,WAAW;KAAC,KAAK;KAAG,MAAM;KAAG,OAAO;KAAE;IACtC,WAAW;KAAC,KAAK;KAAG,MAAM;KAAG,OAAO;KAAE;IACtC,UAAU;KAAC,KAAK;KAAG,MAAM;KAAG,OAAO;KAAE;IACrC,gBAAgB;KAAC,KAAK;KAAG,MAAM;KAAG,OAAO;KAAE;IAC3C,yBAAyB;KAAC,KAAK;KAAG,MAAM;KAAG,OAAO;KAAE;IACpD,eAAe;IACf,iBAAiB;KACb,YAAY;KACZ,eAAe;KACf,YAAY;KACZ,iBAAiB;KACpB;IACJ;;;CAWI,mBAAmB;EAC5B,SAAS;EACT,WAAW;EAEX,SAAS;EACT,SAAS;EAET,UAAU;EACV,gBAAgB;EAiBhB,cAAc;EACjB;CAiCY,yBAAb,MAAoC;;;;;EAoBhC,AAAQ,SAAS,SAAiB,OAAsB;AACpD,OAAI,KAAK,iBAAiB,QAAQ,KAAK,iBAAiB;IACpD,MAAM,SAAS,KAAK,OAAO,UAAU,SAAY,QAAQ,KAAK,aAAa;IAC3E,MAAM,cAAc,GAAG,KAAK,gBAAgB;IAC5C,MAAM,UAAU,GAAG,OAAO,GAAG,YAAY,IAAI,QAAQ;AACrD,QAAI;AAEA,QAAG,UAAU,KAAK,cAAc,SAAS,MAAM,OAAO;aACjD,OAAO;AACZ,aAAQ,MAAM,WAAW,eAAe,MAAM;;;;;;;EAQ1D,AAAQ,iBAAiB,UAAwB;AAC7C,WAAQ,IAAI,4BAA4B,WAAW;AAEnD,QAAK,gBAAgB;AAGrB,QAAK,kBAAkB;AACvB,QAAK,eAAe;GAKpB,MAAM,aAAa,cAAc,OAAO,KAAK,IAAI;GAGjD,IAAI,aAFe,KAAK,QAAQ,WAAW;AAG3C,UAAO,eAAe,KAAK,QAAQ,WAAW,EAAE;AAE5C,QADgB,KAAK,SAAS,WAAW,KACzB,UACZ;AAEJ,iBAAa,KAAK,QAAQ,WAAW;;GAEzC,MAAM,SAAS,KAAK,KAAK,YAAY,SAAS;AAC9C,OAAI,CAAC,GAAG,WAAW,OAAO,EAAE;AACxB,OAAG,UAAU,QAAQ,EAAC,WAAW,MAAK,CAAC;AACvC,YAAQ,IAAI,cAAc,SAAS;SAEnC,SAAQ,IAAI,cAAc,SAAS;GAIvC,MAAM,cAAc,KAAK,KAAK,QAAQ,GAAG,SAAS,UAAU;AAC5D,QAAK,qBAAqB;AAC1B,WAAQ,IAAI,qBAAqB,cAAc;AAG/C,OAAI;AACA,YAAQ,IAAI,sBAAsB;IAClC,MAAM,iBAAiB,sBAAsB,SAAS,oCAAmB,IAAI,MAAM,EAAC,aAAa,CAAC;AAGlG,SAAK,eAAe,GAAG,SAAS,aAAa,IAAI;AAGjD,OAAG,UAAU,KAAK,cAAc,gBAAgB,MAAM,OAAO;AAC7D,YAAQ,IAAI,0BAA0B;AAGtC,QAAI,GAAG,WAAW,YAAY,EAAE;KAC5B,MAAM,QAAQ,GAAG,SAAS,YAAY;AACtC,aAAQ,IAAI,cAAc,YAAY,QAAQ,MAAM,KAAK,QAAQ;WAC9D;AACH,aAAQ,MAAM,eAAe,cAAc;AAC3C,SAAI,KAAK,iBAAiB,MAAM;AAC5B,SAAG,UAAU,KAAK,aAAa;AAC/B,WAAK,eAAe;;AAExB;;YAGCC,OAAY;AACjB,YAAQ,MAAM,eAAe,cAAc;AAC3C,YAAQ,MAAM,SAAS,OAAO,aAAa,QAAQ,OAAO,QAAQ;AAClE,YAAQ,MAAM,SAAS,OAAO,WAAW,OAAO,MAAM,GAAG;AACzD,QAAI,OAAO,MACP,SAAQ,MAAM,SAAS,MAAM,MAAM;AAEvC,QAAI,KAAK,iBAAiB,MAAM;AAC5B,SAAI;AACA,SAAG,UAAU,KAAK,aAAa;cAC1B,GAAG;AAGZ,UAAK,eAAe;;;;;;;EAQhC,AAAQ,iBAAuB;AAC3B,OAAI,KAAK,iBAAiB,QAAQ,KAAK,mBAAmB,KAAK,oBAAoB;AAC/E,SAAK,SAAS,IAAI,EAAE;AACpB,SAAK,SAAS,sBAAsB,KAAK,gBAAgB,cAAc,EAAE;IAGzE,MAAM,WAAW,KAAK;IACtB,MAAM,oBAAoB,KAAK;IAI/B,MAAM,aAAa,cAAc,OAAO,KAAK,IAAI;IAEjD,IAAI,aADe,KAAK,QAAQ,WAAW;AAE3C,WAAO,eAAe,KAAK,QAAQ,WAAW,EAAE;AAE5C,SADgB,KAAK,SAAS,WAAW,KACzB,UACZ;AAEJ,kBAAa,KAAK,QAAQ,WAAW;;IAEzC,MAAM,SAAS,KAAK,KAAK,YAAY,SAAS;IAC9C,MAAM,oBAAoB,KAAK,KAAK,QAAQ,GAAG,SAAS,UAAU;AAElE,YAAQ,IAAI,qBAAqB,WAAW;AAG5C,QAAI;AAEA,QAAG,UAAU,KAAK,aAAa;AAC/B,UAAK,eAAe;AACpB,UAAK,qBAAqB;AAE1B,aAAQ,IAAI,2BAA2B;AACvC,aAAQ,IAAI,gBAAgB,oBAAoB;AAChD,aAAQ,IAAI,iBAAiB,oBAAoB;AAGjD,SAAI,GAAG,WAAW,kBAAkB,EAAE;AAClC,cAAQ,IAAI,sBAAsB;AAClC,SAAG,WAAW,mBAAmB,kBAAkB;AACnD,cAAQ,IAAI,eAAe,SAAS,cAAc,SAAS,UAAU;WAErE,SAAQ,MAAM,aAAa,oBAAoB;aAE9C,OAAO;AACZ,aAAQ,MAAM,mBAAmB,kBAAkB,MAAM,qBAAqB,MAAM;;;AAG5F,QAAK,kBAAkB;AACvB,QAAK,eAAe;AACpB,QAAK,eAAe;AACpB,QAAK,qBAAqB;;;;;;;;;;;;;;EAyC9B,AAAQ,cACJ,WACA,KACsB;GAEtB,IAAIC;AACJ,WAAQ,WAAR;IACI,KAAK;AACD,cAAS,KAAK,eAAe,IAAI,IAAI;AACrC;IACJ,KAAK;AACD,cAAS,KAAK,YAAY,IAAI,IAAI;AAClC;IACJ,KAAK;AACD,cAAS,KAAK,cAAc,IAAI,IAAI;AACpC;;AAIR,OAAI,WAAW,OACX,MAAK,aAAa,eAAe,UAAU;QACxC;AACH,QAAI,cAAc,eAAe;AAEjC,SAAK,aAAa,gBAAgB,UAAU;;AAGhD,UAAO;;;;;;;;;EAaX,YACI,AAAQC,UACR,AAAQC,YACR,SACF;GAHU;GACA;QA5PJ,wCAAwB,IAAI,KAAa;QAGzC,kBAAiC;QAGjC,eAA8B;QAG9B,qBAAoC;QAGpC,eAAuB;QAsKvB,iCAAiB,IAAI,KAAyB;QAU9C,8BAAc,IAAI,KAAyB;QAE3C,gCAAgB,IAAI,KAAyB;QAG7C,eAAe,IAAI,qBAAqB;QAGxC,8CAA8B,IAAI,KAAiC;QAonBnE,eAAe;IACnB,gBAAgB;IAChB,cAAc;IACd,oBAAoB;IACvB;QA+DD,2BAAW,IAAI,KAAK;QAiNpB,yBAAS,IAAI,KAAqB;QAmsB1B,qBAA6B;QAC7B,wBAAgC;QAChC,iBAAyB;AAlhD7B,QAAK,UAAU,EACX,UAAU,SAAS,YAAY,GAClC;;EAIL,iBAAiB,UAAkB;GAC/B,MAAM,WAAW,KAAK,SAAS,IAAI,SAAS;AAC5C,OAAI,CAAC,SACD,OAAM,IAAI,MAAM,OAAO;AAE3B,UAAO;;;;;;;;;;;;;;;;;;;;;;;;EAyBX,AAAO,sBAAyC;GAC5C,MAAMC,mBAAsC,EAAE;AAG9C,QAAK,eAAe;IAAE,gBAAgB;IAAG,cAAc;IAAG,oBAAoB;IAAG;GAGjF,MAAM,YAAY;IACd,WAAW;IACX,2BAAW,IAAI,KAKX;IACP;GAED,MAAM,YAAY,KAAK,KAAK;AAG5B,QAAK,MAAM,CAAC,UAAU,YAAY,KAAK,SAAS,SAAS,EAAE;IACvD,MAAM,gBAAgB,KAAK,KAAK;IAEhC,MAAM,YAAY;KACd,MAAM;KACN,aAAa;KACb,WAAW;KACX,cAAc;KACjB;IAED,MAAM,QAAQ,KAAK,4BAA4B,UAAU,SAAS,UAAU;AAC5E,QAAI,MACA,kBAAiB,KAAK,MAAM;AAGhC,cAAU,OAAO,KAAK,KAAK,GAAG;AAC9B,cAAU,UAAU,IAAI,UAAU,UAAU;;AAGhD,aAAU,YAAY,KAAK,KAAK,GAAG;AAGnC,WAAQ,IAAI,kCAAkC;AAC9C,WAAQ,IAAI,oBAAoB,KAAK,aAAa,eAAe,IAAI;AACrE,WAAQ,IAAI,cAAc,KAAK,aAAa,aAAa,IAAI;AAC7D,WAAQ,IAAI,oCAAoC,KAAK,aAAa,mBAAmB,IAAI;AAEzF,UAAO;;;;;;;;;EAWX,AAAQ,4BACJ,UACA,MACA,WACF;GACE,IAAI;AACJ,WAAQ,KAAK,MAAb;IACI,KAAK;AAED,SAAI,UAAW,WAAU;AAGzB,aAAQ,KAAK,iCAAiC,UAAU,MAAM,UAAU;AACxE,SAAI,MAAO,QAAO;AAGlB,UAAK,MAAM,OAAO,KAAK,cAAc;AACjC,cAAQ,KAAK,4BAA4B,UAAU,KAAK,UAAU;AAClE,UAAI,MAAO,QAAO;;AAEtB;IAEJ,KAAK;AAED,UAAK,MAAM,SAAS,KAAK,OAAO;AAC5B,cAAQ,KAAK,4BAA4B,UAAU,OAAO,UAAU;AACpE,UAAI,MAAO,QAAO;;AAEtB;IAEJ,KAAK;IACL,KAAK;IACL,KAAK;AAED,aAAQ,KAAK,4BAA4B,UAAU,KAAK,MAAM,UAAU;AACxE,SAAI,MAAO,QAAO;AAClB;IAEJ,KAAK;IACL,KAAK,UAED;;;;;;;;;;;;;;;;;EAmBZ,wBACI,UACA,QACA,QACA,WACY;GAEZ,IAAIC,SAAuB,EAAE;AAI7B,QAAK,MAAM,WAAW,OAAO,cAAc;IAGvC,MAAM,kBAAkB,KAAK,WAAW,SAAS,iBAAiB,UAAU,GAAG,GAAG,MAAM;IAExF,MAAM,SAAS,WAAW,iBAAiB;AAE3C,QAAI,QACA;SAAI,CAAC,aAAa,CAAC,SAAS,SAAS,EAAE;AACnC,cAAQ,IAAI,SAAS;AACrB,cAAQ,IAAI,gBAAgB;;;IAIpC,IAAIC,kBAA8B,EAAE;AAGpC,SAAK,MAAM,UAAU,iBAAiB;KAKlC,MAAM,iBAAiB,OAAO,KAAI,SAAQ;AACtC,UAAI,KAAK,WAAW,IAAI,KAAK,CACzB,QAAO,CAAC,CAAC,KAAK,CAAC;MAEnB,MAAM,QAAQ,KAAK,cAAc,WAAW,KAAK;AAEjD,UAAI,CAAC,MACD,OAAM,IAAI,MAAM,OAAO;AAG3B,aAAO;OACT;KAKF,MAAM,eAAe,KAAK,iBAAiB,gBAAgB,OAAO;AAElE,SAAI,QACA;UAAI,aAAa,SAAS,KAAO;AAC7B,eAAQ,IAAI,SAAS;AACrB,eAAQ,IAAI,sBAAsB;AAClC,eAAQ,IAAI,aAAa,OAAO;;;AAKxC,uBAAkB,gBAAgB,OAAO,aAAa;;AAE1D,WAAO,KAAK,KAAK,YAAY,gBAAgB,CAAC;;AAIlD,UAAO;;EAGX,AAAQ,qBACJ,YACA,aACU;AAEV,OAAI,YAAY,WAAW,EACvB,QAAO,EAAE;GAIb,MAAM,2BAAW,IAAI,KAAa;AAClC,QAAK,MAAMC,UAAQ,YAAY;IAE3B,MAAM,MAAMA,OAAK,KAAK,iBAAiB,eAAe;AACtD,aAAS,IAAI,IAAI;;GAIrB,MAAMC,eAA2B,EAAE;AACnC,QAAK,MAAMD,UAAQ,aAAa;IAC5B,MAAM,MAAMA,OAAK,KAAK,iBAAiB,eAAe;AACtD,QAAI,CAAC,SAAS,IAAI,IAAI,CAClB,cAAa,KAAKA,OAAK;;AAG/B,UAAO;;;;;;;;;EAUX,AAAQ,cACJ,YACA,aACe;GAGf,MAAM,4BAAY,IAAI,KAAa;AACnC,QAAK,MAAMA,UAAQ,YACf,WAAU,IAAIA,OAAK,KAAK,iBAAiB,eAAe,CAAC;AAE7D,QAAK,MAAM,aAAa,YAAY;IAChC,MAAM,MAAM,UAAU,KAAK,iBAAiB,eAAe;AAC3D,QAAI,UAAU,IAAI,IAAI,CAClB,QAAO;;;;;;;;;;EAYnB,AAAQ,wBACJ,YACA,aAC2C;AAE3C,OAAI,YAAY,WAAW,KAAK,WAAW,WAAW,EAClD,QAAO;GAIX,MAAM,eAAe,KAAK,qBAAqB,YAAY,YAAY;AAGvE,OAAI,aAAa,WAAW,EACxB,QAAO;GAIX,MAAM,OAAO,IAAI,WAAW;AAC5B,QAAK,MAAMA,UAAQ,aAEf,MAAK,OAAOA,OAAK;AAIrB,QAAK,MAAM,aAAa,YAAY;IAGhC,MAAM,WAAW,KAAK,gBAAgB,UAAU;AAEhD,QAAI,SAEA,QAAO;KACH,QAAQ;KACR,MAAM;KACT;;AAKT,UAAO;;;;;;;;;;;EAYX,AAAQ,4BACJ,UACA,SACA,SACA,UACM;AACN,OAAI,SAAS,SAAS,QAClB,QAAO,MAAM,UAAU,EAAE,OAAO,UAAU,EAAE;;;;OAIjD,UAAU,EAAE,gBAAgB,UAAU,EAAE;;;;AAMvC,UAAO;;;;;;;;;;;;;;;EAgBX,8BACI,UACA,QACA,WACF;AAEE,OAAI,OAAO,aAAa,SAAS,EAC7B;GAIJ,MAAM,iBAAiB,KAAK,wBAAwB,UAAU,QAAQ,iBAAiB,SAAS,iBAAiB;GACjH,MAAM,SAAS,iBAAiB;AAGhC,OAAI,WAAW;IACX,MAAM,aAAa,eAAe,QAAQ,KAAK,UAAU,MAAM,MAAM,QAAQ,EAAE;IAC/E,MAAM,WAAW,KAAK,IAAI,GAAG,eAAe,KAAI,UAAS,MAAM,OAAO,CAAC;AACvE,cAAU,aAAa;AACvB,cAAU,eAAe,KAAK,IAAI,UAAU,cAAc,SAAS;;AAIvE,QAAK,IAAI,IAAI,GAAG,IAAI,eAAe,QAAQ,IACvC,MAAK,IAAI,IAAI,IAAI,GAAG,IAAI,eAAe,QAAQ,KAAK;IAChD,MAAM,aAAa,eAAe;IAClC,MAAM,cAAc,eAAe;IAGnC,MAAM,YAAY,KAAK,cAAc,YAAY,YAAY;AAC7D,QAAI,WAAW;KACX,MAAM,eAAe,UAAU,KAAK,iBAAiB,eAAe;AACpE,YAAO;MACH,OAAO;MACP,MAAM;MACN;MACA,eAAe,CAAC,GAAG,EAAE;MACrB,eAAe;OACX,OAAO;OACP,OAAO;OACV;MACD,SAAS,OAAO,SAAS,YAAY,IAAI,EAAE,OAAO,IAAI,EAAE,MAAM,OAAO;MACrE,YAAY,KAAK,yBAAyB,UAAU,GAAG,GAAG,aAAa;MAC1E;;IAIL,MAAM,iBAAiB,KAAK,wBAAwB,YAAY,YAAY;AAC5E,QAAI,gBAAgB;KAChB,MAAM,YAAY,eAAe,OAAO,KAAK,iBAAiB,eAAe;KAC7E,MAAM,UAAU,eAAe,KAAK,KAAK,iBAAiB,eAAe;AACzE,YAAO;MACH,OAAO;MACP,MAAM;MACN;MACA,eAAe,CAAC,GAAG,EAAE;MACrB,eAAe;OACX,OAAO;OACP,OAAO;OACV;MACD,SAAS,OAAO,SAAS,YAAY,IAAI,EAAE,SAAS,IAAI,EAAE,WAAW,OAAO;MAC5E,YAAY,KAAK,4BAA4B,UAAU,GAAG,GAAG;OACzD,QAAQ;OACR,MAAM;OACN,MAAM;OACT,CAAC;MACL;;;;;;;;;;;;;;;;;;;EAsBjB,iCACI,UACA,QACA,WACF;AAEE,OAAI,OAAO,aAAa,SAAS,EAC7B;GAIJ,MAAM,iBAAiB,KAAK,wBAAwB,UAAU,QAAQ,iBAAiB,UAAU,cAAc;AAG/G,OAAI,WAAW;AACQ,mBAAe,QAAQ,KAAK,UAAU,MAAM,MAAM,QAAQ,EAAE;AAC9D,SAAK,IAAI,GAAG,eAAe,KAAI,UAAS,MAAM,OAAO,CAAC;;AAK3E,QAAK,IAAI,IAAI,GAAG,IAAI,eAAe,QAAQ,IACvC,MAAK,IAAI,IAAI,IAAI,GAAG,IAAI,eAAe,QAAQ,KAAK;IAChD,MAAM,aAAa,eAAe;IAClC,MAAM,cAAc,eAAe;IAGnC,MAAM,iBAAiB,KAAK,wBAAwB,YAAY,YAAY;AAE5E,QAAI,gBAAgB;KAEhB,MAAM,YAAY,eAAe,OAAO,KAAK,iBAAiB,eAAe;KAC7E,MAAM,UAAU,eAAe,KAAK,KAAK,iBAAiB,eAAe;AAGzE,YAAQ;MACJ,OAAO;MACP,MAAM;MACN;MACA,eAAe,CAAC,GAAG,EAAE;MACrB,eAAe;OACX,OAAO;OACP,OAAO;OACV;MACD,SAAS,OAAO,SAAS,YAAY,IAAI,EAAE,SAAS,IAAI;MACxD,YAAY,KAAK,4BAA4B,UAAU,GAAG,GAAG;OACzD,QAAQ;OACR,MAAM;OACN,MAAM;OACT,CAAC;MACL;;;;;;;EASjB,AAAQ,yBACJ,UACA,SACA,SACA,WACM;AACN,UAAO,MAAM,UAAU,EAAE,OAAO,UAAU,EAAE;;;UAG1C,UAAU;;;;OAIb,UAAU,EAAE,gBAAgB,UAAU,EAAE;;;;;;;;;;EA+C3C,iCACI,UACA,QACA,WACF;GACE,MAAM,cAAc,KAAK,KAAK;GAG9B,IAAI,cAAc,KAAK,8BAA8B,UAAU,QAAQ,UAAU;AAGjF,OAAI,CAAC,YAED;AAIJ,QAAK,aAAa;GAGlB,MAAM,gBAAgB,KAAK,iCAAiC,UAAU,QAAQ,UAAU;AAGxF,OAAI,cACA,MAAK,aAAa;OAElB,MAAK,aAAa;AAGP,QAAK,KAAK,GAAG;AAG5B,OAAI,YAAY,SAAS,mBACrB;QAAI,CAAC,eAAe;KAChB,MAAM,WAAW;;MAE3B,SAAS;;;;QAIP,YAAY,KAAK;QACjB,YAAY,cAAc,KAAK,EAAE,KAAK,YAAY,cAAc,KAAK,EAAE;QACvE,YAAY,eAAe,MAAM;QACjC,YAAY,eAAe,MAAM;;;;;;;;;AASzB,aAAQ,MAAM,SAAS;AACvB,WAAM,IAAI,MAAM,+CAA+C,SAAS,GAAG;;;AAKnF,UAAO;;EAKX,AAAQ,cACJ,UACF;AAUE,OAAI,KAAK,sBAAsB,IAAI,SAAS,CAExC,QAAO;AAIX,QAAK,sBAAsB,IAAI,SAAS;AAExC,OAAI;IACA,MAAM,OAAO,KAAK,SAAS,IAAI,SAAS;IAGxC,MAAM,SAAS,KAAK,cAAc,KAAK;AAEvC,QAAI,SAAS,KAAS;AAClB,aAAQ,IAAI,SAAS;AACrB,aAAQ,IAAI,OAAO;;AAEvB,WAAO;aACD;AAEN,SAAK,sBAAsB,OAAO,SAAS;;;EAKnD,mBAAmB,MAA6B;GAC5C,MAAM,MAAM,KAAK,cAAc,KAAK,KAAK;AAEzC,UAAO,MAAM;;EAIjB,gBAAgB,MAAsB;GAClC,MAAM,MAAM,KAAK,cAAc,KAAK,KAAK;AACzC,UAAO,MAAM;;EAGjB,SAAS,KAAmB;AACxB,OAAI,IAAI,MAAM,SAAS,EACnB,QAAO;GAEX,IAAI,MAAM;AACV,QAAK,IAAI,IAAI,GAAG,IAAI,IAAI,MAAM,QAAQ,KAAK;IACvC,MAAM,OAAO,IAAI,MAAM;IACvB,MAAM,QAAQ,KAAK,cAAc,KAAK;AACtC,UAAM,MAAM;;AAEhB,UAAO;;EAGX,QAAQ,IAAY;AAChB,OAAI,GAAG,aAAa,SAAS,EACzB,OAAM,IAAI,MAAM,cAAc;GAElC,IAAIE,gBAAwB;AAE5B,QAAK,IAAI,IAAI,GAAG,IAAI,GAAG,aAAa,QAAQ,KAAK;IAC7C,MAAM,cAAc,GAAG,aAAa;IACpC,MAAM,QAAQ,KAAK,cAAc,YAAY;AAE7C,qBAAiB;;AAErB,OAAI,kBAAkB,EAClB,OAAM,IAAI,MAAM,OAAO;AAE3B,UAAO;;EAGX,cACI,MACM;AAEN,QAAK,aAAa,gBAAgB;GAClC,MAAM,SAAS,KAAK,aAAa,YAAY,gBAAgB;GAI7D,IAAIC;AACJ,WAAQ,KAAK,MAAb;IACI,KAAK;AAED,cAAS;AACT;IAEJ,KAAK;AAED,cAAS,KAAK,cAAc,KAAK,SAAS;AAC1C;IAEJ,KAAK;AAGD,cAAS,KAAK,QAAQ,KAAK;AAC3B;IAEJ,KAAK;AAED,cAAS,KAAK,SAAS,KAAK;AAC5B;IAEJ,KAAK;IACL,KAAK;IACL,KAAK;AAGD,cAAS,KAAK,mBAAmB,KAAK;AACtC;IAEJ,QAEI,OAAM,IAAI,MAAM,WAAY,KAAa,OAAO;;AAIxD,QAAK,aAAa,UAAU,QAAQ,OAAU;AAG9C,UAAO;;EAIX,UAAU,MAAgB,OAAe;AAErC,QAAK,aAAa,YAAY;GAC9B,MAAM,SAAS,KAAK,aAAa,YAAY,gBAAgB;GAI7D,IAAIA;GACJ,IAAI,UAAU,EAAE;AAChB,WAAQ,KAAK,MAAb;IACI,KAAK;AAED,cAAS;AACT;IAEJ,KAAK;KACD,MAAM,WAAY,KAAqB;AAEvC,SAAI,KAAK,OAAO,IAAI,SAAS,CACzB,QAAO,KAAK,OAAO,IAAI,SAAS;AAGpC,SAAI,KAAK,sBAAsB,IAAI,SAAS,CAExC,QAAO;AAEX;AAGA,UAAK,sBAAsB,IAAI,SAAS;KAExC,MAAM,UAAU,KAAK,SAAS,IAAI,SAAS;AAE3C,cAAS,KAAK,UAAU,SAAS,MAAM;AAEvC,UAAK,sBAAsB,OAAO,SAAS;AAC3C;IAEJ,KAAK;AACD,eAAU,EAAE;AACZ,UAAK,MAAM,eAAe,KAAK,aAC3B,SAAQ,KAAK,KAAK,UAAU,aAAa,MAAM,CAAC;AAEpD,cAAS,KAAK,IAAI,GAAG,QAAQ;AAC7B;IAEJ,KAAK;AACD,eAAU,EAAE;AACZ,UAAK,MAAM,eAAe,KAAK,MAC3B,SAAQ,KAAK,KAAK,UAAU,aAAa,MAAM,CAAC;AAEpD,cAAS,KAAK,IAAI,GAAG,QAAQ;AAC7B;IAEJ,KAAK;IACL,KAAK;IACL,KAAK;AACD,cAAS,KAAK,UAAW,KAAoB,MAAM,MAAM;AACzD;IAEJ,QAEI,OAAM,IAAI,MAAM,WAAY,KAAa,OAAO;;AAIxD,QAAK,aAAa,UAAU,QAAQ,OAAU;AAG9C,UAAO;;EAWX,oBAAoB,MAAgB,UAAkB;AAClD,WAAQ,KAAK,MAAb;IACI,KAAK;AACD,UAAK,MAAM,QAAQ,UAAU,KAAK,UAAU;AAC5C;IACJ,KAAK;AACD,UAAK,MAAM,QAAQ,UAAU,KAAK,SAAS;AAC3C;IACJ,KAAK;AACD,UAAK,MAAM,SAAQ,MAAK,KAAK,oBAAoB,GAAG,SAAS,CAAC;AAC9D;IACJ,KAAK;AACD,UAAK,aAAa,SAAQ,QAAO,KAAK,oBAAoB,KAAK,SAAS,CAAC;AACzE;IACJ,KAAK;IACL,KAAK;IACL,KAAK;AACD,UAAK,oBAAoB,KAAK,MAAM,SAAS;AAC7C;;;EAIZ,eAAe,GAAkB;GAC7B,MAAM,QAAQ,CAAC,WAAW;AAE1B,QAAK,MAAM,QAAQ,EAAE,OAAO,CACxB,OAAM,KAAK,OAAO,KAAK,EAAE,OAAO,KAAK,IAAI;AAG7C,UAAO,MAAM,KAAK,KAAK;;EAG3B,WAAW;AACP,QAAK,QAAQ,IAAI,MAAM,EAAC,UAAU,MAAK,CAAC;AAExC,QAAK,MAAM,CAAC,UAAU,SAAS,KAAK,UAAU;AAC1C,SAAK,MAAM,QAAQ,SAAS;AAC5B,SAAK,oBAAoB,MAAM,SAAS;;GAI5C,MAAM,YAAY,MAAM,KAAK,MAAM;AACnC,WAAQ,IAAI,UAAU;GAGtB,MAAM,OAAO,IAAI,OAAO,KAAK,MAAM;AAEnC,WAAQ,IAAI,oBAAoB;AAChC,QAAK,MAAM,OAAO,KACd,KAAI,IAAI,SAAS,GAAG;AAEhB,YAAQ,IAAI,uBAAuB;AACnC,YAAQ,IAAI,OAAO;AACnB,YAAQ,IAAI,GAAG,IAAI,SAAS;;;EAKxC,mBAAmB;AACf,QAAK,MAAM,QAAQ,KAAK,SAAS,QAAQ,EAAE;AACvC,SAAK,sBAAsB,OAAO;IAClC,MAAM,SAAS,KAAK,UAAU,MAAM,EAAE;AACtC,YAAQ,IAAI,KAAK,SAAS;AAC1B,YAAQ,IAAI,OAAO;AACnB,SAAK,OAAO,IAAI,KAAK,UAAU,OAAO;;;EAI9C,yBAAyB;AACrB,QAAK,MAAM,QAAQ,KAAK,SAAS,QAAQ,EAAE;AACvC,SAAK,sBAAsB,OAAO;IAClC,MAAM,WAAW,KAAK;AACtB,YAAQ,IAAI,UAAU,SAAS;IAC/B,MAAM,SAAS,KAAK,cAAc,KAAK;AACvC,QAAI,KAAK,SAAS,IAAI,SAAS,EAAE;KAC7B,MAAM,MAAM,KAAK,SAAS,IAAI,SAAS;AACvC,SAAI,WAAW,KAAK;AAChB,cAAQ,IAAI,OAAO;AACnB,cAAQ,IAAI,SAAS;AACrB,cAAQ,IAAI,SAAS;AACrB,cAAQ,IAAI,IAAI;AAChB,cAAQ,IAAI,KAAK;AACjB,cAAQ,IAAI,OAAO;AACnB,WAAK,SAAS,IAAI,UAAU,OAAO;AACnC,YAAM,IAAI,MAAM,OAAO;;WAExB;AACH,UAAK,SAAS,IAAI,UAAU,OAAO;AACnC,aAAQ,IAAI,OAAO;AACnB,aAAQ,IAAI,SAAS;AACrB,aAAQ,IAAI,OAAO;;;;;;;;;;;EAY/B,iCAA4E;AAExE,QAAK,qBAAqB,KAAK,KAAK;GAEpC,MAAM,iBAAiB,KAAK,KAAK;GAGjC,MAAMC,QAAa;IACf,eAAe;IACf,iBAAiB;IACjB,iBAAiB;IACjB,oBAAoB;IACpB,iBAAiB;IACjB,WAAW;IACX,oBAAoB;IACpB,iBAAiB;IACjB,QAAQ;IACR,YAAY;KACR,WAAW;MAAC,KAAK;MAAG,MAAM;MAAG,OAAO;MAAG,SAAS;MAAE;KAClD,eAAe;MAAC,KAAK;MAAG,MAAM;MAAG,OAAO;MAAG,SAAS;MAAG,MAAM;MAAE;KAC/D,mBAAmB;MAAC,KAAK;MAAG,MAAM;MAAG,OAAO;MAAG,SAAS;MAAE;KAC7D;IACJ;AAGD,QAAK,4BAA4B,OAAO;AAIxC,QAAK,qBAAqB,KAAK,KAAK;GACpC,MAAM,aAAa,KAAK,KAAK;AAC7B,WAAQ,IAAI,uCAAuC;AACnD,WAAQ,IAAI,yBAAyB,iBAAiB,UAAU;GAGhE,MAAM,YAAY,MAAM,KAAK,KAAK,SAAS,MAAM,CAAC;AAGlD,QAAK,MAAM,YAAY,WAAW;AAC9B,SAAK,sBAAsB,OAAO;AAClC,SAAK,sBAAsB,UAAU,iBAAiB,SAAS,GAAG,iBAAiB,UAAU,KAAK;;GAGtG,MAAM,aAAa,iBAAiB;AAIpC,QAAK,IAAI,QAAQ,YAAY,SAAS,iBAAiB,SAAS,SAAS;AACrE,YAAQ,IAAI,mBAAmB,MAAM,SAAS;IAC9C,IAAI,iBAAiB;AACrB,SAAK,MAAM,YAAY,WAAW;AAC9B;KACA,MAAM,MAAM,GAAG,SAAS,GAAG;AAG3B,SAAI,KAAK,cAAc,IAAI,IAAI,CAC3B;KAIJ,MAAM,gBAAgB,KAAK,KAAK;AAIhC,UAAK,sBAAsB,UAAU,MAAM;KAI3C,MAAM,eADc,KAAK,KAAK,GACK;KACnC,MAAM,cAAc,KAAK,cAAc,IAAI,IAAI;KAC/C,MAAM,YAAY,cAAc,YAAY,SAAS;AAGrD,SAAI,eAAe,MAAM,YAAY,IACjC,SAAQ,IAAI,aAAa,SAAS,UAAU,MAAM,QAAQ,aAAa,WAAW,UAAU,GAAG;;AAGvG,YAAQ,IAAI,YAAY,MAAM,SAAS;;AAI3C,WAAQ,IAAI,mCAAmC;GAC/C,IAAI,iBAAiB;AACrB,QAAK,MAAM,YAAY,WAAW;AAC9B;IACA,MAAM,qBAAqB,KAAK,KAAK;IACrC,IAAIC,gBAA4B,EAAE;AAGlC,SAAK,IAAI,QAAQ,YAAY,SAAS,iBAAiB,SAAS,SAAS;KACrE,MAAM,MAAM,GAAG,SAAS,GAAG;AAC3B,SAAI,KAAK,cAAc,IAAI,IAAI,EAAE;MAC7B,MAAM,aAAa,KAAK,cAAc,iBAAiB,IAAI;AAC3D,sBAAgB,cAAc,OAAO,WAAW;;;IAKxD,MAAM,eAAe,KAAK,YAAY,cAAc;AACpD,SAAK,YAAY,IAAI,UAAU,aAAa;AAG5C,QAAI,aAAa,SAAS,KAAM;KAC5B,MAAM,oBAAoB,KAAK,KAAK,GAAG;AACvC,aAAQ,IAAI,MAAM,eAAe,GAAG,UAAU,OAAO,UAAU,SAAS,QAAQ,kBAAkB,WAAW,aAAa,OAAO,GAAG;;;AAwB5I,SAAM,kBADW,KAAK,KAAK,GACQ;AACnC,WAAQ,IAAI,iCAAiC,MAAM,gBAAgB,KAAK;AACxE,WAAQ,IAAI,6CAA6C;AAGzD,QAAK,qBAAqB;AAG1B,QAAK,MAAM,SAAS,KAAK,4BAA4B,QAAQ,EAAE;IAC3D,MAAM,UAAU,KAAK,iBAAiB,MAAM,SAAS;AACrD,UAAM,aAAa,KAAK,2BACpB,MAAM,UACN,SACA,IAAI,IAAI,CAAC,MAAM,SAAS,CAAC,CAC5B;;AAEL,SAAM,qBAAqB,KAAK,4BAA4B;GAE5D,MAAM,sBAAsB,MAAM,KAAK,KAAK,4BAA4B,QAAQ,CAAC;GAGjF,MAAM,KAAK,KAAK,KAAK;GAErB,MAAM,mBAAmB,KAAK,qBAAqB;AAKnD,SAAM,kBAJQ,KAAK,KAAK,GACG;AAI3B,SAAM,kBAAkB,iBAAiB;GAGzC,MAAMC,YAA+B,EAAE;AACvC,aAAU,KAAK,GAAG,oBAAoB;AACtC,aAAU,KAAK,GAAG,iBAAiB;AAGnC,SAAM,YAAY,KAAK,KAAK,GAAG;AAC/B,SAAM,qBAAqB,KAAK,eAAe;AAC/C,SAAM,kBAAkB,KAAK,YAAY;AACzC,SAAM,SAAS,iBAAiB;GAGhC,MAAM,sBAAsB,KAAK,aAAa,WAAW;GACzD,MAAM,mBAAmB,KAAK,aAAa,WAAW;GACtD,MAAM,qBAAqB,KAAK,aAAa,WAAW;GACxD,MAAM,yBAAyB,KAAK,aAAa,WAAW;AAE5D,SAAM,aAAa;IACf,WAAW;KACP,KAAK,oBAAoB;KACzB,MAAM,oBAAoB;KAC1B,OAAO,oBAAoB;KAC3B,SAAS,oBAAoB,QAAQ,IAAK,oBAAoB,MAAM,oBAAoB,QAAQ,MAAO;KAEvG,UAAU,oBAAoB;KACjC;IACD,aAAa;KACT,KAAK,iBAAiB;KACtB,MAAM,iBAAiB;KACvB,OAAO,iBAAiB;KACxB,SAAS,iBAAiB,QAAQ,IAAK,iBAAiB,MAAM,iBAAiB,QAAQ,MAAO;KAC9F,UAAU,iBAAiB;KAC3B,MAAM,KAAK,YAAY;KAC1B;IACD,eAAe;KACX,KAAK,mBAAmB;KACxB,MAAM,mBAAmB;KACzB,OAAO,mBAAmB;KAC1B,SAAS,mBAAmB,QAAQ,IAAK,mBAAmB,MAAM,mBAAmB,QAAQ,MAAO;KACpG,MAAM,KAAK,cAAc;KACzB,UAAU,mBAAmB;KAChC;IACD,mBAAmB;KACf,KAAK,uBAAuB;KAC5B,MAAM,uBAAuB;KAC7B,OAAO,uBAAuB;KAC9B,SAAS,uBAAuB,QAAQ,IAAK,uBAAuB,MAAM,uBAAuB,QAAQ,MAAO;KACnH;IACJ;AAGD,QAAK,aAAa,QAAQ;AAG1B,UAAO;IACH,QAAQ;IACD;IACV;;EAIL,AAAQ,uBAAuB,QAAsB,QAA4B;GAC7E,MAAM,SAAS,KAAK,aAAa,YAAY,mBAAmB;AAGhE,OAAI,OAAO,WAAW,EAClB,QAAO,CAAC,EAAE,CAAC;AAIf,OAAI,OAAO,WAAW,GAAG;IACrB,MAAMC,cAAY,OAAO,GAAG;AAC5B,SAAK,aAAa,UAAU,QAAQA,aAAWA,YAAU;AACzD,WAAO,OAAO;;GAIlB,MAAM,YAAY;IACd,eAAe;IACf,iBAAiB;IACjB,oBAAoB;IACpB,gBAAgB;IAChB,eAAe;IACf,cAAc;IACjB;GAGD,MAAM,aAAa,OAAO;GAI1B,IAAI,SAAS,WAAW,QAAO,SAAQ,KAAK,SAAS,OAAO;GAC5D,IAAI,cAAc,WAAW,QAAO,SAAQ,KAAK,UAAU,OAAO,CAAC,KAAI,SAAQ,KAAK,KAAK,iBAAiB,eAAe,CAAC;GAG1H,MAAM,iBAAiB,IAAI,IAAY,YAAY;AAGnD,QAAK,IAAI,IAAI,GAAG,IAAI,OAAO,QAAQ,KAAK;AACpC,SAAK,aAAa,sBAAsB,EAAE,GAAG,OAAO,SAAS;IAG7D,MAAM,UAAU,OAAO,GAAG;IAE1B,MAAM,eAAe,KAAK,YAAY,OAAO,GAAG;AAGhD,QAAI,UAAU,aAAa,OACvB,OAAM,IAAI,MAAM,OAAO;IAG3B,MAAMC,OAAmB,EAAE;IAG3B,IAAI,WAAW;IACf,MAAM,YAAY,OAAO;IAEzB,MAAM,oBAAoB,YAAY,OAAQ,aAAa,SAAS;IACpE,MAAM,qBAAqB,oBAAoB,KAAK,KAAK,GAAG;AAE5D,QAAI,kBACuB,aAAY,aAAa;AAGpD,SAAK,MAAM,OAAO,QAAQ;AAEtB,SADY,aAAa,SAAS,IAAI,SAC5B,KAAO;AAKjB;AAGA,SAAI,WAAW,QAAS,KAAK,aAAa,WAAW;AACjD,WAAK,aAAa,uBAAuB,SAAS,GAAG,YAAY;AAEjE,UAAI,mBAAmB;AACH,YAAK,KAAK,GAAG;AACZ,QAAE,WAAW,YAAa,KAAK,QAAQ,EAAE;;;KAKlE,MAAM,kBAAkB,SAAS,IAAI;AAGrC,SAAI,kBAAkB,EAClB,OAAM,IAAI,MAAM,gBAAgB;cACzB,oBAAoB,GAAG;MAE9B,MAAMC,WAAS,IAAI,KAAK,iBAAiB,eAAe;AACxD,qBAAe,IAAIA,SAAO;AAC1B,gBAAU;AACV,gBAAU,mBAAmB,aAAa;AAC1C;;KAIJ,MAAM,oCAAoB,IAAI,KAAa;KAK3C,MAAM,YAAY,IAAI;KACtB,MAAM,SAAS,YAAY,IAAI,IAAI,KAAK,iBAAiB,eAAe,GAAG;AAE3E,UAAK,MAAM,UAAU,cAAc;AAC/B,gBAAU;MAKV,MAAM,kBADe,OAAO,UACY,kBAClC,SACA,OAAO,MAAM,GAAG,gBAAgB;MACtC,MAAM,kBAAkB,gBAAgB;MAIxC,MAAM,YAAY,gBAAgB,KAAK,iBAAiB,eAAe;AAGvE,UAAI,kBAAkB,IAAI,UAAU,EAAE;AAClC,iBAAU;AACV;;AAGJ,wBAAkB,IAAI,UAAU;MAGhC,MAAM,iBAAiB,YAAY;AAGnC,UAAI,iBAAiB,OACjB,OAAM,IAAI,MAAM,qBAAqB;AAIzC,UAAI,mBAAmB,QAAQ;OAG3B,MAAM,cAAc,SACb,SAAS,iBAAiB,iBAAiB,YAC5C;AACN,sBAAe,IAAI,YAAY;AAC/B,iBAAU;aACP;OAGH,MAAMC,WAAqB,IAAI,MAAM,eAAe;AACpD,YAAK,IAAI,IAAI,GAAG,IAAI,WAAW,IAC3B,UAAS,KAAK,IAAI;AAEtB,YAAK,IAAI,IAAI,GAAG,IAAI,iBAAiB,IACjC,UAAS,YAAY,KAAK,gBAAgB;AAE9C,YAAK,KAAK,SAAS;;AAGvB,gBAAU;;;IAMlB,MAAM,iBAAiB,KAAK,KAAK;AACjC,aAAS,KAAK,YAAY,KAAK;AACT,SAAK,KAAK,GAAG;AAGnC,cAAU,gBAAgB,KAAK,IAAI,UAAU,eAAe,OAAO,SAAS,eAAe,KAAK;AAIhG,QAAI,OAAO,SAAS,eAAe,OAAO,IACtC,SAAQ,KAAK,uBAAuB,OAAO,OAAO,UAAU,eAAe,KAAK,OAAO,EAAE,GAAG,OAAO,SAAS,EAAE,GAAG;AAIrH,QAAI,OAAO,WAAW,KAAK,eAAe,OAAO,EAE7C;;GAKR,IAAIC,aAAyB,EAAE;AAG/B,QAAK,MAAM,UAAU,eACjB,KAAI,WAAW,GACX,YAAW,KAAK,EAAE,CAAC;OAEnB,YAAW,KAAK,OAAO,MAAM,iBAAiB,eAAe,CAAC;AAKtE,gBAAa,WAAW,OAAO,OAAO;GAItC,MAAM,sBAAsB,KAAK,KAAK;GACtC,MAAM,yBAAyB,KAAK,YAAY,WAAW;AAChC,QAAK,KAAK,GAAG;AAGxC,QAAK,MAAM,iBAAiB,uBACxB,KAAI,cAAc,SAAS,OACvB,OAAM,IAAI,MAAM,kBAAkB;GAI1C,MAAM,YAAY,OAAO,QAAQ,KAAK,QAAQ,MAAM,IAAI,QAAQ,EAAE;AAClE,QAAK,aAAa,UAAU,QAAQ,WAAW,uBAAuB,OAAO;AAE7E,UAAO;;;;;;;;;;;;;;;;;;;EAoBX,AAAQ,iBAAiB,QAAsB,QAA4B;AAMvE,UAH6B,KAAK,uBAAuB,QAAQ,OAAO;;EAM5E,AAAQ,uBAAuB,QAAsB,QAA4B;GAC7E,MAAM,SAAS,KAAK,aAAa,YAAY,mBAAmB;GAOhE,IAAI,yBAJU,cAAc,OAAO,CAIA,KAAI,SAAQ;AAK3C,WAFqB,KAAK,MAAM;KAGlC;GACF,MAAM,YAAY,OAAO,QAAQ,KAAK,QAAQ,MAAM,IAAI,QAAQ,EAAE;AAElE,QAAK,aAAa,UAAU,QAAQ,WAAW,uBAAuB,OAAO;AAE7E,UAAO;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EAqCX,AAAQ,WACJ,MACA,QACA,UACA,UACA,kBAA2B,OACjB;GACV,MAAM,SAAS,KAAK,aAAa,YAAY,aAAa;GAI1D,IAAIC;AACJ,WAAQ,KAAK,MAAb;IACI,KAAK;AAED,cAAS,CAAC,CAAC,KAAK,UAAU,CAAC;AAC3B;IAEJ,KAAK;AAED,cAAS,KAAK,sBAAsB,KAAK,UAAU,QAAQ,UAAU,UAAU,gBAAgB;AAC/F;IAEJ,KAAK;AAGD,cAAS,KAAK,SAAS,KAAK,cAAc,QAAQ,UAAU,UAAU,gBAAgB;AACtF;IAEJ,KAAK;AAED,cAAS,KAAK,mBAAmB,MAAM,QAAQ,UAAU,UAAU,gBAAgB;AACnF;IAEJ,KAAK;IACL,KAAK;AAGD,cAAS,KAAK,aAAa,KAAK,MAAM,QAAQ,UAAU,UAAU,gBAAgB;AAClF;IAEJ,KAAK;AAGD,cAAS,KAAK,iBAAiB,KAAK,MAAM,QAAQ,UAAU,UAAU,gBAAgB;AACtF;IAEJ,QAEI,OAAM,IAAI,MAAM,WAAY,KAAa,OAAO;;AAIxD,QAAK,aAAa,UAAU,QAAQ,QAAW,OAAO,OAAO;AAE7D,UAAO;;EA0BX,AAAQ,aAAa,UAAwB;AACzC,OAAI,CAAC,KAAK,mBAAoB;GAE9B,MAAM,WAAW,KAAK,KAAK,GAAG,KAAK,sBAAsB;AACnC,QAAK,iBAAiB;AAE5C,OAAI,UAAU,KAAK,gBAAgB;IAC/B,MAAM,WAAW;;QAErB,SAAS;QACT,KAAK,sBAAsB;OAC5B,QAAQ,QAAQ,EAAE,CAAC;QAClB,KAAK,eAAe;;;;;;;AAOhB,YAAQ,MAAM,SAAS;AACvB,UAAM,IAAI,MAAM,SAAS,QAAQ,QAAQ,EAAE,CAAC,WAAW,SAAS,GAAG;;;EAI3E,AAAQ,mBACJ,MACA,QACA,UACA,UACA,kBAA2B,MAC7B;GACE,MAAM,SAAS,KAAK,aAAa,YAAY,qBAAqB;AAClE,QAAK,aAAa,wBAAwB;AAG1C,OAAI,KAAK,MAAM,WAAW,EAEtB,QAAO,CAAC,EAAE,CAAC;GAmDf,IAAI,gBAAgB;GACpB,IAAI,gBAAgB,KAAK,MAAM;AAG/B,QAAK,IAAI,IAAI,GAAG,IAAI,KAAK,MAAM,QAAQ,KAAK;IACxC,MAAM,QAAQ,KAAK,MAAM;AAGzB,QAAI,MAAM,SAAS,YAAY,MAAM,SAAS,QAAQ;AAClD;AAGA,SAAI,iBAAiB,QAAQ;AAEzB,sBAAgB,IAAI;AACpB;;;;GAQZ,MAAM,gBAAgB,KAAK,MAAM,MAAM,GAAG,cAAc;GAExD,MAAMC,cAA4B,EAAE;GACpC,IAAI,eAAe;AAGnB,QAAK,IAAI,IAAI,GAAG,IAAI,cAAc,QAAQ,KAAK;AAC3C,SAAK,aAAa,yBAAyB,IAAI,IAAI;IAEnD,MAAM,uBAAuB,KAAK,KAAK;IAIvC,IAAI,WAAW,KAAK,WAChB,cAAc,IACd,QACA,UACA,UACA,mBAAmB,MAAM,EAC5B;AAE2B,SAAK,KAAK,GAAG;AAGzC,QAAI,SAAS,WAAW,EAEpB,QAAO,EAAE;AAGb,eAAW,SAAS,KAAI,SAAQ,KAAK,MAAM,GAAG,OAAO,CAAC;AACtD,gBAAY,KAAK,SAAS;IAI1B,IAAI,YAAY;AAChB,SAAK,MAAM,KAAK,UAAU;KACtB,MAAM,MAAM,EAAE;AACd,SAAI,MAAM,WAAW;AACjB,kBAAY;AACZ,UAAI,cAAc,EAAG;;;AAI7B,oBAAgB;AAGhB,QAAI,gBAAgB,OAChB;;AAKR,OAAI,YAAY,WAAW,EAEvB,QAAO,EAAE;AAIb,QAAK,aAAa,2BAA2B;GAC7C,MAAM,SAAS,KAAK,iBAAiB,aAAa,OAAO;AACzD,QAAK,aAAa,2BAA2B;GAG7C,MAAM,cAAc,KAAK,uBAAuB,QAAQ,OAAO;AAG/D,QAAK,aAAa,UAAU,QAAQ,KAAK,MAAM,QAAQ,YAAY,OAAO;AAE1E,UAAO;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EAsFX,AAAQ,sBACJ,UACA,aACU;GACV,MAAM,QAAQ,KAAK;AAGnB,OAAI,gBAAgB,EAChB,OAAM,IAAI,MAAM,OAAO;GAK3B,MAAM,YAAY,KAAK,YAAY,IAAI,SAAS;AAChD,OAAI,aAAa,UAAU,SAAS,UAEhC,QADe,CAAC,CAAC,SAAS,CAAC;AAK/B,OAAI,gBAAgB,iBAAiB,SAAS;AAC1C,SAAK,SAAS,wBAAwB,SAAS,UAAU,MAAM;AAC/D,SAAK,eAAe,QAAQ;IAC5B,MAAM,SAAS,KAAK,kBAAkB,SAAS;AAC/C,SAAK,eAAe;AACpB,SAAK,SAAS,wBAAwB,SAAS,UAAU,MAAM;AAC/D,SAAK,SAAS,+BAA+B,SAAS,yBAAyB,OAAO,OAAO,SAAS,MAAM;AAC5G,WAAO;;GAGX,MAAM,MAAM,GAAG,SAAS,GAAG;AAG3B,QAAK,wBAAwB,GAAG,SAAS,QAAQ;AAGjD,QAAK,aAAa,yBAAyB,SAAS,QAAQ,cAAc;AAG1E,OAAI,KAAK,cAAc,IAAI,IAAI,EAAE;IAC7B,MAAM,SAAS,KAAK,cAAc,iBAAiB,IAAI;AACvD,SAAK,SAAS,cAAc,IAAI,SAAS,OAAO,UAAU,MAAM;AAChE,SAAK,SAAS,+BAA+B,SAAS,gBAAgB,YAAY,gBAAgB,OAAO,OAAO,SAAS,MAAM;AAC/H,WAAO;;AAGX,QAAK,SAAS,eAAe,OAAO,MAAM;GAG1C,IAAI,cAAc;GAClB,IAAIC,iBAAoC;AAExC,QAAK,IAAI,QAAQ,KAAK,IAAI,aAAa,iBAAiB,QAAQ,EAAE,SAAS,GAAG,SAAS;IACnF,MAAM,WAAW,GAAG,SAAS,GAAG;AAChC,QAAI,KAAK,cAAc,IAAI,SAAS,EAAE;AAClC,mBAAc;AACd,sBAAiB,KAAK,cAAc,iBAAiB,SAAS;AAC9D,UAAK,SAAS,WAAW,SAAS,SAAS,eAAe,UAAU,MAAM;AAG1E,SAAI,UAAU,aAAa;AACvB,WAAK,SAAS,+BAA+B,SAAS,gBAAgB,YAAY,gBAAgB,eAAe,OAAO,SAAS,MAAM;AACvI,aAAO;;AAEX;UAEA,MAAK,SAAS,WAAW,YAAY,MAAM;;AAKnD,OAAI,CAAC,gBAAgB;AACjB,SAAK,SAAS,wBAAwB,SAAS,UAAU,MAAM;AAC/D,kBAAc,iBAAiB;AAC/B,SAAK,eAAe,QAAQ;AAC5B,qBAAiB,KAAK,kBAAkB,SAAS;AACjD,SAAK,eAAe;AACpB,SAAK,SAAS,wBAAwB,SAAS,UAAU,MAAM;;GAInE,MAAM,kBAAkB,cAAc;AAGtC,OAAI,mBAAmB,EACnB,OAAM,IAAI,MAAM,OAAO;GAI3B,IAAIC,gBAA4B,EAAE;GAClC,MAAM,aAAa,eAAe;GAGlC,MAAMC,gBAAkE,EAAE;AAE1E,QAAK,IAAI,cAAc,GAAG,cAAc,eAAe,QAAQ,eAAe;IAC1E,MAAM,iBAAiB,eAAe;AAGtC,QAAI,cAAc,OAAO,KAAK,gBAAgB,eAAe,SAAS,EAClE,MAAK,aAAa,yBAAyB,SAAS,OAAO,cAAc,EAAE,GAAG,aAAa;IAG/F,MAAMC,0BAAwC,EAAE;AAGhD,SAAK,IAAI,YAAY,GAAG,YAAY,eAAe,QAAQ,aAAa;KACpE,MAAM,cAAc,eAAe;AAGnC,UAAK,aAAa,yBAAyB,SAAS,OAAO,YAAY,EAAE,GAAG,eAAe,OAAO,GAAG,cAAc;AAMnH,SAAI,eAAe,SAAS,YAAY,IAAI,eAAe,QAAQ,YAAY,GAAG,WAAW;AAEzF,WAAK,SAAS,YAAY,YAAY,cAAc,MAAM;AAC1D,8BAAwB,KAAK,CAAC,CAAC,YAAY,CAAC,CAAC;AAC7C;;AAIJ,UAAK,SAAS,UAAU,YAAY,UAAU,gBAAgB,SAAS,MAAM;AAC7E,UAAK,eAAe,QAAQ;KAC5B,MAAM,SAAS,KAAK,sBAAsB,aAAa,gBAAgB;AACvE,UAAK,eAAe;AACpB,6BAAwB,KAAK,OAAO;AACpC,UAAK,SAAS,UAAU,YAAY,UAAU,gBAAgB,eAAe,OAAO,UAAU,MAAM;;IAIxG,MAAM,cAAc,wBAAwB,KAAI,MAAK,EAAE,OAAO;IAC9D,MAAM,wBAAwB,YAAY,QAAQ,GAAG,MAAM,IAAI,GAAG,EAAE;IACpE,MAAM,iBAAiB,YAAY,QAAQ,GAAG,MAAM,IAAI,GAAG,EAAE;AAC7D,SAAK,SAAS,sBAAsB,wBAAwB,OAAO,YAAY,YAAY,KAAK,KAAK,CAAC,YAAY,sBAAsB,WAAW,kBAAkB,MAAM;IAE3K,MAAM,aAAa,KAAK,iBAAiB,yBAAyB,iBAAiB,SAAS;AAE5F,SAAK,SAAS,sBAAsB,WAAW,OAAO,WAAW,yBAAyB,MAAM;AAGhG,SAAK,aAAa,yBAAyB,SAAS,KAAK,cAAc,EAAE,QAAQ;AAGjF,QAAI,gBAAgB,iBAAiB,SAAS;KAC1C,MAAM,aAAa,eAAe,KAAK,IAAI;AAC3C,mBAAc,KAAK;MACH;MACZ,OAAO;MACV,CAAC;;AAGN,oBAAgB,cAAc,OAAO,WAAW;;AAEpD,QAAK,aAAa,yBAAyB,SAAS,MAAM;GAC1D,MAAM,cAAc,KAAK,YAAY,cAAc;AAInD,OAAI,KAAK,cAAc,IAAI,IAAI,CAC3B,OAAM,IAAI,MAAM,OAAO;AAI3B,OADoB,CAAC,KAAK,eAAe,aAAa,SAAS,EAC9C;AACb,SAAK,cAAc,IAAI,KAAK,YAAY;AACxC,SAAK,SAAS,YAAY,IAAI,SAAS,YAAY,UAAU,MAAM;SAEnE,MAAK,SAAS,mBAAmB,OAAO,MAAM;AAIlD,OAAI,gBAAgB,iBAAiB,SAAS;AAE1C,SAAK,SAAS,IAAI,MAAM;AACxB,SAAK,SAAS,cAAc,YAAY,OAAO,QAAQ,cAAc,OAAO,WAAW,MAAM;AAC7F,SAAK,SAAS,GAAG,IAAI,OAAO,GAAG,IAAI,MAAM;AAEzC,SAAK,IAAI,IAAI,GAAG,IAAI,cAAc,QAAQ,KAAK;KAC3C,MAAM,SAAS,cAAc;AAC7B,UAAK,SAAS,IAAI,MAAM;AACxB,UAAK,SAAS,MAAM,IAAI,EAAE,IAAI,OAAO,WAAW,IAAI,OAAO,MAAM,OAAO,QAAQ,MAAM;AACtF,UAAK,SAAS,GAAG,IAAI,OAAO,GAAG,IAAI,MAAM;AAEzC,YAAO,MAAM,SAAS,QAAM,UAAU;AAClC,WAAK,SAAS,OAAO,QAAQ,GAAG,UAAU,CAAC,SAAS,GAAG,IAAI,CAAC,IAAIjB,OAAK,KAAK,IAAI,IAAI,MAAM;OAC1F;;AAGN,SAAK,SAAS,GAAG,IAAI,OAAO,GAAG,IAAI,MAAM;AACzC,SAAK,SAAS,IAAI,MAAM;;AAE5B,QAAK,SAAS,+BAA+B,SAAS,gBAAgB,YAAY,UAAU,YAAY,OAAO,SAAS,MAAM;AAC9H,UAAO;;;;;;;;;;;;;;;;EAiBX,AAAQ,kBAAkB,UAA8B;GACpD,MAAM,WAAW,iBAAiB;GAGlC,MAAM,MAAM,GAAG,SAAS,GAAG;GAC3B,MAAM,QAAQ,KAAK;AAEnB,OAAI,KAAK,cAAc,IAAI,IAAI,EAAE;AAC7B,SAAK,aAAa,eAAe,oBAAoB;IACrD,MAAM,SAAS,KAAK,cAAc,iBAAiB,IAAI;AACvD,SAAK,SAAS,4BAA4B,IAAI,SAAS,OAAO,UAAU,MAAM;AAC9E,SAAK,SAAS,2BAA2B,SAAS,gBAAgB,OAAO,OAAO,SAAS,MAAM;AAC/F,WAAO;;AAIX,QAAK,aAAa,gBAAgB,oBAAoB;AACtD,QAAK,SAAS,6BAA6B,OAAO,MAAM;GAGxD,MAAM,YAAY,KAAK,YAAY,IAAI,SAAS;AAChD,OAAI,aAAa,UAAU,SAAS,WAAW;IAC3C,MAAMkB,WAAS,CAAC,CAAC,SAAS,CAAC;AAC3B,SAAK,SAAS,2BAA2B,SAAS,2BAA2B,MAAM;AACnF,WAAOA;;AAKX,OAAI,CADY,KAAK,iBAAiB,SAAS,CAE3C,OAAM,IAAI,MAAM,eAAe,WAAW;GAK9C,MAAM,KAAK,KAAK,KAAK;GACrB,MAAM,SAAS,KAAK,sBAChB,UACA,iBAAiB,UACjB,GACA,UACA,MACH;AACgB,QAAK,KAAK,GAAG;GAI9B,MAAM,cAAc,CAAC,KAAK,eAAe,QAAQ,SAAS;AAC1D,OAAI,eAAe,CAAC,KAAK,cAAc,IAAI,IAAI,EAAE;AAC7C,SAAK,cAAc,IAAI,KAAK,OAAO;AACnC,SAAK,SAAS,eAAe,IAAI,SAAS,OAAO,UAAU,MAAM;cAC1D,CAAC,YACR,MAAK,SAAS,mBAAmB,OAAO,MAAM;AAGlD,QAAK,SAAS,2BAA2B,SAAS,UAAU,OAAO,OAAO,SAAS,MAAM;AACzF,UAAO;;;;;;;;;;;;EAaX,AAAQ,sBACJ,UACA,QACA,UACA,UACA,iBACU;GAGV,MAAM,KAAK,KAAK,KAAK;AACrB,QAAK,aAAa,WAAW;AAI7B,OAAI,CAAC,SACD,OAAM,IAAI,MAAM,OAAO;AAI3B,OAAI,aAAa,UAAU;AAEvB,SAAK,aAAa,WAAW;AAC7B,WAAO,CAAC,CAAC,SAAS,CAAC;cACZ,WAAW,SAClB,OAAM,IAAI,MAAM,OAAO;AAI3B;AAMA,OAAI,WAAW,iBAAiB,SAAS;IAErC,MAAM,SAAS,KAAK,cAAc,kBAAkB,SAAS;AAC7D,QAAI,WAAW,QAAW;KAEtB,MAAM,WAAW,KAAK,KAAK,GAAG;AAC9B,UAAK,aAAa,OAAO,kBAAkB,SAAS;AACpD,YAAO;;cAGJ,WAAW,iBAAiB,UACnC;QAAI,aAAa,iBAAiB,QAC9B,OAAM,IAAI,MAAM,wBAAwB,OAAO,aAAa,WAAW;;AAS/E,OAAI,KAAK,sBAAsB,IAAI,SAAS,CAExC,KAAI,iBAAiB;AAGjB,QAAI,CAAC,KAAK,4BAA4B,IAAI,SAAS,EAAE;KAEjD,MAAMC,QAA4B;MAC9B,OAAO;MACP,MAAM;MACN;MACA,eAAe,EAAE;MACjB,eAAe;OAAC,OAAO;OAAI,OAAO;OAAG;MACrC,SAAS,OAAO,SAAS;MACzB,YAAY;MACf;AAGD,UAAK,4BAA4B,IAAI,UAAU,MAAM;;AAIzD,SAAK,aAAa,WAAW;AAC7B,WAAO,CAAC,CAAC,SAAS,CAAC;UAChB;AAGH,SAAK,aAAa,WAAW;AAC7B,WAAO,CAAC,CAAC,SAAS,CAAC;;AAK3B,QAAK,sBAAsB,IAAI,SAAS;AAExC,OAAI;AAKA,SAAK,aAAa,qBAAqB;IAGvC,MAAM,eAAe,KAAK,aAAa,YAAY,wBAAwB;IAC3E,MAAM,UAAU,KAAK,iBAAiB,SAAS;IAC/C,MAAM,cAAc,KAAK,WAAW,SAAS,QAAQ,UAAU,UAAU,gBAAgB;AACzF,SAAK,aAAa,UAAU,cAAc,QAAW,YAAY,OAAO;IAQxE,MAAM,cAAc,CAAC,KAAK,eAAe,aAAa,SAAS;AAE/D,QAAI,WAAW,iBAAiB,SAE5B;SAAI,eAAe,CAAC,KAAK,eAAe,IAAI,SAAS,CAEjD,MAAK,eAAe,IAAI,UAAU,YAAY;eAE3C,WAAW,iBAAiB,UACnC;SAAI,aAAa,iBAAiB,SAAS;MACvC,MAAM,MAAM,WAAW,IAAI,iBAAiB;AAC5C,UAAI,eAAe,CAAC,KAAK,cAAc,IAAI,IAAI,CAC3C,MAAK,cAAc,IAAI,KAAK,YAAY;;;AAKpD,WAAO;aACD;AAEN,SAAK,sBAAsB,OAAO,SAAS;;;;;;;;;;;;EAcnD,AAAQ,eAAe,QAAoB,UAA2B;AAElE,OAAI,OAAO,WAAW,KAAK,OAAO,GAAG,WAAW,KAAK,OAAO,GAAG,OAAO,SAClE,QAAO;AAEX,UAAO;;;;;;;;;;;;EAaX,AAAQ,YAAY,UAAkC;GAClD,MAAM,SAAS,KAAK,aAAa,YAAY,cAAc;GAG3D,MAAM,uBAAO,IAAI,KAAa;GAE9B,MAAMP,SAAqB,EAAE;AAG7B,QAAK,MAAM,UAAU,UAAU;IAG3B,MAAM,MAAM,OAAO,KAAK,iBAAiB,eAAe;AAExD,QAAI,CAAC,KAAK,IAAI,IAAI,EAAE;AAGhB,UAAK,IAAI,IAAI;AACb,YAAO,KAAK,OAAO;;;AAO3B,QAAK,aAAa,UAAU,QAAQ,SAAS,QAAQ,OAAO,OAAO;AAEnE,UAAO;;;;;;;;;;;;;;;;EAiBX,AAAQ,uBAAuB,UAAsB,QAA4B;GAC7E,MAAM,SAAS,KAAK,aAAa,YAAY,yBAAyB;AAGtE,OAAI,WAAW,iBAAiB,UAAU;IACtC,MAAMM,WAAS,KAAK,YAAY,SAAS;AACzC,SAAK,aAAa,UAAU,QAAQ,SAAS,QAAQA,SAAO,OAAO;AACnE,WAAOA;;GAIX,MAAM,YAAY,SAAS,KAAI,WAAU,OAAO,MAAM,GAAG,OAAO,CAAC;GAGjE,MAAM,SAAS,KAAK,YAAY,UAAU;AAG1C,QAAK,aAAa,UAAU,QAAQ,SAAS,QAAQ,OAAO,OAAO;AAEnE,UAAO;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EA8BX,AAAQ,SACJ,cACA,QACA,UACA,UACA,kBAA2B,MACjB;GACV,MAAM,SAAS,KAAK,aAAa,YAAY,WAAW;AAGxD,OAAI,aAAa,WAAW,EACxB,OAAM,IAAI,MAAM,iBAAiB;GAIrC,IAAIN,SAAqB,EAAE;AAG3B,QAAK,MAAM,OAAO,cAAc;IAE5B,MAAM,WAAW,KAAK,WAAW,KAAK,QAAQ,UAAU,UAAU,gBAAgB;AAClF,aAAS,OAAO,OAAO,SAAS;;AAIpC,OAAI,OAAO,WAAW,EAClB,OAAM,IAAI,MAAM,sBAAsB;GAI1C,MAAM,cAAc,KAAK,YAAY,OAAO;AAG5C,QAAK,aAAa,UAAU,QAAQ,aAAa,QAAQ,YAAY,OAAO;AAE5E,UAAO;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EAiCX,AAAQ,aACJ,MACA,QACA,UACA,UACA,kBAA2B,MACjB;GACV,MAAM,SAAS,KAAK,aAAa,YAAY,eAAe;GAO5D,MAAM,SAAS,CAAC,EAAE,EAAE,GAJE,KAAK,WAAW,MAAM,QAAQ,UAAU,UAAU,gBAAgB,CAInD;GAGrC,MAAM,cAAc,KAAK,YAAY,OAAO;AAG5C,QAAK,aAAa,UAAU,QAAQ,QAAW,YAAY,OAAO;AAElE,UAAO;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EAgCX,AAAQ,iBACJ,MACA,QACA,UACA,UACA,kBAA2B,MACjB;GACV,MAAM,SAAS,KAAK,aAAa,YAAY,mBAAmB;GAGhE,MAAM,gBAAgB,KAAK,WAAW,MAAM,QAAQ,UAAU,UAAU,gBAAgB;GAGxF,MAAM,iBAAiB,cAAc,KAAI,WAAU;AAM/C,WAHgB,CAAC,GAAG,QAAQ,GAAG,OAAO,CAGvB,MAAM,GAAG,OAAO;KACjC;GAGF,MAAM,SAAS,CAAC,GAAG,eAAe,GAAG,eAAe;GAIpD,MAAM,cAAc,KAAK,YAAY,OAAO;AAG5C,QAAK,aAAa,UAAU,QAAQ,QAAW,YAAY,OAAO;AAElE,UAAO;;;;;;;;;;EAWX,AAAQ,2BACJ,UACA,MACA,UACM;AAEN,OAAI,KAAK,SAAS,KACd,QAAO;;;;OAIZ,SAAS,KAAK,SAAS;;;OAGvB,SAAS;;;OAGT,SAAS;OACT,SAAS;cACF,SAAS,GAAG,SAAS;;QAE3B,SAAS,OAAO,MAAM,KAAK,SAAS,CAAC,MAAM,GAAG,EAAE,CAAC,KAAK,KAAK,GAAG,SAAS,OAAO,IAAI,UAAU,GAAG;KAClG,SAAS;AAGN,UAAO;;QAEP,SAAS,OAAO,MAAM,KAAK,SAAS,CAAC,MAAM,GAAG,EAAE,CAAC,KAAK,KAAK,GAAG,SAAS,OAAO,IAAI,UAAU,GAAG;KAClG,SAAS;;;;;;;;;;CC3rGD,0BAAb,MAAqC;;;;;;;;AC+FrC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA8CQ;AACA;;;;;;;;;;;AAiBA;AACA;AACA;AACA;AACA;;;;AASA;;;AAGI;AAEA;;;;;;;;;AAUJ;AAGA;;AAEI;;AAMJ;AACA;AACA;AACA;AACA;AACA;AAEA;AAIA;;;;;;;;;;;AAaA;AACA;AACA;AAEA;AAEI;AACA;;;;;AAMA;AAEA;AAGA;AACA;;;;AAOA;AACA;AAEA;AAGA;AACA;;;;;AAMA;AAEA;AACA;AACA;AAEA;AAGA;AAGA;AAKA;;;;;AAKA;AACA;;;;;;;AAYJ;;AAMA;AACA;AAEA;AACI;;AAEA;;AAEI;AAGA;;;;;;;;AASA;;;AAIR;;;;;;AAOA;;AAMA;;;;AAKI;;AAIA;AACI;AACA;AACA;;AAGJ;AACI;AAMA;;AAEI;;;AAGI;;AAGJ;AAGA;;;;AAKZ;;;;;;AAOA;;AAMA;;AAIQ;AAEA;AACI;AACA;AACA;AACA;AACA;AACA;AACA;;AAIA;;;AAOZ;;;;;;AAWA;AACA;AACA;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAKA;AACA;;AAOA;AACA;;AAEI;;;AAUJ;AACI;AACA;AACI;;;AAUR;AACI;AACA;AAEA;AACI;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAIA;AACA;AAEA;AACA;;;AAOR;AACA;AACA;;;;;;AAWA;;;;;;;;;;;;;;;AAyBA;AACA;;;;;;AAOA;AAIA;AAKA;;;;;;AAOA;AAMA;;;;;AAMI;;AAMJ;;;;;;AAOA;;;;;;AAOA;;;;;;AAOA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AClmBR,IAAY,gDAAL;AACH;AACA;AACA;AACA;AACA;;;;;;AAuBJ,IAAa,0BAAb,MAAqC;;;;;;CAWjC,OAAO,UAAU,QAAqC;AAClD,OAAK,SAAS;GACV,GAAG,KAAK;GACR,GAAG;GACN;;;;;;;;;CAUL,OAAe,UAAU,OAAiB,UAA4B;AAElE,MAAI,KAAK,OAAO,QAAQ,MACpB,QAAO;AAIX,MAAI,YAAY,KAAK,OAAO,gBAAgB,KAAK,OAAO,aAAa,SAAS,GAC1E;OAAI,CAAC,KAAK,OAAO,aAAa,SAAS,SAAS,CAC5C,QAAO;;AAIf,SAAO;;;;;;;;CASX,OAAO,MAAM,SAAiB,UAAyB;AACnD,MAAI,CAAC,KAAK,UAAU,SAAS,OAAO,SAAS,CACzC;AAEJ,UAAQ,IAAI,WAAW,UAAU;;;;;;;;CASrC,OAAO,KAAK,SAAiB,UAAyB;AAClD,MAAI,CAAC,KAAK,UAAU,SAAS,MAAM,SAAS,CACxC;AAEJ,UAAQ,IAAI,UAAU,UAAU;;;;;;;;CASpC,OAAO,KAAK,SAAiB,UAAyB;AAClD,MAAI,CAAC,KAAK,UAAU,SAAS,MAAM,SAAS,CACxC;AAEJ,UAAQ,KAAK,UAAU,UAAU;;;;;;;;CASrC,OAAO,MAAM,SAAiB,UAAyB;AACnD,MAAI,CAAC,KAAK,UAAU,SAAS,OAAO,SAAS,CACzC;AAEJ,UAAQ,MAAM,WAAW,UAAU;;;;;CAMvC,OAAO,YAA0B;AAC7B,SAAO,EAAE,GAAG,KAAK,QAAQ;;;;;CAM7B,OAAO,QAAc;AACjB,OAAK,SAAS;GACV,OAAO,SAAS;GAChB,cAAc,EAAE;GACnB;;;wBA1GU,SAAuB;CAClC,OAAO,SAAS;CAChB,cAAc,EAAE;CACnB;;;;;;;;;;;;;;;;;;ACvBL,IAAa,0BAAb,MAAqC;;;;;;;;;;;;;;;CAejC,OAAO,SAAS,QAAmB;EAE/B,MAAM,WAAW,qBAAqB,aAAa,OAAO;EAO1D,MAAM,SAJW,IAAI,uBAAuB,SAAS,QAAQ,SAAS,SAAS,CAIvD,gCAAgC;AAGxD,MAAI,OAAO,OAAO,SAAS,GAAG;GAC1B,MAAM,QAAQ,IAAI,8BAA8B,OAAO,QAAQ,OAAO,MAAM;AAC5E,WAAQ,MAAM,OAAO,MAAM,UAAU,CAAC;;;;;;;;;;;;;;;;;;;;;ACmFlD,IAAqB,gBAArB,cACY,sBAAsB;;;;CAwE9B,cAAc,QAAwB;AAClC,OAAK,cAAc,IAAI,IAAI,OAAO;AAClC,SAAO;;;;;CAMX,cAAc,QAAwB;AAClC,OAAK,MAAM,SAAS,OAChB,MAAK,YAAY,IAAI,MAAM;AAE/B,SAAO;;;;;CAMX,sBAA4B;AACxB,OAAK,qBAAqB;AAC1B,SAAO;;;;;CAMX,IAAI,oBAA6B;AAC7B,SAAO,KAAK;;CAGhB,eAAe;AACX,SAAO,KAAK,SAAS,KAAI,SAAQ,KAAK,KAAK;;;;;CA2C/C,IAAI,iBAAsC;AACtC,SAAO,KAAK;;;;;CAMhB,IAAI,oBAA6B;AAC7B,SAAO,KAAK,gBAAgB,SAAS;;;;;;;;CASzC,YACI,aAAqB,IACrB,SACF;AACE,SAAO;OAnKM,WAAyB,EAAE;OAQlC,SAA8B;OAG9B,cAAsB;OAGtB,aAAqB;OAGrB,YAAoB;OAGpB,cAAsB;OAGtB,iBAAgC;OAGhC,iBAAyB;OAGzB,eAA4B,YAAY;OAGxC,8BAA8D,IAAI,KAAK;OAGvE,gBAAqC,EAAE;OAOzC,gBAAyB;OAOzB,qBAA8B;OAM5B,cAA2B,IAAI,IAAI;GACzC;GAAU;GAAY;GACtB;GAAe;GAAY;GAC3B;GAAS;GAAU;GAAY;GAAS;GACxC;GAAU;GAAY;GAAa;GAAY;GAC/C;GAAa;GACb;GACA;GACH,CAAC;OAyCe,gBAAgB,IAAI,qBAAqB;OAOzC,mCAAgC,IAAI,KAAK;OAG1D,oBAA6B;OAOrB,0BAAgD,EAAE;OAMlD,kBAAuC,EAAE;OAOzC,mBAA2C;OAG3C,oBAAuC,EAAE;AA2B7C,OAAK,YAAY,KAAK,YAAY;AAClC,OAAK,SAAS,IAAI,qBAAqB;AAGvC,OAAK,cAAc;AACnB,OAAK,aAAa;AAClB,OAAK,YAAY;AACjB,OAAK,cAAc;AACnB,OAAK,iBAAiB;AACtB,OAAK,iBAAiB;AACtB,OAAK,8BAAc,IAAI,KAAK;AAC5B,OAAK,gBAAgB,EAAE;AAGvB,MAAI,SAAS,iBACT,MAAK,SAAS,IAAI,aAAa,QAAQ,iBAAiB;AAI5D,MAAI,SAAS,cACT,MAAK,gBAAgB,IAAI,QAAQ,cAAc,KAAK;MAEpD,MAAK,gBAAgB,IAAI,qBAAqB,KAAK;;;;;CAO3D,IAAI,eAAoC;AACpC,SAAO,KAAK;;;;;;CAOhB,IAAI,iBAAyB;AACzB,SAAO,KAAK,cAAc,SAAS;;;;;;CAOvC,IAAI,oBAA4B;AAC5B,SAAO,KAAK,cAAc;;;;;;;;;;;CAgB9B,AAAU,iBACN,WACA,MACA,QACA,MACsB;AACtB,MAAI,CAAC,KAAK,OAAQ,QAAO;EAGzB,MAAM,gBAAgB,KAAK,YAAY,IAAI,UAAU;AACrD,MAAI,eAAe,IAAI,KAAK,CACxB,QAAO,cAAc,IAAI,KAAK;EAIlC,MAAM,QAAQ,KAAK,OAAO,YACtB,KAAK,aACL,WACA,MACA,QACA,MACA,KAAK,gBACL,KAAK,eACR;AAED,MAAI,CAAC,MAAO,QAAO;AAGnB,MAAI,CAAC,cACD,MAAK,YAAY,IAAI,2BAAW,IAAI,KAAK,CAAC;AAE9C,OAAK,YAAY,IAAI,UAAU,CAAE,IAAI,MAAM,MAAM;AAEjD,SAAO;;;;;;;;;CAUX,AAAmB,GAAG,SAAiB,GAAG,OAAsD;EAC5F,IAAI,eAAe,KAAK;EACxB,IAAI,cAAc,KAAK;EACvB,IAAI,gBAAgB,KAAK;AAEzB,OAAK,IAAI,IAAI,GAAG,IAAI,QAAQ,KAAK;GAE7B,MAAM,OAAO,QAAQ,MAAM,KAAK;GAGhC,MAAM,QAAQ,KAAK,iBAAiB,cAAc,aAAa,eAAe,KAAK;AAEnF,OAAI,CAAC,MAAO,QAAO;AAGnB,OAAI,MAAM,SAAS,EACf,QAAO,MAAM;AAIjB,kBAAe,MAAM;AACrB,iBAAc,MAAM;AACpB,mBAAgB,MAAM;;;;;;CAS9B,AAAmB,KAAK,SAAiB,GAAG,OAAsD;AAC9F,SAAO,KAAK,GAAG,QAAQ,MAAM;;;;;CAMjC,IAAa,WAA0C;AACnD,SAAO,KAAK,GAAG,EAAE;;;;;;;CAYrB,cAAc,WAAmB,MAA4C;AACzE,SAAO,KAAK,QAAQ,WAAW,KAAK;;;;;;CAOxC,iBAAuB;AACnB,OAAK,gBAAgB;;CAOzB,IAAI,SAAiC;AACjC,SAAO,KAAK,SAAS,KAAK,SAAS,SAAS;;CAIhD,MAAM,SAAkB,MAAY;AAChC,OAAK,oBAAoB;AACzB,SAAO;;;;;;;CAQX,MAAM,eAAwB,MAAY;AACtC,kBAAgB,aAAa;AAC7B,OAAK,YAAY,IAAI,qBAAqB,KAAK,cAAc;AAC7D,SAAO;;CAGX,aAAa,SAAkB,MAAY;AACvC,OAAK,cAAc,YAAY,OAAO;AACtC,SAAO;;;;;;;;;;;;;CAcX,qBAA2B;AACvB,OAAK,gBAAgB;;;;;;;CAQzB,sBAA4B;AACxB,OAAK,gBAAgB;;;;;;;;;;;;;;CAezB,WAAiB;AACb,0BAAwB,SAAS,KAAK;AACtC,SAAO;;;;;;;;;;;;CAaX,AAAQ,sBAAsB,UAAkB,WAA8B;EAI1E,MAAM,6BAAa,IAAI,KAAqB;AAE5C,OAAK,MAAM,QAAQ,UACf,YAAW,IAAI,OAAO,WAAW,IAAI,KAAK,IAAI,KAAK,EAAE;AAIzD,OAAK,MAAM,SAAS,WAAW,QAAQ,CACnC,KAAI,SAAS,EACT,QAAO;AAMf,SAAO;;;;;;;CAQX,AAAQ,eAAe,UAAyB;AAE5C,MAAI,KAAK,eAAe;AAEpB,QAAK,gBAAgB;AACrB;;EAIJ,MAAM,eAAe,KAAK;EAG1B,MAAM,eAAe,KAAK,gBAAgB,EAAE;EAG5C,MAAM,mBAAmB,KAAK,OAAO,gBAAgB;EAGrD,MAAM,YAAY,KAAK,cAAc;EAErC,MAAM,YADwB,KAAK,sBAAsB,UAAU,UAAU,GACnC,mBAAmB;AAG7D,QAAM,KAAK,cAAc,YAAY;GACjC,MAAM;GACN,UAAU;GACV,OAAO;GACP,UAAU;IACN,YAAY,KAAK;IACjB,WAAW,KAAK;IAChB,MAAM,cAAc,UAAU,KAAK;IACnC,QAAQ,cAAc,kBAAkB,KAAK;IAChD;GACD,WAAW,CAAC,GAAG,UAAU;GACzB,cAAc;GACd,kBAAkB,MAAM,KAAK,KAAK,iBAAiB;GACnD,cAAc,KAAK,SAAS;GAC5B,gBAAgB;IACZ,MAAM,iBAAiB;IACvB,QAAQ,iBAAiB;IACzB,SAAS,iBAAiB;IAC1B,aAAa,iBAAiB;IACjC;GACD,kBAAkB;GAClB,MAAM;GACT,CAAC;;;;;;CAON,AAAQ,mBAAmB,WAAqB,UAAkB,WAAmB,GAAG,MAAqC;AACzH,MAAI,KAAK,qBAAqB,UAAU,UAAU,CAC9C;EAEJ,MAAM,aAAa,KAAK,SAAS,WAAW;AAE5C,MAAI,WACA,MAAK,kBAAkB;AAG3B,MAAI,KAAK,WACL;EAGJ,MAAM,aAAa,KAAK;EACxB,MAAM,MAAM,GAAG,SAAS,GAAG;AAG3B,MAAI,KAAK,iBAAiB,IAAI,IAAI,CAC9B,MAAK,eAAe,SAAS;AAIjC,OAAK,iBAAiB,IAAI,IAAI;AAE9B,MAAI;GACA,MAAM,YAAY,KAAK,WAAW,YAAY,UAAU,WAAW;AAGnE,OAAI,KAAK,mBAAmB;IACxB,MAAM,SAAS,KAAK,OAAO,IAAI,UAAU,WAAW;AACpD,QAAI,WAAW,QAAW;AACtB,UAAK,WAAW,WAAW,UAAU,MAAM,UAAU;AAGrD,SAAI,KAAK,qBAAqB,OAAO,gBAAgB,YAAY;MAE7D,MAAMa,eAA8B;OAChC,MAAM;OACN,iBAAiB;OACjB,eAAe,OAAO;OACtB,UAAU,OAAO,YAAY,WAAW,CAAC,GAAG,OAAO,WAAW,SAAS,GAAG,EAAE;OAC/E;MACD,MAAM,eAAe,KAAK,kBAAkB,KAAK,kBAAkB,SAAS;AAC5E,UAAI,aACA,cAAa,SAAS,KAAKC,aAAW;AAG1C,WAAK,IAAI,IAAI,KAAK,kBAAkB,SAAS,GAAG,KAAK,GAAG,KAAK;OACzD,MAAM,WAAW,KAAK,kBAAkB;AACxC,WAAI,OAAO,gBAAgB,SAAS,cAChC,UAAS,gBAAgB,OAAO;;;KAK5C,MAAMC,QAAM,KAAK,kBAAkB,OAAO;AAC1C,SAAI,CAACA,MAAI,UAAU,OACf,OAAI,WAAW;AAEnB,YAAOA;;;GAKf,MAAM,kBAAkB;GAGxB,IAAIC,aAAqC;AACzC,OAAI,KAAK,mBAAmB;AACxB,iBAAa;KACT,MAAM;KACN,UAAU,EAAE;KACZ,iBAAiB;KACjB,eAAe;KAClB;AACD,SAAK,kBAAkB,KAAK,WAAW;;GAG3C,MAAM,MAAM,KAAK,gBAAgB,UAAU,WAAW,GAAG,KAAK;AAG9D,OAAI,KAAK,qBAAqB,YAAY;AACtC,SAAK,kBAAkB,KAAK;AAC5B,QAAI,WAAW,gBAAgB,WAAW,iBAAiB;KACvD,MAAM,eAAe,KAAK,kBAAkB,KAAK,kBAAkB,SAAS;AAC5E,SAAI,aACA,cAAa,SAAS,KAAK,WAAW;;;AAMlD,OAAI,KAAK,mBAAmB;IACxB,MAAM,gBAAgB,KAAK;IAC3B,MAAM,gBAAgB,aAAa,KAAK,IAAI,WAAW,eAAe,cAAc,GAAG;IAGvF,MAAM,iBAAiB,KAAK,gBACtB,KAAK,cAAc,MAAM,gBAAgB,GACzC;AAEN,SAAK,OAAO,IAAI,UAAU,iBAAiB;KACvC,eAAe;KACV;KACL,cAAc,KAAK;KACP;KACZ,cAAc;KACjB,CAAC;;AAGN,QAAK,uBAAuB,UAAU,KAAK,YAAY,UAAU;AAGjE,OAAI,cAAc,KAAK,eACnB;QAAI,CAAC,KAAK,OAAO;KACb,MAAM,YAAY,KAAK,GAAG,EAAE;AAC5B,WAAM,IAAI,MACN,6FACgB,WAAW,WAAW,KAAK,WAAW,UAAU,gBAAgB,KAAK,aACxF;;;AAKT,OAAI,cAAc,KAAK,WACnB,MAAK,oBAAoB,UAAU,gBAAgB;AAGvD,OAAI,CAAC,IAAI,UAAU,OACf,KAAI,WAAW;AAEnB,UAAO;YACD;AAEN,QAAK,iBAAiB,OAAO,IAAI;;;CAIzC,AAAQ,mBAAmB;AAEvB,OAAK,gBAAgB;AACrB,OAAK,SAAS,SAAS;AACvB,OAAK,iBAAiB,OAAO;AAC7B,OAAK,aAAa;AAClB,OAAK,YAAY;AACjB,OAAK,cAAc;AACnB,OAAK,gBAAgB,EAAE;AACvB,OAAK,YAAY,OAAO;AAGxB,OAAK,WAAW,mBAAmB,KAAK,cAAc;;CAG1D,AAAQ,qBAAqB,UAAkB,WAA4B;AACvE,MAAI,KAAK,eAAe,SAAS,EAC7B;OAAI,cAAc,KAAK,UACnB,QAAO;;;CAKnB,AAAQ,uBACJ,UACA,KACA,YACA,WACI;AACJ,MAAI,OAAO,CAAC,IAAI,UAAU,OACtB,KAAI,WAAW;AAGnB,MAAI,CAAC,WACD,MAAK,WAAW,WAAW,UAAU,OAAO,UAAU;WAGlD,KAAK,WAAW;AAChB,OAAI,YAAY,KAAK,UACjB,CAAC,KAAK,UAAkB,OAAO,IAAI;AAEvC,GAAC,KAAK,WAAmB,cAAc;;;;;;;CASnD,AAAQ,gBAAgB,UAAkB,WAAqB,GAAG,MAAyB;EACvF,MAAM,MAAM,IAAI,YAAY;AAC5B,MAAI,OAAO;AACX,MAAI,WAAW,EAAE;AAEjB,OAAK,SAAS,KAAK,IAAI;AAGvB,YAAU,MAAM,MAAM,KAAK;AAE3B,OAAK,SAAS,KAAK;AAGnB,MAAI,KAAK,eAAe;GACpB,MAAM,YAAY,KAAK,SAAS,KAAK,SAAS,SAAS;AACvD,OAAI,UACA,WAAU,SAAS,KAAK,IAAI;AAEhC,QAAK,YAAY,IAAI;;AAGzB,SAAO;;CAGX,AAAQ,YAAY,KAAuB;AACvC,MAAI,IAAI,YAAY,IAAI,SAAS,IAAI,KAAK;GACtC,MAAM,YAAY,IAAI,SAAS,IAAI,SAAS,SAAS;AACrD,OAAI,MAAM;IACN,MAAM,IAAI;IACV,OAAO,IAAI,SAAS,GAAG,IAAI;IAC3B,KAAK,WAAW,KAAK,OAAO,IAAI,SAAS,GAAG,IAAI;IACnD;;;;;;;;;;;;CAaT,GAAG,cAAuC;AACtC,MAAI,KAAK,WACL;EAGJ,MAAM,aAAa,KAAK,WAAW;EACnC,MAAM,iBAAiB,KAAK;EAC5B,MAAM,aAAa,aAAa;EAChC,MAAM,iBAAiB,KAAK,QAAQ,QAAQ;AAG5C,OAAK,WAAW,YAAY,gBAAgB,eAAe;AAE3D,OAAK,IAAI,IAAI,GAAG,IAAI,YAAY,KAAK;GACjC,MAAM,MAAM,aAAa;GACzB,MAAM,SAAS,MAAM,aAAa;AAGlC,QAAK,WAAW,aAAa,GAAG,YAAY,eAAe;AAE3D,OAAI,KAAK;AAGT,QAAK,WAAW,iBAAiB,gBAAgB,EAAE;AAEnD,OAAI,KAAK,eAAe;AAEpB,SAAK,WAAW,WAAW,eAAe;AAC1C;;AAIJ,OAAI,CAAC,QAAQ;AACT,SAAK,6BAA6B,YAAY,eAAe;AAC7D,SAAK,gBAAgB;;;AAM7B,OAAK,WAAW,WAAW,eAAe;;;;;;;CAQ9C,KAAK,IAAwB;AACzB,SAAO,KAAK,cAAc,GAAG;;;;;;;;;CAYjC,iBAAiB,IAAwB;AACrC,MAAI,CAAC,KAAK,kBACN,OAAM,IAAI,MAAM,8BAA8B;AAIlD,OAAK,gBAAgB,SAAS;AAE9B,SAAO,CAAC,KAAK,mBAAmB;GAC5B,MAAM,kBAAkB,KAAK;AAG7B,QAAK,mBAAmB;IACpB,MAAM;IACN,UAAU,EAAE;IACK;IACjB,eAAe;IAClB;AACD,QAAK,oBAAoB,CAAC,KAAK,iBAAiB;AAIhD,OAFgB,KAAK,cAAc,GAAG,EAEzB;AAET,SAAK,mBAAmB;AACxB,SAAK,oBAAoB,EAAE;AAC3B;;GAIJ,MAAM,YAAY,KAAK,kBAAkB,KAAK,aAAa,EAAE;GAC7D,MAAM,eAAe,KAAK,uBAAuB,KAAK,kBAAmB,UAAU;AAEnF,OAAI,gBAAgB,aAAa,YAAY,aAAa,SAAS,SAAS,GAAG;IAE3E,MAAM,aAAa,KAAK;AACxB,QAAI,WACA,YAAW,SAAS,KAAK,GAAG,aAAa,SAAS;IAGtD,MAAM,gBAAgB,KAAK,0BAA0B,KAAK,kBAAmB,UAAU;AACvF,QAAI,gBAAgB,KAAK,iBAAiB,KAAK,cAAc,QAAQ;KACjE,MAAM,YAAY,KAAK,cAAc,gBAAgB;AACrD,UAAK,aAAa,UAAU,QAAQ,UAAU,WAAW;;SAI7D,MAAK;AAIT,QAAK,mBAAmB;AACxB,QAAK,oBAAoB,EAAE;AAC3B,QAAK,gBAAgB;;AAIzB,MAAI,KAAK,gBAAgB,SAAS,EAC9B,MAAK,gBAAgB;;;;;;CAQ7B,AAAQ,uBAAuB,MAAuB,UAAqC;AACvF,MAAI,CAAC,QAAQ,KAAK,SAAS,WAAW,EAClC,QAAO;EAGX,MAAM,MAAM,IAAI,YAAY;AAC5B,MAAI,OAAO,KAAK;AAChB,MAAI,WAAW,KAAK,yBAAyB,KAAK,UAAU,SAAS;AAErE,MAAI,CAAC,IAAI,YAAY,IAAI,SAAS,WAAW,EACzC,QAAO;AAGX,SAAO;;;;;;;;;;CAWX,AAAQ,yBAAyB,OAA0B,UAAgC;EAEvF,MAAM,yBAAS,IAAI,KAAgC;AACnD,OAAK,MAAM,QAAQ,OAAO;AAEtB,OAAI,KAAK,gBAAgB,SACrB;GAEJ,MAAM,MAAM,KAAK;AACjB,OAAI,CAAC,OAAO,IAAI,IAAI,CAChB,QAAO,IAAI,KAAK,EAAE,CAAC;AAEvB,UAAO,IAAI,IAAI,CAAE,KAAK,KAAK;;EAI/B,MAAMC,gBAAmC,EAAE;AAC3C,OAAK,MAAM,CAAC,UAAU,UAAU,QAAQ;GAEpC,IAAIC,OAA+B;AACnC,QAAK,MAAM,QAAQ,MACf,KAAI,CAAC,QAAQ,KAAK,iBAAiB,KAAK,cACpC,QAAO;AAGf,OAAI,KACA,eAAc,KAAK,KAAK;;AAKhC,gBAAc,MAAM,GAAG,MAAM,EAAE,kBAAkB,EAAE,gBAAgB;AAGnE,SAAO,cAAc,KAAI,SAAQ,KAAK,qBAAqB,MAAM,SAAS,CAAC;;;;;CAM/E,AAAQ,qBAAqB,MAAuB,UAA8B;EAC9E,MAAM,MAAM,IAAI,YAAY;AAC5B,MAAI,OAAO,KAAK;AAGhB,MAAI,KAAK,OAAO;AACZ,OAAI,QAAQ,KAAK;AACjB,OAAI,MAAM;IACN,MAAM,KAAK,MAAM;IACjB,OAAO,KAAK,MAAM;IAClB,OAAO;KACH,OAAO,KAAK,MAAM,SAAS;KAC3B,MAAM,KAAK,MAAM,UAAU;KAC3B,QAAQ,KAAK,MAAM,kBAAkB;KACxC;IACD,KAAK;KACD,QAAQ,KAAK,MAAM,SAAS,KAAK,KAAK,MAAM,WAAW;KACvD,MAAM,KAAK,MAAM,UAAU;KAC3B,QAAQ,KAAK,MAAM,gBAAgB;KACtC;IACJ;;AAIL,MAAI,KAAK,SAAS,SAAS,GAAG;AAC1B,OAAI,WAAW,KAAK,yBAAyB,KAAK,UAAU,SAAS;AACrE,OAAI,IAAI,SAAS,WAAW,EACxB,KAAI,WAAW;OAGf,MAAK,YAAY,IAAI;;AAI7B,SAAO;;;;;CAMX,AAAQ,0BAA0B,MAAuB,UAA0B;EAC/E,IAAI,SAAS,KAAK,iBAAiB,WAAW,KAAK,gBAAgB;AAEnE,OAAK,MAAM,SAAS,KAAK,UAAU;GAC/B,MAAM,WAAW,KAAK,0BAA0B,OAAO,SAAS;AAChE,OAAI,WAAW,OACX,UAAS;;AAIjB,SAAO;;;;;;;CAQX,AAAU,kBAAkB,WAA2B;AAEnD,OAAK,IAAI,IAAI,WAAW,IAAI,KAAK,YAAY,QAAQ,KAAK;GACtD,MAAM,QAAQ,KAAK,iBAAiB,GAAG,KAAK,WAAW,KAAK,aAAa,KAAK,aAAa;AAC3F,OAAI,SAAS,KAAK,YAAY,IAAI,MAAM,MAAM,UAAU,CACpD,QAAO;;AAGf,SAAO,KAAK,YAAY;;;;;;;;CAS5B,AAAU,gBAAgB,YAAoB,UAA8B;EACxE,MAAM,YAAY,IAAI,YAAY;AAClC,YAAU,OAAO;AACjB,YAAU,WAAW,EAAE;AAGvB,OAAK,MAAM,SAAS,KAAK,cACrB,KAAI,MAAM,SAAS,cAAc,MAAM,QAAQ,UAAU;GACrD,MAAM,YAAY,IAAI,YAAY;AAClC,aAAU,OAAO,MAAM;AACvB,aAAU,QAAQ,MAAM;AACxB,aAAU,MAAM;IACZ,MAAM,MAAM;IACZ,OAAO,MAAM;IACb,OAAO;KACH,OAAO,MAAM;KACb,MAAM,MAAM;KACZ,QAAQ,MAAM;KACjB;IACD,KAAK;KACD,OAAO,MAAM,SAAS,MAAM,YAAY,UAAU;KAClD,MAAM,MAAM;KACZ,QAAQ,MAAM;KACjB;IACJ;AACD,aAAU,SAAS,KAAK,UAAU;;AAK1C,MAAI,UAAU,SAAS,SAAS,GAAG;GAC/B,MAAM,QAAQ,UAAU,SAAS;GACjC,MAAM,OAAO,UAAU,SAAS,UAAU,SAAS,SAAS;AAC5D,aAAU,MAAM;IACZ,MAAM;IACN,OAAO,MAAM,IAAI;IACjB,KAAK,KAAK,IAAI;IACjB;;AAGL,SAAO;;;;;;;CAQX,OAAO,IAAwB;AAC3B,OAAK,cAAc,GAAG;;;;;;;CAQ1B,WAAW,IAAwB;AAC/B,MAAI,KAAK,WACL;AAGJ,MAAI;AAEJ,SAAO,KAAK,cAAc,GAAG;;;;;;;;CAWjC,AAAQ,oBAAoB,UAAkB,YAA0B;AAEpE,MAAI,KAAK,cACL;EAIJ,MAAM,kBAAkB,KAAK,sBAAsB;EACnD,MAAM,QAAQ,KAAK;AAEnB,QAAM,KAAK,cAAc,YAAY;GACjC,MAAM;GACN,UAAU,kBAAkB,iBAAiB;GACtC;GACP,UAAU;IACN,YAAY,KAAK;IACjB,WAAW,KAAK;IAChB,MAAM,OAAO,UAAU,KAAK;IAC5B,QAAQ,OAAO,kBAAkB,KAAK;IACzC;GACD,WAAW,KAAK,cAAc,CAAC,SAAS,IAAI,KAAK,cAAc,GAAG,CAAC,SAAS;GAC/E,CAAC;;CAGN,IAAI,oBAAoB;AACpB,SAAO,KAAK,cAAc,KAAK;;;;;;;CAQnC,QAAQ,WAAmB,MAA4C;AACnE,MAAI,KAAK,WACL;AAGJ,MAAI,KAAK,OAAO;AACZ,QAAK,gBAAgB;AACrB;;EAIJ,MAAM,aAAa,QAAQ,KAAK;EAChC,MAAM,QAAQ,KAAK,iBACf,KAAK,YACL,KAAK,WACL,KAAK,aACL,WACH;AAED,MAAI,CAAC,OAAO;AACR,QAAK,gBAAgB;AACrB;;EAGJ,MAAM,QAAQ,MAAM;AAEpB,MAAI,MAAM,cAAc,WAAW;AAC/B,QAAK,gBAAgB;AAErB,QAAK,WAAW,eACZ,KAAK,YACL,MAAM,YACN,MAAM,WACN,WACA,MACH;AAED;;AAGJ,OAAK,WAAW,eACZ,KAAK,YACL,MAAM,YACN,MAAM,WACN,WACA,KACH;EAED,MAAM,MAAM,KAAK,mBAAmB,MAAM;AAG1C,MAAI,MAAM,cAAc,eACpB,MAAK;WACE,MAAM,cAAc,eAC3B,MAAK;AAIT,OAAK,aAAa,MAAM;AACxB,OAAK,YAAY,MAAM;AACvB,OAAK,cAAc,MAAM;AACzB,OAAK,iBAAiB,MAAM;AAG5B,OAAK,cAAc,KAAK,MAAM;AAE9B,SAAO;;CAGX,AAAQ,mBAAmB,OAAsC;EAC7D,MAAM,MAAM,IAAI,YAAY;AAC5B,MAAI,OAAO,MAAM;AACjB,MAAI,QAAQ,MAAM;AAClB,MAAI,MAAM;GACN,MAAM,MAAM;GACZ,OAAO,MAAM;GACb,OAAO;IACH,OAAO,MAAM,SAAS;IACtB,MAAM,MAAM,UAAU;IACtB,QAAQ,MAAM,kBAAkB;IACnC;GACD,KAAK;IACD,QAAQ,MAAM,SAAS,KAAK,MAAM,WAAW;IAC7C,MAAM,MAAM,UAAU;IACtB,QAAQ,MAAM,gBAAgB;IACjC;GACJ;EAGD,MAAM,aAAa,KAAK;AACxB,MAAI,WACA,YAAW,SAAS,KAAK,IAAI;AAIjC,MAAI,KAAK,mBAAmB;GACxB,MAAM,cAAc,KAAK;GACzB,MAAMC,YAA6B;IAC/B,MAAM,MAAM;IACZ,UAAU,EAAE;IACZ,iBAAiB,KAAK;IACtB,eAAe;IACR;IACP,OAAO,MAAM;IAChB;GACD,MAAM,gBAAgB,KAAK,kBAAkB,KAAK,kBAAkB,SAAS;AAC7E,OAAI,cACA,eAAc,SAAS,KAAK,UAAU;AAG1C,QAAK,MAAM,YAAY,KAAK,kBACxB,UAAS,gBAAgB;;AAIjC,SAAO;;CAIX,AAAQ,YAA6B;EACjC,MAAM,aAAa,KAAK;AACxB,SAAO;GACH,WAAW,KAAK;GAChB,UAAU,KAAK;GACf,YAAY,KAAK;GACjB,eAAe,KAAK;GACpB,sBAAsB,YAAY,UAAU,UAAU;GACtD,oBAAoB,KAAK,cAAc;GAC1C;;CAGL,AAAQ,aAAa,UAAiC;EAClD,MAAM,YAAY,KAAK;EACvB,MAAM,UAAU,SAAS;AAEzB,MAAI,cAAc,QACd,MAAK,WAAW,cAAc,WAAW,QAAQ;AAGrD,OAAK,aAAa,SAAS;AAC3B,OAAK,YAAY,SAAS;AAC1B,OAAK,cAAc,SAAS;AAC5B,OAAK,iBAAiB,SAAS;AAG/B,OAAK,cAAc,SAAS,SAAS;EAErC,MAAM,aAAa,KAAK;AACxB,MAAI,WACA,YAAW,SAAS,SAAS,SAAS;;;;;;;;;;CAY9C,AAAQ,6BAA6B,YAA6B,gBAA8B;AAC5F,OAAK,aAAa,WAAW;;;;;CAMjC,IAAI,QAAiB;AAOjB,SANc,KAAK,iBACf,KAAK,YACL,KAAK,WACL,KAAK,aACL,KAAK,aACR,KACgB;;;;;;;;CASrB,AAAQ,cAAc,IAAyB;AAC3C,MAAI,KAAK,kBACL,QAAO;EAEX,MAAM,aAAa,KAAK,WAAW;EACnC,MAAM,aAAa,KAAK;AAExB,MAAI;AAEJ,MAAI,KAAK,YAAY;AAEjB,QAAK,6BAA6B,YAAY,WAAW;AACzD,QAAK,gBAAgB;AACrB,UAAO;;AAIX,SAAO,KAAK,eAAe;;;;;CAM/B,AAAQ,kBAAkB,QAA+C;AAErE,MAAI,OAAO,gBAAgB,OAAO,aAAa,SAAS,GAAG;AACvD,QAAK,cAAc,KAAK,GAAG,OAAO,aAAa;GAG/C,MAAM,YAAY,OAAO,aAAa,OAAO,aAAa,SAAS;AACnE,QAAK,aAAa,UAAU,QAAQ,UAAU,WAAW;AACzD,QAAK,YAAY,UAAU;AAC3B,QAAK,cAAc,UAAU;AAC7B,QAAK,iBAAiB,UAAU;;AAGpC,OAAK,gBAAgB,OAAO;AAG5B,MAAI,OAAO,cAAc;GACrB,MAAM,YAAY,KAAK,SAAS,KAAK,SAAS,SAAS;AACvD,OAAI,UACA,WAAU,SAAS,KAAK,OAAO,IAAI;;AAI3C,SAAO,OAAO;;;;;;;;CAalB,AAAQ,gBAAgB,cAAsB,GAAwB;EAClE,MAAM,SAAS,KAAK;EACpB,MAAM,MAAM,OAAO;EACnB,MAAM,QAAQ,KAAK,IAAI,GAAG,MAAM,YAAY;AAC5C,SAAO,OAAO,MAAM,MAAM;;;;;;;CAQ9B,AAAQ,wBAAkC;AACtC,MAAI,CAAC,KAAK,UAEN,QAAO,KAAK,sBAAsB;EAItC,MAAM,YAAY,KAAK,UAAU;AACjC,MAAI,CAAC,aAAa,UAAU,WAAW,EACnC,QAAO,CAAC,YAAY;AAGxB,SAAO,2BAA2B,mCAAmC,UAAU;;;;;CAMnF,AAAQ,uBAAiC;EACrC,MAAM,YAAY,KAAK,cAAc;AACrC,MAAI,UAAU,WAAW,EACrB,QAAO,CAAC,YAAY;EAGxB,MAAMC,QAAkB,EAAE;AAC1B,OAAK,IAAI,IAAI,GAAG,IAAI,UAAU,QAAQ,KAAK;GACvC,MAAM,OAAO,UAAU;GACvB,MAAM,SAAS,MAAM,UAAU,SAAS;GACxC,MAAM,SAAS,KAAK,OAAO,EAAE;GAC7B,MAAM,YAAY,MAAM,IAAI,KAAK;GACjC,MAAM,SAAS,SAAS,YAAY;AAEpC,SAAM,KAAK,KAAK,SAAS,YAAY,OAAO,SAAS;;AAGzD,SAAO;;;;;;;;;CAUX,AAAQ,wBAAwB,UAAkB,MAA4B;AAE1E,MAAI,KAAK,eAAe;AACpB,QAAK,gBAAgB;AACrB,UAAO;;EAKX,MAAM,WADgB,KAAK,uBAAuB,CACnB,KAAK,KAAK;EAGzC,MAAM,YAAY,KAAK,cAAc;EAKrC,MAAM,YAJkB,KAAK,sBAAsB,UAAU,UAAU,GAInC,mBAAmB;AAEvD,SAAO,KAAK,cAAc,YAAY;GAClC,MAAM;GACN,UAAU;GACV,OAAO,KAAK;GACZ,UAAU;IACN,YAAY,KAAK;IACjB,WAAW,KAAK;IAChB,MAAM,KAAK,UAAU,UAAU,KAAK;IACpC,QAAQ,KAAK,UAAU,kBAAkB,KAAK;IACjD;GACD,WAAW,CAAC,GAAG,UAAU;GACzB,cAAc;GACd,kBAAkB,EAAE;GACpB,cAAc,KAAK,SAAS;GAC5B,kBAAkB,KAAK,gBAAgB,EAAE;GACnC;GACI;GACb,CAAC;;;;;;ACxiDV,IAAqB,oBAArB,MAAuC;CAWnC,YAAY,UAA6B;AACrC,OAAK,YAAY,SAAS;AAC1B,OAAK,aAAa,SAAS;AAC3B,OAAK,SAAS,SAAS;AACvB,OAAK,iBAAiB,SAAS;AAC/B,OAAK,eAAe,SAAS;AAE7B,OAAK,QAAQ,SAAS;AACtB,OAAK,qBAAqB,SAAS;;;AAI3C,SAAgB,iBAAiB,UAA6B;AAC1D,QAAO,IAAI,kBAAkB,SAAS;;;;;ACY1C,IAAa,qBAAb,MAAgC;CAW5B,YAAY,UAAqC;AAC7C,OAAK,OAAO,SAAS;AACrB,OAAK,OAAO,SAAS,QAAQ,SAAS;AACtC,OAAK,UAAU,SAAS;AACxB,MAAI,SAAS,MACT,MAAK,QAAQ,SAAS;MAEtB,MAAK,QAAQ;AAEjB,OAAK,YAAY,SAAS,aAAa;AACvC,OAAK,OAAO,SAAS;AACrB,OAAK,iBAAiB,SAAS;AAC/B,OAAK,oBAAoB,SAAS;;;AAI1C,MAAa,aAAa;;;;AC3D1B,IAAa,UAAb,MAAqB;CAGjB,OAAe,gBAAwB;AACnC,MAAI,CAAC,KAAK,aAAa;GAEnB,MAAM,aAAa,cAAc,OAAO,KAAK,IAAI;GACjD,MAAM,YAAY,KAAK,QAAQ,WAAW;AAC1C,QAAK,cAAc,KAAK,KAAK,WAAW,cAAc;AAEtD,OAAI,CAAC,GAAG,WAAW,KAAK,YAAY,CAChC,IAAG,cAAc,KAAK,aAAa,wBAAwB;;AAGnE,SAAO,KAAK;;CAGhB,OAAO,IAAI,MAAY,MAAM,MAAM;AAE/B,MAAI;AACkB,wBAAI,MAAM,EAAC,aAAa;GAE1C,IAAI,aAAa;AAEjB,OAAI,SAAS,OACT,KAAI,OAAO,SAAS,SAChB,eAAc,OAAO,KAAK,UAAU,MAAM,MAAM,EAAE;OAElD,eAAc,OAAO,OAAO,KAAK;AAMzC,MAAG,eAAe,KAAK,eAAe,EAAE,WAAW;WAC9C,OAAO;AACZ,WAAQ,MAAM,wBAAwB,MAAM;;;CAIpD,OAAO,QAAQ;AACX,MAAI;AACA,MAAG,cAAc,KAAK,eAAe,EAAE,wBAAwB;WAC1D,OAAO;AACZ,WAAQ,MAAM,wBAAwB,MAAM"}